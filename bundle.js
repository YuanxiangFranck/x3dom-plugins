!function e(t,i,o){function s(n,a){if(!i[n]){if(!t[n]){var d="function"==typeof require&&require;if(!a&&d)return d(n,!0);if(r)return r(n,!0);var l=new Error("Cannot find module '"+n+"'");throw l.code="MODULE_NOT_FOUND",l}var h=i[n]={exports:{}};t[n][0].call(h.exports,function(e){var i=t[n][1][e];return s(i?i:e)},h,h.exports,e,t,i,o)}return i[n].exports}for(var r="function"==typeof require&&require,n=0;n<o.length;n++)s(o[n]);return s}({1:[function(e,t,i){var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";!function(e){"use strict";function t(e){var t=e.charCodeAt(0);return t===n||t===u?62:t===a||t===f?63:d>t?-1:d+10>t?t-d+26+26:h+26>t?t-h:l+26>t?t-l+26:void 0}function i(e){function i(e){l[u++]=e}var o,s,n,a,d,l;if(e.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var h=e.length;d="="===e.charAt(h-2)?2:"="===e.charAt(h-1)?1:0,l=new r(3*e.length/4-d),n=d>0?e.length-4:e.length;var u=0;for(o=0,s=0;n>o;o+=4,s+=3)a=t(e.charAt(o))<<18|t(e.charAt(o+1))<<12|t(e.charAt(o+2))<<6|t(e.charAt(o+3)),i((16711680&a)>>16),i((65280&a)>>8),i(255&a);return 2===d?(a=t(e.charAt(o))<<2|t(e.charAt(o+1))>>4,i(255&a)):1===d&&(a=t(e.charAt(o))<<10|t(e.charAt(o+1))<<4|t(e.charAt(o+2))>>2,i(a>>8&255),i(255&a)),l}function s(e){function t(e){return o.charAt(e)}function i(e){return t(e>>18&63)+t(e>>12&63)+t(e>>6&63)+t(63&e)}var s,r,n,a=e.length%3,d="";for(s=0,n=e.length-a;n>s;s+=3)r=(e[s]<<16)+(e[s+1]<<8)+e[s+2],d+=i(r);switch(a){case 1:r=e[e.length-1],d+=t(r>>2),d+=t(r<<4&63),d+="==";break;case 2:r=(e[e.length-2]<<8)+e[e.length-1],d+=t(r>>10),d+=t(r>>4&63),d+=t(r<<2&63),d+="="}return d}var r="undefined"!=typeof Uint8Array?Uint8Array:Array,n="+".charCodeAt(0),a="/".charCodeAt(0),d="0".charCodeAt(0),l="a".charCodeAt(0),h="A".charCodeAt(0),u="-".charCodeAt(0),f="_".charCodeAt(0);e.toByteArray=i,e.fromByteArray=s}("undefined"==typeof i?this.base64js={}:i)},{}],2:[function(e,t,i){(function(t){"use strict";function o(){function e(){}try{var t=new Uint8Array(1);return t.foo=function(){return 42},t.constructor=e,42===t.foo()&&t.constructor===e&&"function"==typeof t.subarray&&0===t.subarray(1,1).byteLength}catch(i){return!1}}function s(){return r.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function r(e){return this instanceof r?(r.TYPED_ARRAY_SUPPORT||(this.length=0,this.parent=void 0),"number"==typeof e?n(this,e):"string"==typeof e?a(this,e,arguments.length>1?arguments[1]:"utf8"):d(this,e)):arguments.length>1?new r(e,arguments[1]):new r(e)}function n(e,t){if(e=m(e,0>t?0:0|p(t)),!r.TYPED_ARRAY_SUPPORT)for(var i=0;t>i;i++)e[i]=0;return e}function a(e,t,i){("string"!=typeof i||""===i)&&(i="utf8");var o=0|g(t,i);return e=m(e,o),e.write(t,i),e}function d(e,t){if(r.isBuffer(t))return l(e,t);if(K(t))return h(e,t);if(null==t)throw new TypeError("must start with number, buffer, array or string");if("undefined"!=typeof ArrayBuffer){if(t.buffer instanceof ArrayBuffer)return u(e,t);if(t instanceof ArrayBuffer)return f(e,t)}return t.length?_(e,t):c(e,t)}function l(e,t){var i=0|p(t.length);return e=m(e,i),t.copy(e,0,0,i),e}function h(e,t){var i=0|p(t.length);e=m(e,i);for(var o=0;i>o;o+=1)e[o]=255&t[o];return e}function u(e,t){var i=0|p(t.length);e=m(e,i);for(var o=0;i>o;o+=1)e[o]=255&t[o];return e}function f(e,t){return r.TYPED_ARRAY_SUPPORT?(t.byteLength,e=r._augment(new Uint8Array(t))):e=u(e,new Uint8Array(t)),e}function _(e,t){var i=0|p(t.length);e=m(e,i);for(var o=0;i>o;o+=1)e[o]=255&t[o];return e}function c(e,t){var i,o=0;"Buffer"===t.type&&K(t.data)&&(i=t.data,o=0|p(i.length)),e=m(e,o);for(var s=0;o>s;s+=1)e[s]=255&i[s];return e}function m(e,t){r.TYPED_ARRAY_SUPPORT?(e=r._augment(new Uint8Array(t)),e.__proto__=r.prototype):(e.length=t,e._isBuffer=!0);var i=0!==t&&t<=r.poolSize>>>1;return i&&(e.parent=Z),e}function p(e){if(e>=s())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s().toString(16)+" bytes");return 0|e}function x(e,t){if(!(this instanceof x))return new x(e,t);var i=new r(e,t);return delete i.parent,i}function g(e,t){"string"!=typeof e&&(e=""+e);var i=e.length;if(0===i)return 0;for(var o=!1;;)switch(t){case"ascii":case"binary":case"raw":case"raws":return i;case"utf8":case"utf-8":return z(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return W(e).length;default:if(o)return z(e).length;t=(""+t).toLowerCase(),o=!0}}function v(e,t,i){var o=!1;if(t=0|t,i=void 0===i||i===1/0?this.length:0|i,e||(e="utf8"),0>t&&(t=0),i>this.length&&(i=this.length),t>=i)return"";for(;;)switch(e){case"hex":return N(this,t,i);case"utf8":case"utf-8":return E(this,t,i);case"ascii":return A(this,t,i);case"binary":return R(this,t,i);case"base64":return F(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return I(this,t,i);default:if(o)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),o=!0}}function y(e,t,i,o){i=Number(i)||0;var s=e.length-i;o?(o=Number(o),o>s&&(o=s)):o=s;var r=t.length;if(r%2!==0)throw new Error("Invalid hex string");o>r/2&&(o=r/2);for(var n=0;o>n;n++){var a=parseInt(t.substr(2*n,2),16);if(isNaN(a))throw new Error("Invalid hex string");e[i+n]=a}return n}function b(e,t,i,o){return Y(z(t,e.length-i),e,i,o)}function T(e,t,i,o){return Y(j(t),e,i,o)}function S(e,t,i,o){return T(e,t,i,o)}function M(e,t,i,o){return Y(W(t),e,i,o)}function C(e,t,i,o){return Y(H(t,e.length-i),e,i,o)}function F(e,t,i){return q.fromByteArray(0===t&&i===e.length?e:e.slice(t,i))}function E(e,t,i){i=Math.min(e.length,i);for(var o=[],s=t;i>s;){var r=e[s],n=null,a=r>239?4:r>223?3:r>191?2:1;if(i>=s+a){var d,l,h,u;switch(a){case 1:128>r&&(n=r);break;case 2:d=e[s+1],128===(192&d)&&(u=(31&r)<<6|63&d,u>127&&(n=u));break;case 3:d=e[s+1],l=e[s+2],128===(192&d)&&128===(192&l)&&(u=(15&r)<<12|(63&d)<<6|63&l,u>2047&&(55296>u||u>57343)&&(n=u));break;case 4:d=e[s+1],l=e[s+2],h=e[s+3],128===(192&d)&&128===(192&l)&&128===(192&h)&&(u=(15&r)<<18|(63&d)<<12|(63&l)<<6|63&h,u>65535&&1114112>u&&(n=u))}}null===n?(n=65533,a=1):n>65535&&(n-=65536,o.push(n>>>10&1023|55296),n=56320|1023&n),o.push(n),s+=a}return w(o)}function w(e){var t=e.length;if($>=t)return String.fromCharCode.apply(String,e);for(var i="",o=0;t>o;)i+=String.fromCharCode.apply(String,e.slice(o,o+=$));return i}function A(e,t,i){var o="";i=Math.min(e.length,i);for(var s=t;i>s;s++)o+=String.fromCharCode(127&e[s]);return o}function R(e,t,i){var o="";i=Math.min(e.length,i);for(var s=t;i>s;s++)o+=String.fromCharCode(e[s]);return o}function N(e,t,i){var o=e.length;(!t||0>t)&&(t=0),(!i||0>i||i>o)&&(i=o);for(var s="",r=t;i>r;r++)s+=X(e[r]);return s}function I(e,t,i){for(var o=e.slice(t,i),s="",r=0;r<o.length;r+=2)s+=String.fromCharCode(o[r]+256*o[r+1]);return s}function P(e,t,i){if(e%1!==0||0>e)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function D(e,t,i,o,s,n){if(!r.isBuffer(e))throw new TypeError("buffer must be a Buffer instance");if(t>s||n>t)throw new RangeError("value is out of bounds");if(i+o>e.length)throw new RangeError("index out of range")}function V(e,t,i,o){0>t&&(t=65535+t+1);for(var s=0,r=Math.min(e.length-i,2);r>s;s++)e[i+s]=(t&255<<8*(o?s:1-s))>>>8*(o?s:1-s)}function L(e,t,i,o){0>t&&(t=4294967295+t+1);for(var s=0,r=Math.min(e.length-i,4);r>s;s++)e[i+s]=t>>>8*(o?s:3-s)&255}function B(e,t,i,o,s,r){if(t>s||r>t)throw new RangeError("value is out of bounds");if(i+o>e.length)throw new RangeError("index out of range");if(0>i)throw new RangeError("index out of range")}function O(e,t,i,o,s){return s||B(e,t,i,4,3.4028234663852886e38,-3.4028234663852886e38),Q.write(e,t,i,o,23,4),i+4}function k(e,t,i,o,s){return s||B(e,t,i,8,1.7976931348623157e308,-1.7976931348623157e308),Q.write(e,t,i,o,52,8),i+8}function U(e){if(e=G(e).replace(ee,""),e.length<2)return"";for(;e.length%4!==0;)e+="=";return e}function G(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}function X(e){return 16>e?"0"+e.toString(16):e.toString(16)}function z(e,t){t=t||1/0;for(var i,o=e.length,s=null,r=[],n=0;o>n;n++){if(i=e.charCodeAt(n),i>55295&&57344>i){if(!s){if(i>56319){(t-=3)>-1&&r.push(239,191,189);continue}if(n+1===o){(t-=3)>-1&&r.push(239,191,189);continue}s=i;continue}if(56320>i){(t-=3)>-1&&r.push(239,191,189),s=i;continue}i=(s-55296<<10|i-56320)+65536}else s&&(t-=3)>-1&&r.push(239,191,189);if(s=null,128>i){if((t-=1)<0)break;r.push(i)}else if(2048>i){if((t-=2)<0)break;r.push(i>>6|192,63&i|128)}else if(65536>i){if((t-=3)<0)break;r.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(1114112>i))throw new Error("Invalid code point");if((t-=4)<0)break;r.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return r}function j(e){for(var t=[],i=0;i<e.length;i++)t.push(255&e.charCodeAt(i));return t}function H(e,t){for(var i,o,s,r=[],n=0;n<e.length&&!((t-=2)<0);n++)i=e.charCodeAt(n),o=i>>8,s=i%256,r.push(s),r.push(o);return r}function W(e){return q.toByteArray(U(e))}function Y(e,t,i,o){for(var s=0;o>s&&!(s+i>=t.length||s>=e.length);s++)t[s+i]=e[s];return s}var q=e("base64-js"),Q=e("ieee754"),K=e("isarray");i.Buffer=r,i.SlowBuffer=x,i.INSPECT_MAX_BYTES=50,r.poolSize=8192;var Z={};r.TYPED_ARRAY_SUPPORT=void 0!==t.TYPED_ARRAY_SUPPORT?t.TYPED_ARRAY_SUPPORT:o(),r.TYPED_ARRAY_SUPPORT?(r.prototype.__proto__=Uint8Array.prototype,r.__proto__=Uint8Array):(r.prototype.length=void 0,r.prototype.parent=void 0),r.isBuffer=function(e){return!(null==e||!e._isBuffer)},r.compare=function(e,t){if(!r.isBuffer(e)||!r.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var i=e.length,o=t.length,s=0,n=Math.min(i,o);n>s&&e[s]===t[s];)++s;return s!==n&&(i=e[s],o=t[s]),o>i?-1:i>o?1:0},r.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},r.concat=function(e,t){if(!K(e))throw new TypeError("list argument must be an Array of Buffers.");if(0===e.length)return new r(0);var i;if(void 0===t)for(t=0,i=0;i<e.length;i++)t+=e[i].length;var o=new r(t),s=0;for(i=0;i<e.length;i++){var n=e[i];n.copy(o,s),s+=n.length}return o},r.byteLength=g,r.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?E(this,0,e):v.apply(this,arguments)},r.prototype.equals=function(e){if(!r.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:0===r.compare(this,e)},r.prototype.inspect=function(){var e="",t=i.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,t).match(/.{2}/g).join(" "),this.length>t&&(e+=" ... ")),"<Buffer "+e+">"},r.prototype.compare=function(e){if(!r.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?0:r.compare(this,e)},r.prototype.indexOf=function(e,t){function i(e,t,i){for(var o=-1,s=0;i+s<e.length;s++)if(e[i+s]===t[-1===o?0:s-o]){if(-1===o&&(o=s),s-o+1===t.length)return i+o}else o=-1;return-1}if(t>2147483647?t=2147483647:-2147483648>t&&(t=-2147483648),t>>=0,0===this.length)return-1;if(t>=this.length)return-1;if(0>t&&(t=Math.max(this.length+t,0)),"string"==typeof e)return 0===e.length?-1:String.prototype.indexOf.call(this,e,t);if(r.isBuffer(e))return i(this,e,t);if("number"==typeof e)return r.TYPED_ARRAY_SUPPORT&&"function"===Uint8Array.prototype.indexOf?Uint8Array.prototype.indexOf.call(this,e,t):i(this,[e],t);throw new TypeError("val must be string, number or Buffer")},r.prototype.get=function(e){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(e)},r.prototype.set=function(e,t){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(e,t)},r.prototype.write=function(e,t,i,o){if(void 0===t)o="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)o=t,i=this.length,t=0;else if(isFinite(t))t=0|t,isFinite(i)?(i=0|i,void 0===o&&(o="utf8")):(o=i,i=void 0);else{var s=o;o=t,t=0|i,i=s}var r=this.length-t;if((void 0===i||i>r)&&(i=r),e.length>0&&(0>i||0>t)||t>this.length)throw new RangeError("attempt to write outside buffer bounds");o||(o="utf8");for(var n=!1;;)switch(o){case"hex":return y(this,e,t,i);case"utf8":case"utf-8":return b(this,e,t,i);case"ascii":return T(this,e,t,i);case"binary":return S(this,e,t,i);case"base64":return M(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,e,t,i);default:if(n)throw new TypeError("Unknown encoding: "+o);o=(""+o).toLowerCase(),n=!0}},r.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var $=4096;r.prototype.slice=function(e,t){var i=this.length;e=~~e,t=void 0===t?i:~~t,0>e?(e+=i,0>e&&(e=0)):e>i&&(e=i),0>t?(t+=i,0>t&&(t=0)):t>i&&(t=i),e>t&&(t=e);var o;if(r.TYPED_ARRAY_SUPPORT)o=r._augment(this.subarray(e,t));else{var s=t-e;o=new r(s,void 0);for(var n=0;s>n;n++)o[n]=this[n+e]}return o.length&&(o.parent=this.parent||this),o},r.prototype.readUIntLE=function(e,t,i){e=0|e,t=0|t,i||P(e,t,this.length);for(var o=this[e],s=1,r=0;++r<t&&(s*=256);)o+=this[e+r]*s;return o},r.prototype.readUIntBE=function(e,t,i){e=0|e,t=0|t,i||P(e,t,this.length);for(var o=this[e+--t],s=1;t>0&&(s*=256);)o+=this[e+--t]*s;return o},r.prototype.readUInt8=function(e,t){return t||P(e,1,this.length),this[e]},r.prototype.readUInt16LE=function(e,t){return t||P(e,2,this.length),this[e]|this[e+1]<<8},r.prototype.readUInt16BE=function(e,t){return t||P(e,2,this.length),this[e]<<8|this[e+1]},r.prototype.readUInt32LE=function(e,t){return t||P(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},r.prototype.readUInt32BE=function(e,t){return t||P(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},r.prototype.readIntLE=function(e,t,i){e=0|e,t=0|t,i||P(e,t,this.length);for(var o=this[e],s=1,r=0;++r<t&&(s*=256);)o+=this[e+r]*s;return s*=128,o>=s&&(o-=Math.pow(2,8*t)),o},r.prototype.readIntBE=function(e,t,i){e=0|e,t=0|t,i||P(e,t,this.length);for(var o=t,s=1,r=this[e+--o];o>0&&(s*=256);)r+=this[e+--o]*s;return s*=128,r>=s&&(r-=Math.pow(2,8*t)),r},r.prototype.readInt8=function(e,t){return t||P(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},r.prototype.readInt16LE=function(e,t){t||P(e,2,this.length);var i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},r.prototype.readInt16BE=function(e,t){t||P(e,2,this.length);var i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},r.prototype.readInt32LE=function(e,t){return t||P(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},r.prototype.readInt32BE=function(e,t){return t||P(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},r.prototype.readFloatLE=function(e,t){return t||P(e,4,this.length),Q.read(this,e,!0,23,4)},r.prototype.readFloatBE=function(e,t){return t||P(e,4,this.length),Q.read(this,e,!1,23,4)},r.prototype.readDoubleLE=function(e,t){return t||P(e,8,this.length),Q.read(this,e,!0,52,8)},r.prototype.readDoubleBE=function(e,t){return t||P(e,8,this.length),Q.read(this,e,!1,52,8)},r.prototype.writeUIntLE=function(e,t,i,o){e=+e,t=0|t,i=0|i,o||D(this,e,t,i,Math.pow(2,8*i),0);var s=1,r=0;for(this[t]=255&e;++r<i&&(s*=256);)this[t+r]=e/s&255;return t+i},r.prototype.writeUIntBE=function(e,t,i,o){e=+e,t=0|t,i=0|i,o||D(this,e,t,i,Math.pow(2,8*i),0);var s=i-1,r=1;for(this[t+s]=255&e;--s>=0&&(r*=256);)this[t+s]=e/r&255;return t+i},r.prototype.writeUInt8=function(e,t,i){return e=+e,t=0|t,i||D(this,e,t,1,255,0),r.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},r.prototype.writeUInt16LE=function(e,t,i){return e=+e,t=0|t,i||D(this,e,t,2,65535,0),r.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):V(this,e,t,!0),t+2},r.prototype.writeUInt16BE=function(e,t,i){return e=+e,t=0|t,i||D(this,e,t,2,65535,0),r.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):V(this,e,t,!1),t+2},r.prototype.writeUInt32LE=function(e,t,i){return e=+e,t=0|t,i||D(this,e,t,4,4294967295,0),r.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):L(this,e,t,!0),t+4},r.prototype.writeUInt32BE=function(e,t,i){return e=+e,t=0|t,i||D(this,e,t,4,4294967295,0),r.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):L(this,e,t,!1),t+4},r.prototype.writeIntLE=function(e,t,i,o){if(e=+e,t=0|t,!o){var s=Math.pow(2,8*i-1);D(this,e,t,i,s-1,-s)}var r=0,n=1,a=0>e?1:0;for(this[t]=255&e;++r<i&&(n*=256);)this[t+r]=(e/n>>0)-a&255;return t+i},r.prototype.writeIntBE=function(e,t,i,o){if(e=+e,t=0|t,!o){var s=Math.pow(2,8*i-1);D(this,e,t,i,s-1,-s)}var r=i-1,n=1,a=0>e?1:0;for(this[t+r]=255&e;--r>=0&&(n*=256);)this[t+r]=(e/n>>0)-a&255;return t+i},r.prototype.writeInt8=function(e,t,i){return e=+e,t=0|t,i||D(this,e,t,1,127,-128),r.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),0>e&&(e=255+e+1),this[t]=255&e,t+1},r.prototype.writeInt16LE=function(e,t,i){return e=+e,t=0|t,i||D(this,e,t,2,32767,-32768),r.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):V(this,e,t,!0),t+2},r.prototype.writeInt16BE=function(e,t,i){return e=+e,t=0|t,i||D(this,e,t,2,32767,-32768),r.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):V(this,e,t,!1),t+2},r.prototype.writeInt32LE=function(e,t,i){return e=+e,t=0|t,i||D(this,e,t,4,2147483647,-2147483648),r.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):L(this,e,t,!0),t+4},r.prototype.writeInt32BE=function(e,t,i){return e=+e,t=0|t,i||D(this,e,t,4,2147483647,-2147483648),0>e&&(e=4294967295+e+1),r.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):L(this,e,t,!1),t+4},r.prototype.writeFloatLE=function(e,t,i){return O(this,e,t,!0,i)},r.prototype.writeFloatBE=function(e,t,i){return O(this,e,t,!1,i)},r.prototype.writeDoubleLE=function(e,t,i){return k(this,e,t,!0,i)},r.prototype.writeDoubleBE=function(e,t,i){return k(this,e,t,!1,i)},r.prototype.copy=function(e,t,i,o){if(i||(i=0),o||0===o||(o=this.length),t>=e.length&&(t=e.length),t||(t=0),o>0&&i>o&&(o=i),o===i)return 0;if(0===e.length||0===this.length)return 0;if(0>t)throw new RangeError("targetStart out of bounds");if(0>i||i>=this.length)throw new RangeError("sourceStart out of bounds");if(0>o)throw new RangeError("sourceEnd out of bounds");o>this.length&&(o=this.length),e.length-t<o-i&&(o=e.length-t+i);var s,n=o-i;if(this===e&&t>i&&o>t)for(s=n-1;s>=0;s--)e[s+t]=this[s+i];else if(1e3>n||!r.TYPED_ARRAY_SUPPORT)for(s=0;n>s;s++)e[s+t]=this[s+i];else e._set(this.subarray(i,i+n),t);return n},r.prototype.fill=function(e,t,i){if(e||(e=0),t||(t=0),i||(i=this.length),t>i)throw new RangeError("end < start");if(i!==t&&0!==this.length){if(0>t||t>=this.length)throw new RangeError("start out of bounds");if(0>i||i>this.length)throw new RangeError("end out of bounds");var o;if("number"==typeof e)for(o=t;i>o;o++)this[o]=e;else{var s=z(e.toString()),r=s.length;for(o=t;i>o;o++)this[o]=s[o%r]}return this}},r.prototype.toArrayBuffer=function(){if("undefined"!=typeof Uint8Array){if(r.TYPED_ARRAY_SUPPORT)return new r(this).buffer;for(var e=new Uint8Array(this.length),t=0,i=e.length;i>t;t+=1)e[t]=this[t];return e.buffer}throw new TypeError("Buffer.toArrayBuffer not supported in this browser")};var J=r.prototype;r._augment=function(e){return e.constructor=r,e._isBuffer=!0,e._set=e.set,e.get=J.get,e.set=J.set,e.write=J.write,e.toString=J.toString,e.toLocaleString=J.toString,e.toJSON=J.toJSON,e.equals=J.equals,e.compare=J.compare,e.indexOf=J.indexOf,e.copy=J.copy,e.slice=J.slice,e.readUIntLE=J.readUIntLE,e.readUIntBE=J.readUIntBE,e.readUInt8=J.readUInt8,e.readUInt16LE=J.readUInt16LE,e.readUInt16BE=J.readUInt16BE,e.readUInt32LE=J.readUInt32LE,e.readUInt32BE=J.readUInt32BE,e.readIntLE=J.readIntLE,e.readIntBE=J.readIntBE,e.readInt8=J.readInt8,e.readInt16LE=J.readInt16LE,e.readInt16BE=J.readInt16BE,e.readInt32LE=J.readInt32LE,e.readInt32BE=J.readInt32BE,e.readFloatLE=J.readFloatLE,e.readFloatBE=J.readFloatBE,e.readDoubleLE=J.readDoubleLE,e.readDoubleBE=J.readDoubleBE,e.writeUInt8=J.writeUInt8,e.writeUIntLE=J.writeUIntLE,e.writeUIntBE=J.writeUIntBE,e.writeUInt16LE=J.writeUInt16LE,e.writeUInt16BE=J.writeUInt16BE,e.writeUInt32LE=J.writeUInt32LE,e.writeUInt32BE=J.writeUInt32BE,e.writeIntLE=J.writeIntLE,e.writeIntBE=J.writeIntBE,e.writeInt8=J.writeInt8,e.writeInt16LE=J.writeInt16LE,e.writeInt16BE=J.writeInt16BE,e.writeInt32LE=J.writeInt32LE,e.writeInt32BE=J.writeInt32BE,e.writeFloatLE=J.writeFloatLE,e.writeFloatBE=J.writeFloatBE,e.writeDoubleLE=J.writeDoubleLE,e.writeDoubleBE=J.writeDoubleBE,e.fill=J.fill,e.inspect=J.inspect,e.toArrayBuffer=J.toArrayBuffer,e};var ee=/[^+\/0-9A-Za-z-_]/g}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"base64-js":1,ieee754:7,isarray:8}],3:[function(e,t){if(!i)var i=1e-6;if(!o)var o="undefined"!=typeof Float32Array?Float32Array:Array;if(!s)var s=Math.random;var r={};r.setMatrixArrayType=function(e){o=e};var n=Math.PI/180;r.toRadian=function(e){return e*n},t.exports={GLMAT_EPSILON:i,GLMAT_ARRAY_TYPE:o,GLMAT_RANDOM:s,glMatrix:r}},{}],4:[function(e,t){var i={},o=e("common").GLMAT_ARRAY_TYPE;i.create=function(){var e=new o(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},i.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},i.clone=function(e){var t=new o(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},i.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},i.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},i.transpose=function(e,t){if(e===t){var i=t[1],o=t[2],s=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=o,e[7]=s}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},i.invert=function(e,t){var i=t[0],o=t[1],s=t[2],r=t[3],n=t[4],a=t[5],d=t[6],l=t[7],h=t[8],u=h*n-a*l,f=-h*r+a*d,_=l*r-n*d,c=i*u+o*f+s*_;return c?(c=1/c,e[0]=u*c,e[1]=(-h*o+s*l)*c,e[2]=(a*o-s*n)*c,e[3]=f*c,e[4]=(h*i-s*d)*c,e[5]=(-a*i+s*r)*c,e[6]=_*c,e[7]=(-l*i+o*d)*c,e[8]=(n*i-o*r)*c,e):null},i.adjoint=function(e,t){var i=t[0],o=t[1],s=t[2],r=t[3],n=t[4],a=t[5],d=t[6],l=t[7],h=t[8];return e[0]=n*h-a*l,e[1]=s*l-o*h,e[2]=o*a-s*n,e[3]=a*d-r*h,e[4]=i*h-s*d,e[5]=s*r-i*a,e[6]=r*l-n*d,e[7]=o*d-i*l,e[8]=i*n-o*r,e},i.determinant=function(e){var t=e[0],i=e[1],o=e[2],s=e[3],r=e[4],n=e[5],a=e[6],d=e[7],l=e[8];return t*(l*r-n*d)+i*(-l*s+n*a)+o*(d*s-r*a)},i.multiply=function(e,t,i){var o=t[0],s=t[1],r=t[2],n=t[3],a=t[4],d=t[5],l=t[6],h=t[7],u=t[8],f=i[0],_=i[1],c=i[2],m=i[3],p=i[4],x=i[5],g=i[6],v=i[7],y=i[8];return e[0]=f*o+_*n+c*l,e[1]=f*s+_*a+c*h,e[2]=f*r+_*d+c*u,e[3]=m*o+p*n+x*l,e[4]=m*s+p*a+x*h,e[5]=m*r+p*d+x*u,e[6]=g*o+v*n+y*l,e[7]=g*s+v*a+y*h,e[8]=g*r+v*d+y*u,e},i.mul=i.multiply,i.translate=function(e,t,i){var o=t[0],s=t[1],r=t[2],n=t[3],a=t[4],d=t[5],l=t[6],h=t[7],u=t[8],f=i[0],_=i[1];return e[0]=o,e[1]=s,e[2]=r,e[3]=n,e[4]=a,e[5]=d,e[6]=f*o+_*n+l,e[7]=f*s+_*a+h,e[8]=f*r+_*d+u,e},i.rotate=function(e,t,i){var o=t[0],s=t[1],r=t[2],n=t[3],a=t[4],d=t[5],l=t[6],h=t[7],u=t[8],f=Math.sin(i),_=Math.cos(i);return e[0]=_*o+f*n,e[1]=_*s+f*a,e[2]=_*r+f*d,e[3]=_*n-f*o,e[4]=_*a-f*s,e[5]=_*d-f*r,e[6]=l,e[7]=h,e[8]=u,e},i.scale=function(e,t,i){var o=i[0],s=i[1];return e[0]=o*t[0],e[1]=o*t[1],e[2]=o*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},i.fromMat2d=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},i.fromQuat=function(e,t){var i=t[0],o=t[1],s=t[2],r=t[3],n=i+i,a=o+o,d=s+s,l=i*n,h=o*n,u=o*a,f=s*n,_=s*a,c=s*d,m=r*n,p=r*a,x=r*d;return e[0]=1-u-c,e[3]=h-x,e[6]=f+p,e[1]=h+x,e[4]=1-l-c,e[7]=_-m,e[2]=f-p,e[5]=_+m,e[8]=1-l-u,e},i.normalFromMat4=function(e,t){var i=t[0],o=t[1],s=t[2],r=t[3],n=t[4],a=t[5],d=t[6],l=t[7],h=t[8],u=t[9],f=t[10],_=t[11],c=t[12],m=t[13],p=t[14],x=t[15],g=i*a-o*n,v=i*d-s*n,y=i*l-r*n,b=o*d-s*a,T=o*l-r*a,S=s*l-r*d,M=h*m-u*c,C=h*p-f*c,F=h*x-_*c,E=u*p-f*m,w=u*x-_*m,A=f*x-_*p,R=g*A-v*w+y*E+b*F-T*C+S*M;return R?(R=1/R,e[0]=(a*A-d*w+l*E)*R,e[1]=(d*F-n*A-l*C)*R,e[2]=(n*w-a*F+l*M)*R,e[3]=(s*w-o*A-r*E)*R,e[4]=(i*A-s*F+r*C)*R,e[5]=(o*F-i*w-r*M)*R,e[6]=(m*S-p*T+x*b)*R,e[7]=(p*y-c*S-x*v)*R,e[8]=(c*T-m*y+x*g)*R,e):null},i.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},i.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2))},t.exports=i},{common:3}],5:[function(e,t){var i={},o=e("common").GLMAT_ARRAY_TYPE,s=e("common").GLMAT_EPSILON;i.create=function(){var e=new o(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},i.clone=function(e){var t=new o(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},i.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},i.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},i.transpose=function(e,t){if(e===t){var i=t[1],o=t[2],s=t[3],r=t[6],n=t[7],a=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=i,e[6]=t[9],e[7]=t[13],e[8]=o,e[9]=r,e[11]=t[14],e[12]=s,e[13]=n,e[14]=a}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},i.invert=function(e,t){var i=t[0],o=t[1],s=t[2],r=t[3],n=t[4],a=t[5],d=t[6],l=t[7],h=t[8],u=t[9],f=t[10],_=t[11],c=t[12],m=t[13],p=t[14],x=t[15],g=i*a-o*n,v=i*d-s*n,y=i*l-r*n,b=o*d-s*a,T=o*l-r*a,S=s*l-r*d,M=h*m-u*c,C=h*p-f*c,F=h*x-_*c,E=u*p-f*m,w=u*x-_*m,A=f*x-_*p,R=g*A-v*w+y*E+b*F-T*C+S*M;return R?(R=1/R,e[0]=(a*A-d*w+l*E)*R,e[1]=(s*w-o*A-r*E)*R,e[2]=(m*S-p*T+x*b)*R,e[3]=(f*T-u*S-_*b)*R,e[4]=(d*F-n*A-l*C)*R,e[5]=(i*A-s*F+r*C)*R,e[6]=(p*y-c*S-x*v)*R,e[7]=(h*S-f*y+_*v)*R,e[8]=(n*w-a*F+l*M)*R,e[9]=(o*F-i*w-r*M)*R,e[10]=(c*T-m*y+x*g)*R,e[11]=(u*y-h*T-_*g)*R,e[12]=(a*C-n*E-d*M)*R,e[13]=(i*E-o*C+s*M)*R,e[14]=(m*v-c*b-p*g)*R,e[15]=(h*b-u*v+f*g)*R,e):null},i.adjoint=function(e,t){var i=t[0],o=t[1],s=t[2],r=t[3],n=t[4],a=t[5],d=t[6],l=t[7],h=t[8],u=t[9],f=t[10],_=t[11],c=t[12],m=t[13],p=t[14],x=t[15];return e[0]=a*(f*x-_*p)-u*(d*x-l*p)+m*(d*_-l*f),e[1]=-(o*(f*x-_*p)-u*(s*x-r*p)+m*(s*_-r*f)),e[2]=o*(d*x-l*p)-a*(s*x-r*p)+m*(s*l-r*d),e[3]=-(o*(d*_-l*f)-a*(s*_-r*f)+u*(s*l-r*d)),e[4]=-(n*(f*x-_*p)-h*(d*x-l*p)+c*(d*_-l*f)),e[5]=i*(f*x-_*p)-h*(s*x-r*p)+c*(s*_-r*f),e[6]=-(i*(d*x-l*p)-n*(s*x-r*p)+c*(s*l-r*d)),e[7]=i*(d*_-l*f)-n*(s*_-r*f)+h*(s*l-r*d),e[8]=n*(u*x-_*m)-h*(a*x-l*m)+c*(a*_-l*u),e[9]=-(i*(u*x-_*m)-h*(o*x-r*m)+c*(o*_-r*u)),e[10]=i*(a*x-l*m)-n*(o*x-r*m)+c*(o*l-r*a),e[11]=-(i*(a*_-l*u)-n*(o*_-r*u)+h*(o*l-r*a)),e[12]=-(n*(u*p-f*m)-h*(a*p-d*m)+c*(a*f-d*u)),e[13]=i*(u*p-f*m)-h*(o*p-s*m)+c*(o*f-s*u),e[14]=-(i*(a*p-d*m)-n*(o*p-s*m)+c*(o*d-s*a)),e[15]=i*(a*f-d*u)-n*(o*f-s*u)+h*(o*d-s*a),e},i.determinant=function(e){var t=e[0],i=e[1],o=e[2],s=e[3],r=e[4],n=e[5],a=e[6],d=e[7],l=e[8],h=e[9],u=e[10],f=e[11],_=e[12],c=e[13],m=e[14],p=e[15],x=t*n-i*r,g=t*a-o*r,v=t*d-s*r,y=i*a-o*n,b=i*d-s*n,T=o*d-s*a,S=l*c-h*_,M=l*m-u*_,C=l*p-f*_,F=h*m-u*c,E=h*p-f*c,w=u*p-f*m;return x*w-g*E+v*F+y*C-b*M+T*S},i.multiply=function(e,t,i){var o=t[0],s=t[1],r=t[2],n=t[3],a=t[4],d=t[5],l=t[6],h=t[7],u=t[8],f=t[9],_=t[10],c=t[11],m=t[12],p=t[13],x=t[14],g=t[15],v=i[0],y=i[1],b=i[2],T=i[3];return e[0]=v*o+y*a+b*u+T*m,e[1]=v*s+y*d+b*f+T*p,e[2]=v*r+y*l+b*_+T*x,e[3]=v*n+y*h+b*c+T*g,v=i[4],y=i[5],b=i[6],T=i[7],e[4]=v*o+y*a+b*u+T*m,e[5]=v*s+y*d+b*f+T*p,e[6]=v*r+y*l+b*_+T*x,e[7]=v*n+y*h+b*c+T*g,v=i[8],y=i[9],b=i[10],T=i[11],e[8]=v*o+y*a+b*u+T*m,e[9]=v*s+y*d+b*f+T*p,e[10]=v*r+y*l+b*_+T*x,e[11]=v*n+y*h+b*c+T*g,v=i[12],y=i[13],b=i[14],T=i[15],e[12]=v*o+y*a+b*u+T*m,e[13]=v*s+y*d+b*f+T*p,e[14]=v*r+y*l+b*_+T*x,e[15]=v*n+y*h+b*c+T*g,e},i.mul=i.multiply,i.translate=function(e,t,i){var o,s,r,n,a,d,l,h,u,f,_,c,m=i[0],p=i[1],x=i[2];return t===e?(e[12]=t[0]*m+t[4]*p+t[8]*x+t[12],e[13]=t[1]*m+t[5]*p+t[9]*x+t[13],e[14]=t[2]*m+t[6]*p+t[10]*x+t[14],e[15]=t[3]*m+t[7]*p+t[11]*x+t[15]):(o=t[0],s=t[1],r=t[2],n=t[3],a=t[4],d=t[5],l=t[6],h=t[7],u=t[8],f=t[9],_=t[10],c=t[11],e[0]=o,e[1]=s,e[2]=r,e[3]=n,e[4]=a,e[5]=d,e[6]=l,e[7]=h,e[8]=u,e[9]=f,e[10]=_,e[11]=c,e[12]=o*m+a*p+u*x+t[12],e[13]=s*m+d*p+f*x+t[13],e[14]=r*m+l*p+_*x+t[14],e[15]=n*m+h*p+c*x+t[15]),e},i.scale=function(e,t,i){var o=i[0],s=i[1],r=i[2];return e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e[3]=t[3]*o,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},i.rotate=function(e,t,i,o){var r,n,a,d,l,h,u,f,_,c,m,p,x,g,v,y,b,T,S,M,C,F,E,w,A=o[0],R=o[1],N=o[2],I=Math.sqrt(A*A+R*R+N*N);return Math.abs(I)<s?null:(I=1/I,A*=I,R*=I,N*=I,r=Math.sin(i),n=Math.cos(i),a=1-n,d=t[0],l=t[1],h=t[2],u=t[3],f=t[4],_=t[5],c=t[6],m=t[7],p=t[8],x=t[9],g=t[10],v=t[11],y=A*A*a+n,b=R*A*a+N*r,T=N*A*a-R*r,S=A*R*a-N*r,M=R*R*a+n,C=N*R*a+A*r,F=A*N*a+R*r,E=R*N*a-A*r,w=N*N*a+n,e[0]=d*y+f*b+p*T,e[1]=l*y+_*b+x*T,e[2]=h*y+c*b+g*T,e[3]=u*y+m*b+v*T,e[4]=d*S+f*M+p*C,e[5]=l*S+_*M+x*C,e[6]=h*S+c*M+g*C,e[7]=u*S+m*M+v*C,e[8]=d*F+f*E+p*w,e[9]=l*F+_*E+x*w,e[10]=h*F+c*E+g*w,e[11]=u*F+m*E+v*w,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)},i.rotateX=function(e,t,i){var o=Math.sin(i),s=Math.cos(i),r=t[4],n=t[5],a=t[6],d=t[7],l=t[8],h=t[9],u=t[10],f=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=r*s+l*o,e[5]=n*s+h*o,e[6]=a*s+u*o,e[7]=d*s+f*o,e[8]=l*s-r*o,e[9]=h*s-n*o,e[10]=u*s-a*o,e[11]=f*s-d*o,e},i.rotateY=function(e,t,i){var o=Math.sin(i),s=Math.cos(i),r=t[0],n=t[1],a=t[2],d=t[3],l=t[8],h=t[9],u=t[10],f=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*s-l*o,e[1]=n*s-h*o,e[2]=a*s-u*o,e[3]=d*s-f*o,e[8]=r*o+l*s,e[9]=n*o+h*s,e[10]=a*o+u*s,e[11]=d*o+f*s,e},i.rotateZ=function(e,t,i){var o=Math.sin(i),s=Math.cos(i),r=t[0],n=t[1],a=t[2],d=t[3],l=t[4],h=t[5],u=t[6],f=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*s+l*o,e[1]=n*s+h*o,e[2]=a*s+u*o,e[3]=d*s+f*o,e[4]=l*s-r*o,e[5]=h*s-n*o,e[6]=u*s-a*o,e[7]=f*s-d*o,e},i.fromRotationTranslation=function(e,t,i){var o=t[0],s=t[1],r=t[2],n=t[3],a=o+o,d=s+s,l=r+r,h=o*a,u=o*d,f=o*l,_=s*d,c=s*l,m=r*l,p=n*a,x=n*d,g=n*l;return e[0]=1-(_+m),e[1]=u+g,e[2]=f-x,e[3]=0,e[4]=u-g,e[5]=1-(h+m),e[6]=c+p,e[7]=0,e[8]=f+x,e[9]=c-p,e[10]=1-(h+_),e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e},i.fromQuat=function(e,t){var i=t[0],o=t[1],s=t[2],r=t[3],n=i+i,a=o+o,d=s+s,l=i*n,h=o*n,u=o*a,f=s*n,_=s*a,c=s*d,m=r*n,p=r*a,x=r*d;return e[0]=1-u-c,e[1]=h+x,e[2]=f-p,e[3]=0,e[4]=h-x,e[5]=1-l-c,e[6]=_+m,e[7]=0,e[8]=f+p,e[9]=_-m,e[10]=1-l-u,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},i.frustum=function(e,t,i,o,s,r,n){var a=1/(i-t),d=1/(s-o),l=1/(r-n);return e[0]=2*r*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*r*d,e[6]=0,e[7]=0,e[8]=(i+t)*a,e[9]=(s+o)*d,e[10]=(n+r)*l,e[11]=-1,e[12]=0,e[13]=0,e[14]=n*r*2*l,e[15]=0,e},i.perspective=function(e,t,i,o,s){var r=1/Math.tan(t/2),n=1/(o-s);return e[0]=r/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(s+o)*n,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*s*o*n,e[15]=0,e},i.ortho=function(e,t,i,o,s,r,n){var a=1/(t-i),d=1/(o-s),l=1/(r-n);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*d,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*l,e[11]=0,e[12]=(t+i)*a,e[13]=(s+o)*d,e[14]=(n+r)*l,e[15]=1,e},i.lookAt=function(e,t,o,r){var n,a,d,l,h,u,f,_,c,m,p=t[0],x=t[1],g=t[2],v=r[0],y=r[1],b=r[2],T=o[0],S=o[1],M=o[2];return Math.abs(p-T)<s&&Math.abs(x-S)<s&&Math.abs(g-M)<s?i.identity(e):(f=p-T,
_=x-S,c=g-M,m=1/Math.sqrt(f*f+_*_+c*c),f*=m,_*=m,c*=m,n=y*c-b*_,a=b*f-v*c,d=v*_-y*f,m=Math.sqrt(n*n+a*a+d*d),m?(m=1/m,n*=m,a*=m,d*=m):(n=0,a=0,d=0),l=_*d-c*a,h=c*n-f*d,u=f*a-_*n,m=Math.sqrt(l*l+h*h+u*u),m?(m=1/m,l*=m,h*=m,u*=m):(l=0,h=0,u=0),e[0]=n,e[1]=l,e[2]=f,e[3]=0,e[4]=a,e[5]=h,e[6]=_,e[7]=0,e[8]=d,e[9]=u,e[10]=c,e[11]=0,e[12]=-(n*p+a*x+d*g),e[13]=-(l*p+h*x+u*g),e[14]=-(f*p+_*x+c*g),e[15]=1,e)},i.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},i.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2)+Math.pow(e[9],2)+Math.pow(e[10],2)+Math.pow(e[11],2)+Math.pow(e[12],2)+Math.pow(e[13],2)+Math.pow(e[14],2)+Math.pow(e[15],2))},t.exports=i},{common:3}],6:[function(e,t){var i={},o=e("common").GLMAT_ARRAY_TYPE,s=e("common").GLMAT_RANDOM;i.create=function(){var e=new o(3);return e[0]=0,e[1]=0,e[2]=0,e},i.clone=function(e){var t=new o(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},i.fromValues=function(e,t,i){var s=new o(3);return s[0]=e,s[1]=t,s[2]=i,s},i.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},i.set=function(e,t,i,o){return e[0]=t,e[1]=i,e[2]=o,e},i.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e},i.subtract=function(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e},i.sub=i.subtract,i.multiply=function(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e},i.mul=i.multiply,i.divide=function(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e},i.div=i.divide,i.min=function(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e},i.max=function(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e},i.scale=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e},i.scaleAndAdd=function(e,t,i,o){return e[0]=t[0]+i[0]*o,e[1]=t[1]+i[1]*o,e[2]=t[2]+i[2]*o,e},i.distance=function(e,t){var i=t[0]-e[0],o=t[1]-e[1],s=t[2]-e[2];return Math.sqrt(i*i+o*o+s*s)},i.dist=i.distance,i.squaredDistance=function(e,t){var i=t[0]-e[0],o=t[1]-e[1],s=t[2]-e[2];return i*i+o*o+s*s},i.sqrDist=i.squaredDistance,i.length=function(e){var t=e[0],i=e[1],o=e[2];return Math.sqrt(t*t+i*i+o*o)},i.len=i.length,i.squaredLength=function(e){var t=e[0],i=e[1],o=e[2];return t*t+i*i+o*o},i.sqrLen=i.squaredLength,i.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},i.normalize=function(e,t){var i=t[0],o=t[1],s=t[2],r=i*i+o*o+s*s;return r>0&&(r=1/Math.sqrt(r),e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r),e},i.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},i.cross=function(e,t,i){var o=t[0],s=t[1],r=t[2],n=i[0],a=i[1],d=i[2];return e[0]=s*d-r*a,e[1]=r*n-o*d,e[2]=o*a-s*n,e},i.lerp=function(e,t,i,o){var s=t[0],r=t[1],n=t[2];return e[0]=s+o*(i[0]-s),e[1]=r+o*(i[1]-r),e[2]=n+o*(i[2]-n),e},i.random=function(e,t){t=t||1;var i=2*s()*Math.PI,o=2*s()-1,r=Math.sqrt(1-o*o)*t;return e[0]=Math.cos(i)*r,e[1]=Math.sin(i)*r,e[2]=o*t,e},i.transformMat4=function(e,t,i){var o=t[0],s=t[1],r=t[2];return e[0]=i[0]*o+i[4]*s+i[8]*r+i[12],e[1]=i[1]*o+i[5]*s+i[9]*r+i[13],e[2]=i[2]*o+i[6]*s+i[10]*r+i[14],e},i.transformMat3=function(e,t,i){var o=t[0],s=t[1],r=t[2];return e[0]=o*i[0]+s*i[3]+r*i[6],e[1]=o*i[1]+s*i[4]+r*i[7],e[2]=o*i[2]+s*i[5]+r*i[8],e},i.transformQuat=function(e,t,i){var o=t[0],s=t[1],r=t[2],n=i[0],a=i[1],d=i[2],l=i[3],h=l*o+a*r-d*s,u=l*s+d*o-n*r,f=l*r+n*s-a*o,_=-n*o-a*s-d*r;return e[0]=h*l+_*-n+u*-d-f*-a,e[1]=u*l+_*-a+f*-n-h*-d,e[2]=f*l+_*-d+h*-a-u*-n,e},i.rotateX=function(e,t,i,o){var s=[],r=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],r[0]=s[0],r[1]=s[1]*Math.cos(o)-s[2]*Math.sin(o),r[2]=s[1]*Math.sin(o)+s[2]*Math.cos(o),e[0]=r[0]+i[0],e[1]=r[1]+i[1],e[2]=r[2]+i[2],e},i.rotateY=function(e,t,i,o){var s=[],r=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],r[0]=s[2]*Math.sin(o)+s[0]*Math.cos(o),r[1]=s[1],r[2]=s[2]*Math.cos(o)-s[0]*Math.sin(o),e[0]=r[0]+i[0],e[1]=r[1]+i[1],e[2]=r[2]+i[2],e},i.rotateZ=function(e,t,i,o){var s=[],r=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],r[0]=s[0]*Math.cos(o)-s[1]*Math.sin(o),r[1]=s[0]*Math.sin(o)+s[1]*Math.cos(o),r[2]=s[2],e[0]=r[0]+i[0],e[1]=r[1]+i[1],e[2]=r[2]+i[2],e},i.forEach=function(){var e=i.create();return function(t,i,o,s,r,n){var a,d;for(i||(i=3),o||(o=0),d=s?Math.min(s*i+o,t.length):t.length,a=o;d>a;a+=i)e[0]=t[a],e[1]=t[a+1],e[2]=t[a+2],r(e,e,n),t[a]=e[0],t[a+1]=e[1],t[a+2]=e[2];return t}}(),i.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},t.exports=i},{common:3}],7:[function(e,t,i){i.read=function(e,t,i,o,s){var r,n,a=8*s-o-1,d=(1<<a)-1,l=d>>1,h=-7,u=i?s-1:0,f=i?-1:1,_=e[t+u];for(u+=f,r=_&(1<<-h)-1,_>>=-h,h+=a;h>0;r=256*r+e[t+u],u+=f,h-=8);for(n=r&(1<<-h)-1,r>>=-h,h+=o;h>0;n=256*n+e[t+u],u+=f,h-=8);if(0===r)r=1-l;else{if(r===d)return n?0/0:(_?-1:1)*(1/0);n+=Math.pow(2,o),r-=l}return(_?-1:1)*n*Math.pow(2,r-o)},i.write=function(e,t,i,o,s,r){var n,a,d,l=8*r-s-1,h=(1<<l)-1,u=h>>1,f=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,_=o?0:r-1,c=o?1:-1,m=0>t||0===t&&0>1/t?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,n=h):(n=Math.floor(Math.log(t)/Math.LN2),t*(d=Math.pow(2,-n))<1&&(n--,d*=2),t+=n+u>=1?f/d:f*Math.pow(2,1-u),t*d>=2&&(n++,d/=2),n+u>=h?(a=0,n=h):n+u>=1?(a=(t*d-1)*Math.pow(2,s),n+=u):(a=t*Math.pow(2,u-1)*Math.pow(2,s),n=0));s>=8;e[i+_]=255&a,_+=c,a/=256,s-=8);for(n=n<<s|a,l+=s;l>0;e[i+_]=255&n,_+=c,n/=256,l-=8);e[i+_-c]|=128*m}},{}],8:[function(e,t){var i={}.toString;t.exports=Array.isArray||function(e){return"[object Array]"==i.call(e)}},{}],9:[function(e,t,i){!function(o){var s=this;"object"==typeof i?t.exports=o(s,e("jdataview")):"function"==typeof define&&define.amd?define(["jdataview"],function(e){return o(s,e)}):s.jBinary=o(s,s.jDataView)}(function(e,t){"use strict";function i(e,t){return t&&e instanceof t}function o(e){for(var t=1,i=arguments.length;i>t;++t){var o=arguments[t];for(var s in o)void 0!==o[s]&&(e[s]=o[s])}return e}function s(e){return arguments[0]=f(e),o.apply(null,arguments)}function r(e,t,o){return i(o,Function)?o.call(e,t.contexts[0]):o}function n(e){return function(){var t=arguments,o=t.length-1,s=e.length-1,r=t[o];if(t.length=s+1,!i(r,Function)){var n=this;return new u(function(i,o){t[s]=function(e,t){return e?o(e):i(t)},e.apply(n,t)})}t[o]=void 0,t[s]=r,e.apply(this,t)}}function a(e,o){return i(e,a)?e.as(o):(i(e,t)||(e=new t(e,void 0,void 0,o?o["jBinary.littleEndian"]:void 0)),i(this,a)?(this.view=e,this.view.seek(0),this.contexts=[],this.as(o,!0)):new a(e,o))}function d(e){return s(d.prototype,e)}function l(e){return s(l.prototype,e,{createProperty:function(){var t=(e.createProperty||l.prototype.createProperty).apply(this,arguments);return t.getBaseType&&(t.baseType=t.binary.getType(t.getBaseType(t.binary.contexts[0]))),t}})}var h=e.document;"atob"in e&&"btoa"in e||!function(){function t(e){var t,i,s,r,n,a;for(s=e.length,i=0,t="";s>i;){if(r=255&e.charCodeAt(i++),i==s){t+=o.charAt(r>>2),t+=o.charAt((3&r)<<4),t+="==";break}if(n=e.charCodeAt(i++),i==s){t+=o.charAt(r>>2),t+=o.charAt((3&r)<<4|(240&n)>>4),t+=o.charAt((15&n)<<2),t+="=";break}a=e.charCodeAt(i++),t+=o.charAt(r>>2),t+=o.charAt((3&r)<<4|(240&n)>>4),t+=o.charAt((15&n)<<2|(192&a)>>6),t+=o.charAt(63&a)}return t}function i(e){var t,i,o,r,n,a,d;for(a=e.length,n=0,d="";a>n;){do t=s[255&e.charCodeAt(n++)];while(a>n&&-1==t);if(-1==t)break;do i=s[255&e.charCodeAt(n++)];while(a>n&&-1==i);if(-1==i)break;d+=String.fromCharCode(t<<2|(48&i)>>4);do{if(o=255&e.charCodeAt(n++),61==o)return d;o=s[o]}while(a>n&&-1==o);if(-1==o)break;d+=String.fromCharCode((15&i)<<4|(60&o)>>2);do{if(r=255&e.charCodeAt(n++),61==r)return d;r=s[r]}while(a>n&&-1==r);if(-1==r)break;d+=String.fromCharCode((3&o)<<6|r)}return d}var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1];e.btoa||(e.btoa=t),e.atob||(e.atob=i)}();var u=e.Promise||function(e){this.then=e},f=Object.create;f||(f=function(e){var t=function(){};return t.prototype=e,new t});var _=a.prototype,c=_.typeSet={};_.toValue=function(e){return r(this,this,e)},_._named=function(e,t,i){return e.displayName=t+" @ "+(void 0!==i?i:this.view.tell()),e};var m=Object.defineProperty;if(m)try{m({},"x",{})}catch(p){m=void 0}else m=function(e,t,i,o){o&&(e[t]=i.value)};var x="jBinary.Cache",g=0;if(_._getCached=function(e,t,i){if(e.hasOwnProperty(this.cacheKey))return e[this.cacheKey];var o=t.call(this,e);return m(e,this.cacheKey,{value:o},i),o},_.getContext=function(e){switch(typeof e){case"undefined":e=0;case"number":return this.contexts[e];case"string":return this.getContext(function(t){return e in t});case"function":for(var t=0,i=this.contexts.length;i>t;t++){var o=this.contexts[t];if(e.call(this,o))return o}}},_.inContext=function(e,t){this.contexts.unshift(e);var i=t.call(this);return this.contexts.shift(),i},d.prototype={inherit:function(e,t){function i(e,t){var i=r[e];i&&(o||(o=s(r)),t.call(o,i),o[e]=null)}var o,r=this;return i("params",function(t){for(var i=0,o=t.length;o>i;i++)this[t[i]]=e[i]}),i("setParams",function(t){t.apply(this,e)}),i("typeParams",function(e){for(var i=0,o=e.length;o>i;i++){var s=e[i],r=this[s];r&&(this[s]=t(r))}}),i("resolve",function(e){e.call(this,t)}),o||r},createProperty:function(e){return s(this,{binary:e,view:e.view})},toValue:function(e,t){return t!==!1&&"string"==typeof e?this.binary.getContext(e)[e]:r(this,this.binary,e)}},a.Type=d,l.prototype=s(d.prototype,{setParams:function(){this.baseType&&(this.typeParams=["baseType"].concat(this.typeParams||[]))},baseRead:function(){return this.binary.read(this.baseType)},baseWrite:function(e){return this.binary.write(this.baseType,e)}}),o(l.prototype,{read:l.prototype.baseRead,write:l.prototype.baseWrite}),a.Template=l,_.as=function(e,t){var i=t?this:s(this);return e=e||c,i.typeSet=e===c||c.isPrototypeOf(e)?e:s(c,e),i.cacheKey=x,i.cacheKey=i._getCached(e,function(){return x+"."+ ++g},!0),i},_.seek=function(e,t){if(e=this.toValue(e),void 0!==t){var i=this.view.tell();this.view.seek(e);var o=t.call(this);return this.view.seek(i),o}return this.view.seek(e)},_.tell=function(){return this.view.tell()},_.skip=function(e,t){return this.seek(this.tell()+this.toValue(e),t)},_.slice=function(e,t,i){return new a(this.view.slice(e,t,i),this.typeSet)},_._getType=function(e,t){switch(typeof e){case"string":if(!(e in this.typeSet))throw new ReferenceError("Unknown type: "+e);return this._getType(this.typeSet[e],t);case"number":return this._getType(c.bitfield,[e]);case"object":if(i(e,d)){var o=this;return e.inherit(t||[],function(e){return o.getType(e)})}return i(e,Array)?this._getCached(e,function(e){return this.getType(e[0],e.slice(1))},!0):this._getCached(e,function(e){return this.getType(c.object,[e])},!1)}},_.getType=function(e,t){var o=this._getType(e,t);return o&&!i(e,d)&&(o.name="object"==typeof e?i(e,Array)?e[0]+"("+e.slice(1).join(", ")+")":"object":String(e)),o},_._action=function(e,t,i){if(void 0!==e){e=this.getType(e);var o=this._named(function(){return i.call(this,e.createProperty(this),this.contexts[0])},"["+e.name+"]",t);return void 0!==t?this.seek(t,o):o.call(this)}},_.read=function(e,t){return this._action(e,t,function(e,t){return e.read(t)})},_.readAll=function(){return this.read("jBinary.all",0)},_.write=function(e,t,i){return this._action(e,i,function(e,i){var o=this.tell();return e.write(t,i),this.tell()-o})},_.writeAll=function(e){return this.write("jBinary.all",e,0)},function(e,t){for(var i=0,o=t.length;o>i;i++){var r=t[i];c[r.toLowerCase()]=s(e,{dataType:r})}}(d({params:["littleEndian"],read:function(){return this.view["get"+this.dataType](void 0,this.littleEndian)},write:function(e){this.view["write"+this.dataType](e,this.littleEndian)}}),["Uint8","Uint16","Uint32","Uint64","Int8","Int16","Int32","Int64","Float32","Float64","Char"]),o(c,{"byte":c.uint8,"float":c.float32,"double":c.float64}),c.array=l({params:["baseType","length"],read:function(){var e=this.toValue(this.length);if(this.baseType===c.uint8)return this.view.getBytes(e,void 0,!0,!0);var t;if(void 0!==e){t=new Array(e);for(var i=0;e>i;i++)t[i]=this.baseRead()}else{var o=this.view.byteLength;for(t=[];this.binary.tell()<o;)t.push(this.baseRead())}return t},write:function(e){if(this.baseType===c.uint8)return this.view.writeBytes(e);for(var t=0,i=e.length;i>t;t++)this.baseWrite(e[t])}}),c.binary=l({params:["length","typeSet"],read:function(){var e=this.binary.tell(),t=this.binary.skip(this.toValue(this.length)),i=this.view.slice(e,t);return new a(i,this.typeSet)},write:function(e){this.binary.write("blob",e.read("blob",0))}}),c.bitfield=d({params:["bitSize"],read:function(){return this.view.getUnsigned(this.bitSize)},write:function(e){this.view.writeUnsigned(e,this.bitSize)}}),c.blob=d({params:["length"],read:function(){return this.view.getBytes(this.toValue(this.length))},write:function(e){this.view.writeBytes(e,!0)}}),c["const"]=l({params:["baseType","value","strict"],read:function(){var e=this.baseRead();if(this.strict&&e!==this.value){if(i(this.strict,Function))return this.strict(e);throw new TypeError("Unexpected value ("+e+" !== "+this.value+").")}return e},write:function(e){this.baseWrite(this.strict||void 0===e?this.value:e)}}),c["enum"]=l({params:["baseType","matches"],setParams:function(e,t){this.backMatches={};for(var i in t)this.backMatches[t[i]]=i},read:function(){var e=this.baseRead();return e in this.matches?this.matches[e]:e},write:function(e){this.baseWrite(e in this.backMatches?this.backMatches[e]:e)}}),c.extend=d({setParams:function(){this.parts=arguments},resolve:function(e){for(var t=this.parts,i=t.length,o=new Array(i),s=0;i>s;s++)o[s]=e(t[s]);this.parts=o},read:function(){var e=this.parts,t=this.binary.read(e[0]);return this.binary.inContext(t,function(){for(var i=1,s=e.length;s>i;i++)o(t,this.read(e[i]))}),t},write:function(e){var t=this.parts;this.binary.inContext(e,function(){for(var i=0,o=t.length;o>i;i++)this.write(t[i],e)})}}),c["if"]=l({params:["condition","trueType","falseType"],typeParams:["trueType","falseType"],getBaseType:function(){return this.toValue(this.condition)?this.trueType:this.falseType}}),c.if_not=c.ifNot=l({setParams:function(e,t,i){this.baseType=["if",e,i,t]}}),c.lazy=l({marker:"jBinary.Lazy",params:["innerType","length"],getBaseType:function(){return["binary",this.length,this.binary.typeSet]},read:function(){var e=function(t){return 0===arguments.length?"value"in e?e.value:e.value=e.binary.read(e.innerType):o(e,{wasChanged:!0,value:t}).value};return e[this.marker]=!0,o(e,{binary:o(this.baseRead(),{contexts:this.binary.contexts.slice()}),innerType:this.innerType})},write:function(e){e.wasChanged||!e[this.marker]?this.binary.write(this.innerType,e()):this.baseWrite(e.binary)}}),c.object=d({params:["structure","proto"],resolve:function(e){var t={};for(var o in this.structure)t[o]=i(this.structure[o],Function)?this.structure[o]:e(this.structure[o]);this.structure=t},read:function(){var e=this,t=this.structure,o=this.proto?s(this.proto):{};return this.binary.inContext(o,function(){for(var s in t)this._named(function(){var r=i(t[s],Function)?t[s].call(e,o):this.read(t[s]);void 0!==r&&(o[s]=r)},s).call(this)}),o},write:function(e){var t=this,o=this.structure;this.binary.inContext(e,function(){for(var s in o)this._named(function(){i(o[s],Function)?e[s]=o[s].call(t,e):this.write(o[s],e[s])},s).call(this)})}}),c.skip=d({params:["length"],read:function(){this.view.skip(this.toValue(this.length))},write:function(){this.read()}}),c.string=l({params:["length","encoding"],read:function(){return this.view.getString(this.toValue(this.length),void 0,this.encoding)},write:function(e){this.view.writeString(e,this.encoding)}}),c.string0=d({params:["length","encoding"],read:function(){var e=this.view,t=this.length;if(void 0===t){var i,o=e.tell(),s=0;for(t=e.byteLength-o;t>s&&(i=e.getUint8());)s++;var r=e.getString(s,o,this.encoding);return t>s&&e.skip(1),r}return e.getString(t,void 0,this.encoding).replace(/\0.*$/,"")},write:function(e){var t=this.view,i=void 0===this.length?1:this.length-e.length;t.writeString(e,void 0,this.encoding),i>0&&(t.writeUint8(0),t.skip(i-1))}}),a.loadData=n(function(t,o){var s;if(i(t,e.Blob)){var r;if("FileReader"in e)r=new FileReader,r.onload=r.onerror=function(){o(this.error,this.result)},r.readAsArrayBuffer(t);else{r=new FileReaderSync;var n,a;try{a=r.readAsArrayBuffer(t)}catch(d){n=d}finally{o(n,a)}}}else if("string"!=typeof t)o(new TypeError("Unsupported source type."));else if(s=t.match(/^data:(.+?)(;base64)?,(.*)$/))try{var l=s[2],h=s[3];o(null,(l?atob:decodeURIComponent)(h))}catch(d){o(d)}else if("XMLHttpRequest"in e){var u=new XMLHttpRequest;u.open("GET",t,!0),"responseType"in u?u.responseType="arraybuffer":"overrideMimeType"in u?u.overrideMimeType("text/plain; charset=x-user-defined"):u.setRequestHeader("Accept-Charset","x-user-defined"),"onload"in u||(u.onreadystatechange=function(){4===this.readyState&&this.onload()});var f=function(e){o(new Error(e))};u.onload=function(){return 0!==this.status&&200!==this.status?f("HTTP Error #"+this.status+": "+this.statusText):("response"in this||(this.response=new VBArray(this.responseBody).toArray()),void o(null,this.response))},u.onerror=function(){f("Network error.")},u.send(null)}else o(new TypeError("Unsupported source type."))}),a.load=n(function(e,t,i){var o=a.loadData(e);a.load.getTypeSet(e,t,function(e){o.then(function(t){i(null,new a(t,e))},i)})}),a.load.getTypeSet=function(e,t,i){i(t)},_._toURI="URL"in e&&"createObjectURL"in URL?function(e){var t=this.seek(0,function(){return this.view.getBytes()});return URL.createObjectURL(new Blob([t],{type:e}))}:function(e){var t=this.seek(0,function(){return this.view.getString(void 0,void 0,"binary")});return"data:"+e+";base64,"+btoa(t)},_._mimeType=function(e){return e||this.typeSet["jBinary.mimeType"]||"application/octet-stream"},_.toURI=function(e){return this._toURI(this._mimeType(e))},h){var v=a.downloader=h.createElement("a");v.style.display="none"}return _.saveAs=n(function(e,t,i){"string"==typeof e?("msSaveBlob"in navigator?navigator.msSaveBlob(new Blob([this.read("blob",0)],{type:this._mimeType(t)}),e):h?(v.parentNode||h.body.appendChild(v),v.href=this.toURI(t),v.download=e,v.click(),v.href=v.download=""):i(new TypeError("Saving from Web Worker is not supported.")),i()):i(new TypeError("Unsupported storage type."))}),a})},{jdataview:10}],10:[function(e,t){(function(e){!function(e){var i=this;t.exports=e(i)}(function(t){"use strict";function i(e,t){return"object"!=typeof e||null===e?!1:e.constructor===t||Object.prototype.toString.call(e)==="[object "+t.name+"]"}function o(e,t){return!t&&i(e,Array)?e:Array.prototype.slice.call(e)}function s(e,t){return void 0!==e?e:t}function r(t,o,n,a){if(r.is(t)){var d=t.slice(o,o+n);return d._littleEndian=s(a,d._littleEndian),d}if(!r.is(this))return new r(t,o,n,a);if(this.buffer=t=r.wrapBuffer(t),this._isArrayBuffer=h.ArrayBuffer&&i(t,ArrayBuffer),this._isPixelData=!1,this._isDataView=h.DataView&&this._isArrayBuffer,this._isNodeBuffer=!0&&h.NodeBuffer&&i(t,e),!this._isNodeBuffer&&!this._isArrayBuffer&&!i(t,Array))throw new TypeError("jDataView buffer has an incompatible type");this._littleEndian=!!a;var l="byteLength"in t?t.byteLength:t.length;this.byteOffset=o=s(o,0),this.byteLength=n=s(n,l-o),this._offset=this._bitOffset=0,this._isDataView?this._view=new DataView(t,o,n):this._checkBounds(o,n,l),this._engineAction=this._isDataView?this._dataViewAction:this._isNodeBuffer?this._nodeBufferAction:this._isArrayBuffer?this._arrayBufferAction:this._arrayAction}function n(t){if(h.NodeBuffer)return new e(t,"binary");for(var i=h.ArrayBuffer?Uint8Array:Array,o=new i(t.length),s=0,r=t.length;r>s;s++)o[s]=255&t.charCodeAt(s);return o}function a(e){return e>=0&&31>e?1<<e:a[e]||(a[e]=Math.pow(2,e))}function d(e,t){this.lo=e,this.hi=t}function l(){d.apply(this,arguments)}var h={NodeBuffer:!0&&"Buffer"in t,DataView:"DataView"in t,ArrayBuffer:"ArrayBuffer"in t,PixelData:!1},u=t.TextEncoder,f=t.TextDecoder;h.NodeBuffer&&!function(e){try{e.writeFloatLE(1/0,0)}catch(t){h.NodeBuffer=!1}}(new e(4));var _={Int8:1,Int16:2,Int32:4,Uint8:1,Uint16:2,Uint32:4,Float32:4,Float64:8};r.wrapBuffer=function(t){switch(typeof t){case"number":if(h.NodeBuffer)t=new e(t),t.fill(0);else if(h.ArrayBuffer)t=new Uint8Array(t).buffer;else{t=new Array(t);for(var s=0;s<t.length;s++)t[s]=0}return t;case"string":t=n(t);default:return"length"in t&&!(h.NodeBuffer&&i(t,e)||h.ArrayBuffer&&i(t,ArrayBuffer))&&(h.NodeBuffer?t=new e(t):h.ArrayBuffer?i(t,ArrayBuffer)||(t=new Uint8Array(t).buffer,i(t,ArrayBuffer)||(t=new Uint8Array(o(t,!0)).buffer)):t=o(t)),t}},r.is=function(e){return e&&e.jDataView},r.from=function(){return new r(arguments)},r.Uint64=d,d.prototype={valueOf:function(){return this.lo+a(32)*this.hi},toString:function(){return Number.prototype.toString.apply(this.valueOf(),arguments)}},d.fromNumber=function(e){var t=Math.floor(e/a(32)),i=e-t*a(32);return new d(i,t)},r.Int64=l,l.prototype="create"in Object?Object.create(d.prototype):new d,l.prototype.valueOf=function(){return this.hi<a(31)?d.prototype.valueOf.apply(this,arguments):-(a(32)-this.lo+a(32)*(a(32)-1-this.hi))},l.fromNumber=function(e){var t,i;if(e>=0){var o=d.fromNumber(e);t=o.lo,i=o.hi}else i=Math.floor(e/a(32)),t=e-i*a(32),i+=a(32);return new l(t,i)};var c=r.prototype={compatibility:h,jDataView:!0,_checkBounds:function(e,t,i){if("number"!=typeof e)throw new TypeError("Offset is not a number.");if("number"!=typeof t)throw new TypeError("Size is not a number.");if(0>t)throw new RangeError("Length is negative.");if(0>e||e+t>s(i,this.byteLength))throw new RangeError("Offsets are out of bounds.")},_action:function(e,t,i,o,r){return this._engineAction(e,t,s(i,this._offset),s(o,this._littleEndian),r)},_dataViewAction:function(e,t,i,o,s){return this._offset=i+_[e],t?this._view["get"+e](i,o):this._view["set"+e](i,s,o)},_arrayBufferAction:function(e,i,o,r,n){var a,d=_[e],l=t[e+"Array"];if(r=s(r,this._littleEndian),1===d||(this.byteOffset+o)%d===0&&r)return a=new l(this.buffer,this.byteOffset+o,1),this._offset=o+d,i?a[0]:a[0]=n;var h=new Uint8Array(i?this.getBytes(d,o,r,!0):d);return a=new l(h.buffer,0,1),i?a[0]:(a[0]=n,void this._setBytes(o,h,r))},_arrayAction:function(e,t,i,o,s){return t?this["_get"+e](i,o):this["_set"+e](i,s,o)},_getBytes:function(e,t,i){i=s(i,this._littleEndian),t=s(t,this._offset),e=s(e,this.byteLength-t),this._checkBounds(t,e),t+=this.byteOffset,this._offset=t-this.byteOffset+e;var r=this._isArrayBuffer?new Uint8Array(this.buffer,t,e):(this.buffer.slice||Array.prototype.slice).call(this.buffer,t,t+e);return i||1>=e?r:o(r).reverse()},getBytes:function(e,t,i,r){var n=this._getBytes(e,t,s(i,!0));return r?o(n):n},_setBytes:function(t,i,r){var n=i.length;if(0!==n){if(r=s(r,this._littleEndian),t=s(t,this._offset),this._checkBounds(t,n),!r&&n>1&&(i=o(i,!0).reverse()),t+=this.byteOffset,this._isArrayBuffer)new Uint8Array(this.buffer,t,n).set(i);else if(this._isNodeBuffer)new e(i).copy(this.buffer,t);else for(var a=0;n>a;a++)this.buffer[t+a]=i[a];this._offset=t-this.byteOffset+n}},setBytes:function(e,t,i){this._setBytes(e,t,s(i,!0))},getString:function(e,t,i){if(this._isNodeBuffer)return t=s(t,this._offset),e=s(e,this.byteLength-t),this._checkBounds(t,e),this._offset=t+e,this.buffer.toString(i||"binary",this.byteOffset+t,this.byteOffset+this._offset);var o=this._getBytes(e,t,!0);if(i="utf8"===i?"utf-8":i||"binary",f&&"binary"!==i)return new f(i).decode(this._isArrayBuffer?o:new Uint8Array(o));var r="";e=o.length;for(var n=0;e>n;n++)r+=String.fromCharCode(o[n]);return"utf-8"===i&&(r=decodeURIComponent(escape(r))),r},setString:function(e,t,i){if(this._isNodeBuffer)return e=s(e,this._offset),this._checkBounds(e,t.length),void(this._offset=e+this.buffer.write(t,this.byteOffset+e,i||"binary"));i="utf8"===i?"utf-8":i||"binary";var o;u&&"binary"!==i?o=new u(i).encode(t):("utf-8"===i&&(t=unescape(encodeURIComponent(t))),o=n(t)),this._setBytes(e,o,!0)},getChar:function(e){return this.getString(1,e)},setChar:function(e,t){this.setString(e,t)},tell:function(){return this._offset},seek:function(e){return this._checkBounds(e,0),this._offset=e},skip:function(e){return this.seek(this._offset+e)},slice:function(e,t,i){function o(e,t){return 0>e?e+t:e}return e=o(e,this.byteLength),t=o(s(t,this.byteLength),this.byteLength),i?new r(this.getBytes(t-e,e,!0,!0),void 0,void 0,this._littleEndian):new r(this.buffer,this.byteOffset+e,t-e,this._littleEndian)},alignBy:function(e){return this._bitOffset=0,1!==s(e,1)?this.skip(e-(this._offset%e||e)):this._offset},_getFloat64:function(e,t){var i=this._getBytes(8,e,t),o=1-2*(i[7]>>7),s=((i[7]<<1&255)<<3|i[6]>>4)-1023,r=(15&i[6])*a(48)+i[5]*a(40)+i[4]*a(32)+i[3]*a(24)+i[2]*a(16)+i[1]*a(8)+i[0];return 1024===s?0!==r?0/0:1/0*o:-1023===s?o*r*a(-1074):o*(1+r*a(-52))*a(s)},_getFloat32:function(e,t){var i=this._getBytes(4,e,t),o=1-2*(i[3]>>7),s=(i[3]<<1&255|i[2]>>7)-127,r=(127&i[2])<<16|i[1]<<8|i[0];return 128===s?0!==r?0/0:1/0*o:-127===s?o*r*a(-149):o*(1+r*a(-23))*a(s)},_get64:function(e,t,i){i=s(i,this._littleEndian),t=s(t,this._offset);for(var o=i?[0,4]:[4,0],r=0;2>r;r++)o[r]=this.getUint32(t+o[r],i);return this._offset=t+8,new e(o[0],o[1])},getInt64:function(e,t){return this._get64(l,e,t)},getUint64:function(e,t){return this._get64(d,e,t)},_getInt32:function(e,t){var i=this._getBytes(4,e,t);return i[3]<<24|i[2]<<16|i[1]<<8|i[0]},_getUint32:function(e,t){return this._getInt32(e,t)>>>0},_getInt16:function(e,t){return this._getUint16(e,t)<<16>>16},_getUint16:function(e,t){var i=this._getBytes(2,e,t);return i[1]<<8|i[0]},_getInt8:function(e){return this._getUint8(e)<<24>>24},_getUint8:function(e){return this._getBytes(1,e)[0]},_getBitRangeData:function(e,t){var i=(s(t,this._offset)<<3)+this._bitOffset,o=i+e,r=i>>>3,n=o+7>>>3,a=this._getBytes(n-r,r,!0),d=0;(this._bitOffset=7&o)&&(this._bitOffset-=8);for(var l=0,h=a.length;h>l;l++)d=d<<8|a[l];return{start:r,bytes:a,wideValue:d}},getSigned:function(e,t){var i=32-e;return this.getUnsigned(e,t)<<i>>i},getUnsigned:function(e,t){var i=this._getBitRangeData(e,t).wideValue>>>-this._bitOffset;return 32>e?i&~(-1<<e):i},_setBinaryFloat:function(e,t,i,o,s){var r,n,d=0>t?1:0,l=~(-1<<o-1),h=1-l;0>t&&(t=-t),0===t?(r=0,n=0):isNaN(t)?(r=2*l+1,n=1):1/0===t?(r=2*l+1,n=0):(r=Math.floor(Math.log(t)/Math.LN2),r>=h&&l>=r?(n=Math.floor((t*a(-r)-1)*a(i)),r+=l):(n=Math.floor(t/a(h-i)),r=0));for(var u=[];i>=8;)u.push(n%256),n=Math.floor(n/256),i-=8;for(r=r<<i|n,o+=i;o>=8;)u.push(255&r),r>>>=8,o-=8;u.push(d<<o|r),this._setBytes(e,u,s)},_setFloat32:function(e,t,i){this._setBinaryFloat(e,t,23,8,i)},_setFloat64:function(e,t,i){this._setBinaryFloat(e,t,52,11,i)},_set64:function(e,t,i,o){"object"!=typeof i&&(i=e.fromNumber(i)),o=s(o,this._littleEndian),t=s(t,this._offset);var r=o?{lo:0,hi:4}:{lo:4,hi:0};for(var n in r)this.setUint32(t+r[n],i[n],o);this._offset=t+8},setInt64:function(e,t,i){this._set64(l,e,t,i)},setUint64:function(e,t,i){this._set64(d,e,t,i)},_setUint32:function(e,t,i){this._setBytes(e,[255&t,t>>>8&255,t>>>16&255,t>>>24],i)},_setUint16:function(e,t,i){this._setBytes(e,[255&t,t>>>8&255],i)},_setUint8:function(e,t){this._setBytes(e,[255&t])},setUnsigned:function(e,t,i){var o=this._getBitRangeData(i,e),s=o.wideValue,r=o.bytes;s&=~(~(-1<<i)<<-this._bitOffset),s|=(32>i?t&~(-1<<i):t)<<-this._bitOffset;for(var n=r.length-1;n>=0;n--)r[n]=255&s,s>>>=8;this._setBytes(o.start,r,!0)}},m={Int8:"Int8",Int16:"Int16",Int32:"Int32",Uint8:"UInt8",Uint16:"UInt16",Uint32:"UInt32",Float32:"Float",Float64:"Double"};c._nodeBufferAction=function(e,t,i,o,s){this._offset=i+_[e];var r=m[e]+("Int8"===e||"Uint8"===e?"":o?"LE":"BE");return i+=this.byteOffset,t?this.buffer["read"+r](i):this.buffer["write"+r](s,i)};for(var p in _)!function(e){c["get"+e]=function(t,i){return this._action(e,!0,t,i)},c["set"+e]=function(t,i,o){this._action(e,!1,t,o,i)}}(p);c._setInt32=c._setUint32,c._setInt16=c._setUint16,c._setInt8=c._setUint8,c.setSigned=c.setUnsigned;for(var x in c)"set"===x.slice(0,3)&&!function(e){c["write"+e]=function(){Array.prototype.unshift.call(arguments,void 0),this["set"+e].apply(this,arguments)}}(x.slice(3));return r})}).call(this,e("buffer").Buffer)},{buffer:2}],11:[function(e,t){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}(),s=e("gl-matrix-vec3"),r=function(){function e(){i(this,e),this.min_=[0,0,0],this.max_=[0,0,0]}return o(e,[{key:"clone",value:function(){var t=new e;return t.min_=this.min_.slice(),t.max_=this.max_.slice(),t}},{key:"copy",value:function(e){return s.copy(this.min_,e.min_),s.copy(this.max_,e.max_),this}},{key:"setCopy",value:function(e,t){return s.copy(this.min_,e),s.copy(this.max_,t),this}},{key:"set",value:function(e,t,i,o,s,r){var n=this.min_,a=this.max_;return n[0]=e,n[1]=t,n[2]=i,a[0]=o,a[1]=s,a[2]=r,this}},{key:"computeCenter",value:function(){var e=this.min_,t=this.max_;return[.5*(e[0]+t[0]),.5*(e[1]+t[1]),.5*(e[2]+t[2])]}},{key:"isOutside",value:function(e){var t=this.min_,i=this.max_,o=e.min_,s=e.max_;return o[0]>i[0]||s[0]<t[0]?!0:o[1]>i[1]||s[1]<t[1]?!0:o[2]>i[2]||s[2]<t[2]?!0:!1}},{key:"isInside",value:function(e){var t=this.min_,i=this.max_,o=e.min_,s=e.max_;return t[0]>=o[0]&&i[0]<=s[0]&&t[1]>=o[1]&&i[1]<=s[1]&&t[2]>=o[2]&&i[2]<=s[2]?!0:!1}},{key:"pointInside",value:function(e){var t=this.min_,i=this.max_,o=e[0],s=e[1],r=e[2];return o<=t[0]?!1:o>i[0]?!1:s<=t[1]?!1:s>i[1]?!1:r<=t[2]?!1:r>i[2]?!1:!0}},{key:"expandsWithPoint",value:function(e,t,i){var o=this.min_,s=this.max_;e>s[0]&&(s[0]=e),e<o[0]&&(o[0]=e),t>s[1]&&(s[1]=t),t<o[1]&&(o[1]=t),i>s[2]&&(s[2]=i),i<o[2]&&(o[2]=i)}},{key:"expandsWithAabb",value:function(e){var t=this.min_,i=this.max_,o=e.min_,s=e.max_,r=o[0],n=o[1],a=o[2],d=s[0],l=s[1],h=s[2];d>i[0]&&(i[0]=d),r<t[0]&&(t[0]=r),l>i[1]&&(i[1]=l),n<t[1]&&(t[1]=n),h>i[2]&&(i[2]=h),a<t[2]&&(t[2]=a)}},{key:"intersectRay",value:function(e,t){var i=this.min_,o=this.max_,s=t[0],r=t[1],n=t[2],a=e[0],d=e[1],l=e[2],h=(i[0]-a)*s,u=(o[0]-a)*s,f=(i[1]-d)*r,_=(o[1]-d)*r,c=(i[2]-l)*n,m=(o[2]-l)*n,p=Math.max(Math.max(Math.min(h,u),Math.min(f,_)),Math.min(c,m)),x=Math.min(Math.min(Math.max(h,u),Math.max(f,_)),Math.max(c,m));return x>=0&&x>p}},{key:"intersectSphere",value:function(e,t){var i=this.min_,o=this.max_,r=e[0],n=e[1],a=e[2],d=[0,0,0];return d[0]=i[0]>r?i[0]:o[0]<r?o[0]:r,d[1]=i[1]>n?i[1]:o[1]<n?o[1]:n,d[2]=i[2]>a?i[2]:o[2]<a?o[2]:a,s.sqrDist(e,d)<t}},{key:"intersectPlane",value:function(e,t){var i=this.computeCenter(),o=.25*s.sqrDist(this.min_,this.max_),r=s.dot(s.sub(i,i,e),t);return o>r*r}}]),e}();t.exports=r},{"gl-matrix-vec3":6}],12:[function(e,t){"use strict";var i=e("gl-matrix-vec3"),o={};o.normalizedMouse=function(e,t,i,o){return[2*e/i-1,1-2*t/o]},o.mouseOnUnitSphere=function(e){var t=e[0],o=e[1],s=1-t*t-o*o,r=s>0?Math.sqrt(s):0,n=[t,o,r];return i.normalize(n,n)},o.intersectionRayTriangle=function(e,t,o,s,r,n,a){var d=[0,0,0];i.sub(d,e,o);var l=i.dot(d,n),h=i.dot(i.sub(d,t,o),n);if(l*h>=0)return!1;var u=-l/(h-l);i.scaleAndAdd(a,e,i.sub(d,t,e),u);var f=[0,0,0];return i.cross(f,n,i.sub(d,s,o)),i.dot(f,i.sub(d,a,o))<0?!1:(i.cross(f,n,i.sub(d,r,s)),i.dot(f,i.sub(d,a,s))<0?!1:(i.cross(f,n,i.sub(d,o,r)),i.dot(f,i.sub(d,a,o))<0?!1:!0))},o.computeTriangleAabb=function(e,t,i,o,s,r,n,a,d,l){var h=e.min_,u=e.max_;

h[0]=Math.min(t,s,a),h[1]=Math.min(i,r,d),h[2]=Math.min(o,n,l),u[0]=Math.max(t,s,a),u[1]=Math.max(i,r,d),u[2]=Math.max(o,n,l)},o.computeTetraAabb=function(e,t,i,o,s,r,n,a,d,l,h,u,f){var _=e.min_,c=e.max_;_[0]=Math.min(t,s,a,h),_[1]=Math.min(i,r,d,u),_[2]=Math.min(o,n,l,f),c[0]=Math.max(t,s,a,h),c[1]=Math.max(i,r,d,u),c[2]=Math.max(o,n,l,f)},o.computeGeometryAabb=function(e,t){var i=e.min_,o=e.max_;i=1/0,o=-(1/0);for(var s,r=0,n=t.length;n>s;s++)i[r]=Math.min(i[r],t[s]),o[r]=Math.max(o[r],t[s]),r=(r+1)%3},o.normal=function(e,t,i,o,s,r,n,a,d,l){var h=s-t,u=r-i,f=n-o,_=a-t,c=d-i,m=l-o,p=0,x=0,g=0;p=u*m-f*c,x=f*_-h*m,g=h*c-u*_;var v=p*p+x*x+g*g;return 0!==v&&(v=1/Math.sqrt(v),e[0]=p*v,e[1]=x*v,e[2]=g*v),e},o.normalNonUnit=function(e,t,i,o,s,r,n,a,d,l){var h=s-t,u=r-i,f=n-o,_=a-t,c=d-i,m=l-o;return e[0]=u*m-f*c,e[1]=f*_-h*m,e[2]=h*c-u*_,e},o.normalNonUnitV=function(e,t,i,s){return o.normalNonUnit(e,t[0],t[1],t[2],i[0],i[1],i[2],s[0],s[1],s[2])},o.pointInsideTriangle=function(e,t,o,s){var r=[0,0,0];i.sub(r,t,o);var n=[0,0,0];i.sub(n,t,s);var a=[0,0,0];i.sub(a,e,o);var d=[0,0,0];i.sub(d,e,s);var l=[0,0,0],h=i.len(i.cross(l,r,n)),u=i.len(i.cross(l,r,a)),f=i.len(i.cross(l,n,d)),_=i.len(i.cross(l,a,d));return Math.abs(h-(u+f+_))<1e-9?!0:!1},o.sphereIntersectTriangle=function(e,t,i,s,r){return o.distanceToSegment(e,i,s)<t?!0:o.distanceToSegment(e,s,r)<t?!0:o.distanceToSegment(e,i,r)<t?!0:!1},o.distanceToSegment=function(e,t,o){var s=[0,0,0];i.sub(s,e,t);var r=[0,0,0];i.sub(r,o,t);var n=i.sqrLen(r),a=i.dot(s,r)/n;return 0>a?i.sqrLen(s):a>1?i.sqrLen(i.sub(s,e,o)):(s[0]=e[0]-t[0]+a*r[0],s[1]=e[1]-t[1]+a*r[1],s[2]=e[2]-t[2]+a*r[2],i.sqrLen(s))},o.signedAngle2d=function(e,t){var i=e[0],o=e[1],s=t[0],r=t[1];return Math.atan2(i*r-o*s,i*s+o*r)},o.pointPlaneDistance=function(e,t,o){return i.dot(i.sub([0,0,0],e,t),o)},o.mirrorPoint=function(e,t,s){return i.sub(e,e,i.scale([0,0,0],s,2*o.pointPlaneDistance(e,t,s)))},o.pointOnLine=function(e,t,o){var s=[0,0,0];i.sub(s,o,t);var r=[0,0,0],n=i.dot(s,i.sub(r,e,t));return i.scaleAndAdd(r,t,s,n/i.sqrLen(s))},o.intersectionSegmentPlane=function(e,t,o,s){var r=[0,0,0],n=i.dot(i.sub(r,e,o),s),a=i.dot(s,i.normalize(r,i.sub(r,t,e))),d=-n/a;return[i.scaleAndAdd(r,e,r,d),d]},t.exports=o},{"gl-matrix-vec3":6}],13:[function(e,t){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}(),s=e("./octree"),r=e("./plane"),n=e("./aabb"),a=e("gl-matrix-mat4"),d=e("gl-matrix-vec3"),l=e("gl-matrix-mat3"),h=e("./geometry"),u=function(){function e(){i(this,e),this.nodeArray_=null,this.tetraArray_=null,this.dataArray_=null,this.center_=[0,0,0],this.octree_=new s,this.matTransform_=a.create(),this.scale_=1,this.countVertices_=0}return o(e,[{key:"initTetraMesh",value:function(e,t,i){this.nodeArray_=e,this.tetraArray_=t,this.dataArray_=i,this.computeAabbAndCenter(),this.computeOctree()}},{key:"computeAabbAndCenter",value:function(){var e=this.nodeArray_,t=this.octree_.aabbLoose_;t.min_=[e[0],e[1],e[2]],t.max_=[e[0],e[1],e[2]];for(var i=e.length/3,o=0;i>o;++o){var s=3*o;t.expandsWithPoint(e[s],e[s+1],e[s+2])}this.center_=t.computeCenter()}},{key:"scale",value:function t(e){for(var i=this.octree_.aabbLoose_,t=this.scale_=e?e:TriMesh.globalScale_/d.dist(i.min_,i.max_),o=this.nodeArray_,s=o.length,r=0;s>r;++r)o[r]*=t;d.scale(i.min_,i.min_,t),d.scale(i.max_,i.max_,t),d.scale(this.center_,this.center_,t)}},{key:"computeOctree",value:function(){for(var e=this.nodeArray_,t=this.tetraArray_,i=t.length/4,o=new Array(i),s=new Array(i),r=0;i>r;++r){o[r]=r,s[r]=new n;var a=4*r,d=3*t[a],l=3*t[a+1],u=3*t[a+2],f=3*t[a+3],_=e[d],c=e[d+1],m=e[d+2],p=e[l],x=e[l+1],g=e[l+2],v=e[u],y=e[u+1],b=e[u+2],T=e[f],S=e[f+1],M=e[f+2];h.computeTetraAabb(s[r],_,c,m,p,x,g,v,y,b,T,S,M)}this.octree_.build(o,s,this.octree_.aabbLoose_)}},{key:"moveTo",value:function(e){a.translate(this.matTransform_,a.create(),d.sub(e,e,this.center_))}},{key:"makeSlice",value:function(e,t,i,o){var s=new r;s.updateFromEquation(e,t,i,o);var n=[s.originX_,s.originY_,s.originZ_],u=[s.normalX_,s.normalY_,s.normalZ_];d.normalize(u,u);var f=a.create();a.invert(f,this.matTransform_),d.transformMat4(n,n,f),d.transformMat3(u,u,l.normalFromMat4(l.create(),f));for(var _=this.octree_.intersectPlane(n,u),c=_.length,m=[],p=[],x=this.nodeArray_,g=this.tetraArray_,v=this.dataArray_,y=[0,0,0],b=0;c>b;++b){for(var T=4*_[b],S=g.slice(T,T+4),M=x.slice(3*S[0],3*S[0]+3),C=x.slice(3*S[1],3*S[1]+3),F=x.slice(3*S[2],3*S[2]+3),E=x.slice(3*S[3],3*S[3]+3),w=d.dot(u,d.sub(y,n,M))>0?-1:1,A=d.dot(u,d.sub(y,n,C))>0?-1:1,R=d.dot(u,d.sub(y,n,F))>0?-1:1,N=d.dot(u,d.sub(y,n,E))>0?-1:1,I=[w,A,R,N],P=[M,C,F,E],D=[],V=[],L=[],B=0,O=0;3>O;O++)for(var k=O+1;4>k;k++)if(!(I[O]*I[k]>0)){L=h.intersectionSegmentPlane(P[O],P[k],n,u),B=L[1]/d.dist(P[O],P[k]),isNaN(L[0][0])&&isNaN(L[0][1])&&isNaN(L[0][2])&&console.log("intersection is nan"),isNaN(B)&&console.log("coeff is Nan"),D.push(L[0]);var U=v[S[O]]+L[1]/d.dist(P[O],P[k])*(v[S[k]]-v[S[O]]);isNaN(U)&&console.log("new data is nan"),V.push(U)}if(4!=Math.abs(w+A+R+N)){M=D[0],C=D[1],F=D[2];var G=V[0],X=V[1],z=V[2];d.dot(h.normalNonUnitV(y,M,C,F),u)<0?(m.push(M,C,F),p.push(G,X,z),4===D.length&&(m.push(C,D[3],F),p.push(X,V[3],z))):(m.push(M,F,C),p.push(G,z,X),4===D.length&&(m.push(C,F,D[3]),p.push(X,z,V[3])))}}for(var j=m.length,H=new Float32Array(3*j),W=0;j>W;++W)H[3*W]=m[W][0],H[3*W+1]=m[W][1],H[3*W+2]=m[W][2];for(var Y=new Float32Array(H.length),q=u[0],Q=u[1],K=u[2],Z=0;j>Z;++Z){var $=3*Z;Y[$]=-q,Y[$+1]=-Q,Y[$+2]=-K}return this.countVertices_=j,{vertex:H,data:p}}}]),e}();t.exports=u},{"./aabb":11,"./geometry":12,"./octree":14,"./plane":15,"gl-matrix-mat3":4,"gl-matrix-mat4":5,"gl-matrix-vec3":6}],14:[function(e,t){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}(),s=e("./aabb"),r=function(){function e(t,o){i(this,e),this.parent_="undefined"!=typeof t?t:null,this.child_=[],this.depth_="undefined"!=typeof o?o:0,this.aabbLoose_=new s,this.aabbSplit_=new s,this.indices_=[],this.maxDepth_=8,this.maxIndices_=100}return o(e,[{key:"build",value:function(t,i,o){var s=this.aabbSplit_,r=this.aabbLoose_;s.copy(o),r.copy(o),this.indices_.length=0;var n=this.indices_,a=!0,d=!1,l=void 0;try{for(var h,u=t[Symbol.iterator]();!(a=(h=u.next()).done);a=!0){var f=h.value,_=i[f];s.pointInside(_.computeCenter())&&(r.expandsWithAabb(_),n.push(f))}}catch(c){d=!0,l=c}finally{try{!a&&u["return"]&&u["return"]()}finally{if(d)throw l}}var m=n.length;m>e.maxIndices_&&this.depth_<e.maxDepth_&&this.constructCells(i)}},{key:"constructCells",value:function(t){var i=this.child_,o=this.indices_,r=this.aabbSplit_.min_,n=this.aabbSplit_.max_,a=r[0],d=r[1],l=r[2],h=n[0],u=n[1],f=n[2],_=this.aabbSplit_.computeCenter(),c=_[0],m=_[1],p=_[2],x=.5*(h-a),g=.5*(u-d),v=.5*(f-l),y=this.depth_+1,b=new s;i[0]=new e(this,y),i[0].build(o,t,b.set(r[0],r[1],r[2],_[0],_[1],_[2])),i[1]=new e(this,y),i[1].build(o,t,b.set(a+x,d,l,c+x,m,p)),i[2]=new e(this,y),i[2].build(o,t,b.set(c,m-g,p,h,u-g,f)),i[3]=new e(this,y),i[3].build(o,t,b.set(a,d,l+v,c,m,p+v)),i[4]=new e(this,y),i[4].build(o,t,b.set(a,d+g,l,c,m+g,p)),i[5]=new e(this,y),i[5].build(o,t,b.set(c,m,p-v,h,u,f-v)),i[6]=new e(this,y),i[6].build(o,t,b.setCopy(_,n)),i[7]=new e(this,y),i[7].build(o,t,b.set(c-x,m,p,h-x,u,f)),this.indices_.length=0}},{key:"intersectRay",value:function(e,t){if(this.aabbLoose_.intersectRay(e,t)){if(this.child_[0]){for(var i=[],o=this.child_,s=0;8>s;++s){var r=o[s].intersectRay(e,t);i.push.apply(i,r)}return i}return this.indices_}return[]}},{key:"intersectPlane",value:function(e,t){if(this.aabbLoose_.intersectPlane(e,t)){if(this.child_[0]){for(var i=[],o=this.child_,s=0;8>s;++s){var r=o[s].intersectPlane(e,t);i=i.concat(r)}return i}return this.indices_}return[]}}]),e}();t.exports=r},{"./aabb":11}],15:[function(e,t){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}(),s=function(){function e(){i(this,e),this.originX_=0,this.originY_=0,this.originZ_=0,this.normalX_=1,this.normalY_=0,this.normalZ_=0}return o(e,[{key:"setValues",value:function(e,t,i,o,s,r){this.originX_=e,this.originY_=t,this.originZ_=i,this.normalX_=o,this.normalY_=s,this.normalZ_=r}},{key:"updateFromEquation",value:function(e,t,i,o){0!==e?(this.originX_=-o/e,this.originY_=0,this.originZ_=0):0!==t?(this.originX_=0,this.originY_=-o/t,this.originZ_=0):0!==i?(this.originX_=0,this.originY_=0,this.originZ_=-o/i):(this.originX_=0,this.originY_=0,this.originZ_=0),this.normalX_=e,this.normalY_=t,this.normalZ_=i}}]),e}();t.exports=s},{}],16:[function(e){"use strict";function t(){h("resetButton").addEventListener("click",function(){h("transx").value=0,h("transy").value=0,h("transz").value=0,h("translation").setAttribute("translation","0 0 0")},!1),h("cboxUncolored").addEventListener("click",function(){var e=h("faceSetShape2").getAttribute("render");"true"==e?(h("faceSetShape2").setAttribute("render","false"),h("transx").disabled=!0,h("transy").disabled=!0,h("transz").disabled=!0,h("cboxUncolored").checked=!1):(h("faceSetShape2").setAttribute("render","true"),h("transx").disabled=!1,h("transy").disabled=!1,h("transz").disabled=!1,h("cboxUncolored").checked=!0)},!1),h("cboxClipPlane").addEventListener("click",function(){var e=h("triSetShape").getAttribute("render");"true"==e?(h("triSetShape").setAttribute("render","false"),h("cboxClipPlane").checked=!1):(h("triSetShape").setAttribute("render","true"),h("cboxClipPlane").checked=!0)},!1),h("clipSlider").addEventListener("input",function(){var e=-1*(S+this.value*(M-S)),t=h("clipPlane");if(0==this.value)t.setAttribute("on","false"),h("clipPlane2").setAttribute("plane","0, -1, 0, "+-1*e);else if(y){var i="0, 1, 0, "+e;t.setAttribute("on","true"),t.setAttribute("value",i),t.setAttribute("plane",i),h("clipPlane2").setAttribute("plane","0, -1, 0, "+-1*e),r(e)}},!1),h("isoColor1").addEventListener("input",i),h("isoColor2").addEventListener("input",i),h("threshold1").addEventListener("input",s),h("threshold2").addEventListener("input",s),h("transx").addEventListener("input",o),h("transy").addEventListener("input",o),h("transz").addEventListener("input",o)}function i(){var e=l.getSliderMinMax("isoColor",b,T);h("faceSetIsoColor").setAttribute("min",e.min),h("faceSetIsoColor").setAttribute("max",e.max),h("triSetIsoColor").setAttribute("min",e.min),h("triSetIsoColor").setAttribute("max",e.max)}function o(){var e=h("transx").value+" "+h("transy").value+" "+h("transz").value;h("translation").setAttribute("translation",e)}function s(){var e=l.getSliderMinMax("threshold",b,T);h("cboxthreshold").checked&&(h("faceSetThreshold").setAttribute("lowerbound",e.min),h("faceSetThreshold").setAttribute("upperbound",e.max),h("triSetThreshold").setAttribute("lowerbound",e.min),h("triSetThreshold").setAttribute("upperbound",e.max)),h("faceSetThreshold2").setAttribute("lowerbound",e.min),h("faceSetThreshold2").setAttribute("upperbound",e.max)}function r(e){var t=v.makeSlice(0,1,0,Number(e)),i=t.vertex,o=t.data,s=void 0;0!==i.length&&(d.updateCoordPoint(h("triSetCoordinate"),i),d.updateDataValue(h("triSetAttr"),o),s=l.getSliderMinMax("isoColor",b,T),h("triSetIsoColor").setAttribute("min",s.min),h("triSetIsoColor").setAttribute("max",s.max))}var n=e("jbinary"),a=e("./clipUtils/mytetraMesh"),d=e("./x3dom/myx3domutils"),l=e("./utils"),h=l.get,u=e("./x3dom/x3dom.debug.js");e("./x3dom/plugins/threshold.js")(u),e("./x3dom/plugins/isoColor.js")(u);var f="./binGeo/piston/",_=n.loadData(f+"coord.bin"),c=n.loadData(f+"tetras.bin"),m=n.loadData(f+"faces.bin"),p=n.loadData(f+"data.bin"),x=n.loadData(f+"normals.bin"),g=new Promise(function(e){document.addEventListener("load",e)}),v=new a,y=!1,b=0,T=0,S=0,M=0;Promise.all([_,c,m,p,x,g]).then(function(e){var i=new Float32Array(e[0]),o=new Uint32Array(e[1]),s=new Int32Array(e[2]),n=new Float32Array(e[3]),a=new Float32Array(e[4]),u=l.scale_center(i),f=n;b=Math.min.apply(null,f),T=Math.max.apply(null,f),h("faceSetIsoColor").setAttribute("min",b),h("faceSetIsoColor").setAttribute("max",T),h("faceSetIsoColor2").setAttribute("min",b),h("faceSetIsoColor2").setAttribute("max",T),h("triSetThreshold").setAttribute("upperBound",T),h("triSetThreshold").setAttribute("lowerBound",b),h("faceSetThreshold").setAttribute("lowerBound",b),h("faceSetThreshold").setAttribute("upperBound",T),h("faceSetThreshold2").setAttribute("lowerBound",b),h("faceSetThreshold2").setAttribute("upperBound",T),v.initTetraMesh(u,o,f),S=v.octree_.aabbLoose_.min_[1],M=v.octree_.aabbLoose_.max_[1],y=!0,d.setIndexFaceSet({coord:u,coordIndex:s,normal:a,data:f}),t(),r(0)})},{"./clipUtils/mytetraMesh":13,"./utils":17,"./x3dom/myx3domutils":18,"./x3dom/plugins/isoColor.js":19,"./x3dom/plugins/threshold.js":20,"./x3dom/x3dom.debug.js":21,jbinary:9}],17:[function(e,t,i){"use strict";function o(e){for(var t=0,i=s(e),o=Math.min.apply(null,e),r=Math.max.apply(null,e),n=e.length,a=new Float32Array(n),d=0;n>d;d++)a[d]=5*(e[d]-i[t])/(r-o),t=(t+1)%3;return a}function s(e){for(var t=e.length,i=[0,0,0],o=0,s=0;t>s;s++)i[o]+=e[s],o=(o+1)%3;return[3*i[0]/t,3*i[1]/t,3*i[2]/t]}function r(e,t,i){var o=new FormData(document.getElementById(e)),s=o.getAll("values"),r=d(s,2),n=r[0],a=r[1],l=t+n*(i-t),h=t+a*(i-t);return a>n?{min:l,max:h}:{min:h,max:l}}function n(e,t,i){var o=a(e+"1").value,s=a(e+"2").value,r=t+o*(i-t),n=t+s*(i-t);return s>o?{min:r,max:n}:{min:n,max:r}}function a(e){return document.getElementById(e)}var d=function(){function e(e,t){var i=[],o=!0,s=!1,r=void 0;try{for(var n,a=e[Symbol.iterator]();!(o=(n=a.next()).done)&&(i.push(n.value),!t||i.length!==t);o=!0);}catch(d){s=!0,r=d}finally{try{!o&&a["return"]&&a["return"]()}finally{if(s)throw r}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();i.getDblSliderFormValues=r,i.getSliderMinMax=n,i.scale_center=o,i.get=a},{}],18:[function(e,t,i){"use strict";function o(e,t,i){e._x3domNode._vf[i]=t,e._x3domNode.fieldChanged(i),f.render()}function s(e,t){if(1==t)return new _.fields.MFFloat(e);for(var i=e.length/t,o=Array(i),s="SFVec"+String(t)+"f",r=0;i>r;r++)o[r]=new _.fields[s](e[t*r],e[t*r+1],e[t*r+2]);var n="MFVec"+String(t)+"f",a=new _.fields[n](o);return a}function r(e,t){var i=s(t,3);o(e,i,"point")}function n(e,t){var i=s(t,2);o(e,i,"point")}function a(e,t){var i=s(t,3);o(e,i,"vector")}function d(e,t){o(e,t,"coordIndex")}function l(e,t){var i=s(t,1);o(e,i,"value"),f.render()}function h(e){return document.getElementById(e)}function u(e){var t=e.coord,i=e.coordIndex,o=e.normal,s=e.data;r(h("faceSetCoord"),t),a(h("faceSetNormal"),o),d(h("faceSet"),i),l(h("faceSetAttr"),s),l(h("triSetAttr"),s),r(h("faceSetCoord2"),t),a(h("faceSetNormal2"),o),d(h("faceSet2"),i),l(h("faceSetAttr2"),s)}var f=document.getElementById("x3dElem"),_=e("./x3dom.debug.js");i.updateCoordPoint=r,i.updateTexCoordPoint=n,i.setIndexFaceSet=u,i.updateDataValue=l,i.get=h},{"./x3dom.debug.js":21}],19:[function(e,t){"use strict";function i(e){var t=e.defineClass;e.registerNodeType("IsoColor","Custom",t(e.nodeTypes.CustomAttributeNode,function(t){e.nodeTypes.IsoColor.superClass.call(this,t),this.addField_SFFloat(t,"max",0),this.addField_SFFloat(t,"min",0),this.addField_SFString(t,"dataName",[])},{nodeChanged:function(){this.addUniform("colormapMinUniform",this.get("min"),"float"),this.addUniform("colormapMaxUniform",this.get("max"),"float"),this.addVertexShaderPart("fragTexcoord = vec2((( "+this.get("dataName")+" - colormapMinUniform ) / ( colormapMaxUniform - colormapMinUniform )), 0.0);"),this.addFragmentShaderPart("")},fieldChanged:function(e){"min"===e?this.updateUniform(e,"colormapMinUniform"):"max"===e?this.updateUniform(e,"colormapMaxUniform"):"dataName"===e&&this.attributeNameChanged(e)}}))}t.exports=i},{}],20:[function(e,t){"use strict";function i(e){var t=e.defineClass;e.registerNodeType("Threshold","Custom",t(e.nodeTypes.CustomAttributeNode,function(t){e.nodeTypes.Threshold.superClass.call(this,t),this.addField_SFFloat(t,"upperBound",0),this.addField_SFFloat(t,"lowerBound",0),this.addField_SFString(t,"dataName",[])},{nodeChanged:function(){this.addUniform("thresholdUpperBoundUniform",this.get("upperBound"),"float"),this.addUniform("thresholdLowerBoundUniform",this.get("lowerBound"),"float"),this.addVarying("thresholdDataVarying","float"),this.addVertexShaderPart("thresholdDataVarying = "+this.get("dataName")+";"),this.addFragmentShaderPart("if (thresholdDataVarying > thresholdUpperBoundUniform) {discard;}; if (thresholdDataVarying < thresholdLowerBoundUniform) {discard;}; ")},fieldChanged:function(e){"lowerBound"===e?this.updateUniform(e,"thresholdLowerBoundUniform"):"upperBound"===e?this.updateUniform(e,"thresholdUpperBoundUniform"):"dataName"===e&&this.attributeNameChanged(e)}}))}t.exports=i},{}],21:[function(require,module,exports){"use strict";function initX3dom(){function defineClass(e,t,i){if(e){var o=function(){};o.prototype=e.prototype,t.prototype=new o,t.prototype.constructor=t,t.superClass=e}if(i)for(var s in i)t.prototype[s]=i[s];return t}function array_to_object(e){for(var t={},i=0;i<e.length;i++)t[e[i]]="";return t}function uploadDDSLevels(e,t,i,o){function s(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function r(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}var n,a,d,l,h,u,f,_,c,m,p=542327876,x=131072,g=4,v=s("DXT1"),y=s("DXT5"),b=31,T=0,S=1,M=2,C=3,F=4,E=7,w=20,A=21,R=new Int32Array(i,0,b);if(R[T]!=p)return console.error("Invalid magic number in DDS header"),0;if(!R[w]&g)return console.error("Unsupported format, must contain a FourCC code"),0;switch(n=R[A]){case v:a=8,d=t.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case y:a=16,d=t.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return console.error("Unsupported FourCC code:",r(n)),null}for(c=1,R[M]&x&&o!==!1&&(c=Math.max(1,R[E])),l=R[F],h=R[C],f=R[S]+4,m=0;c>m;++m)u=Math.max(4,l)/4*Math.max(4,h)/4*a,_=new Uint8Array(i,f,u),e.compressedTexImage2D(e.TEXTURE_2D,m,d,l,h,0,_),f+=u,l*=.5,h*=.5;return c}function startDashVideo(e,t){var i,o,s,r=function a(){{var a={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,t,i){a[t]=i})}return a},n=e;r&&r.hasOwnProperty("url")&&(n=r.url),i=document.querySelector(t),o=new Dash.di.DashContext,s=new MediaPlayer(o),s.startup(),s.attachView(i),s.setAutoPlay(!1),s.attachSource(n)}function setUpWebglBuffer(e,t){var i=document.getElementsByTagName("x3d")[0],o=i.runtime.canvas.gl.ctx3d,s=t._cf.threshold.node._vf.dataName,r=new Float32Array(t._mesh._dynamicFields[s].value),n=e._webgl.dynamicFields.find(function(e){return e.name==s});n.buf=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,n.buf),o.bufferData(o.ARRAY_BUFFER,r,o.STATIC_DRAW)}function setNamespace(e,t,i){t instanceof Element&&void 0!==t.__setAttribute&&(t.hasAttribute("id")?t.__setAttribute("id",e.toString().replace(" ","")+"__"+t.getAttribute("id")):t.hasAttribute("DEF")&&i&&(t.__setAttribute("id",e.toString().replace(" ","")+"__"+t.getAttribute("DEF")),t.id||(t.id=t.__getAttribute("id")))),t.hasChildNodes()&&Array.forEach(t.childNodes,function(t){setNamespace(e,t,i)})}Array.forEach||(Array.forEach=function(e,t,i){for(var o=e.length,s=0;o>s;s++)s in e&&t.call(i,e[s],s,e)}),Array.map||(Array.map=function(e,t,i){for(var o=e.length,s=[],r=0;o>r;r++)r in e&&(s[r]=t.call(i,e[r],r,e));return s}),Array.filter||(Array.filter=function(e,t,i){for(var o=e.length,s=[],r=0;o>r;r++)if(r in e){var n=e[r];t.call(i,n,r,e)&&s.push(n)}return s});var x3dom={canvases:[],x3dNS:"http://www.web3d.org/specifications/x3d-namespace",x3dextNS:"http://philip.html5.org/x3d/ext",xsltNS:"http://www.w3.org/1999/XSL/x3dom.Transform",xhtmlNS:"http://www.w3.org/1999/xhtml"};x3dom.nodeTypes={},x3dom.nodeTypesLC={},x3dom.components={},x3dom.geoCache=[],x3dom.caps={PLATFORM:navigator.platform,AGENT:navigator.userAgent,RENDERMODE:"HARDWARE"},x3dom.registerNodeType=function(e,t,i){void 0===x3dom.components[t]&&(x3dom.components[t]={}),i._typeName=e,i._compName=t,x3dom.components[t][e]=i,x3dom.nodeTypes[e]=i,x3dom.nodeTypesLC[e.toLowerCase()]=i},x3dom.isX3DElement=function(e){var t=e.nodeType===Node.ELEMENT_NODE&&e.localName?e.localName.toLowerCase():null;return t&&(x3dom.nodeTypes[e.localName]||x3dom.nodeTypesLC[t]||"x3d"==t||"websg"==t||"route"==t)},x3dom.extend=function(e){function t(){}return t.prototype=e.prototype||e,new t},x3dom.getStyle=function(e,t){var i="",o=document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(e,null):null;return o?i=o.getPropertyValue(t):e.currentStyle&&(t=t.replace(/\-(\w)/g,function(e,t){return t.toUpperCase()}),i=e.currentStyle[t]),i},x3dom.isa=function(e,t){return e instanceof t},x3dom.getGlobal=function(){return function(){return this}.call(null)},x3dom.loadJS=function(src,path_prefix,blocking){if(blocking=blocking===!1?blocking:!0){var url=path_prefix?path_prefix.trim()+src:src,req=new XMLHttpRequest;req&&(req.open("GET",url,!1),req.send(null),eval(req.responseText))}else{var head=document.getElementsByTagName("HEAD").item(0),script=document.createElement("script"),loadpath=path_prefix?path_prefix.trim()+src:src;head?(x3dom.debug.logError("Trying to load external JS file: "+loadpath),script.type="text/javascript",script.src=loadpath,head.appendChild(script)):alert("No document object found. Can't load components!")}},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,16)}}(),x3dom.toggleFullScreen=function(){if(document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen)document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen();else{var e=document.documentElement;e.requestFullScreen?e.requestFullScreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen&&e.webkitRequestFullScreen()}},x3dom.debug={INFO:"INFO",WARNING:"WARNING",ERROR:"ERROR",EXCEPTION:"EXCEPTION",isActive:!1,isFirebugAvailable:!1,isSetup:!1,isAppend:!1,numLinesLogged:0,maxLinesToLog:1e4,logContainer:null,setup:function(){if(!x3dom.debug.isSetup){try{void 0!==window.console.firebug&&(x3dom.debug.isFirebugAvailable=!0)}catch(e){x3dom.debug.isFirebugAvailable=!1}x3dom.debug.setupLogContainer(),x3dom.debug.isSetup=!0}},activate:function(e){x3dom.debug.isActive=!0,x3dom.debug.logContainer.style.display=e?"block":"none",x3dom.debug.isAppend||("Microsoft Internet Explorer"==navigator.appName?(x3dom.debug.logContainer.style.marginLeft="8px",document.documentElement.appendChild(x3dom.debug.logContainer)):document.body.appendChild(x3dom.debug.logContainer),x3dom.debug.isAppend=!0)},setupLogContainer:function(){x3dom.debug.logContainer=document.createElement("div"),x3dom.debug.logContainer.id="x3dom_logdiv",x3dom.debug.logContainer.setAttribute("class","x3dom-logContainer"),x3dom.debug.logContainer.style.clear="both"},doLog:function(e,t){if(x3dom.debug.isActive&&(x3dom.debug.numLinesLogged===x3dom.debug.maxLinesToLog&&(e="Maximum number of log lines (="+x3dom.debug.maxLinesToLog+") reached. Deactivating logging..."),!(x3dom.debug.numLinesLogged>x3dom.debug.maxLinesToLog))){var i=document.createElement("p");switch(i.style.margin=0,t){case x3dom.debug.INFO:i.style.color="#00ff00";break;case x3dom.debug.WARNING:i.style.color="#cd853f";break;case x3dom.debug.ERROR:i.style.color="#ff4500";break;case x3dom.debug.EXCEPTION:i.style.color="#ffff00";break;default:i.style.color="#00ff00"}try{i.innerHTML=t+": "+e,x3dom.debug.logContainer.insertBefore(i,x3dom.debug.logContainer.firstChild)}catch(o){void 0!==window.console.firebug&&window.console.warn(e)}if(x3dom.debug.isFirebugAvailable)switch(t){case x3dom.debug.INFO:window.console.info(e);break;case x3dom.debug.WARNING:window.console.warn(e);break;case x3dom.debug.ERROR:window.console.error(e);break;case x3dom.debug.EXCEPTION:window.console.debug(e)}x3dom.debug.numLinesLogged++}},logInfo:function(e){x3dom.debug.doLog(e,x3dom.debug.INFO)},logWarning:function(e){x3dom.debug.doLog(e,x3dom.debug.WARNING)},logError:function(e){x3dom.debug.doLog(e,x3dom.debug.ERROR)},logException:function(e){x3dom.debug.doLog(e,x3dom.debug.EXCEPTION)},assert:function(e,t){e||x3dom.debug.doLog("Assertion failed in "+x3dom.debug.assert.caller.name+": "+t,x3dom.debug.ERROR)},typeOf:function(e){var t="undefined"==typeof e?"undefined":_typeof(e);return"object"!==t||e?t:"null"},exists:function(e,t,i){return i=i||"function",(e?this.typeOf(e[t]):"null")===i},dumpFields:function(e){var t="";for(var i in e)t+=i+", ";return t+="\n",x3dom.debug.logInfo(t),t}},x3dom.debug.setup(),x3dom.arc={},x3dom.arc.instance=null,x3dom.arc.Limits=function(e,t){this._min=e,this._max=t,this.getValue=function(e){return e=this._min+(this._max-this._min)*e,this._max>=e?this._min<=e?e:this._min:this._max}},x3dom.arc.ARF=function(e,t,i,o,s,r,n,a){this._name=e,this._stateValue=[.5,.5],this._limits=new x3dom.arc.Limits(t,i),this._factorGetterFunc=s,this._factorSetterFunc=r,this._setterFunc=a,this._getterFunc=n,this._dirFac=o,this.getFactor=function(){return this._factorGetterFunc()},this.update=function(e,t){var i=this._stateValue[e]+t*this._dirFac;this._stateValue[e]=i>=0?1>=i?i:1:0,this._setterFunc(this._limits.getValue(this._stateValue[e]))},this.reset=function(){this._stateValue[0]=.5,this._stateValue[1]=.5}},x3dom.arc.AdaptiveRenderControl=defineClass(null,function(e){x3dom.arc.instance=this,this._scene=e,this._targetFrameRate=[],this._targetFrameRate[0]=this._scene._vf.minFrameRate,this._targetFrameRate[1]=this._scene._vf.maxFrameRate,this._currentState=0;var t=this,i=t._scene.getEnvironment();this._arfs=[],this._arfs.push(new x3dom.arc.ARF("smallFeatureCulling",0,10,-1,function(){return i._vf.smallFeatureFactor},function(e){i._vf.smallFeatureFactor=e},function(){return i._vf.smallFeatureThreshold},function(e){i._vf.smallFeatureThreshold=e})),this._arfs.push(new x3dom.arc.ARF("lowPriorityCulling",0,100,1,function(){return i._vf.lowPriorityFactor},function(e){i._vf.lowPriorityFactor=e},function(){return 100*i._vf.lowPriorityThreshold},function(e){i._vf.lowPriorityThreshold=e/100})),this._arfs.push(new x3dom.arc.ARF("tessellationDetailCulling",1,12,-1,function(){return i._vf.tessellationErrorFactor},function(e){i._vf.tessellationErrorFactor=e},function(){return i.tessellationErrorThreshold},function(e){i.tessellationErrorThreshold=e})),this._stepWidth=.1},{update:function(e,t){this._currentState=e;var i=t-this._targetFrameRate[e];this._stepWidth=Math.abs(i)>10?.1:.01;var o,s=0,r=[],n=this._arfs.length;for(o=0;n>o;++o)r[o]=this._arfs[o].getFactor(),r[o]>0&&(s+=r[o]);var a=0>i?-1:1;for(o=0;n>o;++o)r[o]>0&&(r[o]/=s,this._arfs[o].update(e,this._stepWidth*r[o]*a))},reset:function(){for(var e=0,t=this._arfs.length;t>e;++e)this._arfs[e].reset()}});var Request=function(e,t,i){this.url=e,this.priority=i,this.xhr=new XMLHttpRequest,this.onloadCallbacks=[t];var o=this;this.xhr.onload=function(){if(x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager received data for URL '"+o.url+"'."),--x3dom.DownloadManager.activeDownloads,x3dom.DownloadManager.stallToKeepOrder===!1||x3dom.DownloadManager.resultGetsStalled(o.priority)===!1){var e;for(e=0;e<o.onloadCallbacks.length;++e)o.onloadCallbacks[e](o.xhr.response);x3dom.DownloadManager.removeDownload(o),x3dom.DownloadManager.updateStalledResults()}else x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager stalled downloaded result for URL '"+o.url+"'.");x3dom.DownloadManager.tryNextDownload()}};Request.prototype.send=function(){this.xhr.open("GET",encodeURI(this.url),!0),this.xhr.responseType="arraybuffer",this.xhr.send(null),x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager posted XHR for URL '"+this.url+"'.")},x3dom.DownloadManager={requests:[],maxDownloads:6,activeDownloads:0,debugOutput:!1,stallToKeepOrder:!1,toggleDebugOutput:function(e){this.debugOutput=e},toggleStrictReturnOrder:function(){this.stallToKeepOrder=!1},removeDownload:function(e){var t,i,o=!1;for(t=0;t<this.requests.length&&!o;++t)if(this.requests[t])for(i=0;i<this.requests[t].length;++i)if(this.requests[t][i]===e){this.requests[t].splice(i,1),o=!0;break}},tryNextDownload:function(){var e,t,i;if(this.activeDownloads<this.maxDownloads){for(t=0;t<this.requests.length&&!e;++t)if(this.requests[t])for(i=0;i<this.requests[t].length;++i)if(this.requests[t][i].xhr.readyState===XMLHttpRequest.UNSENT){e=this.requests[t][i];break}e&&(e.send(),++this.activeDownloads)}},resultGetsStalled:function(e){var t;for(t=0;e>t;++t)if(this.requests[t]&&this.requests[t].length)return!0;return!1},updateStalledResults:function(){if(x3dom.DownloadManager.stallToKeepOrder){var e,t,i,o,s=!1;for(e=0;e<this.requests.length&&!s;++e)if(this.requests[e])for(t=0;t<this.requests[e].length;++t)if(o=this.requests[e][t],o.xhr.readyState===XMLHttpRequest.DONE){for(x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager releases stalled result for URL '"+o.url+"'."),i=0;i<o.onloadCallbacks.length;++i)o.onloadCallbacks[i](o.xhr.response);this.requests[e].splice(t,1)}else s=!0}},get:function(e,t,i){var o,s,r,n,a,d,l,h=!1;if(e.length!==t.length||e.length!==i.length)return void x3dom.debug.logError("DownloadManager: The number of given urls, onload callbacks and priorities is not equal. Ignoring requests.");for(r=0;r<e.length;++r)if(void 0!==!t[r]&&void 0!==!i[r]){for(a=e[r],d=t[r],l=i[r],o=0;o<this.requests.length&&!h;++o)if(this.requests[o])for(s=0;s<this.requests[o].length;++s)if(this.requests[o][s].url===a){this.requests[o][s].onloadCallbacks.push(d),x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager appended onload callback for URL '"+a+"' to a registered request using the same URL."),h=!0;break}h||(n=new Request(a,d,l),this.requests[l]?this.requests[l].push(n):this.requests[l]=[n])}else x3dom.debug.logError('DownloadManager: No onload callback and / or priority specified. Ignoring request for "'+a+'"');for(o=0;o<e.length&&this.activeDownloads<this.maxDownloads;++o)this.tryNextDownload()}},x3dom.MultiMaterial=function(e){this._origAmbientIntensity=e.ambientIntensity,this._origDiffuseColor=e.diffuseColor,this._origEmissiveColor=e.emissiveColor,this._origShininess=e.shininess,this._origSpeclarColor=e.specularColor,this._origTransparency=e.transparency,this._origBackAmbientIntensity=e.backAmbientIntensity,this._origBackDiffuseColor=e.backDiffuseColor,this._origBackEmissiveColor=e.backEmissiveColor,this._origBackShininess=e.backShininess,this._origBackSpecularColor=e.backSpecularColor,this._origBackTransparency=e.backTransparency,this._ambientIntensity=e.ambientIntensity,this._diffuseColor=e.diffuseColor,this._emissiveColor=e.emissiveColor,this._shininess=e.shininess,this._specularColor=e.specularColor,this._transparency=e.transparency,this._backAmbientIntensity=e.backAmbientIntensity,this._backDiffuseColor=e.backDiffuseColor,this._backEmissiveColor=e.backEmissiveColor,this._backShininess=e.backShininess,this._backSpecularColor=e.backSpecularColor,this._backTransparency=e.backTransparency,
this._highlighted=!1,this.reset=function(){this._ambientIntensity=this._origAmbientIntensity,this._diffuseColor=this._origDiffuseColor,this._emissiveColor=this._origEmissiveColor,this._shininess=this._origShininess,this._specularColor=this._origSpeclarColor,this._transparency=this._origTransparency,this._backAmbientIntensity=this._origBackAmbientIntensity,this._backDiffuseColor=this._origBackDiffuseColor,this._backEmissiveColor=this._origBackEmissiveColor,this._backShininess=this._origBackShininess,this._backSpecularColor=this._origBackSpecularColor,this._backTransparency=this._origBackTransparency}},x3dom.Parts=function(e,t,i,o,s,r){var n=this;this.multiPart=e,this.ids=t,this.colorMap=i,this.emissiveMap=o,this.specularMap=s,this.visibilityMap=r,this.width=n.colorMap.getWidth(),this.widthTwo=this.width*this.width,this.setDiffuseColor=function(e,i){var o,s,r,a;if(void 0==i&&"front"!=i&&"back"!=i&&"both"!=i&&(i="both"),e=x3dom.fields.SFColor.parse(e),t.length&&t.length>1){var d=n.colorMap.getPixels();for(o=0;o<n.ids.length;o++)s=n.ids[o],r=s,a=s+this.widthTwo,"front"==i?this.multiPart._materials[s]._diffuseColor=e:"back"==i?this.multiPart._materials[s]._backDiffuseColor=e:"both"==i&&(this.multiPart._materials[s]._diffuseColor=e,this.multiPart._materials[s]._backDiffuseColor=e),this.multiPart._materials[s]._highlighted||("front"==i?(d[r].r=e.r,d[r].g=e.g,d[r].b=e.b):"back"==i?(d[a].r=e.r,d[a].g=e.g,d[a].b=e.b):"both"==i&&(d[r].r=e.r,d[r].g=e.g,d[r].b=e.b,d[a].r=e.r,d[a].g=e.g,d[a].b=e.b));n.colorMap.setPixels(d)}else{var l,h,u,f,_,c;s=n.ids[0],r=s,a=s+this.widthTwo,"front"==i?(l=r%this.width,h=Math.floor(r/this.width),_=n.colorMap.getPixel(l,h),this.multiPart._materials[s]._diffuseColor=e):"back"==i?(u=a%this.width,f=Math.floor(a/this.width),c=n.colorMap.getPixel(u,f),this.multiPart._materials[s]._backDiffuseColor=e):"both"==i&&(l=r%this.width,h=Math.floor(r/this.width),u=a%this.width,f=Math.floor(a/this.width),_=n.colorMap.getPixel(l,h),c=n.colorMap.getPixel(u,f),this.multiPart._materials[s]._diffuseColor=e,this.multiPart._materials[s]._backDiffuseColor=e),this.multiPart._materials[s]._highlighted||("front"==i?(_.r=e.r,_.g=e.g,_.b=e.b,n.colorMap.setPixel(l,h,_)):"back"==i?(c.r=e.r,c.g=e.g,c.b=e.b,n.colorMap.setPixel(u,f,c)):"both"==i&&(_.r=e.r,_.g=e.g,_.b=e.b,c.r=e.r,c.g=e.g,c.b=e.b,n.colorMap.setPixel(l,h,_),n.colorMap.setPixel(u,f,c)))}},this.getDiffuseColor=function(e){var i,o;if(void 0==e&&"front"!=e&&"back"!=e&&(e="front"),t.length&&t.length>1){var s=[];for(i=0;i<n.ids.length;i++)o=n.ids[i],"front"==e?s.push(this.multiPart._materials[o]._diffuseColor):"back"==e&&s.push(this.multiPart._materials[o]._backDiffuseColor);return s}return o=n.ids[0],"front"==e?this.multiPart._materials[o]._diffuseColor:"back"==e?this.multiPart._materials[o]._backDiffuseColor:void 0},this.setEmissiveColor=function(e,i){var o,s,r,a;if(void 0==i&&"front"!=i&&"back"!=i&&"both"!=i&&(i="both"),e=x3dom.fields.SFColor.parse(e),t.length&&t.length>1){var d=n.emissiveMap.getPixels();for(o=0;o<n.ids.length;o++)s=n.ids[o],r=s,a=s+this.widthTwo,"front"==i?this.multiPart._materials[s]._emissiveColor=e:"back"==i?this.multiPart._materials[s]._backEmissiveColor=e:"both"==i&&(this.multiPart._materials[s]._emissiveColor=e,this.multiPart._materials[s]._backEmissiveColor=e),this.multiPart._materials[s]._highlighted||("front"==i?(d[r].r=e.r,d[r].g=e.g,d[r].b=e.b):"back"==i?(d[a].r=e.r,d[a].g=e.g,d[a].b=e.b):"both"==i&&(d[r].r=e.r,d[r].g=e.g,d[r].b=e.b,d[a].r=e.r,d[a].g=e.g,d[a].b=e.b));n.emissiveMap.setPixels(d)}else{var l,h,u,f,_,c;s=n.ids[0],r=s,a=s+this.widthTwo,"front"==i?(l=r%this.width,h=Math.floor(r/this.width),_=n.emissiveMap.getPixel(l,h),this.multiPart._materials[s]._emissiveColor=e):"back"==i?(u=a%this.width,f=Math.floor(a/this.width),c=n.emissiveMap.getPixel(u,f),this.multiPart._materials[s]._backEmissiveColor=e):"both"==i&&(l=r%this.width,h=Math.floor(r/this.width),u=a%this.width,f=Math.floor(a/this.width),_=n.emissiveMap.getPixel(l,h),c=n.emissiveMap.getPixel(u,f),this.multiPart._materials[s]._emissiveColor=e,this.multiPart._materials[s]._backEmissiveColor=e),this.multiPart._materials[s]._highlighted||("front"==i?(_.r=e.r,_.g=e.g,_.b=e.b,n.emissiveMap.setPixel(l,h,_)):"back"==i?(c.r=e.r,c.g=e.g,c.b=e.b,n.emissiveMap.setPixel(u,f,c)):"both"==i&&(_.r=e.r,_.g=e.g,_.b=e.b,c.r=e.r,c.g=e.g,c.b=e.b,n.emissiveMap.setPixel(l,h,_),n.emissiveMap.setPixel(u,f,c)))}},this.getEmissiveColor=function(e){var i,o;if(void 0==e&&"front"!=e&&"back"!=e&&(e="front"),t.length&&t.length>1){var s=[];for(i=0;i<n.ids.length;i++)o=n.ids[i],"front"==e?s.push(this.multiPart._materials[o]._emissiveColor):"back"==e&&s.push(this.multiPart._materials[o]._backEmissiveColor);return s}return o=n.ids[0],"front"==e?this.multiPart._materials[o]._emissiveColor:"back"==e?this.multiPart._materials[o]._backEmissiveColor:void 0},this.setSpecularColor=function(e,i){var o,s,r,a;if(void 0==i&&"front"!=i&&"back"!=i&&"both"!=i&&(i="both"),e=x3dom.fields.SFColor.parse(e),t.length&&t.length>1){var d=n.specularMap.getPixels();for(o=0;o<n.ids.length;o++)s=n.ids[o],r=s,a=s+this.widthTwo,"front"==i?this.multiPart._materials[s]._specularColor=e:"back"==i?this.multiPart._materials[s]._backSpecularColor=e:"both"==i&&(this.multiPart._materials[s]._specularColor=e,this.multiPart._materials[s]._backSpecularColor=e),this.multiPart._materials[s]._highlighted||("front"==i?(d[r].r=e.r,d[r].g=e.g,d[r].b=e.b):"back"==i?(d[a].r=e.r,d[a].g=e.g,d[a].b=e.b):"both"==i&&(d[r].r=e.r,d[r].g=e.g,d[r].b=e.b,d[a].r=e.r,d[a].g=e.g,d[a].b=e.b));n.specularMap.setPixels(d)}else{var l,h,u,f,_,c;s=n.ids[0],r=s,a=s+this.widthTwo,"front"==i?(l=r%this.width,h=Math.floor(r/this.width),_=n.specularMap.getPixel(l,h),this.multiPart._materials[s]._specularColor=e):"back"==i?(u=a%this.width,f=Math.floor(a/this.width),c=n.specularMap.getPixel(u,f),this.multiPart._materials[s]._backSpecularColor=e):"both"==i&&(l=r%this.width,h=Math.floor(r/this.width),u=a%this.width,f=Math.floor(a/this.width),_=n.specularMap.getPixel(l,h),c=n.specularMap.getPixel(u,f),this.multiPart._materials[s]._specularColor=e,this.multiPart._materials[s]._backSpecularColor=e),this.multiPart._materials[s]._highlighted||("front"==i?(_.r=e.r,_.g=e.g,_.b=e.b,n.specularMap.setPixel(l,h,_)):"back"==i?(c.r=e.r,c.g=e.g,c.b=e.b,n.specularMap.setPixel(u,f,c)):"both"==i&&(_.r=e.r,_.g=e.g,_.b=e.b,c.r=e.r,c.g=e.g,c.b=e.b,n.specularMap.setPixel(l,h,_),n.specularMap.setPixel(u,f,c)))}},this.getSpecularColor=function(e){var i,o;if(void 0==e&&"front"!=e&&"back"!=e&&(e="front"),t.length&&t.length>1){var s=[];for(i=0;i<n.ids.length;i++)o=n.ids[i],"front"==e?s.push(this.multiPart._materials[o]._specularColor):"back"==e&&s.push(this.multiPart._materials[o]._backSpecularColor);return s}return o=n.ids[0],"front"==e?this.multiPart._materials[o]._specularColor:"back"==e?this.multiPart._materials[o]._backSpecularColor:void 0},this.setTransparency=function(e,i){var o,s,r,a;if(void 0==i&&"front"!=i&&"back"!=i&&"both"!=i&&(i="both"),t.length&&t.length>1){var d=n.colorMap.getPixels();for(o=0;o<n.ids.length;o++)s=n.ids[o],r=s,a=s+this.widthTwo,"front"==i?this.multiPart._materials[s]._transparency=e:"back"==i?this.multiPart._materials[s]._backTransparency=e:"both"==i&&(this.multiPart._materials[s]._transparency=e,this.multiPart._materials[s]._backTransparency=e),this.multiPart._materials[s]._highlighted||("front"==i?d[r].a=1-e:"back"==i?d[a].a=1-e:"both"==i&&(d[r].a=1-e,d[a].a=1-e));n.colorMap.setPixels(d)}else{var l,h,u,f,_,c;s=n.ids[0],r=s,a=s+this.widthTwo,"front"==i?(l=r%this.width,h=Math.floor(r/this.width),_=n.colorMap.getPixel(l,h),this.multiPart._materials[s]._transparency=e):"back"==i?(u=a%this.width,f=Math.floor(a/this.width),c=n.colorMap.getPixel(u,f),this.multiPart._materials[s]._backTransparency=e):"both"==i&&(l=r%this.width,h=Math.floor(r/this.width),u=a%this.width,f=Math.floor(a/this.width),_=n.colorMap.getPixel(l,h),c=n.colorMap.getPixel(u,f),this.multiPart._materials[s]._transparency=e,this.multiPart._materials[s]._backTransparency=e),this.multiPart._materials[s]._highlighted||("front"==i?(_.a=1-e,n.colorMap.setPixel(l,h,_)):"back"==i?(c.a=1-e,n.colorMap.setPixel(u,f,c)):"both"==i&&(_.a=1-e,c.a=1-e,n.colorMap.setPixel(l,h,_),n.colorMap.setPixel(u,f,c)))}},this.getTransparency=function(e){var i,o;if(void 0==e&&"front"!=e&&"back"!=e&&(e="front"),t.length&&t.length>1){var s=[];for(i=0;i<n.ids.length;i++)o=n.ids[i],"front"==e?s.push(this.multiPart._materials[o]._transparency):"back"==e&&s.push(this.multiPart._materials[o]._backTransparency);return s}return o=n.ids[0],"front"==e?this.multiPart._materials[o]._transparency:"back"==e?this.multiPart._materials[o]._backTransparency:void 0},this.setShininess=function(e,i){var o,s,r,a;if(void 0==i&&"front"!=i&&"back"!=i&&"both"!=i&&(i="both"),t.length&&t.length>1){var d=n.specularMap.getPixels();for(o=0;o<n.ids.length;o++)s=n.ids[o],r=s,a=s+this.widthTwo,"front"==i?this.multiPart._materials[s]._shininess=e:"back"==i?this.multiPart._materials[s]._backShininess=e:"both"==i&&(this.multiPart._materials[s]._shininess=e,this.multiPart._materials[s]._backShininess=e),this.multiPart._materials[s]._highlighted||("front"==i?d[r].a=e:"back"==i?d[a].a=e:"both"==i&&(d[r].a=e,d[a].a=e));n.specularMap.setPixels(d)}else{var l,h,u,f,_,c;s=n.ids[0],r=s,a=s+this.widthTwo,"front"==i?(l=r%this.width,h=Math.floor(r/this.width),_=n.specularMap.getPixel(l,h),this.multiPart._materials[s]._shininess=e):"back"==i?(u=a%this.width,f=Math.floor(a/this.width),c=n.specularMap.getPixel(u,f),this.multiPart._materials[s]._backShininess=e):"both"==i&&(l=r%this.width,h=Math.floor(r/this.width),u=a%this.width,f=Math.floor(a/this.width),_=n.specularMap.getPixel(l,h),c=n.specularMap.getPixel(u,f),this.multiPart._materials[s]._shininess=e,this.multiPart._materials[s]._backShininess=e),this.multiPart._materials[s]._highlighted||("front"==i?(_.a=e,n.specularMap.setPixel(l,h,_)):"back"==i?(c.a=e,n.specularMap.setPixel(u,f,c)):"both"==i&&(_.a=e,c.a=e,n.specularMap.setPixel(l,h,_),n.specularMap.setPixel(u,f,c)))}},this.getShininess=function(e){var i,o;if(void 0==e&&"front"!=e&&"back"!=e&&(e="front"),t.length&&t.length>1){var s=[];for(i=0;i<n.ids.length;i++)o=n.ids[i],"front"==e?s.push(this.multiPart._materials[o]._shininess):"back"==e&&s.push(this.multiPart._materials[o]._backShininess);return s}return o=n.ids[0],"front"==e?this.multiPart._materials[o]._shininess:"back"==e?this.multiPart._materials[o]._backShininess:void 0},this.setAmbientIntensity=function(e,i){var o,s,r,a;if(void 0==i&&"front"!=i&&"back"!=i&&"both"!=i&&(i="both"),t.length&&t.length>1){var d=n.emissiveMap.getPixels();for(o=0;o<n.ids.length;o++)s=n.ids[o],r=s,a=s+this.widthTwo,"front"==i?this.multiPart._materials[s]._ambientIntensity=e:"back"==i?this.multiPart._materials[s]._backAmbientIntensity=e:"both"==i&&(this.multiPart._materials[s]._ambientIntensity=e,this.multiPart._materials[s]._backAmbientIntensity=e),this.multiPart._materials[s]._highlighted||("front"==i?d[r].a=e:"back"==i?d[a].a=e:"both"==i&&(d[r].a=e,d[a].a=e));n.emissiveMap.setPixels(d)}else{var l,h,u,f,_,c;s=n.ids[0],r=s,a=s+this.widthTwo,"front"==i?(l=r%this.width,h=Math.floor(r/this.width),_=n.emissiveMap.getPixel(l,h),this.multiPart._materials[s]._ambientIntensity=e):"back"==i?(u=a%this.width,f=Math.floor(a/this.width),c=n.emissiveMap.getPixel(u,f),this.multiPart._materials[s]._backAmbientIntensity=e):"both"==i&&(l=r%this.width,h=Math.floor(r/this.width),u=a%this.width,f=Math.floor(a/this.width),_=n.emissiveMap.getPixel(l,h),c=n.emissiveMap.getPixel(u,f),this.multiPart._materials[s]._ambientIntensity=e,this.multiPart._materials[s]._backAmbientIntensity=e),this.multiPart._materials[s]._highlighted||("front"==i?(_.a=e,n.emissiveMap.setPixel(l,h,_)):"back"==i?(c.a=e,n.emissiveMap.setPixel(u,f,c)):"both"==i&&(_.a=e,c.a=e,n.emissiveMap.setPixel(l,h,_),n.emissiveMap.setPixel(u,f,c)))}},this.getAmbientIntensity=function(e){var i,o;if(void 0==e&&"front"!=e&&"back"!=e&&(e="front"),t.length&&t.length>1){var s=[];for(i=0;i<n.ids.length;i++)o=n.ids[i],"front"==e?s.push(this.multiPart._materials[o]._ambientIntensity):"back"==e&&s.push(this.multiPart._materials[o]._backAmbientIntensity);return s}return o=n.ids[0],"front"==e?this.multiPart._materials[o]._ambientIntensity:"back"==e?this.multiPart._materials[o]._backAmbientIntensity:void 0},this.highlight=function(e){var i,o,s,r,a,d,l;if(e=x3dom.fields.SFColor.parse(e),t.length&&t.length>1){var h=n.colorMap.getPixels(),u=n.emissiveMap.getPixels(),f=n.specularMap.getPixels();for(a=new x3dom.fields.SFColorRGBA(0,0,0,1),d=new x3dom.fields.SFColorRGBA(e.r,e.g,e.b,0),l=new x3dom.fields.SFColorRGBA(0,0,0,0),i=0;i<n.ids.length;i++)o=n.ids[i],s=o,r=o+this.widthTwo,this.multiPart._materials[o]._highlighted||(this.multiPart._materials[o]._highlighted=!0,h[s]=a,u[s]=d,f[s]=l,h[r]=a,u[r]=d,f[r]=l);this.colorMap.setPixels(h,!1),this.emissiveMap.setPixels(u,!1),this.specularMap.setPixels(f,!0)}else{o=n.ids[0],s=o,r=o+this.widthTwo;var _=s%this.width,c=Math.floor(s/this.width),m=r%this.width,p=Math.floor(r/this.width);this.multiPart._materials[o]._highlighted||(this.multiPart._materials[o]._highlighted=!0,a=new x3dom.fields.SFColorRGBA(0,0,0,1),d=new x3dom.fields.SFColorRGBA(e.r,e.g,e.b,0),l=new x3dom.fields.SFColorRGBA(0,0,0,0),this.colorMap.setPixel(_,c,a,!1),this.emissiveMap.setPixel(_,c,d,!1),this.specularMap.setPixel(_,c,l,!1),this.colorMap.setPixel(m,p,a,!1),this.emissiveMap.setPixel(m,p,d,!1),this.specularMap.setPixel(m,p,l,!0))}},this.unhighlight=function(){var e,i,o,s,r,a,d,l,h,u,f;if(t.length&&t.length>1){var _=n.colorMap.getPixels(),c=n.emissiveMap.getPixels(),m=n.specularMap.getPixels();for(e=0;e<n.ids.length;e++)i=n.ids[e],o=i,s=i+this.widthTwo,r=this.multiPart._materials[i],r._highlighted&&(r._highlighted=!1,_[o]=new x3dom.fields.SFColorRGBA(r._diffuseColor.r,r._diffuseColor.g,r._diffuseColor.b,1-r._transparency),c[o]=new x3dom.fields.SFColorRGBA(r._emissiveColor.r,r._emissiveColor.g,r._emissiveColor.b,r._ambientIntensity),m[o]=new x3dom.fields.SFColorRGBA(r._specularColor.r,r._specularColor.g,r._specularColor.b,r._shininess),_[s]=new x3dom.fields.SFColorRGBA(r._backDiffuseColor.r,r._backDiffuseColor.g,r._backDiffuseColor.b,1-r._backTransparency),c[s]=new x3dom.fields.SFColorRGBA(r._backEmissiveColor.r,r._backEmissiveColor.g,r._backEmissiveColor.b,r._backAmbientIntensity),m[s]=new x3dom.fields.SFColorRGBA(r._backSpecularColor.r,r._backSpecularColor.g,r._backSpecularColor.b,r._backShininess));this.colorMap.setPixels(_,!1),this.emissiveMap.setPixels(c,!1),this.specularMap.setPixels(m,!0)}else{i=n.ids[0],o=i,s=i+this.widthTwo;var p=o%this.width,x=Math.floor(o/this.width),g=s%this.width,v=Math.floor(s/this.width);r=this.multiPart._materials[i],r._highlighted&&(r._highlighted=!1,a=new x3dom.fields.SFColorRGBA(r._diffuseColor.r,r._diffuseColor.g,r._diffuseColor.b,1-r._transparency),d=new x3dom.fields.SFColorRGBA(r._emissiveColor.r,r._emissiveColor.g,r._emissiveColor.b,r._ambientIntensity),l=new x3dom.fields.SFColorRGBA(r._specularColor.r,r._specularColor.g,r._specularColor.b,r._shininess),h=new x3dom.fields.SFColorRGBA(r._backDiffuseColor.r,r._backDiffuseColor.g,r._backDiffuseColor.b,1-r._backTransparency),u=new x3dom.fields.SFColorRGBA(r._backEmissiveColor.r,r._backEmissiveColor.g,r._backEmissiveColor.b,r._backAmbientIntensity),f=new x3dom.fields.SFColorRGBA(r._backSpecularColor.r,r._backSpecularColor.g,r._backSpecularColor.b,r._backShininess),this.colorMap.setPixel(p,x,a,!1),this.emissiveMap.setPixel(p,x,d,!1),this.specularMap.setPixel(p,x,l,!1),this.colorMap.setPixel(g,v,h,!1),this.emissiveMap.setPixel(g,v,u,!1),this.specularMap.setPixel(g,v,f,!0))}},this.toggleHighlight=function(e){for(var t=0;t<n.ids.length;t++)this.multiPart._materials[n.ids[t]]._highlighted?this.unhighlight():this.highlight(e)},this.setColor=function(e,t){this.setDiffuseColor(e,t)},this.getColorRGB=function(){var e=this.getColorRGBA(),t=e.split(" ");return t[0]+" "+t[1]+" "+t[2]},this.getColorRGBA=function(){var e,t,i=this.multiPart._originalColor[n.ids[0]];return this.multiPart._highlightedParts[n.ids[0]]?i=this.multiPart._highlightedParts[n.ids[0]]:(e=n.ids[0]%n.colorMap.getWidth(),t=Math.floor(n.ids[0]/n.colorMap.getWidth()),i=n.colorMap.getPixel(e,t)),i.toString()},this.resetColor=function(){var e,i,o,s,r,a,d,l,h,u,f;if(t.length&&t.length>1){var _=n.colorMap.getPixels(),c=n.emissiveMap.getPixels(),m=n.specularMap.getPixels();for(e=0;e<n.ids.length;e++)i=n.ids[e],o=i,s=i+this.widthTwo,r=this.multiPart._materials[i],r.reset(),r._highlighted||(_[o]=new x3dom.fields.SFColorRGBA(r._diffuseColor.r,r._diffuseColor.g,r._diffuseColor.b,1-r._transparency),c[o]=new x3dom.fields.SFColorRGBA(r._emissiveColor.r,r._emissiveColor.g,r._emissiveColor.b,r._ambientIntensity),m[o]=new x3dom.fields.SFColorRGBA(r._specularColor.r,r._specularColor.g,r._specularColor.b,r._shininess),_[s]=new x3dom.fields.SFColorRGBA(r._backDiffuseColor.r,r._backDiffuseColor.g,r._backDiffuseColor.b,1-r._backTransparency),c[s]=new x3dom.fields.SFColorRGBA(r._backEmissiveColor.r,r._backEmissiveColor.g,r._backEmissiveColor.b,r._backAmbientIntensity),m[s]=new x3dom.fields.SFColorRGBA(r._backSpecularColor.r,r._backSpecularColor.g,r._backSpecularColor.b,r._backShininess));this.colorMap.setPixels(_,!1),this.emissiveMap.setPixels(c,!1),this.specularMap.setPixels(m,!0)}else{i=n.ids[0],o=i,s=i+this.widthTwo;var p=o%this.width,x=Math.floor(o/this.width),g=s%this.width,v=Math.floor(s/this.width);r=this.multiPart._materials[i],r.reset(),r._highlighted||(a=new x3dom.fields.SFColorRGBA(r._diffuseColor.r,r._diffuseColor.g,r._diffuseColor.b,1-r._transparency),d=new x3dom.fields.SFColorRGBA(r._emissiveColor.r,r._emissiveColor.g,r._emissiveColor.b,r._ambientIntensity),l=new x3dom.fields.SFColorRGBA(r._specularColor.r,r._specularColor.g,r._specularColor.b,r._shininess),h=new x3dom.fields.SFColorRGBA(r._backDiffuseColor.r,r._backDiffuseColor.g,r._backDiffuseColor.b,1-r._backTransparency),u=new x3dom.fields.SFColorRGBA(r._backEmissiveColor.r,r._backEmissiveColor.g,r._backEmissiveColor.b,r._backAmbientIntensity),f=new x3dom.fields.SFColorRGBA(r._backSpecularColor.r,r._backSpecularColor.g,r._backSpecularColor.b,r._backShininess),this.colorMap.setPixel(p,x,a,!1),this.emissiveMap.setPixel(p,x,d,!1),this.specularMap.setPixel(p,x,l,!1),this.colorMap.setPixel(g,v,h,!1),this.emissiveMap.setPixel(g,v,u,!1),this.specularMap.setPixel(g,v,f,!0))}},this.setVisibility=function(e){var i,o,s,r,a,d,l;if(t.length&&t.length>1){var h=n.visibilityMap.getPixels();for(i=0;i<n.ids.length;i++)if(l=e?1:0,h[n.ids[i]].r!=l)for(h[n.ids[i]].r=l,this.multiPart._partVisibility[n.ids[i]]=e,a=this.multiPart._idMap.mapping[n.ids[i]].usage,o=0;o<a.length;o++)d=this.multiPart._visiblePartsPerShape[a[o]],e&&d.val<d.max?d.val++:!e&&d.val>0&&d.val--,this.multiPart._inlineNamespace.defMap[a[o]]._vf.render=d.val?!0:!1;n.visibilityMap.setPixels(h),this.multiPart.invalidateVolume()}else{s=n.ids[0]%n.colorMap.getWidth(),r=Math.floor(n.ids[0]/n.colorMap.getWidth());var u=n.visibilityMap.getPixel(s,r);if(l=e?1:0,u.r!=l)for(u.r=l,this.multiPart._partVisibility[n.ids[0]]=e,a=this.multiPart._idMap.mapping[n.ids[0]].usage,o=0;o<a.length;o++)d=this.multiPart._visiblePartsPerShape[a[o]],e&&d.val<d.max?d.val++:!e&&d.val>0&&d.val--,this.multiPart._inlineNamespace.defMap[a[o]]._vf.render=d.val?!0:!1;n.visibilityMap.setPixel(s,r,u),this.multiPart.invalidateVolume()}},this.getVolume=function(){var e,i=this.multiPart.getCurrentTransform();if(t.length&&t.length>1){e=new x3dom.fields.BoxVolume;for(var o=0;o<n.ids.length;o++)e.extendBounds(this.multiPart._partVolume[n.ids[o]].min,this.multiPart._partVolume[n.ids[o]].max);return e.transform(i),e}return e=x3dom.fields.BoxVolume.copy(this.multiPart._partVolume[n.ids[0]]),e.transform(i),e},this.fit=function(e){var t=this.getVolume();this.multiPart._nameSpace.doc._viewarea.fit(t.min,t.max,e)}},x3dom.Properties=function(){this.properties={}},x3dom.Properties.prototype.setProperty=function(e,t){x3dom.debug.logInfo("Properties: Setting property '"+e+"' to value '"+t+"'"),this.properties[e]=t},x3dom.Properties.prototype.getProperty=function(e,t){return this.properties[e]?this.properties[e]:t},x3dom.Properties.prototype.merge=function(e){for(var t in e.properties)this.properties[t]=e.properties[t]},x3dom.Properties.prototype.toString=function(){var e="";for(var t in this.properties)e+="Name: "+t+" Value: "+this.properties[t]+"\n";return e},x3dom.DoublyLinkedList=function(){this.length=0,this.first=null,this.last=null},x3dom.DoublyLinkedList.ListNode=function(e,t,i,o,s){this.point=e,this.point_index=t,this.normals=i,this.colors=o,this.texCoords=s,this.next=null,this.prev=null},x3dom.DoublyLinkedList.prototype.appendNode=function(e){null===this.first?(e.prev=e,e.next=e,this.first=e,this.last=e):(e.prev=this.last,e.next=this.first,this.first.prev=e,this.last.next=e,this.last=e),this.length++},x3dom.DoublyLinkedList.prototype.insertAfterNode=function(e,t){t.prev=e,t.next=e.next,e.next.prev=t,e.next=t,t.prev==this.last&&(this.last=t),this.length++},x3dom.DoublyLinkedList.prototype.deleteNode=function(e){this.length>1?(e.prev.next=e.next,e.next.prev=e.prev,e==this.first&&(this.first=e.next),e==this.last&&(this.last=e.prev)):(this.first=null,this.last=null),e.prev=null,e.next=null,this.length--},x3dom.DoublyLinkedList.prototype.getNode=function(e){var t=null;if(e>this.length)return t;for(var i=0;i<this.length;i++)if(t=0==i?this.first:t.next,i==e)return t;return null},x3dom.DoublyLinkedList.prototype.invert=function(){for(var e=null,t=this.first,i=0;i<this.length;i++)e=t.prev,t.prev=t.next,t.next=e,t=t.prev;e=this.first,this.first=this.last,this.last=e},x3dom.EarClipping={getIndexes:function(e){var t,i,o,s,r=e.first.next,n=this.identifyPlane(r.prev.point,r.point,r.next.point);for(i=[],point_indexes=[],t=0;t<e.length;t++){switch(r=e.getNode(t),n){case"XY":o=r.point.x,s=r.point.y;break;case"XZ":o=r.point.z,s=r.point.x;break;default:o=r.point.y,s=r.point.z}i.push(s),i.push(o),point_indexes.push(r.point_index)}var a=x3dom.EarCut.triangulate(i,null,2);return a=a.map(function(e){return point_indexes[e]})},getMultiIndexes:function(e){var t=e.first.next,o=this.identifyPlane(t.prev.point,t.point,t.next.point),s={};s.indices=[],s.point=[],s.normals=[],s.colors=[],s.texCoords=[];var r={};for(r.indices=[],r.point=[],r.normals=[],r.colors=[],r.texCoords=[],points=[],i=0;i<e.length;i++){switch(t=e.getNode(i),o){case"XY":x=t.point.x,y=t.point.y;break;case"XZ":x=t.point.z,y=t.point.x;break;default:x=t.point.y,y=t.point.z}points.push(y),points.push(x),r.indices.push(t.point_index),r.point.push(t.point),t.normals&&r.normals.push(t.normals),t.colors&&r.colors.push(t.colors),t.texCoords&&r.texCoords.push(t.texCoords)}var n=x3dom.EarCut.triangulate(points,null,2);return s.indices=n.map(function(e){return r.indices[e]}),s.point=n.map(function(e){return r.point[e]}),t.normals&&(s.normals=n.map(function(e){return r.normals[e]})),t.colors&&(s.colors=n.map(function(e){return r.colors[e]})),t.texCoords&&(s.texCoords=n.map(function(e){return r.texCoords[e]})),s},identifyPlane:function(e,t,i){var o,s,r,n,a,d,l,h,u;o=t.x-e.x,s=t.y-e.y,r=t.z-e.z,n=i.x-e.x,a=i.y-e.y,d=i.z-e.z,l=Math.abs(s*d-r*a),h=Math.abs(r*n-o*d),u=Math.abs(o*a-s*n);var f=Math.max(l,h,u);return f==l?"YZ":f==h?"XZ":f==u?"XY":"XZ"}},x3dom.EarCut={triangulate:function(e,t,o){function s(e,t,i){i=i||2;var o=t&&t.length,s=o?t[0]*i:e.length,a=r(e,0,s,i),l=n(e,0,s,i,!0,a),h=[];if(!l)return h;var u,f,c,m,p,x,g;if(o&&(l=_(e,t,l,i)),e.length>80*i){u=c=e[0],f=m=e[1];for(var v=i;s>v;v+=i)p=e[v],x=e[v+1],u>p&&(u=p),f>x&&(f=x),p>c&&(c=p),x>m&&(m=x);g=Math.max(c-u,m-f)}return d(l,h,i,u,f,g),a===!1&&h.reverse(),h}function r(e,t,o,s){var r=0;for(i=t,j=o-s;i<o;i+=s)r+=(e[j]-e[i])*(e[i+1]+e[j+1]),j=i;return r>0}function n(e,t,i,o,s,r){var n,a;if(s===r)for(n=t;i>n;n+=o)a=R(n,e[n],e[n+1],a);else for(n=i-o;n>=t;n-=o)a=R(n,e[n],e[n+1],a);return a}function a(e,t){if(!e)return e;t||(t=e);var i,o=e;do if(i=!1,o.steiner||!M(o,o.next)&&0!==S(o.prev,o,o.next))o=o.next;else{if(N(o),o=t=o.prev,o===o.next)return null;i=!0}while(i||o!==t);return t}function d(e,t,i,o,s,r,n){if(e){!n&&r&&x(e,o,s,r);for(var _,c,m=e;e.prev!==e.next;)if(_=e.prev,c=e.next,r?h(e,o,s,r):l(e))t.push(_.i/i),t.push(e.i/i),t.push(c.i/i),N(e),e=c.next,m=c.next;else if(e=c,e===m){n?1===n?(e=u(e,t,i),d(e,t,i,o,s,r,2)):2===n&&f(e,t,i,o,s,r):d(a(e),t,i,o,s,r,1);break}}}function l(e){var t=e.prev,i=e,o=e.next;if(S(t,i,o)>=0)return!1;for(var s=e.next.next;s!==e.prev;){if(b(t.x,t.y,i.x,i.y,o.x,o.y,s.x,s.y)&&S(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function h(e,t,i,o){var s=e.prev,r=e,n=e.next;if(S(s,r,n)>=0)return!1;for(var a=s.x<r.x?s.x<n.x?s.x:n.x:r.x<n.x?r.x:n.x,d=s.y<r.y?s.y<n.y?s.y:n.y:r.y<n.y?r.y:n.y,l=s.x>r.x?s.x>n.x?s.x:n.x:r.x>n.x?r.x:n.x,h=s.y>r.y?s.y>n.y?s.y:n.y:r.y>n.y?r.y:n.y,u=v(a,d,t,i,o),f=v(l,h,t,i,o),_=e.nextZ;_&&_.z<=f;){if(_!==e.prev&&_!==e.next&&b(s.x,s.y,r.x,r.y,n.x,n.y,_.x,_.y)&&S(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(_=e.prevZ;_&&_.z>=u;){if(_!==e.prev&&_!==e.next&&b(s.x,s.y,r.x,r.y,n.x,n.y,_.x,_.y)&&S(_.prev,_,_.next)>=0)return!1;_=_.prevZ}return!0}function u(e,t,i){var o=e;do{var s=o.prev,r=o.next.next;C(s,o,o.next,r)&&E(s,r)&&E(r,s)&&(t.push(s.i/i),t.push(o.i/i),t.push(r.i/i),N(o),N(o.next),o=e=r),o=o.next}while(o!==e);return o}function f(e,t,i,o,s,r){var n=e;do{for(var l=n.next.next;l!==n.prev;){if(n.i!==l.i&&T(n,l)){var h=A(n,l);return n=a(n,n.next),h=a(h,h.next),d(n,t,i,o,s,r),void d(h,t,i,o,s,r)}l=l.next}n=n.next}while(n!==e)}function _(e,t,i,o){var s,r,d,l,h,u=[];for(s=0,r=t.length;r>s;s++)d=t[s]*o,l=r-1>s?t[s+1]*o:e.length,h=n(e,d,l,o,!1),h===h.next&&(h.steiner=!0),u.push(y(h));for(u.sort(c),s=0;s<u.length;s++)m(u[s],i),i=a(i,i.next);return i}function c(e,t){return e.x-t.x}function m(e,t){if(t=p(e,t)){var i=A(t,e);a(i,i.next)}}function p(e,t){var i,o=t,s=e.x,r=e.y,n=-(1/0);do{if(r<=o.y&&r>=o.next.y){var a=o.x+(r-o.y)*(o.next.x-o.x)/(o.next.y-o.y);s>=a&&a>n&&(n=a,i=o.x<o.next.x?o:o.next)}o=o.next}while(o!==t);if(!i)return null;var d,l=i,h=1/0;for(o=i.next;o!==l;)s>=o.x&&o.x>=i.x&&b(r<i.y?s:n,r,i.x,i.y,r<i.y?n:s,r,o.x,o.y)&&(d=Math.abs(r-o.y)/(s-o.x),(h>d||d===h&&o.x>i.x)&&E(o,e)&&(i=o,h=d)),o=o.next;return i}function x(e,t,i,o){var s=e;do null===s.z&&(s.z=v(s.x,s.y,t,i,o)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next;while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,g(s)}function g(e){var t,i,o,s,r,n,a,d,l=1;do{for(i=e,e=null,r=null,n=0;i;){for(n++,o=i,a=0,t=0;l>t&&(a++,o=o.nextZ,o);t++);for(d=l;a>0||d>0&&o;)0===a?(s=o,o=o.nextZ,d--):0!==d&&o?i.z<=o.z?(s=i,i=i.nextZ,a--):(s=o,o=o.nextZ,d--):(s=i,i=i.nextZ,a--),r?r.nextZ=s:e=s,s.prevZ=r,r=s;i=o}r.nextZ=null,l*=2}while(n>1);return e}function v(e,t,i,o,s){return e=32767*(e-i)/s,t=32767*(t-o)/s,e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e|t<<1}function y(e){var t=e,i=e;do t.x<i.x&&(i=t),t=t.next;while(t!==e);return i}function b(e,t,i,o,s,r,n,a){return(s-n)*(t-a)-(e-n)*(r-a)>=0&&(e-n)*(o-a)-(i-n)*(t-a)>=0&&(i-n)*(r-a)-(s-n)*(o-a)>=0}function T(e,t){return M(e,t)||e.next.i!==t.i&&e.prev.i!==t.i&&!F(e,t)&&E(e,t)&&E(t,e)&&w(e,t)}function S(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function M(e,t){return e.x===t.x&&e.y===t.y}function C(e,t,i,o){return S(e,t,i)>0!=S(e,t,o)>0&&S(i,o,e)>0!=S(i,o,t)>0}function F(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&C(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}function E(e,t){return S(e.prev,e,e.next)<0?S(e,t,e.next)>=0&&S(e,e.prev,t)>=0:S(e,t,e.prev)<0||S(e,e.next,t)<0}function w(e,t){var i=e,o=!1,s=(e.x+t.x)/2,r=(e.y+t.y)/2;do i.y>r!=i.next.y>r&&s<(i.next.x-i.x)*(r-i.y)/(i.next.y-i.y)+i.x&&(o=!o),i=i.next;while(i!==e);return o}function A(e,t){var i=new I(e.i,e.x,e.y),o=new I(t.i,t.x,t.y),s=e.next,r=t.prev;return e.next=t,t.prev=e,i.next=s,s.prev=i,o.next=i,i.prev=o,r.next=o,o.prev=r,o}function R(e,t,i,o){var s=new I(e,t,i);return o?(s.next=o.next,s.prev=o,o.next.prev=s,o.next=s):(s.prev=s,s.next=s),s}function N(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function I(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}return s(e,t,o)}},x3dom.Utils={},x3dom.Utils.maxIndexableCoords=65535,x3dom.Utils.needLineWidth=!1,x3dom.Utils.measurements=[],window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}(),x3dom.Utils.startMeasure=function(e){var t=e.toUpperCase();x3dom.Utils.measurements[t]||(x3dom.Utils.measurements[t]=performance&&performance.now?performance.now():(new Date).getTime())},x3dom.Utils.stopMeasure=function(e){var t=e.toUpperCase();if(x3dom.Utils.measurements[t]){var i=x3dom.Utils.measurements[t];return delete x3dom.Utils.measurements[t],performance&&performance.now?performance.now()-i:(new Date).getTime()-i}return 0},x3dom.Utils.isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},x3dom.Utils.createTexture2D=function(e,t,i,o,s,r,n){var a=e.createTexture(),d=new Uint8Array([0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255]);if(e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,e.UNSIGNED_BYTE,d),n&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),a.ready=!1,null==i||""==i)return a;var l=new Image;switch(s.toLowerCase()){case"anonymous":l.crossOrigin="anonymous";break;case"use-credentials":l.crossOrigin="use-credentials";break;case"none":break;default:x3dom.Utils.forbiddenBySOP(i)&&(l.crossOrigin="anonymous")}return l.src=i,t.downloadCount++,l.onload=function(){r&&(l=x3dom.Utils.scaleImage(l)),1==o&&e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,l),n&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),1==o&&e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),a.width=l.width,a.height=l.height,a.ready=!0,t.downloadCount--,t.needRender=!0},l.onerror=function(){-1!==x3dom.caps.EXTENSIONS.indexOf("WEBGL_compressed_texture_s3tc")?x3dom.Utils.tryCompressedTexture2D(a,e,t,i,o,s,n,function(e){e||x3dom.debug.logError("[Utils|createTexture2D] Can't load Image: "+i),t.downloadCount--}):(x3dom.debug.logError("[Utils|createTexture2D] Can't load Image: "+i),t.downloadCount--)},a},x3dom.Utils.createCompressedTexture2D=function(e,t,i,o,s,r){var n=e.createTexture(),a=new Uint8Array([0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255]);if(e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,e.UNSIGNED_BYTE,a),r&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),n.ready=!1,null==i||""==i)return n;ddsXhr=new XMLHttpRequest;var d=e.getExtension("WEBGL_compressed_texture_s3tc");return ddsXhr.open("GET",i,!0),ddsXhr.responseType="arraybuffer",ddsXhr.onload=function(){e.bindTexture(e.TEXTURE_2D,n);var i=uploadDDSLevels(e,d,this.response);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,i>1?e.LINEAR_MIPMAP_LINEAR:e.LINEAR),n.ready=!0,t.downloadCount--,t.needRender=!0},t.downloadCount++,ddsXhr.send(null),n},x3dom.Utils.tryCompressedTexture2D=function(e,t,i,o,s,r,n,a){ddsXhr=new XMLHttpRequest;var d=t.getExtension("WEBGL_compressed_texture_s3tc");ddsXhr.open("GET",o,!0),ddsXhr.responseType="arraybuffer",ddsXhr.onload=function(){t.bindTexture(t.TEXTURE_2D,e);var o=uploadDDSLevels(t,d,this.response);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,o>1?t.LINEAR_MIPMAP_LINEAR:t.LINEAR),e.ready=!0,i.needRender=!0,a(!0)},ddsXhr.onerror=function(){a(!1)},ddsXhr.send(null)},x3dom.Utils.createTextureCube=function(e,t,i,o,s,r,n){var a,d=e.createTexture();a=o?[e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_X]:[e.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_X],
d.ready=!1,d.pendingTextureLoads=-1,d.textureCubeReady=!1;for(var l=0,h=0,u=0;u<a.length;u++){var f=a[u],_=new Image;switch(s.toLowerCase()){case"anonymous":_.crossOrigin="anonymous";break;case"use-credentials":_.crossOrigin="use-credentials";break;case"none":break;default:x3dom.Utils.forbiddenBySOP(i[u])&&(_.crossOrigin="anonymous")}d.pendingTextureLoads++,t.downloadCount++,_.onload=function(i,o,s,a){return function(){0==l&&0==h?(l=s.width,h=s.height):!r||l==s.width&&h==s.height||(x3dom.debug.logWarning("[Utils|createTextureCube] Rescaling CubeMap images, which are of different size!"),s=x3dom.Utils.rescaleImage(s,l,h)),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,a),e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.texImage2D(o,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s),e.bindTexture(e.TEXTURE_CUBE_MAP,null),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),i.pendingTextureLoads--,t.downloadCount--,i.pendingTextureLoads<0&&(i.width=l,i.height=h,i.textureCubeReady=!0,n&&(e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.generateMipmap(e.TEXTURE_CUBE_MAP),e.bindTexture(e.TEXTURE_CUBE_MAP,null)),x3dom.debug.logInfo("[Utils|createTextureCube] Loading CubeMap finished..."),t.needRender=!0)}}(d,f,_,o),_.onerror=function(){t.downloadCount--,x3dom.debug.logError("[Utils|createTextureCube] Can't load CubeMap!")},_.src=i[u]}return d},x3dom.Utils.initFBO=function(e,t,i,o,s,r,n){var a=e.createTexture();a.width=t,a.height=i,e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,o,null),s&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null);var d,l=null;if(x3dom.caps.DRAW_BUFFERS&&void 0!==n)for(l=[a],d=1;n>d;d++)l[d]=e.createTexture(),l[d].width=t,l[d].height=i,e.bindTexture(e.TEXTURE_2D,l[d]),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,o,null),s&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null);var h=e.createFramebuffer(),u=null,f=null;if(r&&(null!==x3dom.caps.DEPTH_TEXTURE?(u=e.createTexture(),e.bindTexture(e.TEXTURE_2D,u),e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT,t,i,0,e.DEPTH_COMPONENT,e.UNSIGNED_SHORT,null),s&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),u.width=t,u.height=i):(f=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,f),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,i),e.bindRenderbuffer(e.RENDERBUFFER,null))),e.bindFramebuffer(e.FRAMEBUFFER,h),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,a,0),x3dom.caps.DRAW_BUFFERS&&void 0!==n)for(d=1;n>d;d++)e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+d,e.TEXTURE_2D,l[d],0);r&&null!==x3dom.caps.DEPTH_TEXTURE?e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,u,0):e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,f);var _=e.checkFramebufferStatus(e.FRAMEBUFFER);return _!=e.FRAMEBUFFER_COMPLETE&&x3dom.debug.logWarning("[Utils|InitFBO] FBO-Status: "+_),e.bindFramebuffer(e.FRAMEBUFFER,null),{fbo:h,dtex:u,rbo:f,tex:a,texTargets:l,width:t,height:i,type:o,mipMap:s}},x3dom.Utils.getFileName=function(e){var t;return t=e.lastIndexOf("/")>-1?e.substr(e.lastIndexOf("/")+1):e.lastIndexOf("\\")>-1?e.substr(e.lastIndexOf("\\")+1):e},x3dom.Utils.findTextureByName=function(e,t){for(var i=0;i<e.length;++i)if(t==e[i].samplerName)return e[i];return!1},x3dom.Utils.rescaleImage=function(e,t,i){var o=document.createElement("canvas");return o.width=t,o.height=i,o.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,o.width,o.height),o},x3dom.Utils.scaleImage=function(e){if(!x3dom.Utils.isPowerOfTwo(e.width)||!x3dom.Utils.isPowerOfTwo(e.height)){var t=document.createElement("canvas");t.width=x3dom.Utils.nextHighestPowerOfTwo(e.width),t.height=x3dom.Utils.nextHighestPowerOfTwo(e.height);var i=t.getContext("2d");i.drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e},x3dom.Utils.isPowerOfTwo=function(e){return 0===(e&e-1)},x3dom.Utils.nextHighestPowerOfTwo=function(e){--e;for(var t=1;32>t;t<<=1)e|=e>>t;return e+1},x3dom.Utils.nextBestPowerOfTwo=function(e){var t=Math.log(e)/.693147180559945;return Math.pow(2,Math.round(t))},x3dom.Utils.getDataTypeSize=function(e){switch(e){case"Int8":case"Uint8":return 1;case"Int16":case"Uint16":return 2;case"Int32":case"Uint32":case"Float32":return 4;case"Float64":default:return 8}},x3dom.Utils.getOffsetMultiplier=function(e,t){switch(e){case t.UNSIGNED_SHORT:return 1;case t.UNSIGNED_INT:return 2;case t.UNSIGNED_BYTE:return.5;default:return 1}},x3dom.Utils.getByteAwareOffset=function(e,t,i){switch(t){case i.UNSIGNED_SHORT:return 2*e;case i.UNSIGNED_INT:return 4*e;case i.UNSIGNED_BYTE:return e;default:return 2*e}},x3dom.Utils.getVertexAttribType=function(e,t){var i=t.NONE;switch(e){case"Int8":i=t.BYTE;break;case"Uint8":i=t.UNSIGNED_BYTE;break;case"Int16":i=t.SHORT;break;case"Uint16":i=t.UNSIGNED_SHORT;break;case"Int32":i=t.INT;break;case"Uint32":i=t.UNSIGNED_INT;break;case"Float32":i=t.FLOAT;break;case"Float64":default:x3dom.debug.logError("Can't find this.gl data type for "+e+", getting FLOAT..."),i=t.FLOAT}return i},x3dom.Utils.getArrayBufferView=function(e,t){var i=null;switch(e){case"Int8":i=new Int8Array(t);break;case"Uint8":i=new Uint8Array(t);break;case"Int16":i=new Int16Array(t);break;case"Uint16":i=new Uint16Array(t);break;case"Int32":i=new Int32Array(t);break;case"Uint32":i=new Uint32Array(t);break;case"Float32":i=new Float32Array(t);break;case"Float64":i=new Float64Array(t);break;default:x3dom.debug.logError("Can't create typed array view of type "+e+", trying Float32..."),i=new Float32Array(t)}return i},x3dom.Utils.isUnsignedType=function(e){return"Uint8"==e||"Uint16"==e||"Uint16"==e||"Uint32"==e},x3dom.Utils.checkDirtyLighting=function(e){return e.getLights().length+e._scene.getNavigationInfo()._vf.headlight},x3dom.Utils.checkDirtyEnvironment=function(e,t){var i=e._scene.getEnvironment();return t.GAMMACORRECTION!=i._vf.gammaCorrectionDefault},x3dom.Utils.minFilterDic=function(e,t){switch(t.toUpperCase()){case"NEAREST":return e.NEAREST;case"LINEAR":return e.LINEAR;case"NEAREST_MIPMAP_NEAREST":return e.NEAREST_MIPMAP_NEAREST;case"NEAREST_MIPMAP_LINEAR":return e.NEAREST_MIPMAP_LINEAR;case"LINEAR_MIPMAP_NEAREST":return e.LINEAR_MIPMAP_NEAREST;case"LINEAR_MIPMAP_LINEAR":return e.LINEAR_MIPMAP_LINEAR;case"AVG_PIXEL":return e.LINEAR;case"AVG_PIXEL_AVG_MIPMAP":return e.LINEAR_MIPMAP_LINEAR;case"AVG_PIXEL_NEAREST_MIPMAP":return e.LINEAR_MIPMAP_NEAREST;case"DEFAULT":return e.LINEAR_MIPMAP_LINEAR;case"FASTEST":return e.NEAREST;case"NEAREST_PIXEL":return e.NEAREST;case"NEAREST_PIXEL_AVG_MIPMAP":return e.NEAREST_MIPMAP_LINEAR;case"NEAREST_PIXEL_NEAREST_MIPMAP":return e.NEAREST_MIPMAP_NEAREST;case"NICEST":return e.LINEAR_MIPMAP_LINEAR;default:return e.LINEAR}},x3dom.Utils.magFilterDic=function(e,t){switch(t.toUpperCase()){case"NEAREST":return e.NEAREST;case"LINEAR":return e.LINEAR;case"AVG_PIXEL":return e.LINEAR;case"DEFAULT":return e.LINEAR;case"FASTEST":return e.NEAREST;case"NEAREST_PIXEL":return e.NEAREST;case"NICEST":return e.LINEAR;default:return e.LINEAR}},x3dom.Utils.boundaryModesDic=function(e,t){switch(t.toUpperCase()){case"CLAMP":return e.CLAMP_TO_EDGE;case"CLAMP_TO_EDGE":return e.CLAMP_TO_EDGE;case"CLAMP_TO_BOUNDARY":return e.CLAMP_TO_EDGE;case"MIRRORED_REPEAT":return e.MIRRORED_REPEAT;case"REPEAT":return e.REPEAT;default:return e.REPEAT}},x3dom.Utils.primTypeDic=function(e,t){switch(t.toUpperCase()){case"POINTS":return e.POINTS;case"LINES":return e.LINES;case"LINELOOP":return e.LINE_LOOP;case"LINESTRIP":return e.LINE_STRIP;case"TRIANGLES":return e.TRIANGLES;case"TRIANGLESTRIP":return e.TRIANGLE_STRIP;case"TRIANGLEFAN":return e.TRIANGLE_FAN;default:return e.TRIANGLES}},x3dom.Utils.depthFunc=function(e,t){switch(t.toUpperCase()){case"NEVER":return e.NEVER;case"ALWAYS":return e.ALWAYS;case"LESS":return e.LESS;case"EQUAL":return e.EQUAL;case"LEQUAL":return e.LEQUAL;case"GREATER":return e.GREATER;case"GEQUAL":return e.GEQUAL;case"NOTEQUAL":return e.NOTEQUAL;default:return e.LEQUAL}},x3dom.Utils.blendFunc=function(e,t){switch(t.toLowerCase()){case"zero":return e.ZERO;case"one":return e.ONE;case"dst_color":return e.DST_COLOR;case"dst_alpha":return e.DST_ALPHA;case"src_color":return e.SRC_COLOR;case"src_alpha":return e.SRC_ALPHA;case"one_minus_dst_color":return e.ONE_MINUS_DST_COLOR;case"one_minus_dst_alpha":return e.ONE_MINUS_DST_ALPHA;case"one_minus_src_color":return e.ONE_MINUS_SRC_COLOR;case"one_minus_src_alpha":return e.ONE_MINUS_SRC_ALPHA;case"src_alpha_saturate":return e.SRC_ALPHA_SATURATE;case"constant_color":return e.CONSTANT_COLOR;case"constant_alpha":return e.CONSTANT_ALPHA;case"one_minus_constant_color":return e.ONE_MINUS_CONSTANT_COLOR;case"one_minus_constant_alpha":return e.ONE_MINUS_CONSTANT_ALPHA;default:return 0}},x3dom.Utils.blendEquation=function(e,t){switch(t.toLowerCase()){case"func_add":return e.FUNC_ADD;case"func_subtract":return e.FUNC_SUBTRACT;case"func_reverse_subtract":return e.FUNC_REVERSE_SUBTRACT;case"min":return 0;case"max":return 0;case"logic_op":return 0;default:return 0}},x3dom.Utils.gunzip=function(e){var t=new Uint8Array(e);try{e=new Zlib.Gunzip(t).decompress().buffer}catch(i){}return e},x3dom.Utils.generateProperties=function(e,t){var i={},o=t._cf.geometry.node,s=t._cf.appearance.node,r=s?s._cf.texture.node:null,n=s?s._cf.material.node:null,a=e._scene.getEnvironment();if(s&&s._shader&&x3dom.isa(s._shader,x3dom.nodeTypes.ComposedShader))i.CSHADER=s._shader._id;else if(o){i.CSHADER=-1,i.SOLID=t.isSolid()?1:0,i.TEXT=x3dom.isa(o,x3dom.nodeTypes.Text)?1:0,i.POPGEOMETRY=x3dom.isa(o,x3dom.nodeTypes.PopGeometry)?1:0,i.IMAGEGEOMETRY=x3dom.isa(o,x3dom.nodeTypes.ImageGeometry)?1:0,i.BINARYGEOMETRY=x3dom.isa(o,x3dom.nodeTypes.BinaryGeometry)?1:0,i.EXTERNALGEOMETRY=x3dom.isa(o,x3dom.nodeTypes.ExternalGeometry)?1:0,i.IG_PRECISION=i.IMAGEGEOMETRY?o.numCoordinateTextures():0,i.IG_INDEXED=i.IMAGEGEOMETRY&&null!=o.getIndexTexture()?1:0,i.POINTLINE2D=o.needLighting()?0:1,i.VERTEXID=(i.BINARYGEOMETRY||i.EXTERNALGEOMETRY)&&o._vf.idsPerVertex?1:0,i.IS_PARTICLE=x3dom.isa(o,x3dom.nodeTypes.ParticleSet)?1:0,i.TWOSIDEDMAT=i.APPMAT&&x3dom.isa(n,x3dom.nodeTypes.TwoSidedMaterial)?1:0,i.SEPARATEBACKMAT=i.TWOSIDEDMAT&&n._vf.separateBackColor?1:0,i.SHADOW=e.getLightsShadow()?1:0,i.FOG=e._scene.getFog()._vf.visibilityRange>0?1:0,i.CSSHADER=s&&s._shader&&x3dom.isa(s._shader,x3dom.nodeTypes.CommonSurfaceShader)?1:0,i.APPMAT=s&&(n||i.CSSHADER)?1:0,i.LIGHTS=!i.POINTLINE2D&&s&&t.isLit()&&(n||i.CSSHADER)?e.getLights().length+e._scene.getNavigationInfo()._vf.headlight:0,i.TEXTURED=r||i.TEXT||i.CSSHADER&&s._shader.needTexcoords()?1:0,i.CUBEMAP=r&&x3dom.isa(r,x3dom.nodeTypes.X3DEnvironmentTextureNode)||i.CSSHADER&&s._shader.getEnvironmentMap()?1:0,i.PIXELTEX=r&&x3dom.isa(r,x3dom.nodeTypes.PixelTexture)?1:0,i.TEXTRAFO=s&&s._cf.textureTransform.node?1:0,i.DIFFUSEMAP=r&&!x3dom.isa(r,x3dom.nodeTypes.X3DEnvironmentTextureNode)||i.CSSHADER&&s._shader.getDiffuseMap()?1:0,i.NORMALMAP=i.CSSHADER&&s._shader.getNormalMap()?1:0,i.NORMALSPACE=i.NORMALMAP?s._shader._vf.normalSpace.toUpperCase():"",i.SPECMAP=i.CSSHADER&&s._shader.getSpecularMap()?1:0,i.SHINMAP=i.CSSHADER&&s._shader.getShininessMap()?1:0,i.DISPLACEMENTMAP=i.CSSHADER&&s._shader.getDisplacementMap()?1:0,i.DIFFPLACEMENTMAP=i.CSSHADER&&s._shader.getDiffuseDisplacementMap()?1:0,i.MULTIDIFFALPMAP=i.VERTEXID&&i.CSSHADER&&s._shader.getMultiDiffuseAlphaMap()?1:0,i.MULTIEMIAMBMAP=i.VERTEXID&&i.CSSHADER&&s._shader.getMultiEmissiveAmbientMap()?1:0,i.MULTISPECSHINMAP=i.VERTEXID&&i.CSSHADER&&s._shader.getMultiSpecularShininessMap()?1:0,i.MULTIVISMAP=i.VERTEXID&&i.CSSHADER&&s._shader.getMultiVisibilityMap()?1:0,i.BLENDING=i.TEXT||i.CUBEMAP||r&&r._blending?1:0,i.REQUIREBBOX=void 0!==o._vf.coordType&&"Float32"!=o._vf.coordType?1:0,i.REQUIREBBOXNOR=void 0!==o._vf.normalType&&"Float32"!=o._vf.normalType?1:0,i.REQUIREBBOXCOL=void 0!==o._vf.colorType&&"Float32"!=o._vf.colorType?1:0,i.REQUIREBBOXTEX=void 0!==o._vf.texCoordType&&"Float32"!=o._vf.texCoordType?1:0,i.COLCOMPONENTS=o._mesh._numColComponents,i.NORCOMPONENTS=o._mesh._numNormComponents,i.POSCOMPONENTS=o._mesh._numPosComponents,i.SPHEREMAPPING=void 0!==o._cf.texCoord&&null!==o._cf.texCoord.node&&o._cf.texCoord.node._vf.mode&&"sphere"==o._cf.texCoord.node._vf.mode.toLowerCase()?1:0,i.VERTEXCOLOR=o._mesh._colors[0].length>0||i.IMAGEGEOMETRY&&o.getColorTexture()||i.POPGEOMETRY&&o.hasColor()||void 0!==o._vf.color&&o._vf.color.length>0?1:0,i.CLIPPLANES=t._clipPlanes.length,i.ALPHATHRESHOLD=s?s._vf.alphaClipThreshold.toFixed(2):.1,i.GAMMACORRECTION=a._vf.gammaCorrectionDefault,i.CUSTOM_ATTR=[];for(var d=0,l=o._cf.attrib.nodes.length;l>d;d++)i.CUSTOM_ATTR.push({name:o._cf.attrib.nodes[d]._vf.name,numComponents:o._cf.attrib.nodes[d]._vf.numComponents});i.CUSTOM_ATTRIBUTES={vertexShaderPartInit:"",vertexShaderPartMain:"",fragmentShaderPartInit:"",fragmentShaderPartMain:""};var h,u,f;for(d=0,l=o._cf.customAttributes.nodes.length;l>d;d++){var _=o._cf.customAttributes.nodes[d];for(h=0;h<_._cf.uniforms.nodes.length;h++)u=_._cf.uniforms.nodes[h]._vf,i.CUSTOM_ATTRIBUTES.vertexShaderPartInit+="uniform "+u.type+" "+u.name+"; ",i.CUSTOM_ATTRIBUTES.fragmentShaderPartInit+="uniform "+u.type+" "+u.name+"; ";for(h=0;h<_._cf.varyings.nodes.length;h++)f=_._cf.varyings.nodes[h]._vf,i.CUSTOM_ATTRIBUTES.vertexShaderPartInit+="varying "+f.type+" "+f.name+"; ",i.CUSTOM_ATTRIBUTES.fragmentShaderPartInit+="varying "+f.type+" "+f.name+";";i.CUSTOM_ATTRIBUTES.vertexShaderPartMain+=_._vf.vertexShaderPartMain,i.CUSTOM_ATTRIBUTES.fragmentShaderPartMain+=_._vf.fragmentShaderPartMain}}return i.toIdentifier=function(){var e="";for(var t in this)this[t]!=this.toIdentifier&&this[t]!=this.toString&&(e+=this[t]);return this.id=e,e},i.toString=function(){var e="";for(var t in this)this[t]!=this.toIdentifier&&this[t]!=this.toString&&(e+=t+": "+this[t]+", ");return e},i.toIdentifier(),i},x3dom.Utils.wrapProgram=function(e,t,i){var o={shaderID:i,program:t};o.bind=function(){e.useProgram(t)};var s,r,n=null,a=null,d=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(s=0;d>s;++s){try{a=e.getActiveUniform(t,s)}catch(l){if(!a)continue}switch(r=e.getError(),r&&x3dom.debug.logError("GL-Error (on searching uniforms): "+r),n=e.getUniformLocation(t,a.name),a.type){case e.SAMPLER_2D:o.__defineSetter__(a.name,function(t){return function(i){e.uniform1i(t,i)}}(n));break;case e.SAMPLER_CUBE:o.__defineSetter__(a.name,function(t){return function(i){e.uniform1i(t,i)}}(n));break;case e.BOOL:o.__defineSetter__(a.name,function(t){return function(i){e.uniform1i(t,i)}}(n));break;case e.FLOAT:-1!=a.name.indexOf("[0]")?o.__defineSetter__(a.name.substring(0,a.name.length-3),function(t){return function(i){e.uniform1fv(t,new Float32Array(i))}}(n)):o.__defineSetter__(a.name,function(t){return function(i){e.uniform1f(t,i)}}(n));break;case e.FLOAT_VEC2:o.__defineSetter__(a.name,function(t){return function(i){e.uniform2f(t,i[0],i[1])}}(n));break;case e.FLOAT_VEC3:-1!=a.name.indexOf("[0]")?o.__defineSetter__(a.name.substring(0,a.name.length-3),function(t){return function(i){e.uniform3fv(t,new Float32Array(i))}}(n)):o.__defineSetter__(a.name,function(t){return function(i){e.uniform3f(t,i[0],i[1],i[2])}}(n));break;case e.FLOAT_VEC4:o.__defineSetter__(a.name,function(t){return function(i){e.uniform4f(t,i[0],i[1],i[2],i[3])}}(n));break;case e.FLOAT_MAT2:o.__defineSetter__(a.name,function(t){return function(i){e.uniformMatrix2fv(t,!1,new Float32Array(i))}}(n));break;case e.FLOAT_MAT3:o.__defineSetter__(a.name,function(t){return function(i){e.uniformMatrix3fv(t,!1,new Float32Array(i))}}(n));break;case e.FLOAT_MAT4:o.__defineSetter__(a.name,function(t){return function(i){e.uniformMatrix4fv(t,!1,new Float32Array(i))}}(n));break;case e.INT:o.__defineSetter__(a.name,function(t){return function(i){e.uniform1i(t,i)}}(n));break;default:x3dom.debug.logWarning("GLSL program variable "+a.name+" has unknown type "+a.type)}}var h=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(s=0;h>s;++s){try{a=e.getActiveAttrib(t,s)}catch(u){if(!a)continue}r=e.getError(),r&&x3dom.debug.logError("GL-Error (on searching attributes): "+r),n=e.getAttribLocation(t,a.name),o[a.name]=n}return o},x3dom.Utils.forbiddenBySOP=function(e){e=e.toLowerCase();var t,i,o,s,r,n,a,d,l=e.split("//"),h=""===document.location.port?"80":document.location.port;return 2===l.length&&(t=l[0],i=l[1],o=i.split("/")[0].split("?")[0].split("#")[0],s=o.split("@"),r=1===s.length?s[0]:s[1],n=r.split(":"),d=n[0],a=n[1]),a=a||"80",d=d||document.location.host,t=t||document.location.protocol,!(a===h&&d===document.location.host&&t===document.location.protocol)},x3dom.States=function(e){var t=this;this.active=!1,this.viewer=document.createElement("div"),this.viewer.id="x3dom-state-viewer";var i=document.createElement("div");i.className="x3dom-states-head",i.appendChild(document.createTextNode("x3dom"));var o=document.createElement("span");o.className="x3dom-states-head2",o.appendChild(document.createTextNode("stats")),i.appendChild(o),this.renderMode=document.createElement("div"),this.renderMode.className="x3dom-states-rendermode-hardware",this.measureList=document.createElement("ul"),this.measureList.className="x3dom-states-list",this.infoList=document.createElement("ul"),this.infoList.className="x3dom-states-list",this.viewer.appendChild(this.renderMode),this.viewer.appendChild(this.measureList),this.viewer.appendChild(this.infoList),this.disableContextMenu=function(e){return e.preventDefault(),e.stopPropagation(),e.returnValue=!1,!1},this.thousandSeperator=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},this.toFixed=function(e){var t=2;return e.toFixed(t)},this.update=function(){if(!e.runtime&&void 0!==this.updateMethodID)return void clearInterval(this.updateMethodID);var t=e.runtime.states.infos,i=e.runtime.states.measurements,o=x3dom.caps.RENDERMODE;"HARDWARE"==o?(this.renderMode.innerHTML="Hardware-Rendering",this.renderMode.className="x3dom-states-rendermode-hardware"):"SOFTWARE"==o&&(this.renderMode.innerHTML="Software-Rendering",this.renderMode.className="x3dom-states-rendermode-software"),this.measureList.innerHTML="";for(var s in i)n=document.createElement("li"),n.className="x3dom-states-item",a=document.createElement("div"),a.className="x3dom-states-item-title",a.appendChild(document.createTextNode(s)),d=document.createElement("div"),d.className="x3dom-states-item-value",d.appendChild(document.createTextNode(this.toFixed(i[s]))),n.appendChild(a),n.appendChild(d),this.measureList.appendChild(n);this.infoList.innerHTML="";for(var r in t){var n=document.createElement("li");n.className="x3dom-states-item";var a=document.createElement("div");a.className="x3dom-states-item-title",a.appendChild(document.createTextNode(r));var d=document.createElement("div");d.className="x3dom-states-item-value",d.appendChild(document.createTextNode(this.thousandSeperator(t[r]))),n.appendChild(a),n.appendChild(d),this.infoList.appendChild(n)}},this.updateMethodID=window.setInterval(function(){t.update()},1e3),this.viewer.addEventListener("contextmenu",t.disableContextMenu)},x3dom.States.prototype.display=function(e){this.active=void 0!==e?e:!this.active,this.viewer.style.display=this.active?"block":"none"},x3dom.StateManager=function(e){this.gl=e,this.states=[],this.initStates()},x3dom.StateManager.prototype.initStates=function(){this.states.shaderID=null,this.states.colorMask={red:null,green:null,blue:null,alpha:null},this.states.depthMask=null,this.states.stencilMask=null,this.states.cullFace=null,this.states.frontFace=null,this.states.lineWidth=null,this.states.blendColor={red:null,green:null,blue:null,alpha:null},this.states.blendEquation=null,this.states.blendEquationSeparate={modeRGB:null,modeAlpha:null},this.states.blendFunc={sfactor:null,dfactor:null},this.states.blendFuncSeparate={srcRGB:null,dstRGB:null,srcAlpha:null,dstAlpha:null},this.states.depthFunc=null,this.states.viewport={x:null,y:null,width:null,height:null},this.states.depthRange={zNear:null,zFar:null}},x3dom.StateManager.prototype.useProgram=function(e){return this.states.shaderID!=e.shaderID?(this.gl.useProgram(e.program),this.states.shaderID=e.shaderID,!0):!1},x3dom.StateManager.prototype.unsetProgram=function(){this.states.shaderID=null},x3dom.StateManager.prototype.enable=function(e){this.states[e]!==!0&&(this.gl.enable(e),this.states[e]=!0)},x3dom.StateManager.prototype.disable=function(e){this.states[e]!==!1&&(this.gl.disable(e),this.states[e]=!1)},x3dom.StateManager.prototype.colorMask=function(e,t,i,o){(this.states.colorMask.red!=e||this.states.colorMask.green!=t||this.states.colorMask.blue!=i||this.states.colorMask.alpha!=o)&&(this.gl.colorMask(e,t,i,o),this.states.colorMask.red=e,this.states.colorMask.green=t,this.states.colorMask.blue=i,this.states.colorMask.alpha=o)},x3dom.StateManager.prototype.depthMask=function(e){this.states.depthMask!=e&&(this.gl.depthMask(e),this.states.depthMask=e)},x3dom.StateManager.prototype.stencilMask=function(e){this.states.stencilMask!=e&&(this.gl.stencilMask(e),this.states.stencilMask=e)},x3dom.StateManager.prototype.cullFace=function(e){this.states.cullFace!=e&&(this.gl.cullFace(e),this.states.cullFace=e)},x3dom.StateManager.prototype.frontFace=function(e){this.states.frontFace!=e&&(this.gl.frontFace(e),this.states.frontFace=e)},x3dom.StateManager.prototype.lineWidth=function(e){e=1>=e?1:e,this.states.lineWidth!=e&&(this.gl.lineWidth(e),this.states.lineWidth=e)},x3dom.StateManager.prototype.blendColor=function(e,t,i,o){(this.states.blendColor.red!=e||this.states.blendColor.green!=t||this.states.blendColor.blue!=i||this.states.blendColor.alpha!=o)&&(this.gl.blendColor(e,t,i,o),this.states.blendColor.red=e,this.states.blendColor.green=t,this.states.blendColor.blue=i,this.states.blendColor.alpha=o)},x3dom.StateManager.prototype.blendEquation=function(e){e&&this.states.blendEquation!=e&&(this.gl.blendEquation(e),this.states.blendEquation=e)},x3dom.StateManager.prototype.blendEquationSeparate=function(e,t){(this.states.blendEquationSeparate.modeRGB!=e||this.states.blendEquationSeparate.modeAlpha!=t)&&(this.gl.blendEquationSeparate(e,t),this.states.blendEquationSeparate.modeRGB=e,this.states.blendEquationSeparate.modeAlpha=t)},x3dom.StateManager.prototype.blendFunc=function(e,t){(this.states.blendFunc.sfactor!=e||this.states.blendFunc.dfactor!=t)&&(this.gl.blendFunc(e,t),this.states.blendFunc.sfactor=e,this.states.blendFunc.dfactor=t)},x3dom.StateManager.prototype.blendFuncSeparate=function(e,t,i,o){(this.states.blendFuncSeparate.srcRGB!=e||this.states.blendFuncSeparate.dstRGB!=t||this.states.blendFuncSeparate.srcAlpha!=i||this.states.blendFuncSeparate.dstAlpha!=o)&&(this.gl.blendFuncSeparate(e,t,i,o),this.states.blendFuncSeparate.srcRGB=e,this.states.blendFuncSeparate.dstRGB=t,this.states.blendFuncSeparate.srcAlpha=i,this.states.blendFuncSeparate.dstAlpha=o)},x3dom.StateManager.prototype.depthFunc=function(e){this.states.depthFunc!=e&&(this.gl.depthFunc(e),this.states.depthFunc=e)},x3dom.StateManager.prototype.depthRange=function(e,t){0>e||0>t||e>t||(e=e>1?1:e,t=t>1?1:t,(this.states.depthRange.zNear!=e||this.states.depthRange.zFar!=t)&&(this.gl.depthRange(e,t),this.states.depthRange.zNear=e,this.states.depthRange.zFar=t))},x3dom.StateManager.prototype.viewport=function(e,t,i,o){(this.states.viewport.x!=e||this.states.viewport.y!=t||this.states.viewport.width!=i||this.states.viewport.height!=o)&&(this.gl.viewport(e,t,i,o),this.states.viewport.x=e,this.states.viewport.y=t,this.states.viewport.width=i,this.states.viewport.height=o)},x3dom.StateManager.prototype.bindFramebuffer=function(e,t){this.gl.bindFramebuffer(e,t),this.initStates()},x3dom.BinaryContainerLoader={outOfMemory:!1,checkError:function(e){var t=e.getError();t&&(t==e.OUT_OF_MEMORY?(this.outOfMemory=!0,x3dom.debug.logError("GL-Error "+t+" on loading binary container (out of memory)."),console.error("WebGL: OUT_OF_MEMORY")):x3dom.debug.logError("GL-Error "+t+" on loading binary container."))}},x3dom.BinaryContainerLoader.setupBinGeo=function(e,t,i,o,s){if(!this.outOfMemory){var r=(new Date).getTime(),n=this,a=e._cf.geometry.node;e._webgl.binaryGeometry=-1,e._webgl.internalDownloadCount=(a._vf.index.length>0?1:0)+(a._hasStrideOffset&&a._vf.coord.length>0?1:0)+(!a._hasStrideOffset&&a._vf.coord.length>0?1:0)+(!a._hasStrideOffset&&a._vf.normal.length>0?1:0)+(!a._hasStrideOffset&&a._vf.texCoord.length>0?1:0)+(!a._hasStrideOffset&&a._vf.color.length>0?1:0);var d=0==a._vf.normalPerVertex||a._vf.index.length>0&&("Int32"==a._vf.indexType||"Uint32"==a._vf.indexType&&!x3dom.caps.INDEX_UINT);if(e._webgl.makeSeparateTris={index:null,coord:null,normal:null,texCoord:null,color:null,pushBuffer:function(t,i){this[t]=i,0==--e._webgl.internalDownloadCount&&(this.coord&&this.createMesh(),e._nameSpace.doc.needRender=!0),0==--e._nameSpace.doc.downloadCount&&(e._nameSpace.doc.needRender=!0)},createMesh:function(){var r=a;if(r._hasStrideOffset)return void x3dom.debug.logError(r._vf.indexType+" index type and per-face normals not supported for interleaved arrays.");for(var d=0;d<e._webgl.primType.length;d++)if(e._webgl.primType[d]==i.TRIANGLE_STRIP)return void x3dom.debug.logError("makeSeparateTris: triangle strips not yet supported for per-face normals.");var l=r._vf.coordType;e._webgl.coordType=x3dom.Utils.getVertexAttribType(l,i);var h,u,f;e._webgl.coordType!=i.FLOAT?(h=x3dom.fields.SFVec3f.copy(4==r._mesh._numPosComponents&&x3dom.Utils.isUnsignedType(r._vf.coordType)?r.getMin():r._vf.position),u=x3dom.fields.SFVec3f.copy(r._vf.size),f=r.getPrecisionMax("coordType")):(h=new x3dom.fields.SFVec3f(0,0,0),u=new x3dom.fields.SFVec3f(1,1,1),f=1);var _=e._coordStrideOffset[0]/x3dom.Utils.getDataTypeSize(r._vf.coordType);_=0==_?3:_,x3dom.debug.logWarning("makeSeparateTris.createMesh called with coord length "+_),this.color&&_!=e._colorStrideOffset[0]/x3dom.Utils.getDataTypeSize(r._vf.colorType)&&(this.color=null,x3dom.debug.logWarning("Color format not supported."));var c=this.texCoord?e._texCoordStrideOffset[0]/x3dom.Utils.getDataTypeSize(r._vf.texCoordType):0;r._vf.normalType="Float32",e._webgl.normalType=i.FLOAT,r._mesh._numNormComponents=3,e._normalStrideOffset=[0,0];var m,p,x,g=[],v=[],y=[],b=[],T=this.index?this.index.length-2:this.coord.length/3-2;for(m=0;T>m;m+=3){p=_*(this.index?this.index[m]:m);var S=new x3dom.fields.SFVec3f(u.x*this.coord[p]/f,u.y*this.coord[p+1]/f,u.z*this.coord[p+2]/f);g.push(this.coord[p]),g.push(this.coord[p+1]),g.push(this.coord[p+2]),_>3&&g.push(this.coord[p+3]),this.color&&(b.push(this.color[p]),b.push(this.color[p+1]),b.push(this.color[p+2]),_>3&&b.push(this.color[p+3])),this.texCoord&&(x=c*(this.index?this.index[m]:m),y.push(this.texCoord[x]),y.push(this.texCoord[x+1]),c>3&&(y.push(this.texCoord[x+2]),y.push(this.texCoord[x+3]))),p=_*(this.index?this.index[m+1]:m+1);var M=new x3dom.fields.SFVec3f(u.x*this.coord[p]/f,u.y*this.coord[p+1]/f,u.z*this.coord[p+2]/f);g.push(this.coord[p]),g.push(this.coord[p+1]),g.push(this.coord[p+2]),_>3&&g.push(this.coord[p+3]),this.color&&(b.push(this.color[p]),b.push(this.color[p+1]),b.push(this.color[p+2]),_>3&&b.push(this.color[p+3])),this.texCoord&&(x=c*(this.index?this.index[m+1]:m+1),y.push(this.texCoord[x]),y.push(this.texCoord[x+1]),c>3&&(y.push(this.texCoord[x+2]),y.push(this.texCoord[x+3]))),p=_*(this.index?this.index[m+2]:m+2);var C=new x3dom.fields.SFVec3f(u.x*this.coord[p]/f,u.y*this.coord[p+1]/f,u.z*this.coord[p+2]/f);g.push(this.coord[p]),g.push(this.coord[p+1]),g.push(this.coord[p+2]),_>3&&g.push(this.coord[p+3]),this.color&&(b.push(this.color[p]),b.push(this.color[p+1]),b.push(this.color[p+2]),_>3&&b.push(this.color[p+3])),this.texCoord&&(x=c*(this.index?this.index[m+2]:m+2),y.push(this.texCoord[x]),y.push(this.texCoord[x+1]),c>3&&(y.push(this.texCoord[x+2]),y.push(this.texCoord[x+3])));var F=S.subtract(M),E=M.subtract(C),w=F.cross(E).normalize();for(p=0;3>p;p++)v.push(w.x),v.push(w.y),v.push(w.z)}var A=i.createBuffer();e._webgl.buffers[1]=A,i.bindBuffer(i.ARRAY_BUFFER,A),i.bufferData(i.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(r._vf.coordType,g),i.STATIC_DRAW),i.vertexAttribPointer(t.position,r._mesh._numPosComponents,e._webgl.coordType,!1,e._coordStrideOffset[0],e._coordStrideOffset[1]),i.enableVertexAttribArray(t.position),A=i.createBuffer(),e._webgl.buffers[2]=A,i.bindBuffer(i.ARRAY_BUFFER,A),i.bufferData(i.ARRAY_BUFFER,new Float32Array(v),i.STATIC_DRAW),i.vertexAttribPointer(t.normal,r._mesh._numNormComponents,e._webgl.normalType,!1,e._normalStrideOffset[0],e._normalStrideOffset[1]),i.enableVertexAttribArray(t.normal),this.texCoord&&(A=i.createBuffer(),e._webgl.buffers[3]=A,i.bindBuffer(i.ARRAY_BUFFER,A),i.bufferData(i.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(r._vf.texCoordType,y),i.STATIC_DRAW),i.vertexAttribPointer(t.texcoord,r._mesh._numTexComponents,e._webgl.texCoordType,!1,e._texCoordStrideOffset[0],e._texCoordStrideOffset[1]),i.enableVertexAttribArray(t.texcoord)),this.color&&(A=i.createBuffer(),e._webgl.buffers[4]=A,i.bindBuffer(i.ARRAY_BUFFER,A),i.bufferData(i.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(r._vf.colorType,b),i.STATIC_DRAW),i.vertexAttribPointer(t.color,r._mesh._numColComponents,e._webgl.colorType,!1,e._colorStrideOffset[0],e._colorStrideOffset[1]),i.enableVertexAttribArray(t.color)),r._vf.vertexCount=[],r._vf.vertexCount[0]=g.length/_,r._mesh._numCoords=r._vf.vertexCount[0],r._mesh._numFaces=r._vf.vertexCount[0]/3,e._webgl.primType=[],e._webgl.primType[0]=i.TRIANGLES,g=null,v=null,y=null,b=null,this.index=null,this.coord=null,this.normal=null,this.texCoord=null,this.color=null,n.checkError(i),delete e._webgl.shader,e._webgl.shader=s.cache.getDynamicShader(i,o,e)}},a._vf.index.length>0){e._webgl.binaryGeometry=1;var l=new XMLHttpRequest;l.open("GET",e._nameSpace.getURL(a._vf.index),!0),l.responseType="arraybuffer",e._nameSpace.doc.downloadCount+=1,l.send(null),l.onload=function(){if(200!=l.status)return e._nameSpace.doc.downloadCount-=1,void x3dom.debug.logError("XHR1/ index load failed with status: "+l.status);if(e._webgl){var t=1==a._vf.compressed?x3dom.Utils.gunzip(l.response):l.response,o=a,s=o._vf.indexType,h=x3dom.Utils.getArrayBufferView(s,t);if(d)return void e._webgl.makeSeparateTris.pushBuffer("index",h);var u=i.createBuffer();e._webgl.indexType=x3dom.caps.INDEX_UINT&&"Uint32"==s?i.UNSIGNED_INT:i.UNSIGNED_SHORT,i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,u),i.bufferData(i.ELEMENT_ARRAY_BUFFER,h,i.STATIC_DRAW),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),0==o._vf.vertexCount[0]&&(o._vf.vertexCount[0]=h.length),o._mesh._numFaces=0;for(var f=0;f<o._vf.vertexCount.length;f++)o._mesh._numFaces+=e._webgl.primType[f]==i.TRIANGLE_STRIP?o._vf.vertexCount[f]-2:o._vf.vertexCount[f]/3;h=null,e._nameSpace.doc.downloadCount-=1,e._webgl.internalDownloadCount-=1,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),n.checkError(i);var _=(new Date).getTime()-r;x3dom.debug.logInfo("XHR0/ index load time: "+_+" ms"),e._webgl.buffers[0]=u}}}if(a._hasStrideOffset&&a._vf.coord.length>0){var h=new XMLHttpRequest;h.open("GET",e._nameSpace.getURL(a._vf.coord),!0),h.responseType="arraybuffer",e._nameSpace.doc.downloadCount+=1,h.send(null),h.onload=function(){if(200!=h.status)return e._nameSpace.doc.downloadCount-=1,void x3dom.debug.logError("XHR1/ interleaved array load failed with status: "+h.status);if(e._webgl){var o=1==a._vf.compressed?x3dom.Utils.gunzip(h.response):h.response,s=a,d=s._vf.coordType;e._webgl.coordType=x3dom.Utils.getVertexAttribType(d,i),e._webgl.normalType=e._webgl.coordType,e._webgl.texCoordType=e._webgl.coordType,e._webgl.colorType=e._webgl.coordType;var l=x3dom.Utils.getArrayBufferView(d,o),u=e._coordStrideOffset[0]/x3dom.Utils.getDataTypeSize(d);if(u&&(s._mesh._numCoords=l.length/u),0==s._vf.index.length)for(var f=0;f<s._vf.vertexCount.length;f++)s._mesh._numFaces+=e._webgl.primType[f]==i.TRIANGLE_STRIP?s._vf.vertexCount[f]-2:s._vf.vertexCount[f]/3;var _=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,_),i.bufferData(i.ARRAY_BUFFER,l,i.STATIC_DRAW),i.vertexAttribPointer(t.position,s._mesh._numPosComponents,e._webgl.coordType,!1,e._coordStrideOffset[0],e._coordStrideOffset[1]),i.enableVertexAttribArray(t.position),
s._vf.normal.length>0&&(e._webgl.buffers[2]=_,i.bindBuffer(i.ARRAY_BUFFER,_),i.bufferData(i.ARRAY_BUFFER,l,i.STATIC_DRAW),i.vertexAttribPointer(t.normal,s._mesh._numNormComponents,e._webgl.normalType,!1,e._normalStrideOffset[0],e._normalStrideOffset[1]),i.enableVertexAttribArray(t.normal)),s._vf.texCoord.length>0&&(e._webgl.buffers[3]=_,i.bindBuffer(i.ARRAY_BUFFER,_),i.bufferData(i.ARRAY_BUFFER,l,i.STATIC_DRAW),i.vertexAttribPointer(t.texcoord,s._mesh._numTexComponents,e._webgl.texCoordType,!1,e._texCoordStrideOffset[0],e._texCoordStrideOffset[1]),i.enableVertexAttribArray(t.texcoord)),s._vf.color.length>0&&(e._webgl.buffers[4]=_,i.bindBuffer(i.ARRAY_BUFFER,_),i.bufferData(i.ARRAY_BUFFER,l,i.STATIC_DRAW),i.vertexAttribPointer(t.color,s._mesh._numColComponents,e._webgl.colorType,!1,e._colorStrideOffset[0],e._colorStrideOffset[1]),i.enableVertexAttribArray(t.color)),l=null,e._nameSpace.doc.downloadCount-=1,e._webgl.internalDownloadCount-=1,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),n.checkError(i);var c=(new Date).getTime()-r;x3dom.debug.logInfo("XHR/ interleaved array load time: "+c+" ms"),e._webgl.buffers[1]=_}}}if(!a._hasStrideOffset&&a._vf.coord.length>0){var u=new XMLHttpRequest;u.open("GET",e._nameSpace.getURL(a._vf.coord),!0),u.responseType="arraybuffer",e._nameSpace.doc.downloadCount+=1,u.send(null),u.onload=function(){if(200!=u.status)return e._nameSpace.doc.downloadCount-=1,void x3dom.debug.logError("XHR1/ coord load failed with status: "+u.status);if(e._webgl){var o=1==a._vf.compressed?x3dom.Utils.gunzip(u.response):u.response,s=a,l=0,h=s._vf.coordType;e._webgl.coordType=x3dom.Utils.getVertexAttribType(h,i);var f=x3dom.Utils.getArrayBufferView(h,o);if(d)return void e._webgl.makeSeparateTris.pushBuffer("coord",f);i.bindAttribLocation(t.program,0,"position");var _=i.createBuffer();if(i.bindBuffer(i.ARRAY_BUFFER,_),i.bufferData(i.ARRAY_BUFFER,f,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),s._mesh._numCoords=f.length/s._mesh._numPosComponents,0==s._vf.index.length)for(l=0;l<s._vf.vertexCount.length;l++)s._mesh._numFaces+=e._webgl.primType[l]==i.TRIANGLE_STRIP?s._vf.vertexCount[l]-2:s._vf.vertexCount[l]/3;if("Float32"==h&&(e._vf.bboxSize.x<0||e._vf.bboxSize.y<0||e._vf.bboxSize.z<0)){var c=new x3dom.fields.SFVec3f(f[0],f[1],f[2]),m=new x3dom.fields.SFVec3f(f[0],f[1],f[2]);for(l=3;l<f.length;l+=3)c.x>f[l+0]&&(c.x=f[l+0]),c.y>f[l+1]&&(c.y=f[l+1]),c.z>f[l+2]&&(c.z=f[l+2]),m.x<f[l+0]&&(m.x=f[l+0]),m.y<f[l+1]&&(m.y=f[l+1]),m.z<f[l+2]&&(m.z=f[l+2]);e._vf.bboxCenter.setValues(c.add(m).multiply(.5)),e._vf.bboxSize.setValues(m.subtract(c))}f=null,e._nameSpace.doc.downloadCount-=1,e._webgl.internalDownloadCount-=1,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),n.checkError(i);var p=(new Date).getTime()-r;x3dom.debug.logInfo("XHR1/ coord load time: "+p+" ms"),e._webgl.buffers[1]=_}}}if(!a._hasStrideOffset&&a._vf.normal.length>0){var f=new XMLHttpRequest;f.open("GET",e._nameSpace.getURL(a._vf.normal),!0),f.responseType="arraybuffer",e._nameSpace.doc.downloadCount+=1,f.send(null),f.onload=function(){if(200!=f.status)return e._nameSpace.doc.downloadCount-=1,void x3dom.debug.logError("XHR2/ normal load failed with status: "+f.status);if(e._webgl){var t=1==a._vf.compressed?x3dom.Utils.gunzip(f.response):f.response,o=a._vf.normalType;e._webgl.normalType=x3dom.Utils.getVertexAttribType(o,i);var s=x3dom.Utils.getArrayBufferView(o,t);if(d)return void e._webgl.makeSeparateTris.pushBuffer("normal",s);var l=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,l),i.bufferData(i.ARRAY_BUFFER,s,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),s=null,e._nameSpace.doc.downloadCount-=1,e._webgl.internalDownloadCount-=1,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),n.checkError(i);var h=(new Date).getTime()-r;x3dom.debug.logInfo("XHR2/ normal load time: "+h+" ms"),e._webgl.buffers[2]=l}}}if(!a._hasStrideOffset&&a._vf.texCoord.length>0){var _=new XMLHttpRequest;_.open("GET",e._nameSpace.getURL(a._vf.texCoord),!0),_.responseType="arraybuffer",e._nameSpace.doc.downloadCount+=1,_.send(null),_.onload=function(){var t,o;if(200!=_.status)return e._nameSpace.doc.downloadCount-=1,void x3dom.debug.logError("XHR3/ texcoord load failed with status: "+_.status);if(e._webgl){var s=1==a._vf.compressed?x3dom.Utils.gunzip(_.response):_.response,l=a._vf.texCoordType;e._webgl.texCoordType=x3dom.Utils.getVertexAttribType(l,i);var h=x3dom.Utils.getArrayBufferView(l,s);if(d)return void e._webgl.makeSeparateTris.pushBuffer("texCoord",h);if(a._vf.idsPerVertex){var u=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,u);var f=x3dom.Utils.getArrayBufferView("Float32",h.length/2);for(t=0,o=0;t<h.length;t+=2,o++)f[o]=65536*h[t+1]+h[t];i.bufferData(i.ARRAY_BUFFER,f,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),e._webgl.buffers[5]=u}else{var c=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,c),i.bufferData(i.ARRAY_BUFFER,h,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),e._webgl.buffers[3]=c}h=null,e._nameSpace.doc.downloadCount-=1,e._webgl.internalDownloadCount-=1,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),n.checkError(i);var m=(new Date).getTime()-r;x3dom.debug.logInfo("XHR3/ texCoord load time: "+m+" ms")}}}if(!a._hasStrideOffset&&a._vf.color.length>0){var c=new XMLHttpRequest;c.open("GET",e._nameSpace.getURL(a._vf.color),!0),c.responseType="arraybuffer",e._nameSpace.doc.downloadCount+=1,c.send(null),c.onload=function(){if(200!=c.status)return e._nameSpace.doc.downloadCount-=1,void x3dom.debug.logError("XHR4/ color load failed with status: "+c.status);if(e._webgl){var t=1==a._vf.compressed?x3dom.Utils.gunzip(c.response):c.response,o=a._vf.colorType;e._webgl.colorType=x3dom.Utils.getVertexAttribType(o,i);var s=x3dom.Utils.getArrayBufferView(o,t);if(d)return void e._webgl.makeSeparateTris.pushBuffer("color",s);var l=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,l),i.bufferData(i.ARRAY_BUFFER,s,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),s=null,e._nameSpace.doc.downloadCount-=1,e._webgl.internalDownloadCount-=1,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),n.checkError(i);var h=(new Date).getTime()-r;x3dom.debug.logInfo("XHR4/ color load time: "+h+" ms"),e._webgl.buffers[4]=l}}}}},x3dom.BinaryContainerLoader.setupPopGeo=function(e,t,i){if(!this.outOfMemory){var o=e._cf.geometry.node;if(o.hasIndex()){e._webgl.popGeometry=1,e._webgl.buffers[0]=i.createBuffer(),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e._webgl.buffers[0]),i.bufferData(i.ELEMENT_ARRAY_BUFFER,2*o.getTotalNumberOfIndices(),i.STATIC_DRAW),e._webgl.buffers[5]=i.createBuffer();var s=new Float32Array(o._vf.vertexBufferSize);!function(){for(var e=0;e<s.length;++e)s[e]=e}(),i.bindBuffer(i.ARRAY_BUFFER,e._webgl.buffers[5]),i.bufferData(i.ARRAY_BUFFER,s,i.STATIC_DRAW)}else e._webgl.popGeometry=-1;e._webgl.buffers[1]=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,e._webgl.buffers[1]),i.bufferData(i.ARRAY_BUFFER,o._vf.attributeStride*o._vf.vertexBufferSize,i.STATIC_DRAW);var r=o._vf.coordType;e._webgl.coordType=x3dom.Utils.getVertexAttribType(r,i),e._coordStrideOffset[0]=o.getAttributeStride(),e._coordStrideOffset[1]=o.getPositionOffset(),i.vertexAttribPointer(t.position,e._cf.geometry.node._mesh._numPosComponents,e._webgl.coordType,!1,e._coordStrideOffset[0],e._coordStrideOffset[1]),i.enableVertexAttribArray(t.position),o.hasNormal()&&(r=o._vf.normalType,e._webgl.normalType=x3dom.Utils.getVertexAttribType(r,i),e._normalStrideOffset[0]=o.getAttributeStride(),e._normalStrideOffset[1]=o.getNormalOffset(),e._webgl.buffers[2]=e._webgl.buffers[1],i.vertexAttribPointer(t.normal,e._cf.geometry.node._mesh._numNormComponents,e._webgl.normalType,!1,e._normalStrideOffset[0],e._normalStrideOffset[1]),i.enableVertexAttribArray(t.normal)),o.hasTexCoord()&&(r=o._vf.texCoordType,e._webgl.texCoordType=x3dom.Utils.getVertexAttribType(r,i),e._webgl.buffers[3]=e._webgl.buffers[1],e._texCoordStrideOffset[0]=o.getAttributeStride(),e._texCoordStrideOffset[1]=o.getTexCoordOffset(),i.vertexAttribPointer(t.texcoord,e._cf.geometry.node._mesh._numTexComponents,e._webgl.texCoordType,!1,e._texCoordStrideOffset[0],e._texCoordStrideOffset[1]),i.enableVertexAttribArray(t.texcoord)),o.hasColor()&&(r=o._vf.colorType,e._webgl.colorType=x3dom.Utils.getVertexAttribType(r,i),e._webgl.buffers[4]=e._webgl.buffers[1],e._colorStrideOffset[0]=o.getAttributeStride(),e._colorStrideOffset[1]=o.getColorOffset(),i.vertexAttribPointer(t.color,e._cf.geometry.node._mesh._numColComponents,e._webgl.colorType,!1,e._colorStrideOffset[0],e._colorStrideOffset[1]),i.enableVertexAttribArray(t.color)),e._webgl.currentNumIndices=0,e._webgl.currentNumVertices=0,e._webgl.numVerticesAtLevel=[],e._webgl.levelsAvailable=0,this.checkError(i),e._webgl.levelLoaded=[],function(){for(var t=0;t<o.getNumLevels();++t)e._webgl.levelLoaded.push(!1)}();var n=function(t,s){if(e._webgl.levelLoaded[s]=!0,e._webgl.numVerticesAtLevel[s]=0,t){var r=0,n=!1;if(o.hasIndex()&&(r=2*o.getNumIndicesByLevel(s),r>0)){n=!0;var a=new Uint8Array(t,0,r);i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e._webgl.buffers[0]),function(){for(var e=0,t=0;s>t;++t)e+=o.getNumIndicesByLevel(t);i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,2*e,a)}()}var d=t.byteLength-r;if(d>0){n=!0;var l=new Uint8Array(t,r,d);i.bindBuffer(i.ARRAY_BUFFER,e._webgl.buffers[1]),o.hasIndex()?i.bufferSubData(i.ARRAY_BUFFER,o.getVertexDataBufferOffset(s)*o.getAttributeStride(),l):i.bufferSubData(i.ARRAY_BUFFER,e._webgl.currentNumVertices*o.getAttributeStride(),l),e._webgl.numVerticesAtLevel[s]=d/o.getAttributeStride(),e._webgl.currentNumVertices+=e._webgl.numVerticesAtLevel[s]}!function(){for(var t=0,i=e._webgl.levelsAvailable;i<o.getNumLevels()&&e._webgl.levelLoaded[i]!==!1;++i)t+=o.getNumIndicesByLevel(i),++e._webgl.levelsAvailable;e._webgl.currentNumIndices=t}(),o._mesh._numCoords=e._webgl.currentNumVertices,o._mesh._numFaces=(o.hasIndex()?e._webgl.currentNumIndices:e._webgl.currentNumVertices)/3,o.adaptVertexCount(o.hasIndex()?3*o._mesh._numFaces:o._mesh._numCoords),n&&(e._nameSpace.doc.needRender=!0)}},a=o.getDataURLs(),d=[],l=[];e._webgl.downloadStartTimer=(new Date).getTime();for(var h=0;h<a.length;++h)e._nameSpace.doc.downloadCount+=1,function(t){d.push(function(i){return e._nameSpace.doc.downloadCount-=1,n(i,t)})}(h),l.push(h);x3dom.DownloadManager.get(a,d,l)}},x3dom.BinaryContainerLoader.setupImgGeo=function(e,t,i,o,s){if(!this.outOfMemory){var r=e._cf.geometry.node;e._webgl.imageGeometry=r.getIndexTexture()?1:-1,r.unsetGeoDirty(),null==s.IG_PositionBuffer&&(s.IG_PositionBuffer=i.createBuffer()),e._webgl.buffers[1]=s.IG_PositionBuffer,i.bindBuffer(i.ARRAY_BUFFER,s.IG_PositionBuffer);var n=new Float32Array(e._webgl.positions[0]);i.bufferData(i.ARRAY_BUFFER,n,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,s.IG_PositionBuffer),i.vertexAttribPointer(t.position,r._mesh._numPosComponents,e._webgl.coordType,!1,e._coordStrideOffset[0],e._coordStrideOffset[1]),i.enableVertexAttribArray(t.position),n=null,this.checkError(i)}},x3dom.DrawableCollection=function(e){this.collection=[],this.viewMatrix=e.viewMatrix,this.projMatrix=e.projMatrix,this.sceneMatrix=e.sceneMatrix,this.viewarea=e.viewArea;var t=this.viewarea._scene,i=t.getEnvironment(),o=t.getViewpoint();this.near=o.getNear(),this.pixelHeightAtDistOne=o.getImgPlaneHeightAtDistOne()/this.viewarea._height,this.context=e.context,this.gl=e.gl,this.viewFrustum=this.viewarea.getViewfrustum(this.sceneMatrix),this.worldVol=new x3dom.fields.BoxVolume,this.frustumCulling=e.frustumCulling&&null!=this.viewFrustum,this.smallFeatureThreshold=e.smallFeatureThreshold,this.sortOpaque=this.smallFeatureThreshold>0&&i._lowPriorityThreshold<1,this.sortTrans=e.sortTrans,this.prioLevels=10,this.maxTreshold=100,this.sortBySortKey=!1,this.sortByPriority=!1,this.numberOfNodes=0,this.length=0},x3dom.DrawableCollection.prototype.cull=function(e,t,i,o){var s=t.boundedNode;if(!s||!s._vf.render)return-1;var r=s.getVolume(),n=63;if(this.frustumCulling&&t.needCulling){var a;if(i&&!t.worldVolume.isValid()?(t.worldVolume.transformFrom(e,r),a=t.worldVolume):n>o&&(this.worldVol.transformFrom(e,r),a=this.worldVol),n>o&&(o=this.viewFrustum.intersect(a,o)),-1==o)return-1}else o=n;if(t.coverage=-1,this.smallFeatureThreshold>0||s.forceUpdateCoverage()){var d=this.viewMatrix.mult(e);t.center=d.multMatrixPnt(r.getCenter());var l=d.multMatrixVec(r.getRadialVec()),h=l.length(),u=Math.max(-t.center.z-h,this.near),f=u*this.pixelHeightAtDistOne;if(t.coverage=2*h/f,this.smallFeatureThreshold>0&&t.coverage<this.smallFeatureThreshold&&t.needCulling)return-1}return this.numberOfNodes++,o},x3dom.DrawableCollection.prototype.addShape=function(e,t,i){var o={};o.shape=e,o.transform=t,o.localTransform=i.localMatrix,o.localVolume=i.volume,o.worldVolume=x3dom.fields.BoxVolume.copy(i.worldVolume),o.priority=Math.max(0,i.coverage),o.shaderID=e.getShaderProperties(this.viewarea).id;var s=e._cf.appearance.node;if(o.sortType=s?s._vf.sortType.toLowerCase():"opaque",o.sortKey=s?s._vf.sortKey:0,"transparent"==o.sortType)if(this.smallFeatureThreshold>0)o.zPos=i.center.z;else{var r=t.multMatrixPnt(e.getCenter());r=this.viewMatrix.multMatrixPnt(r),o.zPos=r.z}this.sortBySortKey||0==o.sortKey||(this.sortBySortKey=!0),void 0===this.collection[o.sortType]&&(this.collection[o.sortType]=[]),this.collection[o.sortType].push(o),this.length++,this.context&&this.gl&&this.context.setupShape(this.gl,o,this.viewarea)},x3dom.DrawableCollection.prototype.addDrawable=function(e){e.shaderID=e.shape.getShaderProperties(this.viewarea).id;var t=e.shape._cf.appearance.node;if(e.sortType=t?t._vf.sortType.toLowerCase():"opaque",e.sortKey=t?t._vf.sortKey:0,"transparent"==e.sortType){var i=e.transform.multMatrixPnt(e.shape.getCenter());i=this.viewMatrix.multMatrixPnt(i),e.zPos=i.z}this.sortBySortKey||0==e.sortKey||(this.sortBySortKey=!0),void 0===this.collection[e.sortType]&&(this.collection[e.sortType]=[]),this.collection[e.sortType].push(e),this.length++,this.context&&this.gl&&this.context.setupShape(this.gl,e,this.viewarea)},x3dom.DrawableCollection.prototype.calculatePriority=function(e){var t=Math.max(0,e.coverage),i=this.prioLevels-1;return t=Math.min(Math.round(t/(this.maxTreshold/i)),i)},x3dom.DrawableCollection.prototype.concat=function(){var e=void 0!==this.collection.opaque?this.collection.opaque:[],t=void 0!==this.collection.transparent?this.collection.transparent:[];this.collection=e.concat(t)},x3dom.DrawableCollection.prototype.get=function(e){return this.collection[e]},x3dom.DrawableCollection.prototype.sort=function(){var e=[],t=[],i=this;void 0!==this.collection.opaque&&(this.sortOpaque&&this.collection.opaque.sort(function(e,t){return e.sortKey!=t.sortKey&&i.sortBySortKey?e.sortKey-t.sortKey:t.priority-e.priority}),e=this.collection.opaque),void 0!==this.collection.transparent&&(this.sortTrans&&this.collection.transparent.sort(function(e,t){return e.sortKey!=t.sortKey&&i.sortBySortKey?e.sortKey-t.sortKey:e.priority!=t.priority&&i.sortByPriority?t.priority-e.priority:e.zPos-t.zPos}),t=this.collection.transparent),this.collection=e.concat(t)},x3dom.DrawableCollection.prototype.forEach=function(e,t){t=void 0!==t?Math.min(t,this.prioLevels):this.prioLevels;var i,o,s,r;for(i=0;i<this.collection.opaque.length;++i)if(void 0!==this.collection.opaque[i])for(o=this.collection.opaque[i].length;o>0;--o)if(void 0!==this.collection.opaque[i][o])for(s in this.collection.opaque[i][o])for(r=0;r<this.collection.opaque[i][o][s].length;++r)e(this.collection.opaque[i][o][s][r]);for(i=0;i<this.collection.transparent.length;++i)if(void 0!==this.collection.transparent[i])for(o=this.collection.transparent[i].length;o>0;--o)if(void 0!==this.collection.transparent[i][o])for(var n in this.collection.transparent[i][o])for(this.collection.transparent[i][o][n].sort(function(e,t){return e.zPos-t.zPos}),r=0;r<this.collection.transparent[i][o][n].length;++r)e(this.collection.transparent[i][o][n][r])},x3dom.Moveable=function(e,t,i,o,s){this._x3domRoot=e,this._runtime=e.runtime,this._callback=i,this._gridSize=o?o:0,this._moveable=t,this._drag=!1,this._w=0,this._h=0,this._uPlane=null,this._vPlane=null,this._pPlane=null,this._isect=null,this._translationOffset=null,this._rotationOffset=null,this._scaleOffset=null,this._lastX=0,this._lastY=0,this._buttonState=0,this._mode=s&&s.length?s.toLowerCase():"translation",this._firstRay=null,this._matrixTrafo=null,this._navType="examine",this.attachHandlers()},x3dom.Moveable.prototype.setGridSize=function(e){this._gridSize=e},x3dom.Moveable.prototype.setMode=function(e){this._mode=e.toLowerCase()},x3dom.Moveable.prototype.attachHandlers=function(){this._moveable._iMove=this,this._x3domRoot._iMove||(this._x3domRoot._iMove=[]),this._x3domRoot._iMove.push(this),this._moveable.addEventListener("mousedown",this.start,!1),this._moveable.addEventListener("mouseover",this.over,!1),this._moveable.addEventListener("mouseout",this.out,!1),1==this._x3domRoot._iMove.length&&(this._x3domRoot.addEventListener("mouseup",this.stop,!1),this._x3domRoot.addEventListener("mouseout",this.stop,!1),this._x3domRoot.addEventListener("mousemove",this.move,!0),this._runtime.canvas.disableTouch||(this._x3domRoot.addEventListener("MozTouchDown",this.touchStartHandlerMoz,!1),this._x3domRoot.addEventListener("MozTouchMove",this.touchMoveHandlerMoz,!0),this._x3domRoot.addEventListener("MozTouchUp",this.touchEndHandlerMoz,!1),this._x3domRoot.addEventListener("touchstart",this.touchStartHandler,!1),this._x3domRoot.addEventListener("touchmove",this.touchMoveHandler,!0),this._x3domRoot.addEventListener("touchend",this.touchEndHandler,!1)))},x3dom.Moveable.prototype.detachHandlers=function(){var e=this._x3domRoot._iMove;if(e)for(var t=0,i=e.length;i>t;t++)if(e[t]==this){e.splice(t,1);break}this._moveable.removeEventListener("mousedown",this.start,!1),this._moveable.removeEventListener("mouseover",this.over,!1),this._moveable.removeEventListener("mouseout",this.out,!1),0==e.length&&(this._x3domRoot.removeEventListener("mouseup",this.stop,!1),this._x3domRoot.removeEventListener("mouseout",this.stop,!1),this._x3domRoot.removeEventListener("mousemove",this.move,!0),this._runtime.canvas.disableTouch||(this._x3domRoot.removeEventListener("MozTouchDown",this.touchStartHandlerMoz,!1),this._x3domRoot.removeEventListener("MozTouchMove",this.touchMoveHandlerMoz,!0),this._x3domRoot.removeEventListener("MozTouchUp",this.touchEndHandlerMoz,!1),this._x3domRoot.removeEventListener("touchstart",this.touchStartHandler,!1),this._x3domRoot.removeEventListener("touchmove",this.touchMoveHandler,!0),this._x3domRoot.removeEventListener("touchend",this.touchEndHandler,!1))),this._moveable._iMove&&delete this._moveable._iMove},x3dom.Moveable.prototype.calcViewPlane=function(e){this._w=this._runtime.getWidth(),this._h=this._runtime.getHeight();var t=this._runtime.getViewingRay(0,this._h-1),i=t.pos.add(t.dir);t=this._runtime.getViewingRay(this._w-1,this._h-1);var o=t.pos.add(t.dir);t=this._runtime.getViewingRay(0,0);var s=t.pos.add(t.dir);this._uPlane=o.subtract(i).normalize(),this._vPlane=s.subtract(i).normalize(),this._pPlane=0===arguments.length?i:x3dom.fields.SFVec3f.copy(e)},x3dom.Moveable.prototype.det=function(e){return e[0][0]*e[1][1]*e[2][2]+e[0][1]*e[1][2]*e[2][0]+e[0][2]*e[2][1]*e[1][0]-e[2][0]*e[1][1]*e[0][2]-e[0][0]*e[2][1]*e[1][2]-e[1][0]*e[0][1]*e[2][2]},x3dom.Moveable.prototype.translateXY=function(e){for(var t=null,i=[],o=[],s=0;3>s;s++)i[s]=[],o[s]=[],i[s][0]=this._uPlane.at(s),o[s][0]=i[s][0],i[s][1]=this._vPlane.at(s),o[s][1]=i[s][1],i[s][2]=e.pos.subtract(this._pPlane).at(s),o[s][2]=-e.dir.at(s);var r=this.det(o);if(0!==r){var n=this.det(i)/r;t=e.pos.addScaled(e.dir,n)}return t&&(this._isect&&(t=t.subtract(this._isect)),t=t.add(this._translationOffset)),t},x3dom.Moveable.prototype.translateZ=function(e,t){var i=this._runtime.getSceneBBox(),o=t<this._lastY?1:-1,s=o*i.max.subtract(i.min).length()/100;return this._translationOffset=this._translationOffset.addScaled(e.dir,s),this._translationOffset},x3dom.Moveable.prototype.rotate=function(e,t){var i=2*Math.PI,o=(t-this._lastY)*i/this._w,s=(e-this._lastX)*i/this._h,r=x3dom.fields.Quaternion.axisAngle(this._uPlane,o),n=r.toMatrix();this._rotationOffset=n.mult(this._rotationOffset),r=x3dom.fields.Quaternion.axisAngle(this._vPlane,s),n=r.toMatrix(),this._rotationOffset=n.mult(this._rotationOffset);var a=this._rotationOffset.mult(x3dom.fields.SFMatrix4f.scale(this._scaleOffset)),d=new x3dom.fields.Quaternion(0,0,1,0);return d.setValue(a),d},x3dom.Moveable.prototype.over=function(){var e=this._iMove;e._runtime.getCanvas().style.cursor="crosshair"},x3dom.Moveable.prototype.out=function(){var e=this._iMove;e._drag||(e._runtime.getCanvas().style.cursor="pointer")},x3dom.Moveable.prototype.start=function(e){var t=this._iMove;switch(t._mode){case"translation":t._buttonState=4==e.button?1:3&e.button;break;case"rotation":t._buttonState=4;break;case"all":default:t._buttonState=e.button}if(!t._drag&&t._buttonState){t._lastX=e.layerX,t._lastY=e.layerY,t._drag=!0,t._navType=t._runtime.navigationType(),t._runtime.noNav(),t._isect=new x3dom.fields.SFVec3f(e.worldX,e.worldY,e.worldZ),t.calcViewPlane(t._isect),t._firstRay=t._runtime.getViewingRay(e.layerX,e.layerY);var i=t._moveable.getAttribute("translation");if(t._matrixTrafo=null,i){t._translationOffset=x3dom.fields.SFVec3f.parse(i);var o=t._moveable.getAttribute("rotation");o=o?x3dom.fields.Quaternion.parseAxisAngle(o):new x3dom.fields.Quaternion(0,0,1,0),t._rotationOffset=o.toMatrix();var s=t._moveable.getAttribute("scale");t._scaleOffset=s?x3dom.fields.SFVec3f.parse(s):new x3dom.fields.SFVec3f(1,1,1)}else if(i=t._moveable.getAttribute("matrix")){t._matrixTrafo=x3dom.fields.SFMatrix4f.parse(i).transpose();var r=new x3dom.fields.SFVec3f(0,0,0),n=new x3dom.fields.SFVec3f(1,1,1),a=new x3dom.fields.Quaternion(0,0,1,0),d=new x3dom.fields.Quaternion(0,0,1,0);t._matrixTrafo.getTransform(r,a,n,d),t._translationOffset=r,t._rotationOffset=a.toMatrix(),t._scaleOffset=n}else t._translationOffset=new x3dom.fields.SFVec3f(0,0,0),t._rotationOffset=new x3dom.fields.SFMatrix4f,t._scaleOffset=new x3dom.fields.SFVec3f(1,1,1);t._runtime.getCanvas().style.cursor="crosshair"}},x3dom.Moveable.prototype.move=function(e){for(var t=0,i=this._iMove.length;i>t;t++){var o=this._iMove[t];if(o._drag){var s=o._runtime.mousePosition(e),r=o._runtime.getViewingRay(s[0],s[1]),n=null;if(n=2==o._buttonState?o.translateZ(o._firstRay,s[1]):1==o._buttonState?o.translateXY(r):o.rotate(s[0],s[1])){if(o._gridSize>0&&4!=o._buttonState){var a=o._gridSize*Math.round(n.x/o._gridSize),d=o._gridSize*Math.round(n.y/o._gridSize),l=o._gridSize*Math.round(n.z/o._gridSize);n=new x3dom.fields.SFVec3f(a,d,l)}o._matrixTrafo?(4==o._buttonState?o._matrixTrafo.setRotate(n):o._matrixTrafo.setTranslate(n),o._moveable.setAttribute("matrix",o._matrixTrafo.toGL().toString())):4==o._buttonState?o._moveable.setAttribute("rotation",n.toAxisAngle().toString()):o._moveable.setAttribute("translation",n.toString()),o._callback&&o._callback(o._moveable,n)}o._lastX=s[0],o._lastY=s[1]}}},x3dom.Moveable.prototype.stop=function(e){for(var t=0,i=this._iMove.length;i>t;t++){var o=this._iMove[t];if(o._drag){o._lastX=e.layerX,o._lastY=e.layerY,o._isect=null,o._drag=!1;var s=o._runtime.canvas.doc._scene.getNavigationInfo();s.setType(o._navType),o._runtime.getCanvas().style.cursor="pointer"}}},x3dom.Moveable.prototype.touchStartHandler=function(e){e.preventDefault()},x3dom.Moveable.prototype.touchStartHandlerMoz=function(e){e.preventDefault()},x3dom.Moveable.prototype.touchMoveHandler=function(e){e.preventDefault()},x3dom.Moveable.prototype.touchMoveHandlerMoz=function(e){e.preventDefault()},x3dom.Moveable.prototype.touchEndHandler=function(e){if(this._iMove.length){var t=this._iMove[0];t.stop.apply(t._x3domRoot,[e])}e.preventDefault()},x3dom.Moveable.prototype.touchEndHandlerMoz=function(e){if(this._iMove.length){var t=this._iMove[0];t.stop.apply(t._x3domRoot,[e])}e.preventDefault()},x3dom.X3DCanvas=function(e,t){var i=this;if(this._canvasIdx=t,this.isFlashReady=!1,this.x3dElem=e,this._current_dim=[0,0],this.fps_t0=(new Date).getTime(),this.lastTimeFPSWasTaken=0,this.framesSinceLastTime=0,this.doc=null,this.lastMousePos={x:0,y:0},x3dom.caps.DOMNodeInsertedEvent_perSubtree=!(-1!=navigator.userAgent.indexOf("MSIE")||-1!=navigator.userAgent.indexOf("Trident")),e.__setAttribute=e.setAttribute,e.setAttribute=function(e,t){switch(this.__setAttribute(e,t),window.devicePixelRatio&&(t=parseInt(t)*window.devicePixelRatio),e){case"width":i.canvas.setAttribute("width",t),i.doc&&i.doc._viewarea&&(i.doc._viewarea._width=parseInt(i.canvas.getAttribute("width"),0),i.doc.needRender=!0);break;case"height":i.canvas.setAttribute("height",t),i.doc&&i.doc._viewarea&&(i.doc._viewarea._height=parseInt(i.canvas.getAttribute("height"),0),i.doc.needRender=!0)}},x3dom.caps.MOBILE=navigator.appVersion.indexOf("Mobile")>-1,this.backend=this.x3dElem.getAttribute("backend"),this.backend=this.backend?this.backend.toLowerCase():"none","flash"==this.backend){if(this.backend="flash",this.canvas=this._createFlashObject(e),null==this.canvas)return void this._createInitFailedDiv(e);this.canvas.parent=this,this.gl=this._initFlashContext(this.canvas,this.flash_renderType)}else if(this.canvas=this._createHTMLCanvas(e),this.canvas.parent=this,this.gl=this._initContext(this.canvas,this.backend.search("desktop")>=0,this.backend.search("mobile")>=0,this.backend.search("flashie")>=0,this.backend.search("webgl2")>=0),this.backend="webgl",null==this.gl){if(x3dom.debug.logInfo("Fallback to Flash Renderer"),this.backend="flash",this.canvas=this._createFlashObject(e),null==this.canvas)return void this._createInitFailedDiv(e);this.canvas.parent=this,this.gl=this._initFlashContext(this.canvas,this.flash_renderType)}x3dom.caps.BACKEND=this.backend;var o=e.getAttribute("runtimeEnabled");if(this.hasRuntime=null!==o?"true"==o.toLowerCase():e.hasRuntime,null===this.gl&&(this.hasRuntime=!1),"flash"!=this.backend&&(this.showStat=e.getAttribute("showStat"),this.stateViewer=new x3dom.States(e),null!==this.showStat&&"true"==this.showStat&&this.stateViewer.display(!0),this.x3dElem.appendChild(this.stateViewer.viewer)),this.showProgress=e.getAttribute("showProgress"),this.progressDiv=this._createProgressDiv(),this.progressDiv.style.display=null!==this.showProgress&&"true"==this.showProgress?"inline":"none",this.x3dElem.appendChild(this.progressDiv),this.showTouchpoints=e.getAttribute("showTouchpoints"),this.showTouchpoints=this.showTouchpoints?this.showTouchpoints:!1,this.disableTouch=e.getAttribute("disableTouch"),this.disableTouch=this.disableTouch?"true"==this.disableTouch.toLowerCase():!1,this.disableKeys=e.getAttribute("keysEnabled"),this.disableKeys=this.disableKeys?"true"==this.disableKeys.toLowerCase():!1,this.disableRightDrag=e.getAttribute("disableRightDrag"),this.disableRightDrag=this.disableRightDrag?"true"==this.disableRightDrag.toLowerCase():!1,this.disableLeftDrag=e.getAttribute("disableLeftDrag"),this.disableLeftDrag=this.disableLeftDrag?"true"==this.disableLeftDrag.toLowerCase():!1,this.disableMiddleDrag=e.getAttribute("disableMiddleDrag"),this.disableMiddleDrag=this.disableMiddleDrag?"true"==this.disableMiddleDrag.toLowerCase():!1,null!==this.canvas&&null!==this.gl&&this.hasRuntime&&"flash"!==this.backend){this.canvas.mouse_dragging=!1,this.canvas.mouse_button=0,this.canvas.mouse_drag_x=0,this.canvas.mouse_drag_y=0,this.canvas.isMulti=!1,this.canvas.oncontextmenu=function(e){return e.preventDefault(),e.stopPropagation(),!1},this.canvas.addEventListener("webglcontextlost",function(e){x3dom.debug.logError("WebGL context lost"),e.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",function(e){x3dom.debug.logError("recover WebGL state and resources on context lost NYI"),e.preventDefault()},!1),this.canvas.addEventListener("mousedown",function(e){if(!this.isMulti){switch(this.focus(),this.classList.add("x3dom-canvas-mousedown"),e.button){case 0:this.mouse_button=1;break;case 1:this.mouse_button=4;break;case 2:this.mouse_button=2;break;default:this.mouse_button=0}e.shiftKey&&(this.mouse_button=1),e.ctrlKey&&(this.mouse_button=4),e.altKey&&(this.mouse_button=2);var t=this.parent.mousePosition(e);this.mouse_drag_x=t.x,this.mouse_drag_y=t.y,this.mouse_dragging=!0,this.parent.doc.onMousePress(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0}},!1),this.canvas.addEventListener("mouseup",function(){if(!this.isMulti){var e=this.mouse_button;this.classList.remove("x3dom-canvas-mousedown"),this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseRelease(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button,e),this.parent.doc.needRender=!0}},!1),this.canvas.addEventListener("mouseover",function(){this.isMulti||(this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseOver(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0)},!1),this.canvas.addEventListener("mouseout",function(){this.isMulti||(this.mouse_button=0,this.mouse_dragging=!1,this.classList.remove("x3dom-canvas-mousedown"),this.parent.doc.onMouseOut(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0)},!1),this.canvas.addEventListener("dblclick",function(e){if(!this.isMulti){this.mouse_button=0;var t=this.parent.mousePosition(e);this.mouse_drag_x=t.x,this.mouse_drag_y=t.y,this.mouse_dragging=!1,this.parent.doc.onDoubleClick(i.gl,this.mouse_drag_x,this.mouse_drag_y),this.parent.doc.needRender=!0}},!1),this.canvas.addEventListener("mousemove",function(e){if(!this.isMulti){var t=this.parent.mousePosition(e);(t.x!=i.lastMousePos.x||t.y!=i.lastMousePos.y)&&(i.lastMousePos=t,e.shiftKey&&(this.mouse_button=1),e.ctrlKey&&(this.mouse_button=4),e.altKey&&(this.mouse_button=2),this.mouse_drag_x=t.x,this.mouse_drag_y=t.y,this.mouse_dragging?(1==this.mouse_button&&!this.parent.disableLeftDrag||2==this.mouse_button&&!this.parent.disableRightDrag||4==this.mouse_button&&!this.parent.disableMiddleDrag)&&this.parent.doc.onDrag(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button):this.parent.doc.onMove(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0,e.preventDefault(),e.stopPropagation())}},!1),this.canvas.addEventListener("DOMMouseScroll",function(e){if(!this.isMulti){this.focus();var t=this.parent.mousePosition(e).y;this.mouse_drag_y+=2*e.detail,this.parent.doc.onWheel(i.gl,this.mouse_drag_x,this.mouse_drag_y,t),this.parent.doc.needRender=!0,e.preventDefault(),e.stopPropagation()}},!1),this.canvas.addEventListener("mousewheel",function(e){if(!this.isMulti){this.focus();var t=this.parent.mousePosition(e).y;this.mouse_drag_y-=.1*e.wheelDelta,this.parent.doc.onWheel(i.gl,this.mouse_drag_x,this.mouse_drag_y,t),this.parent.doc.needRender=!0,e.preventDefault(),e.stopPropagation()}},!1),this.canvas.addEventListener("keypress",function(e){this.parent.disableKeys||this.parent.doc.onKeyPress(e.charCode),this.parent.doc.needRender=!0},!0),this.canvas.addEventListener("keyup",function(e){this.parent.disableKeys||this.parent.doc.onKeyUp(e.keyCode),this.parent.doc.needRender=!0},!0),this.canvas.addEventListener("keydown",function(e){this.parent.disableKeys||this.parent.doc.onKeyDown(e.keyCode),this.parent.doc.needRender=!0},!0);var s={numTouches:0,firstTouchTime:(new Date).getTime(),firstTouchPoint:new x3dom.fields.SFVec2f(0,0),lastPos:new x3dom.fields.SFVec2f,lastDrag:new x3dom.fields.SFVec2f,lastMiddle:new x3dom.fields.SFVec2f,lastSquareDistance:0,lastAngle:0,lastLayer:[],examineNavType:1,calcAngle:function(e){var t=e.normalize().dot(new x3dom.fields.SFVec2f(1,0));return t=Math.acos(t),e.y<0&&(t=Math.PI+(Math.PI-t)),t},disableTouch:this.disableTouch,visMarker:this.showTouchpoints,visMarkerBag:[],visualizeTouches:function(e){if(this.visMarker){for(var t=[],i=null,o=0;o<e.touches.length;o++){var s=e.touches[o].identifier||e.touches[o].streamId;s||(s=0);var r=this.visMarkerBag.indexOf(s);r>=0?(i=document.getElementById("visMarker"+s),
i.style.left=e.touches[o].pageX+"px",i.style.top=e.touches[o].pageY+"px"):(i=document.createElement("div"),i.appendChild(document.createTextNode("#"+s)),i.id="visMarker"+s,i.className="x3dom-touch-marker",document.body.appendChild(i),r=this.visMarkerBag.length,this.visMarkerBag[r]=s),t.push(s)}for(var n=this.visMarkerBag.length-1;n>=0;n--){var a=this.visMarkerBag[n];t.indexOf(a)<0&&(this.visMarkerBag.splice(n,1),i=document.getElementById("visMarker"+a),document.body.removeChild(i))}}}},r=function(e,t){this.isMulti=!0,e.preventDefault(),s.visualizeTouches(e),this.focus(),null==t&&(t=this.parent.doc);var o=t._scene.getNavigationInfo();switch(o.getType()){case"examine":s.examineNavType=1;break;case"turntable":s.examineNavType=2;break;default:s.examineNavType=0}s.lastLayer=[];var r,n;for(r=0;r<e.touches.length;r++)n=this.parent.mousePosition(e.touches[r]),s.lastLayer.push([e.touches[r].identifier,new x3dom.fields.SFVec2f(n.x,n.y)]);if(s.numTouches<1&&1==e.touches.length)s.numTouches=1,s.lastDrag=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY);else if(s.numTouches<2&&e.touches.length>=2){s.numTouches=2;var a=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY),d=new x3dom.fields.SFVec2f(e.touches[1].screenX,e.touches[1].screenY),l=d.subtract(a),h=l.multiply(.5).add(a),u=l.dot(l);s.lastMiddle=h,s.lastSquareDistance=u,s.lastAngle=s.calcAngle(l),s.lastPos=this.parent.mousePosition(e.touches[0])}if(t._scene.updateVolume(),1==s.examineNavType)for(r=0;r<e.touches.length;r++)n=this.parent.mousePosition(e.touches[r]),t.onPick(i.gl,n.x,n.y),t._viewarea.prepareEvents(n.x,n.y,1,"onmousedown"),t._viewarea._pickingInfo.lastClickObj=t._viewarea._pickingInfo.pickObj;else e.touches.length&&(n=this.parent.mousePosition(e.touches[0]),t.onMousePress(i.gl,n.x,n.y,1));t.needRender=!0},n=function(e,t){e.preventDefault(),s.visualizeTouches(e),null==t&&(t=this.parent.doc);var o,r,n,a,d,l,h,u,f=null,_=null;if(1==s.examineNavType){if(1==e.touches.length){var c=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY),m=c.subtract(s.lastDrag);s.lastDrag=c;var p=x3dom.fields.SFMatrix4f.rotationY(m.x/100),x=x3dom.fields.SFMatrix4f.rotationX(m.y/100);_=p.mult(x),t.onMoveView(i.gl,null,_)}else if(e.touches.length>=2){o=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY),r=new x3dom.fields.SFVec2f(e.touches[1].screenX,e.touches[1].screenY),n=r.subtract(o),a=n.multiply(.5).add(o),d=n.dot(n),l=a.subtract(s.lastMiddle),h=d-s.lastSquareDistance,u=new x3dom.fields.SFVec3f(l.x/screen.width,-l.y/screen.height,h/(screen.width*screen.height*.2));var g=s.calcAngle(n),v=s.lastAngle-g;s.lastAngle=g,_=x3dom.fields.SFMatrix4f.rotationZ(v),s.lastMiddle=a,s.lastSquareDistance=d,t.onMoveView(i.gl,u,_)}}else e.touches.length&&(2==s.examineNavType&&e.touches.length>=2?(o=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY),r=new x3dom.fields.SFVec2f(e.touches[1].screenX,e.touches[1].screenY),n=r.subtract(o),d=n.dot(n),h=(d-s.lastSquareDistance)/(.1*(screen.width+screen.height)),s.lastPos.y+=h,s.lastSquareDistance=d,t.onDrag(i.gl,s.lastPos.x,s.lastPos.y,2)):(f=this.parent.mousePosition(e.touches[0]),t.onDrag(i.gl,f.x,f.y,1)));t.needRender=!0},a=function(e,t){this.isMulti=!1,e.preventDefault(),s.visualizeTouches(e),null==t&&(t=this.parent.doc),t._viewarea._isMoving=!1,2==s.numTouches&&1==e.touches.length&&(s.lastDrag=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY));var o=!1;if(e.touches.length<2&&(1==s.numTouches&&(o=!0),s.numTouches=e.touches.length),1==s.examineNavType){for(var r=0;r<s.lastLayer.length;r++){var n=s.lastLayer[r][1];if(t.onPick(i.gl,n.x,n.y),"box"!==t._scene._vf.pickMode.toLowerCase())t._viewarea.prepareEvents(n.x,n.y,1,"onmouseup"),t._viewarea._pickingInfo.lastClickObj=t._viewarea._pickingInfo.pickObj,t._viewarea._pickingInfo.pickObj&&t._viewarea._pickingInfo.pickObj===t._viewarea._pickingInfo.lastClickObj&&t._viewarea.prepareEvents(n.x,n.y,1,"onclick");else{var a=t._viewarea.calcViewRay(n.x,n.y),d=t._scene.doIntersect(a),l=a.hitObject;d&&l&&(t._viewarea._pick.setValues(a.hitPoint),t._viewarea.checkEvents(l,n.x,n.y,1,"onclick"),x3dom.debug.logInfo("Hit '"+l._xmlNode.localName+"/ "+l._DEF+"' at pos "+t._viewarea._pick))}}if(o){var h=(new Date).getTime(),u=s.firstTouchPoint.subtract(s.lastDrag).length();18>u&&h-s.firstTouchTime<180&&t.onDoubleClick(i.gl,0,0),s.firstTouchTime=h,s.firstTouchPoint=s.lastDrag}}else s.lastLayer.length&&(n=s.lastLayer[0][1],t.onMouseRelease(i.gl,n.x,n.y,0,1));t.needRender=!0};this.disableTouch||(this.canvas.addEventListener("touchstart",r,!0),this.canvas.addEventListener("touchmove",n,!0),this.canvas.addEventListener("touchend",a,!0))}},x3dom.X3DCanvas.prototype._initContext=function(e,t,i,o,s){x3dom.debug.logInfo("Initializing X3DCanvas for ["+e.id+"]");var r=x3dom.gfx_webgl(e,t,i,s,this.x3dElem);if(!r)return x3dom.debug.logError("No 3D context found..."),this.x3dElem.removeChild(e),null;var n=parseFloat(x3dom.caps.VERSION.match(/\d+\.\d+/)[0]);if(1>n){if(console.log(o),o)return x3dom.debug.logError("No valid 3D context found..."),this.x3dElem.removeChild(e),null;x3dom.debug.logError("WebGL version "+x3dom.caps.VERSION+" lacks important WebGL/GLSL features needed for shadows, special vertex attribute types, etc.!")}return r},x3dom.X3DCanvas.prototype._initFlashContext=function(e,t){return x3dom.debug.logInfo("Initializing X3DObject for ["+e.id+"]"),x3dom.gfx_flash(e,t)},x3dom.X3DCanvas.prototype.appendParam=function(e,t,i){var o=document.createElement("param");o.setAttribute("name",t),o.setAttribute("value",i),e.appendChild(o)},x3dom.X3DCanvas.prototype._fileExists=function(e){var t=new XMLHttpRequest;try{return t.open("HEAD",e,!1),t.send(null),404!=t.status}catch(i){return!0}},x3dom.X3DCanvas.prototype._detectFlash=function(e,t){var i=e,o=t,s=0;if("object"==_typeof(navigator.plugins["Shockwave Flash"])){var r=navigator.plugins["Shockwave Flash"].description;s=r.substr(16,r.indexOf(".",16)-16)}else if("function"==typeof ActiveXObject)for(var n=10;o+1>n;n++)try{"object"==_typeof(new ActiveXObject("ShockwaveFlash.ShockwaveFlash."+n))&&(s=n+1)}catch(a){}return[s,i]},x3dom.X3DCanvas.prototype._createInitFailedDiv=function(e){var t=document.createElement("div");t.setAttribute("id","x3dom-create-init-failed"),t.style.width=e.getAttribute("width"),t.style.height=e.getAttribute("height"),t.style.backgroundColor="#C00",t.style.color="#FFF",t.style.fontSize="20px",t.style.fontWidth="bold",t.style.padding="10px 10px 10px 10px",t.style.display="inline-block",t.style.fontFamily="Helvetica",t.style.textAlign="center",t.appendChild(document.createTextNode("Your Browser does not support X3DOM")),t.appendChild(document.createElement("br")),t.appendChild(document.createTextNode("Read more about Browser support on:")),t.appendChild(document.createElement("br"));var i=document.createElement("a");i.setAttribute("href","http://www.x3dom.org/?page_id=9"),i.appendChild(document.createTextNode("X3DOM | Browser Support")),t.appendChild(i);var o=e.getAttribute("altImg")||null;if(o){var s=new Image;s.src=o,t.style.backgroundImage="url("+o+")",t.style.backgroundRepeat="no-repeat",t.style.backgroundPosition="50% 50%"}e.appendChild(t),x3dom.debug.logError("Your Browser does not support X3DOM!")},x3dom.X3DCanvas.prototype._createFlashObject=function(e){var t=this._detectFlash(11,11);if(!t[0]||t[0]<t[1])return null;x3dom.debug.logInfo("Creating FlashObject for (X)3D element...");var i=this.x3dElem.getAttribute("id");if(null!==i)i="x3dom-"+i+"-object";else{var o=(new Date).getTime();i="x3dom-"+o+"-object"}var s=this.x3dElem.getAttribute("swfpath");if(null===s&&(s="x3dom.swf"),!this._fileExists(s)){var r;if(void 0===x3dom.versionInfo||-1!=x3dom.versionInfo.version.indexOf("dev"))r="dev";else{r=x3dom.versionInfo.version;var n=r.substr(r.length-1);0==n&&(r=r.substr(0,3))}s="http://www.x3dom.org/download/"+r+"/x3dom.swf",x3dom.debug.logWarning("Can't find local x3dom.swf ("+r+"). X3DOM now using the online version from x3dom.org.The online version needs a <a href='http://examples.x3dom.org/crossdomain.xml'>crossdomain.xml</a> file in the root directory of your domain to access textures")}var a=this.x3dElem.getAttribute("width"),d=-1;null==a?a=550:(d=a.indexOf("px"),-1!=d&&(a=a.substr(0,d)));var l=this.x3dElem.getAttribute("height");null==l?l=400:(d=l.indexOf("px"),-1!=d&&(l=l.substr(0,d)));var h=this.x3dElem.getAttribute("flashrenderer");this.flash_renderType=null==h?"forward":"deferred";var u=document.createElement("object");return u.setAttribute("width","100%"),u.setAttribute("height","100%"),u.setAttribute("id",i),!document.doctype||document.doctype&&document.doctype.publicId&&-1!=document.doctype.publicId.search(/DTD XHTML/i)?(x3dom.debug.logWarning("Flash backend doesn't like XHTML, please use HTML5!"),u.setAttribute("style","width:"+a+"px; height:"+l+"px;")):null==e.getAttribute("style")&&e.setAttribute("style","width:"+a+"px; height:"+l+"px;"),this.appendParam(u,"menu","false"),this.appendParam(u,"quality","high"),this.appendParam(u,"wmode","direct"),this.appendParam(u,"allowScriptAccess","always"),this.appendParam(u,"flashvars","canvasIdx="+this._canvasIdx+"&renderType="+this.flash_renderType),this.appendParam(u,"movie",s),"Microsoft Internet Explorer"==navigator.appName?(e.appendChild(u),u.setAttribute("classid","clsid:d27cdb6e-ae6d-11cf-96b8-444553540000")):(u.setAttribute("type","application/x-shockwave-flash"),u.setAttribute("data",s),e.appendChild(u)),u},x3dom.X3DCanvas.prototype._createHTMLCanvas=function(e){x3dom.debug.logInfo("Creating canvas for (X)3D element...");var t=document.createElement("canvas");t.setAttribute("class","x3dom-canvas");var i=e.getAttribute("style");i&&x3dom.debug.logInfo("Inline X3D styles detected");for(var o=["onmousedown","onmousemove","onmouseout","onmouseover","onmouseup","onclick","ondblclick","onkeydown","onkeypress","onkeyup","ontouchstart","ontouchmove","ontouchend","ontouchcancel","ontouchleave","ontouchenter","ondragstart","ondrop","ondragover"],s=0;s<o.length;s++){var r=o[s],n=e.getAttribute(r);n&&(x3dom.debug.logInfo(r+", "+n),t.setAttribute(r,n),e.removeAttribute(r))}var a=e.getAttribute("draggable");a&&(x3dom.debug.logInfo("draggable="+a),t.setAttribute("draggable",a)),e.__addEventListener||e.__removeEventListener||(e.__addEventListener=e.addEventListener,e.__removeEventListener=e.removeEventListener,e.addEventListener=function(e,i,s){var r,n=!1;for(r=0;r<o.length&&!n;r++)o[r]===e&&(n=!0);n?(x3dom.debug.logInfo("addEventListener for div.on"+e),t.addEventListener(e,i,s)):(x3dom.debug.logInfo("addEventListener for X3D.on"+e),this.__addEventListener(e,i,s))},e.removeEventListener=function(e,i,s){var r,n=!1;for(r=0;r<o.length&&!n;r++)o[r]===e&&(n=!0);n?(x3dom.debug.logInfo("removeEventListener for div.on"+e),t.removeEventListener(e,i,s)):(x3dom.debug.logInfo("removeEventListener for X3D.on"+e),this.__removeEventListener(e,i,s))}),e.hasAttribute("ondownloadsfinished")&&e.addEventListener("downloadsfinished",function(){var t={target:e,type:"downloadsfinished"},i=e.getAttribute("ondownloadsfinished"),o=new Function("event",i);o.call(e,t)},!0),e.appendChild(t);var d=e.getAttribute("id");if(null!==d)t.id="x3dom-"+d+"-canvas";else{var l=(new Date).getTime();t.id="x3dom-"+l+"-canvas"}var h,u;return null!==(h=e.getAttribute("width"))&&(h.indexOf("%")>=0&&x3dom.debug.logWarning("The width attribute is to be specified in pixels not in percent."),t.style.width=h,t.setAttribute("width",h)),null!==(u=e.getAttribute("height"))&&(u.indexOf("%")>=0&&x3dom.debug.logWarning("The height attribute is to be specified in pixels not in percent."),t.style.height=u,t.setAttribute("height",u)),t.setAttribute("tabindex","0"),t},x3dom.X3DCanvas.prototype._watchForResize=function(){var e=[parseInt(x3dom.getStyle(this.canvas,"width")),parseInt(x3dom.getStyle(this.canvas,"height"))];(this._current_dim[0]!=e[0]||this._current_dim[1]!=e[1])&&(this._current_dim=e,this.x3dElem.setAttribute("width",e[0]+"px"),this.x3dElem.setAttribute("height",e[1]+"px"))},x3dom.X3DCanvas.prototype._createProgressDiv=function(){var e=document.createElement("div");e.setAttribute("class","x3dom-progress");var t=document.createElement("strong");t.appendChild(document.createTextNode("Loading...")),e.appendChild(t);var i=document.createElement("span");return i.setAttribute("style","width: 25%;"),i.appendChild(document.createTextNode(" ")),e.appendChild(i),e.oncontextmenu=e.onmousedown=function(e){return e.preventDefault(),e.stopPropagation(),!1},e},x3dom.X3DCanvas.prototype.mousePosition=function(e){var t=0,i=0;if("getBoundingClientRect"in document.documentElement){var o=e.target.offsetParent,s=o.getBoundingClientRect(),r=window.pageXOffset||document.documentElement.scrollLeft,n=window.pageYOffset||document.documentElement.scrollTop,a=document.defaultView.getComputedStyle(o,null),d=parseFloat(a.getPropertyValue("padding-left")),l=parseFloat(a.getPropertyValue("border-left-width")),h=parseFloat(a.getPropertyValue("padding-top")),u=parseFloat(a.getPropertyValue("border-top-width"));t=Math.round(e.pageX-(s.left+d+l+r)),i=Math.round(e.pageY-(s.top+h+u+n))}else x3dom.debug.logError("NO getBoundingClientRect");return new x3dom.fields.SFVec2f(t,i)},x3dom.X3DCanvas.prototype.tick=function(){var e=this,t=this.x3dElem.runtime,i=(new Date).getTime(),o=i-this.lastTimeFPSWasTaken,s=1e3/(i-this.fps_t0);this.fps_t0=i,this.doc.advanceTime(i/1e3);var r=(new Date).getTime()-i;if(this.doc.needRender&&(o>=1e3&&(t.fps=this.framesSinceLastTime/(o/1e3),t.addMeasurement("FPS",t.fps),this.framesSinceLastTime=0,this.lastTimeFPSWasTaken=i),this.framesSinceLastTime++,t.addMeasurement("ANIM",r),0==t.isReady&&(t.ready(),t.isReady=!0),t.enterFrame(),"flash"==this.backend?this.isFlashReady&&(this.canvas.setFPS({fps:s}),this.doc.needRender=!1,this.doc.render(this.gl)):(this.doc.needRender=!1,this.doc.render(this.gl),this.doc._scene._vf.doPickPass||t.removeMeasurement("PICKING")),t.exitFrame()),this.progressDiv&&(this.doc.downloadCount>0?t.addInfo("#LOADS:",this.doc.downloadCount):t.removeInfo("#LOADS:"),"false"!==this.doc.properties.getProperty("showProgress")?this.progressDiv&&(this.progressDiv.childNodes[0].textContent="Loading: "+ +this.doc.downloadCount,this.progressDiv.style.display=this.doc.downloadCount>0?"inline":"none"):this.progressDiv.style.display="none"),0==this.doc.downloadCount&&this.doc.previousDownloadCount>0){var n;document.createEvent?(n=document.createEvent("Events"),n.initEvent("downloadsfinished",!0,!0),e.x3dElem.dispatchEvent(n)):document.createEventObject&&(n=document.createEventObject(),e.x3dElem.fireEvent("ondownloadsfinished",n))}this.doc.previousDownloadCount=this.doc.downloadCount},x3dom.X3DCanvas.prototype.load=function(e,t,i){this.doc=new x3dom.X3DDocument(this.canvas,this.gl,i);var o=this;this.doc.onload=function(){o.hasRuntime?!function e(){o.doc&&o.x3dElem.runtime&&(o._watchForResize(),o.tick(),window.requestAnimFrame(e,o))}():o.tick()},this.x3dElem.render=function(){o.hasRuntime?o.doc.needRender=!0:o.doc.render(o.gl)},this.x3dElem.context=o.gl.ctx3d,this.doc.onerror=function(){alert("Failed to load X3D document")},this.doc.load(e,t)},x3dom.runtime={},x3dom.Runtime=function(e,t){this.doc=e,this.canvas=t,this.config={},this.isReady=!1,this.fps=0,this.states={measurements:[],infos:[]}},x3dom.Runtime.prototype.addMeasurement=function(e,t){this.states.measurements[e]=t},x3dom.Runtime.prototype.removeMeasurement=function(e){this.states.measurements[e]&&delete this.states.measurements[e]},x3dom.Runtime.prototype.addInfo=function(e,t){this.states.infos[e]=t},x3dom.Runtime.prototype.removeInfo=function(e){delete this.states.infos[e]},x3dom.Runtime.prototype.initialize=function(e,t){this.doc=e,this.canvas=t,this.config={},this.isReady=!1,this.fps=0},x3dom.Runtime.prototype.noBackendFound=function(){x3dom.debug.logInfo("No backend found. Unable to render.")},x3dom.Runtime.prototype.ready=function(){x3dom.debug.logInfo("System ready.")},x3dom.Runtime.prototype.enterFrame=function(){},x3dom.Runtime.prototype.exitFrame=function(){},x3dom.Runtime.prototype.triggerRedraw=function(){this.canvas.doc.needRender=!0},x3dom.Runtime.prototype.getActiveBindable=function(e){var t,i,o,s,r;if(t=this.canvas.doc._bindableBag._stacks,s=[],r=x3dom.nodeTypesLC[e.toLowerCase()],!r)return x3dom.debug.logError('No node of type "'+e+'" found.'),null;for(i=0;i<t.length;i++)o=t[i].getActive(),void 0!==o._xmlNode&&x3dom.isa(o,r)&&s.push(o);return s[0]?s[0]._xmlNode:null},x3dom.Runtime.prototype.nextView=function(){var e=this.canvas.doc._scene.getViewpoint()._stack;e?e.switchTo("next"):x3dom.debug.logError("No valid ViewBindable stack.")},x3dom.Runtime.prototype.prevView=function(){var e=this.canvas.doc._scene.getViewpoint()._stack;e?e.switchTo("prev"):x3dom.debug.logError("No valid ViewBindable stack.")},x3dom.Runtime.prototype.viewpoint=function(){return this.canvas.doc._scene.getViewpoint()},x3dom.Runtime.prototype.viewMatrix=function(){return this.canvas.doc._viewarea.getViewMatrix()},x3dom.Runtime.prototype.projectionMatrix=function(){return this.canvas.doc._viewarea.getProjectionMatrix()},x3dom.Runtime.prototype.getWorldToCameraCoordinatesMatrix=function(){return this.canvas.doc._viewarea.getWCtoCCMatrix()},x3dom.Runtime.prototype.getCameraToWorldCoordinatesMatrix=function(){return this.canvas.doc._viewarea.getCCtoWCMatrix()},x3dom.Runtime.prototype.getViewingRay=function(e,t){return this.canvas.doc._viewarea.calcViewRay(e,t)},x3dom.Runtime.prototype.shootRay=function(e,t){var i=this.canvas.doc,o=i._viewarea._pickingInfo;return i.onPick(this.canvas.gl,e,t),{pickPosition:o.pickObj?o.pickPos:null,pickNormal:o.pickObj?o.pickNorm:null,pickObject:o.pickObj?o.pickObj._xmlNode:null}},x3dom.Runtime.prototype.getWidth=function(){return this.canvas.doc._viewarea._width},x3dom.Runtime.prototype.getHeight=function(){return this.canvas.doc._viewarea._height},x3dom.Runtime.prototype.mousePosition=function(e){var t=this.canvas.mousePosition(e);return[t.x,t.y]},x3dom.Runtime.prototype.calcCanvasPos=function(e,t,i){var o=new x3dom.fields.SFVec3f(e,t,i),s=this.canvas.doc._viewarea.getWCtoCCMatrix(),r=s.multFullMatrixPnt(o),n=this.canvas.doc._viewarea._width,a=this.canvas.doc._viewarea._height,d=Math.round((r.x+1)*(n-1)/2),l=Math.round((a-1)*(1-r.y)/2);return[d,l]},x3dom.Runtime.prototype.calcPagePos=function(e,t,i){var o=this.canvas.canvas.offsetParent;if(!o)return x3dom.debug.logError("Can't calc page pos without offsetParent."),[0,0];var s=o.getBoundingClientRect(),r=this.calcCanvasPos(e,t,i),n=window.pageXOffset||document.body.scrollLeft,a=window.pageYOffset||document.body.scrollTop,d=document.defaultView.getComputedStyle(o,null),l=parseFloat(d.getPropertyValue("padding-left")),h=parseFloat(d.getPropertyValue("border-left-width")),u=parseFloat(d.getPropertyValue("padding-top")),f=parseFloat(d.getPropertyValue("border-top-width")),_=s.left+l+h+n+r[0],c=s.top+u+f+a+r[1];return[_,c]},x3dom.Runtime.prototype.calcClientPos=function(e,t,i){var o=this.canvas.canvas.offsetParent;if(!o)return x3dom.debug.logError("Can't calc client pos without offsetParent."),[0,0];var s=o.getBoundingClientRect(),r=this.calcCanvasPos(e,t,i),n=document.defaultView.getComputedStyle(o,null),a=parseFloat(n.getPropertyValue("padding-left")),d=parseFloat(n.getPropertyValue("border-left-width")),l=parseFloat(n.getPropertyValue("padding-top")),h=parseFloat(n.getPropertyValue("border-top-width")),u=s.left+a+d+r[0],f=s.top+l+h+r[1];return[u,f]},x3dom.Runtime.prototype.getScreenshot=function(){var e="",t=this.canvas.backend,i=this.canvas.canvas;if(i)if("flash"==t)e=i.getScreenshot();else{var o=document.createElement("canvas");o.width=i.width,o.height=i.height;var s=o.getContext("2d");s.drawImage(i,0,0,i.width,i.height),s.scale(1,-1),s.translate(0,-i.height),e=o.toDataURL()}return e},x3dom.Runtime.prototype.getCanvas=function(){return this.canvas.canvas},x3dom.Runtime.prototype.lightMatrix=function(){this.canvas.doc._viewarea.getLightMatrix()},x3dom.Runtime.prototype.resetView=function(){this.canvas.doc._viewarea.resetView()},x3dom.Runtime.prototype.lightView=function(){return this.canvas.doc._nodeBag.lights.length>0?(this.canvas.doc._viewarea.animateTo(this.canvas.doc._viewarea.getLightMatrix()[0],this.canvas.doc._scene.getViewpoint()),!0):(x3dom.debug.logInfo("No lights to navigate to."),!1)},x3dom.Runtime.prototype.uprightView=function(){this.canvas.doc._viewarea.uprightView()},x3dom.Runtime.prototype.fitAll=function(e){void 0===e&&(e=!0);var t=this.canvas.doc._scene;t.updateVolume(),this.canvas.doc._viewarea.fit(t._lastMin,t._lastMax,e)},x3dom.Runtime.prototype.fitObject=function(e,t){if(e&&e._x3domNode){void 0===t&&(t=!0);var i=x3dom.fields.SFVec3f.MAX(),o=x3dom.fields.SFVec3f.MIN(),s=e._x3domNode.getVolume();s.getBounds(i,o);var r=e._x3domNode.getCurrentTransform();if(i=r.multMatrixPnt(i),o=r.multMatrixPnt(o),x3dom.isa(e._x3domNode,x3dom.nodeTypes.X3DTransformNode)){var n=e._x3domNode._trafo.inverse();i=n.multMatrixPnt(i),o=n.multMatrixPnt(o)}this.canvas.doc._viewarea.fit(i,o,t)}},x3dom.Runtime.prototype.showAll=function(e){this.canvas.doc._viewarea.showAll(e)},x3dom.Runtime.prototype.showObject=function(e){if(e&&e._x3domNode){var t=x3dom.fields.SFVec3f.MAX(),i=x3dom.fields.SFVec3f.MIN(),o=e._x3domNode.getVolume();o.getBounds(t,i);var s=e._x3domNode.getCurrentTransform();t=s.multMatrixPnt(t),i=s.multMatrixPnt(i);var r=this.canvas.doc._viewarea,n=r._width<r._height?r._width:r._height,a=new x3dom.fields.SFVec3f(0,0,1),d=this.canvas.doc._scene.getViewpoint(),l=d.getFieldOfView()/2,h=Math.tan(l);Math.abs(h)>x3dom.fields.Eps&&(n/=h);var u=r._width-1,f=r._height-1,_=.25,c=new x3dom.fields.SFVec2f(_*u,_*f);_=.75;var m=new x3dom.fields.SFVec2f(_*u,_*f),p=i.subtract(t).multiply(.5),x=p.length(),g=t.add(p),v=m.subtract(c).multiply(.5),y=1.5*v.length();v=v.add(c);var b=1;y>x3dom.fields.Eps&&(b=x/y*Math.sqrt(v.x*v.x+v.y*v.y+n*n)),a=s.multMatrixVec(a).normalize(),a=a.multiply(b);var T=g.add(a),S=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,1),a),M=S.toMatrix(),C=x3dom.fields.SFMatrix4f.translation(T.negate()),F=x3dom.fields.SFMatrix4f.translation(T);F=F.mult(M).mult(C).mult(F);var E=F.inverse();r.animateTo(E,d)}},x3dom.Runtime.prototype.getCenter=function(e){return e&&e._x3domNode&&(this.isA(e,"X3DShapeNode")||this.isA(e,"X3DGeometryNode"))?e._x3domNode.getCenter():null},x3dom.Runtime.prototype.getCurrentTransform=function(e){return e&&e._x3domNode?e._x3domNode.getCurrentTransform():null},x3dom.Runtime.prototype.getBBox=function(e){if(e&&e._x3domNode&&this.isA(e,"X3DBoundedObject")){var t=e._x3domNode.getVolume();return{min:x3dom.fields.SFVec3f.copy(t.min),max:x3dom.fields.SFVec3f.copy(t.max)}}return null},x3dom.Runtime.prototype.getSceneBBox=function(){var e=this.canvas.doc._scene;return e.updateVolume(),{min:x3dom.fields.SFVec3f.copy(e._lastMin),max:x3dom.fields.SFVec3f.copy(e._lastMax)}},x3dom.Runtime.prototype.debug=function(e){var t=this.canvas.doc;return void 0===t._viewarea._visDbgBuf&&(t._viewarea._visDbgBuf="true"===t._x3dElem.getAttribute("showLog")),arguments.length>0?e===!0?(t._viewarea._visDbgBuf=!0,x3dom.debug.logContainer.style.display="block"):(t._viewarea._visDbgBuf=!1,x3dom.debug.logContainer.style.display="none"):(t._viewarea._visDbgBuf=!t._viewarea._visDbgBuf,x3dom.debug.logContainer.style.display=1==t._viewarea._visDbgBuf?"block":"none"),t.needRender=!0,t._viewarea._visDbgBuf},x3dom.Runtime.prototype.navigationType=function(){return this.canvas.doc._scene.getNavigationInfo().getType()},x3dom.Runtime.prototype.noNav=function(){this.canvas.doc._scene.getNavigationInfo().setType("none")},x3dom.Runtime.prototype.examine=function(){this.canvas.doc._scene.getNavigationInfo().setType("examine")},x3dom.Runtime.prototype.turnTable=function(){this.canvas.doc._scene.getNavigationInfo().setType("turntable")},x3dom.Runtime.prototype.fly=function(){this.canvas.doc._scene.getNavigationInfo().setType("fly")},x3dom.Runtime.prototype.freeFly=function(){this.canvas.doc._scene.getNavigationInfo().setType("freefly")},x3dom.Runtime.prototype.lookAt=function(){this.canvas.doc._scene.getNavigationInfo().setType("lookat")},x3dom.Runtime.prototype.lookAround=function(){this.canvas.doc._scene.getNavigationInfo().setType("lookaround")},x3dom.Runtime.prototype.walk=function(){this.canvas.doc._scene.getNavigationInfo().setType("walk")},x3dom.Runtime.prototype.game=function(){this.canvas.doc._scene.getNavigationInfo().setType("game")},x3dom.Runtime.prototype.helicopter=function(){this.canvas.doc._scene.getNavigationInfo().setType("helicopter")},x3dom.Runtime.prototype.resetExamin=function(){var e=this.canvas.doc._viewarea;e._rotMat=x3dom.fields.SFMatrix4f.identity(),e._transMat=x3dom.fields.SFMatrix4f.identity(),e._movement=new x3dom.fields.SFVec3f(0,0,0),e._needNavigationMatrixUpdate=!0,this.canvas.doc.needRender=!0},x3dom.Runtime.prototype.disableKeys=function(){this.canvas.disableKeys=!0},x3dom.Runtime.prototype.enableKeys=function(){this.canvas.disableKeys=!1},x3dom.Runtime.prototype.disableLeftDrag=function(){this.canvas.disableLeftDrag=!0},x3dom.Runtime.prototype.enableLeftDrag=function(){this.canvas.disableLeftDrag=!1},x3dom.Runtime.prototype.disableRightDrag=function(){this.canvas.disableRightDrag=!0},x3dom.Runtime.prototype.enableRightDrag=function(){this.canvas.disableRightDrag=!1},x3dom.Runtime.prototype.disableMiddleDrag=function(){this.canvas.disableMiddleDrag=!0},x3dom.Runtime.prototype.enableMiddleDrag=function(){this.canvas.disableMiddleDrag=!1},x3dom.Runtime.prototype.togglePoints=function(e){var t=this.canvas.doc,i=e===!0?3:2;return t._viewarea._points=++t._viewarea._points%i,t.needRender=!0,t._viewarea._points},x3dom.Runtime.prototype.pickRect=function(e,t,i,o){return this.canvas.doc.onPickRect(this.canvas.gl,e,t,i,o)},x3dom.Runtime.prototype.pickMode=function(e){return e&&e.internal===!0?this.canvas.doc._scene._vf.pickMode:this.canvas.doc._scene._vf.pickMode.toLowerCase()},x3dom.Runtime.prototype.changePickMode=function(e){switch(e=e.toLowerCase()){case"idbuf":e="idBuf";break;case"idbuf24":e="idBuf24";break;case"idbufid":e="idBufId";break;case"texcoord":e="texCoord";break;case"color":e="color";break;case"box":e="box";break;default:x3dom.debug.logWarning("Switch pickMode to "+e+" unknown intersect type"),e=void 0}return void 0!==e?(this.canvas.doc._scene._vf.pickMode=e,x3dom.debug.logInfo("Switched pickMode to '"+e+"'."),!0):!1},x3dom.Runtime.prototype.speed=function(e){var t=this.canvas.doc._scene.getNavigationInfo();return e&&(t._vf.speed=e,x3dom.debug.logInfo("Changed navigation speed to "+t._vf.speed)),t._vf.speed},x3dom.Runtime.prototype.statistics=function(e){var t=this.canvas.stateViewer;return t?(this.canvas.doc.needRender=!0,e===!0?(t.display(e),!0):e===!1?(t.display(e),!1):(t.display(!t.active),t.active)):!1},x3dom.Runtime.prototype.processIndicator=function(e){var t=this.canvas.progressDiv;return t?e===!0?(t.style.display="inline",!0):e===!1?(t.style.display="none",!1):"none"!=t.style.display:!1},x3dom.Runtime.prototype.properties=function(){return this.canvas.doc.properties},x3dom.Runtime.prototype.backendName=function(){return this.canvas.backend},x3dom.Runtime.prototype.getFPS=function(){return this.fps},x3dom.Runtime.prototype.isA=function(e,t){var i=!1;return t&&e&&e._x3domNode&&(""===t&&(t="X3DNode"),i=x3dom.isa(e._x3domNode,x3dom.nodeTypesLC[t.toLowerCase()])),i},x3dom.detectActiveX=function(){var e=!1;if(window.ActiveXObject){var t=null;try{t=new ActiveXObject("AVALONATX.InstantPluginATXCtrl.1")}catch(i){}t&&(e=!0)}return e},x3dom.rerouteSetAttribute=function(e,t){e._setAttribute=e.setAttribute,e.setAttribute=function(i,o){var s=e.getAttribute("_x3domNode"),r=t.findNode(s);return r?r.parseField(i,o):0};for(var i=0;i<e.childNodes.length;i++){var o=e.childNodes[i];x3dom.rerouteSetAttribute(o,t)}},x3dom.insertActiveX=function(e){"undefined"==typeof x3dom.atxCtrlCounter&&(x3dom.atxCtrlCounter=0);var t=e.getAttribute("height"),i=e.getAttribute("width"),o=e.parentNode,s=document.createElement("div");s.setAttribute("id","x3dplaceholder");var r=o.insertBefore(s,e),n=document.createElement("div");n.style.display="none",o.appendChild(n),o.removeChild(e),n.appendChild(e);var a=document.createElement("object"),d="Avalon"+x3dom.atxCtrlCounter;x3dom.atxCtrlCounter++,a.setAttribute("id",d),a.setAttribute("classid","CLSID:F3254BA0-99FF-4D14-BD81-EDA9873A471E"),a.setAttribute("width",i?i:"500"),a.setAttribute("height",t?t:"500"),r.appendChild(a);var l=document.getElementById(d),h=l.getBrowser(),u=h.importDocument(e);h.replaceWorld(u),e.getBrowser=function(){return l.getBrowser()},x3dom.rerouteSetAttribute(e,h)},x3dom.userAgentFeature={supportsDOMAttrModified:!1},function(){var e=function(){var e,t,i=document.getElementsByTagName("X3D"),o=[];for(e=0;e<i.length;e++)void 0===i[e].hasRuntime&&o.push(i[e]);var s,r,n,a=new x3dom.Properties,d=array_to_object(["showLog","showStat","showProgress","PrimitiveQuality","components","loadpath","disableDoubleClick","backend","altImg","flashrenderer","swfpath","runtimeEnabled","keysEnabled","showTouchpoints","disableTouch","maxActiveDownloads"]),l=!1;for(e=0;e<o.length;e++){for(a.setProperty("showLog",o[e].getAttribute("showLog")||"false"),a.setProperty("showStat",o[e].getAttribute("showStat")||"false"),a.setProperty("showProgress",o[e].getAttribute("showProgress")||"true"),a.setProperty("PrimitiveQuality",o[e].getAttribute("PrimitiveQuality")||"High"),s=o[e].getElementsByTagName("PARAM"),t=0;t<s.length;t++)s[t].getAttribute("name")in d&&a.setProperty(s[t].getAttribute("name"),s[t].getAttribute("value"));if("true"===a.getProperty("showLog")&&(l=!0),"undefined"!=typeof X3DOM_SECURITY_OFF&&X3DOM_SECURITY_OFF===!0){if(r=a.getProperty("components",o[e].getAttribute("components")))for(n=a.getProperty("loadpath",o[e].getAttribute("loadpath")),r=r.trim().split(","),t=0;t<r.length;t++)x3dom.loadJS(r[t]+".js",n);if(o[e].getAttribute("src")){var h=document.createElement("scene"),u=document.createElement("Inline");u.setAttribute("url",o[e].getAttribute("src")),h.appendChild(u),o[e].appendChild(h)}}}x3dom.debug.activate(1==l?!0:!1),o=Array.map(o,function(e){return e.hasRuntime=!0,e});var f=document.getElementsByTagName("webSG");for(e=0;e<f.length;e++)f[e].hasRuntime=!1,o.push(f[e]);void 0!==x3dom.versionInfo&&x3dom.debug.logInfo("X3DOM version "+x3dom.versionInfo.version+", Revison <a href='https://github.com/x3dom/x3dom/tree/"+x3dom.versionInfo.revision+"'>"+x3dom.versionInfo.revision+"</a>, Date "+x3dom.versionInfo.date),x3dom.debug.logInfo("Found "+(o.length-f.length)+" X3D and "+f.length+" (experimental) WebSG nodes...");var _,c,m,p,x,g,v;for(e=0;e<o.length;e++)_=o[e],x3dom.detectActiveX()?x3dom.insertActiveX(_):(c=new x3dom.X3DCanvas(_,x3dom.canvases.length),x3dom.canvases.push(c),null!==c.gl?(g=(new Date).getTime(),o[e].runtime=new x3dom.Runtime(o[e],c),o[e].runtime.initialize(o[e],c),x3dom.runtime.ready&&(o[e].runtime.ready=x3dom.runtime.ready),""==c.backend&&x3dom.runtime.noBackendFound(),c.load(o[e],e,a),o[e].runtime.statistics("true"===a.getProperty("showStat")?!0:!1),"true"===a.getProperty("showProgress")?("bar"===a.getProperty("showProgress")&&c.progressDiv.setAttribute("class","x3dom-progress bar"),o[e].runtime.processIndicator(!0)):o[e].runtime.processIndicator(!1),v=(new Date).getTime()-g,x3dom.debug.logInfo("Time for setup and init of GL element no. "+e+": "+v+" ms.")):(m=document.createElement("div"),m.setAttribute("class","x3dom-nox3d"),m.setAttribute("id","x3dom-nox3d"),p=document.createElement("p"),p.appendChild(document.createTextNode("WebGL is not yet supported in your browser. ")),x=document.createElement("a"),x.setAttribute("href","http://www.x3dom.org/?page_id=9"),x.appendChild(document.createTextNode("Follow link for a list of supported browsers... ")),m.appendChild(p),m.appendChild(x),c.x3dElem.appendChild(m),c.stateViewer&&_.removeChild(c.stateViewer.viewer)));!function(e){var t=null;document.createEvent?(t=document.createEvent("Events"),t.initEvent(e,!0,!0),
document.dispatchEvent(t)):document.createEventObject&&(t=document.createEventObject(),document.body.fireEvent("on"+e,t))}("load")},t=function(){if(x3dom.canvases){for(var e=0;e<x3dom.canvases.length;e++)x3dom.canvases[e].doc.shutdown(x3dom.canvases[e].gl);x3dom.canvases=[]}};x3dom.reload=function(){e()},-1!=navigator.userAgent.indexOf("Chrome")?(document.__getElementsByTagName=document.getElementsByTagName,document.getElementsByTagName=function(e){var t=[],i=this.__getElementsByTagName("*");if("*"==e)t=i;else{e=e.toUpperCase();for(var o=0;o<i.length;o++){var s=i[o].tagName.toUpperCase();s===e&&t.push(i[o])}}return t},document.__getElementById=document.getElementById,document.getElementById=function(e){var t=this.__getElementById(e);if(!t)for(var i=this.__getElementsByTagName("*"),o=0;o<i.length&&!t;o++)i[o].getAttribute("id")===e&&(t=i[o]);return t}):(document.__getElementById=document.getElementById,document.getElementById=function(e){var t=this.__getElementById(e);if(!t)for(var i=this.getElementsByTagName("*"),o=0;o<i.length&&!t;o++)i[o].getAttribute("id")===e&&(t=i[o]);return t}),window.addEventListener?(window.addEventListener("load",e,!1),window.addEventListener("unload",t,!1),window.addEventListener("reload",t,!1)):window.attachEvent&&(window.attachEvent("onload",e),window.attachEvent("onunload",t),window.attachEvent("onreload",t)),"complete"===document.readyState&&window.setTimeout(function(){e()},20)}(),x3dom.Cache=function(){this.textures=[],this.shaders=[]},x3dom.Cache.prototype.getTexture2D=function(e,t,i,o,s,r,n){var a=i;return void 0===this.textures[a]&&(this.textures[a]=x3dom.Utils.createTexture2D(e,t,i,o,s,r,n)),this.textures[a]},x3dom.Cache.prototype.getTexture2DByDEF=function(e,t,i){var o=t.name+"_"+i;return void 0===this.textures[o]&&(this.textures[o]=e.createTexture()),this.textures[o]},x3dom.Cache.prototype.getTextureCube=function(e,t,i,o,s,r,n){for(var a="",d=0;d<i.length;++d)a+=i[d]+"|";return void 0===this.textures[a]&&(this.textures[a]=x3dom.Utils.createTextureCube(e,t,i,o,s,r,n)),this.textures[a]},x3dom.Cache.prototype.getShader=function(e,t){var i=null;if(void 0===this.shaders[t]){switch(t){case x3dom.shader.PICKING:i=new x3dom.shader.PickingShader(e);break;case x3dom.shader.PICKING_24:i=new x3dom.shader.Picking24Shader(e);break;case x3dom.shader.PICKING_ID:i=new x3dom.shader.PickingIdShader(e);break;case x3dom.shader.PICKING_COLOR:i=new x3dom.shader.PickingColorShader(e);break;case x3dom.shader.PICKING_TEXCOORD:i=new x3dom.shader.PickingTexcoordShader(e);break;case x3dom.shader.FRONTGROUND_TEXTURE:i=new x3dom.shader.FrontgroundTextureShader(e);break;case x3dom.shader.BACKGROUND_TEXTURE:i=new x3dom.shader.BackgroundTextureShader(e);break;case x3dom.shader.BACKGROUND_SKYTEXTURE:i=new x3dom.shader.BackgroundSkyTextureShader(e);break;case x3dom.shader.BACKGROUND_CUBETEXTURE:i=new x3dom.shader.BackgroundCubeTextureShader(e);break;case x3dom.shader.SHADOW:i=new x3dom.shader.ShadowShader(e);break;case x3dom.shader.BLUR:i=new x3dom.shader.BlurShader(e);break;case x3dom.shader.DEPTH:break;case x3dom.shader.NORMAL:i=new x3dom.shader.NormalShader(e);break;case x3dom.shader.TEXTURE_REFINEMENT:i=new x3dom.shader.TextureRefinementShader(e)}i?this.shaders[t]=x3dom.Utils.wrapProgram(e,i,t):x3dom.debug.logError("Couldn't create shader: "+t)}return this.shaders[t]},x3dom.Cache.prototype.getDynamicShader=function(e,t,i){var o=x3dom.Utils.generateProperties(t,i),s=o.id;if(void 0===this.shaders[s]){var r=null;r=-1!=o.CSHADER?new x3dom.shader.ComposedShader(e,i):x3dom.caps.MOBILE&&!o.CSSHADER?new x3dom.shader.DynamicMobileShader(e,o):new x3dom.shader.DynamicShader(e,o),this.shaders[s]=x3dom.Utils.wrapProgram(e,r,s)}return this.shaders[s]},x3dom.Cache.prototype.getShaderByProperties=function(e,t,i,o,s){var r=i.id;if(void 0!==o&&null!==o&&(r+=o),void 0!==s&&null!==s&&(r+="S"),void 0===this.shaders[r]){var n=null;n=void 0!==o&&null!==o?new x3dom.shader.DynamicShaderPicking(e,i,o):void 0!==s&&null!==s?new x3dom.shader.DynamicShadowShader(e,i):-1!=i.CSHADER?new x3dom.shader.ComposedShader(e,t):x3dom.caps.MOBILE&&!i.CSSHADER?new x3dom.shader.DynamicMobileShader(e,i):new x3dom.shader.DynamicShader(e,i),this.shaders[r]=x3dom.Utils.wrapProgram(e,n,r)}return this.shaders[r]},x3dom.Cache.prototype.getShadowRenderingShader=function(e,t){for(var i="shadow",o=0;o<t.length;o++)i+=x3dom.isa(t[o],x3dom.nodeTypes.SpotLight)?"S":x3dom.isa(t[o],x3dom.nodeTypes.PointLight)?"P":"D";if(void 0===this.shaders[i]){var s=new x3dom.shader.ShadowRenderingShader(e,t);this.shaders[i]=x3dom.Utils.wrapProgram(e,s,i)}return this.shaders[i]},x3dom.Cache.prototype.Release=function(e){for(var t in this.textures)e.deleteTexture(this.textures[t]);this.textures=[];for(var i in this.shaders){for(var o=this.shaders[i],s=e.getAttachedShaders(o.program),r=0;r<s.length;++r)e.detachShader(o.program,s[r]),e.deleteShader(s[r]);e.deleteProgram(o.program)}this.shaders=[]},x3dom.Texture=function(e,t,i,o){this.gl=e,this.doc=t,this.cache=i,this.node=o,this.samplerName="diffuseMap",this.type=e.TEXTURE_2D,this.format=e.RGBA,this.magFilter=e.LINEAR,this.minFilter=e.LINEAR,this.wrapS=e.REPEAT,this.wrapT=e.REPEAT,this.genMipMaps=!1,this.texture=null,this.ready=!1,this.dashtexture=!1;var s=this.node,r="mpd";if(this.node._x3domTexture=this,x3dom.isa(s,x3dom.nodeTypes.MovieTexture)&&-1!==s._vf.url[0].indexOf(r,s._vf.url[0].length-r.length)){this.dashtexture=!0;var n=document.getElementById("AdditionalDashVideoScript");n||(n=document.createElement("script"),n.setAttribute("type","text/javascript"),n.setAttribute("src",x3dom.Texture.dashVideoScriptFile),n.setAttribute("id","AdditionalDashVideoScript"),n.onload=function(){for(var e;e=x3dom.Texture.loadDashVideos.pop();)x3dom.Texture.textNum++,e.update();n.ready=!0},document.getElementsByTagName("head")[0].appendChild(n)),n.ready===!0?(x3dom.Texture.textNum++,this.update()):x3dom.Texture.loadDashVideos.push(this)}this.dashtexture||this.update()},x3dom.Texture.dashVideoScriptFile="dash.all.js",x3dom.Texture.loadDashVideos=[],x3dom.Texture.textNum=0,x3dom.Texture.clampFontSize=!1,x3dom.Texture.minFontQuality=.5,x3dom.Texture.maxFontQuality=10,x3dom.Texture.prototype.update=function(){x3dom.isa(this.node,x3dom.nodeTypes.Text)?this.updateText():this.updateTexture()},x3dom.Texture.prototype.setPixel=function(e,t,i,o){var s=this.gl,r=new Uint8Array(i);s.bindTexture(this.type,this.texture),s.pixelStorei(s.UNPACK_ALIGNMENT,1),s.texSubImage2D(this.type,0,e,t,1,1,this.format,s.UNSIGNED_BYTE,r),s.bindTexture(this.type,null),o&&(this.doc.needRender=!0)},x3dom.Texture.prototype.updateTexture=function(){var e=this.gl,t=this.doc,i=this.node;if(this.samplerName=i._type,this.type=x3dom.isa(i,x3dom.nodeTypes.X3DEnvironmentTextureNode)?e.TEXTURE_CUBE_MAP:e.TEXTURE_2D,x3dom.isa(i,x3dom.nodeTypes.PixelTexture))switch(i._vf.image.comp){case 1:this.format=e.LUMINANCE;break;case 2:this.format=e.LUMINANCE_ALPHA;break;case 3:this.format=e.RGB;break;case 4:this.format=e.RGBA}else this.format=e.RGBA;if(null!==i._cf.textureProperties.node){var o=i._cf.textureProperties.node;this.wrapS=x3dom.Utils.boundaryModesDic(e,o._vf.boundaryModeS),this.wrapT=x3dom.Utils.boundaryModesDic(e,o._vf.boundaryModeT),this.minFilter=x3dom.Utils.minFilterDic(e,o._vf.minificationFilter),this.magFilter=x3dom.Utils.magFilterDic(e,o._vf.magnificationFilter),o._vf.generateMipMaps===!0?(this.genMipMaps=!0,this.minFilter==e.NEAREST?this.minFilter=e.NEAREST_MIPMAP_NEAREST:this.minFilter==e.LINEAR&&(this.minFilter=e.LINEAR_MIPMAP_LINEAR),this.texture&&(this.texture.ready||this.texture.textureCubeReady)&&(e.bindTexture(this.type,this.texture),e.generateMipmap(this.type),e.bindTexture(this.type,null))):(this.genMipMaps=!1,this.minFilter==e.LINEAR_MIPMAP_LINEAR||this.minFilter==e.LINEAR_MIPMAP_NEAREST?this.minFilter=e.LINEAR:(this.minFilter==e.NEAREST_MIPMAP_LINEAR||this.minFilter==e.NEAREST_MIPMAP_NEAREST)&&(this.minFilter=e.NEAREST))}else this.wrapS=0==i._vf.repeatS?e.CLAMP_TO_EDGE:e.REPEAT,this.wrapT=0==i._vf.repeatT?e.CLAMP_TO_EDGE:e.REPEAT,("displacementMap"==this.samplerName||"multiDiffuseAlphaMap"==this.samplerName||"multiVisibilityMap"==this.samplerName||"multiEmissiveAmbientMap"==this.samplerName||"multiSpecularShininessMap"==this.samplerName)&&(this.wrapS=e.CLAMP_TO_EDGE,this.wrapT=e.CLAMP_TO_EDGE,this.minFilter=e.NEAREST,this.magFilter=e.NEAREST);var s=i._video&&i._needPerFrameUpdate===!0;if(i._isCanvas&&i._canvas)null==this.texture&&(this.texture=e.createTexture()),this.texture.width=i._canvas.width,this.texture.height=i._canvas.height,this.texture.ready=!0,e.bindTexture(this.type,this.texture),e.texImage2D(this.type,0,this.format,this.format,e.UNSIGNED_BYTE,i._canvas),this.genMipMaps&&e.generateMipmap(this.type),e.bindTexture(this.type,null);else if(x3dom.isa(i,x3dom.nodeTypes.RenderedTexture))i._webgl&&i._webgl.fbo?this.texture=i._webgl.fbo.dtex&&i._vf.depthMap?i._webgl.fbo.dtex:i._webgl.fbo.tex:(this.texture=null,x3dom.debug.logError("Try updating RenderedTexture without FBO initialized!")),this.texture&&(this.texture.ready=!0);else if(x3dom.isa(i,x3dom.nodeTypes.PixelTexture)){null==this.texture&&(this.texture=this.node._DEF?this.cache.getTexture2DByDEF(e,this.node._nameSpace,this.node._DEF):e.createTexture()),this.texture.width=i._vf.image.width,this.texture.height=i._vf.image.height,this.texture.ready=!0;var r=i._vf.image.array,n=i._vf.image.width*i._vf.image.height*i._vf.image.comp;if(r.length<n)for(r=i._vf.image.toGL();r.length<n;)r.push(0);var a=new Uint8Array(r);e.bindTexture(this.type,this.texture),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.texImage2D(this.type,0,this.format,i._vf.image.width,i._vf.image.height,0,this.format,e.UNSIGNED_BYTE,a),this.genMipMaps&&e.generateMipmap(this.type),e.bindTexture(this.type,null)}else if(x3dom.isa(i,x3dom.nodeTypes.MovieTexture)||s){var d=this,l=document.getElementsByTagName("body")[0];if(null==this.texture&&(this.texture=e.createTexture()),this.dashtexture){var h=document.createElement("div");h.setAttribute("class","dash-video-player"+x3dom.Texture.textNum),i._video=document.createElement("video"),i._video.setAttribute("preload","auto"),i._video.setAttribute("muted","muted");var u=document.createElement("script");u.setAttribute("type","text/javascript"),u.innerHTML='startDashVideo("'+i._vf.url[0]+'",".dash-video-player'+x3dom.Texture.textNum+' video")',h.appendChild(u),h.appendChild(i._video),l.appendChild(h),i._video.style.visibility="hidden",i._video.style.display="none"}else{s||(i._video=document.createElement("video"),i._video.setAttribute("preload","auto"),i._video.setAttribute("muted","muted"),l.appendChild(i._video),i._video.style.visibility="hidden",i._video.style.display="none");for(var f=0;f<i._vf.url.length;f++){var _=i._nameSpace.getURL(i._vf.url[f]);x3dom.debug.logInfo("Adding video file: "+_);var c=document.createElement("source");c.setAttribute("src",_),i._video.appendChild(c)}}var m=function(){e.bindTexture(d.type,d.texture),e.texImage2D(d.type,0,d.format,d.format,e.UNSIGNED_BYTE,i._video),d.genMipMaps&&e.generateMipmap(d.type),e.bindTexture(d.type,null),d.texture.ready=!0,t.needRender=!0},p=function(){i._video.play(),i._intervalID=setInterval(m,16)},x=function(){clearInterval(i._intervalID),i._vf.loop===!0&&(i._video.play(),i._intervalID=setInterval(m,16))};i._video.addEventListener("canplaythrough",p,!0),i._video.addEventListener("ended",x,!0)}else this.texture=x3dom.isa(i,x3dom.nodeTypes.X3DEnvironmentTextureNode)?this.cache.getTextureCube(e,t,i.getTexUrl(),!1,i._vf.crossOrigin,i._vf.scale,this.genMipMaps):this.cache.getTexture2D(e,t,i._nameSpace.getURL(i._vf.url[0]),!1,i._vf.crossOrigin,i._vf.scale,this.genMipMaps)},x3dom.Texture.prototype.updateText=function(){var e=this.gl;this.wrapS=e.CLAMP_TO_EDGE,this.wrapT=e.CLAMP_TO_EDGE,this.type=e.TEXTURE_2D,this.format=e.RGBA,this.magFilter=e.LINEAR,this.minFilter=e.LINEAR;var t=this.node._cf.fontStyle.node,i="serif",o="normal",s="left",r=1,n=1,a=!0,d="",l=2,h="FIRST";if(null!==t){var u=t._vf.family.toString();switch(u=u.trim().replace(/\'/g,"").replace(/\,/," "),u=u.split(" "),i=Array.map(u,function(e){return"SANS"==e?"sans-serif":"SERIF"==e?"serif":"TYPEWRITER"==e?"monospace":""+e}).join(","),o=t._vf.style.toString().replace(/\'/g,""),o.toUpperCase()){case"PLAIN":o="normal";break;case"BOLD":o="bold";break;case"ITALIC":o="italic";break;case"BOLDITALIC":o="italic bold";break;default:o="normal"}var f=t._vf.leftToRight?"ltr":"rtl",_=t._vf.topToBottom;switch(s=t._vf.justify[0].toString().replace(/\'/g,""),s.toUpperCase()){case"BEGIN":s="left";break;case"END":s="right";break;case"FIRST":s="left";break;case"MIDDLE":s="center";break;default:s="left"}if(void 0===t._vf.justify[1])h="FIRST";else switch(h=t._vf.justify[1].toString().replace(/\'/g,""),h.toUpperCase()){case"BEGIN":h="BEGIN";break;case"FIRST":h="FIRST";break;case"MIDDLE":h="MIDDLE";break;case"END":h="END";break;default:h="FIRST"}r=t._vf.size,n=t._vf.spacing,a=t._vf.horizontal,d=t._vf.language,l=t._vf.quality,l=Math.max(x3dom.Texture.minFontQuality,l),l=Math.min(x3dom.Texture.maxFontQuality,l),.1>r&&(r=.1),x3dom.Texture.clampFontSize&&r>2.3&&(r=2.3)}var c,m,p=this.node._vf.string,x=this.node._vf.maxExtent,g=[],v=document.createElement("canvas");v.dir=f;var y=42,b=r*y,T=s;document.body.appendChild(v);var S=v.getContext("2d");S.font=o+" "+b+"px "+i;var M,C,F,E,w=0;for(F=0;F<p.length;F++)M=S.measureText(p[F]).width,M>w&&(w=M),C=0|this.node._vf.length[F],x>0&&(C>x||0==C)&&(C=x),g[F]=0>=C?M:C*y;var A=.1*b,R=w,N=b*n*p.length+A;c=0,m=0;var I=0,P=0,D="top";switch(s){case"center":I=-R/2,c=R/2;break;case"left":I="ltr"==f?0:-R,c=0;break;case"right":I="ltr"==f?-R:0,c=R}switch(h){case"MIDDLE":P=N/2;break;case"BEGIN":P=_?0:N-A,D=_?"top":"bottom",m=_?0:b;break;case"FIRST":P=_?b:N-A,D=_?"alphabetic":"bottom",m=_?b:b;break;case"END":P=_?N-A:0,D=_?"bottom":"top",m=_?b:0}var V=1/42,L=R*V,B=N*V;for(I*=V,P*=V,v.width=R*l,v.height=N*l,v.dir=f,S.scale(l,l),S.fillStyle="rgba(0,0,0,0)",S.fillRect(0,0,S.canvas.width,S.canvas.height),S.fillStyle="white",S.textBaseline=D,S.font=o+" "+b+"px "+i,S.textAlign=T,F=0;F<p.length;F++)E=_?F:p.length-1-F,S.fillText(p[E],c,m,g[E]),m+=b*n;null===this.texture&&(this.texture=e.createTexture()),e.bindTexture(this.type,this.texture),e.texImage2D(this.type,0,this.format,this.format,e.UNSIGNED_BYTE,v),e.bindTexture(this.type,null),document.body.removeChild(v),this.node._mesh._positions[0]=[0+I,-B+P,0,L+I,-B+P,0,L+I,0+P,0,0+I,0+P,0],this.node.invalidateVolume(),Array.forEach(this.node._parentNodes,function(e){e.setAllDirty()})},x3dom.X3DDocument=function(e,t,i){this.canvas=e,this.ctx=t,this.properties=i,this.needRender=!0,this._x3dElem=null,this._scene=null,this._viewarea=null,this.downloadCount=0,this.previousDownloadCount=0,this._nodeBag={timer:[],lights:[],clipPlanes:[],followers:[],trans:[],renderTextures:[],viewarea:[],affectedPointingSensors:[]},this.onload=function(){},this.onerror=function(){}},x3dom.X3DDocument.prototype.load=function(e,t){function i(){if(0===s.length)return r._setup(o[e],o,t),void r.onload();var n=s.shift();!x3dom.isX3DElement(n)||"x3d"!==n.localName.toLowerCase()&&"websg"!==n.localName.toLowerCase()||(o[n]=n,r._x3dElem=n,i())}var o={},s=[e],r=this;i()},x3dom.findScene=function(e){for(var t=[],i=0;i<e.childNodes.length;i++){var o=e.childNodes[i];o&&o.localName&&"scene"===o.localName.toLowerCase()&&t.push(o)}return t.length>1?(x3dom.debug.logError("X3D element has more than one Scene child (has "+e.childNodes.length+")."),null):t[0]},x3dom.X3DDocument.prototype._setup=function(e){function t(e,t){for(var i=0,o=e.length;o>i;i++)if(e[i]===t){e.splice(i,1);break}}function i(e){for(var s=e.childNodes,r=0,n=s.length;n>r;r++)i(s[r]);if(e._x3domNode){var a=e._x3domNode,d=a._nameSpace;if(x3dom.isa(a,x3dom.nodeTypes.X3DShapeNode))a._cleanupGLObjects&&a._cleanupGLObjects(!0),x3dom.nodeTypes.Shape.idMap.nodeID[a._objectID]&&delete x3dom.nodeTypes.Shape.idMap.nodeID[a._objectID];else if(x3dom.isa(a,x3dom.nodeTypes.TimeSensor))t(o._nodeBag.timer,a);else if(x3dom.isa(a,x3dom.nodeTypes.X3DLightNode))t(o._nodeBag.lights,a);else if(x3dom.isa(a,x3dom.nodeTypes.X3DFollowerNode))t(o._nodeBag.followers,a);else if(x3dom.isa(a,x3dom.nodeTypes.X3DTransformNode))t(o._nodeBag.trans,a);else if(x3dom.isa(a,x3dom.nodeTypes.RenderedTexture))t(o._nodeBag.renderTextures,a),a._cleanupGLObjects&&a._cleanupGLObjects();else if(x3dom.isa(a,x3dom.nodeTypes.X3DPointingDeviceSensorNode))t(o._nodeBag.affectedPointingSensors,a);else if(x3dom.isa(a,x3dom.nodeTypes.Texture))a.shutdown();else if(x3dom.isa(a,x3dom.nodeTypes.AudioClip))a.shutdown();else if(x3dom.isa(a,x3dom.nodeTypes.X3DBindableNode)){var l=a._stack;l&&(a.bind(!1),t(l._bindBag,a)),a._cleanupGLObjects&&a._cleanupGLObjects()}else x3dom.isa(a,x3dom.nodeTypes.Scene)&&a._webgl&&(a._webgl=null);!d||e.getAttribute("use")||e.getAttribute("USE")||d.removeNode(a._DEF),a._xmlNode=null,delete e._x3domNode}}var o=this,s={onAttrModified:function(e){if("_x3domNode"in e.target){e.target._x3domNode.updateField(e.attrName,e.newValue),o.needRender=!0}},onNodeRemoved:function(e){var t=e.target;if(t)if("_x3domNode"in t.parentNode&&"_x3domNode"in t){var s=t.parentNode._x3domNode,r=t._x3domNode;s&&r&&(s.removeChild(r),s.nodeChanged(),i(t),o._viewarea&&o._viewarea._scene&&(o._viewarea._scene.nodeChanged(),o._viewarea._scene.updateVolume(),o.needRender=!0))}else if(t.localName&&"ROUTE"==t.localName.toUpperCase()&&t._nodeNameSpace){var n=t._nodeNameSpace.defMap[t.getAttribute("fromNode")],a=t._nodeNameSpace.defMap[t.getAttribute("toNode")];n&&a&&n.removeRoute(t.getAttribute("fromField"),a,t.getAttribute("toField"))}else if(t.localName&&"X3D"==t.localName.toUpperCase()){var d=t.runtime;if(d&&d.canvas&&d.canvas.doc&&d.canvas.doc._scene){var l=d.canvas.doc._scene._xmlNode;i(l);for(var h=0;h<x3dom.canvases.length;h++)if(x3dom.canvases[h]===d.canvas){x3dom.canvases[h].doc.shutdown(x3dom.canvases[h].gl),x3dom.canvases.splice(h,1);break}d.canvas.doc._scene=null,d.canvas.doc._viewarea=null,d.canvas.doc=null,d.canvas=null,d=null,t.context=null,t.runtime=null}}},onNodeInserted:function(e){var t=e.target,s=t.parentNode;if("_x3domNode"in s)if(s.tagName&&"inline"==s.tagName.toLowerCase()||"multipart"==s.tagName.toLowerCase());else{var r=s._x3domNode;if(r&&r._nameSpace&&t instanceof Element){x3dom.caps.DOMNodeInsertedEvent_perSubtree&&i(t);var n=r._nameSpace.setupTree(t);r.addChild(n,t.getAttribute("containerField")),r.nodeChanged();var a=s.parentNode;a&&a._x3domNode&&a._x3domNode.nodeChanged(),o._viewarea&&o._viewarea._scene&&(o._viewarea._scene.nodeChanged(),o._viewarea._scene.updateVolume(),o.needRender=!0)}else x3dom.debug.logWarning("No _nameSpace in onNodeInserted")}}};e.addEventListener("DOMNodeRemoved",s.onNodeRemoved,!0),e.addEventListener("DOMNodeInserted",s.onNodeInserted,!0),x3dom.userAgentFeature.supportsDOMAttrModified===!0&&e.addEventListener("DOMAttrModified",s.onAttrModified,!0);var r=x3dom.findScene(e);this._bindableBag=new x3dom.BindableBag(this);var n=new x3dom.NodeNameSpace("scene",o),a=n.setupTree(r);this._scene=a,this._bindableBag.setRefNode(a),this._viewarea=new x3dom.Viewarea(this,a),this._viewarea._width=this.canvas.width,this._viewarea._height=this.canvas.height},x3dom.X3DDocument.prototype.advanceTime=function(e){var t=0;if(this._nodeBag.timer.length)for(t=0;t<this._nodeBag.timer.length;t++)this.needRender|=this._nodeBag.timer[t].tick(e);if(this._nodeBag.followers.length)for(t=0;t<this._nodeBag.followers.length;t++)this.needRender|=this._nodeBag.followers[t].tick(e);if(this._nodeBag.trans.length)for(t=0;t<this._nodeBag.trans.length;t++)this.needRender|=this._nodeBag.trans[t].tick(e);if(this._nodeBag.viewarea.length)for(t=0;t<this._nodeBag.viewarea.length;t++)this.needRender|=this._nodeBag.viewarea[t].tick(e)},x3dom.X3DDocument.prototype.render=function(e){e&&this._viewarea&&e.renderScene(this._viewarea)},x3dom.X3DDocument.prototype.onPick=function(e,t,i){e&&this._viewarea&&e.pickValue(this._viewarea,t,i,1)},x3dom.X3DDocument.prototype.onPickRect=function(e,t,i,o,s){return e&&this._viewarea?e.pickRect(this._viewarea,t,i,o,s):[]},x3dom.X3DDocument.prototype.onMove=function(e,t,i,o){e&&this._viewarea&&(this._viewarea._scene._vf.doPickPass&&e.pickValue(this._viewarea,t,i,o),this._viewarea.onMove(t,i,o))},x3dom.X3DDocument.prototype.onMoveView=function(e,t,i){e&&this._viewarea&&this._viewarea.onMoveView(t,i)},x3dom.X3DDocument.prototype.onDrag=function(e,t,i,o){e&&this._viewarea&&(this._viewarea._scene._vf.doPickPass&&e.pickValue(this._viewarea,t,i,o),this._viewarea.onDrag(t,i,o))},x3dom.X3DDocument.prototype.onWheel=function(e,t,i,o){e&&this._viewarea&&(this._viewarea._scene._vf.doPickPass&&e.pickValue(this._viewarea,t,o,0),this._viewarea.onDrag(t,i,2))},x3dom.X3DDocument.prototype.onMousePress=function(e,t,i,o){e&&this._viewarea&&(this._viewarea._scene.updateVolume(),e.pickValue(this._viewarea,t,i,o),this._viewarea.onMousePress(t,i,o))},x3dom.X3DDocument.prototype.onMouseRelease=function(e,t,i,o,s){if(e&&this._viewarea){var r=s<<8|o;e.pickValue(this._viewarea,t,i,r),this._viewarea.onMouseRelease(t,i,o,s)}},x3dom.X3DDocument.prototype.onMouseOver=function(e,t,i,o){e&&this._viewarea&&(e.pickValue(this._viewarea,t,i,o),this._viewarea.onMouseOver(t,i,o))},x3dom.X3DDocument.prototype.onMouseOut=function(e,t,i,o){e&&this._viewarea&&(e.pickValue(this._viewarea,t,i,o),this._viewarea.onMouseOut(t,i,o))},x3dom.X3DDocument.prototype.onDoubleClick=function(e,t,i){e&&this._viewarea&&this._viewarea.onDoubleClick(t,i)},x3dom.X3DDocument.prototype.onKeyDown=function(e){switch(e){case 37:this._viewarea.strafeLeft();break;case 38:this._viewarea.moveFwd();break;case 39:this._viewarea.strafeRight();break;case 40:this._viewarea.moveBwd()}},x3dom.X3DDocument.prototype.onKeyUp=function(e){var t=null;switch(e){case 13:x3dom.toggleFullScreen();break;case 33:t=this._scene.getViewpoint()._stack,t?t.switchTo("next"):x3dom.debug.logError("No valid ViewBindable stack.");break;case 34:t=this._scene.getViewpoint()._stack,t?t.switchTo("prev"):x3dom.debug.logError("No valid ViewBindable stack.");break;case 37:break;case 38:break;case 39:break;case 40:}},x3dom.X3DDocument.prototype.onKeyPress=function(e){var t=this._scene.getNavigationInfo(),i=this._scene.getEnvironment();switch(e){case 32:var o=this.canvas.parent.stateViewer;o&&o.display(),x3dom.debug.logInfo("a: show all | d: show helper buffers | s: small feature culling | t: light view | m: toggle render mode | c: frustum culling | p: intersect type | r: reset view | \ne: examine mode | f: fly mode | y: freefly mode | w: walk mode | h: helicopter mode | l: lookAt mode | o: lookaround | g: game mode | n: turntable | u: upright position | \nv: print viewpoint info | pageUp: next view | pageDown: prev. view | +: increase speed | -: decrease speed ");break;case 43:t._vf.speed=2*t._vf.speed,x3dom.debug.logInfo("Changed navigation speed to "+t._vf.speed);break;case 45:t._vf.speed=.5*t._vf.speed,x3dom.debug.logInfo("Changed navigation speed to "+t._vf.speed);break;case 51:x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor+=.5,x3dom.debug.logInfo("Changed POP error tolerance to "+x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor);break;case 52:x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor-=.5,x3dom.debug.logInfo("Changed POP error tolerance to "+x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor);break;case 54:t._vf.typeParams[1]+=1,t._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter height to "+t._vf.typeParams[1]);break;case 55:t._vf.typeParams[1]-=1,t._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter height to "+t._vf.typeParams[1]);break;case 56:t._vf.typeParams[0]-=.02,t._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter angle to "+t._vf.typeParams[0]);break;case 57:t._vf.typeParams[0]+=.02,t._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter angle to "+t._vf.typeParams[0]);break;case 97:this._viewarea.showAll();break;case 99:i._vf.frustumCulling=!i._vf.frustumCulling,x3dom.debug.logInfo("Viewfrustum culling "+(i._vf.frustumCulling?"on":"off"));break;case 100:void 0===this._viewarea._visDbgBuf&&(this._viewarea._visDbgBuf="true"===this._x3dElem.getAttribute("showLog")),this._viewarea._visDbgBuf=!this._viewarea._visDbgBuf,x3dom.debug.logContainer.style.display=1==this._viewarea._visDbgBuf?"block":"none";break;case 101:t.setType("examine",this._viewarea);break;case 102:t.setType("fly",this._viewarea);break;case 103:t.setType("game",this._viewarea);break;case 104:t.setType("helicopter",this._viewarea);break;case 105:this._viewarea.fit(this._scene._lastMin,this._scene._lastMax);break;case 108:t.setType("lookat",this._viewarea);break;case 109:this._viewarea._points=++this._viewarea._points%2;break;case 110:t.setType("turntable",this._viewarea);break;case 111:t.setType("lookaround",this._viewarea);break;case 112:switch(this._scene._vf.pickMode.toLowerCase()){case"idbuf":this._scene._vf.pickMode="color";break;case"color":this._scene._vf.pickMode="texCoord";break;case"texcoord":this._scene._vf.pickMode="box";break;default:this._scene._vf.pickMode="idBuf"}x3dom.debug.logInfo("Switch pickMode to '"+this._scene._vf.pickMode+"'.");break;case 114:this._viewarea.resetView();break;case 115:i._vf.smallFeatureCulling=!i._vf.smallFeatureCulling,x3dom.debug.logInfo("Small feature culling "+(i._vf.smallFeatureCulling?"on":"off"));break;case 116:this._nodeBag.lights.length>0&&this._viewarea.animateTo(this._viewarea.getLightMatrix()[0],this._scene.getViewpoint());break;case 117:this._viewarea.uprightView();break;case 118:var s=this;!function(){var e=s._viewarea._scene.getViewpoint(),t=s._viewarea.getViewMatrix().inverse(),i=new x3dom.fields.Quaternion(0,0,1,0);i.setValue(t);var o=i.toAxisAngle(),r=t.e3();x3dom.debug.logInfo('\n&lt;Viewpoint position="'+r.x.toFixed(5)+" "+r.y.toFixed(5)+" "+r.z.toFixed(5)+'" orientation="'+o[0].x.toFixed(5)+" "+o[0].y.toFixed(5)+" "+o[0].z.toFixed(5)+" "+o[1].toFixed(5)+'" \n	zNear="'+e.getNear().toFixed(5)+'" zFar="'+e.getFar().toFixed(5)+'" description="'+e._vf.description+'"&gt;&lt;/Viewpoint&gt;')}();break;case 119:t.setType("walk",this._viewarea);break;case 121:t.setType("freefly",this._viewarea)}},x3dom.X3DDocument.prototype.shutdown=function(e){e&&e.shutdown(this._viewarea)},x3dom.MatrixMixer=function(e,t){0===arguments.length?(this._beginTime=0,this._endTime=1):(this._beginTime=e,this._endTime=t),this._beginMat=x3dom.fields.SFMatrix4f.identity(),this._beginInvMat=x3dom.fields.SFMatrix4f.identity(),this._beginLogMat=x3dom.fields.SFMatrix4f.identity(),this._endMat=x3dom.fields.SFMatrix4f.identity(),this._endLogMat=x3dom.fields.SFMatrix4f.identity(),this._beginRot=new x3dom.fields.Quaternion,this._endRot=new x3dom.fields.Quaternion,this._beginPos=new x3dom.fields.SFVec3f,this._endPos=new x3dom.fields.SFVec3f,this._result=x3dom.fields.SFMatrix4f.identity(),this._useQuaternion=!1},x3dom.MatrixMixer.prototype.calcFraction=function(e){var t=(e-this._beginTime)/(this._endTime-this._beginTime);return(Math.sin(t*Math.PI-Math.PI/2)+1)/2},x3dom.MatrixMixer.prototype._isValid=function(){var e=this._beginMat.inverse().mult(this._endMat).getEulerAngles();return Math.abs(e[0])!=Math.PI&&Math.abs(e[1])!=Math.PI&&Math.abs(e[2])!=Math.PI},x3dom.MatrixMixer.prototype._prepareQuaternionAnimation=function(){this._beginRot.setValue(this._beginMat),this._endRot.setValue(this._endMat),this._beginPos=this._beginMat.e3(),this._endPos=this._endMat.e3(),this._useQuaternion=!0},x3dom.MatrixMixer.prototype.setBeginMatrix=function(e){this._beginMat.setValues(e),this._beginInvMat=e.inverse(),this._beginLogMat=x3dom.fields.SFMatrix4f.zeroMatrix()},x3dom.MatrixMixer.prototype.reset=function(){this._beginTime=0,this._endTime=0,this._useQuaternion=!1},x3dom.MatrixMixer.prototype.setEndMatrix=function(e){this._endMat.setValues(e),this._isValid()||this._prepareQuaternionAnimation(),this._endLogMat=this._endMat.mult(this._beginInvMat).log(),this._logDiffMat=this._endLogMat.addScaled(this._beginLogMat,-1)},x3dom.MatrixMixer.prototype.mixQuaternion=function(e){var t=this.calcFraction(e),i=this._beginRot.slerp(this._endRot,t),o=this._beginPos.addScaled(this._endPos.subtract(this._beginPos),t);return this._result.setRotate(i),this._result.setTranslate(o),this._result.copy()},x3dom.MatrixMixer.prototype.mixMatrix=function(e){var t=null;if(e<=this._beginTime)t=x3dom.fields.SFMatrix4f.copy(this._beginLogMat);else if(e>=this._endTime)t=x3dom.fields.SFMatrix4f.copy(this._endLogMat);else{var i=this.calcFraction(e);t=this._logDiffMat.multiply(i).add(this._beginLogMat)}return t.exp().mult(this._beginMat)},x3dom.MatrixMixer.prototype.mix=function(e){return this._useQuaternion?this.mixQuaternion(e):this.mixMatrix(e)},x3dom.InputTypes={NAVIGATION:1,INTERACTION:2},x3dom.Viewarea=function(e,t){this._doc=e,this._scene=t,e._nodeBag.viewarea.push(this),this._pickingInfo={pickPos:new x3dom.fields.SFVec3f(0,0,0),pickNorm:new x3dom.fields.SFVec3f(0,0,1),pickObj:null,firstObj:null,lastObj:null,lastClickObj:null,shadowObjectId:-1},this._currentInputType=x3dom.InputTypes.NAVIGATION,this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0,this._deltaT=0,this._flyMat=null,this._pitch=0,this._yaw=0,this._eyePos=new x3dom.fields.SFVec3f(0,0,0),this._width=400,this._height=300,this._dx=0,this._dy=0,this._lastX=-1,this._lastY=-1,this._pressX=-1,this._pressY=-1,this._lastButton=0,this._points=0,this._numRenderedNodes=0,this._pick=new x3dom.fields.SFVec3f(0,0,0),this._pickNorm=new x3dom.fields.SFVec3f(0,0,1),this._isAnimating=!1,this._isMoving=!1,this._lastTS=0,this._mixer=new x3dom.MatrixMixer,this.arc=null},x3dom.Viewarea.prototype.tick=function(e){var t=!1,i=this._scene.getEnvironment();if(i._vf.enableARC&&null==this.arc&&(this.arc=new x3dom.arc.AdaptiveRenderControl(this._scene)),this._mixer._beginTime>0)if(t=!0,e>=this._mixer._beginTime)if(e<=this._mixer._endTime){var o=this._mixer.mix(e);this._scene.getViewpoint().setView(o)}else this._mixer.reset(),this._scene.getViewpoint().setView(this._mixer._endMat);else this._mixer.reset(),this._scene.getViewpoint().setView(this._mixer._beginMat);var s=this.navigateTo(e),r=this._isAnimating;return this._lastTS=e,this._isAnimating=t||s,null!=this.arc&&this.arc.update(this.isMovingOrAnimating()?1:0,this._doc._x3dElem.runtime.getFPS()),this._isAnimating||r},x3dom.Viewarea.prototype.isMoving=function(){return this._isMoving},x3dom.Viewarea.prototype.isAnimating=function(){return this._isAnimating},x3dom.Viewarea.prototype.isMovingOrAnimating=function(){return this._isMoving||this._isAnimating},x3dom.Viewarea.prototype.navigateTo=function(e){var t=this._scene.getNavigationInfo(),i=t.getType(),o=null,s=this._currentInputType==x3dom.InputTypes.NAVIGATION&&("game"===i||this._lastButton>0&&(i.indexOf("fly")>=0||"walk"===i||"helicopter"===i||"looka"===i.substr(0,5)));this._deltaT=e-this._lastTS;var r=function(e,t){return e>0?t>=e?0:e-t:0>=e?e>=-t?0:e+t:void 0},n=function(e,t){return(0>t?-1:1)*Math.pow(e*Math.abs(t),1.65)};if(s){null!==this._pickingInfo.pickObj&&(o={pickPos:this._pickingInfo.pickPos,pickNorm:this._pickingInfo.pickNorm,pickObj:this._pickingInfo.pickObj,firstObj:this._pickingInfo.firstObj,lastObj:this._pickingInfo.lastObj,lastClickObj:this._pickingInfo.lastClickObj,shadowObjectId:this._pickingInfo.shadowObjectId});var a=.25,d=1.6,l=.75;t._vf.avatarSize.length>2&&(a=t._vf.avatarSize[0],d=t._vf.avatarSize[1],l=t._vf.avatarSize[2]);var h=this.getViewMatrix(),u=0,f=Math.min(this._width,this._height),_=r((this._pressX-this._lastX)/f,.01),c=r((this._pressY-this._lastY)/f,.01),m=n(1,_),p=n(1,c),x=2&this._lastButton?-1:1;x*=this._deltaT*t._vf.speed;var g=(this._deltaT*t._vf.speed*m,this._deltaT*t._vf.speed*p),v=Math.PI*this._deltaT*m,y=Math.PI*this._deltaT*p;if(this._needNavigationMatrixUpdate===!0){this._needNavigationMatrixUpdate=!1,this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0);var b=0,T=Math.asin(h._02),S=Math.cos(T);

Math.abs(S)>1e-4&&(b=Math.atan2(-h._12/S,h._22/S)),this._flyMat=h.inverse(),this._from=this._flyMat.e3(),this._at=this._from.subtract(this._flyMat.e2()),"helicopter"===i&&(this._at.y=this._from.y),this._up=this._flyMat.e1(),this._pitch=180*b/Math.PI,this._yaw=180*T/Math.PI,this._eyePos=this._from.negate()}var M,C,F,E,w,A,R=null,N=null,I=null;if("game"===i){this._pitch+=this._dy,this._yaw+=this._dx,this._pitch>=89&&(this._pitch=89),this._pitch<=-89&&(this._pitch=-89),this._yaw>=360&&(this._yaw-=360),this._yaw<0&&(this._yaw=360+this._yaw),this._dx=0,this._dy=0;var P=x3dom.fields.SFMatrix4f.rotationX(this._pitch/180*Math.PI),D=x3dom.fields.SFMatrix4f.rotationY(this._yaw/180*Math.PI),V=x3dom.fields.SFMatrix4f.translation(this._eyePos);this._flyMat=P.mult(D).mult(V);var L=this._flyMat.inverse(),B=L.e3();return N=new x3dom.fields.SFVec3f(0,-1,0),R=B.add(N),N=L.e0().cross(N).normalize(),I=x3dom.fields.SFMatrix4f.lookAt(B,R,N),I=I.inverse(),this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton,I,this.getProjectionMatrix().mult(I)),this._pickingInfo.pickObj&&(u=this._pickingInfo.pickPos.subtract(B).length(),B.y+=d-u,L.setTranslate(B),this._eyePos=L.e3().negate(),this._flyMat=L.inverse(),this._pickingInfo.pickObj=null),this._scene.getViewpoint().setView(this._flyMat),s}if("helicopter"===i){var O=t.getTypeParams();if(2&this._lastButton){var k=200*g;O[1]+=k,t.setTypeParams(O)}x=1&this._lastButton?300*g:0,y=O[0],this._from.y=O[1],this._at.y=this._from.y,M=x3dom.fields.Quaternion.axisAngle(this._up,v),C=M.toMatrix(),F=x3dom.fields.SFMatrix4f.translation(this._from),F=F.mult(C),C=x3dom.fields.SFMatrix4f.translation(this._from.negate()),F=F.mult(C),this._at=F.multMatrixPnt(this._at),E=this._at.subtract(this._from).normalize(),w=E.cross(this._up).normalize(),A=w.cross(E).normalize(),E=E.multiply(x),this._from=this._from.add(E),this._at=this._at.add(E),M=x3dom.fields.Quaternion.axisAngle(w,y),C=M.toMatrix(),F=x3dom.fields.SFMatrix4f.translation(this._from),F=F.mult(C),C=x3dom.fields.SFMatrix4f.translation(this._from.negate()),F=F.mult(C);var U=F.multMatrixPnt(this._at);return this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,U,A),this._scene.getViewpoint().setView(this._flyMat.inverse()),s}if(M=x3dom.fields.Quaternion.axisAngle(this._up,v),C=M.toMatrix(),F=x3dom.fields.SFMatrix4f.translation(this._from),F=F.mult(C),C=x3dom.fields.SFMatrix4f.translation(this._from.negate()),F=F.mult(C),this._at=F.multMatrixPnt(this._at),E=this._at.subtract(this._from).normalize(),w=E.cross(this._up).normalize(),A=w.cross(E).normalize(),M=x3dom.fields.Quaternion.axisAngle(w,y),C=M.toMatrix(),F=x3dom.fields.SFMatrix4f.translation(this._from),F=F.mult(C),C=x3dom.fields.SFMatrix4f.translation(this._from.negate()),F=F.mult(C),this._at=F.multMatrixPnt(this._at),"looka"!==i.substr(0,5)){var G=this.getProjectionMatrix();"freefly"!==i&&(0>x?(I=new x3dom.fields.SFMatrix4f,I.setValue(this._last_mat_view.e0(),this._last_mat_view.e1(),this._last_mat_view.e2().negate(),this._last_mat_view.e3()),this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton,I,G.mult(I))):this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton),this._pickingInfo.pickObj&&(u=this._pickingInfo.pickPos.subtract(this._from).length(),a>=u&&(x=0))),E=this._at.subtract(this._from).normalize().multiply(x),this._at=this._at.add(E),this._from=this._from.add(E),"walk"===i&&(R=this._from.addScaled(A,-1),N=w.cross(A.negate()).normalize(),I=x3dom.fields.SFMatrix4f.lookAt(this._from,R,N),I=I.inverse(),this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton,I,G.mult(I)),this._pickingInfo.pickObj&&(u=this._pickingInfo.pickPos.subtract(this._from).length(),this._at=this._at.add(A.multiply(d-u)),this._from=this._from.add(A.multiply(d-u)))),this._pickingInfo.pickObj=null}this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,A),this._scene.getViewpoint().setView(this._flyMat.inverse()),null!==o&&(this._pickingInfo=o)}return s},x3dom.Viewarea.prototype.moveFwd=function(){var e=this._scene.getNavigationInfo();if("game"===e.getType()){var t=.25,i=1.6;e._vf.avatarSize.length>2&&(t=e._vf.avatarSize[0],i=e._vf.avatarSize[1]);var o=5*this._deltaT*e._vf.speed,s=this._yaw/180*Math.PI,r=this._pitch/180*Math.PI,n=0,a=this._flyMat.inverse();this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton),this._pickingInfo.pickObj&&(n=this._pickingInfo.pickPos.subtract(a.e3()).length(),2*t>=n||(this._eyePos.x-=Math.sin(s)*o,this._eyePos.z+=Math.cos(s)*o,this._eyePos.y+=Math.sin(r)*o))}},x3dom.Viewarea.prototype.moveBwd=function(){var e=this._scene.getNavigationInfo();if("game"===e.getType()){var t=5*this._deltaT*e._vf.speed,i=this._yaw/180*Math.PI,o=this._pitch/180*Math.PI;this._eyePos.x+=Math.sin(i)*t,this._eyePos.z-=Math.cos(i)*t,this._eyePos.y-=Math.sin(o)*t}},x3dom.Viewarea.prototype.strafeRight=function(){var e=this._scene.getNavigationInfo();if("game"===e.getType()){var t=5*this._deltaT*e._vf.speed,i=this._yaw/180*Math.PI;this._eyePos.x-=Math.cos(i)*t,this._eyePos.z-=Math.sin(i)*t}},x3dom.Viewarea.prototype.strafeLeft=function(){var e=this._scene.getNavigationInfo();if("game"===e.getType()){var t=5*this._deltaT*e._vf.speed,i=this._yaw/180*Math.PI;this._eyePos.x+=Math.cos(i)*t,this._eyePos.z+=Math.sin(i)*t}},x3dom.Viewarea.prototype.animateTo=function(e,t,i){var o=this._scene.getNavigationInfo();x3dom.isa(e,x3dom.nodeTypes.X3DViewpointNode)&&(e=e.getViewMatrix().mult(e.getCurrentTransform().inverse())),"teleport"!==o._vf.transitionType[0].toLowerCase()&&0!=i&&"game"!==o.getType()&&t&&x3dom.isa(t,x3dom.nodeTypes.X3DViewpointNode)?(t=t.getViewMatrix().mult(t.getCurrentTransform().inverse()).mult(this._transMat).mult(this._rotMat),this._mixer._beginTime=this._lastTS,this._mixer._endTime=arguments.length>=3?this._lastTS+i:this._lastTS+o._vf.transitionTime,this._mixer.setBeginMatrix(t),this._mixer.setEndMatrix(e),this._scene.getViewpoint().setView(t)):this._scene.getViewpoint().setView(e),this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0},x3dom.Viewarea.prototype.getLights=function(){for(var e=[],t=0;t<this._doc._nodeBag.lights.length;t++)1==this._doc._nodeBag.lights[t]._vf.on&&e.push(this._doc._nodeBag.lights[t]);return e},x3dom.Viewarea.prototype.getLightsShadow=function(){for(var e=this._doc._nodeBag.lights,t=0;t<e.length;t++)if(e[t]._vf.shadowIntensity>0)return!0;return!1},x3dom.Viewarea.prototype.updateSpecialNavigation=function(e,t){var i=this._scene.getNavigationInfo(),o=i.getType();if("helicopter"==o&&!i._heliUpdated){var s=i.getTypeParams(),r=s[0],n=e.getViewMatrix().mult(t.inverse()).inverse();this._from=n.e3(),this._at=this._from.subtract(n.e2()),this._up=new x3dom.fields.SFVec3f(0,1,0),this._from.y=s[1],this._at.y=this._from.y;var a=n.e0(),d=x3dom.fields.Quaternion.axisAngle(a,r),l=d.toMatrix(),h=x3dom.fields.SFMatrix4f.translation(this._from);h=h.mult(l),l=x3dom.fields.SFMatrix4f.translation(this._from.negate()),h=h.mult(l),this._at=h.multMatrixPnt(this._at),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,this._up),this._scene.getViewpoint().setView(this._flyMat.inverse()),i._heliUpdated=!0}},x3dom.Viewarea.prototype.getViewpointMatrix=function(){var e=this._scene.getViewpoint(),t=e.getCurrentTransform();return this.updateSpecialNavigation(e,t),e.getViewMatrix().mult(t.inverse())},x3dom.Viewarea.prototype.getViewMatrix=function(){return this.getViewpointMatrix().mult(this._transMat).mult(this._rotMat)},x3dom.Viewarea.prototype.getLightMatrix=function(){var e,t=this._doc._nodeBag.lights,i=t.length;if(i>0){var o=this._scene.getVolume();if(o.isValid()){var s=x3dom.fields.SFVec3f.MAX(),r=x3dom.fields.SFVec3f.MIN();o.getBounds(s,r);var n=[],a=this._scene.getViewpoint(),d=a.getFieldOfView(),l=r.subtract(s),h=l.y/2/Math.tan(d/2)+l.z/2,u=l.x/2/Math.tan(d/2)+l.z/2;for(l=s.add(l.multiply(.5)),e=0;i>e;e++){if(x3dom.isa(t[e],x3dom.nodeTypes.PointLight)){var f=t[e].getCurrentTransform().multMatrixPnt(t[e]._vf.location);l=l.subtract(f).normalize()}else{var _=t[e].getCurrentTransform().multMatrixVec(t[e]._vf.direction);_=_.normalize().negate(),l=l.add(_.multiply(1.2*(h>u?h:u)))}n[e]=t[e].getViewMatrix(l)}return n}}return[this.getViewMatrix()]},x3dom.Viewarea.prototype.getWCtoLCMatrix=function(e){var t,i=this.getProjectionMatrix();return t=0===arguments.length?this.getLightMatrix()[0]:e,i.mult(t)},x3dom.Viewarea.prototype.getWCtoLCMatricesPointLight=function(e,t,i){var o=t._vf.zNear,s=t._vf.zFar,r=this.getLightProjectionMatrix(e,o,s,!1,i);r._00=1,r._11=1;var n=[];n[0]=r.mult(e);for(var a,d=1;3>=d;d++)a=x3dom.fields.SFMatrix4f.rotationY(d*Math.PI/2),n[d]=r.mult(a.mult(e));return a=x3dom.fields.SFMatrix4f.rotationX(Math.PI/2),n[4]=r.mult(a.mult(e)),a=x3dom.fields.SFMatrix4f.rotationX(3*Math.PI/2),n[5]=r.mult(a.mult(e)),n},x3dom.Viewarea.prototype.getWCtoLCMatricesCascaded=function(e,t,i){var o=Math.max(1,Math.min(t._vf.shadowCascades,6)),s=Math.max(0,Math.min(t._vf.shadowSplitFactor,1)),r=Math.max(0,Math.min(t._vf.shadowSplitOffset,1)),n=x3dom.isa(t,x3dom.nodeTypes.SpotLight),a=t._vf.zNear,d=t._vf.zFar,l=this.getLightProjectionMatrix(e,a,d,!0,i);n&&(l._00=1,l._11=1);var h=l.mult(e),u=[];if(1==o)return u[0]=h,u;for(var f=this.getShadowSplitDepths(o,s,r,!0,i),_=0;o>_;_++){var c=this.getLightFittingMatrix(h,f[_],f[_+1],i);u[_]=c.mult(h)}return u},x3dom.Viewarea.prototype.getLightProjectionMatrix=function(e,t,i,o,s){var r=x3dom.fields.SFMatrix4f.copy(s);if(!o||t>0||i>0){var n,a,d=e.inverse().e3(),l=.8,h=1.2,u=x3dom.fields.SFVec3f.copy(this._scene._lastMin),f=x3dom.fields.SFVec3f.copy(this._scene._lastMax),_=f.subtract(u),c=_.length()/2,m=u.add(_.multiply(.5)),p=d.subtract(m).length();return c&&(n=p>c?(p-c)*l:1,a=(p+c)*h),t>0&&(n=t),i>0&&(a=i),r._22=-(a+n)/(a-n),r._23=-2*a*n/(a-n),r}var x=this.getLightCropMatrix(r.mult(e));return x.mult(r)},x3dom.Viewarea.prototype.getProjectionMatrix=function(){var e=this._scene.getViewpoint();return e.getProjectionMatrix(this._width/this._height)},x3dom.Viewarea.prototype.getViewfrustum=function(e){var t=this._scene.getEnvironment();if(1==t._vf.frustumCulling){if(0==arguments.length){var i=this.getProjectionMatrix(),o=this.getViewMatrix();return new x3dom.fields.FrustumVolume(i.mult(o))}return new x3dom.fields.FrustumVolume(e)}return null},x3dom.Viewarea.prototype.getWCtoCCMatrix=function(){var e=this.getViewMatrix(),t=this.getProjectionMatrix();return t.mult(e)},x3dom.Viewarea.prototype.getCCtoWCMatrix=function(){var e=this.getWCtoCCMatrix();return e.inverse()},x3dom.Viewarea.prototype.calcViewRay=function(e,t,i){var o=i?i:this.getCCtoWCMatrix(),s=e/(this._width-1)*2-1,r=(this._height-1-t)/(this._height-1)*2-1,n=o.multFullMatrixPnt(new x3dom.fields.SFVec3f(s,r,-1)),a=o.multFullMatrixPnt(new x3dom.fields.SFVec3f(s,r,1)),d=a.subtract(n);return new x3dom.fields.Ray(n,d)},x3dom.Viewarea.prototype.showAll=function(e){void 0===e&&(e="negZ");var t=this._scene;t.updateVolume();var i,o=x3dom.fields.SFVec3f.copy(t._lastMin),s=x3dom.fields.SFVec3f.copy(t._lastMax),r="x",n="y",a="z",d=1,l=new x3dom.fields.SFVec3f(0,0,-1);switch(e){case"posX":d=-1;case"negX":a="x",r="y",n="z",i=new x3dom.fields.SFVec3f(d,0,0);break;case"posY":d=-1;case"negY":a="y",r="z",n="x",i=new x3dom.fields.SFVec3f(0,d,0);break;case"posZ":d=-1;case"negZ":default:i=new x3dom.fields.SFVec3f(0,0,-d)}var h=t.getViewpoint(),u=h.getFieldOfView(),f=s.subtract(o),_=f[a]/2,c=Math.tan(u/2),m=f[n]/2/c+_,p=f[r]/2/c+_;f=o.add(f.multiply(.5)),f[a]+=d*(m>p?m:p)*1.01;var x=x3dom.fields.Quaternion.rotateFromTo(l,i),g=x.toMatrix();g=g.mult(x3dom.fields.SFMatrix4f.translation(f.negate())),this.animateTo(g,h)},x3dom.Viewarea.prototype.fit=function(e,t,i){void 0===i&&(i=!0);var o=t.subtract(e).multiply(.5),s=e.add(o),r=o.length(),n=this._scene.getViewpoint(),a=n.getFieldOfView(),d=x3dom.fields.SFMatrix4f.copy(this.getViewMatrix()),l=new x3dom.fields.SFVec3f(d._00,d._01,d._02),h=new x3dom.fields.SFVec3f(d._10,d._11,d._12),u=new x3dom.fields.SFVec3f(d._20,d._21,d._22),f=Math.tan(a/2),_=r/f,c=s.add(u.multiply(_));d._03=-l.dot(c),d._13=-h.dot(c),d._23=-u.dot(c),i&&n.setCenterOfRotation(s),x3dom.isa(n,x3dom.nodeTypes.OrthoViewpoint)?(n._vf.fieldOfView[0]=-_,n._vf.fieldOfView[1]=-_,n._vf.fieldOfView[2]=_,n._vf.fieldOfView[3]=_,n._projMatrix=null,this.animateTo(d,n,0)):this.animateTo(d,n)},x3dom.Viewarea.prototype.resetView=function(){var e=this._scene.getNavigationInfo();if("teleport"!==e._vf.transitionType[0].toLowerCase()&&"game"!==e.getType()){this._mixer._beginTime=this._lastTS,this._mixer._endTime=this._lastTS+e._vf.transitionTime,this._mixer.setBeginMatrix(this.getViewMatrix());var t=this._scene.getViewpoint();t.resetView(),t=t.getViewMatrix().mult(t.getCurrentTransform().inverse()),this._mixer.setEndMatrix(t)}else this._scene.getViewpoint().resetView();this.resetNavHelpers(),e._heliUpdated=!1},x3dom.Viewarea.prototype.resetNavHelpers=function(){this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0},x3dom.Viewarea.prototype.uprightView=function(){var e=this.getViewMatrix().inverse(),t=e.e3(),i=t.subtract(e.e2()),o=new x3dom.fields.SFVec3f(0,1,0),s=e.e2().cross(o).normalize(),r=s.cross(o).normalize();i=t.add(r),e=x3dom.fields.SFMatrix4f.lookAt(t,i,o),e=e.inverse(),this.animateTo(e,this._scene.getViewpoint())},x3dom.Viewarea.prototype.callEvtHandler=function(e,t,i){if(!e||!e._xmlNode)return null;try{var o=e._xmlNode[t];if("function"==typeof o)o.call(e._xmlNode,i);else{var s=e._xmlNode.getAttribute(t),r=new Function("event",s);r.call(e._xmlNode,i)}var n=e._listeners[i.type];if(n)for(var a=0;a<n.length;a++)n[a].call(e._xmlNode,i)}catch(d){x3dom.debug.logException(d)}return i.cancelBubble},x3dom.Viewarea.prototype.checkEvents=function(e,t,i,o,s){var r,n,a,d=this,l=!0,h=e&&e._xmlNode?e._xmlNode:{},u=this._doc._nodeBag.affectedPointingSensors,f={viewarea:d,target:h,type:s.substr(2,s.length-2),button:o,layerX:t,layerY:i,worldX:d._pick.x,worldY:d._pick.y,worldZ:d._pick.z,normalX:d._pickNorm.x,normalY:d._pickNorm.y,normalZ:d._pickNorm.z,hitPnt:d._pick.toGL(),hitObject:h,shadowObjectId:d._pickingInfo.shadowObjectId,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};try{var _=e;_&&_._xmlNode&&_._cf.geometry&&!_._xmlNode[s]&&!_._xmlNode.hasAttribute(s)&&!_._listeners[f.type]&&(_=_._cf.geometry.node),_&&d.callEvtHandler(_,s,f)===!0&&(l=!1)}catch(c){x3dom.debug.logException(c)}var m=function p(e){Array.forEach(e._parentNodes,function(e){if(e._xmlNode&&(e._xmlNode[s]||e._xmlNode.hasAttribute(s)||e._listeners[f.type])&&d.callEvtHandler(e,s,f)===!0&&(l=!1),0==o&&0==u.length&&("onmousemove"==s||"onmouseover"==s||"onmouseout"==s))for(a=e._childNodes.length,n=0;a>n;++n)r=e._childNodes[n],x3dom.isa(r,x3dom.nodeTypes.X3DPointingDeviceSensorNode)&&r._vf.enabled&&u.push(r);x3dom.isa(e,x3dom.nodeTypes.Anchor)&&"onclick"===s?(e.handleTouch(),l=!1):l&&p(e)})};return l&&e&&m(e),l},x3dom.Viewarea.prototype._notifyAffectedPointingSensors=function(e){var t,i={mousedown:"pointerPressedOverSibling",mousemove:"pointerMoved",mouseover:"pointerMovedOver",mouseout:"pointerMovedOut"},o=i[e.type],s=this._doc._nodeBag.affectedPointingSensors,r=s.length;if(r>0&&void 0!==o)for(t=0;r>t;t++)s[t][o](e)},x3dom.Viewarea.prototype.initMouseState=function(){this._deltaT=0,this._dx=0,this._dy=0,this._lastX=-1,this._lastY=-1,this._pressX=-1,this._pressY=-1,this._lastButton=0,this._isMoving=!1,this._needNavigationMatrixUpdate=!0},x3dom.Viewarea.prototype.initTurnTable=function(e,t){t=void 0==t?!0:t;var i=this.getViewMatrix(),o=this._scene.getViewpoint(),s=x3dom.fields.SFVec3f.copy(o.getCenterOfRotation());this._flyMat=i.inverse(),this._from=this._flyMat.e3(),this._at=s,this._up=this._flyMat.e1(),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,this._up),this._flyMat=this.calcOrbit(0,0,e);var r=0;t&&(r=.2/e._vf.speed),this.animateTo(this._flyMat.inverse(),o,r),this.resetNavHelpers()},x3dom.Viewarea.prototype.onMousePress=function(e,t,i){if(this._needNavigationMatrixUpdate=!0,this.prepareEvents(e,t,i,"onmousedown"),this._pickingInfo.lastClickObj=this._pickingInfo.pickObj,this._pickingInfo.firstObj=this._pickingInfo.pickObj,this._dx=0,this._dy=0,this._lastX=e,this._lastY=t,this._pressX=e,this._pressY=t,this._lastButton=i,this._isMoving=!1,this._currentInputType==x3dom.InputTypes.NAVIGATION){var o=this._scene.getNavigationInfo();"turntable"===o.getType()&&this.initTurnTable(o,!1)}},x3dom.Viewarea.prototype.onMouseRelease=function(e,t,i,o){var s,r=this._doc._nodeBag.affectedPointingSensors;for(s=0;s<r.length;++s)r[s].pointerReleased();this._doc._nodeBag.affectedPointingSensors=[];var n,a=3,d=this._scene.getNavigationInfo(),l=d.getType();if("box"!==this._scene._vf.pickMode.toLowerCase()){if(this.prepareEvents(e,t,o,"onmouseup"),this._pickingInfo.pickObj&&this._pickingInfo.pickObj===this._pickingInfo.lastClickObj)this.prepareEvents(e,t,o,"onclick");else if(!this._pickingInfo.pickObj&&!this._pickingInfo.lastClickObj&&!this._pickingInfo.firstObj){var h="backgroundClicked";try{if(this._scene._xmlNode&&(this._scene._xmlNode["on"+h]||this._scene._xmlNode.hasAttribute("on"+h)||this._scene._listeners[h])){var u={target:this._scene._xmlNode,type:h,button:o,layerX:e,layerY:t,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};this._scene.callEvtHandler("on"+h,u)}}catch(f){x3dom.debug.logException("backgroundClicked: "+f)}}}else{var _=(new Date).getTime(),c=this.calcViewRay(e,t),m=this._scene.doIntersect(c),p=c.hitObject;m&&p&&(this._pick.setValues(c.hitPoint),this.checkEvents(p,e,t,i,"onclick"),x3dom.debug.logInfo("Hit '"+p._xmlNode.localName+"/ "+p._DEF+"' at dist="+c.dist.toFixed(4)),x3dom.debug.logInfo("Ray hit at position "+this._pick));var x=(new Date).getTime()-_;if(x3dom.debug.logInfo("Picking time (box): "+x+"ms"),!m){n=this.getViewMatrix().e2().negate();var g=n.dot(c.pos.negate())/n.dot(c.dir);this._pick=c.pos.add(c.dir.multiply(g))}}if(this._pickingInfo.firstObj=null,this._currentInputType==x3dom.InputTypes.NAVIGATION&&(this._pickingInfo.pickObj||this._pickingInfo.shadowObjectId>=0)&&"lookat"===l&&this._pressX===e&&this._pressY===t){var v=2&this._lastButton?-1:1,y=this._pickingInfo.pickPos.subtract(this._from).length()/a,b=new x3dom.fields.SFMatrix4f;b.setValues(this.getViewMatrix()),b=b.inverse();var T=b.e3(),S=(T.subtract(b.e2()),b.e1());n=this._pickingInfo.pickPos.subtract(T);var M=n.length();n=n.normalize();var C=T.addScaled(n,M),F=n.cross(S).normalize();n=F.cross(S).normalize(),0>v&&(y=2*(.5+M+y));var E=C.addScaled(n,y);b=x3dom.fields.SFMatrix4f.lookAt(E,C,S),b=b.inverse(),y=E.subtract(T).length();var w=Math.max(.5,Math.log((1+y)/d._vf.speed));this.animateTo(b,this._scene.getViewpoint(),w)}this._dx=0,this._dy=0,this._lastX=e,this._lastY=t,this._lastButton=i,this._isMoving=!1},x3dom.Viewarea.prototype.onMouseOver=function(e,t){this._dx=0,this._dy=0,this._lastButton=0,this._isMoving=!1,this._lastX=e,this._lastY=t,this._deltaT=0},x3dom.Viewarea.prototype.onMouseOut=function(e,t){this._dx=0,this._dy=0,this._lastButton=0,this._isMoving=!1,this._lastX=e,this._lastY=t,this._deltaT=0;var i,o=this._doc._nodeBag.affectedPointingSensors;for(i=0;i<o.length;++i)o[i].pointerReleased();this._doc._nodeBag.affectedPointingSensors=[]},x3dom.Viewarea.prototype.onDoubleClick=function(){if(!this._doc._x3dElem.hasAttribute("disableDoubleClick")||"true"!==this._doc._x3dElem.getAttribute("disableDoubleClick")){var e=this._scene.getNavigationInfo();if("none"!=e.getType()){var t=this._scene._vf.pickMode.toLowerCase();if("color"!=t&&"texcoord"!=t){var i=this._scene.getViewpoint();i.setCenterOfRotation(this._pick),x3dom.debug.logInfo("New center of Rotation:  "+this._pick);var o=this.getViewMatrix().inverse(),s=o.e3(),r=this._pick,n=o.e1(),a=o.e0().cross(n).normalize(),d=a.dot(this._pick.subtract(s));s=r.addScaled(a,-d),o=x3dom.fields.SFMatrix4f.lookAt(s,r,n),x3dom.debug.logInfo("New camera position:  "+s),this.animateTo(o.inverse(),i)}}}},x3dom.Viewarea.prototype.handleMoveEvt=function(e,t,i){if(0==i&&(this._doc._nodeBag.affectedPointingSensors=[]),this.prepareEvents(e,t,i,"onmousemove"),this._pickingInfo.pickObj!==this._pickingInfo.lastObj){if(this._pickingInfo.lastObj){var o=this._pickingInfo.pickObj;this._pickingInfo.pickObj=this._pickingInfo.lastObj,this.prepareEvents(e,t,i,"onmouseout"),this._pickingInfo.pickObj=o}this._pickingInfo.pickObj&&this.prepareEvents(e,t,i,"onmouseover"),this._pickingInfo.lastObj=this._pickingInfo.pickObj}},x3dom.Viewarea.prototype.onMove=function(e,t,i){this.handleMoveEvt(e,t,i),(this._lastX<0||this._lastY<0)&&(this._lastX=e,this._lastY=t),this._dx=e-this._lastX,this._dy=t-this._lastY,this._lastX=e,this._lastY=t},x3dom.Viewarea.prototype.onMoveView=function(e,t){if(this._currentInputType==x3dom.InputTypes.NAVIGATION){var i=this._scene.getNavigationInfo(),o=this._scene.getViewpoint();if("examine"===i.getType()){if(e){var s=this._scene._lastMax.subtract(this._scene._lastMin).length();s=(s<x3dom.fields.Eps?1:s)*i._vf.speed,e=e.multiply(s),this._movement=this._movement.add(e),this._transMat=o.getViewMatrix().inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(o.getViewMatrix())}if(t){var r=o.getCenterOfRotation(),n=this.getViewMatrix();n.setTranslate(new x3dom.fields.SFVec3f(0,0,0)),this._rotMat=this._rotMat.mult(x3dom.fields.SFMatrix4f.translation(r)).mult(n.inverse()).mult(t).mult(n).mult(x3dom.fields.SFMatrix4f.translation(r.negate()))}this._isMoving=!0}}},x3dom.Viewarea.prototype.onDrag=function(e,t,i){if(this.handleMoveEvt(e,t,i),this._currentInputType==x3dom.InputTypes.NAVIGATION){var o=this._scene.getNavigationInfo(),s=o.getType(),r=o.getExplorationMode();if("none"===s||0==r)return;var n,a,d,l,h,u=this._scene.getViewpoint(),f=e-this._lastX,_=t-this._lastY,c=null;if(i=!r||7!=r&&1==i?r:i,"examine"===s){if(1&i){l=2*_*Math.PI/this._width,h=2*f*Math.PI/this._height,c=this.getViewMatrix();var m=x3dom.fields.SFMatrix4f.rotationX(l),p=x3dom.fields.SFMatrix4f.rotationY(h),x=u.getCenterOfRotation();c.setTranslate(new x3dom.fields.SFVec3f(0,0,0)),this._rotMat=this._rotMat.mult(x3dom.fields.SFMatrix4f.translation(x)).mult(c.inverse()).mult(m).mult(p).mult(c).mult(x3dom.fields.SFMatrix4f.translation(x.negate()))}if(4&i&&(n=this._scene._lastMax.subtract(this._scene._lastMin).length(),n=(n<x3dom.fields.Eps?1:n)*o._vf.speed,a=new x3dom.fields.SFVec3f(n*f/this._width,n*-_/this._height,0),this._movement=this._movement.add(a),c=this.getViewpointMatrix().mult(this._transMat),this._transMat=c.inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(c)),2&i)if(n=this._scene._lastMax.subtract(this._scene._lastMin).length(),n=(n<x3dom.fields.Eps?1:n)*o._vf.speed,a=new x3dom.fields.SFVec3f(0,0,n*(f+_)/this._height),x3dom.isa(u,x3dom.nodeTypes.OrthoViewpoint))u._vf.fieldOfView[0]+=a.z,u._vf.fieldOfView[1]+=a.z,u._vf.fieldOfView[2]-=a.z,u._vf.fieldOfView[3]-=a.z,u._projMatrix=null;else{if(o._vf.typeParams.length>=6){var g=-o._vf.typeParams[5],v=o._vf.typeParams[4];this._movement.z=Math.min(Math.max(this._movement.z,g),v)}this._movement=this._movement.add(a),c=this.getViewpointMatrix().mult(this._transMat),this._transMat=c.inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(c)}this._isMoving=!0}else if("turntable"===s){if(this._flyMat||this.initTurnTable(o,!1),1&i)l=2*_*Math.PI/this._height,h=2*f*Math.PI/this._width,this._flyMat=this.calcOrbit(l,h,o),u.setView(this._flyMat.inverse());else if(2&i){n=this._scene._lastMax.subtract(this._scene._lastMin).length(),n=(n<x3dom.fields.Eps?1:n)*o._vf.speed,this._up=this._flyMat.e1(),this._from=this._flyMat.e3(),d=u.getCenterOfRotation();var y=d.subtract(this._from),b=y.length();y=y.normalize();var T=n*(f+_)/this._height;if(o._vf.typeParams.length>=5&&o._vf.typeParams[4]>0){var S=Math.min(T,b-o._vf.typeParams[4]);this._from=this._from.addScaled(y,S)}else{var M=T-b+.01;M>=0&&(d=d.addScaled(y,M),u.setCenterOfRotation(d)),this._from=this._from.addScaled(y,T)}this._from=this._from.addScaled(y,T),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,d,this._up),u.setView(this._flyMat.inverse())}else if(4&i){n=this._scene._lastMax.subtract(this._scene._lastMin).length(),n=(n<x3dom.fields.Eps?1:n)*o._vf.speed*.75;var C=-n*f/this._width,F=n*_/this._height;this._up=this._flyMat.e1(),this._from=this._flyMat.e3();var E=this._flyMat.e0();this._from=this._from.addScaled(this._up,F),this._from=this._from.addScaled(E,C),d=u.getCenterOfRotation(),d=d.addScaled(this._up,F),d=d.addScaled(E,C),u.setCenterOfRotation(d),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,d,this._up),u.setView(this._flyMat.inverse())}this._isMoving=!0}}this._dx=f,this._dy=_,this._lastX=e,this._lastY=t},x3dom.Viewarea.prototype.calcOrbit=function(e,t,i){this._up=this._flyMat.e1(),this._from=this._flyMat.e3();var o=this._from.subtract(this._at),s=Math.atan2(o.x,o.z),r=Math.atan2(Math.sqrt(o.x*o.x+o.z*o.z),o.y);s-=t,r-=e;var n=i.getTypeParams();r=Math.max(n[2],Math.min(n[3],r));var a=o.length(),d=a*Math.sin(r);o.x=d*Math.sin(s),o.y=a*Math.cos(r),o.z=d*Math.cos(s),o=this._at.add(o),r-=Math.PI/2;var l=Math.sin(r),h=Math.cos(r),u=new x3dom.fields.SFVec3f(l*Math.sin(s),h,l*Math.cos(s));return u.y<0&&(u=u.negate()),x3dom.fields.SFMatrix4f.lookAt(o,this._at,u)},x3dom.Viewarea.prototype.prepareEvents=function(e,t,i,o){var s=this._doc._nodeBag.affectedPointingSensors,r=this._scene._vf.pickMode.toLowerCase(),n=0==r.indexOf("idbuf")||"color"==r||"texcoord"==r,a=null;n&&(a=this._pickingInfo.pickObj,a&&(this._pick.setValues(this._pickingInfo.pickPos),this._pickNorm.setValues(this._pickingInfo.pickNorm),this.checkEvents(a,e,t,i,o),"onclick"===o&&(a._xmlNode&&x3dom.debug.logInfo('Hit "'+a._xmlNode.localName+"/ "+a._DEF+'"'),x3dom.debug.logInfo("Ray hit at position "+this._pick))));var d={viewarea:this,target:{},type:o.substr(2,o.length-2),button:i,layerX:e,layerY:t,worldX:this._pick.x,worldY:this._pick.y,worldZ:this._pick.z,normalX:this._pickNorm.x,normalY:this._pickNorm.y,normalZ:this._pickNorm.z,hitPnt:this._pick.toGL(),hitObject:a&&a._xmlNode?a._xmlNode:null,shadowObjectId:this._pickingInfo.shadowObjectId,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};this._notifyAffectedPointingSensors(d),this._currentInputType=s.length>0?x3dom.InputTypes.INTERACTION:x3dom.InputTypes.NAVIGATION},x3dom.Viewarea.prototype.getRenderMode=function(){return this._points},x3dom.Viewarea.prototype.getShadowedLights=function(){for(var e=[],t=0,i=this.getLights(),o=0;o<i.length;o++)i[o]._vf.shadowIntensity>0&&(e[t]=i[o],t++);return e},x3dom.Viewarea.prototype.getShadowSplitDepths=function(e,t,i,o,s){var r,n=[],a=this._scene.getViewpoint(),d=a.getNear(),l=a.getFar();n[0]=d,d+=i*(l-d)/10;for(var h=1;e>h;h++)r=d*Math.pow(l/d,h/e),n[h]=t*r+(1-t)*(d+h/(e*(d-l)));if(n[e]=l,!o)return n;for(var u=[],f=0;e>=f;f++)u[f]=s.multFullMatrixPnt(new x3dom.fields.SFVec3f(0,0,-n[f])).z;return u},x3dom.Viewarea.prototype.getLightCropMatrix=function(e){var t=x3dom.fields.SFVec3f.copy(this._scene._lastMin),i=x3dom.fields.SFVec3f.copy(this._scene._lastMax),o=[];o[0]=new x3dom.fields.SFVec3f(t.x,t.y,t.z),o[1]=new x3dom.fields.SFVec3f(t.x,t.y,i.z),o[2]=new x3dom.fields.SFVec3f(t.x,i.y,t.z),o[3]=new x3dom.fields.SFVec3f(t.x,i.y,i.z),o[4]=new x3dom.fields.SFVec3f(i.x,t.y,t.z),o[5]=new x3dom.fields.SFVec3f(i.x,t.y,i.z),o[6]=new x3dom.fields.SFVec3f(i.x,i.y,t.z),o[7]=new x3dom.fields.SFVec3f(i.x,i.y,i.z);var s;for(s=0;8>s;s++)o[s]=e.multFullMatrixPnt(o[s]);var r=x3dom.fields.SFVec3f.copy(o[0]),n=x3dom.fields.SFVec3f.copy(o[0]);for(s=1;8>s;s++)r.z=Math.min(o[s].z,r.z),n.z=Math.max(o[s].z,n.z);var a=2/(n.z-r.z),d=-(a*(n.z+r.z))/2,l=x3dom.fields.SFMatrix4f.identity();return l._22=a,l._23=d,l},x3dom.Viewarea.prototype.getLightFittingMatrix=function(e,t,i,o){function s(e,t){var i=e.x,o=e.y,s=e.z,r=t.x,n=t.y,a=t.z;i>1||-1>r?(i=-1,r=1):(i=Math.max(i,-1),r=Math.min(r,1)),o>1||-1>n?(o=-1,n=1):(o=Math.max(o,-1),n=Math.min(n,1)),s>1||-1>a?(s=-1,a=1):(s=Math.max(s,-1),a=Math.min(a,1));var d=new x3dom.fields.SFVec3f(i,o,s),l=new x3dom.fields.SFVec3f(r,n,a);return new x3dom.fields.BoxVolume(d,l)}var r=this.getViewMatrix(),n=o.mult(r),a=n.inverse(),d=[];d[0]=new x3dom.fields.SFVec3f(-1,-1,i),d[1]=new x3dom.fields.SFVec3f(-1,-1,t),d[2]=new x3dom.fields.SFVec3f(-1,1,i),d[3]=new x3dom.fields.SFVec3f(-1,1,t),d[4]=new x3dom.fields.SFVec3f(1,-1,i),d[5]=new x3dom.fields.SFVec3f(1,-1,t),d[6]=new x3dom.fields.SFVec3f(1,1,i),d[7]=new x3dom.fields.SFVec3f(1,1,t);var l;for(l=0;8>l;l++)d[l]=a.multFullMatrixPnt(d[l]),d[l]=e.multFullMatrixPnt(d[l]);var h=x3dom.fields.SFVec3f.copy(d[0]),u=x3dom.fields.SFVec3f.copy(d[0]);for(l=1;8>l;l++)h.x=Math.min(d[l].x,h.x),h.y=Math.min(d[l].y,h.y),h.z=Math.min(d[l].z,h.z),u.x=Math.max(d[l].x,u.x),u.y=Math.max(d[l].y,u.y),u.z=Math.max(d[l].z,u.z);var f=s(h,u),_=2/(f.max.x-f.min.x),c=2/(f.max.y-f.min.y),m=-(_*(f.max.x+f.min.x))/2,p=-(c*(f.max.y+f.min.y))/2,x=x3dom.fields.SFMatrix4f.identity();return x._00=_,x._11=c,x._03=m,x._13=p,x},x3dom.Mesh=function(e){this._parent=e,this._vol=new x3dom.fields.BoxVolume,this._invalidate=!0,this._numFaces=0,this._numCoords=0,this._primType="TRIANGLES",this._positions=[],this._normals=[],this._texCoords=[],this._colors=[],this._indices=[],this._positions[0]=[],this._normals[0]=[],this._texCoords[0]=[],this._colors[0]=[],this._indices[0]=[]},x3dom.Mesh.prototype._dynamicFields={},x3dom.Mesh.prototype._numPosComponents=3,x3dom.Mesh.prototype._numTexComponents=2,x3dom.Mesh.prototype._numColComponents=3,x3dom.Mesh.prototype._numNormComponents=3,x3dom.Mesh.prototype._lit=!0,x3dom.Mesh.prototype._vol=null,x3dom.Mesh.prototype._invalidate=!0,x3dom.Mesh.prototype._numFaces=0,x3dom.Mesh.prototype._numCoords=0,x3dom.Mesh.prototype.setMeshData=function(e,t,i,o,s){this._positions[0]=e,this._normals[0]=t,this._texCoords[0]=i,this._colors[0]=o,this._indices[0]=s,this._invalidate=!0,this._numFaces=this._indices[0].length/3,this._numCoords=this._positions[0].length/3},x3dom.Mesh.prototype.getVolume=function(){if(1==this._invalidate&&!this._vol.isValid()){var e=this._positions[0],t=e.length;if(t>3){var i=new x3dom.fields.SFVec3f(e[0],e[1],e[2]);this._vol.setBounds(i,i);for(var o=3;t>o;o+=3)this._vol.min.x>e[o]&&(this._vol.min.x=e[o]),this._vol.min.y>e[o+1]&&(this._vol.min.y=e[o+1]),this._vol.min.z>e[o+2]&&(this._vol.min.z=e[o+2]),this._vol.max.x<e[o]&&(this._vol.max.x=e[o]),this._vol.max.y<e[o+1]&&(this._vol.max.y=e[o+1]),this._vol.max.z<e[o+2]&&(this._vol.max.z=e[o+2]);this._invalidate=!1}}return this._vol},x3dom.Mesh.prototype.invalidate=function(){this._invalidate=!0,this._vol.invalidate()},x3dom.Mesh.prototype.isValid=function(){return this._vol.isValid()},x3dom.Mesh.prototype.getCenter=function(){return this.getVolume().getCenter()},x3dom.Mesh.prototype.getDiameter=function(){return this.getVolume().getDiameter()},x3dom.Mesh.prototype.doIntersect=function(e){var t=this.getVolume(),i=e.intersect(t.min,t.max);return i&&e.enter<e.dist&&(e.dist=e.enter,e.hitObject=this._parent,e.hitPoint=e.pos.add(e.dir.multiply(e.enter))),i},x3dom.Mesh.prototype.calcNormals=function(e,t){void 0===t&&(t=!0);var i,o,s,r,n=this._multiIndIndices&&this._multiIndIndices.length,a=n?this._multiIndIndices:this._indices[0],d=this._positions[0],l=[],h=[],u=d.length,f=null,_=void 0!==this._posSize&&this._posSize>u?this._posSize/3:u/3;for(_=3*(_-Math.floor(_)>0?Math.floor(_+1):_),i=0;_>i;++i)h[i]=[];for(_=a.length,i=0;_>i;i+=3){var c,m,p,x;n?(c=3*i,m=3*(i+1),p=3*(i+2),x=new x3dom.fields.SFVec3f(d[m],d[m+1],d[m+2]),s=new x3dom.fields.SFVec3f(d[c],d[c+1],d[c+2]).subtract(x),r=x.subtract(new x3dom.fields.SFVec3f(d[p],d[p+1],d[p+2]))):(c=3*a[i],m=3*a[i+1],
p=3*a[i+2],x=new x3dom.fields.SFVec3f(d[m],d[m+1],d[m+2]),s=new x3dom.fields.SFVec3f(d[c],d[c+1],d[c+2]).subtract(x),r=x.subtract(new x3dom.fields.SFVec3f(d[p],d[p+1],d[p+2])),c=3*i,m=3*(i+1),p=3*(i+2)),f=s.cross(r).normalize(),t||(f=f.negate()),e<=x3dom.fields.Eps?(l[c]=l[m]=l[p]=f.x,l[c+1]=l[m+1]=l[p+1]=f.y,l[c+2]=l[m+2]=l[p+2]=f.z):(h[a[i]].push(f),h[a[i+1]].push(f),h[a[i+2]].push(f))}if(e>x3dom.fields.Eps)for(i=0;u>i;i+=3){var g,v=i/3;for(g=n?h[a[v]]:h[v],_=g.length,f=new x3dom.fields.SFVec3f(0,0,0),o=0;_>o;++o)f=f.add(g[o]);f=f.normalize(),l[i]=f.x,l[i+1]=f.y,l[i+2]=f.z}this._normals[0]=l},x3dom.Mesh.prototype.splitMesh=function(e,t){var i,o;i=void 0===("undefined"==typeof e?"undefined":_typeof(e))?3:e,void 0===("undefined"==typeof t?"undefined":_typeof(t))&&(t=!1);var s=x3dom.Utils.maxIndexableCoords;if(s=Math.floor(s/i)*i,!(this._positions[0].length/3<=s)||t){o=t?this._multiIndIndices&&this._multiIndIndices.length:!1;var r=this._positions[0],n=this._normals[0],a=this._texCoords[0],d=this._colors[0],l=o?this._multiIndIndices:this._indices[0],h=0;do{this._positions[h]=[],this._normals[h]=[],this._texCoords[h]=[],this._colors[h]=[],this._indices[h]=[];var u=l.length-(h+1)*s>=0;if(this._indices[h]=u?l.slice(h*s,(h+1)*s):l.slice(h*s),o)for(var f=0,_=this._indices[h].length;_>f;f++)this._indices[h][f]=f;else if(h)for(var c=h*s,f=0,_=this._indices[h].length;_>f;f++)this._indices[h][f]-=c;this._positions[h]=u?r.slice(h*s*3,3*(h+1)*s):r.slice(h*s*3),n.length&&(this._normals[h]=u?n.slice(h*s*3,3*(h+1)*s):n.slice(h*s*3)),a.length&&(this._texCoords[h]=u?a.slice(h*s*this._numTexComponents,this._numTexComponents*(h+1)*s):a.slice(h*s*this._numTexComponents)),d.length&&(this._colors[h]=u?d.slice(h*s*this._numColComponents,this._numColComponents*(h+1)*s):d.slice(h*s*this._numColComponents))}while(r.length>++h*s*3)}},x3dom.Mesh.prototype.calcTexCoords=function(e){if(this._texCoords[0]=[],"sphere-local"===e.toLowerCase())for(var t=0,i=0,o=this._normals[0].length;o>t;t+=3)this._texCoords[0][i++]=.5+this._normals[0][t]/2,this._texCoords[0][i++]=.5+this._normals[0][t+1]/2;else{var s=new x3dom.fields.SFVec3f(0,0,0),r=new x3dom.fields.SFVec3f(0,0,0),n=this.getVolume();n.getBounds(s,r);var a=r.subtract(s),d=0,l=1;a.x>=a.y?a.x>=a.z?(d=0,l=a.y>=a.z?1:2):(d=2,l=0):a.y>=a.z?(d=1,l=a.x>=a.z?0:2):(d=2,l=1);var h=1,u=1,f=0,_=0;switch(d){case 0:h=a.x,f=s.x;break;case 1:h=a.y,f=s.y;break;case 2:h=a.z,f=s.z}switch(l){case 0:u=a.x,_=s.x;break;case 1:u=a.y,_=s.y;break;case 2:u=a.z,_=s.z}for(var c=0,m=0,p=this._positions[0].length;p>c;c+=3)this._texCoords[0][m++]=(this._positions[0][c+d]-f)/h,this._texCoords[0][m++]=(this._positions[0][c+l]-_)/u}},"undefined"==typeof x3dom&&(x3dom={extend:function(e){function t(){}return t.prototype=e.prototype||e,new t},debug:{logInfo:function(e){console.log(e)},logWarning:function(e){console.warn(e)},logError:function(e){console.error(e)}}},Array.map||(Array.map=function(e,t,i){for(var o=e.length,s=[],r=0;o>r;r++)r in e&&(s[r]=t.call(i,e[r],r,e));return s}),console.log("Using x3dom fields.js as standalone math and/or base types library.")),x3dom.fields={};var VecMath=x3dom.fields;return x3dom.fields.Eps=1e-6,x3dom.fields.SFMatrix4f=function(e,t,i,o,s,r,n,a,d,l,h,u,f,_,c,m){0===arguments.length?(this._00=1,this._01=0,this._02=0,this._03=0,this._10=0,this._11=1,this._12=0,this._13=0,this._20=0,this._21=0,this._22=1,this._23=0,this._30=0,this._31=0,this._32=0,this._33=1):(this._00=e,this._01=t,this._02=i,this._03=o,this._10=s,this._11=r,this._12=n,this._13=a,this._20=d,this._21=l,this._22=h,this._23=u,this._30=f,this._31=_,this._32=c,this._33=m)},x3dom.fields.SFMatrix4f.prototype.e0=function(){var e=new x3dom.fields.SFVec3f(this._00,this._10,this._20);return e.normalize()},x3dom.fields.SFMatrix4f.prototype.e1=function(){var e=new x3dom.fields.SFVec3f(this._01,this._11,this._21);return e.normalize()},x3dom.fields.SFMatrix4f.prototype.e2=function(){var e=new x3dom.fields.SFVec3f(this._02,this._12,this._22);return e.normalize()},x3dom.fields.SFMatrix4f.prototype.e3=function(){return new x3dom.fields.SFVec3f(this._03,this._13,this._23)},x3dom.fields.SFMatrix4f.copy=function(e){return new x3dom.fields.SFMatrix4f(e._00,e._01,e._02,e._03,e._10,e._11,e._12,e._13,e._20,e._21,e._22,e._23,e._30,e._31,e._32,e._33)},x3dom.fields.SFMatrix4f.prototype.copy=function(){return x3dom.fields.SFMatrix4f.copy(this)},x3dom.fields.SFMatrix4f.identity=function(){return new x3dom.fields.SFMatrix4f(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},x3dom.fields.SFMatrix4f.zeroMatrix=function(){return new x3dom.fields.SFMatrix4f(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},x3dom.fields.SFMatrix4f.translation=function(e){return new x3dom.fields.SFMatrix4f(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationX=function(e){var t=Math.cos(e),i=Math.sin(e);return new x3dom.fields.SFMatrix4f(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationY=function(e){var t=Math.cos(e),i=Math.sin(e);return new x3dom.fields.SFMatrix4f(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationZ=function(e){var t=Math.cos(e),i=Math.sin(e);return new x3dom.fields.SFMatrix4f(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1)},x3dom.fields.SFMatrix4f.scale=function(e){return new x3dom.fields.SFMatrix4f(e.x,0,0,0,0,e.y,0,0,0,0,e.z,0,0,0,0,1)},x3dom.fields.SFMatrix4f.lookAt=function(e,t,i){var o=e.subtract(t).normalize(),s=i.normalize().cross(o).normalize();if(s.dot(s)<x3dom.fields.Eps)return x3dom.debug.logWarning("View matrix is linearly dependent."),x3dom.fields.SFMatrix4f.translation(e);var r=o.cross(s).normalize(),n=x3dom.fields.SFMatrix4f.identity();return n.setValue(s,r,o,e),n},x3dom.fields.SFMatrix4f.perspectiveFrustum=function(e,t,i,o,s,r){return new x3dom.fields.SFMatrix4f(2*s/(t-e),0,(t+e)/(t-e),0,0,2*s/(o-i),(o+i)/(o-i),0,0,0,-(r+s)/(r-s),-2*r*s/(r-s),0,0,-1,0)},x3dom.fields.SFMatrix4f.perspective=function(e,t,i,o){var s=1/Math.tan(e/2);return new x3dom.fields.SFMatrix4f(s/t,0,0,0,0,s,0,0,0,0,(i+o)/(i-o),2*i*o/(i-o),0,0,-1,0)},x3dom.fields.SFMatrix4f.ortho=function(e,t,i,o,s,r,n){var a=(t-e)/2,d=(o-i)/2,l=r-s;return void 0===n&&(n=1),a/d>n?d=a/n:a=d*n,e=-a,t=a,i=-d,o=d,a*=2,d*=2,new x3dom.fields.SFMatrix4f(2/a,0,0,-(t+e)/a,0,2/d,0,-(o+i)/d,0,0,-2/l,-(r+s)/l,0,0,0,1)},x3dom.fields.SFMatrix4f.prototype.setTranslate=function(e){this._03=e.x,this._13=e.y,this._23=e.z},x3dom.fields.SFMatrix4f.prototype.setScale=function(e){this._00=e.x,this._11=e.y,this._22=e.z},x3dom.fields.SFMatrix4f.prototype.setRotate=function(e){var t=e.x*e.x,i=e.x*e.y,o=e.x*e.z,s=e.y*e.y,r=e.y*e.z,n=e.z*e.z,a=e.w*e.x,d=e.w*e.y,l=e.w*e.z;this._00=1-2*(s+n),this._01=2*(i-l),this._02=2*(o+d),this._10=2*(i+l),this._11=1-2*(t+n),this._12=2*(r-a),this._20=2*(o-d),this._21=2*(r+a),this._22=1-2*(t+s)},x3dom.fields.SFMatrix4f.parseRotation=function(e){var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e),i=+t[1],o=+t[2],s=+t[3],r=+t[4],n=Math.sqrt(i*i+o*o+s*s);0===n?(i=1,o=s=0):(i/=n,o/=n,s/=n);var a=Math.cos(r),d=Math.sin(r),l=1-a;return new x3dom.fields.SFMatrix4f(l*i*i+a,l*i*o+d*s,l*i*s-d*o,0,l*i*o-d*s,l*o*o+a,l*o*s+d*i,0,l*i*s+d*o,l*o*s-d*i,l*s*s+a,0,0,0,0,1).transpose()},x3dom.fields.SFMatrix4f.parse=function(e){var t=!1,i=/matrix.*\((.+)\)/;i.exec(e)&&(e=RegExp.$1,t=!0);var o=Array.map(e.split(/[,\s]+/),function(e){return+e});return o.length>=16?t?new x3dom.fields.SFMatrix4f(o[0],o[4],o[8],o[12],o[1],o[5],o[9],o[13],o[2],o[6],o[10],o[14],o[3],o[7],o[11],o[15]):new x3dom.fields.SFMatrix4f(o[0],o[1],o[2],o[3],o[4],o[5],o[6],o[7],o[8],o[9],o[10],o[11],o[12],o[13],o[14],o[15]):6===o.length?new x3dom.fields.SFMatrix4f(o[0],o[1],0,o[4],o[2],o[3],0,o[5],0,0,1,0,0,0,0,1):(x3dom.debug.logWarning("SFMatrix4f - can't parse string: "+e),x3dom.fields.SFMatrix4f.identity())},x3dom.fields.SFMatrix4f.prototype.mult=function(e){return new x3dom.fields.SFMatrix4f(this._00*e._00+this._01*e._10+this._02*e._20+this._03*e._30,this._00*e._01+this._01*e._11+this._02*e._21+this._03*e._31,this._00*e._02+this._01*e._12+this._02*e._22+this._03*e._32,this._00*e._03+this._01*e._13+this._02*e._23+this._03*e._33,this._10*e._00+this._11*e._10+this._12*e._20+this._13*e._30,this._10*e._01+this._11*e._11+this._12*e._21+this._13*e._31,this._10*e._02+this._11*e._12+this._12*e._22+this._13*e._32,this._10*e._03+this._11*e._13+this._12*e._23+this._13*e._33,this._20*e._00+this._21*e._10+this._22*e._20+this._23*e._30,this._20*e._01+this._21*e._11+this._22*e._21+this._23*e._31,this._20*e._02+this._21*e._12+this._22*e._22+this._23*e._32,this._20*e._03+this._21*e._13+this._22*e._23+this._23*e._33,this._30*e._00+this._31*e._10+this._32*e._20+this._33*e._30,this._30*e._01+this._31*e._11+this._32*e._21+this._33*e._31,this._30*e._02+this._31*e._12+this._32*e._22+this._33*e._32,this._30*e._03+this._31*e._13+this._32*e._23+this._33*e._33)},x3dom.fields.SFMatrix4f.prototype.multMatrixPnt=function(e){return new x3dom.fields.SFVec3f(this._00*e.x+this._01*e.y+this._02*e.z+this._03,this._10*e.x+this._11*e.y+this._12*e.z+this._13,this._20*e.x+this._21*e.y+this._22*e.z+this._23)},x3dom.fields.SFMatrix4f.prototype.multMatrixVec=function(e){return new x3dom.fields.SFVec3f(this._00*e.x+this._01*e.y+this._02*e.z,this._10*e.x+this._11*e.y+this._12*e.z,this._20*e.x+this._21*e.y+this._22*e.z)},x3dom.fields.SFMatrix4f.prototype.multFullMatrixPnt=function(e){var t=this._30*e.x+this._31*e.y+this._32*e.z+this._33;return t&&(t=1/t),new x3dom.fields.SFVec3f((this._00*e.x+this._01*e.y+this._02*e.z+this._03)*t,(this._10*e.x+this._11*e.y+this._12*e.z+this._13)*t,(this._20*e.x+this._21*e.y+this._22*e.z+this._23)*t)},x3dom.fields.SFMatrix4f.prototype.multMatrixPlane=function(e){var t=new x3dom.fields.SFVec3f(e.x,e.y,e.z),i=t.multiply(-e.w);i=this.multMatrixPnt(i);var o=this.inverse().transpose();t=o.multMatrixVec(t);var s=-t.dot(i);return new x3dom.fields.SFVec4f(t.x,t.y,t.z,s)},x3dom.fields.SFMatrix4f.prototype.transpose=function(){return new x3dom.fields.SFMatrix4f(this._00,this._10,this._20,this._30,this._01,this._11,this._21,this._31,this._02,this._12,this._22,this._32,this._03,this._13,this._23,this._33)},x3dom.fields.SFMatrix4f.prototype.negate=function(){return new x3dom.fields.SFMatrix4f(-this._00,-this._01,-this._02,-this._03,-this._10,-this._11,-this._12,-this._13,-this._20,-this._21,-this._22,-this._23,-this._30,-this._31,-this._32,-this._33)},x3dom.fields.SFMatrix4f.prototype.multiply=function(e){return new x3dom.fields.SFMatrix4f(e*this._00,e*this._01,e*this._02,e*this._03,e*this._10,e*this._11,e*this._12,e*this._13,e*this._20,e*this._21,e*this._22,e*this._23,e*this._30,e*this._31,e*this._32,e*this._33)},x3dom.fields.SFMatrix4f.prototype.add=function(e){return new x3dom.fields.SFMatrix4f(this._00+e._00,this._01+e._01,this._02+e._02,this._03+e._03,this._10+e._10,this._11+e._11,this._12+e._12,this._13+e._13,this._20+e._20,this._21+e._21,this._22+e._22,this._23+e._23,this._30+e._30,this._31+e._31,this._32+e._32,this._33+e._33)},x3dom.fields.SFMatrix4f.prototype.addScaled=function(e,t){return new x3dom.fields.SFMatrix4f(this._00+t*e._00,this._01+t*e._01,this._02+t*e._02,this._03+t*e._03,this._10+t*e._10,this._11+t*e._11,this._12+t*e._12,this._13+t*e._13,this._20+t*e._20,this._21+t*e._21,this._22+t*e._22,this._23+t*e._23,this._30+t*e._30,this._31+t*e._31,this._32+t*e._32,this._33+t*e._33)},x3dom.fields.SFMatrix4f.prototype.setValues=function(e){this._00=e._00,this._01=e._01,this._02=e._02,this._03=e._03,this._10=e._10,this._11=e._11,this._12=e._12,this._13=e._13,this._20=e._20,this._21=e._21,this._22=e._22,this._23=e._23,this._30=e._30,this._31=e._31,this._32=e._32,this._33=e._33},x3dom.fields.SFMatrix4f.prototype.setValue=function(e,t,i,o){this._00=e.x,this._01=t.x,this._02=i.x,this._10=e.y,this._11=t.y,this._12=i.y,this._20=e.z,this._21=t.z,this._22=i.z,this._30=0,this._31=0,this._32=0,arguments.length>3&&(this._03=o.x,this._13=o.y,this._23=o.z,this._33=1)},x3dom.fields.SFMatrix4f.prototype.setFromArray=function(e){this._00=e[0],this._01=e[4],this._02=e[8],this._03=e[12],this._10=e[1],this._11=e[5],this._12=e[9],this._13=e[13],this._20=e[2],this._21=e[6],this._22=e[10],this._23=e[14],this._30=e[3],this._31=e[7],this._32=e[11],this._33=e[15]},x3dom.fields.SFMatrix4f.prototype.toGL=function(){return[this._00,this._10,this._20,this._30,this._01,this._11,this._21,this._31,this._02,this._12,this._22,this._32,this._03,this._13,this._23,this._33]},x3dom.fields.SFMatrix4f.prototype.at=function(e,t){var i="_"+e+t;return this[i]},x3dom.fields.SFMatrix4f.prototype.sqrt=function(){for(var e=x3dom.fields.SFMatrix4f.identity(),t=x3dom.fields.SFMatrix4f.copy(this),i=0;6>i;i++){var o=t.inverse(),s=0==i?x3dom.fields.SFMatrix4f.identity():e.inverse(),r=t.det(),n=e.det(),a=Math.abs(Math.pow(r*n,-.125)),d=1/a;t=t.multiply(a),t=t.addScaled(s,d),t=t.multiply(.5),e=e.multiply(a),e=e.addScaled(o,d),e=e.multiply(.5)}return t},x3dom.fields.SFMatrix4f.prototype.normInfinity=function(){var e=0,t=0;return(e=Math.abs(this._00))>t&&(t=e),(e=Math.abs(this._01))>t&&(t=e),(e=Math.abs(this._02))>t&&(t=e),(e=Math.abs(this._03))>t&&(t=e),(e=Math.abs(this._10))>t&&(t=e),(e=Math.abs(this._11))>t&&(t=e),(e=Math.abs(this._12))>t&&(t=e),(e=Math.abs(this._13))>t&&(t=e),(e=Math.abs(this._20))>t&&(t=e),(e=Math.abs(this._21))>t&&(t=e),(e=Math.abs(this._22))>t&&(t=e),(e=Math.abs(this._23))>t&&(t=e),(e=Math.abs(this._30))>t&&(t=e),(e=Math.abs(this._31))>t&&(t=e),(e=Math.abs(this._32))>t&&(t=e),(e=Math.abs(this._33))>t&&(t=e),t},x3dom.fields.SFMatrix4f.prototype.norm1_3x3=function(){var e=Math.abs(this._00)+Math.abs(this._10)+Math.abs(this._20),t=0;return(t=Math.abs(this._01)+Math.abs(this._11)+Math.abs(this._21))>e&&(e=t),(t=Math.abs(this._02)+Math.abs(this._12)+Math.abs(this._22))>e&&(e=t),e},x3dom.fields.SFMatrix4f.prototype.normInf_3x3=function(){var e=Math.abs(this._00)+Math.abs(this._01)+Math.abs(this._02),t=0;return(t=Math.abs(this._10)+Math.abs(this._11)+Math.abs(this._12))>e&&(e=t),(t=Math.abs(this._20)+Math.abs(this._21)+Math.abs(this._22))>e&&(e=t),e},x3dom.fields.SFMatrix4f.prototype.adjointT_3x3=function(){var e=x3dom.fields.SFMatrix4f.identity();return e._00=this._11*this._22-this._12*this._21,e._01=this._12*this._20-this._10*this._22,e._02=this._10*this._21-this._11*this._20,e._10=this._21*this._02-this._22*this._01,e._11=this._22*this._00-this._20*this._02,e._12=this._20*this._01-this._21*this._00,e._20=this._01*this._12-this._02*this._11,e._21=this._02*this._10-this._00*this._12,e._22=this._00*this._11-this._01*this._10,e},x3dom.fields.SFMatrix4f.prototype.equals=function(e){var t=1e-12;return Math.abs(this._00-e._00)<t&&Math.abs(this._01-e._01)<t&&Math.abs(this._02-e._02)<t&&Math.abs(this._03-e._03)<t&&Math.abs(this._10-e._10)<t&&Math.abs(this._11-e._11)<t&&Math.abs(this._12-e._12)<t&&Math.abs(this._13-e._13)<t&&Math.abs(this._20-e._20)<t&&Math.abs(this._21-e._21)<t&&Math.abs(this._22-e._22)<t&&Math.abs(this._23-e._23)<t&&Math.abs(this._30-e._30)<t&&Math.abs(this._31-e._31)<t&&Math.abs(this._32-e._32)<t&&Math.abs(this._33-e._33)<t},x3dom.fields.SFMatrix4f.prototype.getTransform=function(e,t,i,o,s){var r=null;if(arguments.length>4){r=x3dom.fields.SFMatrix4f.translation(s.negate()),r=r.mult(this);var n=x3dom.fields.SFMatrix4f.translation(s);r=r.mult(n)}else r=x3dom.fields.SFMatrix4f.copy(this);var a=r.decompose(e,t,i,o);i.setValues(i.multiply(a))},x3dom.fields.SFMatrix4f.prototype.decompose=function(e,t,i,o){var s=x3dom.fields.SFMatrix4f.copy(this),r=x3dom.fields.SFMatrix4f.identity(),n=x3dom.fields.SFMatrix4f.identity(),a=x3dom.fields.SFMatrix4f.identity();e.x=s._03,e.y=s._13,e.z=s._23,s._03=0,s._13=0,s._23=0,s._30=0,s._31=0,s._32=0;var d=s.polarDecompose(r,n),l=1;return 0>d&&(r=r.negate(),l=-1),t.setValue(r),n.spectralDecompose(a,i),o.setValue(a),l},x3dom.fields.SFMatrix4f.prototype.polarDecompose=function(e,t){var i,o,s,r,n,a=1e-12,d=this.transpose(),l=x3dom.fields.SFMatrix4f.identity(),h=d.norm1_3x3(),u=d.normInf_3x3();do{if(i=d.adjointT_3x3(),n=d._00*i._00+d._01*i._01+d._02*i._02,0==n){x3dom.debug.logWarning("polarDecompose: Mk_det == 0.0");break}o=i.norm1_3x3(),s=i.normInf_3x3();var f=Math.sqrt(Math.sqrt(o*s/(h*u))/Math.abs(n)),_=.5*f,c=.5/(f*n);l.setValues(d),d=d.multiply(_),d=d.addScaled(i,c),l=l.addScaled(d,-1),r=l.norm1_3x3(),h=d.norm1_3x3(),u=d.normInf_3x3()}while(r>h*a);e.setValues(d.transpose()),t.setValues(d.mult(this));for(var m=0;3>m;++m)for(var p=m;3>p;++p)t["_"+p+m]=.5*(t["_"+p+m]+t["_"+m+p]),t["_"+m+p]=.5*(t["_"+p+m]+t["_"+m+p]);return n},x3dom.fields.SFMatrix4f.prototype.spectralDecompose=function(e,t){for(var i=[1,2,0],o=20,s=[this._00,this._11,this._22],r=[this._12,this._20,this._01],n=0;o>n;++n){var a=Math.abs(r[0])+Math.abs(r[1])+Math.abs(r[2]);if(0==a)break;for(var d=2;d>=0;--d){var l=i[d],h=i[l],u=Math.abs(r[d]),f=100*u;if(u>0){var _=0,c=s[h]-s[l],m=Math.abs(c);if(m+f==m)_=r[d]/c;else{var p=.5*c/r[d];_=1/(Math.abs(p)+Math.sqrt(p*p+1)),_=0>p?-_:_}var x=1/Math.sqrt(_*_+1),g=_*x,v=g/(x+1),y=_*r[d];r[d]=0,s[l]-=y,s[h]+=y;var b=r[h];r[h]-=g*(r[l]+v*b),r[l]+=g*(b-v*r[l]);for(var T=2;T>=0;--T){var S=e["_"+T+l],M=e["_"+T+h];e["_"+T+l]-=g*(M+v*S),e["_"+T+h]+=g*(S-v*M)}}}}t.x=s[0],t.y=s[1],t.z=s[2]},x3dom.fields.SFMatrix4f.prototype.log=function(){var e=12,t=1e-12,i=x3dom.fields.SFMatrix4f.copy(this),o=x3dom.fields.SFMatrix4f.copy(this);o._00-=1,o._11-=1,o._22-=1,o._33-=1;for(var s=0;o.normInfinity()>.5;)i=i.sqrt(),o.setValues(i),o._00-=1,o._11-=1,o._22-=1,o._33-=1,s++;i._00-=1,i._11-=1,i._22-=1,i._33-=1,i=i.negate(),o.setValues(i);for(var r=x3dom.fields.SFMatrix4f.copy(i),n=1;o.normInfinity()>t&&e>n;)o=o.mult(i),n++,r=r.addScaled(o,1/n);return r.multiply(-(1<<s))},x3dom.fields.SFMatrix4f.prototype.exp=function(){var e=6,t=x3dom.fields.SFMatrix4f.copy(this),i=x3dom.fields.SFMatrix4f.identity(),o=x3dom.fields.SFMatrix4f.identity(),s=x3dom.fields.SFMatrix4f.identity(),r=0,n=1,a=1+parseInt(Math.log(t.normInfinity()/.693));for(0>a&&(a=0),t=t.multiply(1/(1<<a)),r=1;e>=r;r++)n*=(e-r+1)/(r*(2*e-r+1)),s=t.mult(s),o=o.addScaled(s,n),i=r%2?i.addScaled(s,-n):i.addScaled(s,n);for(s=i.inverse().mult(o),r=0;a>r;r++)s=s.mult(s);return s},x3dom.fields.SFMatrix4f.prototype.det3=function(e,t,i,o,s,r,n,a,d){return e*s*d+t*r*n+i*o*a-e*r*a-t*o*d-i*s*n},x3dom.fields.SFMatrix4f.prototype.det=function(){var e=this._00,t=this._10,i=this._20,o=this._30,s=this._01,r=this._11,n=this._21,a=this._31,d=this._02,l=this._12,h=this._22,u=this._32,f=this._03,_=this._13,c=this._23,m=this._33;return e*this.det3(r,l,_,n,h,c,a,u,m)-t*this.det3(s,d,f,n,h,c,a,u,m)+i*this.det3(s,d,f,r,l,_,a,u,m)-o*this.det3(s,d,f,r,l,_,n,h,c)},x3dom.fields.SFMatrix4f.prototype.inverse=function(){var e=this._00,t=this._10,i=this._20,o=this._30,s=this._01,r=this._11,n=this._21,a=this._31,d=this._02,l=this._12,h=this._22,u=this._32,f=this._03,_=this._13,c=this._23,m=this._33,p=this.det();return 0==p?(x3dom.debug.logWarning("Invert matrix: singular matrix, no inverse!"),x3dom.fields.SFMatrix4f.identity()):(p=1/p,new x3dom.fields.SFMatrix4f(+this.det3(r,l,_,n,h,c,a,u,m)*p,-this.det3(s,d,f,n,h,c,a,u,m)*p,+this.det3(s,d,f,r,l,_,a,u,m)*p,-this.det3(s,d,f,r,l,_,n,h,c)*p,-this.det3(t,l,_,i,h,c,o,u,m)*p,+this.det3(e,d,f,i,h,c,o,u,m)*p,-this.det3(e,d,f,t,l,_,o,u,m)*p,+this.det3(e,d,f,t,l,_,i,h,c)*p,+this.det3(t,r,_,i,n,c,o,a,m)*p,-this.det3(e,s,f,i,n,c,o,a,m)*p,+this.det3(e,s,f,t,r,_,o,a,m)*p,-this.det3(e,s,f,t,r,_,i,n,c)*p,-this.det3(t,r,l,i,n,h,o,a,u)*p,+this.det3(e,s,d,i,n,h,o,a,u)*p,-this.det3(e,s,d,t,r,l,o,a,u)*p,+this.det3(e,s,d,t,r,l,i,n,h)*p))},x3dom.fields.SFMatrix4f.prototype.getEulerAngles=function(){var e,t,i,o,s,r,n,a,d,l,h;return Math.abs(Math.abs(this._20)-1)>1e-4?(e=-Math.asin(this._20),t=Math.PI-e,l=Math.cos(e),h=Math.cos(t),n=Math.atan2(this._21/l,this._22/l),a=Math.atan2(this._21/h,this._22/h),o=Math.atan2(this._10/l,this._00/l),s=Math.atan2(this._10/h,this._00/h),[n,e,o,a,t,s]):(r=0,-1==this._20?(i=Math.PI/2,d=r+Math.atan2(this._01,this._02)):(i=-(Math.PI/2),d=-r+Math.atan2(-this._01,-this._02)),[d,i,r,d,i,r])},x3dom.fields.SFMatrix4f.prototype.toString=function(){return"\n"+this._00.toFixed(6)+", "+this._01.toFixed(6)+", "+this._02.toFixed(6)+", "+this._03.toFixed(6)+", \n"+this._10.toFixed(6)+", "+this._11.toFixed(6)+", "+this._12.toFixed(6)+", "+this._13.toFixed(6)+", \n"+this._20.toFixed(6)+", "+this._21.toFixed(6)+", "+this._22.toFixed(6)+", "+this._23.toFixed(6)+", \n"+this._30.toFixed(6)+", "+this._31.toFixed(6)+", "+this._32.toFixed(6)+", "+this._33.toFixed(6)},x3dom.fields.SFMatrix4f.prototype.setValueByStr=function(e){var t=!1,i=/matrix.*\((.+)\)/;i.exec(e)&&(e=RegExp.$1,t=!0);var o=Array.map(e.split(/[,\s]+/),function(e){return+e});return o.length>=16?t?(this._00=o[0],this._01=o[4],this._02=o[8],this._03=o[12],this._10=o[1],this._11=o[5],this._12=o[9],this._13=o[13],this._20=o[2],this._21=o[6],this._22=o[10],this._23=o[14],this._30=o[3],this._31=o[7],this._32=o[11],this._33=o[15]):(this._00=o[0],this._01=o[1],this._02=o[2],this._03=o[3],this._10=o[4],this._11=o[5],this._12=o[6],this._13=o[7],this._20=o[8],this._21=o[9],this._22=o[10],this._23=o[11],this._30=o[12],this._31=o[13],this._32=o[14],this._33=o[15]):6===o.length?(this._00=o[0],this._01=o[1],this._02=0,this._03=o[4],this._10=o[2],this._11=o[3],this._12=0,this._13=o[5],this._20=0,this._21=0,this._22=1,this._23=0,this._30=0,this._31=0,this._32=0,this._33=1):x3dom.debug.logWarning("SFMatrix4f - can't parse string: "+e),this},x3dom.fields.SFVec2f=function(e,t){0===arguments.length?(this.x=0,this.y=0):(this.x=e,this.y=t)},x3dom.fields.SFVec2f.copy=function(e){return new x3dom.fields.SFVec2f(e.x,e.y)},x3dom.fields.SFVec2f.parse=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return new x3dom.fields.SFVec2f(+t[1],+t[2])},x3dom.fields.SFVec2f.prototype.copy=function(){return x3dom.fields.SFVec2f.copy(this)},x3dom.fields.SFVec2f.prototype.setValues=function(e){this.x=e.x,this.y=e.y},x3dom.fields.SFVec2f.prototype.at=function(e){switch(e){case 0:return this.x;case 1:return this.y;default:return this.x}},x3dom.fields.SFVec2f.prototype.add=function(e){return new x3dom.fields.SFVec2f(this.x+e.x,this.y+e.y)},x3dom.fields.SFVec2f.prototype.subtract=function(e){return new x3dom.fields.SFVec2f(this.x-e.x,this.y-e.y)},x3dom.fields.SFVec2f.prototype.negate=function(){return new x3dom.fields.SFVec2f(-this.x,-this.y)},x3dom.fields.SFVec2f.prototype.dot=function(e){return this.x*e.x+this.y*e.y},x3dom.fields.SFVec2f.prototype.reflect=function(e){var t=2*this.dot(e);return new x3dom.fields.SFVec2f(this.x-t*e.x,this.y-t*e.y)},x3dom.fields.SFVec2f.prototype.normalize=function(){var e=this.length();return e&&(e=1/e),new x3dom.fields.SFVec2f(this.x*e,this.y*e)},x3dom.fields.SFVec2f.prototype.multComponents=function(e){return new x3dom.fields.SFVec2f(this.x*e.x,this.y*e.y)},x3dom.fields.SFVec2f.prototype.multiply=function(e){return new x3dom.fields.SFVec2f(this.x*e,this.y*e)},x3dom.fields.SFVec2f.prototype.divide=function(e){var t=e?1/e:1;return new x3dom.fields.SFVec2f(this.x*t,this.y*t)},x3dom.fields.SFVec2f.prototype.equals=function(e,t){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t},x3dom.fields.SFVec2f.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},x3dom.fields.SFVec2f.prototype.toGL=function(){return[this.x,this.y]},x3dom.fields.SFVec2f.prototype.toString=function(){return this.x+" "+this.y},x3dom.fields.SFVec2f.prototype.setValueByStr=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return this.x=+t[1],this.y=+t[2],this},x3dom.fields.SFVec3f=function(e,t,i){0===arguments.length?(this.x=0,this.y=0,this.z=0):(this.x=e,this.y=t,this.z=i)},x3dom.fields.SFVec3f.NullVector=new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.SFVec3f.OneVector=new x3dom.fields.SFVec3f(1,1,1),x3dom.fields.SFVec3f.copy=function(e){return new x3dom.fields.SFVec3f(e.x,e.y,e.z)},x3dom.fields.SFVec3f.MIN=function(){return new x3dom.fields.SFVec3f(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)},x3dom.fields.SFVec3f.MAX=function(){return new x3dom.fields.SFVec3f(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},x3dom.fields.SFVec3f.parse=function(e){try{var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return new x3dom.fields.SFVec3f(+t[1],+t[2],+t[3])}catch(i){var o=x3dom.fields.SFColor.colorParse(e);return new x3dom.fields.SFVec3f(o.r,o.g,o.b)}},x3dom.fields.SFVec3f.prototype.copy=function(){return x3dom.fields.SFVec3f.copy(this)},x3dom.fields.SFVec3f.prototype.setValues=function(e){this.x=e.x,this.y=e.y,this.z=e.z},x3dom.fields.SFVec3f.prototype.at=function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:return this.x}},x3dom.fields.SFVec3f.prototype.add=function(e){return new x3dom.fields.SFVec3f(this.x+e.x,this.y+e.y,this.z+e.z)},x3dom.fields.SFVec3f.prototype.addScaled=function(e,t){return new x3dom.fields.SFVec3f(this.x+t*e.x,this.y+t*e.y,this.z+t*e.z)},x3dom.fields.SFVec3f.prototype.subtract=function(e){return new x3dom.fields.SFVec3f(this.x-e.x,this.y-e.y,this.z-e.z)},x3dom.fields.SFVec3f.prototype.negate=function(){return new x3dom.fields.SFVec3f(-this.x,-this.y,-this.z)},x3dom.fields.SFVec3f.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},x3dom.fields.SFVec3f.prototype.cross=function(e){return new x3dom.fields.SFVec3f(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},x3dom.fields.SFVec3f.prototype.reflect=function(e){var t=2*this.dot(e);return new x3dom.fields.SFVec3f(this.x-t*e.x,this.y-t*e.y,this.z-t*e.z)},x3dom.fields.SFVec3f.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},x3dom.fields.SFVec3f.prototype.normalize=function(){var e=this.length();return e&&(e=1/e),new x3dom.fields.SFVec3f(this.x*e,this.y*e,this.z*e)},x3dom.fields.SFVec3f.prototype.multComponents=function(e){return new x3dom.fields.SFVec3f(this.x*e.x,this.y*e.y,this.z*e.z)},x3dom.fields.SFVec3f.prototype.multiply=function(e){return new x3dom.fields.SFVec3f(this.x*e,this.y*e,this.z*e)},x3dom.fields.SFVec3f.prototype.divide=function(e){var t=e?1/e:1;return new x3dom.fields.SFVec3f(this.x*t,this.y*t,this.z*t)},x3dom.fields.SFVec3f.prototype.equals=function(e,t){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t},x3dom.fields.SFVec3f.prototype.toGL=function(){return[this.x,this.y,this.z]},x3dom.fields.SFVec3f.prototype.toString=function(){return this.x+" "+this.y+" "+this.z},x3dom.fields.SFVec3f.prototype.setValueByStr=function(e){try{var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);this.x=+t[1],this.y=+t[2],this.z=+t[3]}catch(i){var o=x3dom.fields.SFColor.colorParse(e);this.x=o.r,this.y=o.g,this.z=o.b}return this},x3dom.fields.SFVec4f=function(e,t,i,o){0===arguments.length?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x=e,this.y=t,this.z=i,this.w=o)},x3dom.fields.SFVec4f.copy=function(e){return new x3dom.fields.SFVec4f(e.x,e.y,e.z,e.w)},x3dom.fields.SFVec4f.prototype.copy=function(){return x3dom.fields.SFVec4f(this)},x3dom.fields.SFVec4f.parse=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return new x3dom.fields.SFVec4f(+t[1],+t[2],+t[3],+t[4])},x3dom.fields.SFVec4f.prototype.setValueByStr=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return this.x=+t[1],this.y=+t[2],this.z=+t[3],this.w=+t[4],this},x3dom.fields.SFVec4f.prototype.toGL=function(){return[this.x,this.y,this.z,this.w]},x3dom.fields.SFVec4f.prototype.toString=function(){return this.x+" "+this.y+" "+this.z+" "+this.w},x3dom.fields.Quaternion=function(e,t,i,o){0===arguments.length?(this.x=0,this.y=0,this.z=0,this.w=1):(this.x=e,this.y=t,this.z=i,this.w=o)},x3dom.fields.Quaternion.copy=function(e){return new x3dom.fields.Quaternion(e.x,e.y,e.z,e.w)},x3dom.fields.Quaternion.prototype.multiply=function(e){return new x3dom.fields.Quaternion(this.w*e.x+this.x*e.w+this.y*e.z-this.z*e.y,this.w*e.y+this.y*e.w+this.z*e.x-this.x*e.z,this.w*e.z+this.z*e.w+this.x*e.y-this.y*e.x,this.w*e.w-this.x*e.x-this.y*e.y-this.z*e.z)},x3dom.fields.Quaternion.parseAxisAngle=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+t[1],+t[2],+t[3]),+t[4])},x3dom.fields.Quaternion.axisAngle=function(e,t){var i=e.length();if(i>x3dom.fields.Eps){var o=Math.sin(t/2)/i,s=Math.cos(t/2);return new x3dom.fields.Quaternion(e.x*o,e.y*o,e.z*o,s)}return new x3dom.fields.Quaternion(0,0,0,1)},x3dom.fields.Quaternion.prototype.copy=function(){return x3dom.fields.Quaternion.copy(this)},x3dom.fields.Quaternion.prototype.toMatrix=function(){var e=this.x*this.x,t=this.x*this.y,i=this.x*this.z,o=this.y*this.y,s=this.y*this.z,r=this.z*this.z,n=this.w*this.x,a=this.w*this.y,d=this.w*this.z;return new x3dom.fields.SFMatrix4f(1-2*(o+r),2*(t-d),2*(i+a),0,2*(t+d),1-2*(e+r),2*(s-n),0,2*(i-a),2*(s+n),1-2*(e+o),0,0,0,0,1)},x3dom.fields.Quaternion.prototype.toAxisAngle=function(){var e=0,t=0,i=0,o=0,s=0,r=this;return this.w>1&&(r=x3dom.fields.Quaternion.normalize(this)),s=2*Math.acos(r.w),o=Math.sqrt(1-r.w*r.w),0==o?(e=r.x,t=r.y,i=r.z):(e=r.x/o,t=r.y/o,i=r.z/o),[new x3dom.fields.SFVec3f(e,t,i),s]},x3dom.fields.Quaternion.prototype.angle=function(){return 2*Math.acos(this.w)},x3dom.fields.Quaternion.prototype.setValue=function(e){var t,i=1,o=[0,0,0],s=0,r=0,n=0,a=[1,2,0];if(t=e._00+e._11+e._22,t>0?(i=Math.sqrt(t+1),this.w=.5*i,i=.5/i,this.x=(e._21-e._12)*i,this.y=(e._02-e._20)*i,this.z=(e._10-e._01)*i):(s=e._11>e._00?1:0,e._22>e.at(s,s)&&(s=2),r=a[s],n=a[r],i=Math.sqrt(e.at(s,s)-(e.at(r,r)+e.at(n,n))+1),o[s]=.5*i,i=.5/i,this.w=(e.at(n,r)-e.at(r,n))*i,o[r]=(e.at(r,s)+e.at(s,r))*i,o[n]=(e.at(n,s)+e.at(s,n))*i,this.x=o[0],this.y=o[1],this.z=o[2]),this.w>1||this.w<-1){var d=1+100*x3dom.fields.Eps;(this.w>d||this.w<-d)&&x3dom.debug.logInfo("MatToQuat: BUG: |quat[4]| ("+this.w+") >> 1.0 !"),this.w=this.w>1?1:-1}},x3dom.fields.Quaternion.prototype.setFromEuler=function(e,t,i){var o=Math.sin(.5*e),s=Math.cos(.5*e),r=Math.sin(.5*t),n=Math.cos(.5*t),a=Math.sin(.5*i),d=Math.cos(.5*i);this.x=o*n*d-s*r*a,this.y=s*r*d+o*n*a,this.z=s*n*a-o*r*d,this.w=s*n*d+o*r*a},x3dom.fields.Quaternion.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},x3dom.fields.Quaternion.prototype.add=function(e){return new x3dom.fields.Quaternion(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},x3dom.fields.Quaternion.prototype.subtract=function(e){return new x3dom.fields.Quaternion(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)},x3dom.fields.Quaternion.prototype.setValues=function(e){this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w},x3dom.fields.Quaternion.prototype.equals=function(e,t){return this.dot(e)>=1-t},x3dom.fields.Quaternion.prototype.multScalar=function(e){return new x3dom.fields.Quaternion(this.x*e,this.y*e,this.z*e,this.w*e)},x3dom.fields.Quaternion.prototype.normalize=function(e){var t=this.dot(e),i=1;return t&&(i=1/Math.sqrt(t)),new x3dom.fields.Quaternion(this.x*i,this.y*i,this.z*i,this.w*i)},x3dom.fields.Quaternion.prototype.negate=function(){return new x3dom.fields.Quaternion(-this.x,-this.y,-this.z,-this.w)},x3dom.fields.Quaternion.prototype.inverse=function(){return new x3dom.fields.Quaternion(-this.x,-this.y,-this.z,this.w)},x3dom.fields.Quaternion.prototype.slerp=function(e,t){var i,o=this.dot(e);0>o?(o=-o,i=e.negate()):i=new x3dom.fields.Quaternion(e.x,e.y,e.z,e.w);var s,r;if(1-o>1e-5){var n=Math.acos(o),a=Math.sin(n);s=Math.sin((1-t)*n)/a,r=Math.sin(t*n)/a;

}else s=1-t,r=t;return this.multScalar(s).add(i.multScalar(r))},x3dom.fields.Quaternion.rotateFromTo=function(e,t){var i=e.normalize(),o=t.normalize(),s=i.dot(o);if(s>.99999)return new x3dom.fields.Quaternion(0,0,0,1);if(-.99999>s){var r=new x3dom.fields.SFVec3f(1,0,0),n=i.cross(r);return n.length()<1e-5&&(r.x=0,r.y=1,r.z=0,n=i.cross(r)),n=n.normalize(),x3dom.fields.Quaternion.axisAngle(n,Math.PI)}var a=e.cross(t);a=a.normalize();var d=Math.sqrt(.5*(1-s));return a=a.multiply(d),d=Math.sqrt(.5*(1+s)),new x3dom.fields.Quaternion(a.x,a.y,a.z,d)},x3dom.fields.Quaternion.prototype.toGL=function(){var e=this.toAxisAngle();return[e[0].x,e[0].y,e[0].z,e[1]]},x3dom.fields.Quaternion.prototype.toString=function(){return this.x+" "+this.y+" "+this.z+", "+this.w},x3dom.fields.Quaternion.prototype.setValueByStr=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e),i=x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+t[1],+t[2],+t[3]),+t[4]);return this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w,this},x3dom.fields.SFColor=function(e,t,i){0===arguments.length?(this.r=0,this.g=0,this.b=0):(this.r=e,this.g=t,this.b=i)},x3dom.fields.SFColor.parse=function(e){try{var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return new x3dom.fields.SFColor(+t[1],+t[2],+t[3])}catch(i){return x3dom.fields.SFColor.colorParse(e)}},x3dom.fields.SFColor.copy=function(e){return new x3dom.fields.SFColor(e.r,e.g,e.b)},x3dom.fields.SFColor.prototype.copy=function(){return x3dom.fields.SFColor.copy(this)},x3dom.fields.SFColor.prototype.setHSV=function(){x3dom.debug.logWarning("SFColor.setHSV() NYI")},x3dom.fields.SFColor.prototype.getHSV=function(){var e=0,t=0,i=0;return x3dom.debug.logWarning("SFColor.getHSV() NYI"),[e,t,i]},x3dom.fields.SFColor.prototype.setValues=function(e){this.r=e.r,this.g=e.g,this.b=e.b},x3dom.fields.SFColor.prototype.equals=function(e,t){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t},x3dom.fields.SFColor.prototype.add=function(e){return new x3dom.fields.SFColor(this.r+e.r,this.g+e.g,this.b+e.b)},x3dom.fields.SFColor.prototype.subtract=function(e){return new x3dom.fields.SFColor(this.r-e.r,this.g-e.g,this.b-e.b)},x3dom.fields.SFColor.prototype.multiply=function(e){return new x3dom.fields.SFColor(this.r*e,this.g*e,this.b*e)},x3dom.fields.SFColor.prototype.toGL=function(){return[this.r,this.g,this.b]},x3dom.fields.SFColor.prototype.toString=function(){return this.r+" "+this.g+" "+this.b},x3dom.fields.SFColor.prototype.setValueByStr=function(e){try{var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);this.r=+t[1],this.g=+t[2],this.b=+t[3]}catch(i){var o=x3dom.fields.SFColor.colorParse(e);this.r=o.r,this.g=o.g,this.b=o.b}return this},x3dom.fields.SFColor.colorParse=function(e){var t=0,i=0,o=0,s={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};if(s[e]&&(e="#"+s[e]),e.substr&&"#"===e.substr(0,1)){e=e.substr(1);var r=e.length;6===r?(t=parseInt("0x"+e.substr(0,2),16)/255,i=parseInt("0x"+e.substr(2,2),16)/255,o=parseInt("0x"+e.substr(4,2),16)/255):3===r&&(t=parseInt("0x"+e.substr(0,1),16)/15,i=parseInt("0x"+e.substr(1,1),16)/15,o=parseInt("0x"+e.substr(2,1),16)/15)}return new x3dom.fields.SFColor(t,i,o)},x3dom.fields.SFColorRGBA=function(e,t,i,o){0===arguments.length?(this.r=0,this.g=0,this.b=0,this.a=1):(this.r=e,this.g=t,this.b=i,this.a=o)},x3dom.fields.SFColorRGBA.parse=function(e){try{var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);return new x3dom.fields.SFColorRGBA(+t[1],+t[2],+t[3],+t[4])}catch(i){return x3dom.fields.SFColorRGBA.colorParse(e)}},x3dom.fields.SFColorRGBA.copy=function(e){return new x3dom.fields.SFColorRGBA(e.r,e.g,e.b,e.a)},x3dom.fields.SFColorRGBA.prototype.copy=function(){return x3dom.fields.SFColorRGBA.copy(this)},x3dom.fields.SFColorRGBA.prototype.setValues=function(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a},x3dom.fields.SFColorRGBA.prototype.equals=function(e,t){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t&&Math.abs(this.a-e.a)<t},x3dom.fields.SFColorRGBA.prototype.toGL=function(){return[this.r,this.g,this.b,this.a]},x3dom.fields.SFColorRGBA.prototype.toString=function(){return this.r+" "+this.g+" "+this.b+" "+this.a},x3dom.fields.SFColorRGBA.prototype.setValueByStr=function(e){try{var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);this.r=+t[1],this.g=+t[2],this.b=+t[3],this.a=+t[4]}catch(i){var o=x3dom.fields.SFColorRGBA.colorParse(e);this.r=o.r,this.g=o.g,this.b=o.b,this.a=o.a}return this},x3dom.fields.SFColorRGBA.prototype.toUint=function(){return(Math.round(255*this.r)<<24|Math.round(255*this.g)<<16|Math.round(255*this.b)<<8|Math.round(255*this.a))>>>0},x3dom.fields.SFColorRGBA.colorParse=function(e){var t=0,i=0,o=0,s=0,r={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};if(r[e]&&(e="#"+r[e]+"ff"),e.substr&&"#"===e.substr(0,1)){e=e.substr(1);var n=e.length;8===n?(t=parseInt("0x"+e.substr(0,2),16)/255,i=parseInt("0x"+e.substr(2,2),16)/255,o=parseInt("0x"+e.substr(4,2),16)/255,s=parseInt("0x"+e.substr(6,2),16)/255):6===n?(t=parseInt("0x"+e.substr(0,2),16)/255,i=parseInt("0x"+e.substr(2,2),16)/255,o=parseInt("0x"+e.substr(4,2),16)/255,s=1):4===n?(t=parseInt("0x"+e.substr(0,1),16)/15,i=parseInt("0x"+e.substr(1,1),16)/15,o=parseInt("0x"+e.substr(2,1),16)/15,s=parseInt("0x"+e.substr(3,1),16)/15):3===n&&(t=parseInt("0x"+e.substr(0,1),16)/15,i=parseInt("0x"+e.substr(1,1),16)/15,o=parseInt("0x"+e.substr(2,1),16)/15,s=1)}return new x3dom.fields.SFColorRGBA(t,i,o,s)},x3dom.fields.SFImage=function(e,t,i,o){if(0!==arguments.length&&o&&o.map){this.width=e,this.height=t,this.comp=i;var s=this.array;o.map(function(e){s.push(e)},this.array)}else this.width=0,this.height=0,this.comp=0,this.array=[]},x3dom.fields.SFImage.parse=function(e){var t=new x3dom.fields.SFImage;return t.setValueByStr(e),t},x3dom.fields.SFImage.copy=function(e){var t=new x3dom.fields.SFImage;return t.width=e.width,t.height=e.height,t.comp=e.comp,t.setPixels(e.getPixels()),t},x3dom.fields.SFImage.prototype.copy=function(){return x3dom.fields.SFImage.copy(this)},x3dom.fields.SFImage.prototype.setValueByStr=function(e){var t=e.match(/(\w+)/g),i=t.length,o=0;if(this.array=[],!(i>2))return this.width=0,this.height=0,void(this.comp=0);this.width=+t[0],this.height=+t[1],this.comp=+t[2],o=2*this.comp;var s,r;for(r=3;i>r;r++){var n,a,d,l;if(t[r].substr)if("x"!==t[r].substr(1,1).toLowerCase()){var h=parseInt(t[r],10);1===this.comp?(n=h,this.array.push(n)):2===this.comp?(n=h>>8&255,a=255&h,this.array.push(n,a)):3===this.comp?(n=h>>16&255,a=h>>8&255,d=255&h,this.array.push(n,a,d)):4===this.comp&&(n=h>>24&255,a=h>>16&255,d=h>>8&255,l=255&h,this.array.push(n,a,d,l))}else"x"===t[r].substr(1,1).toLowerCase()&&(t[r]=t[r].substr(2),s=t[r].length,s===o&&(1===this.comp?(n=parseInt("0x"+t[r].substr(0,2),16),this.array.push(n)):2===this.comp?(n=parseInt("0x"+t[r].substr(0,2),16),a=parseInt("0x"+t[r].substr(2,2),16),this.array.push(n,a)):3===this.comp?(n=parseInt("0x"+t[r].substr(0,2),16),a=parseInt("0x"+t[r].substr(2,2),16),d=parseInt("0x"+t[r].substr(4,2),16),this.array.push(n,a,d)):4===this.comp&&(n=parseInt("0x"+t[r].substr(0,2),16),a=parseInt("0x"+t[r].substr(2,2),16),d=parseInt("0x"+t[r].substr(4,2),16),l=parseInt("0x"+t[r].substr(6,2),16),this.array.push(n,a,d,l))))}},x3dom.fields.SFImage.prototype.setPixel=function(e,t,i){var o=(t*this.width+e)*this.comp;1===this.comp&&o<this.array.length?this.array[o]=255*i.r:2===this.comp&&o+1<this.array.length?(this.array[o]=255*i.r,this.array[o+1]=255*i.g):3===this.comp&&o+2<this.array.length?(this.array[o]=255*i.r,this.array[o+1]=255*i.g,this.array[o+2]=255*i.b):4===this.comp&&o+3<this.array.length&&(this.array[o]=255*i.r,this.array[o+1]=255*i.g,this.array[o+2]=255*i.b,this.array[o+3]=255*i.a)},x3dom.fields.SFImage.prototype.getPixel=function(e,t){var i=(t*this.width+e)*this.comp;return 1===this.comp&&i<this.array.length?new x3dom.fields.SFColorRGBA(this.array[i]/255,0,0,1):2===this.comp&&i+1<this.array.length?new x3dom.fields.SFColorRGBA(this.array[i]/255,this.array[i+1]/255,0,1):3===this.comp&&i+2<this.array.length?new x3dom.fields.SFColorRGBA(this.array[i]/255,this.array[i+1]/255,this.array[i+2]/255,1):4===this.comp&&i+3<this.array.length?new x3dom.fields.SFColorRGBA(this.array[i]/255,this.array[i+1]/255,this.array[i+2]/255,this.array[i+3]/255):void 0},x3dom.fields.SFImage.prototype.setPixels=function(e){var t,i=0;if(1===this.comp)for(t=0;t<e.length;t++)this.array[i++]=255*e[t].r;else if(2===this.comp)for(t=0;t<e.length;t++)this.array[i++]=255*e[t].r,this.array[i++]=255*e[t].g;else if(3===this.comp)for(t=0;t<e.length;t++)this.array[i++]=255*e[t].r,this.array[i++]=255*e[t].g,this.array[i++]=255*e[t].b;else if(4===this.comp)for(t=0;t<e.length;t++)this.array[i++]=255*e[t].r,this.array[i++]=255*e[t].g,this.array[i++]=255*e[t].b,this.array[i++]=255*e[t].a},x3dom.fields.SFImage.prototype.getPixels=function(){var e,t=[];if(1===this.comp)for(e=0;e<this.array.length;e+=this.comp)t.push(new x3dom.fields.SFColorRGBA(this.array[e]/255,0,0,1));else if(2===this.comp)for(e=0;e<this.array.length;e+=this.comp)t.push(new x3dom.fields.SFColorRGBA(this.array[e]/255,this.array[e+1]/255,0,1));else if(3===this.comp)for(e=0;e<this.array.length;e+=this.comp)t.push(new x3dom.fields.SFColorRGBA(this.array[e]/255,this.array[e+1]/255,this.array[e+2]/255,1));else if(4===this.comp)for(e=0;e<this.array.length;e+=this.comp)t.push(new x3dom.fields.SFColorRGBA(this.array[e]/255,this.array[e+1]/255,this.array[e+2]/255,this.array[e+3]/255));return t},x3dom.fields.SFImage.prototype.toGL=function(){var e=[];return Array.map(this.array,function(t){e.push(t)}),e},x3dom.fields.MFColor=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFColor.copy=function(e){var t=new x3dom.fields.MFColor;return e.map(function(e){t.push(e.copy())},this),t},x3dom.fields.MFColor.prototype=x3dom.extend([]),x3dom.fields.MFColor.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],o=0,s=t?t.length:0;s>o;o+=3)i.push(new x3dom.fields.SFColor(+t[o+0],+t[o+1],+t[o+2]));return new x3dom.fields.MFColor(i)},x3dom.fields.MFColor.prototype.copy=function(){return x3dom.fields.MFColor.copy(this)},x3dom.fields.MFColor.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,o=t?t.length:0;o>i;i+=3)this.push(new x3dom.fields.SFColor(+t[i+0],+t[i+1],+t[i+2]))},x3dom.fields.MFColor.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t.r),e.push(t.g),e.push(t.b)}),e},x3dom.fields.MFColorRGBA=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFColorRGBA.copy=function(e){var t=new x3dom.fields.MFColorRGBA;return e.map(function(e){t.push(e.copy())},this),t},x3dom.fields.MFColorRGBA.prototype=x3dom.extend([]),x3dom.fields.MFColorRGBA.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],o=0,s=t?t.length:0;s>o;o+=4)i.push(new x3dom.fields.SFColorRGBA(+t[o+0],+t[o+1],+t[o+2],+t[o+3]));return new x3dom.fields.MFColorRGBA(i)},x3dom.fields.MFColorRGBA.prototype.copy=function(){return x3dom.fields.MFColorRGBA.copy(this)},x3dom.fields.MFColorRGBA.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,o=t?t.length:0;o>i;i+=4)this.push(new x3dom.fields.SFColorRGBA(+t[i+0],+t[i+1],+t[i+2],+t[i+3]))},x3dom.fields.MFColorRGBA.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t.r),e.push(t.g),e.push(t.b),e.push(t.a)}),e},x3dom.fields.MFRotation=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFRotation.prototype=x3dom.extend([]),x3dom.fields.MFRotation.copy=function(e){var t=new x3dom.fields.MFRotation;return e.map(function(e){t.push(e.copy())},this),t},x3dom.fields.MFRotation.prototype.copy=function(){return x3dom.fields.MFRotation.copy(this)},x3dom.fields.MFRotation.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],o=0,s=t?t.length:0;s>o;o+=4)i.push(x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+t[o+0],+t[o+1],+t[o+2]),+t[o+3]));return new x3dom.fields.MFRotation(i)},x3dom.fields.MFRotation.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,o=t?t.length:0;o>i;i+=4)this.push(x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+t[i+0],+t[i+1],+t[i+2]),+t[i+3]))},x3dom.fields.MFRotation.prototype.toGL=function(){var e=[];return Array.map(this,function(t){var i=t.toAxisAngle();e.push(i[0].x),e.push(i[0].y),e.push(i[0].z),e.push(i[1])}),e},x3dom.fields.MFVec3f=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFVec3f.prototype=x3dom.extend(Array),x3dom.fields.MFVec3f.copy=function(e){var t=new x3dom.fields.MFVec3f;return e.map(function(e){t.push(e.copy())},this),t},x3dom.fields.MFVec3f.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],o=0,s=t?t.length:0;s>o;o+=3)i.push(new x3dom.fields.SFVec3f(+t[o+0],+t[o+1],+t[o+2]));return new x3dom.fields.MFVec3f(i)},x3dom.fields.MFVec3f.prototype.copy=function(){x3dom.fields.MFVec3f.copy(this)},x3dom.fields.MFVec3f.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,o=t?t.length:0;o>i;i+=3)this.push(new x3dom.fields.SFVec3f(+t[i+0],+t[i+1],+t[i+2]))},x3dom.fields.MFVec3f.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t.x),e.push(t.y),e.push(t.z)}),e},x3dom.fields.MFVec2f=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFVec2f.prototype=x3dom.extend([]),x3dom.fields.MFVec2f.copy=function(e){var t=new x3dom.fields.MFVec2f;return e.map(function(e){t.push(e.copy())},this),t},x3dom.fields.MFVec2f.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],o=0,s=t?t.length:0;s>o;o+=2)i.push(new x3dom.fields.SFVec2f(+t[o+0],+t[o+1]));return new x3dom.fields.MFVec2f(i)},x3dom.fields.MFVec2f.prototype.copy=function(){return x3dom.fields.MFVec2f.copy(this)},x3dom.fields.MFVec2f.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,o=t?t.length:0;o>i;i+=2)this.push(new x3dom.fields.SFVec2f(+t[i+0],+t[i+1]))},x3dom.fields.MFVec2f.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t.x),e.push(t.y)}),e},x3dom.fields.MFInt32=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFInt32.prototype=x3dom.extend([]),x3dom.fields.MFInt32.copy=function(e){var t=new x3dom.fields.MFInt32;return e.map(function(e){t.push(e)},this),t},x3dom.fields.MFInt32.parse=function(e){for(var t=e.match(/([+\-]?\d+\s*){1},?\s*/g),i=[],o=0,s=t?t.length:0;s>o;++o)i.push(parseInt(t[o],10));return new x3dom.fields.MFInt32(i)},x3dom.fields.MFInt32.prototype.copy=function(){return x3dom.fields.MFInt32.copy(this)},x3dom.fields.MFInt32.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-]?\d+\s*){1},?\s*/g),i=0,o=t?t.length:0;o>i;++i)this.push(parseInt(t[i],10))},x3dom.fields.MFInt32.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t)}),e},x3dom.fields.MFFloat=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFFloat.prototype=x3dom.extend([]),x3dom.fields.MFFloat.copy=function(e){var t=new x3dom.fields.MFFloat;return e.map(function(e){t.push(e)},this),t},x3dom.fields.MFFloat.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],o=0,s=t?t.length:0;s>o;o++)i.push(+t[o]);return new x3dom.fields.MFFloat(i)},x3dom.fields.MFFloat.prototype.copy=function(){return x3dom.fields.MFFloat.copy(this)},x3dom.fields.MFFloat.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,o=t?t.length:0;o>i;i++)this.push(+t[i])},x3dom.fields.MFFloat.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t)}),e},x3dom.fields.MFBoolean=function(e){if(e){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFBoolean.prototype=x3dom.extend([]),x3dom.fields.MFBoolean.copy=function(e){var t=new x3dom.fields.MFBoolean;return e.map(function(e){t.push(e)},this),t},x3dom.fields.MFBoolean.parse=function(e){for(var t=e.match(/(true|false|1|0)/gi),i=[],o=0,s=t?t.length:0;s>o;o++)i.push("1"==t[o]||"true"==t[o].toLowerCase());return new x3dom.fields.MFBoolean(i)},x3dom.fields.MFBoolean.prototype.copy=function(){return x3dom.fields.MFBoolean.copy(this)},x3dom.fields.MFBoolean.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/(true|false|1|0)/gi),i=0,o=t?t.length:0;o>i;i++)this.push("1"==t[i]||"true"==t[i].toLowerCase())},x3dom.fields.MFBoolean.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t?1:0)}),e},x3dom.fields.MFString=function(e){if(e&&e.map){var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFString.prototype=x3dom.extend([]),x3dom.fields.MFString.copy=function(e){var t=new x3dom.fields.MFString;return e.map(function(e){t.push(e)},this),t},x3dom.fields.MFString.parse=function(e){var t=[];if(e.length&&'"'==e[0])for(var i,o=/"((?:[^\\"]|\\\\|\\")*)"/g;i=o.exec(e);){var s=i[1].replace(/\\([\\"])/g,"$1");void 0!==s&&t.push(s)}else t.push(e);return new x3dom.fields.MFString(t)},x3dom.fields.MFString.prototype.copy=function(){return x3dom.fields.MFString.copy(this)},x3dom.fields.MFString.prototype.setValueByStr=function(e){if(this.length=0,e.length&&'"'==e[0])for(var t,i=/"((?:[^\\"]|\\\\|\\")*)"/g;t=i.exec(e);){var o=t[1].replace(/\\([\\"])/,"$1");void 0!==o&&this.push(o)}else this.push(e);return this},x3dom.fields.MFString.prototype.toString=function(){for(var e="",t=0,i=this.length;i>t;t++)e=e+this[t]+" ";return e},x3dom.fields.SFNode=function(e){this.type=e,this.node=null},x3dom.fields.SFNode.prototype.hasLink=function(e){return e?this.node===e:this.node},x3dom.fields.SFNode.prototype.addLink=function(e){return this.node=e,!0},x3dom.fields.SFNode.prototype.rmLink=function(e){return this.node===e?(this.node=null,!0):!1},x3dom.fields.MFNode=function(e){this.type=e,this.nodes=[]},x3dom.fields.MFNode.prototype.hasLink=function(e){if(!e)return this.length>0;for(var t=0,i=this.nodes.length;i>t;t++)if(this.nodes[t]===e)return!0;return!1},x3dom.fields.MFNode.prototype.addLink=function(e){return this.nodes.push(e),!0},x3dom.fields.MFNode.prototype.rmLink=function(e){for(var t=0,i=this.nodes.length;i>t;t++)if(this.nodes[t]===e)return this.nodes.splice(t,1),!0;return!1},x3dom.fields.MFNode.prototype.length=function(){return this.nodes.length},x3dom.fields.Line=function(e,t){0===arguments.length&&(this.pos=new x3dom.fields.SFVec3f(0,0,0),this.dir=new x3dom.fields.SFVec3f(0,0,1)),this.pos=x3dom.fields.SFVec3f.copy(e),this.dir=x3dom.fields.SFVec3f.copy(t)},x3dom.fields.Line.prototype.closestPoint=function(e){var t=e.subtract(this.pos),i=t.dot(this.dir);return this.pos.add(this.dir.multiply(i))},x3dom.fields.Line.prototype.shortestDistance=function(e){var t=e.subtract(this.pos),i=t.dot(this.dir);return t.subtract(this.dir.multiply(i)).length()},x3dom.fields.Ray=function(e,t){if(0===arguments.length)this.pos=new x3dom.fields.SFVec3f(0,0,0),this.dir=new x3dom.fields.SFVec3f(0,0,1);else{this.pos=new x3dom.fields.SFVec3f(e.x,e.y,e.z);var i=t.length();i&&(i=1/i),this.dir=new x3dom.fields.SFVec3f(t.x*i,t.y*i,t.z*i)}this.enter=0,this.exit=0,this.hitObject=null,this.hitPoint={},this.dist=Number.MAX_VALUE},x3dom.fields.Ray.prototype.toString=function(){return"Ray: ["+this.pos.toString()+"; "+this.dir.toString()+"]"},x3dom.fields.Ray.prototype.intersectPlane=function(e,t){var i,o=null,s=t.dot(this.dir);return 0>s&&(i=(e.dot(t)-this.pos.dot(t))/s,o=this.pos.addScaled(this.dir,i)),o},x3dom.fields.Ray.prototype.intersect=function(e,t){var i,o,s,r=0,n=Number.MAX_VALUE;if(this.dir.x>x3dom.fields.Eps)i=1/this.dir.x,o=(e.x-this.pos.x)*i,s=(t.x-this.pos.x)*i,n>s&&(n=s),o>r&&(r=o);else if(this.dir.x<-x3dom.fields.Eps)i=1/this.dir.x,o=(t.x-this.pos.x)*i,s=(e.x-this.pos.x)*i,n>s&&(n=s),o>r&&(r=o);else if(this.pos.x<e.x||this.pos.x>t.x)return!1;if(this.dir.y>x3dom.fields.Eps){if(i=1/this.dir.y,o=(e.y-this.pos.y)*i,s=(t.y-this.pos.y)*i,n>s&&(n=s),o>r&&(r=o),r-n>=x3dom.fields.Eps)return!1}else if(this.dir.y<-x3dom.fields.Eps){if(i=1/this.dir.y,o=(t.y-this.pos.y)*i,s=(e.y-this.pos.y)*i,n>s&&(n=s),o>r&&(r=o),r-n>=x3dom.fields.Eps)return!1}else if(this.pos.y<e.y||this.pos.y>t.y)return!1;if(this.dir.z>x3dom.fields.Eps)i=1/this.dir.z,o=(e.z-this.pos.z)*i,s=(t.z-this.pos.z)*i,n>s&&(n=s),o>r&&(r=o);else if(this.dir.z<-x3dom.fields.Eps)i=1/this.dir.z,o=(t.z-this.pos.z)*i,s=(e.z-this.pos.z)*i,n>s&&(n=s),o>r&&(r=o);else if(this.pos.z<e.z||this.pos.z>t.z)return!1;return this.enter=r,this.exit=n,r-n<x3dom.fields.Eps},x3dom.fields.BoxVolume=function(e,t){arguments.length<2?(this.min=new x3dom.fields.SFVec3f(0,0,0),this.max=new x3dom.fields.SFVec3f(0,0,0),this.valid=!1):(this.min=x3dom.fields.SFVec3f.copy(e),this.max=x3dom.fields.SFVec3f.copy(t),this.valid=!0),this.updateInternals()},x3dom.fields.BoxVolume.prototype.getScalarValue=function(){var e=this.max.subtract(this.min);return e.x*e.y*e.z},x3dom.fields.BoxVolume.copy=function(e){return new x3dom.fields.BoxVolume(e.min,e.max)},x3dom.fields.BoxVolume.prototype.updateInternals=function(){this.radialVec=this.max.subtract(this.min).multiply(.5),this.center=this.min.add(this.radialVec),this.diameter=2*this.radialVec.length()},x3dom.fields.BoxVolume.prototype.setBounds=function(e,t){this.min.setValues(e),this.max.setValues(t),this.updateInternals(),this.valid=!0},x3dom.fields.BoxVolume.prototype.setBoundsByCenterSize=function(e,t){var i=t.multiply(.5);this.min=e.subtract(i),this.max=e.add(i),this.updateInternals(),this.valid=!0},x3dom.fields.BoxVolume.prototype.extendBounds=function(e,t){this.valid?(this.min.x>e.x&&(this.min.x=e.x),this.min.y>e.y&&(this.min.y=e.y),this.min.z>e.z&&(this.min.z=e.z),this.max.x<t.x&&(this.max.x=t.x),this.max.y<t.y&&(this.max.y=t.y),this.max.z<t.z&&(this.max.z=t.z),this.updateInternals()):this.setBounds(e,t)},x3dom.fields.BoxVolume.prototype.getBounds=function(e,t){e.setValues(this.min),t.setValues(this.max)},x3dom.fields.BoxVolume.prototype.getRadialVec=function(){return this.radialVec},x3dom.fields.BoxVolume.prototype.invalidate=function(){this.valid=!1,this.min=new x3dom.fields.SFVec3f(0,0,0),this.max=new x3dom.fields.SFVec3f(0,0,0)},x3dom.fields.BoxVolume.prototype.isValid=function(){return this.valid},x3dom.fields.BoxVolume.prototype.getCenter=function(){return this.center},x3dom.fields.BoxVolume.prototype.getDiameter=function(){return this.diameter},x3dom.fields.BoxVolume.prototype.transform=function(e){var t,i,o,s,r,n;t=s=e._03,i=r=e._13,o=n=e._23;var a=this.max.x*e._00,d=this.min.x*e._00;a>=d?(s+=a,t+=d):(s+=d,t+=a),a=this.max.y*e._01,d=this.min.y*e._01,a>=d?(s+=a,t+=d):(s+=d,t+=a),a=this.max.z*e._02,d=this.min.z*e._02,a>=d?(s+=a,t+=d):(s+=d,t+=a),a=this.max.x*e._10,d=this.min.x*e._10,a>=d?(r+=a,i+=d):(r+=d,i+=a),a=this.max.y*e._11,d=this.min.y*e._11,a>=d?(r+=a,i+=d):(r+=d,i+=a),a=this.max.z*e._12,d=this.min.z*e._12,a>=d?(r+=a,i+=d):(r+=d,i+=a),a=this.max.x*e._20,d=this.min.x*e._20,a>=d?(n+=a,o+=d):(n+=d,o+=a),a=this.max.y*e._21,d=this.min.y*e._21,a>=d?(n+=a,o+=d):(n+=d,o+=a),a=this.max.z*e._22,d=this.min.z*e._22,a>=d?(n+=a,o+=d):(n+=d,o+=a),this.min.x=t,this.min.y=i,this.min.z=o,this.max.x=s,this.max.y=r,this.max.z=n,this.updateInternals()},x3dom.fields.BoxVolume.prototype.transformFrom=function(e,t){var i,o,s,r,n,a;i=r=e._03,o=n=e._13,s=a=e._23;var d=t.max.x*e._00,l=t.min.x*e._00;d>=l?(r+=d,i+=l):(r+=l,i+=d),d=t.max.y*e._01,l=t.min.y*e._01,d>=l?(r+=d,i+=l):(r+=l,i+=d),d=t.max.z*e._02,l=t.min.z*e._02,d>=l?(r+=d,i+=l):(r+=l,i+=d),d=t.max.x*e._10,l=t.min.x*e._10,d>=l?(n+=d,o+=l):(n+=l,o+=d),d=t.max.y*e._11,l=t.min.y*e._11,d>=l?(n+=d,o+=l):(n+=l,o+=d),d=t.max.z*e._12,l=t.min.z*e._12,d>=l?(n+=d,o+=l):(n+=l,o+=d),d=t.max.x*e._20,l=t.min.x*e._20,d>=l?(a+=d,s+=l):(a+=l,s+=d),d=t.max.y*e._21,l=t.min.y*e._21,d>=l?(a+=d,s+=l):(a+=l,s+=d),d=t.max.z*e._22,l=t.min.z*e._22,d>=l?(a+=d,s+=l):(a+=l,s+=d),this.min.x=i,this.min.y=o,this.min.z=s,this.max.x=r,this.max.y=n,this.max.z=a,this.updateInternals(),this.valid=!0},x3dom.fields.FrustumVolume=function(e){if(this.planeNormals=[],this.planeDistances=[],this.directionIndex=[],0!==arguments.length){for(var t=[],i=0;6>i;i++)this.planeNormals[i]=new x3dom.fields.SFVec3f(0,0,0),this.planeDistances[i]=0,this.directionIndex[i]=0,t[i]=new x3dom.fields.SFVec4f(0,0,0,0);for(t[0].x=e._30-e._00,t[0].y=e._31-e._01,t[0].z=e._32-e._02,t[0].w=e._33-e._03,t[1].x=e._30+e._00,t[1].y=e._31+e._01,t[1].z=e._32+e._02,t[1].w=e._33+e._03,t[2].x=e._30+e._10,t[2].y=e._31+e._11,t[2].z=e._32+e._12,t[2].w=e._33+e._13,t[3].x=e._30-e._10,t[3].y=e._31-e._11,t[3].z=e._32-e._12,t[3].w=e._33-e._13,t[4].x=e._30+e._20,t[4].y=e._31+e._21,t[4].z=e._32+e._22,t[4].w=e._33+e._23,t[5].x=e._30-e._20,t[5].y=e._31-e._21,t[5].z=e._32-e._22,t[5].w=e._33-e._23,i=0;6>i;i++){var o=Math.sqrt(t[i].x*t[i].x+t[i].y*t[i].y+t[i].z*t[i].z);t[i].x/=o,t[i].y/=o,t[i].z/=o,t[i].w/=-o}var s=function(e){var t=0;return e.x>0&&(t|=1),e.y>0&&(t|=2),e.z>0&&(t|=4),t};this.planeNormals[3].setValues(t[0]),this.planeDistances[3]=t[0].w,this.directionIndex[3]=s(this.planeNormals[3]),this.planeNormals[2].setValues(t[1]),this.planeDistances[2]=t[1].w,this.directionIndex[2]=s(this.planeNormals[2]),this.planeNormals[5].setValues(t[2]),this.planeDistances[5]=t[2].w,this.directionIndex[5]=s(this.planeNormals[5]),this.planeNormals[4].setValues(t[3]),this.planeDistances[4]=t[3].w,this.directionIndex[4]=s(this.planeNormals[4]),this.planeNormals[0].setValues(t[4]),this.planeDistances[0]=t[4].w,this.directionIndex[0]=s(this.planeNormals[0]),this.planeNormals[1].setValues(t[5]),this.planeDistances[1]=t[5].w,this.directionIndex[1]=s(this.planeNormals[1])}},x3dom.fields.FrustumVolume.prototype.intersect=function(e,t){if(this.planeNormals.length<6)return x3dom.debug.logWarning("FrustumVolume not initialized!"),!1;var i=this,o=e.min,s=e.max,r=function(e){var t=new x3dom.fields.SFVec3f(0,0,0);return t.x=1&e?o.x:s.x,t.y=2&e?o.y:s.y,t.z=4&e?o.z:s.z,t},n=function(e,t){var o=i.planeNormals[e].dot(t)-i.planeDistances[e];return o>=0},a=function(e){var t=r(i.directionIndex[e]);return n(e,t)},d=function(e){var t=r(7^i.directionIndex[e]);return!n(e,t)},l=1;0>t&&(t=0);for(var h=0;6>h;h++,l<<=1)if(0==(t&l)){if(d(h))return-1;

a(h)&&(t|=l)}return t},x3dom.docs={},x3dom.docs.specURLMap={CADGeometry:"CADGeometry.html",Core:"core.html",DIS:"dis.html",CubeMapTexturing:"env_texture.html",EnvironmentalEffects:"enveffects.html",EnvironmentalSensor:"envsensor.html",Followers:"followers.html",Geospatial:"geodata.html",Geometry2D:"geometry2D.html",Geometry3D:"geometry3D.html",Grouping:"group.html","H-Anim":"hanim.html",Interpolation:"interp.html",KeyDeviceSensor:"keyboard.html",Layering:"layering.html",Layout:"layout.html",Lighting:"lighting.html",Navigation:"navigation.html",Networking:"networking.html",NURBS:"nurbs.html",ParticleSystems:"particle_systems.html",Picking:"picking.html",PointingDeviceSensor:"pointingsensor.html",Rendering:"rendering.html",RigidBodyPhysics:"rigid_physics.html",Scripting:"scripting.html",Shaders:"shaders.html",Shape:"shape.html",Sound:"sound.html",Text:"text.html",Texturing3D:"texture3D.html",Texturing:"texturing.html",Time:"time.html",EventUtilities:"utils.html",VolumeRendering:"volume.html"},x3dom.docs.specBaseURL="http://www.web3d.org/x3d/specifications/ISO-IEC-19775-1.2-X3D-AbstractSpecification/Part01/components/",x3dom.docs.getNodeTreeInfo=function(){var e,t,i="",o=function(e,t){for(var i=0;i<e.length;i++)if(e[i]===t)return!0;return!1},s=function r(e,t){for(var o=0;t>o;o++)i+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";i+="<a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[x3dom.nodeTypes[e]._compName]+"#"+e+"' style='color:black; text-decoration:none; font-weight:bold;'>"+e+"</a> &nbsp; <a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[x3dom.nodeTypes[e]._compName]+"' style='color:black; text-decoration:none; font-style:italic;'>"+x3dom.nodeTypes[e]._compName+"</a><br/>";for(var o in x3dom.nodeTypes[e].childTypes[e])r(x3dom.nodeTypes[e].childTypes[e][o],t+1)};for(e in x3dom.nodeTypes){var t=x3dom.nodeTypes[e];for(void 0===t.childTypes&&(t.childTypes={});t.superClass;)void 0===t.superClass.childTypes[t.superClass._typeName]&&(t.superClass.childTypes[t.superClass._typeName]=[]),o(t.superClass.childTypes[t.superClass._typeName],t._typeName)||t.superClass.childTypes[t.superClass._typeName].push(t._typeName),t=t.superClass}return s("X3DNode",0),"<div class='x3dom-doc-nodes-tree'>"+i+"</div>"},x3dom.docs.getComponentInfo=function(){var e,t,i,o=[],s="";for(t in x3dom.components)o.push(t);o.sort();for(i in o){t=o[i],e=x3dom.components[t],s+="<h2><a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[t]+"' style='color:black; text-decoration:none; font-style:italic;'>"+t+"</a></h2>",s+="<ul style='list-style-type:circle;'>";for(var r in e)s+="<li><a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[t]+"#"+r+"' style='color:black; text-decoration:none; font-weight:bold;'>"+r+"</a></li>";s+="</ul>"}return s},x3dom.shader={},x3dom.shader.PICKING="picking",x3dom.shader.PICKING_24="picking24",x3dom.shader.PICKING_ID="pickingId",x3dom.shader.PICKING_COLOR="pickingColor",x3dom.shader.PICKING_TEXCOORD="pickingTexCoord",x3dom.shader.FRONTGROUND_TEXTURE="frontgroundTexture",x3dom.shader.BACKGROUND_TEXTURE="backgroundTexture",x3dom.shader.BACKGROUND_SKYTEXTURE="backgroundSkyTexture",x3dom.shader.BACKGROUND_CUBETEXTURE="backgroundCubeTexture",x3dom.shader.BLUR="blur",x3dom.shader.DEPTH="depth",x3dom.shader.NORMAL="normal",x3dom.shader.TEXTURE_REFINEMENT="textureRefinement",x3dom.shader.SSAO="ssao",x3dom.shader.material=function(){var e="uniform vec3  diffuseColor;\nuniform vec3  specularColor;\nuniform vec3  emissiveColor;\nuniform float shininess;\nuniform float transparency;\nuniform float ambientIntensity;\n";return e},x3dom.shader.twoSidedMaterial=function(){var e="uniform vec3  backDiffuseColor;\nuniform vec3  backSpecularColor;\nuniform vec3  backEmissiveColor;\nuniform float backShininess;\nuniform float backTransparency;\nuniform float backAmbientIntensity;\n";return e},x3dom.shader.fog=function(){var e="uniform vec3  fogColor;\nuniform float fogType;\nuniform float fogRange;\nvarying vec3 fragEyePosition;\nfloat calcFog(in vec3 eye) {\n   float f0 = 0.0;\n   if(fogType == 0.0) {\n       if(length(eye) < fogRange){\n           f0 = (fogRange-length(eye)) / fogRange;\n       }\n   }else{\n       if(length(eye) < fogRange){\n           f0 = exp(-length(eye) / (fogRange-length(eye) ) );\n       }\n   }\n   f0 = clamp(f0, 0.0, 1.0);\n   return f0;\n}\n";return e},x3dom.shader.clipPlanes=function(e){var t,i="";for(t=0;e>t;t++)i+="uniform vec4 clipPlane"+t+"_Plane;\n",i+="uniform float clipPlane"+t+"_CappingStrength;\n",i+="uniform vec3 clipPlane"+t+"_CappingColor;\n";for(i+="vec3 calculateClipPlanes() {\n",t=0;e>t;t++)i+="    vec4 clipPlane"+t+" = clipPlane"+t+"_Plane * viewMatrixInverse;\n",i+="    float dist"+t+" = dot(fragPosition, clipPlane"+t+");\n";for(i+="    if( ",t=0;e>t;t++)0!=t&&(i+=" || "),i+="dist"+t+" < 0.0";for(i+=" ) ",i+="{ discard; }\n",t=0;e>t;t++)i+="    if( abs(dist"+t+") < clipPlane"+t+"_CappingStrength ) ",i+="{ return clipPlane"+t+"_CappingColor; }\n";return i+="    return vec3(-1.0, -1.0, -1.0);\n",i+="}\n"},x3dom.shader.gammaCorrectionDecl=function(e){var t="";return"none"===e.GAMMACORRECTION||("fastlinear"===e.GAMMACORRECTION?(t+="vec4 gammaEncode(vec4 color){\n  vec4 tmp = sqrt(color);\n  return vec4(tmp.rgb, color.a);\n}\n",t+="vec4 gammaDecode(vec4 color){\n  vec4 tmp = color * color;\n  return vec4(tmp.rgb, color.a);\n}\n",t+="vec3 gammaEncode(vec3 color){\n  return sqrt(color);\n}\n",t+="vec3 gammaDecode(vec3 color){\n  return (color * color);\n}\n"):(t+="const vec4 gammaEncode4Vector = vec4(0.4545454545454545, 0.4545454545454545, 0.4545454545454545, 1.0);\n",t+="const vec4 gammaDecode4Vector = vec4(2.2, 2.2, 2.2, 1.0);\n",t+="vec4 gammaEncode(vec4 color){\n    return pow(color, gammaEncode4Vector);\n}\n",t+="vec4 gammaDecode(vec4 color){\n    return pow(color, gammaDecode4Vector);\n}\n",t+="const vec3 gammaEncode3Vector = vec3(0.4545454545454545, 0.4545454545454545, 0.4545454545454545);\n",t+="const vec3 gammaDecode3Vector = vec3(2.2, 2.2, 2.2);\n",t+="vec3 gammaEncode(vec3 color){\n    return pow(color, gammaEncode3Vector);\n}\n",t+="vec3 gammaDecode(vec3 color){\n    return pow(color, gammaDecode3Vector);\n}\n")),t},x3dom.shader.encodeGamma=function(e,t){return"none"===e.GAMMACORRECTION?t:"gammaEncode ("+t+")"},x3dom.shader.decodeGamma=function(e,t){return"none"===e.GAMMACORRECTION?t:"gammaDecode ("+t+")"},x3dom.shader.rgbaPacking=function(){var e="";return e+="vec4 packDepth(float depth){\n depth = (depth + 1.0)*0.5;\n vec4 outVal = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n outVal = fract(outVal);\n   outVal -= outVal.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n   return outVal;\n}\n",e+="float unpackDepth(vec4 color){\n float depth = dot(color, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0));\n return (2.0*depth - 1.0);\n}\n"},x3dom.shader.shadowRendering=function(){var e="";return e+="float getLightInfluence(float lType, float lShadowIntensity, float lOn, vec3 lLocation, vec3 lDirection, float lCutOffAngle, float lBeamWidth, vec3 lAttenuation, float lRadius, vec3 eyeCoords) {\n if (lOn == 0.0 || lShadowIntensity == 0.0){ return 0.0;\n } else if (lType == 0.0) {\n  return 1.0;\n } else {\n    float attenuation = 0.0;\n    vec3 lightVec = (lLocation - (eyeCoords));\n    float distance = length(lightVec);\n  lightVec = normalize(lightVec);\n  eyeCoords = normalize(-eyeCoords);\n    if(lRadius == 0.0 || distance <= lRadius) {\n        attenuation = 1.0 / max(lAttenuation.x + lAttenuation.y * distance + lAttenuation.z * (distance * distance), 1.0);\n  }\n   if (lType == 1.0) return attenuation;\n    float spotAngle = acos(max(0.0, dot(-lightVec, normalize(lDirection))));\n    if(spotAngle >= lCutOffAngle) return 0.0;\n    else if(spotAngle <= lBeamWidth) return attenuation;\n    else return attenuation * (spotAngle - lCutOffAngle) / (lBeamWidth - lCutOffAngle);\n }\n}\n",e+="void getShadowValues(inout vec4 shadowMapValues, inout float viewSampleDepth, in mat4 lightMatrix, in vec4 worldCoords, in sampler2D shadowMap){\n vec4 lightSpaceCoords = lightMatrix*worldCoords;\n vec3 lightSpaceCoordsCart = lightSpaceCoords.xyz / lightSpaceCoords.w;\n vec2 textureCoords = (lightSpaceCoordsCart.xy + 1.0)*0.5;\n viewSampleDepth = lightSpaceCoordsCart.z;\n shadowMapValues = texture2D(shadowMap, textureCoords);\n",(!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE)&&(e+=" shadowMapValues = vec4(1.0,1.0,unpackDepth(shadowMapValues),1.0);\n"),e+="}\n",e+="void getShadowValuesPointLight(inout vec4 shadowMapValues, inout float viewSampleDepth, in vec3 lLocation, in vec4 worldCoords, in mat4 lightViewMatrix,in mat4 lMatrix_0, in mat4 lMatrix_1, in mat4 lMatrix_2, in mat4 lMatrix_3, in mat4 lMatrix_4, in mat4 lMatrix_5,in sampler2D shadowMap_0, in sampler2D shadowMap_1, in sampler2D shadowMap_2, in sampler2D shadowMap_3,in sampler2D shadowMap_4, in sampler2D shadowMap_5){\n vec4 transformed = lightViewMatrix * worldCoords;\n vec3 lightVec = normalize(transformed.xyz/transformed.w);\n vec3 lightVecAbs = abs(lightVec);\n float maximum = max(max(lightVecAbs.x, lightVecAbs.y),lightVecAbs.z);\n if (lightVecAbs.x == maximum) {\n  if (lightVec.x < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_3,worldCoords,shadowMap_3);\n  else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_1,worldCoords,shadowMap_1);\n }\n else if (lightVecAbs.y == maximum) {\n  if (lightVec.y < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_4,worldCoords,shadowMap_4);\n  else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_5,worldCoords,shadowMap_5);\n }\n else if (lightVec.z < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_0,worldCoords,shadowMap_0);\n else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_2,worldCoords,shadowMap_2);\n}\n",e+="void getShadowValuesCascaded(inout vec4 shadowMapValues, inout float viewSampleDepth, in vec4 worldCoords, in float eyeDepth, in mat4 lMatrix_0, in mat4 lMatrix_1, in mat4 lMatrix_2,in mat4 lMatrix_3, in mat4 lMatrix_4, in mat4 lMatrix_5, in sampler2D shadowMap_0, in sampler2D shadowMap_1, in sampler2D shadowMap_2,in sampler2D shadowMap_3, in sampler2D shadowMap_4, in sampler2D shadowMap_5, in float split_0, in float split_1, in float split_2, in float split_3, in float split_4){\n if (eyeDepth < split_0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_0, worldCoords, shadowMap_0);\n else if (eyeDepth < split_1) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_1, worldCoords, shadowMap_1);\n else if (eyeDepth < split_2) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_2, worldCoords, shadowMap_2);\n else if (eyeDepth < split_3) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_3, worldCoords, shadowMap_3);\n else if (eyeDepth < split_4) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_4, worldCoords, shadowMap_4);\n else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_5, worldCoords, shadowMap_5);\n}\n",e+="float ESM(float shadowMapDepth, float viewSampleDepth, float offset){\n",e+=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?" return exp(-80.0*(1.0-offset)*(viewSampleDepth - shadowMapDepth));\n":" return shadowMapDepth * exp(-80.0*(1.0-offset)*viewSampleDepth);\n",e+="}\n",e+="float VSM(vec2 moments, float viewSampleDepth, float offset){\n viewSampleDepth = (viewSampleDepth + 1.0) * 0.5;\n if (viewSampleDepth <= moments.x) return 1.0;\n float variance = moments.y - moments.x * moments.x;\n variance = max(variance, 0.00002 + offset*0.01);\n float d = viewSampleDepth - moments.x;\n return variance/(variance + d*d);\n}\n"},x3dom.shader.light=function(e){for(var t="",i=0;e>i;i++)t+="uniform float light"+i+"_On;\nuniform float light"+i+"_Type;\nuniform vec3  light"+i+"_Location;\nuniform vec3  light"+i+"_Direction;\nuniform vec3  light"+i+"_Color;\nuniform vec3  light"+i+"_Attenuation;\nuniform float light"+i+"_Radius;\nuniform float light"+i+"_Intensity;\nuniform float light"+i+"_AmbientIntensity;\nuniform float light"+i+"_BeamWidth;\nuniform float light"+i+"_CutOffAngle;\nuniform float light"+i+"_ShadowIntensity;\n";return t+="vec3 lighting(in float lType, in vec3 lLocation, in vec3 lDirection, in vec3 lColor, in vec3 lAttenuation, in float lRadius, in float lIntensity, in float lAmbientIntensity, in float lBeamWidth, in float lCutOffAngle, in vec3 N, in vec3 V, float shin, float ambIntensity)\n{\n   vec3 L;\n   float spot = 1.0, attentuation = 0.0;\n   if(lType == 0.0) {\n       L = -normalize(lDirection);\n  V = normalize(V);\n  attentuation = 1.0;\n   } else{\n       L = (lLocation - (-V));\n       float d = length(L);\n  L = normalize(L);\n  V = normalize(V);\n       if(lRadius == 0.0 || d <= lRadius) {\n        attentuation = 1.0 / max(lAttenuation.x + lAttenuation.y * d + lAttenuation.z * (d * d), 1.0);\n  }\n       if(lType == 2.0) {\n           float spotAngle = acos(max(0.0, dot(-L, normalize(lDirection))));\n           if(spotAngle >= lCutOffAngle) spot = 0.0;\n           else if(spotAngle <= lBeamWidth) spot = 1.0;\n           else spot = (spotAngle - lCutOffAngle ) / (lBeamWidth - lCutOffAngle);\n       }\n   }\n   vec3  H = normalize( L + V );\n   float NdotL = clamp(dot(L, N), 0.0, 1.0);\n   float NdotH = clamp(dot(H, N), 0.0, 1.0);\n   float ambientFactor  = lAmbientIntensity * ambIntensity;\n   float diffuseFactor  = lIntensity * NdotL;\n   float specularFactor = lIntensity * pow(NdotH, shin*128.0);\n   return vec3(ambientFactor, diffuseFactor, specularFactor) * attentuation * spot;\n}\n"},x3dom.shader.TBNCalculation=function(){var e="";return e+="mat3 cotangent_frame(vec3 N, vec3 p, vec2 uv)\n{\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( p );\n    vec3 dp2 = dFdy( p );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n\n    // solve the linear system\n    vec3 dp2perp = cross( dp2, N );\n    vec3 dp1perp = cross( N, dp1 );\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n    // construct a scale-invariant frame\n    float invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n    return mat3( T * invmax, B * invmax, N );\n}\n\n",e+="vec3 perturb_normal( vec3 N, vec3 V, vec2 texcoord )\n{\n    // assume N, the interpolated vertex normal and\n    // V, the view vector (vertex to eye)\n    vec3 map = texture2D(normalMap, texcoord ).xyz;\n    map = 2.0 * map - 1.0;\n    mat3 TBN = cotangent_frame(N, -V, texcoord);\n    return normalize(TBN * map);\n}\n\n"},x3dom.shader.DynamicShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e,t),o=this.generateFragmentShader(e,t);return e.attachShader(this.program,i),e.attachShader(this.program,o),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.DynamicShader.prototype.generateVertexShader=function(e,t){var i="";if(i+="uniform mat4 modelViewMatrix;\n",i+="uniform mat4 modelViewProjectionMatrix;\n",3==t.POSCOMPONENTS?i+="attribute vec3 position;\n":4==t.POSCOMPONENTS&&(i+="attribute vec4 position;\n"),t.IMAGEGEOMETRY){i+="uniform vec3 IG_bboxMin;\n",i+="uniform vec3 IG_bboxMax;\n",i+="uniform float IG_coordTextureWidth;\n",i+="uniform float IG_coordTextureHeight;\n",i+="uniform vec2 IG_implicitMeshSize;\n";for(var o=0;o<t.IG_PRECISION;o++)i+="uniform sampler2D IG_coords"+o+"\n;";t.IG_INDEXED&&(i+="uniform sampler2D IG_index;\n",i+="uniform float IG_indexTextureWidth;\n",i+="uniform float IG_indexTextureHeight;\n")}if(t.POPGEOMETRY&&(i+="uniform float PG_precisionLevel;\n",i+="uniform float PG_powPrecision;\n",i+="uniform vec3 PG_maxBBSize;\n",i+="uniform vec3 PG_bbMin;\n",i+="uniform vec3 PG_bbMaxModF;\n",i+="uniform vec3 PG_bboxShiftVec;\n",i+="uniform float PG_numAnchorVertices;\n",i+="attribute float PG_vertexID;\n"),t.LIGHTS&&(t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(i+="varying vec3 fragNormal;\n",i+="uniform mat4 normalMatrix;\n",t.IMAGEGEOMETRY?i+="uniform sampler2D IG_normals;\n":2==t.NORCOMPONENTS?4!=t.POSCOMPONENTS&&(i+="attribute vec2 normal;\n"):3==t.NORCOMPONENTS&&(i+="attribute vec3 normal;\n"))),t.VERTEXCOLOR&&(t.IMAGEGEOMETRY?(i+="uniform sampler2D IG_colors;\n",3==t.COLCOMPONENTS?i+="varying vec3 fragColor;\n":4==t.COLCOMPONENTS&&(i+="varying vec4 fragColor;\n")):3==t.COLCOMPONENTS?(i+="attribute vec3 color;\n",i+="varying vec3 fragColor;\n"):4==t.COLCOMPONENTS&&(i+="attribute vec4 color;\n",i+="varying vec4 fragColor;\n")),t.TEXTURED&&(i+="varying vec2 fragTexcoord;\n",t.SPHEREMAPPING||(t.IMAGEGEOMETRY?i+="uniform sampler2D IG_texCoords;\n":t.IS_PARTICLE||(i+="attribute vec2 texcoord;\n")),t.TEXTRAFO&&(i+="uniform mat4 texTrafoMatrix;\n"),t.NORMALMAP&&"TANGENT"==t.NORMALSPACE&&!x3dom.caps.STD_DERIVATIVES&&(x3dom.debug.logWarning("Your System doesn't support the 'OES_STANDARD_DERIVATIVES' Extension. You must set tangents and binormals manually via the FloatVertexAttribute-Node to use normal maps"),i+="attribute vec3 tangent;\n",i+="attribute vec3 binormal;\n",i+="varying vec3 fragTangent;\n",i+="varying vec3 fragBinormal;\n"),t.CUBEMAP&&(i+="varying vec3 fragViewDir;\n",i+="uniform mat4 viewMatrix;\n"),t.DISPLACEMENTMAP&&(i+="uniform sampler2D displacementMap;\n",i+="uniform float displacementFactor;\n",i+="uniform float displacementWidth;\n",i+="uniform float displacementHeight;\n",i+="uniform float displacementAxis;\n"),t.DIFFPLACEMENTMAP&&(i+="uniform sampler2D diffuseDisplacementMap;\n",i+="uniform float displacementFactor;\n",i+="uniform float displacementWidth;\n",i+="uniform float displacementHeight;\n",i+="uniform float displacementAxis;\n")),t.VERTEXID&&(i+="attribute float id;\n",i+="varying float fragID;\n"),t.IS_PARTICLE&&(i+="attribute vec3 particleSize;\n"),(t.LIGHTS||t.FOG||t.CLIPPLANES)&&(i+="uniform vec3 eyePosition;\n",i+="varying vec4 fragPosition;\n",t.FOG&&(i+="varying vec3 fragEyePosition;\n")),t.REQUIREBBOX&&(i+="uniform vec3 bgCenter;\n",i+="uniform vec3 bgSize;\n",i+="uniform float bgPrecisionMax;\n"),t.REQUIREBBOXNOR&&(i+="uniform float bgPrecisionNorMax;\n"),t.REQUIREBBOXCOL&&(i+="uniform float bgPrecisionColMax;\n"),t.REQUIREBBOXTEX&&(i+="uniform float bgPrecisionTexMax;\n"),t.CUSTOM_ATTR)for(var s,r=0,n=t.CUSTOM_ATTR.length;n>r;r++){switch(t.CUSTOM_ATTR[r].numComponents){case 2:s="vec2 ";break;case 3:s="vec3 ";break;case 4:s="vec4 ";break;default:s="float "}i+="attribute "+s+t.CUSTOM_ATTR[r].name+";\n"}if(i+=t.CUSTOM_ATTRIBUTES.vertexShaderPartInit+"\n",i+="void main(void) {\n",t.IMAGEGEOMETRY){t.IG_INDEXED?(i+="vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n",i+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n",i+="vec2 IG_indices = texture2D( IG_index, IG_texCoord ).rg;\n",i+="halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);\n",i+="IG_texCoord = (IG_indices * 0.996108948) + halfPixel;\n"):(i+="vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n",i+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n"),i+="vec3 temp = vec3(0.0, 0.0, 0.0);\n",i+="vec3 vertPosition = vec3(0.0, 0.0, 0.0);\n";for(var o=0;o<t.IG_PRECISION;o++)i+="temp = 255.0 * texture2D( IG_coords"+o+", IG_texCoord ).rgb;\n",i+="vertPosition *= 256.0;\n",i+="vertPosition += temp;\n";i+="vertPosition /= (pow(2.0, 8.0 * "+t.IG_PRECISION+".0) - 1.0);\n",i+="vertPosition = vertPosition * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n",t.LIGHTS&&(i+="vec3 vertNormal = texture2D( IG_normals, IG_texCoord ).rgb;\n",i+="vertNormal = vertNormal * 2.0 - 1.0;\n"),t.VERTEXCOLOR&&(3==t.COLCOMPONENTS?i+="fragColor = texture2D( IG_colors, IG_texCoord ).rgb;\n":4==t.COLCOMPONENTS&&(i+="fragColor = texture2D( IG_colors, IG_texCoord ).rgba;\n")),t.TEXTURED&&(i+="vec4 IG_doubleTexCoords = texture2D( IG_texCoords, IG_texCoord );\n",i+="vec2 vertTexCoord;",i+="vertTexCoord.r = (IG_doubleTexCoords.r * 0.996108948) + (IG_doubleTexCoords.b * 0.003891051);\n",i+="vertTexCoord.g = (IG_doubleTexCoords.g * 0.996108948) + (IG_doubleTexCoords.a * 0.003891051);\n")}else i+="vec3 vertPosition = position.xyz;\n",t.POPGEOMETRY?(i+="vec3 offsetVec = step(vertPosition / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",i+="if ((PG_precisionLevel <= 2.0) || PG_vertexID >= PG_numAnchorVertices) {\n",i+="   vertPosition = floor(vertPosition / PG_powPrecision) * PG_powPrecision;\n",i+="   vertPosition /= (65536.0 - PG_powPrecision);\n",i+="}\n",i+="else {\n",i+="   vertPosition /= bgPrecisionMax;\n",i+="}\n",i+="vertPosition = (vertPosition + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):t.REQUIREBBOX&&(i+="vertPosition = bgCenter + bgSize * vertPosition / bgPrecisionMax;\n"),t.LIGHTS&&(2==t.NORCOMPONENTS?(4==t.POSCOMPONENTS?(i+="vec3 vertNormal = vec3(position.w / 256.0); \n",i+="vertNormal.x = floor(vertNormal.x) / 255.0; \n",i+="vertNormal.y = fract(vertNormal.y) * 1.00392156862745; \n"):t.REQUIREBBOXNOR&&(i+="vec3 vertNormal = vec3(normal.xy, 0.0) / bgPrecisionNorMax;\n"),i+="vec2 thetaPhi = 3.14159265358979 * vec2(vertNormal.x, vertNormal.y*2.0-1.0); \n",i+="vec4 sinCosThetaPhi = sin( vec4(thetaPhi, thetaPhi + 1.5707963267949) ); \n",i+="vertNormal.x = sinCosThetaPhi.x * sinCosThetaPhi.w; \n",i+="vertNormal.y = sinCosThetaPhi.x * sinCosThetaPhi.y; \n",i+="vertNormal.z = sinCosThetaPhi.z; \n"):t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(i+="vec3 vertNormal = normal;\n",t.REQUIREBBOXNOR&&(i+="vertNormal = vertNormal / bgPrecisionNorMax;\n"),t.POPGEOMETRY&&(i+="vertNormal = 2.0*vertNormal - 1.0;\n"))),t.VERTEXCOLOR&&(i+="fragColor = color;\n",t.REQUIREBBOXCOL&&(i+="fragColor = fragColor / bgPrecisionColMax;\n")),t.TEXTURED&&!t.SPHEREMAPPING&&(t.IS_PARTICLE?i+="vec2 vertTexCoord = vec2(0.0);\n":(i+="vec2 vertTexCoord = texcoord;\n",t.REQUIREBBOXTEX&&(i+="vertTexCoord = vertTexCoord / bgPrecisionTexMax;\n")));t.LIGHTS&&(!t.DISPLACEMENTMAP&&!t.DIFFPLACEMENTMAP||t.NORMALMAP?t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(i+="fragNormal = (normalMatrix * vec4(vertNormal, 0.0)).xyz;\n"):(i+="float dx = 1.0 / displacementWidth;\n",i+="float dy = 1.0 / displacementHeight;\n",t.DISPLACEMENTMAP?(i+="float s1 = texture2D(displacementMap, vec2(vertTexCoord.x - dx, 1.0 - vertTexCoord.y)).r;\n",i+="float s2 = texture2D(displacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y - dy)).r;\n",i+="float s3 = texture2D(displacementMap, vec2(vertTexCoord.x + dx, 1.0 - vertTexCoord.y)).r;\n",i+="float s4 = texture2D(displacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y + dy)).r;\n"):t.DIFFPLACEMENTMAP&&(i+="float s1 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x - dx, 1.0 - vertTexCoord.y)).a;\n",i+="float s2 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y - dy)).a;\n",i+="float s3 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x + dx, 1.0 - vertTexCoord.y)).a;\n",i+="float s4 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y + dy)).a;\n"),i+="float coef = displacementFactor;\n",i+="vec3 calcNormal;\n",i+="if (displacementAxis == 0.0) {\n",i+="calcNormal = vec3((s1 - s3) * coef, -5.0, (s2 - s4) * coef);\n",i+="} else if(displacementAxis == 1.0) {\n",i+="calcNormal = vec3((s1 - s3) * coef, -5.0, (s2 - s4) * coef);\n",i+="} else {\n",i+="calcNormal = vec3((s1 - s3) * coef, -(s2 - s4) * coef, 5.0);\n",i+="}\n",i+="calcNormal = normalize(calcNormal);\n",i+="fragNormal = (normalMatrix * vec4(calcNormal, 0.0)).xyz;\n")),t.TEXTURED&&(t.CUBEMAP&&(i+="fragViewDir = (viewMatrix[3].xyz);\n"),t.SPHEREMAPPING?i+=" fragTexcoord = 0.5 + fragNormal.xy / 2.0;\n":t.TEXTRAFO?i+=" fragTexcoord = (texTrafoMatrix * vec4(vertTexCoord, 1.0, 1.0)).xy;\n":(i+=" fragTexcoord = vertTexCoord;\n",t.POPGEOMETRY&&x3dom.debug.usePrecisionLevelAsTexCoord===!0&&(i+="fragTexcoord = vec2(0.03125 + 0.9375 * (PG_precisionLevel / 16.0), 1.0);")),t.NORMALMAP&&"TANGENT"==t.NORMALSPACE&&!x3dom.caps.STD_DERIVATIVES&&(i+="fragTangent  = (normalMatrix * vec4(tangent, 0.0)).xyz;\n",i+="fragBinormal = (normalMatrix * vec4(binormal, 0.0)).xyz;\n")),(t.LIGHTS||t.FOG||t.CLIPPLANES)&&(i+="fragPosition = (modelViewMatrix * vec4(vertPosition, 1.0));\n",t.FOG&&(i+="fragEyePosition = eyePosition - fragPosition.xyz;\n")),t.MULTIDIFFALPMAP&&(i+="fragID = id;\n"),t.DISPLACEMENTMAP?i+="vertPosition += normalize(vertNormal) * texture2D(displacementMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).r * displacementFactor;\n":t.DIFFPLACEMENTMAP&&(i+="vertPosition += normalize(vertNormal) * texture2D(diffuseDisplacementMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).a * displacementFactor;\n"),i+="gl_Position = modelViewProjectionMatrix * vec4(vertPosition, 1.0);\n",t.IS_PARTICLE?(i+="float spriteDist = (gl_Position.w > 0.000001) ? gl_Position.w : 0.000001;\n",i+="float pointSize = floor(length(particleSize) * 256.0 / spriteDist + 0.5);\n",i+="gl_PointSize = clamp(pointSize, 2.0, 256.0);\n"):i+="gl_PointSize = 2.0;\n",i+=t.CUSTOM_ATTRIBUTES.vertexShaderPartMain+"\n",i+="}\n";var a=e.createShader(e.VERTEX_SHADER);return e.shaderSource(a,i),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)||(x3dom.debug.logInfo("VERTEX:\n"+i),x3dom.debug.logError("VertexShader "+e.getShaderInfoLog(a))),a},x3dom.shader.DynamicShader.prototype.generateFragmentShader=function(e,t){var i="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";if(i+=" precision highp float;\n",i+="#else\n",i+=" precision mediump float;\n",i+="#endif\n\n",i+="uniform mat4 modelMatrix;\n",i+="uniform mat4 modelViewMatrix;\n",i+="uniform mat4 viewMatrixInverse;\n",i+=x3dom.shader.material(),t.TWOSIDEDMAT&&(i+=x3dom.shader.twoSidedMaterial()),t.VERTEXCOLOR&&(3==t.COLCOMPONENTS?i+="varying vec3 fragColor;  \n":4==t.COLCOMPONENTS&&(i+="varying vec4 fragColor;  \n")),(t.CUBEMAP||t.CLIPPLANES)&&(i+="uniform mat4 modelViewMatrixInverse;\n"),t.VERTEXID&&(i+="varying float fragID;\n",t.MULTIDIFFALPMAP&&(i+="uniform sampler2D multiDiffuseAlphaMap;\n",i+="uniform float multiDiffuseAlphaWidth;\n",i+="uniform float multiDiffuseAlphaHeight;\n"),t.MULTIEMIAMBMAP&&(i+="uniform sampler2D multiEmissiveAmbientMap;\n",i+="uniform float multiEmissiveAmbientWidth;\n",i+="uniform float multiEmissiveAmbientHeight;\n"),t.MULTISPECSHINMAP&&(i+="uniform sampler2D multiSpecularShininessMap;\n",i+="uniform float multiSpecularShininessWidth;\n",i+="uniform float multiSpecularShininessHeight;\n"),t.MULTIVISMAP&&(i+="uniform sampler2D multiVisibilityMap;\n",i+="uniform float multiVisibilityWidth;\n",i+="uniform float multiVisibilityHeight;\n")),t.TEXTURED&&(i+="varying vec2 fragTexcoord;\n",(t.TEXTURED||t.DIFFUSEMAP)&&(i+="uniform sampler2D diffuseMap;\n"),t.CUBEMAP&&(i+="uniform samplerCube environmentMap;\n",i+="varying vec3 fragViewDir;\n"),t.SPECMAP&&(i+="uniform sampler2D specularMap;\n"),t.SHINMAP&&(i+="uniform sampler2D shininessMap;\n"),t.DISPLACEMENTMAP&&(i+="uniform sampler2D displacementMap;\n",i+="uniform float displacementWidth;\n",i+="uniform float displacementHeight;\n"),t.DIFFPLACEMENTMAP&&(i+="uniform sampler2D diffuseDisplacementMap;\n",i+="uniform float displacementWidth;\n",i+="uniform float displacementHeight;\n"),t.NORMALMAP&&(i+="uniform sampler2D normalMap;\n","TANGENT"==t.NORMALSPACE?x3dom.caps.STD_DERIVATIVES?(i+="#extension GL_OES_standard_derivatives:enable\n",i+=x3dom.shader.TBNCalculation()):(i+="varying vec3 fragTangent;\n",i+="varying vec3 fragBinormal;\n"):"OBJECT"==t.NORMALSPACE&&(i+="uniform mat4 normalMatrix;\n"))),t.FOG&&(i+=x3dom.shader.fog()),(t.LIGHTS||t.CLIPPLANES)&&(i+="varying vec4 fragPosition;\n"),t.LIGHTS&&(t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(i+="varying vec3 fragNormal;\n"),i+=x3dom.shader.light(t.LIGHTS)),t.CLIPPLANES&&(i+=x3dom.shader.clipPlanes(t.CLIPPLANES)),i+=x3dom.shader.gammaCorrectionDecl(t),i+=t.CUSTOM_ATTRIBUTES.fragmentShaderPartInit+"\n",i+="void main(void) {\n",i+=t.CUSTOM_ATTRIBUTES.fragmentShaderPartMain+"\n",t.CLIPPLANES&&(i+="vec3 cappingColor = calculateClipPlanes();\n"),i+="vec4 color;\n",i+="color.rgb = "+x3dom.shader.decodeGamma(t,"diffuseColor")+";\n",i+="color.a = 1.0 - transparency;\n",i+="vec3 _emissiveColor     = emissiveColor;\n",i+="float _shininess        = shininess;\n",i+="vec3 _specularColor     = specularColor;\n",i+="float _ambientIntensity = ambientIntensity;\n",i+="float _transparency     = transparency;\n",(t.MULTIVISMAP||t.MULTIDIFFALPMAP||t.MULTISPECSHINMAP||t.MULTIEMIAMBMAP)&&(i+="vec2 idCoord;\n",i+="float roundedIDVisibility = floor(fragID+0.5);\n",i+="float roundedIDMaterial = floor(fragID+0.5);\n",i+="if(!gl_FrontFacing) {\n",i+="    roundedIDMaterial = floor(fragID + (multiDiffuseAlphaWidth*multiDiffuseAlphaWidth) + 0.5);\n",i+="}\n"),t.MULTIVISMAP&&(i+="idCoord.x = mod(roundedIDVisibility, multiVisibilityWidth) * (1.0 / multiVisibilityWidth) + (0.5 / multiVisibilityWidth);\n",i+="idCoord.y = floor(roundedIDVisibility / multiVisibilityWidth) * (1.0 / multiVisibilityHeight) + (0.5 / multiVisibilityHeight);\n",i+="vec4 visibility = texture2D( multiVisibilityMap, idCoord );\n",i+="if (visibility.r < 1.0) discard; \n"),t.MULTIDIFFALPMAP&&(i+="idCoord.x = mod(roundedIDMaterial, multiDiffuseAlphaWidth) * (1.0 / multiDiffuseAlphaWidth) + (0.5 / multiDiffuseAlphaWidth);\n",i+="idCoord.y = floor(roundedIDMaterial / multiDiffuseAlphaWidth) * (1.0 / multiDiffuseAlphaHeight) + (0.5 / multiDiffuseAlphaHeight);\n",i+="vec4 diffAlpha = texture2D( multiDiffuseAlphaMap, idCoord );\n",i+="color.rgb = "+x3dom.shader.decodeGamma(t,"diffAlpha.rgb")+";\n",i+="_transparency = 1.0 - diffAlpha.a;\n",i+="color.a = diffAlpha.a;\n"),t.MULTIEMIAMBMAP&&(i+="idCoord.x = mod(roundedIDMaterial, multiDiffuseAlphaWidth) * (1.0 / multiDiffuseAlphaWidth) + (0.5 / multiDiffuseAlphaWidth);\n",i+="idCoord.y = floor(roundedIDMaterial / multiDiffuseAlphaWidth) * (1.0 / multiDiffuseAlphaHeight) + (0.5 / multiDiffuseAlphaHeight);\n",i+="vec4 emiAmb = texture2D( multiEmissiveAmbientMap, idCoord );\n",i+="_emissiveColor = emiAmb.rgb;\n",i+="_ambientIntensity = emiAmb.a;\n"),t.VERTEXCOLOR&&(3===t.COLCOMPONENTS?i+="color.rgb = "+x3dom.shader.decodeGamma(t,"fragColor")+";\n":4===t.COLCOMPONENTS&&(i+="color = "+x3dom.shader.decodeGamma(t,"fragColor")+";\n")),t.LIGHTS){if(i+="vec3 ambient   = vec3(0.0, 0.0, 0.0);\n",i+="vec3 diffuse   = vec3(0.0, 0.0, 0.0);\n",i+="vec3 specular  = vec3(0.0, 0.0, 0.0);\n",i+="vec3 eye    = -fragPosition.xyz;\n",i+=t.NORMALMAP&&"OBJECT"==t.NORMALSPACE?"vec3 normal  = vec3(0.0, 0.0, 0.0);\n":"vec3 normal    = normalize(fragNormal);\n",t.NORMALMAP&&("TANGENT"==t.NORMALSPACE?(i+="vec3 n = normal;\n",x3dom.caps.STD_DERIVATIVES?i+="normal = perturb_normal( n, fragPosition.xyz, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) );\n":(i+="vec3 t = normalize( fragTangent );\n",i+="vec3 b = normalize( fragBinormal );\n",i+="mat3 tangentToWorld = mat3(t, b, n);\n",i+="normal = texture2D( normalMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) ).rgb;\n",i+="normal = 2.0 * normal - 1.0;\n",i+="normal = normalize( normal * tangentToWorld );\n",i+="normal.y = -normal.y;\n",i+="normal.x = -normal.x;\n")):"OBJECT"==t.NORMALSPACE&&(i+="normal = texture2D( normalMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) ).rgb;\n",i+="normal = 2.0 * normal - 1.0;\n",i+="normal = (normalMatrix * vec4(normal, 0.0)).xyz;\n",i+="normal = normalize(normal);\n")),t.SHINMAP&&(i+="_shininess = texture2D( shininessMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) ).r;\n"),t.SPECMAP&&(i+="_specularColor = "+x3dom.shader.decodeGamma(t,"texture2D(specularMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).rgb")+";\n"),t.MULTISPECSHINMAP&&(i+="idCoord.x = mod(roundedIDMaterial, multiSpecularShininessWidth) * (1.0 / multiSpecularShininessWidth) + (0.5 / multiSpecularShininessWidth);\n",i+="idCoord.y = floor(roundedIDMaterial / multiSpecularShininessWidth) * (1.0 / multiSpecularShininessHeight) + (0.5 / multiSpecularShininessHeight);\n",i+="vec4 specShin = texture2D( multiSpecularShininessMap, idCoord );\n",i+="_specularColor = specShin.rgb;\n",i+="_shininess = specShin.a;\n"),
(!t.SOLID||t.TWOSIDEDMAT)&&(i+="if (dot(normal, eye) < 0.0) {\n",i+="  normal *= -1.0;\n",i+="}\n"),t.SEPARATEBACKMAT&&(i+="  if(!gl_FrontFacing) {\n",i+="    color.rgb = "+x3dom.shader.decodeGamma(t,"backDiffuseColor")+";\n",i+="    color.a = 1.0 - backTransparency;\n",i+="    _transparency = 1.0 - backTransparency;\n",i+="    _shininess = backShininess;\n",i+="    _emissiveColor = backEmissiveColor;\n",i+="    _specularColor = backSpecularColor;\n",i+="    _ambientIntensity = backAmbientIntensity;\n",i+="  }\n"),t.LIGHTS){i+="vec3 ads;\n";for(var o=0;o<t.LIGHTS;o++){var s="light"+o+"_Color";i+="ads = lighting(light"+o+"_Type, light"+o+"_Location, light"+o+"_Direction, "+s+", light"+o+"_Attenuation, light"+o+"_Radius, light"+o+"_Intensity, light"+o+"_AmbientIntensity, light"+o+"_BeamWidth, light"+o+"_CutOffAngle, normal, eye, _shininess, _ambientIntensity);\n",i+="   ambient  += "+s+" * ads.r;\n   diffuse  += "+s+" * ads.g;\n   specular += "+s+" * ads.b;\n"}i+="ambient = max(ambient, 0.0);\n",i+="diffuse = max(diffuse, 0.0);\n",i+="specular = max(specular, 0.0);\n"}t.TEXTURED&&(t.DIFFUSEMAP||t.DIFFPLACEMENTMAP||t.TEXT||t.CUBEMAP)?(t.CUBEMAP&&(i+="vec3 viewDir = normalize(fragViewDir);\n",i+="vec3 reflected = reflect(-eye, normal);\n",i+="reflected = (modelViewMatrixInverse * vec4(reflected, 0.0)).xyz;\n",i+="vec4 envColor = "+x3dom.shader.decodeGamma(t,"textureCube(environmentMap, reflected)")+";\n",i+="color.a *= envColor.a;\n"),t.DIFFPLACEMENTMAP?(i+="vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",i+="vec4 texColor = texture2D(diffuseDisplacementMap, texCoord);\n"):(t.DIFFUSEMAP||t.TEXT)&&(i+=t.PIXELTEX?"vec2 texCoord = fragTexcoord;\n":"vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",i+="vec4 texColor = "+x3dom.shader.decodeGamma(t,"texture2D(diffuseMap, texCoord)")+";\n",i+="color.a *= texColor.a;\n"),t.BLENDING?(i+="color.rgb = (_emissiveColor + max(ambient + diffuse, 0.0) * color.rgb + specular*_specularColor);\n",(t.DIFFUSEMAP||t.TEXT)&&(i+="color.rgb *= texColor.rgb;\n"),t.CUBEMAP&&(i+="color.rgb *= envColor.rgb;\n")):i+="color.rgb = (_emissiveColor + max(ambient + diffuse, 0.0) * texColor.rgb + specular*_specularColor);\n"):i+="color.rgb = (_emissiveColor + max(ambient + diffuse, 0.0) * color.rgb + specular*_specularColor);\n"}else t.APPMAT&&!t.VERTEXCOLOR&&(i+="color = vec4(0.0, 0.0, 0.0, 1.0 - _transparency);\n"),t.TEXTURED&&(t.DIFFUSEMAP||t.DIFFPLACEMENTMAP||t.TEXT)?(i+=t.PIXELTEX?"vec2 texCoord = fragTexcoord;\n":"vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",t.IS_PARTICLE&&(i+="texCoord = clamp(gl_PointCoord, 0.01, 0.99);\n"),i+="vec4 texColor = "+x3dom.shader.decodeGamma(t,"texture2D(diffuseMap, texCoord)")+";\n",i+="color.a = texColor.a;\n",t.BLENDING||t.IS_PARTICLE?(i+="color.rgb += _emissiveColor.rgb;\n",i+="color.rgb *= texColor.rgb;\n"):i+="color = texColor;\n"):t.VERTEXCOLOR||t.POINTLINE2D?!t.VERTEXCOLOR&&t.POINTLINE2D?(i+="color.rgb = _emissiveColor;\n",t.IS_PARTICLE&&(i+="float pAlpha = 1.0 - clamp(length((gl_PointCoord - 0.5) * 2.0), 0.0, 1.0);\n",i+="color.rgb *= vec3(pAlpha);\n",i+="color.a = pAlpha;\n")):t.IS_PARTICLE&&(i+="float pAlpha = 1.0 - clamp(length((gl_PointCoord - 0.5) * 2.0), 0.0, 1.0);\n",i+="color.rgb *= vec3(pAlpha);\n",i+="color.a = pAlpha;\n"):i+="color.rgb += _emissiveColor;\n";t.CLIPPLANES&&(i+="if (cappingColor.r != -1.0) {\n",i+="    color.rgb = cappingColor;\n",i+="}\n"),i+=t.TEXT?"if (color.a <= 0.5) discard;\n":"if (color.a <= "+t.ALPHATHRESHOLD+") discard;\n",i+="color = clamp(color, 0.0, 1.0);\n",i+="color = "+x3dom.shader.encodeGamma(t,"color")+";\n",t.FOG&&(i+="float f0 = calcFog(fragEyePosition);\n",i+="color.rgb = fogColor * (1.0-f0) + f0 * (color.rgb);\n"),i+="gl_FragColor = color;\n",i+="}\n";var r=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(r,i),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)||(x3dom.debug.logInfo("FRAGMENT:\n"+i),x3dom.debug.logError("FragmentShader "+e.getShaderInfoLog(r))),r},x3dom.shader.DynamicMobileShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e,t),o=this.generateFragmentShader(e,t);return e.attachShader(this.program,i),e.attachShader(this.program,o),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.DynamicMobileShader.prototype.generateVertexShader=function(e,t){var i="";if(i+=x3dom.shader.material(),t.TWOSIDEDMAT&&(i+=x3dom.shader.twoSidedMaterial()),i+="uniform mat4 normalMatrix;\n",i+="uniform mat4 modelViewMatrix;\n",i+="uniform mat4 modelViewProjectionMatrix;\n",3==t.POSCOMPONENTS?i+="attribute vec3 position;\n":4==t.POSCOMPONENTS&&(i+="attribute vec4 position;\n"),t.IMAGEGEOMETRY){i+="uniform vec3 IG_bboxMin;\n",i+="uniform vec3 IG_bboxMax;\n",i+="uniform float IG_coordTextureWidth;\n",i+="uniform float IG_coordTextureHeight;\n",i+="uniform vec2 IG_implicitMeshSize;\n";for(var o=0;o<t.IG_PRECISION;o++)i+="uniform sampler2D IG_coords"+o+"\n;";t.IG_INDEXED&&(i+="uniform sampler2D IG_index;\n",i+="uniform float IG_indexTextureWidth;\n",i+="uniform float IG_indexTextureHeight;\n")}if(t.POPGEOMETRY&&(i+="uniform float PG_precisionLevel;\n",i+="uniform float PG_powPrecision;\n",i+="uniform vec3 PG_maxBBSize;\n",i+="uniform vec3 PG_bbMin;\n",i+="uniform vec3 PG_bbMaxModF;\n",i+="uniform vec3 PG_bboxShiftVec;\n",i+="uniform float PG_numAnchorVertices;\n",i+="attribute float PG_vertexID;\n"),t.POINTLINE2D||(t.IMAGEGEOMETRY?i+="uniform sampler2D IG_normals;\n":2==t.NORCOMPONENTS?4!=t.POSCOMPONENTS&&(i+="attribute vec2 normal;\n"):3==t.NORCOMPONENTS&&(i+="attribute vec3 normal;\n")),i+="varying vec4 fragColor;\n",t.VERTEXCOLOR&&(t.IMAGEGEOMETRY?i+="uniform sampler2D IG_colors;":3==t.COLCOMPONENTS?i+="attribute vec3 color;":4==t.COLCOMPONENTS&&(i+="attribute vec4 color;")),t.TEXTURED&&(i+="varying vec2 fragTexcoord;\n",i+=t.IMAGEGEOMETRY?"uniform sampler2D IG_texCoords;":"attribute vec2 texcoord;\n",t.TEXTRAFO&&(i+="uniform mat4 texTrafoMatrix;\n"),t.BLENDING||(i+="varying vec3 fragAmbient;\n",i+="varying vec3 fragDiffuse;\n"),t.CUBEMAP&&(i+="varying vec3 fragViewDir;\n",i+="varying vec3 fragNormal;\n",i+="uniform mat4 viewMatrix;\n")),t.FOG&&(i+=x3dom.shader.fog()),t.LIGHTS&&(i+=x3dom.shader.light(t.LIGHTS)),t.REQUIREBBOX&&(i+="uniform vec3 bgCenter;\n",i+="uniform vec3 bgSize;\n",i+="uniform float bgPrecisionMax;\n"),t.REQUIREBBOXNOR&&(i+="uniform float bgPrecisionNorMax;\n"),t.REQUIREBBOXCOL&&(i+="uniform float bgPrecisionColMax;\n"),t.REQUIREBBOXTEX&&(i+="uniform float bgPrecisionTexMax;\n"),i+="void main(void) {\n",i+="gl_PointSize = 2.0;\n",t.IMAGEGEOMETRY){t.IG_INDEXED?(i+="vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n",i+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n",i+="vec2 IG_indices = texture2D( IG_index, IG_texCoord ).rg;\n",i+="halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);\n",i+="IG_texCoord = (IG_indices * 0.996108948) + halfPixel;\n"):(i+="vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n",i+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n"),i+="vec3 temp = vec3(0.0, 0.0, 0.0);\n",i+="vec3 vertPosition = vec3(0.0, 0.0, 0.0);\n";for(var o=0;o<t.IG_PRECISION;o++)i+="temp = 255.0 * texture2D( IG_coords"+o+", IG_texCoord ).rgb;\n",i+="vertPosition *= 256.0;\n",i+="vertPosition += temp;\n";i+="vertPosition /= (pow(2.0, 8.0 * "+t.IG_PRECISION+".0) - 1.0);\n",i+="vertPosition = vertPosition * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n",t.POINTLINE2D||(i+="vec3 vertNormal = texture2D( IG_normals, IG_texCoord ).rgb;\n",i+="vertNormal = vertNormal * 2.0 - 1.0;\n"),t.VERTEXCOLOR&&(3==t.COLCOMPONENTS?i+="vec3 vertColor = texture2D( IG_colors, IG_texCoord ).rgb;":4==t.COLCOMPONENTS&&(i+="vec4 vertColor = texture2D( IG_colors, IG_texCoord ).rgba;")),t.TEXTURED&&(i+="vec4 IG_doubleTexCoords = texture2D( IG_texCoords, IG_texCoord );\n",i+="vec2 vertTexCoord;",i+="vertTexCoord.r = (IG_doubleTexCoords.r * 0.996108948) + (IG_doubleTexCoords.b * 0.003891051);\n",i+="vertTexCoord.g = (IG_doubleTexCoords.g * 0.996108948) + (IG_doubleTexCoords.a * 0.003891051);\n")}else i+="vec3 vertPosition = position.xyz;\n",t.POPGEOMETRY?(i+="vec3 offsetVec = step(vertPosition / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",i+="if ((PG_precisionLevel <= 2.0) || PG_vertexID >= PG_numAnchorVertices) {\n",i+="   vertPosition = floor(vertPosition / PG_powPrecision) * PG_powPrecision;\n",i+="   vertPosition /= (65536.0 - PG_powPrecision);\n",i+="}\n",i+="else {\n",i+="   vertPosition /= bgPrecisionMax;\n",i+="}\n",i+="vertPosition = (vertPosition + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):t.REQUIREBBOX&&(i+="vertPosition = bgCenter + bgSize * vertPosition / bgPrecisionMax;\n"),t.POINTLINE2D||(2==t.NORCOMPONENTS?(4==t.POSCOMPONENTS?(i+="vec3 vertNormal = vec3(position.w / 256.0); \n",i+="vertNormal.x = floor(vertNormal.x) / 255.0; \n",i+="vertNormal.y = fract(vertNormal.y) * 1.00392156862745; \n"):i+=t.REQUIREBBOXNOR?"vec3 vertNormal = vec3(normal.xy, 0.0) / bgPrecisionNorMax;\n":"vec3 vertNormal = vec3(normal.xy, 0.0);\n",i+="vec2 thetaPhi = 3.14159265358979 * vec2(vertNormal.x, vertNormal.y*2.0-1.0); \n",i+="vec4 sinCosThetaPhi = vec4(thetaPhi, thetaPhi + 1.5707963267949); \n",i+="vec4 thetaPhiPow2 = sinCosThetaPhi * sinCosThetaPhi; \n",i+="vec4 thetaPhiPow3 =  thetaPhiPow2  * sinCosThetaPhi; \n",i+="vec4 thetaPhiPow5 =  thetaPhiPow3  * thetaPhiPow2; \n",i+="vec4 thetaPhiPow7 =  thetaPhiPow5  * thetaPhiPow2; \n",i+="vec4 thetaPhiPow9 =  thetaPhiPow7  * thetaPhiPow2; \n",i+="sinCosThetaPhi +=  -0.16666666667   * thetaPhiPow3; \n",i+="sinCosThetaPhi +=   0.00833333333   * thetaPhiPow5; \n",i+="sinCosThetaPhi +=  -0.000198412698  * thetaPhiPow7; \n",i+="sinCosThetaPhi +=   0.0000027557319 * thetaPhiPow9; \n",i+="vertNormal.x = sinCosThetaPhi.x * sinCosThetaPhi.w; \n",i+="vertNormal.y = sinCosThetaPhi.x * sinCosThetaPhi.y; \n",i+="vertNormal.z = sinCosThetaPhi.z; \n"):(i+="vec3 vertNormal = normal;\n",t.REQUIREBBOXNOR&&(i+="vertNormal = vertNormal / bgPrecisionNorMax;\n"),t.POPGEOMETRY&&(i+="vertNormal = 2.0*vertNormal - 1.0;\n"))),t.VERTEXCOLOR&&(3==t.COLCOMPONENTS?i+="vec3 vertColor = color;":4==t.COLCOMPONENTS&&(i+="vec4 vertColor = color;"),t.REQUIREBBOXCOL&&(i+="vertColor = vertColor / bgPrecisionColMax;\n")),t.TEXTURED&&(i+="vec2 vertTexCoord = texcoord;\n",t.REQUIREBBOXTEX&&(i+="vertTexCoord = vertTexCoord / bgPrecisionTexMax;\n"));if(i+="vec3 positionMV = (modelViewMatrix * vec4(vertPosition, 1.0)).xyz;\n",t.POINTLINE2D||(i+="vec3 normalMV = normalize( (normalMatrix * vec4(vertNormal, 0.0)).xyz );\n"),i+="vec3 eye = -positionMV;\n",t.VERTEXCOLOR?(i+="vec3 rgb = vertColor.rgb;\n",4==t.COLCOMPONENTS?i+="float alpha = vertColor.a;\n":3==t.COLCOMPONENTS&&(i+="float alpha = 1.0 - transparency;\n")):(i+="vec3 rgb = diffuseColor;\n",i+="float alpha = 1.0 - transparency;\n"),t.TEXTURED&&(t.CUBEMAP?(i+="fragViewDir = viewMatrix[3].xyz;\n",i+="fragNormal = normalMV;\n"):t.SPHEREMAPPING?i+=" fragTexcoord = 0.5 + normalMV.xy / 2.0;\n":t.TEXTRAFO?i+=" fragTexcoord = (texTrafoMatrix * vec4(vertTexCoord, 1.0, 1.0)).xy;\n":(i+=" fragTexcoord = vertTexCoord;\n",t.POPGEOMETRY&&x3dom.debug.usePrecisionLevelAsTexCoord===!0&&(i+="fragTexcoord = vec2(0.03125 + 0.9375 * (PG_precisionLevel / 16.0), 1.0);"))),t.LIGHTS){if(i+="vec3 ambient   = vec3(0.0, 0.0, 0.0);\n",i+="vec3 diffuse   = vec3(0.0, 0.0, 0.0);\n",i+="vec3 specular  = vec3(0.0, 0.0, 0.0);\n",i+="float _shininess     = shininess;\n",i+="vec3 _specularColor  = specularColor;\n",i+="vec3 _emissiveColor  = emissiveColor;\n",i+="float _ambientIntensity = ambientIntensity;\n",(!t.SOLID||t.TWOSIDEDMAT)&&(i+="if (dot(normalMV, eye) < 0.0) {\n",i+="  normalMV *= -1.0;\n",t.SEPARATEBACKMAT&&(i+="    rgb = backDiffuseColor;\n",i+="    alpha = 1.0 - backTransparency;\n",i+="    _shininess = backShininess;\n",i+="    _emissiveColor = backEmissiveColor;\n",i+="    _specularColor = backSpecularColor;\n",i+="    _ambientIntensity = backAmbientIntensity;\n"),i+="  }\n"),t.LIGHTS){i+="vec3 ads;\n";for(var s=0;s<t.LIGHTS;s++){var r="light"+s+"_Color";i+="ads = lighting(light"+s+"_Type, light"+s+"_Location, light"+s+"_Direction, "+r+", light"+s+"_Attenuation, light"+s+"_Radius, light"+s+"_Intensity, light"+s+"_AmbientIntensity, light"+s+"_BeamWidth, light"+s+"_CutOffAngle, normalMV, eye, _shininess, _ambientIntensity);\n",i+="   ambient  += "+r+" * ads.r;\n   diffuse  += "+r+" * ads.g;\n   specular += "+r+" * ads.b;\n"}i+="ambient = max(ambient, 0.0);\n",i+="diffuse = max(diffuse, 0.0);\n",i+="specular = max(specular, 0.0);\n"}t.TEXTURED&&!t.BLENDING?(i+="fragAmbient = ambient;\n",i+="fragDiffuse = diffuse;\n",i+="fragColor.rgb = (_emissiveColor + specular*_specularColor);\n",i+="fragColor.a = alpha;\n"):(i+="fragColor.rgb = (_emissiveColor + max(ambient + diffuse, 0.0) * rgb + specular*_specularColor);\n",i+="fragColor.a = alpha;\n")}else t.APPMAT&&!t.VERTEXCOLOR&&(i+="rgb = vec3(0.0, 0.0, 0.0);\n"),t.TEXTURED&&!t.BLENDING?(i+="fragAmbient = vec3(0.0);\n",i+="fragDiffuse = vec3(1.0);\n",i+="fragColor.rgb = vec3(0.0);\n",i+="fragColor.a = alpha;\n"):!t.VERTEXCOLOR&&t.POINTLINE2D?(i+="fragColor.rgb = emissiveColor;\n",i+="fragColor.a = alpha;\n"):(i+="fragColor.rgb = rgb + emissiveColor;\n",i+="fragColor.a = alpha;\n");t.FOG&&(i+="float f0 = calcFog(-positionMV);\n",i+="fragColor.rgb = fogColor * (1.0-f0) + f0 * (fragColor.rgb);\n"),i+="gl_Position = modelViewProjectionMatrix * vec4(vertPosition, 1.0);\n",i+="}\n";var n=e.createShader(e.VERTEX_SHADER);return e.shaderSource(n,i),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)||x3dom.debug.logError("[DynamicMobileShader] VertexShader "+e.getShaderInfoLog(n)),n},x3dom.shader.DynamicMobileShader.prototype.generateFragmentShader=function(e,t){var i="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";i+="precision highp float;\n",i+="#else\n",i+=" precision mediump float;\n",i+="#endif\n\n",i+="varying vec4 fragColor;\n",t.TEXTURED&&(t.CUBEMAP?(i+="uniform samplerCube cubeMap;\n",i+="varying vec3 fragViewDir;\n",i+="varying vec3 fragNormal;\n",i+="uniform mat4 modelViewMatrixInverse;\n"):(i+="uniform sampler2D diffuseMap;           \n",i+="varying vec2 fragTexcoord;       \n"),t.BLENDING||(i+="varying vec3 fragAmbient;\n",i+="varying vec3 fragDiffuse;\n")),i+="void main(void) {\n",i+="vec4 color = fragColor;\n",t.TEXTURED&&(t.CUBEMAP?(i+="vec3 normal = normalize(fragNormal);\n",i+="vec3 viewDir = normalize(fragViewDir);\n",i+="vec3 reflected = reflect(viewDir, normal);\n",i+="reflected = (modelViewMatrixInverse * vec4(reflected,0.0)).xyz;\n",i+="vec4 texColor = textureCube(cubeMap, reflected);\n"):i+="vec4 texColor = texture2D(diffuseMap, vec2(fragTexcoord.s, 1.0-fragTexcoord.t));\n",t.BLENDING?t.CUBEMAP?(i+="color.rgb = mix(color.rgb, texColor.rgb, vec3(0.75));\n",i+="color.a = texColor.a;\n"):(i+="color.rgb *= texColor.rgb;\n",i+="color.a *= texColor.a;\n"):(i+="color.rgb += max(fragAmbient + fragDiffuse, 0.0) * texColor.rgb;\n",i+="color.a *= texColor.a;\n")),i+=t.TEXT?"if (color.a <= 0.5) discard;\n":"if (color.a <= 0.1) discard;\n",i+="gl_FragColor = clamp(color, 0.0, 1.0);\n",i+="}\n";var o=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(o,i),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)||x3dom.debug.logError("[DynamicMobileShader] FragmentShader "+e.getShaderInfoLog(o)),o},x3dom.shader.DynamicShaderPicking=function(e,t,i){this.program=e.createProgram();var o=this.generateVertexShader(e,t,i),s=this.generateFragmentShader(e,t,i);return e.attachShader(this.program,o),e.attachShader(this.program,s),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.DynamicShaderPicking.prototype.generateVertexShader=function(e,t,i){var o="";if(o+="uniform mat4 modelMatrix;\n",o+="uniform mat4 modelViewProjectionMatrix;\n",o+="attribute vec3 position;\n",o+="uniform vec3 from;\n",o+="varying vec3 worldCoord;\n",1==i?(o+="attribute vec3 color;\n",o+="varying vec3 fragColor;\n"):2==i&&(o+="attribute vec2 texcoord;\n",o+="varying vec3 fragColor;\n"),t.REQUIREBBOX&&(o+="uniform vec3 bgCenter;\n",o+="uniform vec3 bgSize;\n",o+="uniform float bgPrecisionMax;\n"),t.REQUIREBBOXCOL&&(o+="uniform float bgPrecisionColMax;\n"),t.REQUIREBBOXTEX&&(o+="uniform float bgPrecisionTexMax;\n"),t.VERTEXID&&(o+="uniform float shadowIDs;\n",o+=3==i?"varying vec3 idCoord;\n":"varying vec2 idCoord;\n",o+="varying float fragID;\n",o+="attribute float id;\n"),t.IMAGEGEOMETRY){o+="uniform vec3 IG_bboxMin;\n",o+="uniform vec3 IG_bboxMax;\n",o+="uniform float IG_coordTextureWidth;\n",o+="uniform float IG_coordTextureHeight;\n",o+="uniform vec2 IG_implicitMeshSize;\n";for(var s=0;s<t.IG_PRECISION;s++)o+="uniform sampler2D IG_coords"+s+"\n;";t.IG_INDEXED&&(o+="uniform sampler2D IG_index;\n",o+="uniform float IG_indexTextureWidth;\n",o+="uniform float IG_indexTextureHeight;\n")}t.POPGEOMETRY&&(o+="uniform float PG_precisionLevel;\n",o+="uniform float PG_powPrecision;\n",o+="uniform vec3 PG_maxBBSize;\n",o+="uniform vec3 PG_bbMin;\n",o+="uniform vec3 PG_bbMaxModF;\n",o+="uniform vec3 PG_bboxShiftVec;\n",o+="uniform float PG_numAnchorVertices;\n",o+="attribute float PG_vertexID;\n"),t.CLIPPLANES&&(o+="uniform mat4 modelViewMatrix;\n",o+="varying vec4 fragPosition;\n"),o+="void main(void) {\n",o+="gl_PointSize = 2.0;\n",o+="vec3 pos = position;\n",t.VERTEXID&&(0==i?(o+="idCoord = vec2((id + shadowIDs) / 256.0);\n",o+="idCoord.x = floor(idCoord.x) / 255.0;\n",o+="idCoord.y = fract(idCoord.y) * 1.00392156862745;\n",o+="fragID = id;\n"):3==i?(o+="float ID = id + shadowIDs;\n",o+="float h = floor(ID / 256.0);\n",o+="idCoord.x = ID - (h * 256.0);\n",o+="idCoord.z = floor(h / 256.0);\n",o+="idCoord.y = h - (idCoord.z * 256.0);\n",o+="idCoord = idCoord.zyx / 255.0;\n",o+="fragID = id;\n"):4==i&&(o+="idCoord = vec2((id + shadowIDs) / 256.0);\n",o+="idCoord.x = floor(idCoord.x) / 255.0;\n",o+="idCoord.y = fract(idCoord.y) * 1.00392156862745;\n",o+="fragID = id;\n")),t.IMAGEGEOMETRY?(t.IG_INDEXED?(o+="vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n",o+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n",o+="vec2 IG_indices = texture2D( IG_index, IG_texCoord ).rg;\n",o+="halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);\n",o+="IG_texCoord = (IG_indices * 0.996108948) + halfPixel;\n"):(o+="vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n",o+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n"),o+="pos = texture2D( IG_coordinateTexture, IG_texCoord ).rgb;\n",o+="pos = pos * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n"):t.POPGEOMETRY?(o+="vec3 offsetVec = step(pos / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",o+="if (PG_precisionLevel <= 2.0) {\n",o+="pos = floor(pos / PG_powPrecision) * PG_powPrecision;\n",o+="pos /= (65536.0 - PG_powPrecision);\n",o+="}\n",o+="else {\n",o+="pos /= bgPrecisionMax;\n",o+="}\n",o+="pos = (pos + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):(t.REQUIREBBOX&&(o+="pos = bgCenter + bgSize * pos / bgPrecisionMax;\n"),1!=i||t.REQUIREBBOXCOL?1==i&&t.REQUIREBBOXCOL?o+="fragColor = color / bgPrecisionColMax;\n":2!=i||t.REQUIREBBOXTEX?2==i&&t.REQUIREBBOXTEX&&(o+="vec2 texCoord = texcoord / bgPrecisionTexMax;\n",o+="fragColor = vec3(abs(texCoord.x), abs(texCoord.y), 0.0);\n"):o+="fragColor = vec3(abs(texcoord.x), abs(texcoord.y), 0.0);\n":o+="fragColor = color;\n"),t.CLIPPLANES&&(o+="fragPosition = (modelViewMatrix * vec4(pos, 1.0));\n"),o+="worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz - from;\n",o+="gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n",o+="}\n";var r=e.createShader(e.VERTEX_SHADER);return e.shaderSource(r,o),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)||(x3dom.debug.logInfo("VERTEX:\n"+o),x3dom.debug.logError("VertexShader "+e.getShaderInfoLog(r))),r},x3dom.shader.DynamicShaderPicking.prototype.generateFragmentShader=function(e,t,i){var o="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";o+=" precision highp float;\n",o+="#else\n",o+=" precision mediump float;\n",o+="#endif\n\n",o+="uniform float highBit;\n",o+="uniform float lowBit;\n",o+="uniform float sceneSize;\n",o+="varying vec3 worldCoord;\n",(1==i||2==i)&&(o+="varying vec3 fragColor;\n"),t.VERTEXID&&(o+=3==i?"varying vec3 idCoord;\n":"varying vec2 idCoord;\n",o+="varying float fragID;\n"),t.CLIPPLANES&&(o+="uniform mat4 viewMatrixInverse;\n",o+="varying vec4 fragPosition;\n"),t.MULTIVISMAP&&(o+="uniform sampler2D multiVisibilityMap;\n",o+="uniform float multiVisibilityWidth;\n",o+="uniform float multiVisibilityHeight;\n"),t.CLIPPLANES&&(o+=x3dom.shader.clipPlanes(t.CLIPPLANES)),o+="void main(void) {\n",t.CLIPPLANES&&(o+="calculateClipPlanes();\n"),o+=1==i||2==i?"vec4 color = vec4(fragColor, lowBit);\n":4==i?"vec4 color = vec4(highBit, lowBit, 0.0, 0.0);\n":"vec4 color = vec4(0.0, 0.0, highBit, lowBit);\n",t.VERTEXID&&(0==i||4==i?o+="color.ba = idCoord;\n":3==i&&(o+="color.gba = idCoord;\n"),t.MULTIVISMAP&&(o+="vec2 idTexCoord;\n",o+="float roundedID = floor(fragID+0.5);\n",o+="idTexCoord.x = (mod(roundedID, multiVisibilityWidth)) * (1.0 / multiVisibilityWidth) + (0.5 / multiVisibilityWidth);\n",o+="idTexCoord.y = (floor(roundedID / multiVisibilityHeight)) * (1.0 / multiVisibilityHeight) + (0.5 / multiVisibilityHeight);\n",o+="vec4 visibility = texture2D( multiVisibilityMap, idTexCoord );\n",o+="if (visibility.r < 1.0) discard; \n")),1!=i&&2!=i&&(o+="float d = length(worldCoord) / sceneSize;\n"),0==i?(o+="vec2 comp = fract(d * vec2(256.0, 1.0));\n",o+="color.rg = comp - (comp.rr * vec2(0.0, 1.0/256.0));\n"):3==i&&(o+="color.r = d;\n"),o+="gl_FragColor = color;\n",o+="}\n";var s=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(s,o),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)||(x3dom.debug.logInfo("FRAGMENT:\n"+o),x3dom.debug.logError("FragmentShader "+e.getShaderInfoLog(s))),s},x3dom.shader.DynamicShadowShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e,t),o=this.generateFragmentShader(e,t);return e.attachShader(this.program,i),e.attachShader(this.program,o),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.DynamicShadowShader.prototype.generateVertexShader=function(e,t){var i="";if(i+="attribute vec3 position;\n",i+="uniform mat4 modelViewProjectionMatrix;\n",i+="varying vec4 projCoords;\n",t.VERTEXID&&(i+="varying float fragID;\n",i+="attribute float id;\n"),t.REQUIREBBOX&&(i+="uniform vec3 bgCenter;\n",i+="uniform vec3 bgSize;\n",i+="uniform float bgPrecisionMax;\n"),t.IMAGEGEOMETRY){i+="uniform vec3 IG_bboxMin;\n",i+="uniform vec3 IG_bboxMax;\n",i+="uniform float IG_coordTextureWidth;\n",i+="uniform float IG_coordTextureHeight;\n",i+="uniform vec2 IG_implicitMeshSize;\n";for(var o=0;o<t.IG_PRECISION;o++)i+="uniform sampler2D IG_coords"+o+"\n;";t.IG_INDEXED&&(i+="uniform sampler2D IG_index;\n",i+="uniform float IG_indexTextureWidth;\n",i+="uniform float IG_indexTextureHeight;\n")}t.POPGEOMETRY&&(i+="uniform float PG_precisionLevel;\n",i+="uniform float PG_powPrecision;\n",i+="uniform vec3 PG_maxBBSize;\n",i+="uniform vec3 PG_bbMin;\n",i+="uniform vec3 PG_bbMaxModF;\n",i+="uniform vec3 PG_bboxShiftVec;\n",i+="uniform float PG_numAnchorVertices;\n",i+="attribute float PG_vertexID;\n"),t.CLIPPLANES&&(i+="uniform mat4 modelViewMatrix;\n",i+="varying vec4 fragPosition;\n"),i+="void main(void) {\n",i+="    vec3 pos = position;\n",t.IMAGEGEOMETRY?(t.IG_INDEXED?(i+="    vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n",i+="    vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n",i+="    vec2 IG_indices = texture2D( IG_index, IG_texCoord ).rg;\n",i+="    halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);\n",i+="    IG_texCoord = (IG_indices * 0.996108948) + halfPixel;\n"):(i+="    vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n",i+="    vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n"),i+="    pos = texture2D( IG_coordinateTexture, IG_texCoord ).rgb;\n",i+="    pos = pos * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n"):t.POPGEOMETRY?(i+="    vec3 offsetVec = step(pos / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",i+="    if (PG_precisionLevel <= 2.0) {\n",i+="        pos = floor(pos / PG_powPrecision) * PG_powPrecision;\n",i+="        pos /= (65536.0 - PG_powPrecision);\n",i+="    }\n",i+="    else {\n",i+="        pos /= bgPrecisionMax;\n",i+="    }\n",i+="    pos = (pos + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):t.REQUIREBBOX&&(i+="    pos = bgCenter + bgSize * pos / bgPrecisionMax;\n"),t.VERTEXID&&(i+="    fragID = id;\n"),t.CLIPPLANES&&(i+="    fragPosition = (modelViewMatrix * vec4(pos, 1.0));\n"),i+="    projCoords = modelViewProjectionMatrix * vec4(pos, 1.0);\n",i+="    gl_Position = projCoords;\n",i+="}\n";var s=e.createShader(e.VERTEX_SHADER);return e.shaderSource(s,i),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)||x3dom.debug.logError("[ShadowShader] VertexShader "+e.getShaderInfoLog(s)),s},x3dom.shader.DynamicShadowShader.prototype.generateFragmentShader=function(e,t){var i="";i+="#ifdef GL_FRAGMENT_PRECISION_HIGH\n",i+="    precision highp float;\n",i+="#else\n",i+="    precision mediump float;\n",i+="#endif\n\n",i+="varying vec4 projCoords;\n",i+="uniform float offset;\n",i+="uniform bool cameraView;\n",t.VERTEXID&&(i+="varying float fragID;\n"),t.MULTIVISMAP&&(i+="uniform sampler2D multiVisibilityMap;\n",i+="uniform float multiVisibilityWidth;\n",i+="uniform float multiVisibilityHeight;\n"),t.CLIPPLANES&&(i+="uniform mat4 viewMatrixInverse;\n",i+="varying vec4 fragPosition;\n",i+=x3dom.shader.clipPlanes(t.CLIPPLANES)),x3dom.caps.FP_TEXTURES||(i+=x3dom.shader.rgbaPacking()),i+="void main(void) {\n",t.CLIPPLANES&&(i+="calculateClipPlanes();\n"),t.MULTIVISMAP&&(i+="    vec2 idTexCoord;\n",i+="    float roundedID = floor(fragID+0.5);\n",i+="    idTexCoord.x = (mod(roundedID, multiVisibilityWidth)) * (1.0 / multiVisibilityWidth) + (0.5 / multiVisibilityWidth);\n",i+="    idTexCoord.y = (floor(roundedID / multiVisibilityHeight)) * (1.0 / multiVisibilityHeight) + (0.5 / multiVisibilityHeight);\n",i+="    vec4 visibility = texture2D( multiVisibilityMap, idTexCoord );\n",i+="    if (visibility.r < 1.0) discard; \n"),i+="    vec3 proj = (projCoords.xyz / projCoords.w);\n",x3dom.caps.FP_TEXTURES?(i+="    if (!cameraView){\n",i+="     proj.z = (proj.z + 1.0)*0.5;\n",i+="     proj.y = proj.z * proj.z;\n",i+="    }\n",i+="    gl_FragColor = vec4(proj, 1.0);\n"):i+="    gl_FragColor = packDepth(proj.z);\n",i+="}\n";var o=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(o,i),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)||x3dom.debug.logError("[ShadowShader] FragmentShader "+e.getShaderInfoLog(o)),o},x3dom.shader.ComposedShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e,t),o=this.generateFragmentShader(e,t);return e.attachShader(this.program,i),e.attachShader(this.program,o),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.ComposedShader.prototype.generateVertexShader=function(e,t){var i=t._cf.appearance.node._shader._vertex._vf.url[0],o=e.createShader(e.VERTEX_SHADER);return e.shaderSource(o,i),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)||x3dom.debug.logError("[ComposedShader] VertexShader "+e.getShaderInfoLog(o)),o},x3dom.shader.ComposedShader.prototype.generateFragmentShader=function(e,t){var i=t._cf.appearance.node._shader._fragment._vf.url[0],o=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(o,i),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)||x3dom.debug.logError("[ComposedShader] FragmentShader "+e.getShaderInfoLog(o)),o},x3dom.shader.NormalShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.NormalShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nattribute vec3 normal;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform float bgPrecisionNorMax;\nuniform mat4 normalMatrix;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec3 fragNormal;\nvoid main(void) {\n    vec3 pos = bgCenter + bgSize * position / bgPrecisionMax;\n    fragNormal = (normalMatrix * vec4(normal / bgPrecisionNorMax, 0.0)).xyz;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[NormalShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.NormalShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="varying vec3 fragNormal;\nvoid main(void) {\n    gl_FragColor = vec4(normalize(fragNormal) / 2.0 + 0.5, 1.0);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[NormalShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.FrontgroundTextureShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.FrontgroundTextureShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    fragTexCoord = texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[FrontgroundTextureShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.FrontgroundTextureShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec4 col = texture2D(tex, fragTexCoord);\n    gl_FragColor = vec4(col.rgb, 1.0);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[FrontgroundTextureShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BackgroundTextureShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.BackgroundTextureShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    fragTexCoord = texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);

return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundTextureShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BackgroundTextureShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    gl_FragColor = texture2D(tex, fragTexCoord);\n}";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundTextureShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BackgroundSkyTextureShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.BackgroundSkyTextureShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nattribute vec2 texcoord;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    fragTexCoord = texcoord;\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundSkyTextureShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BackgroundSkyTextureShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    gl_FragColor = texture2D(tex, fragTexCoord);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundSkyTextureShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BackgroundCubeTextureShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.BackgroundCubeTextureShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec3 fragNormal;\n\nvoid main(void) {\n    fragNormal = normalize(position);\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundCubeTextureShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BackgroundCubeTextureShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform samplerCube tex;\nvarying vec3 fragNormal;\n\nfloat magn(float val) {\n    return ((val >= 0.0) ? val : -1.0 * val);\n}\nvoid main(void) {\n    vec3 normal = -reflect(normalize(fragNormal), vec3(0.0,0.0,1.0));\n    if (magn(normal.y) >= magn(normal.x) && magn(normal.y) >= magn(normal.z))\n        normal.xz = -normal.xz;\n    gl_FragColor = textureCube(tex, normal);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundCubeTextureShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.ShadowRenderingShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e),o=this.generateFragmentShader(e,t);return e.attachShader(this.program,i),e.attachShader(this.program,o),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.ShadowRenderingShader.prototype.generateVertexShader=function(e){var t="";t+="attribute vec2 position;\n",t+="varying vec2 vPosition;\n",t+="void main(void) {\n",t+=" vPosition = position;\n",t+=" gl_Position = vec4(position, -1.0, 1.0);\n",t+="}\n";var i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[ShadowRendering] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.ShadowRenderingShader.prototype.generateFragmentShader=function(e,t){var i="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";i+="precision highp float;\n",i+="#else\n",i+=" precision mediump float;\n",i+="#endif\n\n",i+="uniform mat4 inverseViewProj;\n",i+="uniform mat4 inverseProj;\n",i+="varying vec2 vPosition;\n",i+="uniform sampler2D sceneMap;\n";for(var o=0;5>o;o++)i+="uniform float cascade"+o+"_Depth;\n";for(var s=0;s<t.length;s++){i+="uniform float light"+s+"_On;\nuniform float light"+s+"_Type;\nuniform vec3  light"+s+"_Location;\nuniform vec3  light"+s+"_Direction;\nuniform vec3  light"+s+"_Attenuation;\nuniform float light"+s+"_Radius;\nuniform float light"+s+"_BeamWidth;\nuniform float light"+s+"_CutOffAngle;\nuniform float light"+s+"_ShadowIntensity;\nuniform float light"+s+"_ShadowOffset;\nuniform mat4 light"+s+"_ViewMatrix;\n";for(var r=0;6>r;r++)i+="uniform mat4 light"+s+"_"+r+"_Matrix;\n",i+="uniform sampler2D light"+s+"_"+r+"_ShadowMap;\n";for(var r=0;5>r;r++)i+="uniform float light"+s+"_"+r+"_Split;\n"}(!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE)&&(i+=x3dom.shader.rgbaPacking()),i+=x3dom.shader.shadowRendering(),i+=x3dom.shader.gammaCorrectionDecl({}),i+="void main(void) {\n float shadowValue = 1.0;\n vec2 texCoordsSceneMap = (vPosition + 1.0)*0.5;\n vec4 projCoords = texture2D(sceneMap, texCoordsSceneMap);\n if (projCoords != vec4(1.0,1.0,1.0,0.0)){\n",(!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE)&&(i+=" projCoords.z = unpackDepth(projCoords);\n projCoords.w = 1.0;\n"),i+=" projCoords = projCoords / projCoords.w;\n projCoords.xy = vPosition;\n vec4 eyeCoords = inverseProj*projCoords;\n vec4 worldCoords = inverseViewProj*projCoords;\n float lightInfluence = 0.0;\n";for(var s=0;s<t.length;s++)i+=" lightInfluence = getLightInfluence(light"+s+"_Type, light"+s+"_ShadowIntensity, light"+s+"_On, light"+s+"_Location, light"+s+"_Direction, light"+s+"_CutOffAngle, light"+s+"_BeamWidth, light"+s+"_Attenuation, light"+s+"_Radius, eyeCoords.xyz/eyeCoords.w);\n if (lightInfluence != 0.0){\n  vec4 shadowMapValues;\n  float viewSampleDepth;\n",i+=x3dom.isa(t[s],x3dom.nodeTypes.PointLight)?"  getShadowValuesPointLight(shadowMapValues, viewSampleDepth, light"+s+"_Location, worldCoords, light"+s+"_ViewMatrix, light"+s+"_0_Matrix,light"+s+"_1_Matrix,light"+s+"_2_Matrix,light"+s+"_3_Matrix,light"+s+"_4_Matrix,light"+s+"_5_Matrix,light"+s+"_0_ShadowMap,light"+s+"_1_ShadowMap,light"+s+"_2_ShadowMap,light"+s+"_3_ShadowMap,light"+s+"_4_ShadowMap,light"+s+"_5_ShadowMap);\n":"  getShadowValuesCascaded(shadowMapValues, viewSampleDepth, worldCoords, -eyeCoords.z/eyeCoords.w,light"+s+"_0_Matrix,light"+s+"_1_Matrix,light"+s+"_2_Matrix,light"+s+"_3_Matrix,light"+s+"_4_Matrix,light"+s+"_5_Matrix,light"+s+"_0_ShadowMap,light"+s+"_1_ShadowMap,light"+s+"_2_ShadowMap,light"+s+"_3_ShadowMap,light"+s+"_4_ShadowMap,light"+s+"_5_ShadowMap, light"+s+"_0_Split, light"+s+"_1_Split, light"+s+"_2_Split, light"+s+"_3_Split, \nlight"+s+"_4_Split);\n",i+=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?" shadowValue *= clamp(ESM(shadowMapValues.z, viewSampleDepth, light"+s+"_ShadowOffset),     1.0 - light"+s+"_ShadowIntensity*lightInfluence, 1.0);\n":"  shadowValue *= clamp(VSM(shadowMapValues.zy, viewSampleDepth, light"+s+"_ShadowOffset),     1.0 - light"+s+"_ShadowIntensity*lightInfluence, 1.0);\n",i+=" }\n";i+="}\n gl_FragColor = "+x3dom.shader.encodeGamma({},"vec4(shadowValue, shadowValue, shadowValue, 1.0)")+";\n}\n";var n=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(n,i),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)||x3dom.debug.logError("[ShadowRendering] FragmentShader "+e.getShaderInfoLog(n)),n},x3dom.shader.TextureRefinementShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.TextureRefinementShader.prototype.generateVertexShader=function(e){var t="attribute vec2 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    fragTexCoord = (position.xy + 1.0) / 2.0;\n    gl_Position = vec4(position, -1.0, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[TextureRefinementShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.TextureRefinementShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n precision highp float;\n#else\n precision mediump float;\n#endif\n\n";t+="uniform sampler2D stamp;\nuniform sampler2D lastTex;\nuniform sampler2D curTex;\nuniform int mode;\nuniform vec2 repeat;\nvarying vec2 fragTexCoord;\n\nvoid init(void);\nvoid refine(void);\n\nvoid main(void) {\n    if (mode == 0) { init(); }\n    else { refine(); }\n}\n\nvoid init(void) {\n    gl_FragColor = texture2D(curTex, fragTexCoord);\n}\n\nvoid refine(void) {\n    vec3 red = texture2D(stamp, repeat * fragTexCoord).rgb;\n    vec3 v1  = texture2D(lastTex, fragTexCoord).rgb;\n    vec3 v2  = texture2D(curTex, fragTexCoord).rgb;\n    if (red.r <= 0.5) {\n        gl_FragColor = vec4(v1, 1.0);\n    }\n    else {\n        gl_FragColor = vec4(v2, 1.0);\n    }\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[TextureRefinementShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BlurShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.BlurShader.prototype.generateVertexShader=function(e){var t="";t+="attribute vec2 position;\n",t+="varying vec2 vPosition;\n",t+="void main(void) {\n",t+=" vPosition = position;\n",t+=" gl_Position = vec4(position, -1.0, 1.0);\n",t+="}\n";var i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BlurShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.BlurShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="varying vec2 vPosition;\nuniform sampler2D texture;\nuniform bool horizontal;\nuniform float pixelSizeHor;\nuniform float pixelSizeVert;\nuniform int filterSize;\n",t+=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?x3dom.shader.rgbaPacking()+"void main(void) {\n vec2 texCoords = (vPosition + 1.0)*0.5;\n vec2 offset;\n if (horizontal) offset = vec2(pixelSizeHor, 0.0);\n else offset = vec2(0.0, pixelSizeVert);\n float depth = unpackDepth(texture2D(texture, texCoords));\n if (filterSize == 3){\n  depth = depth * 0.3844;\n  depth += 0.3078*unpackDepth(texture2D(texture, texCoords-offset));\n  depth += 0.3078*unpackDepth(texture2D(texture, texCoords+offset));\n } else if (filterSize == 5){\n  depth = depth * 0.2921;\n  depth += 0.2339*unpackDepth(texture2D(texture, texCoords-offset));\n  depth += 0.2339*unpackDepth(texture2D(texture, texCoords+offset));\n  depth += 0.1201*unpackDepth(texture2D(texture, texCoords-2.0*offset));\n  depth += 0.1201*unpackDepth(texture2D(texture, texCoords+2.0*offset));\n } else if (filterSize == 7){\n  depth = depth * 0.2161;\n  depth += 0.1907*unpackDepth(texture2D(texture, texCoords-offset));\n  depth += 0.1907*unpackDepth(texture2D(texture, texCoords+offset));\n  depth += 0.1311*unpackDepth(texture2D(texture, texCoords-2.0*offset));\n  depth += 0.1311*unpackDepth(texture2D(texture, texCoords+2.0*offset));\n  depth += 0.0702*unpackDepth(texture2D(texture, texCoords-3.0*offset));\n  depth += 0.0702*unpackDepth(texture2D(texture, texCoords+3.0*offset));\n }\n gl_FragColor = packDepth(depth);\n}\n":"void main(void) {\n vec2 texCoords = (vPosition + 1.0)*0.5;\n vec2 offset;\n if (horizontal) offset = vec2(pixelSizeHor, 0.0);\n else offset = vec2(0.0, pixelSizeVert);\n vec4 color = texture2D(texture, texCoords);\n if (filterSize == 3){\n  color = color * 0.3844;\n  color += 0.3078*texture2D(texture, texCoords-offset);\n  color += 0.3078*texture2D(texture, texCoords+offset);\n } else if (filterSize == 5){\n  color = color * 0.2921;\n  color += 0.2339*texture2D(texture, texCoords-offset);\n  color += 0.2339*texture2D(texture, texCoords+offset);\n  color += 0.1201*texture2D(texture, texCoords-2.0*offset);\n  color += 0.1201*texture2D(texture, texCoords+2.0*offset);\n } else if (filterSize == 7){\n  color = color * 0.2161;\n  color += 0.1907*texture2D(texture, texCoords-offset);\n  color += 0.1907*texture2D(texture, texCoords+offset);\n  color += 0.1311*texture2D(texture, texCoords-2.0*offset);\n  color += 0.1311*texture2D(texture, texCoords+2.0*offset);\n  color += 0.0702*texture2D(texture, texCoords-3.0*offset);\n  color += 0.0702*texture2D(texture, texCoords+3.0*offset);\n }\n gl_FragColor = color;\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BlurShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.SSAOShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.SSAOShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nvarying vec2 depthTexCoord;\nvarying vec2 randomTexCoord;\nuniform vec2 randomTextureTilingFactor;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    depthTexCoord = texCoord;\n  randomTexCoord = randomTextureTilingFactor*texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[SSAOShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.SSAOShader.depthReconsructionFunctionCode=function(){var e="uniform float depthReconstructionConstantA;\nuniform float depthReconstructionConstantB;\n";return(!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE)&&(e+=x3dom.shader.rgbaPacking()),e+="float getDepth(vec2 depthTexCoord) {\n    vec4 col = texture2D(depthTexture, depthTexCoord);\n    float d;\n",e+=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?"    d = unpackDepth(col);\n":"    d = col.b;\n",e+="    return depthReconstructionConstantB/(depthReconstructionConstantA+d);\n",e+="}\n"},x3dom.shader.SSAOShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform sampler2D depthTexture;\nuniform sampler2D randomTexture;\nuniform float nearPlane;\nuniform float farPlane;\nuniform float radius;\nuniform float depthBufferEpsilon;\nuniform vec3 samples[16];\nvarying vec2 depthTexCoord;\nvarying vec2 randomTexCoord;\n",t+=x3dom.shader.SSAOShader.depthReconsructionFunctionCode(),t+="void main(void) {\n    float referenceDepth = getDepth(depthTexCoord);\n    if(referenceDepth == 1.0)\n    {\n        gl_FragColor = vec4(1.0,1.0,1.0, 1.0);\n        return;\n    }\n    int numOcclusions = 0;\n    for(int i = 0; i<16; ++i){\n        float scale  = 1.0/referenceDepth;\n        vec3 samplepos = reflect(samples[i],texture2D(randomTexture,randomTexCoord).xyz*2.0-vec3(1.0,1.0,1.0));\n        float sampleDepth = getDepth(depthTexCoord+samplepos.xy*scale*radius);\n        //if(abs(sampleDepth-referenceDepth)<=radius*(1.0/nearPlane))\n        if( sampleDepth < referenceDepth-depthBufferEpsilon) {\n            ++numOcclusions;\n        }\n    }\n    float r = 1.0-float(numOcclusions)/16.0;\n    r*=2.0;\n    gl_FragColor = vec4(r,r,r, 1.0);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[SSAOhader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.SSAOBlurShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.SSAOBlurShader.prototype.generateVertexShader=function(e){var t="attribute vec3 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    fragTexCoord = texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n",i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[SSAOShader] VertexShader "+e.getShaderInfoLog(i)),i},x3dom.shader.SSAOBlurShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform sampler2D SSAOTexture;\nuniform sampler2D depthTexture;\nuniform float nearPlane;\nuniform float farPlane;\nuniform float amount;\nuniform vec2 pixelSize;\nuniform float depthThreshold;\nvarying vec2 fragTexCoord;\n",t+=x3dom.shader.SSAOShader.depthReconsructionFunctionCode(),t+="void main(void) {\n    float sum = 0.0;\n    float numSamples = 0.0;\n    float referenceDepth = getDepth(fragTexCoord);\n    for(int i = -2; i<2;i++){\n        for(int j = -2; j<2;j++){\n            vec2 sampleTexCoord = fragTexCoord+vec2(pixelSize.x*float(i),pixelSize.y*float(j));\n            if(abs(referenceDepth - getDepth(sampleTexCoord))<depthThreshold){\n                sum+= texture2D(SSAOTexture,sampleTexCoord).r;\n                numSamples++;\n    }}}\n    float intensity = mix(1.0,sum/numSamples,amount);\n    gl_FragColor = vec4(intensity,intensity,intensity,1.0);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[SSAOhader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.SSAO={},x3dom.SSAO.isEnabled=function(e){return e.getEnvironment()._vf.SSAO},x3dom.SSAO.reinitializeShadersIfNecessary=function(e){void 0===x3dom.SSAO.shaderProgram&&(x3dom.SSAO.shaderProgram=x3dom.Utils.wrapProgram(e,new x3dom.shader.SSAOShader(e),"ssao")),void 0===x3dom.SSAO.blurShaderProgram&&(x3dom.SSAO.blurShaderProgram=x3dom.Utils.wrapProgram(e,new x3dom.shader.SSAOBlurShader(e),"ssao-blur"))},x3dom.SSAO.reinitializeRandomTextureIfNecessary=function(e,t){var i=t.getEnvironment()._vf.SSAOrandomTextureSize!=x3dom.SSAO.currentRandomTextureSize;if(void 0===x3dom.SSAO.randomTexture&&(x3dom.SSAO.randomTexture=e.createTexture()),void 0===x3dom.SSAO.randomTexture||i){e.bindTexture(e.TEXTURE_2D,x3dom.SSAO.randomTexture);for(var o=x3dom.SSAO.currentRandomTextureSize=t.getEnvironment()._vf.SSAOrandomTextureSize,s=new ArrayBuffer(o*o*4),r=new Uint8Array(s),n=0;o*o>n;++n){var a=2*Math.random()-1,d=2*Math.random()-1,l=0,h=Math.sqrt(a*a+d*d+l*l);a/=h,d/=h,r[4*n]=.5*(a+1)*255,r[4*n+1]=.5*(d+1)*255,r[4*n+2]=.5*(l+1)*255,r[4*n+3]=255}e.texImage2D(e.TEXTURE_2D,0,e.RGBA,o,o,0,e.RGBA,e.UNSIGNED_BYTE,r),e.bindTexture(e.TEXTURE_2D,null)}},x3dom.SSAO.reinitializeFBOIfNecessary=function(e,t){var i=x3dom.SSAO.currentFBOWidth!=t.width||x3dom.SSAO.currentFBOHeight!=t.height;if(void 0===x3dom.SSAO.fbo||i){x3dom.SSAO.currentFBOWidth=t.width,x3dom.SSAO.currentFBOHeight=t.height;var o=e.getParameter(e.FRAMEBUFFER_BINDING);void 0===x3dom.SSAO.fbo&&(x3dom.SSAO.fbo=e.createFramebuffer()),e.bindFramebuffer(e.FRAMEBUFFER,x3dom.SSAO.fbo),void 0===x3dom.SSAO.fbotex&&(x3dom.SSAO.fbotex=e.createTexture()),e.bindTexture(e.TEXTURE_2D,x3dom.SSAO.fbotex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,x3dom.SSAO.currentFBOWidth,x3dom.SSAO.currentFBOHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindTexture(e.TEXTURE_2D,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,x3dom.SSAO.fbotex,0),e.bindFramebuffer(e.FRAMEBUFFER,o)}},x3dom.SSAO.render=function(e,t,i,o,s,r){var n=t.getParameter(t.FRAMEBUFFER_BINDING);null!=r&&t.bindFramebuffer(t.FRAMEBUFFER,r),e.frontFace(t.CCW),e.disable(t.CULL_FACE),e.disable(t.DEPTH_TEST);var a=x3dom.SSAO.shaderProgram;e.useProgram(a),a.depthTexture=0,a.randomTexture=1,a.radius=i.getEnvironment()._vf.SSAOradius,a.randomTextureTilingFactor=[s.width/x3dom.SSAO.currentRandomTextureSize,s.height/x3dom.SSAO.currentRandomTextureSize];var d=i.getViewpoint(),l=d.getNear(),h=d.getFar();a.nearPlane=l,a.farPlane=h,a.depthReconstructionConstantA=(h+l)/(l-h),a.depthReconstructionConstantB=2*h*l/(l-h),a.depthBufferEpsilon=1e-4*(h-l),a.samples=[.03800223814729654,.10441029119843426,-.04479934806797181,-.03800223814729654,-.10441029119843426,.04479934806797181,-.17023209847088397,.1428416910414532,.6154407640895228,.17023209847088397,-.1428416910414532,-.6154407640895228,-.288675134594813,-.16666666666666646,-.3774214123135722,.288675134594813,.16666666666666646,.3774214123135722,.07717696785196887,-.43769233467209245,-.5201284112706428,-.07717696785196887,.43769233467209245,.5201284112706428,.5471154183401156,-.09647120981496134,-.15886420745887797,-.5471154183401156,.09647120981496134,.15886420745887797,.3333333333333342,.5773502691896253,-.8012446019636266,-.3333333333333342,-.5773502691896253,.8012446019636266,-.49994591864508653,.5958123446480936,-.15385106176844343,.49994591864508653,-.5958123446480936,.15385106176844343,-.8352823295874743,-.3040179051783715,.7825440557226517,.8352823295874743,.3040179051783715,-.7825440557226517],a.tex||(a.tex=0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,x3dom.SSAO.randomTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i._fgnd._webgl.buffers[0]),t.bindBuffer(t.ARRAY_BUFFER,i._fgnd._webgl.buffers[1]),t.vertexAttribPointer(a.position,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(a.position),t.drawElements(i._fgnd._webgl.primType,i._fgnd._webgl.indexes.length,t.UNSIGNED_SHORT,0),t.disableVertexAttribArray(a.position),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),null!=r&&t.bindFramebuffer(t.FRAMEBUFFER,n)},x3dom.SSAO.blur=function(e,t,i,o,s,r,n){var a=t.getParameter(t.FRAMEBUFFER_BINDING);null!=n&&t.bindFramebuffer(t.FRAMEBUFFER,n),e.frontFace(t.CCW),e.disable(t.CULL_FACE),e.disable(t.DEPTH_TEST);var d=x3dom.SSAO.blurShaderProgram;e.useProgram(d),d.SSAOTexture=0,d.depthTexture=1,d.depthThreshold=i.getEnvironment()._vf.SSAOblurDepthTreshold;var l=i.getViewpoint(),h=l.getNear(),u=l.getFar();d.nearPlane=h,d.farPlane=u,d.depthReconstructionConstantA=(u+h)/(h-u),d.depthReconstructionConstantB=2*u*h/(h-u),d.pixelSize=[1/r.width,1/r.height],d.amount=i.getEnvironment()._vf.SSAOamount,t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i._fgnd._webgl.buffers[0]),t.bindBuffer(t.ARRAY_BUFFER,i._fgnd._webgl.buffers[1]),t.vertexAttribPointer(d.position,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(d.position),t.drawElements(i._fgnd._webgl.primType,i._fgnd._webgl.indexes.length,t.UNSIGNED_SHORT,0),t.disableVertexAttribArray(d.position),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),null!=n&&t.bindFramebuffer(t.FRAMEBUFFER,a)},x3dom.SSAO.renderSSAO=function(e,t,i,o){this.reinitializeShadersIfNecessary(t),this.reinitializeRandomTextureIfNecessary(t,i),this.reinitializeFBOIfNecessary(t,o),e.viewport(0,0,o.width,o.height),this.render(e,t,i,i._webgl.fboScene.tex,o,x3dom.SSAO.fbo),t.enable(t.BLEND),t.blendFunc(t.DST_COLOR,t.ONE_MINUS_SRC_ALPHA),this.blur(e,t,i,x3dom.SSAO.fbotex,i._webgl.fboScene.tex,o,null),t.disable(t.BLEND)},x3dom.gfx_webgl=function(){function e(e,t,i,o){this.ctx3d=e,this.canvas=t,this.name=i,this.x3dElem=o,this.IG_PositionBuffer=null,this.cache=new x3dom.Cache,this.stateManager=new x3dom.StateManager(e)}function t(t,i,o,s,r){var n=["webgl","experimental-webgl","moz-webgl","webkit-3d"];s&&(n=["experimental-webgl2"].concat(n));for(var a=null,d=r.getElementsByTagName("Environment"),l=d&&d[0]&&d[0].hasAttribute("SSAO")&&"true"===d[0].getAttribute("SSAO").toLowerCase()?!0:!1,h={alpha:!0,depth:!0,stencil:!0,antialias:!l,premultipliedAlpha:!1,preserveDrawingBuffer:!0,failIfMajorPerformanceCaveat:!0},u=0;u<n.length;u++)try{if(a=t.getContext(n[u],h),a||(x3dom.caps.RENDERMODE="SOFTWARE",h.failIfMajorPerformanceCaveat=!1,a=t.getContext(n[u],h)),a){var f=new e(a,t,"webgl",r);try{x3dom.caps.VENDOR=a.getParameter(a.VENDOR),x3dom.caps.VERSION=a.getParameter(a.VERSION),x3dom.caps.RENDERER=a.getParameter(a.RENDERER),x3dom.caps.SHADING_LANGUAGE_VERSION=a.getParameter(a.SHADING_LANGUAGE_VERSION),x3dom.caps.RED_BITS=a.getParameter(a.RED_BITS),x3dom.caps.GREEN_BITS=a.getParameter(a.GREEN_BITS),x3dom.caps.BLUE_BITS=a.getParameter(a.BLUE_BITS),x3dom.caps.ALPHA_BITS=a.getParameter(a.ALPHA_BITS),x3dom.caps.DEPTH_BITS=a.getParameter(a.DEPTH_BITS),x3dom.caps.MAX_VERTEX_ATTRIBS=a.getParameter(a.MAX_VERTEX_ATTRIBS),x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS=a.getParameter(a.MAX_VERTEX_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_VARYING_VECTORS=a.getParameter(a.MAX_VARYING_VECTORS),x3dom.caps.MAX_VERTEX_UNIFORM_VECTORS=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS),x3dom.caps.MAX_COMBINED_TEXTURE_IMAGE_UNITS=a.getParameter(a.MAX_COMBINED_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_TEXTURE_SIZE=a.getParameter(a.MAX_TEXTURE_SIZE),x3dom.caps.MAX_TEXTURE_IMAGE_UNITS=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_CUBE_MAP_TEXTURE_SIZE=a.getParameter(a.MAX_CUBE_MAP_TEXTURE_SIZE),x3dom.caps.COMPRESSED_TEXTURE_FORMATS=a.getParameter(a.COMPRESSED_TEXTURE_FORMATS),x3dom.caps.MAX_RENDERBUFFER_SIZE=a.getParameter(a.MAX_RENDERBUFFER_SIZE),x3dom.caps.MAX_VIEWPORT_DIMS=a.getParameter(a.MAX_VIEWPORT_DIMS),x3dom.caps.ALIASED_LINE_WIDTH_RANGE=a.getParameter(a.ALIASED_LINE_WIDTH_RANGE),x3dom.caps.ALIASED_POINT_SIZE_RANGE=a.getParameter(a.ALIASED_POINT_SIZE_RANGE),x3dom.caps.SAMPLES=a.getParameter(a.SAMPLES),x3dom.caps.INDEX_UINT=a.getExtension("OES_element_index_uint"),x3dom.caps.FP_TEXTURES=a.getExtension("OES_texture_float"),x3dom.caps.FPL_TEXTURES=a.getExtension("OES_texture_float_linear"),x3dom.caps.STD_DERIVATIVES=a.getExtension("OES_standard_derivatives"),x3dom.caps.DRAW_BUFFERS=a.getExtension("WEBGL_draw_buffers"),x3dom.caps.DEBUGRENDERINFO=a.getExtension("WEBGL_debug_renderer_info"),x3dom.caps.DEPTH_TEXTURE=a.getExtension("WEBGL_depth_texture"),x3dom.caps.EXTENSIONS=a.getSupportedExtensions(),x3dom.caps.DEBUGRENDERINFO?(x3dom.caps.UNMASKED_RENDERER_WEBGL=a.getParameter(x3dom.caps.DEBUGRENDERINFO.UNMASKED_RENDERER_WEBGL),x3dom.caps.UNMASKED_VENDOR_WEBGL=a.getParameter(x3dom.caps.DEBUGRENDERINFO.UNMASKED_VENDOR_WEBGL)):(x3dom.caps.UNMASKED_RENDERER_WEBGL="",x3dom.caps.UNMASKED_VENDOR_WEBGL="");var _=x3dom.caps.EXTENSIONS.toString().replace(/,/g,", ");x3dom.debug.logInfo(n[u]+" context found\nVendor: "+x3dom.caps.VENDOR+" "+x3dom.caps.UNMASKED_VENDOR_WEBGL+", Renderer: "+x3dom.caps.RENDERER+" "+x3dom.caps.UNMASKED_RENDERER_WEBGL+", Version: "+x3dom.caps.VERSION+", ShadingLangV.: "+x3dom.caps.SHADING_LANGUAGE_VERSION+", MSAA samples: "+x3dom.caps.SAMPLES+"\nExtensions: "+_),x3dom.caps.INDEX_UINT&&(x3dom.Utils.maxIndexableCoords=4294967295),x3dom.caps.MOBILE=function(e){return/android.+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|e\-|e\/|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(di|rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|xda(\-|2|g)|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))}(navigator.userAgent||navigator.vendor||window.opera),(x3dom.caps.RENDERER.indexOf("PowerVR")>=0||navigator.appVersion.indexOf("Mobile")>-1||x3dom.caps.MAX_VARYING_VECTORS<=8||x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS<2)&&(x3dom.caps.MOBILE=!0),x3dom.caps.MOBILE?i?(x3dom.caps.MOBILE=!1,x3dom.debug.logWarning("Detected mobile graphics card! But being forced to desktop shaders which might not work!")):x3dom.debug.logWarning("Detected mobile graphics card! Using low quality shaders without ImageGeometry support!"):o&&(x3dom.caps.MOBILE=!0,x3dom.debug.logWarning("Detected desktop graphics card! But being forced to mobile shaders with lower quality!"))}catch(c){x3dom.debug.logWarning("Your browser probably supports an older WebGL version. Please try the old mobile runtime instead:\nhttp://www.x3dom.org/x3dom/src_mobile/x3dom.js"),
f=null}return f}}catch(m){x3dom.debug.logWarning(m)}return null}return e.prototype.getName=function(){return this.name},e.prototype.setupShape=function(e,t,i){var o,s,r,n,a,d,l,h,u,f,_=0,c=t.shape,m=c._cf.geometry.node;if(void 0!==c._webgl){var p=!1;if(c._dirty.colors===!0&&void 0===c._webgl.shader.color&&m._mesh._colors[0].length&&(p=!0),p&&c._cleanupGLObjects&&c._cleanupGLObjects(!0,!1),c._dirty.texture===!0){if(c._webgl.texture.length!=c.getTextures().length){for(r=0;r<c._webgl.texture.length;++r)c._webgl.texture.pop();for(s=c.getTextures(),r=0;r<s.length;++r)c._webgl.texture.push(new x3dom.Texture(e,c._nameSpace.doc,this.cache,s[r]));c._dirty.shader=!0,void 0===c._webgl.shader.texcoord&&(c._dirty.texcoords=!0)}else for(s=c.getTextures(),r=0;r<s.length;++r)s[r]===c._webgl.texture[r].node?c._webgl.texture[r].update():(c._webgl.texture[r].texture=null,c._webgl.texture[r].node=s[r],c._webgl.texture[r].update());c._dirty.texture=!1}if(c._webgl.shader=this.cache.getShaderByProperties(e,c,c.getShaderProperties(i)),!p&&0==c._webgl.binaryGeometry)for(_=0;_<c._webgl.positions.length;_++)if(o=6*_,(1==c._dirty.positions||1==c._dirty.indexes)&&(void 0!==c._webgl.shader.position&&(c._webgl.indexes[_]=m._mesh._indices[_],e.deleteBuffer(c._webgl.buffers[o]),u=e.createBuffer(),c._webgl.buffers[o]=u,x3dom.caps.INDEX_UINT&&m._mesh._positions[0].length/3>65535?(f=new Uint32Array(c._webgl.indexes[_]),c._webgl.indexType=e.UNSIGNED_INT):(f=new Uint16Array(c._webgl.indexes[_]),c._webgl.indexType=e.UNSIGNED_SHORT),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,u),e.bufferData(e.ELEMENT_ARRAY_BUFFER,f,e.STATIC_DRAW),f=null,c._webgl.positions[_]=m._mesh._positions[_],e.deleteBuffer(c._webgl.buffers[o+1]),a=e.createBuffer(),c._webgl.buffers[o+1]=a,e.bindBuffer(e.ARRAY_BUFFER,a),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,c._webgl.buffers[o]),n=new Float32Array(c._webgl.positions[_]),e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,a),e.vertexAttribPointer(c._webgl.shader.position,m._mesh._numPosComponents,c._webgl.coordType,!1,c._coordStrideOffset[0],c._coordStrideOffset[1]),n=null),c._dirty.positions=!1,c._dirty.indexes=!1),1==c._dirty.colors&&(void 0!==c._webgl.shader.color&&(c._webgl.colors[_]=m._mesh._colors[_],e.deleteBuffer(c._webgl.buffers[o+4]),h=e.createBuffer(),c._webgl.buffers[o+4]=h,A=new Float32Array(c._webgl.colors[_]),e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,A,e.STATIC_DRAW),e.vertexAttribPointer(c._webgl.shader.color,m._mesh._numColComponents,c._webgl.colorType,!1,c._colorStrideOffset[0],c._colorStrideOffset[1]),A=null),c._dirty.colors=!1),1==c._dirty.normals&&(void 0!==c._webgl.shader.normal&&(c._webgl.normals[_]=m._mesh._normals[_],e.deleteBuffer(c._webgl.buffers[o+2]),l=e.createBuffer(),c._webgl.buffers[o+2]=l,F=new Float32Array(c._webgl.normals[_]),e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,F,e.STATIC_DRAW),e.vertexAttribPointer(c._webgl.shader.normal,m._mesh._numNormComponents,c._webgl.normalType,!1,c._normalStrideOffset[0],c._normalStrideOffset[1]),F=null),c._dirty.normals=!1),1==c._dirty.texcoords&&(void 0!==c._webgl.shader.texcoord&&(c._webgl.texcoords[_]=m._mesh._texCoords[_],e.deleteBuffer(c._webgl.buffers[o+3]),d=e.createBuffer(),c._webgl.buffers[o+3]=d,w=new Float32Array(c._webgl.texcoords[_]),e.bindBuffer(e.ARRAY_BUFFER,d),e.bufferData(e.ARRAY_BUFFER,w,e.STATIC_DRAW),e.vertexAttribPointer(c._webgl.shader.texCoord,m._mesh._numTexComponents,c._webgl.texCoordType,!1,c._texCoordStrideOffset[0],c._texCoordStrideOffset[1]),w=null),c._dirty.texcoords=!1),1==c._dirty.specialAttribs){if(void 0!==c._webgl.shader.particleSize){var x=m._vf.size.toGL();x.length&&(e.deleteBuffer(c._webgl.buffers[o+5]),c._webgl.buffers[o+5]=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,c._webgl.buffers[o+5]),e.bufferData(e.ARRAY_BUFFER,new Float32Array(x),e.STATIC_DRAW))}var g,v,y=m._mesh._dynamicFields;for(v in y)if(g=y[v],void 0!==g&&g.value.length){var b=new Float32Array(g.value),T=c._webgl.dynamicFields.find(function(e){return e.name==v});if(!T)continue;"[object WebGLBuffer]"==T.buf.toString()&&e.deleteBuffer(T.buf),e.deleteBuffer(T.buf),T.buf=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,T.buf),e.bufferData(e.ARRAY_BUFFER,b,e.STATIC_DRAW),b=null}c._dirty.specialAttribs=!1}if(0!=c._webgl.imageGeometry){for(r=0;r<c._webgl.texture.length;++r)c._webgl.texture[r].updateTexture();m.unsetGeoDirty(),c.unsetGeoDirty()}if(!p)return}else if(!(x3dom.isa(m,x3dom.nodeTypes.Text)||x3dom.isa(m,x3dom.nodeTypes.BinaryGeometry)||x3dom.isa(m,x3dom.nodeTypes.PopGeometry)||x3dom.isa(m,x3dom.nodeTypes.ExternalGeometry))&&(!m||m._mesh._positions[0].length<1))return void x3dom.debug.logError(x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS<2&&x3dom.isa(m,x3dom.nodeTypes.ImageGeometry)?"Can't render ImageGeometry nodes with only "+x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS+" vertex texture units. Please upgrade your GPU!":"NO VALID MESH OR NO VERTEX POSITIONS SET!");for(c.unsetDirty(),c._cleanupGLObjects||(c._cleanupGLObjects=function(t,i){if(this._webgl&&(arguments.length>0&&t||0==this._parentNodes.length)){for(var o=this._webgl.shader,s=0;s<this._webgl.positions.length;s++){var r=6*s;void 0!==o.position&&(e.deleteBuffer(this._webgl.buffers[r+1]),e.deleteBuffer(this._webgl.buffers[r])),void 0!==o.normal&&e.deleteBuffer(this._webgl.buffers[r+2]),void 0!==o.texcoord&&e.deleteBuffer(this._webgl.buffers[r+3]),void 0!==o.color&&e.deleteBuffer(this._webgl.buffers[r+4]),void 0!==o.id&&e.deleteBuffer(this._webgl.buffers[r+5])}for(var n=0;n<this._webgl.dynamicFields.length;n++){var a=this._webgl.dynamicFields[n];void 0!==o[a.name]&&e.deleteBuffer(a.buf)}void 0===i&&(i=!0),i&&(delete this._webgl,x3dom.BinaryContainerLoader.outOfMemory=!1)}}),c._webgl={positions:m._mesh._positions,normals:m._mesh._normals,texcoords:m._mesh._texCoords,colors:m._mesh._colors,indexes:m._mesh._indices,indexType:e.UNSIGNED_SHORT,coordType:e.FLOAT,normalType:e.FLOAT,texCoordType:e.FLOAT,colorType:e.FLOAT,texture:[],dirtyLighting:x3dom.Utils.checkDirtyLighting(i),imageGeometry:0,binaryGeometry:0,popGeometry:0,externalGeometry:0},s=c.getTextures(),r=0;r<s.length;++r)c._webgl.texture.push(new x3dom.Texture(e,c._nameSpace.doc,this.cache,s[r]));c._webgl.shader=this.cache.getShaderByProperties(e,c,c.getShaderProperties(i));var S=c._webgl.shader,M=0;if(c._webgl.buffers=[],c._webgl.dynamicFields=[],x3dom.isa(m,x3dom.nodeTypes.X3DBinaryContainerGeometryNode)){c._webgl.primType=[];for(var C=0;C<m._vf.primType.length;++C)c._webgl.primType.push(x3dom.Utils.primTypeDic(e,m._vf.primType[C]))}else c._webgl.primType=x3dom.Utils.primTypeDic(e,m._mesh._primType);if(x3dom.isa(m,x3dom.nodeTypes.ExternalGeometry))m.updateRenderData(c,S,e,i,this);else if(x3dom.isa(m,x3dom.nodeTypes.BinaryGeometry))x3dom.BinaryContainerLoader.setupBinGeo(c,S,e,i,this);else if(x3dom.isa(m,x3dom.nodeTypes.PopGeometry))x3dom.BinaryContainerLoader.setupPopGeo(c,S,e,i,this);else if(x3dom.isa(m,x3dom.nodeTypes.ImageGeometry))x3dom.BinaryContainerLoader.setupImgGeo(c,S,e,i,this);else{for(_=0;_<c._webgl.positions.length;_++){if(o=6*_,void 0!==S.position&&(u=e.createBuffer(),c._webgl.buffers[o]=u,x3dom.caps.INDEX_UINT&&c._webgl.positions[0].length/3>65535?(f=new Uint32Array(c._webgl.indexes[_]),c._webgl.indexType=e.UNSIGNED_INT):(f=new Uint16Array(c._webgl.indexes[_]),c._webgl.indexType=e.UNSIGNED_SHORT),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,u),e.bufferData(e.ELEMENT_ARRAY_BUFFER,f,e.STATIC_DRAW),f=null,a=e.createBuffer(),c._webgl.buffers[o+1]=a,e.bindBuffer(e.ARRAY_BUFFER,a),n=new Float32Array(c._webgl.positions[_]),e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,a),e.vertexAttribPointer(S.position,m._mesh._numPosComponents,c._webgl.coordType,!1,c._coordStrideOffset[0],c._coordStrideOffset[1]),e.enableVertexAttribArray(S.position),n=null),void 0!==S.normal||c._webgl.normals[_]){l=e.createBuffer(),c._webgl.buffers[o+2]=l;var F=new Float32Array(c._webgl.normals[_]);e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,F,e.STATIC_DRAW),e.vertexAttribPointer(S.normal,m._mesh._numNormComponents,c._webgl.normalType,!1,c._normalStrideOffset[0],c._normalStrideOffset[1]),e.enableVertexAttribArray(S.normal),F=null}if(void 0!==S.texcoord){var E=e.createBuffer();c._webgl.buffers[o+3]=E;var w=new Float32Array(c._webgl.texcoords[_]);e.bindBuffer(e.ARRAY_BUFFER,E),e.bufferData(e.ARRAY_BUFFER,w,e.STATIC_DRAW),e.vertexAttribPointer(S.texcoord,m._mesh._numTexComponents,c._webgl.texCoordType,!1,c._texCoordStrideOffset[0],c._texCoordStrideOffset[1]),e.enableVertexAttribArray(S.texcoord),w=null}if(void 0!==S.color){h=e.createBuffer(),c._webgl.buffers[o+4]=h;var A=new Float32Array(c._webgl.colors[_]);e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,A,e.STATIC_DRAW),e.vertexAttribPointer(S.color,m._mesh._numColComponents,c._webgl.colorType,!1,c._colorStrideOffset[0],c._colorStrideOffset[1]),e.enableVertexAttribArray(S.color),A=null}if(void 0!==S.particleSize){var R=m._vf.size.toGL();if(R.length){var N=e.createBuffer();c._webgl.buffers[o+5]=N,e.bindBuffer(e.ARRAY_BUFFER,N),e.bufferData(e.ARRAY_BUFFER,new Float32Array(R),e.STATIC_DRAW)}}}for(var I in m._mesh._dynamicFields)if(m._mesh._dynamicFields.hasOwnProperty(I)){var P=m._mesh._dynamicFields[I];if(c._webgl.dynamicFields[M]={buf:{},name:I,numComponents:P.numComponents},void 0!==S[I]){var D=e.createBuffer();c._webgl.dynamicFields[M++].buf=D;var b=new Float32Array(P.value);e.bindBuffer(e.ARRAY_BUFFER,D),e.bufferData(e.ARRAY_BUFFER,b,e.STATIC_DRAW),e.vertexAttribPointer(S[I],P.numComponents,e.FLOAT,!1,0,0),b=null}}}},e.prototype.setupScene=function(e,t){var i=null,o=null,s=this;if(void 0!==t._webgl){if(!t._dirty)return;void 0!==t._webgl.texture&&t._webgl.texture&&e.deleteTexture(t._webgl.texture),t._cleanupGLObjects&&t._cleanupGLObjects(),t._webgl={}}t._dirty=!1;var r=t.getTexUrl(),n=0,a=1,d=1;if(r.length>0&&r[0].length>0)r.length>=6&&r[1].length>0&&r[2].length>0&&r[3].length>0&&r[4].length>0&&r[5].length>0?(i=new x3dom.nodeTypes.Sphere,t._webgl={positions:i._mesh._positions[0],indexes:i._mesh._indices[0],buffers:[{},{}]},t._webgl.primType=e.TRIANGLES,t._webgl.shader=this.cache.getShader(e,x3dom.shader.BACKGROUND_CUBETEXTURE),t._webgl.texture=x3dom.Utils.createTextureCube(e,t._nameSpace.doc,r,!0,t._vf.crossOrigin,!0,!1)):(t._webgl={positions:[-a,-d,0,-a,d,0,a,-d,0,a,d,0],indexes:[0,1,2,3],buffers:[{},{}]},r=t._nameSpace.getURL(r[0]),t._webgl.texture=x3dom.Utils.createTexture2D(e,t._nameSpace.doc,r,!0,t._vf.crossOrigin,!0,!1),t._webgl.primType=e.TRIANGLE_STRIP,t._webgl.shader=this.cache.getShader(e,x3dom.shader.BACKGROUND_TEXTURE));else if(t.getSkyColor().length>1||t.getGroundColor().length){i=new x3dom.nodeTypes.Sphere,o=e.createTexture(),t._webgl={positions:i._mesh._positions[0],texcoords:i._mesh._texCoords[0],indexes:i._mesh._indices[0],buffers:[{},{},{}],texture:o,primType:e.TRIANGLES};var l=x3dom.Utils.nextHighestPowerOfTwo(t.getSkyColor().length+t.getGroundColor().length+2);l=512>l?512:l;var h=t._vf.groundAngle.length,u=[],f=[],_=[],c=[0];for(n=0;n<t._vf.skyColor.length;n++)_[n]=t._vf.skyColor[n];for(n=0;n<t._vf.skyAngle.length;n++)c[n+1]=t._vf.skyAngle[n];if(h>0||1==t._vf.groundColor.length){for(c[c.length-1]<Math.PI/2&&(c[c.length]=Math.PI/2-x3dom.fields.Eps,_[_.length]=_[_.length-1]),n=h-1;n>=0;n--)n==h-1&&Math.PI-t._vf.groundAngle[n]<=Math.PI/2&&(c[c.length]=Math.PI/2,_[_.length]=t._vf.groundColor[t._vf.groundColor.length-1]),c[c.length]=Math.PI-t._vf.groundAngle[n],_[_.length]=t._vf.groundColor[n+1];0==h&&1==t._vf.groundColor.length&&(c[c.length]=Math.PI/2,_[_.length]=t._vf.groundColor[0]),c[c.length]=Math.PI,_[_.length]=t._vf.groundColor[0]}else c[c.length-1]<Math.PI&&(c[c.length]=Math.PI,_[_.length]=_[_.length-1]);for(n=0;n<c.length;n++)c[n]/=Math.PI;if(c.length!=_.length){x3dom.debug.logError("Number of background colors and corresponding angles are different!");var m=c.length<_.length?c.length:_.length;c.length=m,_.length=m}var p=new x3dom.nodeTypes.ColorInterpolator;for(p._vf.key=new x3dom.fields.MFFloat(c),p._vf.keyValue=new x3dom.fields.MFColor(_),n=0;l>n;n++)p._vf.set_fraction=n/(l-1),p.fieldChanged("set_fraction"),u[n]=p._vf.value_changed;u.reverse();var x=Math.floor(255*(1-t.getTransparency()));for(n=0;n<u.length;n++)f.push(Math.floor(255*u[n].r),Math.floor(255*u[n].g),Math.floor(255*u[n].b),x);var g=new Uint8Array(f),v=e.RGBA;l=g.length/4,e.bindTexture(e.TEXTURE_2D,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.texImage2D(e.TEXTURE_2D,0,v,1,l,0,v,e.UNSIGNED_BYTE,g),e.bindTexture(e.TEXTURE_2D,null),t._webgl.shader=this.cache.getShader(e,x3dom.shader.BACKGROUND_SKYTEXTURE)}else t._webgl={};if(t._webgl.shader){var y=t._webgl.shader,b=e.createBuffer();t._webgl.buffers[1]=b,e.bindBuffer(e.ARRAY_BUFFER,b);var T=new Float32Array(t._webgl.positions);e.bufferData(e.ARRAY_BUFFER,T,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,b),e.vertexAttribPointer(y.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(y.position);var S=e.createBuffer();t._webgl.buffers[0]=S;var M=new Uint16Array(t._webgl.indexes);if(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,S),e.bufferData(e.ELEMENT_ARRAY_BUFFER,M,e.STATIC_DRAW),T=null,M=null,void 0!==y.texcoord){var C=e.createBuffer();t._webgl.buffers[2]=C;var F=new Float32Array(t._webgl.texcoords);e.bindBuffer(e.ARRAY_BUFFER,C),e.bufferData(e.ARRAY_BUFFER,F,e.STATIC_DRAW),e.vertexAttribPointer(y.texcoord,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(y.texcoord),F=null}t._cleanupGLObjects=function(){var t=this._webgl.shader;void 0!==t.position&&(e.deleteBuffer(this._webgl.buffers[0]),e.deleteBuffer(this._webgl.buffers[1])),void 0!==t.texcoord&&e.deleteBuffer(this._webgl.buffers[2])}}t._webgl.render=function(e,i,o){var r=t._webgl.shader,n=1-t.getTransparency(),a=null,d=o._22,l=o._23,h=i.e3();if(void 0!==r&&null!==r&&void 0!==r.texcoord&&null!==r.texcoord&&void 0!==t._webgl.texture&&null!==t._webgl.texture)e.clearColor(0,0,0,n),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),s.stateManager.frontFace(e.CCW),s.stateManager.disable(e.CULL_FACE),s.stateManager.disable(e.DEPTH_TEST),s.stateManager.disable(e.BLEND),s.stateManager.useProgram(r),r.tex||(r.tex=0),o._22=100001/99999,o._23=2e5/99999,i._03=0,i._13=0,i._23=0,a=o.mult(i),r.modelViewProjectionMatrix=a.toGL(),i._03=h.x,i._13=h.y,i._23=h.z,o._22=d,o._23=l,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t._webgl.buffers[0]),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[1]),e.vertexAttribPointer(r.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(r.position),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[2]),e.vertexAttribPointer(r.texcoord,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(r.texcoord),e.drawElements(t._webgl.primType,t._webgl.indexes.length,e.UNSIGNED_SHORT,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(r.position),e.disableVertexAttribArray(r.texcoord),e.clear(e.DEPTH_BUFFER_BIT);else if(!r||!t._webgl.texture||void 0!==t._webgl.texture.textureCubeReady&&t._webgl.texture.textureCubeReady!==!0){var u=t.getSkyColor().toGL();e.clearColor(u[0],u[1],u[2],n),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}else e.clearColor(0,0,0,n),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),s.stateManager.frontFace(e.CCW),s.stateManager.disable(e.CULL_FACE),s.stateManager.disable(e.DEPTH_TEST),s.stateManager.disable(e.BLEND),s.stateManager.useProgram(r),r.tex||(r.tex=0),t._webgl.texture.textureCubeReady?(o._22=100001/99999,o._23=2e5/99999,i._03=0,i._13=0,i._23=0,a=o.mult(i),r.modelViewProjectionMatrix=a.toGL(),i._03=h.x,i._13=h.y,i._23=h.z,o._22=d,o._23=l,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_CUBE_MAP,t._webgl.texture),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)):(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t._webgl.buffers[0]),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[1]),e.vertexAttribPointer(r.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(r.position),e.drawElements(t._webgl.primType,t._webgl.indexes.length,e.UNSIGNED_SHORT,0),e.disableVertexAttribArray(r.position),e.activeTexture(e.TEXTURE0),t._webgl.texture.textureCubeReady?e.bindTexture(e.TEXTURE_CUBE_MAP,null):e.bindTexture(e.TEXTURE_2D,null),e.clear(e.DEPTH_BUFFER_BIT)}},e.prototype.setupFgnds=function(e,t){if(void 0===t._fgnd){var i=this,o=1,s=1;t._fgnd={},t._fgnd._webgl={positions:[-o,-s,0,-o,s,0,o,-s,0,o,s,0],indexes:[0,1,2,3],buffers:[{},{}]},t._fgnd._webgl.primType=e.TRIANGLE_STRIP,t._fgnd._webgl.shader=this.cache.getShader(e,x3dom.shader.FRONTGROUND_TEXTURE);var r=t._fgnd._webgl.shader,n=e.createBuffer();t._fgnd._webgl.buffers[1]=n,e.bindBuffer(e.ARRAY_BUFFER,n);var a=new Float32Array(t._fgnd._webgl.positions);e.bufferData(e.ARRAY_BUFFER,a,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,n),e.vertexAttribPointer(r.position,3,e.FLOAT,!1,0,0);var d=e.createBuffer();t._fgnd._webgl.buffers[0]=d;var l=new Uint16Array(t._fgnd._webgl.indexes);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,d),e.bufferData(e.ELEMENT_ARRAY_BUFFER,l,e.STATIC_DRAW),a=null,l=null,t._fgnd._webgl.render=function(e,o){t._fgnd._webgl.texture=o,i.stateManager.frontFace(e.CCW),i.stateManager.disable(e.CULL_FACE),i.stateManager.disable(e.DEPTH_TEST),i.stateManager.useProgram(r),r.tex||(r.tex=0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t._fgnd._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t._fgnd._webgl.buffers[0]),e.bindBuffer(e.ARRAY_BUFFER,t._fgnd._webgl.buffers[1]),e.vertexAttribPointer(r.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(r.position),e.drawElements(t._fgnd._webgl.primType,t._fgnd._webgl.indexes.length,e.UNSIGNED_SHORT,0),e.disableVertexAttribArray(r.position),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null)}}},e.prototype.renderShadowPass=function(e,t,i,o,s,r,n){var a=t._scene,d=!1;this.stateManager.bindFramebuffer(e.FRAMEBUFFER,s.fbo),this.stateManager.viewport(0,0,s.width,s.height),e.clearColor(1,1,1,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.stateManager.depthFunc(e.LEQUAL),this.stateManager.enable(e.DEPTH_TEST),this.stateManager.enable(e.CULL_FACE),this.stateManager.disable(e.BLEND);var l,h=(x3dom.fields.SFVec3f.NullVector.toGL(),x3dom.fields.SFVec3f.OneVector.toGL(),a.getEnvironment()),u=h._vf.shadowExcludeTransparentObjects,f=a.drawableCollection.length;for(l=0;f>l;l++){var _=a.drawableCollection.get(l),c=_.transform,m=_.shape,p=m._webgl;if(p&&(!u||"transparent"!=_.sortType)){var x=m._cf.geometry.node,g=m._cf.appearance.node,v=x._mesh,y=m.getShaderProperties(t),b=this.cache.getShaderByProperties(e,m,y,null,!0);if(!b)return;if(this.stateManager.useProgram(b),b.cameraView=n,b.offset=r,b.modelViewProjectionMatrix=i.mult(c).toGL(),p.coordType!=e.FLOAT&&(b.bgCenter=!p.popGeometry&&x3dom.Utils.isUnsignedType(x._vf.coordType)?x.getMin().toGL():x._vf.position.toGL(),b.bgSize=x._vf.size.toGL(),b.bgPrecisionMax=x.getPrecisionMax("coordType")),m._clipPlanes){b.modelViewMatrix=o.mult(c).toGL(),b.viewMatrixInverse=o.inverse().toGL();for(var T=0;T<m._clipPlanes.length;T++){var S=m._clipPlanes[T].plane,M=m._clipPlanes[T].trafo;b["clipPlane"+T+"_Plane"]=M.multMatrixPlane(S._vf.plane).toGL(),b["clipPlane"+T+"_CappingStrength"]=S._vf.cappingStrength,b["clipPlane"+T+"_CappingColor"]=S._vf.cappingColor.toGL()}}if(0==p.imageGeometry||x3dom.caps.MOBILE){if((0!=p.binaryGeometry||0!=p.externalGeometry)&&1==x._vf.idsPerVertex){var C=g._shader;if(C&&x3dom.isa(g._shader,x3dom.nodeTypes.CommonSurfaceShader)&&C.getMultiVisibilityMap()){b.multiVisibilityMap=0;var F=x3dom.Utils.findTextureByName(p.texture,"multiVisibilityMap");b.multiVisibilityWidth=F.texture.width,b.multiVisibilityHeight=F.texture.height,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,F.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST)}}}else{b.IG_bboxMin=x.getMin().toGL(),b.IG_bboxMax=x.getMax().toGL(),b.IG_implicitMeshSize=x._vf.implicitMeshSize.toGL();var E=x3dom.Utils.findTextureByName(p.texture,"IG_coords0");if(E&&(b.IG_coordTextureWidth=E.texture.width,b.IG_coordTextureHeight=E.texture.height),1==p.imageGeometry){var w=x3dom.Utils.findTextureByName(p.texture,"IG_index");w&&(b.IG_indexTextureWidth=w.texture.width,b.IG_indexTextureHeight=w.texture.height),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,w.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,E.texture)}else e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,E.texture);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST);var A=0;x.getIndexTexture()&&(b.IG_indexTexture||(b.IG_indexTexture=A++)),x.getCoordinateTexture(0)&&(b.IG_coordinateTexture||(b.IG_coordinateTexture=A++))}m.isSolid()?(this.stateManager.enable(e.CULL_FACE),this.stateManager.frontFace(m.isCCW()?e.CCW:e.CW)):this.stateManager.disable(e.CULL_FACE);var R=g?g._cf.depthMode.node:null;if(R?R._vf.enableDepthTest?(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!R._vf.readOnly),this.stateManager.depthFunc(x3dom.Utils.depthFunc(e,R._vf.depthFunc)),this.stateManager.depthRange(R._vf.zNearRange,R._vf.zFarRange)):this.stateManager.disable(e.DEPTH_TEST):(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(e.LEQUAL)),p.popGeometry){var N=o.mult(c);this.updatePopState(_,x,b,p,a,N,t,this.x3dElem.runtime.fps)}var I;I=0!=p.externalGeometry?p.primType.length:p.positions.length;for(var P=0;I>P;P++){var D,V,L,B=6*P;if(void 0!==b.position&&p.buffers[B+1]&&(p.indexes[P]||0!=p.externalGeometry)){if(d=!1,p.buffers[B]&&(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,p.buffers[B]),d=!0),void 0!==b.position&&p.buffers[B+1]&&(e.bindBuffer(e.ARRAY_BUFFER,p.buffers[B+1]),e.vertexAttribPointer(b.position,v._numPosComponents,p.coordType,!1,m._coordStrideOffset[0],m._coordStrideOffset[1]),e.enableVertexAttribArray(b.position)),void 0!==b.id&&p.buffers[B+5]&&(e.bindBuffer(e.ARRAY_BUFFER,p.buffers[B+5]),0==p.binaryGeometry&&0==p.externalGeometry||1!=x._vf.idsPerVertex||(e.vertexAttribPointer(b.id,1,e.FLOAT,!1,4,0),e.enableVertexAttribArray(b.id))),d&&(p.binaryGeometry>0||p.popGeometry>0))for(D=0,L=0,V=x._vf.vertexCount.length;V>D;D++)e.drawElements(p.primType[D],x._vf.vertexCount[D],p.indexType,x3dom.Utils.getByteAwareOffset(L,p.indexType,e)),L+=x._vf.vertexCount[D];else if(p.binaryGeometry<0||p.popGeometry<0||p.imageGeometry)for(D=0,L=0,V=x._vf.vertexCount.length;V>D;D++)e.drawArrays(p.primType[D],L,x._vf.vertexCount[D]),L+=x._vf.vertexCount[D];else if(1==p.externalGeometry)e.drawElements(p.primType[P],p.drawCount[P],p.indexType,p.indexOffset[P]);else if(-1==p.externalGeometry)e.drawArrays(p.primType[P],0,p.drawCount[P]);else if(x.hasIndexOffset()){var O=m.tessellationProperties();for(D=0,V=O.length;V>D;D++)e.drawElements(p.primType,O[D].count,p.indexType,O[D].offset*x3dom.Utils.getOffsetMultiplier(p.indexType,e))}else 0==p.indexes[P].length?e.drawArrays(p.primType,0,p.positions[P].length/3):e.drawElements(p.primType,p.indexes[P].length,p.indexType,0);e.disableVertexAttribArray(b.position),void 0!==b.texcoord&&p.buffers[B+3]&&e.disableVertexAttribArray(b.texcoord),void 0!==b.color&&p.buffers[B+4]&&e.disableVertexAttribArray(b.color),void 0!==b.id&&p.buffers[B+5]&&e.disableVertexAttribArray(b.id)}}0==p.imageGeometry||x3dom.caps.MOBILE||(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),1==p.imageGeometry&&(e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null)))}}x3dom.Utils.needLineWidth&&this.stateManager.lineWidth(1),R&&(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(e.LEQUAL),this.stateManager.depthRange(0,1)),e.flush(),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null)},e.prototype.renderPickingPass=function(e,t,i,o,s,r,n,a,d,l,h){var u=t._webgl.pickScale,f=t._webgl.fboPick.height,_=a*u,c=f-1-d*u,m=!1;this.stateManager.bindFramebuffer(e.FRAMEBUFFER,t._webgl.fboPick.fbo),this.stateManager.viewport(0,0,t._webgl.fboPick.width,f),e.clearColor(0,0,0,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var p=t.drawableCollection.viewarea,x=t.getEnvironment(),g=t.drawableCollection.length;x._vf.smallFeatureCulling&&x._lowPriorityThreshold<1&&p.isMovingOrAnimating()&&(g=Math.floor(g*x._lowPriorityThreshold),!g&&t.drawableCollection.length&&(g=1));x3dom.fields.SFVec3f.NullVector.toGL(),x3dom.fields.SFVec3f.OneVector.toGL();this.stateManager.depthFunc(e.LEQUAL),this.stateManager.enable(e.DEPTH_TEST),this.stateManager.enable(e.CULL_FACE),this.stateManager.disable(e.BLEND),x3dom.Utils.needLineWidth&&this.stateManager.lineWidth(2);for(var v=0;g>v;v++){var y=t.drawableCollection.get(v),b=y.transform,T=y.shape,S=T._webgl;if(S&&!(T._objectID<1)&&T._vf.isPickable){var M=T._cf.geometry.node,C=T._cf.appearance.node,F=M._mesh,E=T.getShaderProperties(p),w=this.cache.getShaderByProperties(e,T,E,n);if(!w)return;if(this.stateManager.useProgram(w),w.modelMatrix=b.toGL(),w.modelViewProjectionMatrix=o.mult(b).toGL(),w.lowBit=(255&T._objectID)/255,w.highBit=(T._objectID>>>8)/255,w.from=s.toGL(),w.sceneSize=r,0==S.binaryGeometry&&0==S.externalGeometry||1!=M._vf.idsPerVertex||(w.shadowIDs=T._vf.idOffset+x3dom.nodeTypes.Shape.objectID+2),S.coordType!=e.FLOAT&&(w.bgCenter=!S.popGeometry&&x3dom.Utils.isUnsignedType(M._vf.coordType)?M.getMin().toGL():M._vf.position.toGL(),w.bgSize=M._vf.size.toGL(),w.bgPrecisionMax=M.getPrecisionMax("coordType")),1==n&&S.colorType!=e.FLOAT&&(w.bgPrecisionColMax=M.getPrecisionMax("colorType")),2==n&&S.texCoordType!=e.FLOAT&&(w.bgPrecisionTexMax=M.getPrecisionMax("texCoordType")),T._clipPlanes){w.modelViewMatrix=i.mult(b).toGL(),w.viewMatrixInverse=i.inverse().toGL();for(var A=0;A<T._clipPlanes.length;A++){var R=T._clipPlanes[A].plane,N=T._clipPlanes[A].trafo;w["clipPlane"+A+"_Plane"]=N.multMatrixPlane(R._vf.plane).toGL(),w["clipPlane"+A+"_CappingStrength"]=R._vf.cappingStrength,w["clipPlane"+A+"_CappingColor"]=R._vf.cappingColor.toGL()}}if(0==S.imageGeometry||x3dom.caps.MOBILE){if((0!=S.binaryGeometry||0!=S.externalGeometry)&&1==M._vf.idsPerVertex){var I=C._shader;if(I&&x3dom.isa(C._shader,x3dom.nodeTypes.CommonSurfaceShader)&&I.getMultiVisibilityMap()){w.multiVisibilityMap=0;var P=x3dom.Utils.findTextureByName(S.texture,"multiVisibilityMap");w.multiVisibilityWidth=P.texture.width,w.multiVisibilityHeight=P.texture.height,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,P.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST)}}}else{w.IG_bboxMin=M.getMin().toGL(),w.IG_bboxMax=M.getMax().toGL(),w.IG_implicitMeshSize=M._vf.implicitMeshSize.toGL();var D=x3dom.Utils.findTextureByName(S.texture,"IG_coords0");if(D&&(w.IG_coordTextureWidth=D.texture.width,w.IG_coordTextureHeight=D.texture.height),1==S.imageGeometry){var V=x3dom.Utils.findTextureByName(S.texture,"IG_index");V&&(w.IG_indexTextureWidth=V.texture.width,w.IG_indexTextureHeight=V.texture.height),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,V.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,D.texture)}else e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,D.texture);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST);var L=0;M.getIndexTexture()&&(w.IG_indexTexture||(w.IG_indexTexture=L++)),M.getCoordinateTexture(0)&&(w.IG_coordinateTexture||(w.IG_coordinateTexture=L++))}T.isSolid()?(this.stateManager.enable(e.CULL_FACE),this.stateManager.frontFace(T.isCCW()?e.CCW:e.CW)):this.stateManager.disable(e.CULL_FACE);var B=C?C._cf.depthMode.node:null;if(B?B._vf.enableDepthTest?(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!B._vf.readOnly),this.stateManager.depthFunc(x3dom.Utils.depthFunc(e,B._vf.depthFunc)),this.stateManager.depthRange(B._vf.zNearRange,B._vf.zFarRange)):this.stateManager.disable(e.DEPTH_TEST):(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(e.LEQUAL)),S.popGeometry){var O=i.mult(b);this.updatePopState(y,M,w,S,t,O,p,this.x3dElem.runtime.fps)}var k;k=0!=S.externalGeometry?S.primType.length:S.positions.length;for(var U=0;k>U;U++){var G,X,z,j=6*U;if(void 0!==w.position&&S.buffers[j+1]&&(S.indexes[U]||0!=S.externalGeometry)){if(m=!1,S.buffers[j]&&(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,S.buffers[j]),m=!0),void 0!==w.position&&S.buffers[j+1]&&(e.bindBuffer(e.ARRAY_BUFFER,S.buffers[j+1]),e.vertexAttribPointer(w.position,F._numPosComponents,S.coordType,!1,T._coordStrideOffset[0],T._coordStrideOffset[1]),e.enableVertexAttribArray(w.position)),1==n&&void 0!==w.color&&S.buffers[j+4]&&(e.bindBuffer(e.ARRAY_BUFFER,S.buffers[j+4]),e.vertexAttribPointer(w.color,F._numColComponents,S.colorType,!1,T._colorStrideOffset[0],T._colorStrideOffset[1]),e.enableVertexAttribArray(w.color)),2==n&&void 0!==w.texcoord&&S.buffers[j+3]&&(e.bindBuffer(e.ARRAY_BUFFER,S.buffers[j+3]),e.vertexAttribPointer(w.texcoord,F._numTexComponents,S.texCoordType,!1,T._texCoordStrideOffset[0],T._texCoordStrideOffset[1]),e.enableVertexAttribArray(w.texcoord)),void 0!==w.id&&S.buffers[j+5]&&(e.bindBuffer(e.ARRAY_BUFFER,S.buffers[j+5]),0==S.binaryGeometry&&0==S.externalGeometry||1!=M._vf.idsPerVertex||(e.vertexAttribPointer(w.id,1,e.FLOAT,!1,4,0),e.enableVertexAttribArray(w.id))),m&&(S.binaryGeometry>0||S.popGeometry>0))for(G=0,z=0,X=M._vf.vertexCount.length;X>G;G++)e.drawElements(S.primType[G],M._vf.vertexCount[G],S.indexType,x3dom.Utils.getByteAwareOffset(z,S.indexType,e)),z+=M._vf.vertexCount[G];else if(S.binaryGeometry<0||S.popGeometry<0||S.imageGeometry)for(G=0,z=0,X=M._vf.vertexCount.length;X>G;G++)e.drawArrays(S.primType[G],z,M._vf.vertexCount[G]),z+=M._vf.vertexCount[G];else if(1==S.externalGeometry)e.drawElements(S.primType[U],S.drawCount[U],S.indexType,S.indexOffset[U]);else if(-1==S.externalGeometry)e.drawArrays(S.primType[U],0,S.drawCount[U]);else if(M.hasIndexOffset()){var H=T.tessellationProperties();for(G=0,X=H.length;X>G;G++)e.drawElements(S.primType,H[G].count,S.indexType,H[G].offset*x3dom.Utils.getOffsetMultiplier(S.indexType,e))}else 0==S.indexes[U].length?e.drawArrays(S.primType,0,S.positions[U].length/3):e.drawElements(S.primType,S.indexes[U].length,S.indexType,0);

e.disableVertexAttribArray(w.position),void 0!==w.texcoord&&S.buffers[j+3]&&e.disableVertexAttribArray(w.texcoord),void 0!==w.color&&S.buffers[j+4]&&e.disableVertexAttribArray(w.color),void 0!==w.id&&S.buffers[j+5]&&e.disableVertexAttribArray(w.id)}}0==S.imageGeometry||x3dom.caps.MOBILE||(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),1==S.imageGeometry&&(e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null)))}}x3dom.Utils.needLineWidth&&this.stateManager.lineWidth(1),B&&(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(e.LEQUAL),this.stateManager.depthRange(0,1)),e.flush();try{var W=new Uint8Array(4*l*h);e.readPixels(_,c,l,h,e.RGBA,e.UNSIGNED_BYTE,W),t._webgl.fboPick.pixelData=W}catch(Y){t._webgl.fboPick.pixelData=[],x3dom.debug.logException(Y+" (cannot pick)")}this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null)},e.prototype.renderShape=function(e,t,i,o,s,r,n,a,d){var l=!1,h=e.shape,u=e.transform;if(!h||!h._webgl||!u)return void x3dom.debug.logError("[Context|RenderShape] No valid Shape!");var f=h._webgl,_=f.shader;if(!_)return void x3dom.debug.logError("[Context|RenderShape] No Shader is set!");var c=this.stateManager.useProgram(_),m=h._cf.appearance.node,p=h._cf.geometry.node,x=p._mesh,g=t._scene,v=null;f.coordType!=d.FLOAT?(_.bgCenter=!f.popGeometry&&x3dom.Utils.isUnsignedType(p._vf.coordType)?p.getMin().toGL():p._vf.position.toGL(),_.bgSize=p._vf.size.toGL(),_.bgPrecisionMax=p.getPrecisionMax("coordType")):(_.bgCenter=[0,0,0],_.bgSize=[1,1,1],_.bgPrecisionMax=1),_.bgPrecisionColMax=f.colorType!=d.FLOAT?p.getPrecisionMax("colorType"):1,_.bgPrecisionTexMax=f.texCoordType!=d.FLOAT?p.getPrecisionMax("texCoordType"):1,_.bgPrecisionNorMax=f.normalType!=d.FLOAT?p.getPrecisionMax("normalType"):1;var y,b,T,S,M=p._cf.customAttributes.nodes.length;for(le=0;M>le;le++)for(y=p._cf.customAttributes.nodes[le],b=0;b<y._cf.uniforms.nodes.length;b++)T=y._cf.uniforms.nodes[b],S=T._vf.name,_[T._vf.name]=T._vf.value;0!=f.imageGeometry&&(_.IG_bboxMin=p.getMin().toGL(),_.IG_bboxMax=p.getMax().toGL(),_.IG_implicitMeshSize=p._vf.implicitMeshSize.toGL(),v=x3dom.Utils.findTextureByName(f.texture,"IG_coords0"),v&&(_.IG_coordTextureWidth=v.texture.width,_.IG_coordTextureHeight=v.texture.height),1==f.imageGeometry&&(v=x3dom.Utils.findTextureByName(f.texture,"IG_index"),v&&(_.IG_indexTextureWidth=v.texture.width,_.IG_indexTextureHeight=v.texture.height)),v=null);var C=g.getFog();C&&c&&(_.fogColor=C._vf.color.toGL(),_.fogRange=C._vf.visibilityRange,_.fogType="LINEAR"==C._vf.fogType?0:1);var F=m?m._cf.material.node:null,E=m?m._shader:null,w=!1,A=E&&x3dom.isa(E,x3dom.nodeTypes.ComposedShader);if(f.csshader?(_.diffuseColor=E._vf.diffuseFactor.toGL(),_.specularColor=E._vf.specularFactor.toGL(),_.emissiveColor=E._vf.emissiveFactor.toGL(),_.shininess=E._vf.shininessFactor,_.ambientIntensity=(E._vf.ambientFactor.x+E._vf.ambientFactor.y+E._vf.ambientFactor.z)/3,_.transparency=1-E._vf.alphaFactor,E.getDisplacementMap()?(v=x3dom.Utils.findTextureByName(f.texture,"displacementMap"),_.displacementWidth=v.texture.width,_.displacementHeight=v.texture.height,_.displacementFactor=E._vf.displacementFactor,_.displacementAxis="x"==E._vf.displacementAxis?0:"y"==E._vf.displacementAxis?1:2):E.getDiffuseDisplacementMap()&&(v=x3dom.Utils.findTextureByName(f.texture,"diffuseDisplacementMap"),_.displacementWidth=v.texture.width,_.displacementHeight=v.texture.height,_.displacementFactor=E._vf.displacementFactor,_.displacementAxis="x"==E._vf.displacementAxis?0:"y"==E._vf.displacementAxis?1:2),E.getMultiDiffuseAlphaMap()&&(v=x3dom.Utils.findTextureByName(f.texture,"multiDiffuseAlphaMap"),_.multiDiffuseAlphaWidth=v.texture.width,_.multiDiffuseAlphaHeight=v.texture.height),E.getMultiEmissiveAmbientMap()&&(v=x3dom.Utils.findTextureByName(f.texture,"multiEmissiveAmbientMap"),_.multiEmissiveAmbientWidth=v.texture.width,_.multiEmissiveAmbientHeight=v.texture.height),E.getMultiSpecularShininessMap()&&(v=x3dom.Utils.findTextureByName(f.texture,"multiSpecularShininessMap"),_.multiSpecularShininessWidth=v.texture.width,_.multiSpecularShininessHeight=v.texture.height),E.getMultiVisibilityMap()&&(v=x3dom.Utils.findTextureByName(f.texture,"multiVisibilityMap"),_.multiVisibilityWidth=v.texture.width,_.multiVisibilityHeight=v.texture.height)):F?(_.diffuseColor=F._vf.diffuseColor.toGL(),_.specularColor=F._vf.specularColor.toGL(),_.emissiveColor=F._vf.emissiveColor.toGL(),_.shininess=F._vf.shininess,_.ambientIntensity=F._vf.ambientIntensity,_.transparency=F._vf.transparency,x3dom.isa(F,x3dom.nodeTypes.TwoSidedMaterial)&&(w=!0,_.backDiffuseColor=F._vf.backDiffuseColor.toGL(),_.backSpecularColor=F._vf.backSpecularColor.toGL(),_.backEmissiveColor=F._vf.backEmissiveColor.toGL(),_.backShininess=F._vf.backShininess,_.backAmbientIntensity=F._vf.backAmbientIntensity,_.backTransparency=F._vf.backTransparency)):(_.diffuseColor=[1,1,1],_.specularColor=[0,0,0],_.emissiveColor=[0,0,0],_.shininess=0,_.ambientIntensity=1,_.transparency=0),E)if(A){for(var R in E._vf)if(E._vf.hasOwnProperty(R)&&"language"!==R){var N=E._vf[R];void 0!==N&&null!==N&&(_[R]=N.toGL?N.toGL():N)}}else x3dom.isa(E,x3dom.nodeTypes.CommonSurfaceShader)&&(f.csshader=E);for(var I=0;o>I&&c;I++){var P=s.mult(i[I].getCurrentTransform());x3dom.isa(i[I],x3dom.nodeTypes.DirectionalLight)?(_["light"+I+"_Type"]=0,_["light"+I+"_On"]=i[I]._vf.on?1:0,_["light"+I+"_Color"]=i[I]._vf.color.toGL(),_["light"+I+"_Intensity"]=i[I]._vf.intensity,_["light"+I+"_AmbientIntensity"]=i[I]._vf.ambientIntensity,_["light"+I+"_Direction"]=P.multMatrixVec(i[I]._vf.direction).toGL(),_["light"+I+"_Attenuation"]=[1,1,1],_["light"+I+"_Location"]=[1,1,1],_["light"+I+"_Radius"]=0,_["light"+I+"_BeamWidth"]=0,_["light"+I+"_CutOffAngle"]=0,_["light"+I+"_ShadowIntensity"]=i[I]._vf.shadowIntensity):x3dom.isa(i[I],x3dom.nodeTypes.PointLight)?(_["light"+I+"_Type"]=1,_["light"+I+"_On"]=i[I]._vf.on?1:0,_["light"+I+"_Color"]=i[I]._vf.color.toGL(),_["light"+I+"_Intensity"]=i[I]._vf.intensity,_["light"+I+"_AmbientIntensity"]=i[I]._vf.ambientIntensity,_["light"+I+"_Direction"]=[1,1,1],_["light"+I+"_Attenuation"]=i[I]._vf.attenuation.toGL(),_["light"+I+"_Location"]=P.multMatrixPnt(i[I]._vf.location).toGL(),_["light"+I+"_Radius"]=i[I]._vf.radius,_["light"+I+"_BeamWidth"]=0,_["light"+I+"_CutOffAngle"]=0,_["light"+I+"_ShadowIntensity"]=i[I]._vf.shadowIntensity):x3dom.isa(i[I],x3dom.nodeTypes.SpotLight)&&(_["light"+I+"_Type"]=2,_["light"+I+"_On"]=i[I]._vf.on?1:0,_["light"+I+"_Color"]=i[I]._vf.color.toGL(),_["light"+I+"_Intensity"]=i[I]._vf.intensity,_["light"+I+"_AmbientIntensity"]=i[I]._vf.ambientIntensity,_["light"+I+"_Direction"]=P.multMatrixVec(i[I]._vf.direction).toGL(),_["light"+I+"_Attenuation"]=i[I]._vf.attenuation.toGL(),_["light"+I+"_Location"]=P.multMatrixPnt(i[I]._vf.location).toGL(),_["light"+I+"_Radius"]=i[I]._vf.radius,_["light"+I+"_BeamWidth"]=i[I]._vf.beamWidth,_["light"+I+"_CutOffAngle"]=i[I]._vf.cutOffAngle,_["light"+I+"_ShadowIntensity"]=i[I]._vf.shadowIntensity)}var D=g.getNavigationInfo();if(D._vf.headlight&&c&&(o=o?o:0,_["light"+o+"_Type"]=0,_["light"+o+"_On"]=1,_["light"+o+"_Color"]=[1,1,1],_["light"+o+"_Intensity"]=1,_["light"+o+"_AmbientIntensity"]=0,_["light"+o+"_Direction"]=[0,0,-1],_["light"+o+"_Attenuation"]=[1,1,1],_["light"+o+"_Location"]=[1,1,1],_["light"+o+"_Radius"]=0,_["light"+o+"_BeamWidth"]=0,_["light"+o+"_CutOffAngle"]=0,_["light"+o+"_ShadowIntensity"]=0),h._clipPlanes)for(var V=0;V<h._clipPlanes.length;V++){var L=h._clipPlanes[V].plane,B=h._clipPlanes[V].trafo;_["clipPlane"+V+"_Plane"]=B.multMatrixPlane(L._vf.plane).toGL(),_["clipPlane"+V+"_CappingStrength"]=L._vf.cappingStrength,_["clipPlane"+V+"_CappingColor"]=L._vf.cappingColor.toGL()}var O=m?m._cf.depthMode.node:null;O?O._vf.enableDepthTest?(this.stateManager.enable(d.DEPTH_TEST),this.stateManager.depthMask(!O._vf.readOnly),this.stateManager.depthFunc(x3dom.Utils.depthFunc(d,O._vf.depthFunc)),this.stateManager.depthRange(O._vf.zNearRange,O._vf.zFarRange)):this.stateManager.disable(d.DEPTH_TEST):(this.stateManager.enable(d.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(d.LEQUAL));var k=m?m._cf.blendMode.node:null;if(k){var U=x3dom.Utils.blendFunc(d,k._vf.srcFactor),G=x3dom.Utils.blendFunc(d,k._vf.destFactor);U&&G?(this.stateManager.enable(d.BLEND),this.stateManager.blendFuncSeparate(U,G,d.ONE,d.ONE),this.stateManager.blendColor(k._vf.color.r,k._vf.color.g,k._vf.color.b,1-k._vf.colorTransparency),this.stateManager.blendEquation(x3dom.Utils.blendEquation(d,k._vf.equation))):this.stateManager.disable(d.BLEND)}else this.stateManager.enable(d.BLEND),this.stateManager.blendFuncSeparate(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA,d.ONE,d.ONE);var X=m?m._cf.colorMaskMode.node:null;X?this.stateManager.colorMask(X._vf.maskR,X._vf.maskG,X._vf.maskB,X._vf.maskA):this.stateManager.colorMask(!0,!0,!0,!0);var z=m?m._cf.lineProperties.node:null;z?this.stateManager.lineWidth(z._vf.linewidthScaleFactor):x3dom.Utils.needLineWidth&&this.stateManager.lineWidth(1),h.isSolid()&&!w?(this.stateManager.enable(d.CULL_FACE),this.stateManager.frontFace(h.isCCW()?d.CCW:d.CW)):this.stateManager.disable(d.CULL_FACE);var j=s.mult(u),H=j.inverse();_.modelViewMatrix=j.toGL(),_.viewMatrix=s.toGL(),_.normalMatrix=H.transpose().toGL(),_.modelViewMatrixInverse=H.toGL(),_.modelViewProjectionMatrix=r.mult(u).toGL(),(A||h._clipPlanes&&h._clipPlanes.length)&&(_.viewMatrixInverse=s.inverse().toGL()),A&&(_.projectionMatrix=a.toGL(),_.worldMatrix=u.toGL(),_.worldInverseTranspose=u.inverse().transpose().toGL()),f.popGeometry&&this.updatePopState(e,p,_,f,g,j,t,this.x3dElem.runtime.fps);for(var W=0,Y=f.texture.length;Y>W;W++)v=f.texture[W],d.activeTexture(d.TEXTURE0+W),d.bindTexture(v.type,v.texture),d.texParameteri(v.type,d.TEXTURE_WRAP_S,v.wrapS),d.texParameteri(v.type,d.TEXTURE_WRAP_T,v.wrapT),d.texParameteri(v.type,d.TEXTURE_MAG_FILTER,v.magFilter),d.texParameteri(v.type,d.TEXTURE_MIN_FILTER,v.minFilter),E&&A||_[v.samplerName]||(_[v.samplerName]=W);if(m&&m._cf.textureTransform.node){var q=m.texTransformMatrix();_.texTrafoMatrix=q.toGL()}var Q,K=null,Z=f.dynamicFields.length;for(Q=0;Z>Q;Q++)K=f.dynamicFields[Q],void 0!==_[K.name]&&(d.bindBuffer(d.ARRAY_BUFFER,K.buf),d.vertexAttribPointer(_[K.name],K.numComponents,d.FLOAT,!1,0,0),d.enableVertexAttribArray(_[K.name]));var $,J,ee,te,ie=!1;x3dom.isa(p,x3dom.nodeTypes.ParticleSet)&&(ie=!0),te=0!=f.externalGeometry?f.primType.length:f.positions.length;for(var oe=0;te>oe;oe++){var se=6*oe;if(void 0!==_.position&&f.buffers[se+1]&&(f.indexes[oe]||0!=f.externalGeometry)){if(l=!1,f.buffers[se]){if(ie&&"any"!=p.drawOrder()){for(var re,ne=[],ae=p._cf.coord.node.getPoints(),de=ae.length==f.indexes[oe].length?f.indexes[oe].length:0,le=0;de>le;le++){var he=j.multMatrixPnt(ae[le]);ne.push([le,he.z])}for(ne.sort("backtofront"==p.drawOrder()?function(e,t){return e[1]-t[1]}:function(e,t){return t[1]-e[1]}),le=0;de>le;le++)h._webgl.indexes[oe][le]=ne[le][0];x3dom.caps.INDEX_UINT&&de>65535?(re=new Uint32Array(h._webgl.indexes[oe]),h._webgl.indexType=d.UNSIGNED_INT):(re=new Uint16Array(h._webgl.indexes[oe]),h._webgl.indexType=d.UNSIGNED_SHORT),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,f.buffers[se]),d.bufferData(d.ELEMENT_ARRAY_BUFFER,re,d.DYNAMIC_DRAW),re=null}d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,f.buffers[se]),l=!0}void 0!==_.position&&f.buffers[se+1]&&(d.bindBuffer(d.ARRAY_BUFFER,f.buffers[se+1]),d.vertexAttribPointer(_.position,x._numPosComponents,f.coordType,!1,h._coordStrideOffset[0],h._coordStrideOffset[1]),d.enableVertexAttribArray(_.position)),void 0!==_.normal&&f.buffers[se+2]&&(d.bindBuffer(d.ARRAY_BUFFER,f.buffers[se+2]),d.vertexAttribPointer(_.normal,x._numNormComponents,f.normalType,!1,h._normalStrideOffset[0],h._normalStrideOffset[1]),d.enableVertexAttribArray(_.normal)),void 0!==_.texcoord&&f.buffers[se+3]&&(d.bindBuffer(d.ARRAY_BUFFER,f.buffers[se+3]),d.vertexAttribPointer(_.texcoord,x._numTexComponents,f.texCoordType,!1,h._texCoordStrideOffset[0],h._texCoordStrideOffset[1]),d.enableVertexAttribArray(_.texcoord)),void 0!==_.color&&f.buffers[se+4]&&(d.bindBuffer(d.ARRAY_BUFFER,f.buffers[se+4]),d.vertexAttribPointer(_.color,x._numColComponents,f.colorType,!1,h._colorStrideOffset[0],h._colorStrideOffset[1]),d.enableVertexAttribArray(_.color)),void 0===_.id&&void 0===_.particleSize||!f.buffers[se+5]||(d.bindBuffer(d.ARRAY_BUFFER,f.buffers[se+5]),0==f.binaryGeometry&&0==f.externalGeometry||1!=p._vf.idsPerVertex?ie&&(d.vertexAttribPointer(_.particleSize,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(_.particleSize)):(d.vertexAttribPointer(_.id,1,d.FLOAT,!1,4,0),d.enableVertexAttribArray(_.id))),0!=f.popGeometry&&f.buffers[se+5]&&(d.bindBuffer(d.ARRAY_BUFFER,f.buffers[se+5]),d.vertexAttribPointer(_.PG_vertexID,1,d.FLOAT,!1,4,0),d.enableVertexAttribArray(_.PG_vertexID));var ue,fe=t.getRenderMode();if(fe>0){var _e=1==fe?d.POINTS:d.LINES;if(l&&(f.binaryGeometry>0||f.popGeometry>0))for($=0,ee=0,J=p._vf.vertexCount.length;J>$;$++)d.drawElements(_e,p._vf.vertexCount[$],f.indexType,x3dom.Utils.getByteAwareOffset(ee,f.indexType,d)),ee+=p._vf.vertexCount[$];else if(f.binaryGeometry<0||f.popGeometry<0||f.imageGeometry)for($=0,ee=0,J=p._vf.vertexCount.length;J>$;$++)d.drawArrays(_e,ee,p._vf.vertexCount[$]),ee+=p._vf.vertexCount[$];else if(1==f.externalGeometry)d.drawElements(_e,f.drawCount[oe],f.indexType,f.indexOffset[oe]);else if(-1==f.externalGeometry)d.drawArrays(_e,0,f.drawCount[oe]);else if(p.hasIndexOffset())for(ue=h.tessellationProperties(),$=0,J=ue.length;J>$;$++)d.drawElements(_e,ue[$].count,f.indexType,ue[$].offset*x3dom.Utils.getOffsetMultiplier(f.indexType,d));else 0==f.indexes[oe].length?d.drawArrays(_e,0,f.positions[oe].length/3):d.drawElements(_e,f.indexes[oe].length,f.indexType,0)}else if(l&&(f.binaryGeometry>0||f.popGeometry>0))for($=0,ee=0,J=p._vf.vertexCount.length;J>$;$++)d.drawElements(f.primType[$],p._vf.vertexCount[$],f.indexType,x3dom.Utils.getByteAwareOffset(ee,f.indexType,d)),ee+=p._vf.vertexCount[$];else if(f.binaryGeometry<0||f.popGeometry<0||f.imageGeometry)for($=0,ee=0,J=p._vf.vertexCount.length;J>$;$++)d.drawArrays(f.primType[$],ee,p._vf.vertexCount[$]),ee+=p._vf.vertexCount[$];else if(1==f.externalGeometry)d.drawElements(f.primType[oe],f.drawCount[oe],f.indexType,f.indexOffset[oe]);else if(-1==f.externalGeometry)d.drawArrays(f.primType[oe],0,f.drawCount[oe]);else if(p.hasIndexOffset())for(ue=h.tessellationProperties(),$=0,J=ue.length;J>$;$++)d.drawElements(f.primType,ue[$].count,f.indexType,ue[$].offset*x3dom.Utils.getOffsetMultiplier(f.indexType,d));else 0==f.indexes[oe].length?d.drawArrays(f.primType,0,f.positions[oe].length/3):d.drawElements(f.primType,f.indexes[oe].length,f.indexType,0);d.disableVertexAttribArray(_.position),void 0!==_.normal&&d.disableVertexAttribArray(_.normal),void 0!==_.texcoord&&d.disableVertexAttribArray(_.texcoord),void 0!==_.color&&d.disableVertexAttribArray(_.color),f.buffers[se+5]&&(void 0!==_.id?d.disableVertexAttribArray(_.id):void 0!==_.particleSize&&d.disableVertexAttribArray(_.particleSize)),0!=f.popGeometry&&void 0!==_.PG_vertexID&&d.disableVertexAttribArray(_.PG_vertexID)}}for(Q=0;Z>Q;Q++)K=f.dynamicFields[Q],void 0!==_[K.name]&&d.disableVertexAttribArray(_[K.name]);if(f.imageGeometry)for(J=p._vf.vertexCount.length,this.numDrawCalls+=J,$=0;J>$;$++)this.numFaces+=f.primType[$]==d.TRIANGLE_STRIP?p._vf.vertexCount[$]-2:p._vf.vertexCount[$]/3,this.numCoords+=p._vf.vertexCount[$];else this.numCoords+=x._numCoords,this.numFaces+=x._numFaces,this.numDrawCalls+=f.binaryGeometry||f.popGeometry?p._vf.vertexCount.length:p.hasIndexOffset()?h.tessellationProperties().length:te;O&&(this.stateManager.enable(d.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(d.LEQUAL),this.stateManager.depthRange(0,1)),k&&(this.stateManager.enable(d.BLEND),this.stateManager.blendFuncSeparate(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA,d.ONE,d.ONE),this.stateManager.blendColor(1,1,1,1),this.stateManager.blendEquation(d.FUNC_ADD)),X&&this.stateManager.colorMask(!0,!0,!0,!0),z&&this.stateManager.lineWidth(1);var ce=f.texture;for(Y=ce?ce.length:0,W=0;Y>W;W++)ce[W]&&m&&m._cf.texture.node&&(v=m._cf.texture.node.getTexture(W),d.activeTexture(d.TEXTURE0+W),x3dom.isa(v,x3dom.nodeTypes.X3DEnvironmentTextureNode)?d.bindTexture(d.TEXTURE_CUBE_MAP,null):d.bindTexture(d.TEXTURE_2D,null))},e.prototype.updatePopState=function(e,t,i,o,s,r,n,a){var d=x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor*t._vf.precisionFactor;(1>=a||n.isMovingOrAnimating())&&(d*=x3dom.nodeTypes.PopGeometry.PrecisionFactorOnMove);var l=16;if(d>0){var h=s.getViewpoint(),u=h.getImgPlaneHeightAtDistOne(),f=h.getNear(),_=r.multMatrixPnt(t._vf.position),c=.5*r.multMatrixVec(t._vf.size).length(),m=.5*r.multMatrixVec(t._vf.maxBBSize).length(),p=Math.max(-_.z-c,f),x=p*(u/n._height),g=2*m/(d*x);l=Math.ceil(Math.log(g)/.693147180559945),l=1>l?1:l>16?16:l}var v=t._vf.minPrecisionLevel,y=t._vf.maxPrecisionLevel;l=-1!=v&&v>l?v:l,l=-1!=y&&l>y?y:l;var b=o.levelsAvailable<l?o.levelsAvailable:l;l=b,1>=d&&(l=l==t.getNumLevels()?16:l);var T=t._vf.indexedRendering,S=t._mesh;S._numCoords=0,S._numFaces=0;for(var M=0;b>M;++M){var C=o.numVerticesAtLevel[M];S._numCoords+=C,S._numFaces+=(T?t.getNumIndicesByLevel(M):C)/3}x3dom.nodeTypes.PopGeometry.numRenderedVerts+=S._numCoords,x3dom.nodeTypes.PopGeometry.numRenderedTris+=S._numFaces,S.currentLOD=l,t.adaptVertexCount(T?3*S._numFaces:S._numCoords),i.PG_maxBBSize=t._vf.maxBBSize.toGL(),i.PG_bbMin=t._bbMinBySize,i.PG_numAnchorVertices=t._vf.numAnchorVertices,i.PG_bbMaxModF=t._vf.bbMaxModF.toGL(),i.PG_bboxShiftVec=t._vf.bbShiftVec.toGL(),i.PG_precisionLevel=l,i.PG_powPrecision=x3dom.nodeTypes.PopGeometry.powLUT[l-1]},e.prototype.pickValue=function(e,t,i,o,s,r){x3dom.Utils.startMeasure("picking");var n=e._scene,a=this.ctx3d;if(!(a&&n&&n._webgl&&n.drawableCollection))return!1;var d=n._vf.pickMode.toLowerCase(),l=0;switch(d){case"box":return!1;case"idbuf":l=0;break;case"idbuf24":l=3;break;case"idbufid":l=4;break;case"color":l=1;break;case"texcoord":l=2}var h,u;arguments.length>4?(h=s,u=r):(h=e._last_mat_view,u=e._last_mat_scene);var f=x3dom.fields.SFVec3f.copy(n._lastMin),_=x3dom.fields.SFVec3f.copy(n._lastMax),c=h.inverse().e3(),m=x3dom.fields.SFVec3f.copy(c),p=x3dom.fields.SFVec3f.copy(c);m.x>f.x&&(m.x=f.x),m.y>f.y&&(m.y=f.y),m.z>f.z&&(m.z=f.z),p.x<_.x&&(p.x=_.x),p.y<_.y&&(p.y=_.y),p.z<_.z&&(p.z=_.z),n._lastMin.setValues(m),n._lastMax.setValues(p);var x=n._lastMax.subtract(n._lastMin).length(),g=e.getCCtoWCMatrix();n._lastMin.setValues(f),n._lastMax.setValues(_);var v=x3dom.nodeTypes.Shape.objectID+2;this.renderPickingPass(a,n,h,u,c,x,l,t,i,2,2);var y=n._webgl.fboPick.pixelData;if(y&&y.length){var b,T,S,M,C,F,E=new x3dom.fields.SFVec3f(0,0,0),w=new x3dom.fields.SFVec3f(0,0,1),A=0,R=y[A+3],N=1/n._webgl.pickScale,I=1/256;0==l?(R+=256*y[A+2],T=y[A]/255*I+y[A+1]/255,S=e.calcViewRay(t,i,g),E=S.pos.add(S.dir.multiply(T*x)),A=4,T=y[A]/255*I+y[A+1]/255,M=e.calcViewRay(t+N,i,g),C=M.pos.add(M.dir.multiply(T*x)),C=C.subtract(E).normalize(),A=8,T=y[A]/255*I+y[A+1]/255,M=e.calcViewRay(t,i-N,g),F=M.pos.add(M.dir.multiply(T*x)),F=F.subtract(E).normalize(),w=C.cross(F).normalize()):3==l?(R+=256*y[A+2]+65536*y[A+1],T=y[A]/255,S=e.calcViewRay(t,i,g),E=S.pos.add(S.dir.multiply(T*x)),A=4,T=y[A]/255,M=e.calcViewRay(t+N,i,g),C=M.pos.add(M.dir.multiply(T*x)),C=C.subtract(E).normalize(),A=8,T=y[A]/255,M=e.calcViewRay(t,i-N,g),F=M.pos.add(M.dir.multiply(T*x)),F=F.subtract(E).normalize(),w=C.cross(F).normalize()):4==l?(R+=256*y[A+2],b=y[A+1],b+=256*y[A],0==R&&b>0&&v>b&&(R=b)):(E.x=y[A],E.y=y[A+1],E.z=y[A+2]);var P,D,V="shadowObjectIdChanged",L=Math.max(o>>>8,255&o);if(R>=v){R-=v;var B;if(4!=l?(e._pickingInfo.pickPos=E,e._pick.setValues(E),e._pickingInfo.pickNorm=w,e._pickNorm.setValues(w),e._pickingInfo.pickObj=null,e._pickingInfo.lastClickObj=null,B=n._xmlNode):(e._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[b],B=e._pickingInfo.pickObj._xmlNode),n._multiPartMap){var O,k;for(O=0;O<n._multiPartMap.multiParts.length;O++)k=n._multiPartMap.multiParts[O],R>=k._minId&&R<=k._maxId?(B=k._xmlNode,D={target:k._xmlNode,button:L,mouseup:o>>>8>0,layerX:t,layerY:i,pickedId:R,worldX:E.x,worldY:E.y,worldZ:E.z,normalX:w.x,normalY:w.y,normalZ:w.z,hitPnt:E.toGL(),hitObject:B,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},k.handleEvents(D)):(D={target:k._xmlNode,button:L,mouseup:o>>>8>0,layerX:t,layerY:i,pickedId:-1,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},k.handleEvents(D))}if(P=e._pickingInfo.shadowObjectId!=R,e._pickingInfo.lastShadowObjectId=e._pickingInfo.shadowObjectId,e._pickingInfo.shadowObjectId=R,(P||L)&&n._xmlNode&&(n._xmlNode["on"+V]||n._xmlNode.hasAttribute("on"+V)||n._listeners[V])&&(D={target:n._xmlNode,type:V,button:L,mouseup:o>>>8>0,layerX:t,layerY:i,shadowObjectId:R,worldX:E.x,worldY:E.y,worldZ:E.z,normalX:w.x,normalY:w.y,normalZ:w.z,hitPnt:E.toGL(),hitObject:B,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},n.callEvtHandler("on"+V,D)),n._shadowIdMap&&n._shadowIdMap.mapping&&R<n._shadowIdMap.mapping.length){var U,G,X,z=n._shadowIdMap.mapping[R].usage;for(S||(S=e.calcViewRay(t,i,g)),G=0;G<z.length;G++)if(X=n._nameSpace.defMap[z[G]],X&&X.doIntersect(S)){e._pickingInfo.pickObj=X;break}for(U=0;U<n._nameSpace.childSpaces.length;U++)for(G=0;G<z.length;G++)if(X=n._nameSpace.childSpaces[U].defMap[z[G]],X&&X.doIntersect(S)){e._pickingInfo.pickObj=X;break}}}else{if(n._multiPartMap)for(O=0;O<n._multiPartMap.multiParts.length;O++)k=n._multiPartMap.multiParts[O],D={target:k._xmlNode,button:L,mouseup:o>>>8>0,layerX:t,layerY:i,pickedId:-1,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},k.handleEvents(D);P=-1!=e._pickingInfo.shadowObjectId,e._pickingInfo.shadowObjectId=-1,P&&n._xmlNode&&(n._xmlNode["on"+V]||n._xmlNode.hasAttribute("on"+V)||n._listeners[V])&&(D={target:n._xmlNode,type:V,button:L,mouseup:o>>>8>0,layerX:t,layerY:i,shadowObjectId:e._pickingInfo.shadowObjectId,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},n.callEvtHandler("on"+V,D)),R>0?(e._pickingInfo.pickPos=E,e._pickingInfo.pickNorm=w,e._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[R]):(e._pickingInfo.pickObj=null,e._pickingInfo.lastClickObj=null)}}var j=x3dom.Utils.stopMeasure("picking");return this.x3dElem.runtime.addMeasurement("PICKING",j),!0},e.prototype.pickRect=function(e,t,i,o,s){var r=this.ctx3d,n=e?e._scene:null;if(!(r&&n&&n._webgl&&n.drawableCollection))return!1;var a=e._last_mat_view.inverse().e3(),d=n._lastMax.subtract(n._lastMin).length(),l=o>=t?t:o,h=i>=s?i:s,u=(1+Math.abs(o-t))*n._webgl.pickScale,f=(1+Math.abs(s-i))*n._webgl.pickScale;this.renderPickingPass(r,n,e._last_mat_view,e._last_mat_scene,a,d,0,l,h,1>u?1:u,1>f?1:f);var _,c=[];for(_=0;n._webgl.fboPick.pixelData&&_<n._webgl.fboPick.pixelData.length;_+=4){var m=n._webgl.fboPick.pixelData[_+3]+256*n._webgl.fboPick.pixelData[_+2];m>0&&c.push(m)}c.sort();var p=function(e){for(var t=[],i=e.length,o=0;i>o;o++){for(var s=o+1;i>s;s++)e[o]===e[s]&&(s=++o);t.push(e[o])}return t}(c);c=p;var x,g,v=[],y=x3dom.nodeTypes.Shape.objectID+2;for(_=0;_<c.length;_++)if(m=c[_],m>=y){if(m-=y,n._multiPartMap){var b,T,S,M,C,F,E;for(b=0;b<n._multiPartMap.multiParts.length;b++)T=n._multiPartMap.multiParts[b],S=T._inlineNamespace.defMap.MultiMaterial_ColorMap,M=T._inlineNamespace.defMap.MultiMaterial_EmissiveMap,C=T._inlineNamespace.defMap.MultiMaterial_SpecularMap,F=T._inlineNamespace.defMap.MultiMaterial_VisibilityMap,m>=T._minId&&m<=T._maxId&&(E=T._idMap.mapping[m-T._minId].name,g=new x3dom.Parts(T,[m],S,M,C,F),x={partID:E,part:g},v.push(x))}}else g=x3dom.nodeTypes.Shape.idMap.nodeID[m],g=g&&g._xmlNode?g._xmlNode:null,g&&v.push(g);return v},e.prototype.renderScene=function(e){var t=this.ctx3d,i=e._scene;if(null!==t&&null!==i){var o,s,r=e._doc._nodeBag.renderTextures,n=r.length,a=null,d=t.UNSIGNED_BYTE,l=t.UNSIGNED_BYTE,h=!1;x3dom.caps.FP_TEXTURES&&!x3dom.caps.MOBILE&&(d=t.FLOAT,l=t.FLOAT,x3dom.caps.FPL_TEXTURES||(h=!0));var u,f,_,c,m,p,x,g,v,y=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];if(i.updateVolume(),i._webgl){var b=Math.round(this.canvas.width*i._webgl.pickScale),T=Math.round(this.canvas.height*i._webgl.pickScale);for((i._webgl._currFboWidth!==b||i._webgl._currFboHeight!==T)&&(i._webgl._currFboWidth=b,i._webgl._currFboHeight=T,i._webgl.fboPick=x3dom.Utils.initFBO(t,b,T,i._webgl.fboPick.type,!1,!0),i._webgl.fboPick.pixelData=null,x3dom.debug.logInfo("Refreshed picking FBO to size ("+b+", "+T+")")),s=0;n>s;s++)o=r[s],o._webgl&&o._webgl.fbo&&o._webgl.fbo.width==o._vf.dimensions[0]&&o._webgl.fbo.height==o._vf.dimensions[1]||(o.invalidateGLObject(),o._cleanupGLObjects?o._cleanupGLObjects():o._cleanupGLObjects=function(e){e||t.deleteTexture(this._webgl.fbo.tex),this._webgl.fbo.dtex&&t.deleteTexture(this._webgl.fbo.dtex),this._webgl.fbo.rbo&&t.deleteRenderbuffer(this._webgl.fbo.rbo),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(this._webgl.fbo.fbo),this._webgl.fbo.rbo=null,this._webgl.fbo.fbo=null},a=o._cf.textureProperties.node,g=o.requirePingPong()?t.UNSIGNED_BYTE:d,o._webgl={},o._webgl.fbo=x3dom.Utils.initFBO(t,o._vf.dimensions[0],o._vf.dimensions[1],g,a&&a._vf.generateMipMaps,o._vf.depthMap||!o.requirePingPong()),o.requirePingPong()&&(v=o._vf.dimensions[0]+"x"+o._vf.dimensions[1],void 0===i._webgl.refinement[v]&&(i._webgl.refinement[v]=x3dom.Utils.initFBO(t,o._vf.dimensions[0],o._vf.dimensions[1],g,!1,!1)),o._webgl.texture=null),x3dom.debug.logInfo("Init/resize RenderedTexture_"+s+" to size "+o._vf.dimensions[0]+" x "+o._vf.dimensions[1]));for(u=e.getShadowedLights(),m=u.length,_=0;m>_;_++)if(p=u[_]._vf.shadowMapSize,f=x3dom.isa(u[_],x3dom.nodeTypes.PointLight)?6:Math.max(1,Math.min(u[_]._vf.shadowCascades,6)),"undefined"==typeof i._webgl.fboShadow[_]||i._webgl.fboShadow[_].length!=f||i._webgl.fboShadow[_][0].height!=p)for(i._webgl.fboShadow[_]=[],c=0;f>c;c++)i._webgl.fboShadow[_][c]=x3dom.Utils.initFBO(t,p,p,l,!1,!0);for(_=0;m>_;_++){for(p=i._webgl.fboShadow[_][0].height,x=!1,c=0;c<i._webgl.fboBlur.length;c++)p==i._webgl.fboBlur[c].height&&(x=!0);x||(i._webgl.fboBlur[i._webgl.fboBlur.length]=x3dom.Utils.initFBO(t,p,p,l,!1,!0))}((x3dom.SSAO.isEnabled(i)||i._webgl.fboShadow.length>0)&&"undefined"==typeof i._webgl.fboScene||i._webgl.fboScene&&(this.canvas.width!=i._webgl.fboScene.width||this.canvas.height!=i._webgl.fboScene.height))&&(i._webgl.fboScene=x3dom.Utils.initFBO(t,this.canvas.width,this.canvas.height,l,!1,!0))}else{for(i._webgl={},this.setupFgnds(t,i),i._webgl.pickScale=.5,i._webgl._currFboWidth=Math.round(this.canvas.width*i._webgl.pickScale),i._webgl._currFboHeight=Math.round(this.canvas.height*i._webgl.pickScale),i._webgl.fboPick=x3dom.Utils.initFBO(t,i._webgl._currFboWidth,i._webgl._currFboHeight,t.UNSIGNED_BYTE,!1,!0),i._webgl.fboPick.pixelData=null,i._webgl.normalShader=this.cache.getShader(t,x3dom.shader.NORMAL),i._webgl.fboShadow=[],u=e.getShadowedLights(),m=u.length,_=0;m>_;_++)for(p=u[_]._vf.shadowMapSize,f=x3dom.isa(u[_],x3dom.nodeTypes.PointLight)?6:Math.max(1,Math.min(u[_]._vf.shadowCascades,6)),i._webgl.fboShadow[_]=[],c=0;f>c;c++)i._webgl.fboShadow[_][c]=x3dom.Utils.initFBO(t,p,p,l,!1,!0);for((i._webgl.fboShadow.length>0||x3dom.SSAO.isEnabled(i))&&(i._webgl.fboScene=x3dom.Utils.initFBO(t,this.canvas.width,this.canvas.height,l,!1,!0)),i._webgl.fboBlur=[],_=0;m>_;_++){for(p=i._webgl.fboShadow[_][0].height,x=!1,c=0;c<i._webgl.fboBlur.length;c++)p==i._webgl.fboBlur[c].height&&(x=!0);x||(i._webgl.fboBlur[i._webgl.fboBlur.length]=x3dom.Utils.initFBO(t,p,p,l,!1,!0))}for(i._webgl.ppBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i._webgl.ppBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(y),t.STATIC_DRAW),i._webgl.refinement={stamps:new Array(2),positionBuffer:t.createBuffer()},t.bindBuffer(t.ARRAY_BUFFER,i._webgl.refinement.positionBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(y),t.STATIC_DRAW),s=0;n>s;s++)o=r[s],a=o._cf.textureProperties.node,g=o.requirePingPong()?t.UNSIGNED_BYTE:d,o._webgl={},o._webgl.fbo=x3dom.Utils.initFBO(t,o._vf.dimensions[0],o._vf.dimensions[1],g,a&&a._vf.generateMipMaps,o._vf.depthMap||!o.requirePingPong()),o._cleanupGLObjects=function(e){e||t.deleteTexture(this._webgl.fbo.tex),this._webgl.fbo.dtex&&t.deleteTexture(this._webgl.fbo.dtex),this._webgl.fbo.rbo&&t.deleteFramebuffer(this._webgl.fbo.rbo),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(this._webgl.fbo.fbo),this._webgl.fbo.rbo=null,this._webgl.fbo.fbo=null},o.requirePingPong()&&(v=o._vf.dimensions[0]+"x"+o._vf.dimensions[1],void 0===i._webgl.refinement[v]&&(i._webgl.refinement[v]=x3dom.Utils.initFBO(t,o._vf.dimensions[0],o._vf.dimensions[1],g,!1,!1)),o._webgl.texture=null);e._last_mat_view=x3dom.fields.SFMatrix4f.identity(),e._last_mat_proj=x3dom.fields.SFMatrix4f.identity(),e._last_mat_scene=x3dom.fields.SFMatrix4f.identity(),this._calledViewpointChangedHandler=!1}var S=i.getEnvironment();S.checkSanity();var M=i.getBackground();this.setupScene(t,M),this.numFaces=0,this.numCoords=0,this.numDrawCalls=0;var C=e.getProjectionMatrix(),F=e.getViewMatrix();if(!this._calledViewpointChangedHandler||!e._last_mat_view.equals(F)){var E=i.getViewpoint(),w="viewpointChanged";try{if(E._xmlNode&&(E._xmlNode["on"+w]||E._xmlNode.hasAttribute("on"+w)||E._listeners[w])){var A=E.getCurrentTransform();A=A.inverse().mult(F);var R=A.inverse(),N=new x3dom.fields.Quaternion(0,0,1,0);N.setValue(R);var I=R.e3(),P={target:E._xmlNode,type:w,matrix:A,position:I,orientation:N.toAxisAngle(),cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};E.callEvtHandler("on"+w,P),this._calledViewpointChangedHandler=!0}}catch(D){x3dom.debug.logException(D)}}e._last_mat_view=F,e._last_mat_proj=C;var V=C.mult(F);if(e._last_mat_scene=V,i.drawableCollection=null,!i.drawableCollection){var L={viewArea:e,sortTrans:S._vf.sortTrans,viewMatrix:F,projMatrix:C,sceneMatrix:V,frustumCulling:!0,smallFeatureThreshold:S._smallFeatureThreshold,context:this,gl:t};i.drawableCollection=new x3dom.DrawableCollection(L),x3dom.Utils.startMeasure("traverse"),i.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),i.drawableCollection,!0,!1,0,[]);var B=x3dom.Utils.stopMeasure("traverse");this.x3dElem.runtime.addMeasurement("TRAVERSE",B)}x3dom.Utils.startMeasure("sorting"),i.drawableCollection.sort();var O=x3dom.Utils.stopMeasure("sorting");this.x3dElem.runtime.addMeasurement("SORT",O);var k,U=e.getLights(),G=U.length,X=[],z=[],j=0;x3dom.Utils.startMeasure("shadow");for(var H=0;G>H;H++)if(U[H]._vf.shadowIntensity>0){var W=e.getLightMatrix()[H];ee=i._webgl.fboShadow[j];var Y=Math.max(0,Math.min(1,U[H]._vf.shadowOffset));if(x3dom.isa(U[H],x3dom.nodeTypes.PointLight))for(k=e.getWCtoLCMatricesPointLight(W,U[H],C),_=0;6>_;_++)this.renderShadowPass(t,e,k[_],F,ee[_],Y,!1);else{var q=Math.max(1,Math.min(U[H]._vf.shadowCascades,6));for(k=e.getWCtoLCMatricesCascaded(W,U[H],C),_=0;q>_;_++)this.renderShadowPass(t,e,k[_],F,ee[_],Y,!1)}j++,X[X.length]=k,z[z.length]=W}if(j>0||x3dom.SSAO.isEnabled(i)){this.renderShadowPass(t,e,V,F,i._webgl.fboScene,0,!0);var Q=x3dom.Utils.stopMeasure("shadow");this.x3dElem.runtime.addMeasurement("SHADOW",Q)}else this.x3dElem.runtime.removeMeasurement("SHADOW");for(k=e.getWCtoLCMatrix(e.getLightMatrix()[0]),s=0;n>s;s++)this.renderRTPass(t,e,r[s]);for(x3dom.Utils.startMeasure("render"),this.stateManager.viewport(0,0,this.canvas.width,this.canvas.height),M._webgl.render(t,F,C),x3dom.nodeTypes.PopGeometry.numRenderedVerts=0,x3dom.nodeTypes.PopGeometry.numRenderedTris=0,m=i.drawableCollection.length,S._vf.smallFeatureCulling&&S._lowPriorityThreshold<1&&e.isMovingOrAnimating()&&(m=Math.floor(m*S._lowPriorityThreshold),!m&&i.drawableCollection.length&&(m=1)),this.stateManager.unsetProgram(),_=0;m>_;_++){var K=i.drawableCollection.get(_);

this.renderShape(K,e,U,G,F,V,k,C,t)}if(j>0&&this.renderShadows(t,e,u,X,z,F,C,V),this.stateManager.disable(t.BLEND),this.stateManager.disable(t.DEPTH_TEST),e._numRenderedNodes=m,x3dom.SSAO.isEnabled(i)&&x3dom.SSAO.renderSSAO(this.stateManager,t,i,this.canvas),void 0!==e._visDbgBuf&&e._visDbgBuf){var Z=i._vf.pickMode.toLowerCase();(0==Z.indexOf("idbuf")||"color"==Z||"texcoord"==Z)&&(this.stateManager.viewport(0,3*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),i._fgnd._webgl.render(t,i._webgl.fboPick.tex)),(j>0||x3dom.SSAO.isEnabled(i))&&(this.stateManager.viewport(this.canvas.width/4,3*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),i._fgnd._webgl.render(t,i._webgl.fboScene.tex));var $=3,J=2;for(_=0;j>_;_++){var ee=i._webgl.fboShadow[_];for(c=0;c<ee.length;c++)this.stateManager.viewport(J*this.canvas.width/4,$*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),i._fgnd._webgl.render(t,ee[c].tex),2>J?J++:(J=0,$--)}for(s=0;n>s;s++)o=r[s],o._webgl.fbo.fbo&&(this.stateManager.viewport(s*this.canvas.width/8,5*this.canvas.height/8,this.canvas.width/8,this.canvas.height/8),i._fgnd._webgl.render(t,o._webgl.fbo.tex))}t.finish();var te=x3dom.Utils.stopMeasure("render");this.x3dElem.runtime.addMeasurement("RENDER",te),this.x3dElem.runtime.addMeasurement("DRAW",m?te/m:0),this.x3dElem.runtime.addInfo("#NODES:",i.drawableCollection.numberOfNodes),this.x3dElem.runtime.addInfo("#SHAPES:",e._numRenderedNodes),this.x3dElem.runtime.addInfo("#DRAWS:",this.numDrawCalls),this.x3dElem.runtime.addInfo("#POINTS:",this.numCoords),this.x3dElem.runtime.addInfo("#TRIS:",this.numFaces)}},e.prototype.renderPingPongPass=function(e,t,i){var o=t._scene,s=i._vf.dimensions[0]+"x"+i._vf.dimensions[1],r=o._webgl.refinement[s];if(0!=i._currLoadLevel||o._webgl.refinement.stamps[0]&&o._webgl.refinement.stamps[1]||(o._webgl.refinement.stamps[0]=this.cache.getTexture2D(e,i._nameSpace.doc,i._nameSpace.getURL(i._vf.stamp0),!1,!1,!1,!1),o._webgl.refinement.stamps[1]=this.cache.getTexture2D(e,i._nameSpace.doc,i._nameSpace.getURL(i._vf.stamp1),!1,!1,!1,!1)),i._currLoadLevel<i._loadLevel){i._currLoadLevel++,i._webgl.texture&&e.deleteTexture(i._webgl.texture);var n=i._vf.url[0]+"/"+i._currLoadLevel+"."+i._vf.format;i._webgl.texture=x3dom.Utils.createTexture2D(e,i._nameSpace.doc,i._nameSpace.getURL(n),!1,!1,!1,!1),i._vf.iterations%2===0?i._currLoadLevel%2!==0?i._repeat.x*=2:i._repeat.y*=2:i._currLoadLevel%2===0?i._repeat.x*=2:i._repeat.y*=2}if(i._webgl.texture.ready&&o._webgl.refinement.stamps[0].ready&&o._webgl.refinement.stamps[1].ready){this.stateManager.bindFramebuffer(e.FRAMEBUFFER,r.fbo),this.stateManager.viewport(0,0,r.width,r.height),this.stateManager.disable(e.BLEND),this.stateManager.disable(e.CULL_FACE),this.stateManager.disable(e.DEPTH_TEST),e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var a=this.cache.getShader(e,x3dom.shader.TEXTURE_REFINEMENT);this.stateManager.useProgram(a),e.bindBuffer(e.ARRAY_BUFFER,o._webgl.refinement.positionBuffer),e.vertexAttribPointer(a.position,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(a.position),a.stamp=0,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,o._webgl.refinement.stamps[(i._currLoadLevel+1)%2]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),i._currLoadLevel>1&&(a.lastTex=1,e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,i._webgl.fbo.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),a.curTex=2,e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,i._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),a.mode=i._currLoadLevel-1,a.repeat=i._repeat.toGL(),e.drawArrays(e.TRIANGLES,0,6),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,i._webgl.fbo.fbo),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),a.mode=0,a.curTex=2,e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,r.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.drawArrays(e.TRIANGLES,0,6),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(a.position),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null),this.stateManager.viewport(0,0,this.canvas.width,this.canvas.height),i._vf.autoRefinement&&i.nextLevel(),i._currLoadLevel==i._vf.maxLevel&&i._currLoadLevel++,i._webgl.fbo.mipMap&&(e.bindTexture(e.TEXTURE_2D,i._webgl.fbo.tex),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null)),i.requirePingPong()||(e.deleteTexture(i._webgl.texture),delete i._webgl.texture,i._cleanupGLObjects(!0)),i._renderedImage++}},e.prototype.renderRTPass=function(e,t,i){if(x3dom.isa(i,x3dom.nodeTypes.RefinementTexture))return void(i.requirePingPong()&&this.renderPingPongPass(e,t,i));switch(i._vf.update.toUpperCase()){case"NONE":return;case"NEXT_FRAME_ONLY":if(!i._needRenderUpdate)return;i._needRenderUpdate=!1;break;case"ALWAYS":}var o,s,r=t._scene,n=null,a=i.getViewMatrix(),d=i.getProjectionMatrix(),l=d.mult(a),h=t.getLightMatrix()[0],u=t.getWCtoLCMatrix(h),f=i._cf.excludeNodes.nodes.length,_=new Array(f);for(o=0;f>o;o++){var c=i._cf.excludeNodes.nodes[o]._vf.render;_[o]=void 0===c?-1:c===!0?1:0,i._cf.excludeNodes.nodes[o]._vf.render=!1}this.stateManager.bindFramebuffer(e.FRAMEBUFFER,i._webgl.fbo.fbo),this.stateManager.viewport(0,0,i._webgl.fbo.width,i._webgl.fbo.height),null===i._cf.background.node?(e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)):i._cf.background.node===r.getBackground()?(n=r.getBackground(),n._webgl.render(e,a,d)):(n=i._cf.background.node,this.setupScene(e,n),n._webgl.render(e,a,d)),this.stateManager.depthFunc(e.LEQUAL),this.stateManager.enable(e.DEPTH_TEST),this.stateManager.enable(e.CULL_FACE),this.stateManager.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE),this.stateManager.enable(e.BLEND);var m,p=t.getLights(),x=p.length,g=i._cf.scene.node;if(g&&g!==r){var v=r.getEnvironment(),y={viewArea:t,sortTrans:v._vf.sortTrans,viewMatrix:a,projMatrix:d,sceneMatrix:l,frustumCulling:!1,smallFeatureThreshold:1,context:this,gl:e};if(g.numberOfNodes=0,g.drawableCollection=new x3dom.DrawableCollection(y),g.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),g.drawableCollection,!0,!1,0,[]),g.drawableCollection.sort(),s=g.drawableCollection.length,i._vf.showNormals)this.renderNormals(e,g,r._webgl.normalShader,a,l);else for(this.stateManager.unsetProgram(),o=0;s>o;o++)m=g.drawableCollection.get(o),m.shape._vf.render&&this.renderShape(m,t,p,x,a,l,u,d,e)}else if(s=r.drawableCollection.length,i._vf.showNormals)this.renderNormals(e,r,r._webgl.normalShader,a,l);else for(this.stateManager.unsetProgram(),o=0;s>o;o++)m=r.drawableCollection.get(o),this.renderShape(m,t,p,x,a,l,u,d,e);for(this.stateManager.disable(e.BLEND),this.stateManager.disable(e.DEPTH_TEST),e.flush(),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null),i._webgl.fbo.mipMap&&(e.bindTexture(e.TEXTURE_2D,i._webgl.fbo.tex),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null)),o=0;f>o;o++)0!==_[o]&&(i._cf.excludeNodes.nodes[o]._vf.render=!0)},e.prototype.renderNormals=function(e,t,i,o,s){if(i&&t){this.stateManager.depthFunc(e.LEQUAL),this.stateManager.enable(e.DEPTH_TEST),this.stateManager.enable(e.CULL_FACE),this.stateManager.disable(e.BLEND),this.stateManager.useProgram(i);for(var r=x3dom.fields.SFVec3f.NullVector.toGL(),n=x3dom.fields.SFVec3f.OneVector.toGL(),a=0,d=t.drawableCollection.length;d>a;a++){var l=t.drawableCollection.get(a),h=l.transform,u=l.shape,f=u._webgl;if(f&&u&&u._vf.render){var _=u._cf.geometry.node,c=_._mesh,m=o.mult(h).inverse();i.normalMatrix=m.transpose().toGL(),i.modelViewProjectionMatrix=s.mult(h).toGL(),i.imageGeometry=f.imageGeometry,f.coordType!=e.FLOAT?(i.bgCenter=0!=f.popGeometry||4==c._numPosComponents&&x3dom.Utils.isUnsignedType(_._vf.coordType)?_.getMin().toGL():_._vf.position.toGL(),i.bgSize=_._vf.size.toGL(),i.bgPrecisionMax=_.getPrecisionMax("coordType")):(i.bgCenter=r,i.bgSize=n,i.bgPrecisionMax=1),i.bgPrecisionNorMax=f.normalType!=e.FLOAT?_.getPrecisionMax("normalType"):1,u.isSolid()?(this.stateManager.enable(e.CULL_FACE),this.stateManager.frontFace(u.isCCW()?e.CCW:e.CW)):this.stateManager.disable(e.CULL_FACE);for(var p=0,x=f.positions.length;x>p;p++){var g,v,y,b=6*p;if(void 0!==i.position&&f.buffers[b+1]&&f.indexes[p]){if(f.buffers[b]&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f.buffers[b]),e.bindBuffer(e.ARRAY_BUFFER,f.buffers[b+1]),e.vertexAttribPointer(i.position,c._numPosComponents,f.coordType,!1,u._coordStrideOffset[0],u._coordStrideOffset[1]),e.enableVertexAttribArray(i.position),void 0!==i.normal&&f.buffers[b+2]&&(e.bindBuffer(e.ARRAY_BUFFER,f.buffers[b+2]),e.vertexAttribPointer(i.normal,c._numNormComponents,f.normalType,!1,u._normalStrideOffset[0],u._normalStrideOffset[1]),e.enableVertexAttribArray(i.normal)),f.binaryGeometry>0||f.popGeometry>0)for(g=0,y=0,v=_._vf.vertexCount.length;v>g;g++)e.drawElements(f.primType[g],_._vf.vertexCount[g],f.indexType,x3dom.Utils.getByteAwareOffset(y,f.indexType,e)),y+=_._vf.vertexCount[g];else if(f.binaryGeometry<0||f.popGeometry<0||f.imageGeometry)for(g=0,y=0,v=_._vf.vertexCount.length;v>g;g++)e.drawArrays(f.primType[g],y,_._vf.vertexCount[g]),y+=_._vf.vertexCount[g];else if(_.hasIndexOffset()){var T=u.tessellationProperties();for(g=0,v=T.length;v>g;g++)e.drawElements(f.primType,T[g].count,f.indexType,T[g].offset*x3dom.Utils.getOffsetMultiplier(f.indexType,e))}else 0==f.indexes[p].length?e.drawArrays(f.primType,0,f.positions[p].length/3):e.drawElements(f.primType,f.indexes[p].length,f.indexType,0);e.disableVertexAttribArray(i.position),void 0!==i.normal&&e.disableVertexAttribArray(i.normal)}}}}}},e.prototype.shutdown=function(e){var t=this.ctx3d,i=e._scene;if(null!=t&&i){var o=i.getBackground();void 0!==o._webgl.position&&(t.deleteBuffer(o._webgl.buffers[1]),t.deleteBuffer(o._webgl.buffers[0]));var s=i._fgnd;void 0!==s._webgl.position&&(t.deleteBuffer(s._webgl.buffers[1]),t.deleteBuffer(s._webgl.buffers[0]));for(var r=i.drawableCollection?i.drawableCollection.length:0,n=0;r>n;n++){var a=i.drawableCollection.get(n).shape;a._cleanupGLObjects&&a._cleanupGLObjects(!0)}this.cache.Release(t)}},e.prototype.renderShadows=function(e,t,i,o,s,r,n,a){var d=t._scene,l=x3dom.caps.MAX_TEXTURE_IMAGE_UNITS;if(!(7>l)){var h,u,f,_,c,m=1,p=[0];for(f=0;f<i.length;f++){var x=i[f]._vf.shadowFilterSize;for(h=d._webgl.fboShadow[f],u=h.length,_=0;u>_;_++)this.blurTex(e,d,h[_],x);m+=6,m>l&&(p[p.length]=f,m=7)}p[p.length]=i.length;var g=p.length-1,v=n.inverse(),y=a.inverse();this.stateManager.enable(e.BLEND),this.stateManager.blendFunc(e.DST_COLOR,e.ZERO);for(var b=0;g>b;b++){var T=p[b],S=p[b+1],M=[];for(c=T;S>c;c++)M[M.length]=i[c];var C=this.cache.getShadowRenderingShader(e,M);this.stateManager.useProgram(C),e.bindBuffer(e.ARRAY_BUFFER,d._webgl.ppBuffer),e.vertexAttribPointer(C.position,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(C.position),C.sceneMap=0,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,d._webgl.fboScene.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),C.inverseProj=v.toGL(),C.inverseViewProj=y.toGL();for(var F,E,w=0,A=0,R=M.length;R>A;A++){for(E=s[A+T],F=o[A+T],h=d._webgl.fboShadow[A+T],u=F.length,f=0;u>f;f++)e.activeTexture(e.TEXTURE1+w),e.bindTexture(e.TEXTURE_2D,h[f].tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),C["light"+A+"_"+f+"_ShadowMap"]=w+1,C["light"+A+"_"+f+"_Matrix"]=F[f].toGL(),w++;if(C["light"+A+"_ViewMatrix"]=E.toGL(),!x3dom.isa(M[A],x3dom.nodeTypes.PointLight))for(_=0;u>_;_++){var N=Math.max(1,Math.min(M[A]._vf.shadowCascades,6)),I=Math.max(0,Math.min(M[A]._vf.shadowSplitFactor,1)),P=Math.max(0,Math.min(M[A]._vf.shadowSplitOffset,1)),D=t.getShadowSplitDepths(N,I,P,!1,n);C["light"+A+"_"+_+"_Split"]=D[_+1]}var V=r.mult(M[A].getCurrentTransform());x3dom.isa(M[A],x3dom.nodeTypes.DirectionalLight)?(C["light"+A+"_Type"]=0,C["light"+A+"_On"]=M[A]._vf.on?1:0,C["light"+A+"_Direction"]=V.multMatrixVec(M[A]._vf.direction).toGL(),C["light"+A+"_Attenuation"]=[1,1,1],C["light"+A+"_Location"]=[1,1,1],C["light"+A+"_Radius"]=0,C["light"+A+"_BeamWidth"]=0,C["light"+A+"_CutOffAngle"]=0,C["light"+A+"_ShadowIntensity"]=M[A]._vf.shadowIntensity,C["light"+A+"_ShadowCascades"]=M[A]._vf.shadowCascades,C["light"+A+"_ShadowOffset"]=Math.max(0,Math.min(1,M[A]._vf.shadowOffset))):x3dom.isa(M[A],x3dom.nodeTypes.PointLight)?(C["light"+A+"_Type"]=1,C["light"+A+"_On"]=M[A]._vf.on?1:0,C["light"+A+"_Direction"]=[1,1,1],C["light"+A+"_Attenuation"]=M[A]._vf.attenuation.toGL(),C["light"+A+"_Location"]=V.multMatrixPnt(M[A]._vf.location).toGL(),C["light"+A+"_Radius"]=M[A]._vf.radius,C["light"+A+"_BeamWidth"]=0,C["light"+A+"_CutOffAngle"]=0,C["light"+A+"_ShadowIntensity"]=M[A]._vf.shadowIntensity,C["light"+A+"_ShadowOffset"]=Math.max(0,Math.min(1,M[A]._vf.shadowOffset))):x3dom.isa(M[A],x3dom.nodeTypes.SpotLight)&&(C["light"+A+"_Type"]=2,C["light"+A+"_On"]=M[A]._vf.on?1:0,C["light"+A+"_Direction"]=V.multMatrixVec(M[A]._vf.direction).toGL(),C["light"+A+"_Attenuation"]=M[A]._vf.attenuation.toGL(),C["light"+A+"_Location"]=V.multMatrixPnt(M[A]._vf.location).toGL(),C["light"+A+"_Radius"]=M[A]._vf.radius,C["light"+A+"_BeamWidth"]=M[A]._vf.beamWidth,C["light"+A+"_CutOffAngle"]=M[A]._vf.cutOffAngle,C["light"+A+"_ShadowIntensity"]=M[A]._vf.shadowIntensity,C["light"+A+"_ShadowCascades"]=M[A]._vf.shadowCascades,C["light"+A+"_ShadowOffset"]=Math.max(0,Math.min(1,M[A]._vf.shadowOffset)))}e.drawArrays(e.TRIANGLES,0,6);var L=w+1;for(c=0;L>c;c++)e.activeTexture(e.TEXTURE0+c),e.bindTexture(e.TEXTURE_2D,null);e.disableVertexAttribArray(C.position)}this.stateManager.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)}},e.prototype.blurTex=function(e,t,i,o){if(!(0>=o)){o=5>o?3:7>o?5:7;for(var s=i.width,r=i.height,n=null,a=0,d=t._webgl.fboBlur.length;d>a;a++)if(r==t._webgl.fboBlur[a].height){n=t._webgl.fboBlur[a];break}this.stateManager.bindFramebuffer(e.FRAMEBUFFER,n.fbo),this.stateManager.viewport(0,0,s,r),this.stateManager.enable(e.BLEND),this.stateManager.blendFunc(e.ONE,e.ZERO),this.stateManager.disable(e.CULL_FACE),this.stateManager.disable(e.DEPTH_TEST),e.clearColor(1,1,1,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var l=this.cache.getShader(e,x3dom.shader.BLUR);this.stateManager.useProgram(l),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.ppBuffer),e.vertexAttribPointer(l.position,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(l.position),l.pixelSizeHor=1/s,l.pixelSizeVert=1/r,l.filterSize=o,l.horizontal=!0,l.texture=0,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,i.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.drawArrays(e.TRIANGLES,0,6),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,i.fbo),e.clearColor(1,1,1,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),l.horizontal=!1,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,n.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.drawArrays(e.TRIANGLES,0,6),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(l.position),e.flush(),this.stateManager.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null),this.stateManager.viewport(0,0,this.canvas.width,this.canvas.height)}},t}(),x3dom.bridge={setFlashReady:function(e,t){var i=x3dom.canvases[t];i.isFlashReady=!0,x3dom.debug.logInfo("Flash is ready for rendering ("+e+")")},onMouseDown:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onMousePress(s.gl,e,t,i),s.doc.needRender=!0},onMouseUp:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onMouseRelease(s.gl,e,t,i),s.doc.needRender=!0},onMouseOver:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onMouseOver(s.gl,e,t,i),s.doc.needRender=!0},onMouseOut:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onMouseOut(s.gl,e,t,i),s.doc.needRender=!0},onDoubleClick:function(e,t,i){var o=x3dom.canvases[i];o.doc.onDoubleClick(o.gl,e,t),o.doc.needRender=!0,x3dom.debug.logInfo("dblClick")},onMouseDrag:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onDrag(s.gl,e,t,i),s.doc.needRender=!0},onMouseMove:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onMove(s.gl,e,t,i),s.doc.needRender=!0},onMouseWheel:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onDrag(s.gl,e,t,i),s.doc.needRender=!0},onKeyDown:function(e,t){var i=x3dom.canvases[t],o=i.x3dElem.getAttribute("keysEnabled");o&&"true"!==o.toLowerCase()||i.doc.onKeyPress(e),i.doc.needRender=!0},setBBox:function(e){x3dom.nodeTypes.Shape.idMap.nodeID[e]},setShapeDirty:function(e){var t=x3dom.nodeTypes.Shape.idMap.nodeID[e];t.setAllDirty()}},x3dom.gfx_flash=function(){function e(e,t,i){this.object=e,this.name=t,this.isAlreadySet=!1,this.renderType=i}function t(t,i){return x3dom.Utils.maxIndexableCoords=65535,new e(t,"flash",i)}return e.prototype.getName=function(){return this.name},e.prototype.renderScene=function(e){var t=e._scene,i=x3dom.fields.SFVec3f.MAX(),o=x3dom.fields.SFVec3f.MIN(),s=t.getVolume();s.getBounds(i,o),t._lastMin=i,t._lastMax=o,e._last_mat_view=x3dom.fields.SFMatrix4f.identity(),e._last_mat_proj=x3dom.fields.SFMatrix4f.identity(),e._last_mat_scene=x3dom.fields.SFMatrix4f.identity();var r=t.getViewpoint();(-1==r._vf.zNear||-1==r._vf.zFar)&&(r._vf.zFar=2e4,r._vf.zNear=.1);var n=e.getViewMatrix(),a=e.getProjectionMatrix(),d=a.mult(n);this.setupScene(t,e);var l=t.getBackground();this.setupBackground(l);var h=t.getFog();this.setupFog(h),t.drawableCollection=null;var u=t.getEnvironment(),f={viewArea:e,sortTrans:u._vf.sortTrans,viewMatrix:n,projMatrix:a,sceneMatrix:d,frustumCulling:!1,smallFeatureThreshold:!1,context:null,gl:null};t.drawableCollection=new x3dom.DrawableCollection(f),t.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),t.drawableCollection,!0,!1,0,[]),t.drawableCollection.concat();var _=t.drawableCollection.length;if(_>0)for(var c=[],m=0;_>m;m++){var p=t.drawableCollection.get(m),x=p.transform,g=p.shape;void 0!=c[g._objectID]?c[g._objectID]++:c[g._objectID]=0,this.setupShape(g,x,c[g._objectID])}this.object.renderScene()},e.prototype.setupScene=function(e,t){var i=t.getViewMatrix();if(!t._last_mat_view.equals(i)){var o=t._scene.getViewpoint(),s="viewpointChanged";try{if(o._xmlNode&&(o._xmlNode["on"+s]||o._xmlNode.hasAttribute("on"+s)||o._listeners[s])){var r=o.getCurrentTransform();r=r.inverse().mult(i);var n=r.inverse(),a=new x3dom.fields.Quaternion(0,0,1,0),d=n.e3(),l={target:o._xmlNode,type:s,matrix:r,position:d,orientation:a.toAxisAngle(),cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}};o.callEvtHandler(s,l)}}catch(h){x3dom.debug.logException(h)}}t._last_mat_view=i;var u=e.getViewpoint(),f=t.getProjectionMatrix();this.object.setViewpoint({fov:u._vf.fov,zFar:u._vf.zFar,zNear:u._vf.zNear,viewMatrix:i.toGL(),projectionMatrix:f.toGL()});var _=e.getNavigationInfo();if(_._vf.headlight&&this.object.setHeadLight({id:-1,on:1,color:[1,1,1],intensity:1,ambientIntensity:0,direction:[0,0,-1]}),"deferred"==this.renderType)for(var c=t.getLights(),m=0;m<c.length;m++)if(c[m]._dirty){if(x3dom.isa(c[m],x3dom.nodeTypes.DirectionalLight))this.object.setDirectionalLight({id:c[m]._lightID,on:c[m]._vf.on,color:c[m]._vf.color.toGL(),intensity:c[m]._vf.intensity,ambientIntensity:c[m]._vf.ambientIntensity,direction:c[m]._vf.direction.toGL()});else if(x3dom.isa(c[m],x3dom.nodeTypes.PointLight)){{i.mult(c[m].getCurrentTransform())}this.object.setPointLight({id:c[m]._lightID,on:c[m]._vf.on,color:c[m]._vf.color.toGL(),intensity:c[m]._vf.intensity,ambientIntensity:c[m]._vf.ambientIntensity,attenuation:c[m]._vf.attenuation.toGL(),location:c[m]._vf.location.toGL(),radius:c[m]._vf.radius})}else x3dom.isa(c[m],x3dom.nodeTypes.SpotLight);c[m]._dirty=!1}},e.prototype.setupBackground=function(e){e._dirty&&(this.object.setBackground({texURLs:e.getTexUrl(),skyAngle:e._vf.skyAngle,skyColor:e.getSkyColor().toGL(),groundAngle:e._vf.groundAngle,groundColor:e.getGroundColor().toGL(),transparency:e.getTransparency()}),e._dirty=!1)},e.prototype.setupFog=function(e){return!e||!e._vf||e._vf.visibilityRange<=0?void this.object.setFog({color:null,visibilityRange:-1,fogType:-1}):void this.object.setFog({color:e._vf.color.toGL(),visibilityRange:e._vf.visibilityRange,fogType:"LINEAR"===e._vf.fogType?0:1})},e.prototype.setupShape=function(e,t,i){x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.PointSet)?x3dom.debug.logError("Flash backend doesn't support PointSets yet"):x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.IndexedLineSet)?x3dom.debug.logError("Flash backend doesn't support LineSets yet"):x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.Text)?this.setupText(e,t,i):this.setupIndexedFaceSet(e,t,i)},e.prototype.setupIndexedFaceSet=function(e,t,i){if(this.object.setMeshTransform({id:e._objectID,refID:i,transform:t.toGL()}),0==i){var o=x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.ImageGeometry),s=x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.BinaryGeometry),r=e._cf.appearance.node,n=r?e._cf.appearance.node._vf.sortType:"auto",a=r?e._cf.appearance.node._vf.sortKey:0;if(this.object.setMeshProperties(o?{id:e._objectID,type:"ImageGeometry",sortType:n,sortKey:a,solid:e.isSolid(),bboxMin:e._cf.geometry.node.getMin().toGL(),bboxMax:e._cf.geometry.node.getMax().toGL(),bboxCenter:e._cf.geometry.node.getCenter().toGL(),primType:e._cf.geometry.node._vf.primType,vertexCount:e._cf.geometry.node._vf.vertexCount}:s?{id:e._objectID,type:"BinaryGeometry",sortType:n,sortKey:a,solid:e.isSolid(),bgCenter:e._cf.geometry.node._vf.position.toGL(),bgSize:e._cf.geometry.node._vf.size.toGL(),bboxCenter:e._cf.geometry.node.getCenter().toGL(),primType:e._cf.geometry.node._vf.primType,vertexCount:e._cf.geometry.node._vf.vertexCount}:{id:e._objectID,type:"Default",sortType:n,sortKey:a,solid:e.isSolid()}),e._dirty.indexes===!0){if(o);else if(s)this.object.setMeshIndices({id:e._objectID,idx:0,indices:e._nameSpace.getURL(e._cf.geometry.node._vf.index)});else{e._cf.geometry.node._mesh._multiIndIndices&&e._cf.geometry.node._mesh._multiIndIndices.length&&e._cf.geometry.node._mesh.splitMesh(3,!0);for(var d=0;d<e._cf.geometry.node._mesh._indices.length;d++)this.object.setMeshIndices({id:e._objectID,idx:d,indices:e._cf.geometry.node._mesh._indices[d]})}e._dirty.indexes=!1}if(e._dirty.positions===!0){if(o)this.object.setMeshVertices({id:e._objectID,idx:0,coordinateTexture0:e._cf.geometry.node.getCoordinateTextureURL(0),coordinateTexture1:e._cf.geometry.node.getCoordinateTextureURL(1)});else if(s)this.object.setMeshVertices({id:e._objectID,idx:0,interleaved:e._cf.geometry.node._hasStrideOffset,vertices:e._nameSpace.getURL(e._cf.geometry.node._vf.coord),normals:e._nameSpace.getURL(e._cf.geometry.node._vf.normal),texCoords:e._nameSpace.getURL(e._cf.geometry.node._vf.texCoord),colors:e._nameSpace.getURL(e._cf.geometry.node._vf.color),numColorComponents:e._cf.geometry.node._mesh._numColComponents,numNormalComponents:e._cf.geometry.node._mesh._numNormComponents,vertexType:e._cf.geometry.node._vf.coordType,normalType:e._cf.geometry.node._vf.normalType,texCoordType:e._cf.geometry.node._vf.texCoordType,colorType:e._cf.geometry.node._vf.colorType,vertexStrideOffset:e._coordStrideOffset,normalStrideOffset:e._normalStrideOffset,texCoordStrideOffset:e._texCoordStrideOffset,colorStrideOffset:e._colorStrideOffset});else for(var d=0;d<e._cf.geometry.node._mesh._positions.length;d++)this.object.setMeshVertices({id:e._objectID,idx:d,vertices:e._cf.geometry.node._mesh._positions[d]});e._dirty.positions=!1}if(e._dirty.normals===!0){if(o)this.object.setMeshNormals({id:e._objectID,idx:0,normalTexture:e._cf.geometry.node.getNormalTextureURL()});else if(s)e._cf.geometry.node._hasStrideOffset||this.object.setMeshNormals({id:e._objectID,idx:0,normals:e._nameSpace.getURL(e._cf.geometry.node._vf.normal)});else if(e._cf.geometry.node._mesh._normals[0].length)for(var d=0;d<e._cf.geometry.node._mesh._normals.length;d++)this.object.setMeshNormals({id:e._objectID,idx:d,normals:e._cf.geometry.node._mesh._normals[d]});e._dirty.normals=!1}if(e._dirty.colors===!0){if(o)this.object.setMeshColors({id:e._objectID,idx:0,colorTexture:e._cf.geometry.node.getColorTextureURL(),components:e._cf.geometry.node._mesh._numColComponents});else if(s)e._cf.geometry.node._hasStrideOffset||this.object.setMeshColors({id:e._objectID,idx:0,colors:e._nameSpace.getURL(e._cf.geometry.node._vf.color),components:e._cf.geometry.node._mesh._numColComponents});else if(e._cf.geometry.node._mesh._colors[0].length)for(var d=0;d<e._cf.geometry.node._mesh._colors.length;d++)this.object.setMeshColors({id:e._objectID,idx:d,colors:e._cf.geometry.node._mesh._colors[d],components:e._cf.geometry.node._mesh._numColComponents});e._dirty.colors=!1}if(e._dirty.texcoords===!0){if(o)this.object.setMeshTexCoords({id:e._objectID,idx:0,texCoordTexture:e._cf.geometry.node.getTexCoordTextureURL()});else if(s)e._cf.geometry.node._hasStrideOffset||this.object.setMeshTexCoords({id:e._objectID,idx:0,texCoords:e._nameSpace.getURL(e._cf.geometry.node._vf.texCoord)});else if(e._cf.geometry.node._mesh._texCoords[0].length)for(var d=0;d<e._cf.geometry.node._mesh._texCoords.length;d++)this.object.setMeshTexCoords({id:e._objectID,idx:d,texCoords:e._cf.geometry.node._mesh._texCoords[d]});e._dirty.texcoords=!1}if(e._dirty.material===!0){if(r){var l=e._cf.appearance.node._cf.material.node;l&&this.object.setMeshMaterial({id:e._objectID,ambientIntensity:l._vf.ambientIntensity,diffuseColor:l._vf.diffuseColor.toGL(),emissiveColor:l._vf.emissiveColor.toGL(),shininess:l._vf.shininess,specularColor:l._vf.specularColor.toGL(),transparency:l._vf.transparency})}e._dirty.material=!1}if(e._dirty.texture===!0){if(r){var h=null;r._cf.textureTransform.node&&(h=r.texTransformMatrix().toGL());var u=e._cf.appearance.node._cf.texture.node;u?x3dom.isa(u,x3dom.nodeTypes.PixelTexture)?this.object.setPixelTexture({id:e._objectID,width:u._vf.image.width,height:u._vf.image.height,comp:u._vf.image.comp,pixels:u._vf.image.toGL()}):x3dom.isa(u,x3dom.nodeTypes.ComposedCubeMapTexture)?this.object.setCubeTexture({id:e._objectID,texURLs:u.getTexUrl()}):u._isCanvas&&u._canvas?this.object.setCanvasTexture({id:e._objectID,width:u._canvas.width,height:u._canvas.height,dataURL:u._canvas.toDataURL()}):x3dom.isa(u,x3dom.nodeTypes.MultiTexture)?x3dom.debug.logError("Flash backend doesn't support MultiTextures yet"):x3dom.isa(u,x3dom.nodeTypes.MovieTexture)?x3dom.debug.logError("Flash backend doesn't support MovieTextures yet"):this.object.setMeshTexture({id:e._objectID,origChannelCount:u._vf.origChannelCount,repeatS:u._vf.repeatS,repeatT:u._vf.repeatT,url:u._vf.url[0],transform:h}):this.object.removeTexture({id:e._objectID})}e._dirty.texture=!1}if(void 0!==e._cf.geometry.node._cf.texCoord&&null!==e._cf.geometry.node._cf.texCoord.node&&!x3dom.isa(e._cf.geometry.node._cf.texCoord.node,x3dom.nodeTypes.X3DTextureNode)&&e._cf.geometry.node._cf.texCoord.node._vf.mode){var f=e._cf.geometry.node._cf.texCoord.node._vf.mode;this.object.setSphereMapping("sphere"==f.toLowerCase()?{id:e._objectID,sphereMapping:1}:{id:e._objectID,sphereMapping:0})}else this.object.setSphereMapping({id:e._objectID,sphereMapping:0})}},e.prototype.setupText=function(e,t,i){if(this.object.setMeshTransform({id:e._objectID,refID:i,transform:t.toGL()}),0==i){var o=e._cf.appearance.node,s=o?e._cf.appearance.node._vf.sortType:"auto",r=o?e._cf.appearance.node._vf.sortKey:0;if(e._dirty.text===!0){var n=e._cf.geometry.node._cf.fontStyle.node;this.object.setMeshProperties(null===n?{id:e._objectID,type:"Text",sortType:s,sortKey:r,solid:e.isSolid(),text:e._cf.geometry.node._vf.string,fontFamily:["SERIF"],fontStyle:"PLAIN",fontAlign:"BEGIN",fontSize:32,fontSpacing:1,fontHorizontal:!0,fontLanguage:"",fontLeftToRight:!0,fontTopToBottom:!0}:{id:e._objectID,type:"Text",sortType:s,sortKey:r,solid:e.isSolid(),text:e._cf.geometry.node._vf.string,fontFamily:n._vf.family.toString(),fontStyle:n._vf.style.toString(),fontAlign:n._vf.justify.toString(),fontSize:n._vf.size,fontSpacing:n._vf.spacing,fontHorizontal:n._vf.horizontal,fontLanguage:n._vf.language,fontLeftToRight:n._vf.leftToRight,fontTopToBottom:n._vf.topToBottom}),e._dirty.text=!1}if(e._dirty.material===!0){if(o){var a=e._cf.appearance.node._cf.material.node;a&&this.object.setMeshMaterial({id:e._objectID,ambientIntensity:a._vf.ambientIntensity,diffuseColor:a._vf.diffuseColor.toGL(),emissiveColor:a._vf.emissiveColor.toGL(),shininess:a._vf.shininess,specularColor:a._vf.specularColor.toGL(),transparency:a._vf.transparency})}e._dirty.material=!1}}},e.prototype.pickValue=function(e){var t=e._scene;if(null===this.object||null===t||void 0===t.drawableCollection||!t.drawableCollection||"box"===t._vf.pickMode.toLowerCase())return!1;var i="color"===t._vf.pickMode.toLowerCase()?1:"texcoord"===t._vf.pickMode.toLowerCase()?2:0,o=this.object.pickValue({pickMode:i});return o.objID>0?(e._pickingInfo.pickPos=new x3dom.fields.SFVec3f(o.pickPosX,o.pickPosY,o.pickPosZ),e._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[o.objID]):(e._pickingInfo.pickObj=null,e._pickingInfo.lastClickObj=null),!0},e.prototype.shutdown=function(){},t}(),x3dom.NodeNameSpace=function(e,t){this.name=e,this.doc=t,this.baseURL="",this.defMap={},this.parent=null,this.childSpaces=[]},x3dom.NodeNameSpace.prototype.addNode=function(e,t){this.defMap[t]=e,e._nameSpace=this},x3dom.NodeNameSpace.prototype.removeNode=function(e){var t=e?this.defMap[e]:null;t&&(delete this.defMap[e],t._nameSpace=null)},x3dom.NodeNameSpace.prototype.getNamedNode=function(e){return this.defMap[e]},x3dom.NodeNameSpace.prototype.getNamedElement=function(e){var t=this.defMap[e];return t?t._xmlNode:null},x3dom.NodeNameSpace.prototype.addSpace=function(e){this.childSpaces.push(e),e.parent=this},x3dom.NodeNameSpace.prototype.removeSpace=function(e){e.parent=null;for(var t=0;t<this.childSpaces.length;t++)this.childSpaces[t]==e&&this.childSpaces.splice(t,1)},x3dom.NodeNameSpace.prototype.setBaseURL=function(e){var t=e.lastIndexOf("/");this.baseURL=t>=0?e.substr(0,t+1):"",x3dom.debug.logInfo("setBaseURL: "+this.baseURL)},x3dom.NodeNameSpace.prototype.getURL=function(e){return void 0!==e&&e.length?"/"===e[0]||e.indexOf(":")>=0?e:this.baseURL+e:""},x3dom.hasElementAttribute=function(e){var t=this.__hasAttribute(e);return!t&&e&&(t=this.__hasAttribute(e.toLowerCase())),t},x3dom.getElementAttribute=function(e){var t=this.__getAttribute(e);return!t&&""!=t&&e&&(t=this.__getAttribute(e.toLowerCase())),t||!this._x3domNode?t:this._x3domNode._vf[e]},x3dom.setElementAttribute=function(e,t){this.__setAttribute(e,t);var i=this._x3domNode;i&&(i.updateField(e,t),i._nameSpace.doc.needRender=!0)},x3dom.getFieldValue=function(e){var t=this._x3domNode;

if(t&&void 0!==t._vf[e]){var i=t._vf[e];return i instanceof Object&&"copy"in i?t._vf[e].copy():t._vf[e]}return null},x3dom.setFieldValue=function(e,t){var i=this._x3domNode;i&&void 0!==i._vf[e]&&(i._vf[e]=t instanceof Object&&"copy"in t?t.copy():t,i.fieldChanged(e),i._nameSpace.doc.needRender=!0)},x3dom.requestFieldRef=function(e){var t=this._x3domNode;return t&&t._vf[e]?t._vf[e]:null},x3dom.releaseFieldRef=function(e){var t=this._x3domNode;t&&t._vf[e]&&(t.fieldChanged(e),t._nameSpace.doc.needRender=!0)},x3dom.NodeNameSpace.prototype.setupTree=function(e){var t=null;if(x3dom.isX3DElement(e)){if(e._x3domNode)return x3dom.debug.logWarning("Tree is already initialized"),null;if(void 0===e.tagName||e.__addEventListener||e.__removeEventListener||(e.__addEventListener=e.addEventListener,e.addEventListener=function(e,t,i){this._x3domNode._listeners[e]||(this._x3domNode._listeners[e]=[]),this._x3domNode._listeners[e].push(t),this.__addEventListener(e,t,i)},e.__removeEventListener=e.removeEventListener,e.removeEventListener=function(e,t,i){var o=this._x3domNode._listeners[e];if(o)for(var s=0;s<o.length;s++)o[s]==t&&o.splice(s,1);this.__removeEventListener(e,t,i)}),e.hasAttribute("USE")||e.hasAttribute("use")){if(e.hasAttribute("USE")||e.setAttribute("USE",e.getAttribute("use")),t=this.defMap[e.getAttribute("USE")],!t){var i=e.getAttribute("USE").split("__");if(i.length>=2){for(var o=this;o;)o.name==i[0]&&(t=o.defMap[i[1]]),o=t?null:o.parent;t||(t=null,x3dom.debug.logWarning("Could not USE: "+e.getAttribute("USE")))}}return t&&(e._x3domNode=t),t}if("route"===e.localName.toLowerCase()){var s=e,r=s.getAttribute("fromNode")||s.getAttribute("fromnode"),n=s.getAttribute("toNode")||s.getAttribute("tonode"),a=this.defMap[r],d=this.defMap[n];return a&&d?(r=s.getAttribute("fromField")||s.getAttribute("fromfield"),n=s.getAttribute("toField")||s.getAttribute("tofield"),a.setupRoute(r,d,n),s._nodeNameSpace=this):x3dom.debug.logWarning("Broken route - can't find all DEFs for "+r+" -> "+n),null}e.requestFieldRef=x3dom.requestFieldRef,e.releaseFieldRef=x3dom.releaseFieldRef,e.getFieldValue=x3dom.getFieldValue,e.setFieldValue=x3dom.setFieldValue;var l=x3dom.nodeTypesLC[e.localName.toLowerCase()];if(void 0!==l){x3dom.userAgentFeature.supportsDOMAttrModified===!1&&e instanceof Element&&(e.setAttribute&&!e.__setAttribute&&(e.__setAttribute=e.setAttribute,e.setAttribute=x3dom.setElementAttribute),e.getAttribute&&!e.__getAttribute&&(e.__getAttribute=e.getAttribute,e.getAttribute=x3dom.getElementAttribute),e.hasAttribute&&!e.__hasAttribute&&(e.__hasAttribute=e.hasAttribute,e.hasAttribute=x3dom.hasElementAttribute));var h={doc:this.doc,xmlNode:e,nameSpace:this};t=new l(h),e.hasAttribute("DEF")?(t._DEF=e.getAttribute("DEF"),this.defMap[t._DEF]=t):e.hasAttribute("id")&&(t._DEF=e.getAttribute("id"),this.defMap[t._DEF]=t),void 0===e.highlight&&(e.highlight=function(e,t){var i=x3dom.fields.SFColor.parse(t);this._x3domNode.highlight(e,i),this._x3domNode._nameSpace.doc.needRender=!0}),t._xmlNode=e,e._x3domNode=t;var u=this;return Array.forEach(e.childNodes,function(e){var i=u.setupTree(e);i&&t.addChild(i,e.getAttribute("containerField"))}),t.nodeChanged(),t}x3dom.debug.logWarning("Unrecognised X3D element &lt;"+e.localName+"&gt;.")}else e.localName&&(x3dom.debug.logWarning("Unrecognised X3D element &lt;"+e.localName+"&gt;."),t=null);return t},x3dom.registerNodeType("X3DNode","Core",defineClass(null,function(e){this._xmlNode=null,this._DEF=null,this._nameSpace=e&&e.nameSpace?e.nameSpace:null,this._vf={},this._vfFieldTypes={},this._cf={},this._cfFieldTypes={},this._fieldWatchers={},this._routes={},this._listeners={},this._parentNodes=[],this._childNodes=[],this.addField_SFNode("metadata",x3dom.nodeTypes.X3DMetadataObject)},{type:function(){return this.constructor},typeName:function(){return this.constructor._typeName},addChild:function(e,t){if(e){var i=null;if(t)i=this._cf[t];else for(var o in this._cf)if(this._cf.hasOwnProperty(o)){var s=this._cf[o];if(x3dom.isa(e,s.type)){i=s;break}}if(i&&i.addLink(e))return e._parentNodes.push(this),this._childNodes.push(e),e.parentAdded(this),!0}return!1},removeChild:function(e){if(e)for(var t in this._cf)if(this._cf.hasOwnProperty(t)){var i=this._cf[t];if(i.rmLink(e)){for(var o=e._parentNodes.length-1;o>=0;o--)e._parentNodes[o]===this&&(e._parentNodes.splice(o,1),e.parentRemoved(this));for(var s=this._childNodes.length-1;s>=0;s--)if(this._childNodes[s]===e)return e.onRemove(),this._childNodes.splice(s,1),!0}}return!1},onRemove:function(){},parentAdded:function(){},parentRemoved:function(){for(var e=0,t=this._childNodes.length;t>e;e++)this._childNodes[e]&&this._childNodes[e].parentRemoved(this)},getCurrentTransform:function(){return this._parentNodes.length>=1?this.transformMatrix(this._parentNodes[0].getCurrentTransform()):x3dom.fields.SFMatrix4f.identity()},transformMatrix:function(e){return e},getVolume:function(){return null},invalidateVolume:function(){},invalidateCache:function(){},volumeValid:function(){return!1},collectDrawableObjects:function(){},highlight:function(e,t){this._vf.hasOwnProperty("diffuseColor")&&(e?(void 0===this._actDiffuseColor&&(this._actDiffuseColor=new x3dom.fields.SFColor,this._highlightOn=!1),this._highlightOn||(this._actDiffuseColor.setValues(this._vf.diffuseColor),this._highlightOn=!0),this._vf.diffuseColor.setValues(t)):void 0!==this._actDiffuseColor&&(this._vf.diffuseColor.setValues(this._actDiffuseColor),this._highlightOn=!1,delete this._actDiffuseColor));for(var i=0,o=this._childNodes.length;o>i;i++)this._childNodes[i]&&this._childNodes[i].highlight(e,t)},findX3DDoc:function(){return this._nameSpace.doc},doIntersect:function(e){for(var t=!1,i=0;i<this._childNodes.length;i++)this._childNodes[i]&&(t=this._childNodes[i].doIntersect(e)||t);return t},postMessage:function(e,t){this._vf[e]=t;var i=this._fieldWatchers[e],o=this;i&&Array.forEach(i,function(e){e.call(o,t)});var s={target:o._xmlNode,type:"outputchange",fieldName:e,value:t};this.callEvtHandler("onoutputchange",s)},updateField:function(e,t){var i=this._vf[e];if(void 0===i){for(var o in this._vf)if(o.toLowerCase()==e){e=o,i=this._vf[e];break}var s="set_";if(void 0===i&&0==e.indexOf(s)){var r=e.substr(s.length,e.length-1);void 0!==this._vf[r]&&(e=r,i=this._vf[e])}void 0===i&&(i=null,this._vf[e]=i)}if(null!==i){try{this._vf[e].setValueByStr(t)}catch(n){try{switch(_typeof(this._vf[e]).toString()){case"number":this._vf[e]="number"==typeof t?t:+t;break;case"boolean":this._vf[e]="boolean"==typeof t?t:"true"==t.toLowerCase();break;case"string":this._vf[e]=t}}catch(a){x3dom.debug.logError("updateField: setValueByStr() NYI for "+("undefined"==typeof i?"undefined":_typeof(i)))}}this.fieldChanged(e)}},setupRoute:function(e,t,i){var o,s,r="set_",n="_changed";this._vf[e]||(o=e.indexOf(r),0===o?(s=e.substr(r.length,e.length-1),this._vf[s]&&(e=s)):(o=e.indexOf(n),o>0&&(s=e.substr(0,e.length-n.length),this._vf[s]&&(e=s)))),t._vf[i]||(o=i.indexOf(r),0===o?(s=i.substr(r.length,i.length-1),t._vf[s]&&(i=s)):(o=i.indexOf(n),o>0&&(s=i.substr(0,i.length-n.length),t._vf[s]&&(i=s))));var a=this._DEF+"&"+e+"&"+t._DEF+"&"+i;this._routes[a]||(this._fieldWatchers[e]||(this._fieldWatchers[e]=[]),this._fieldWatchers[e].push(function(e){t.postMessage(i,e)}),t._fieldWatchers[i]||(t._fieldWatchers[i]=[]),t._fieldWatchers[i].push(function(e){t._vf[i]=e,t.fieldChanged(i)}),this._routes[a]={from:this._fieldWatchers[e].length-1,to:t._fieldWatchers[i].length-1})},removeRoute:function(e,t,i){var o,s,r="set_",n="_changed";this._vf[e]||(o=e.indexOf(r),0===o?(s=e.substr(r.length,e.length-1),this._vf[s]&&(e=s)):(o=e.indexOf(n),o>0&&(s=e.substr(0,e.length-n.length),this._vf[s]&&(e=s)))),t._vf[i]||(o=i.indexOf(r),0===o?(s=i.substr(r.length,i.length-1),t._vf[s]&&(i=s)):(o=i.indexOf(n),o>0&&(s=i.substr(0,i.length-n.length),t._vf[s]&&(i=s))));var a=this._DEF+"&"+e+"&"+t._DEF+"&"+i;this._routes[a]&&(this._fieldWatchers[e].splice(this._routes[a].from,1),t._fieldWatchers[i].splice(this._routes[a].to,1),delete this._routes[a])},fieldChanged:function(){},nodeChanged:function(){},callEvtHandler:function(e,t){var i=this;if(!i._xmlNode)return t.cancelBubble;try{var o=i._xmlNode[e];if(t.target=i._xmlNode,"function"==typeof o)o.call(i._xmlNode,t);else{var s=i._xmlNode.getAttribute(e),r=new Function("event",s);r.call(i._xmlNode,t)}var n=i._listeners[t.type];if(n)for(var a=0;a<n.length;a++)n[a].call(i._xmlNode,t)}catch(d){x3dom.debug.logException(d)}return t.cancelBubble},initSetter:function(e,t){if(e&&t){var i=t.toLowerCase();if(e.__defineSetter__&&e.__defineGetter__?(e.__defineSetter__(t,function(i){e.setAttribute(t,i)}),e.__defineGetter__(t,function(){return e.getAttribute(t)}),i!=t&&(e.__defineSetter__(i,function(i){e.setAttribute(t,i)}),e.__defineGetter__(i,function(){return e.getAttribute(t)}))):Object.defineProperty(e,t,{set:function(i){e.setAttribute(t,i)},get:function(){return e.getAttribute(t)},configurable:!0,enumerable:!0}),this._vf[t]&&!e.attributes[t]&&!e.attributes[t.toLowerCase()]){var o="";try{o=this._vf[t].toGL?this._vf[t].toGL().toString():this._vf[t].toString()}catch(s){o=this._vf[t].toString()}o||(o=""),e.setAttribute(t,o)}}},addField_SFInt32:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?parseInt(e.xmlNode.getAttribute(t),10):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFInt32"},addField_SFFloat:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?+e.xmlNode.getAttribute(t):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFFloat"},addField_SFDouble:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?+e.xmlNode.getAttribute(t):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFDouble"},addField_SFTime:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?+e.xmlNode.getAttribute(t):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFTime"},addField_SFBool:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?"true"===e.xmlNode.getAttribute(t).toLowerCase():i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFBool"},addField_SFString:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?e.xmlNode.getAttribute(t):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFString"},addField_SFColor:function(e,t,i,o,s){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFColor.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFColor(i,o,s),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFColor"},addField_SFColorRGBA:function(e,t,i,o,s,r){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFColorRGBA.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFColorRGBA(i,o,s,r),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFColorRGBA"},addField_SFVec2f:function(e,t,i,o){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFVec2f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFVec2f(i,o),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFVec2f"},addField_SFVec3f:function(e,t,i,o,s){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFVec3f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFVec3f(i,o,s),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFVec3f"},addField_SFVec4f:function(e,t,i,o,s,r){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFVec4f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFVec4f(i,o,s,r),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFVec4f"},addField_SFVec3d:function(e,t,i,o,s){this.addField_SFVec3f(e,t,i,o,s),this._vfFieldTypes[t]="SFVec3d"},addField_SFRotation:function(e,t,i,o,s,r){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.Quaternion.parseAxisAngle(e.xmlNode.getAttribute(t)):x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(i,o,s),r),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFRotation"},addField_SFMatrix4f:function(e,t,i,o,s,r,n,a,d,l,h,u,f,_,c,m,p,x){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFMatrix4f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFMatrix4f(i,o,s,r,n,a,d,l,h,u,f,_,c,m,p,x),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFMatrix4f"},addField_SFImage:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFImage.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFImage(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFImage"},addField_MFString:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFString.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFString(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFString"},addField_MFBoolean:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFBoolean.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFBoolean(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFBoolean"},addField_MFInt32:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFInt32.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFInt32(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFInt32"},addField_MFFloat:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFFloat.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFFloat(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFFloat"},addField_MFDouble:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFFloat.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFFloat(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFDouble"},addField_MFColor:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFColor.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFColor(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFColor"},addField_MFColorRGBA:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFColorRGBA.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFColorRGBA(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFColorRGBA"},addField_MFVec2f:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFVec2f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFVec2f(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFVec2f"},addField_MFVec3f:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFVec3f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFVec3f(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFVec3f"},addField_MFVec3d:function(e,t,i){this.addField_MFVec3f(e,t,i),this._vfFieldTypes[t]="MFVec3d"},addField_MFRotation:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFRotation.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFRotation(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFRotation"},addField_SFNode:function(e,t){this._cf[e]=new x3dom.fields.SFNode(t),this._cfFieldTypes[e]="SFNode"},addField_MFNode:function(e,t){this._cf[e]=new x3dom.fields.MFNode(t),this._cfFieldTypes[e]="MFNode"}})),x3dom.registerNodeType("X3DMetadataObject","Core",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DMetadataObject.superClass.call(this,e),this.addField_SFString(e,"name",""),this.addField_SFString(e,"reference","")})),x3dom.registerNodeType("MetadataBoolean","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataBoolean.superClass.call(this,e),this.addField_MFBoolean(e,"value",[])})),x3dom.registerNodeType("MetadataDouble","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataDouble.superClass.call(this,e),this.addField_MFDouble(e,"value",[])})),x3dom.registerNodeType("MetadataFloat","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataFloat.superClass.call(this,e),this.addField_MFFloat(e,"value",[])})),x3dom.registerNodeType("MetadataInteger","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataInteger.superClass.call(this,e),this.addField_MFInt32(e,"value",[])})),x3dom.registerNodeType("MetadataSet","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataSet.superClass.call(this,e),this.addField_MFNode("value",x3dom.nodeTypes.X3DMetadataObject)})),x3dom.registerNodeType("MetadataString","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataString.superClass.call(this,e),this.addField_MFString(e,"value",[])})),x3dom.registerNodeType("Field","Core",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.Field.superClass.call(this,e),this.addField_SFString(e,"name",""),this.addField_SFString(e,"type",""),this.addField_SFString(e,"value","")},{fieldChanged:function(e){var t=this;"value"===e&&Array.forEach(this._parentNodes,function(e){e.fieldChanged(t._vf.name)})}})),x3dom.registerNodeType("X3DChildNode","Core",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DChildNode.superClass.call(this,e)})),x3dom.registerNodeType("X3DBindableNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DBindableNode.superClass.call(this,e),this.addField_SFBool(e,"bind",!1),this.addField_SFString(e,"description",""),this.addField_SFBool(e,"isActive",!1),this._autoGen=e&&e.autoGen?!0:!1,this._autoGen&&(this._vf.description="default"+this.constructor.superClass._typeName),this._stack=null},{bind:function(e){this._stack?e?this._stack.push(this):this._stack.pop(this):x3dom.debug.logError("No BindStack in "+this.typeName()+"Bindable")},activate:function(){this.postMessage("isActive",!0),x3dom.debug.logInfo("activate "+this.typeName()+"Bindable "+this._DEF+"/"+this._vf.description)},deactivate:function(){this.postMessage("isActive",!1),x3dom.debug.logInfo("deactivate "+this.typeName()+"Bindable "+this._DEF+"/"+this._vf.description)},fieldChanged:function(e){e.indexOf("bind")>=0&&this.bind(this._vf.bind)},nodeChanged:function(){this._stack=this._nameSpace.doc._bindableBag.addBindable(this)}})),x3dom.registerNodeType("X3DInfoNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DInfoNode.superClass.call(this,e)})),x3dom.registerNodeType("WorldInfo","Core",defineClass(x3dom.nodeTypes.X3DInfoNode,function(e){x3dom.nodeTypes.WorldInfo.superClass.call(this,e),this.addField_MFString(e,"info",[]),this.addField_SFString(e,"title",""),x3dom.debug.logInfo(this._vf.info),x3dom.debug.logInfo(this._vf.title)})),x3dom.registerNodeType("X3DSensorNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DSensorNode.superClass.call(this,e),this.addField_SFBool(e,"enabled",!0)})),x3dom.registerNodeType("Param","Core",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.Param.superClass.call(this,e),x3dom.debug.logWarning('DEPRECATED: Param element needs to be child of X3D element [<a href="http://x3dom.org/docs/latest/configuration.html">DOCS</a>]')})),x3dom.registerNodeType("X3DBoundedObject","Grouping",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DBoundedObject.superClass.call(this,e),this.addField_SFBool(e,"render",!0),this.addField_SFVec3f(e,"bboxCenter",0,0,0),this.addField_SFVec3f(e,"bboxSize",-1,-1,-1),this._graph={boundedNode:this,localMatrix:x3dom.fields.SFMatrix4f.identity(),globalMatrix:null,volume:new x3dom.fields.BoxVolume,worldVolume:new x3dom.fields.BoxVolume,center:new x3dom.fields.SFVec3f(0,0,0),coverage:-1,needCulling:!0}},{fieldChanged:function(e){this._vf.hasOwnProperty(e)&&this.invalidateVolume()},nodeChanged:function(){this.invalidateVolume()},parentAdded:function(){this.invalidateVolume()},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this._vf.render)for(var t=0,i=this._childNodes.length;i>t;t++){var o=this._childNodes[t];if(o&&o._vf.render===!0){var s=o.getVolume();s&&s.isValid()&&e.extendBounds(s.min,s.max)}}return e},invalidateVolume:function(){var e=this._graph;e.volume.invalidate(),e.worldVolume.invalidate(),e.globalMatrix=null;for(var t=0,i=this._parentNodes.length;i>t;t++){var o=this._parentNodes[t];o&&o.volumeValid()&&o.invalidateVolume()}},invalidateCache:function(){var e=this._graph;e.worldVolume.invalidate(),e.globalMatrix=null},cacheInvalid:function(){return null==this._graph.globalMatrix||!this._graph.worldVolume.isValid()},volumeValid:function(){return this._graph.volume.isValid()},graphState:function(){return this._graph},forceUpdateCoverage:function(){return!1}})),x3dom.registerNodeType("X3DGroupingNode","Grouping",defineClass(x3dom.nodeTypes.X3DBoundedObject,function(e){x3dom.nodeTypes.X3DGroupingNode.superClass.call(this,e),this.addField_MFNode("children",x3dom.nodeTypes.X3DChildNode)},{collectDrawableObjects:function(e,t,i,o,s,r){if(i&&this._parentNodes.length>1&&(i=!1),i&&(o=o||this.cacheInvalid())&&this.invalidateCache(),s=t.cull(e,this.graphState(),i,s),!(0>s)){var n,a;i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),a=this._graph.globalMatrix):a=this.transformMatrix(e);var d=this._childNodes.length;if(x3dom.nodeTypes.ClipPlane.count>0){for(var l=[],h=0;d>h;h++)(n=this._childNodes[h])&&x3dom.isa(n,x3dom.nodeTypes.ClipPlane)&&n._vf.on&&n._vf.enabled&&l.push({plane:n,trafo:a});r=l.concat(r)}for(var u=0;d>u;u++)(n=this._childNodes[u])&&n.collectDrawableObjects(a,t,i,o,s,r)}}})),x3dom.registerNodeType("Switch","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Switch.superClass.call(this,e),this.addField_SFInt32(e,"whichChoice",-1)},{fieldChanged:function(e){"whichChoice"==e&&this.invalidateVolume()},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this._vf.render&&this._vf.whichChoice>=0&&this._vf.whichChoice<this._childNodes.length){var t=this._childNodes[this._vf.whichChoice],i=t&&t._vf.render===!0?t.getVolume():null;i&&i.isValid()&&e.extendBounds(i.min,i.max)}return e},collectDrawableObjects:function(e,t,i,o,s,r){if(i&&this._parentNodes.length>1&&(i=!1),i&&(o=o||this.cacheInvalid())&&this.invalidateCache(),!(this._vf.whichChoice<0||this._vf.whichChoice>=this._childNodes.length||(s=t.cull(e,this.graphState(),i,s))<0)){var n,a;i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),a=this._graph.globalMatrix):a=this.transformMatrix(e),(n=this._childNodes[this._vf.whichChoice])&&n.collectDrawableObjects(a,t,i,o,s,r)}},doIntersect:function(e){if(this._vf.whichChoice<0||this._vf.whichChoice>=this._childNodes.length)return!1;var t=this._childNodes[this._vf.whichChoice];return t?t.doIntersect(e):!1}})),x3dom.registerNodeType("X3DTransformNode","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.X3DTransformNode.superClass.call(this,e),e?e.doc._nodeBag.trans.push(this):x3dom.debug.logWarning("X3DTransformNode: No runtime context found!"),this._trafo=null,this._needCssStyleUpdates=!0},{tick:function(){var e=this._xmlNode;if(e&&(e.ontransform||e.hasAttribute("ontransform")||this._listeners.transform)){var t=this.getCurrentTransform(),i={target:e,type:"transform",worldX:t._03,worldY:t._13,worldZ:t._23,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}};this.callEvtHandler("ontransform",i)}if(this._needCssStyleUpdates&&e){var o=x3dom.getStyle(e,"-webkit-transform")||x3dom.getStyle(e,"-moz-transform")||x3dom.getStyle(e,"-ms-transform")||x3dom.getStyle(e,"transform");if(o&&"none"!=o)return this._trafo.setValueByStr(o),this.invalidateVolume(),!0;this._needCssStyleUpdates=!1}return!1},transformMatrix:function(e){return e.mult(this._trafo)},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this._vf.render){this._graph.localMatrix=this._trafo;for(var t=0,i=this._childNodes.length;i>t;t++){var o=this._childNodes[t];if(o&&o._vf.render===!0){var s=o.getVolume();s&&s.isValid()&&e.extendBounds(s.min,s.max)}}e.isValid()&&e.transform(this._trafo)}return e},doIntersect:function(e){var t=!1,i=this._trafo.inverse(),o=new x3dom.fields.SFVec3f(e.pos.x,e.pos.y,e.pos.z),s=new x3dom.fields.SFVec3f(e.dir.x,e.dir.y,e.dir.z);e.pos=i.multMatrixPnt(e.pos),e.dir=i.multMatrixVec(e.dir),e.hitObject&&(e.dist*=e.dir.length());for(var r=0;r<this._childNodes.length;r++)this._childNodes[r]&&(t=this._childNodes[r].doIntersect(e)||t);return e.pos.setValues(o),e.dir.setValues(s),t&&(e.hitPoint=this._trafo.multMatrixPnt(e.hitPoint),e.dist*=e.dir.length()),t},parentRemoved:function(){var e,t;if(0==this._parentNodes.length){var i=this.findX3DDoc();for(e=0,t=i._nodeBag.trans.length;t>e;e++)i._nodeBag.trans[e]===this&&i._nodeBag.trans.splice(e,1)}for(e=0,t=this._childNodes.length;t>e;e++)this._childNodes[e]&&this._childNodes[e].parentRemoved(this)}})),x3dom.registerNodeType("Transform","Grouping",defineClass(x3dom.nodeTypes.X3DTransformNode,function(e){x3dom.nodeTypes.Transform.superClass.call(this,e),this.addField_SFVec3f(e,"center",0,0,0),this.addField_SFVec3f(e,"translation",0,0,0),this.addField_SFRotation(e,"rotation",0,0,1,0),this.addField_SFVec3f(e,"scale",1,1,1),this.addField_SFRotation(e,"scaleOrientation",0,0,1,0),this._trafo=x3dom.fields.SFMatrix4f.translation(this._vf.translation.add(this._vf.center)).mult(this._vf.rotation.toMatrix()).mult(this._vf.scaleOrientation.toMatrix()).mult(x3dom.fields.SFMatrix4f.scale(this._vf.scale)).mult(this._vf.scaleOrientation.toMatrix().inverse()).mult(x3dom.fields.SFMatrix4f.translation(this._vf.center.negate()))},{fieldChanged:function(e){"center"==e||"translation"==e||"rotation"==e||"scale"==e||"scaleOrientation"==e?(this._trafo=x3dom.fields.SFMatrix4f.translation(this._vf.translation.add(this._vf.center)).mult(this._vf.rotation.toMatrix()).mult(this._vf.scaleOrientation.toMatrix()).mult(x3dom.fields.SFMatrix4f.scale(this._vf.scale)).mult(this._vf.scaleOrientation.toMatrix().inverse()).mult(x3dom.fields.SFMatrix4f.translation(this._vf.center.negate())),this.invalidateVolume()):"render"==e&&this.invalidateVolume()}})),x3dom.registerNodeType("MatrixTransform","Grouping",defineClass(x3dom.nodeTypes.X3DTransformNode,function(e){x3dom.nodeTypes.MatrixTransform.superClass.call(this,e),this.addField_SFMatrix4f(e,"matrix",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this._trafo=this._vf.matrix.transpose()},{fieldChanged:function(e){"matrix"==e?(this._trafo=this._vf.matrix.transpose(),this.invalidateVolume()):"render"==e&&this.invalidateVolume()}})),x3dom.registerNodeType("Group","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Group.superClass.call(this,e)})),x3dom.registerNodeType("Block","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Block.superClass.call(this,e),this.addField_MFString(e,"nameSpaceName",[])})),x3dom.registerNodeType("StaticGroup","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.StaticGroup.superClass.call(this,e),x3dom.debug.logWarning("StaticGroup erroneously also bakes parent transforms, if happens use Group node!"),this.addField_SFBool(e,"debug",!1),this.addField_SFBool(e,"showDebugBoxVolumes",!1),this.addField_SFString(e,"bvhType","jsBIH"),this.addField_SFInt32(e,"maxObjectsPerNode",1),this.addField_SFInt32(e,"maxDepth",-1),this.addField_SFFloat(e,"minRelativeBBoxSize",.01),this.needBvhRebuild=!0,this.drawableCollection=null,this.bvh=null},{getMaxDepth:function(){return-1==this._vf.maxDepth?"jsBIH"==this._vf.bvhType?50:4:this._vf.maxDepth},collectDrawableObjects:function(e,t,i,o,s,r){if(i&&this._parentNodes.length>1&&(i=!1),i&&(o=o||this.cacheInvalid())&&this.invalidateCache(),s=t.cull(e,this.graphState(),i,s),!(0>s)){var n,a;if(i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),a=this._graph.globalMatrix):a=this.transformMatrix(e),this.needBvhRebuild){var d={viewArea:t.viewarea,sortTrans:t.sortTrans,viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,sceneMatrix:t.sceneMatrix,frustumCulling:!1,smallFeatureThreshold:0,context:t.context};this.drawableCollection=new x3dom.DrawableCollection(d);var l,h=this._childNodes.length;for(l=0;h>l;l++)(n=this._childNodes[l])&&n.collectDrawableObjects(a,this.drawableCollection,i,o,s,r);this.drawableCollection.concat();var u=this._nameSpace.doc._scene,f=new x3dom.bvh.Settings(this._vf.debug,this._vf.showDebugBoxVolumes,this._vf.bvhType,this._vf.maxObjectsPerNode,this.getMaxDepth(),this._vf.minRelativeBBoxSize);for(this.bvh="jsBIH"==this._vf.bvhType?new x3dom.bvh.BIH(u,f):new x3dom.bvh.Culler(this.drawableCollection,u,f),(this._vf.debug||this._vf.showDebugBoxVolumes)&&(this.bvh=new x3dom.bvh.DebugDecorator(this.bvh,u,f)),h=this.drawableCollection.length,l=0;h>l;l++)this.bvh.addDrawable(this.drawableCollection.get(l));this.bvh.compile(),this._vf.debug&&this.bvh.showCompileStats(),this.needBvhRebuild=!1}x3dom.Utils.startMeasure("bvhTraverse"),this.bvh.collectDrawables(t);var _=x3dom.Utils.stopMeasure("bvhTraverse");this._nameSpace.doc.ctx.x3dElem.runtime.addMeasurement("BVH",_),this.bvh.showTraverseStats(this._nameSpace.doc.ctx.x3dElem.runtime)}}})),x3dom.registerNodeType("RemoteSelectionGroup","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.RemoteSelectionGroup.superClass.call(this,e),this.addField_MFString(e,"url",["ws://localhost:35668/cstreams/0"]),this.addField_MFString(e,"label",[]),this.addField_SFInt32(e,"maxRenderedIds",-1),this.addField_SFBool(e,"reconnect",!0),this.addField_SFFloat(e,"scaleRenderedIdsOnMove",1),this.addField_SFBool(e,"enableCulling",!0),this.addField_MFString(e,"invisibleNodes",[]),this._idList=[],this._websocket=null,this._nameObjMap={},this._createTime=[],this._visibleList=[],e?this.initializeSocket():x3dom.debug.logWarning("RemoteSelectionGroup: No runtime context found!")},{initializeSocket:function(){var e=this;if("WebSocket"in window){var t="ws://localhost:35668/cstreams/0";this._vf.url.length&&this._vf.url[0].length&&(t=this._vf.url[0]),this._websocket=new WebSocket(t),this._websocket._lastMsg=null,this._websocket._lastData="",this._websocket.onopen=function(){x3dom.debug.logInfo("WS Connected");var t=e._nameSpace.doc._viewarea.getViewMatrix();this._lastMsg=t.toGL().toString(),t=e._nameSpace.doc._viewarea.getProjectionMatrix(),this._lastMsg+=","+t.toGL().toString(),this.send(this._lastMsg),x3dom.debug.logInfo("WS Sent: "+this._lastMsg),this._lastMsg="",this._lastData=""},this._websocket.onclose=function(){x3dom.debug.logInfo("WS Disconnected"),e._vf.reconnect&&window.setTimeout(function(){e.initializeSocket()},2e3)},this._websocket.onmessage=function(t){if(e._vf.maxRenderedIds<0)e._idList=x3dom.fields.MFString.parse(t.data);else if(e._vf.maxRenderedIds>0){e._idList=[];for(var i=x3dom.fields.MFString.parse(t.data),o=Math.min(i.length,Math.abs(e._vf.maxRenderedIds)),s=0;o>s;++s)e._idList[s]=i[s]}0!=e._vf.maxRenderedIds&&this._lastData!=t.data&&(this._lastData=t.data,e._nameSpace.doc.needRender=!0,e.invalidateVolume())},this._websocket.onerror=function(e){x3dom.debug.logError(e.data)},this._websocket.updateCamera=function(){var t=e._nameSpace.doc._viewarea.getViewMatrix(),i=t.toGL().toString();t=e._nameSpace.doc._viewarea.getProjectionMatrix(),i+=","+t.toGL().toString(),null!=this._lastMsg&&this._lastMsg!=i&&(this._lastMsg=i,this.send(i))}}else x3dom.debug.logError("Browser has no WebSocket support!")},nodeChanged:function(){var e=this._vf.label.length;this._nameObjMap={},this._createTime=new Array(e),this._visibleList=new Array(e);for(var t=0;e>t;++t){var i=this._childNodes[t];i&&x3dom.isa(i,x3dom.nodeTypes.X3DShapeNode)?(this._nameObjMap[this._vf.label[t]]={shape:i,pos:t},this._visibleList[t]=!0):(this._visibleList[t]=!1,x3dom.debug.logError("Invalid children: "+this._vf.label[t])),this._createTime[t]=0}this.invalidateVolume(),x3dom.debug.logInfo("RemoteSelectionGroup has "+e+" entries.");

},fieldChanged:function(e){if("url"==e)this._websocket&&(this._websocket.close(),this._websocket=null),this.initializeSocket();else if("invisibleNodes"==e){for(var t=0,i=this._vf.label.length;i>t;++t){var o=this._childNodes[t];if(o&&x3dom.isa(o,x3dom.nodeTypes.X3DShapeNode)){this._visibleList[t]=!0;for(var s=0,r=this._vf.invisibleNodes.length;r>s;++s){var n=this._vf.invisibleNodes[s],a=n.lastIndexOf("*"),d=!1;if(a>0&&(n=n.substring(0,a),d=!0),!(n.length<=1)&&(d&&0==this._vf.label[t].indexOf(n)||this._vf.label[t]==n)){this._visibleList[t]=!1;break}}}else this._visibleList[t]=!1}this.invalidateVolume()}else"render"==e&&this.invalidateVolume()},getNumRenderedObjects:function(e,t){var i=e;if(this._vf.maxRenderedIds>0){var o=Math.max(this._vf.maxRenderedIds,16),s=1;t&&(s=Math.min(this._vf.scaleRenderedIdsOnMove,1)),o=Math.max(Math.round(s*o),0),i=Math.min(i,o)}return i},collectDrawableObjects:function(e,t,i,o,s,r){if(i&&this._parentNodes.length>1&&(i=!1),i&&(o=o||this.cacheInvalid())&&this.invalidateCache(),s=t.cull(e,this.graphState(),i,s),!(0>=s)){var n,a,d=this._nameSpace.doc._viewarea,l=d.isMovingOrAnimating(),h=(new Date).getTime(),u=1e4,f=this._childNodes.length;if(this._vf.enableCulling){if(this._websocket&&this._websocket.updateCamera(),this._vf.label.length){for(a=this.getNumRenderedObjects(this._idList.length,l),n=0;a>n;n++){var _=this._nameObjMap[this._idList[n]];_&&_.shape?(_.shape.collectDrawableObjects(e,t,i,o,s,r),this._createTime[_.pos]=h):x3dom.debug.logError("Invalid label: "+this._idList[n])}for(n=0;n<this._childNodes.length;n++)this._childNodes[n]&&!l&&this._createTime[n]>0&&h-this._createTime[n]>u&&this._childNodes[n]._cleanupGLObjects&&(this._childNodes[n]._cleanupGLObjects(!0),this._createTime[n]=0)}}else{a=this.getNumRenderedObjects(f,l);var c=0;for(n=0;f>n;n++){var m=this._childNodes[n];if(m){var p=!0;this._visibleList[n]&&a>c&&m.collectDrawableObjects(e,t,i,o,s,r)&&(this._createTime[n]=h,c++,p=!1),p&&!l&&this._createTime[n]>0&&h-this._createTime[n]>u&&m._cleanupGLObjects&&(m._cleanupGLObjects(!0),this._createTime[n]=0)}}}}}})),x3dom.registerNodeType("Scene","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Scene.superClass.call(this,e),this.addField_SFString(e,"pickMode","idBuf"),this.addField_SFBool(e,"doPickPass",!0),this.addField_SFString(e,"shadowObjectIdMapping",""),this._lastMin=new x3dom.fields.SFVec3f(0,0,0),this._lastMax=new x3dom.fields.SFVec3f(1,1,1),this._shadowIdMap=null,this.loadMapping(),this._multiPartMap=null},{fieldChanged:function(e){"shadowObjectIdMapping"==e&&this.loadMapping()},updateVolume:function(){var e=this.getVolume();e.isValid()&&(this._lastMin=x3dom.fields.SFVec3f.copy(e.min),this._lastMax=x3dom.fields.SFVec3f.copy(e.max))},loadMapping:function loadMapping(){if(this._shadowIdMap=null,0!=this._vf.shadowObjectIdMapping.length){var that=this,xhr=new XMLHttpRequest;xhr.open("GET",this._nameSpace.getURL(this._vf.shadowObjectIdMapping),!0),xhr.send(),xhr.onload=function(){that._shadowIdMap=eval("("+xhr.response+")"),that._shadowIdMap&&that._shadowIdMap.mapping?x3dom.debug.assert(that._shadowIdMap.maxID<=that._shadowIdMap.mapping.length,"Too few ID map entries in "+that._vf.shadowObjectIdMapping+", length of mapping array is only "+that._shadowIdMap.mapping.length+" instead of "+that._shadowIdMap.ids.length+"!"):x3dom.debug.logWarning("Invalid ID map: "+that._vf.shadowObjectIdMapping)}}}})),x3dom.BindableStack=function(e,t,i,o){this._doc=e,this._type=t,this._defaultType=i,this._defaultRoot=null,this._getter=o,this._bindBag=[],this._bindStack=[]},x3dom.BindableStack.prototype.top=function(){return this._bindStack.length>0?this._bindStack[this._bindStack.length-1]:null},x3dom.BindableStack.prototype.push=function(e){var t=this.top();t!==e&&(t&&t.deactivate(),this._bindStack.push(e),e.activate(t))},x3dom.BindableStack.prototype.replaceTop=function(e){var t=this.top();t!==e&&t&&(t.deactivate(),this._bindStack[this._bindStack.length-1]=e,e.activate(t))},x3dom.BindableStack.prototype.pop=function(e){var t;return e&&(t=this.top(),e!==t)?null:(t=this._bindStack.pop(),t&&t.deactivate(),t)},x3dom.BindableStack.prototype.switchTo=function(e){var t=this.getActive(),i=this._bindBag.length,o=0,s=0,r=-1;if(!(1>=i)){switch(e){case"first":o=this._bindBag[0];break;case"last":o=this._bindBag[i-1];break;default:for(s=0;i>s;s++)if(this._bindBag[s]==t){r=s;break}if(r>=0)for(s=r;!o&&(s="next"==e?i-1>s?s+1:0:s>0?s-1:i-1,s!=r);)this._bindBag[s]._vf.description.length>=0&&(o=this._bindBag[s])}o?this.replaceTop(o):x3dom.debug.logWarning("Cannot switch bindable; no other bindable with description found.")}},x3dom.BindableStack.prototype.getActive=function(){if(0===this._bindStack.length){if(0===this._bindBag.length)if(this._defaultRoot){x3dom.debug.logInfo("create new "+this._defaultType._typeName+" for "+this._type._typeName+"-stack");var e=new this._defaultType({doc:this._doc,nameSpace:this._defaultRoot._nameSpace,autoGen:!0});this._defaultRoot.addChild(e),e.nodeChanged()}else x3dom.debug.logError("stack without defaultRoot");else x3dom.debug.logInfo("activate first "+this._type._typeName+" for "+this._type._typeName+"-stack");this._bindStack.push(this._bindBag[0]),this._bindBag[0].activate()}return this._bindStack[this._bindStack.length-1]},x3dom.BindableBag=function(e){this._stacks=[],this.addType("X3DViewpointNode","Viewpoint","getViewpoint",e),this.addType("X3DNavigationInfoNode","NavigationInfo","getNavigationInfo",e),this.addType("X3DBackgroundNode","Background","getBackground",e),this.addType("X3DFogNode","Fog","getFog",e),this.addType("X3DEnvironmentNode","Environment","getEnvironment",e)},x3dom.BindableBag.prototype.addType=function(e,t,i,o){var s=x3dom.nodeTypes[e],r=x3dom.nodeTypes[t];if(s&&r){var n=new x3dom.BindableStack(o,s,r,i);this._stacks.push(n)}else x3dom.debug.logWarning("Invalid Bindable type/defaultType: "+e+"/"+r)},x3dom.BindableBag.prototype.setRefNode=function(e){Array.forEach(this._stacks,function(t){t._defaultRoot=e,e[t._getter]=function(){return t.getActive()}})},x3dom.BindableBag.prototype.addBindable=function(e){for(var t=0,i=this._stacks.length;i>t;t++){var o=this._stacks[t];if(x3dom.isa(e,o._type)){x3dom.debug.logInfo("register "+e.typeName()+"Bindable "+e._DEF+"/"+e._vf.description),o._bindBag.push(e);var s=o.top();if(s&&s._autoGen){o.replaceTop(e);for(var r=0,n=o._bindBag.length;n>r;r++)if(o._bindBag[r]===s){o._bindBag.splice(r,1);break}o._defaultRoot.removeChild(s)}return o}}return x3dom.debug.logError(e.typeName()+" is not a valid bindable"),null},x3dom.registerNodeType("X3DGeometryNode","Rendering",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DGeometryNode.superClass.call(this,e),this.addField_SFBool(e,"solid",!0),this.addField_SFBool(e,"ccw",!0),this.addField_SFBool(e,"useGeoCache",!0),this.addField_SFBool(e,"lit",!0),this._mesh=new x3dom.Mesh(this)},{getVolume:function(){return this._mesh.getVolume()},invalidateVolume:function(){this._mesh.invalidate()},getCenter:function(){return this._mesh.getCenter()},getDiameter:function(){return this._mesh.getDiameter()},doIntersect:function(e){return this._mesh.doIntersect(e)},forceUpdateCoverage:function(){return!1},hasIndexOffset:function(){return!1},getColorTexture:function(){return null},getColorTextureURL:function(){return null},parentAdded:function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)&&(e._cleanupGLObjects&&e._cleanupGLObjects(!0),e.setAllDirty(),e.invalidateVolume())},needLighting:function(){var e=this._mesh._primType.indexOf("TRIANGLE")>=0;return this._vf.lit&&e}})),x3dom.registerNodeType("Mesh","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.Mesh.superClass.call(this,e),this.addField_SFString(e,"primType","triangle"),this.addField_MFInt32(e,"index",[]),this.addField_MFNode("vertexAttributes",x3dom.nodeTypes.X3DVertexAttributeNode)},{nodeChanged:function(){var e,t=(new Date).getTime(),i=this._cf.vertexAttributes.nodes.length;for(e=0;i>e;e++){var o=this._cf.vertexAttributes.nodes[e]._vf.name;switch(o.toLowerCase()){case"position":this._mesh._positions[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;case"normal":this._mesh._normals[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;case"texcoord":this._mesh._texCoords[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;case"color":this._mesh._colors[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;default:this._mesh._dynamicFields[o]={},this._mesh._dynamicFields[o].numComponents=this._cf.vertexAttributes.nodes[e]._vf.numComponents,this._mesh._dynamicFields[o].value=this._cf.vertexAttributes.nodes[e]._vf.value.toGL()}}this._mesh._indices[0]=this._vf.index.toGL(),this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3;var s=(new Date).getTime()-t;x3dom.debug.logWarning("Mesh load time: "+s+" ms")}})),x3dom.registerNodeType("PointSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.PointSet.superClass.call(this,e),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this._mesh._primType="POINTS"},{nodeChanged:function(){var e=(new Date).getTime(),t=this._cf.coord.node;x3dom.debug.assert(t,"PointSet without coord node!");var i=t.getPoints(),o=3,s=this._cf.color.node,r=new x3dom.fields.MFColor;s&&(r=s._vf.color,x3dom.debug.assert(i.length==r.length,"Size of color and coord array differs!"),x3dom.isa(s,x3dom.nodeTypes.ColorRGBA)&&(o=4)),this._mesh._numColComponents=o,this._mesh._lit=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=i.toGL(),this._mesh._colors[0]=r.toGL(),this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3;(new Date).getTime()-e},fieldChanged:function(e){var t=null;"coord"==e?(t=this._cf.coord.node.getPoints(),this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})):"color"==e&&(t=this._cf.color.node._vf.color,this._mesh._colors[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0}))}})),x3dom.registerNodeType("X3DComposedGeometryNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.X3DComposedGeometryNode.superClass.call(this,e),this.addField_SFBool(e,"colorPerVertex",!0),this.addField_SFBool(e,"normalPerVertex",!0),this.addField_SFString(e,"normalUpdateMode","fast"),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_MFNode("customAttributes",x3dom.nodeTypes.CustomAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("normal",x3dom.nodeTypes.Normal),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode)},{handleAttribs:function(){var e,t=this._cf.attrib.nodes.length;for(e=0;t>e;e++){var i=this._cf.attrib.nodes[e]._vf.name;switch(i.toLowerCase()){case"position":this._mesh._positions[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;case"normal":this._mesh._normals[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;case"texcoord":this._mesh._texCoords[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;case"color":this._mesh._colors[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;default:this._mesh._dynamicFields[i]={},this._mesh._dynamicFields[i].numComponents=this._cf.attrib.nodes[e]._vf.numComponents,this._mesh._dynamicFields[i].value=this._cf.attrib.nodes[e]._vf.value.toGL()}}}})),x3dom.registerNodeType("LineSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.LineSet.superClass.call(this,e),this.addField_MFInt32(e,"vertexCount",[]),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this._mesh._primType="LINES",x3dom.Utils.needLineWidth=!0},{nodeChanged:function(){var e=this._cf.coord.node;x3dom.debug.assert(e);var t=e.getPoints();this._mesh._positions[0]=t.toGL();var i=this._cf.color.node;if(i){var o=i._vf.color;this._mesh._colors[0]=o.toGL(),this._mesh._numColComponents=3,x3dom.isa(i,x3dom.nodeTypes.ColorRGBA)&&(this._mesh._numColComponents=4)}var s=0;this._mesh._indices[0]=[];for(var r=0,n=this._vf.vertexCount.length;n>r;r++){var a=this._vf.vertexCount[r];if(2>a){x3dom.debug.logError("LineSet.vertexCount must not be smaller than 2!");break}for(var d=a-2;d>=0;d--)this._mesh._indices[0].push(s++,s),0==d&&s++}},fieldChanged:function(e){if("coord"==e){var t=this._cf.coord.node.getPoints();this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})}else if("color"==e){var i=this._cf.color.node._vf.color;this._mesh._colors[0]=i.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})}}})),x3dom.registerNodeType("IndexedLineSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.IndexedLineSet.superClass.call(this,e),this.addField_SFBool(e,"colorPerVertex",!0),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_MFInt32(e,"coordIndex",[]),this.addField_MFInt32(e,"colorIndex",[]),this._mesh._primType="LINES",x3dom.Utils.needLineWidth=!0},{_buildGeometry:function(){var e=(new Date).getTime(),t=this._vf.coordIndex,i=this._vf.colorIndex,o=!1,s=!1,r=this._vf.colorPerVertex;i.length==t.length&&(s=!0);var n,a,d=this._cf.coord.node;x3dom.debug.assert(d),n=d.getPoints();var l=3,h=this._cf.color.node;h?(o=!0,a=h._vf.color,x3dom.isa(h,x3dom.nodeTypes.ColorRGBA)&&(l=4)):o=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._colors[0]=[];var u,f,_,c,m,p,x,g;if(o&&s||n.length>x3dom.Utils.maxIndexableCoords){for(f=0,_=0,c=0,u=0;u<t.length;++u)if(!(t[u]>n.length-1))if(-1!==t[u])switch(s&&x3dom.debug.assert(-1!=i[u]),f){case 0:m=+t[u],x=s&&r?+i[u]:m,f=1;break;case 1:p=+t[u],g=s&&r?+i[u]:s&&!r?+i[c]:p,this._mesh._indices[0].push(_++,_++),this._mesh._positions[0].push(n[m].x),this._mesh._positions[0].push(n[m].y),this._mesh._positions[0].push(n[m].z),this._mesh._positions[0].push(n[p].x),this._mesh._positions[0].push(n[p].y),this._mesh._positions[0].push(n[p].z),o&&(r||(x=g),this._mesh._colors[0].push(a[x].r),this._mesh._colors[0].push(a[x].g),this._mesh._colors[0].push(a[x].b),this._mesh._colors[0].push(a[g].r),this._mesh._colors[0].push(a[g].g),this._mesh._colors[0].push(a[g].b)),f=2,c++;break;case 2:m=p,x=g,p=+t[u],g=s&&r?+i[u]:s&&!r?+i[c]:p,this._mesh._indices[0].push(_++,_++),this._mesh._positions[0].push(n[m].x),this._mesh._positions[0].push(n[m].y),this._mesh._positions[0].push(n[m].z),this._mesh._positions[0].push(n[p].x),this._mesh._positions[0].push(n[p].y),this._mesh._positions[0].push(n[p].z),o&&(r||(x=g),this._mesh._colors[0].push(a[x].r),this._mesh._colors[0].push(a[x].g),this._mesh._colors[0].push(a[x].b),this._mesh._colors[0].push(a[g].r),this._mesh._colors[0].push(a[g].g),this._mesh._colors[0].push(a[g].b)),c++}else f=0;n.length>x3dom.Utils.maxIndexableCoords&&this._mesh.splitMesh(2)}else{var v=t.length;for(f=0,u=0;v>u;++u)if(-1!=t[u])switch(f){case 0:m=+t[u],f=1;break;case 1:p=+t[u],f=2,this._mesh._indices[0].push(m,p);break;case 2:m=p,p=+t[u],this._mesh._indices[0].push(m,p)}else f=0;this._mesh._positions[0]=n.toGL(),o&&(this._mesh._colors[0]=a.toGL(),this._mesh._numColComponents=l)}for(this.invalidateVolume(),this._mesh._numCoords=0,u=0;u<this._mesh._indices.length;u++)this._mesh._numCoords+=this._mesh._positions[u].length/3;(new Date).getTime()-e},nodeChanged:function(){this._buildGeometry()},fieldChanged:function(e){"coord"==e?(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})):"color"==e?(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})):"coordIndex"==e?(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.indexes=!0,e.invalidateVolume()})):"colorIndex"==e&&(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0,e.invalidateVolume()}))}})),x3dom.registerNodeType("IndexedTriangleSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(e){x3dom.nodeTypes.IndexedTriangleSet.superClass.call(this,e),this.addField_MFInt32(e,"index",[])},{nodeChanged:function(){var e=(new Date).getTime();this.handleAttribs();var t,i,o,s,r=this._vf.colorPerVertex,n=this._vf.normalPerVertex,a=this._vf.index,d=!1,l=!1,h=!1,u=this._cf.coord.node;x3dom.debug.assert(u),t=u._vf.point;var f=this._cf.normal.node;f?(d=!0,i=f._vf.vector):d=!1;var _="",c=2,m=this._cf.texCoord.node;x3dom.isa(m,x3dom.nodeTypes.MultiTextureCoordinate)&&m._cf.texCoord.nodes.length&&(m=m._cf.texCoord.nodes[0]),m?m._vf.point?(l=!0,o=m._vf.point,x3dom.isa(m,x3dom.nodeTypes.TextureCoordinate3D)&&(c=3)):m._vf.mode&&(_=m._vf.mode):l=!1;var p=3,x=this._cf.color.node;x?(h=!0,s=x._vf.color,x3dom.isa(x,x3dom.nodeTypes.ColorRGBA)&&(p=4)):h=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];for(var g,v,y,b,T,S,M,C,F,E,w,A,R,N,I,P,D;t.length%3>0;)t.push(t.length-1);if(T=t.length,!n||!r||T>x3dom.Utils.maxIndexableCoords){for(v=0,y=0,b=0,this._mesh._multiIndIndices=[],this._mesh._posSize=t.length,g=0;g<a.length;++g)switch(g>0&&g%3===0&&(v=0,b++),v){case 0:S=+a[g],n?F=S:n||(F=b),A=S,r?I=S:r||(I=b),v=1;break;case 1:M=+a[g],n?E=M:n||(E=b),R=M,r?P=M:r||(P=b),v=2;break;case 2:C=+a[g],n?w=C:n||(w=b),N=C,r?D=C:r||(D=b),v=3,this._mesh._indices[0].push(y++,y++,y++),this._mesh._positions[0].push(t[S].x),this._mesh._positions[0].push(t[S].y),this._mesh._positions[0].push(t[S].z),this._mesh._positions[0].push(t[M].x),this._mesh._positions[0].push(t[M].y),this._mesh._positions[0].push(t[M].z),this._mesh._positions[0].push(t[C].x),this._mesh._positions[0].push(t[C].y),this._mesh._positions[0].push(t[C].z),d?(this._mesh._normals[0].push(i[F].x),this._mesh._normals[0].push(i[F].y),this._mesh._normals[0].push(i[F].z),this._mesh._normals[0].push(i[E].x),this._mesh._normals[0].push(i[E].y),this._mesh._normals[0].push(i[E].z),this._mesh._normals[0].push(i[w].x),this._mesh._normals[0].push(i[w].y),this._mesh._normals[0].push(i[w].z)):this._mesh._multiIndIndices.push(S,M,C),h&&(this._mesh._colors[0].push(s[I].r),this._mesh._colors[0].push(s[I].g),this._mesh._colors[0].push(s[I].b),4===p&&this._mesh._colors[0].push(s[I].a),this._mesh._colors[0].push(s[P].r),this._mesh._colors[0].push(s[P].g),this._mesh._colors[0].push(s[P].b),4===p&&this._mesh._colors[0].push(s[P].a),this._mesh._colors[0].push(s[D].r),this._mesh._colors[0].push(s[D].g),this._mesh._colors[0].push(s[D].b),4===p&&this._mesh._colors[0].push(s[D].a)),l&&(this._mesh._texCoords[0].push(o[A].x),this._mesh._texCoords[0].push(o[A].y),3===c&&this._mesh._texCoords[0].push(o[A].z),this._mesh._texCoords[0].push(o[R].x),this._mesh._texCoords[0].push(o[R].y),3===c&&this._mesh._texCoords[0].push(o[R].z),this._mesh._texCoords[0].push(o[N].x),this._mesh._texCoords[0].push(o[N].y),3===c&&this._mesh._texCoords[0].push(o[N].z))}d||this._mesh.calcNormals(n?Math.PI:0),l||this._mesh.calcTexCoords(_),this._mesh.splitMesh()}else{for(b=0,g=0;g<a.length;g++)g>0&&g%3===0&&b++,this._mesh._indices[0].push(a[g]),!n&&d&&(this._mesh._normals[0].push(i[b].x),this._mesh._normals[0].push(i[b].y),this._mesh._normals[0].push(i[b].z)),!r&&h&&(this._mesh._colors[0].push(s[b].r),this._mesh._colors[0].push(s[b].g),this._mesh._colors[0].push(s[b].b),4===p&&this._mesh._colors[0].push(s[b].a));this._mesh._positions[0]=t.toGL(),d?this._mesh._normals[0]=i.toGL():this._mesh.calcNormals(n?Math.PI:0),l?(this._mesh._texCoords[0]=o.toGL(),this._mesh._numTexComponents=c):this._mesh.calcTexCoords(_),h&&r&&(this._mesh._colors[0]=s.toGL(),this._mesh._numColComponents=p)}for(this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,g=0;g<this._mesh._indices.length;g++)this._mesh._numFaces+=this._mesh._indices[g].length/3,this._mesh._numCoords+=this._mesh._positions[g].length/3;(new Date).getTime()-e},fieldChanged:function(e){var t=this._cf.coord.node._vf.point;if(t.length>x3dom.Utils.maxIndexableCoords)return void x3dom.debug.logWarning("IndexedTriangleSet: fieldChanged with too many coordinates not yet implemented!");if("coord"==e)this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()});else if("color"==e){if(t=this._cf.color.node._vf.color,this._vf.colorPerVertex)this._mesh._colors[0]=t.toGL();else if(!this._vf.colorPerVertex){var i=0,o=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(o=4),this._mesh._colors[0]=[];for(var s=this._vf.index,r=0;r<s.length;++r)r>0&&r%3===0&&i++,this._mesh._colors[0].push(t[i].r),this._mesh._colors[0].push(t[i].g),this._mesh._colors[0].push(t[i].b),4===o&&this._mesh._colors[0].push(t[i].a)}Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})}else if("normal"==e){if(t=this._cf.normal.node._vf.vector,this._vf.normalPerVertex)this._mesh._normals[0]=t.toGL();else if(!this._vf.normalPerVertex){var s=this._vf.index;this._mesh._normals[0]=[];for(var i=0,r=0;r<s.length;++r)r>0&&r%3===0&&i++,this._mesh._normals[0].push(t[i].x),this._mesh._normals[0].push(t[i].y),this._mesh._normals[0].push(t[i].z)}Array.forEach(this._parentNodes,function(e){e._dirty.normals=!0})}else if("texCoord"==e){var n=this._cf.texCoord.node;x3dom.isa(n,x3dom.nodeTypes.MultiTextureCoordinate)&&n._cf.texCoord.nodes.length&&(n=n._cf.texCoord.nodes[0]),t=n._vf.point,this._mesh._texCoords[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.texcoords=!0})}else if(e.startsWith("attrib")){var a=e.slice(7),d=this._cf.attrib.nodes.find(function(e){return e._vf.name==a}),l=d._vf.value,h=d._vf.numComponents;for(this._mesh._dynamicFields[a].value=[],this._mesh._dynamicFields[a].numComponents=h,s=this._vf.index,r=0;r<s.length;++r)for(var u=0;h>u;u++)this._mesh._dynamicFields[a].value.push(l[h*s[r]+u]);Array.forEach(this._parentNodes,function(e){e._dirty.specialAttribs=!0})}}})),x3dom.registerNodeType("IndexedTriangleStripSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(e){x3dom.nodeTypes.IndexedTriangleStripSet.superClass.call(this,e),this.addField_MFInt32(e,"index",[]),this._hasIndexOffset=!1,this._indexOffset=null},{hasIndexOffset:function(){return this._hasIndexOffset},nodeChanged:function(){this.handleAttribs();var e=!1,t=!1,i=!1,o=this._vf.colorPerVertex,s=this._vf.normalPerVertex,r=this._vf.index;r.length&&-1!=r[r.length-1]&&r.push(-1);var n,a,d,l,h=this._cf.coord.node;x3dom.debug.assert(h),n=h._vf.point;var u=this._cf.normal.node;u?(e=!0,a=u._vf.vector):e=!1;var f="",_=2,c=this._cf.texCoord.node;x3dom.isa(c,x3dom.nodeTypes.MultiTextureCoordinate)&&c._cf.texCoord.nodes.length&&(c=c._cf.texCoord.nodes[0]),c?c._vf.point?(t=!0,d=c._vf.point,x3dom.isa(c,x3dom.nodeTypes.TextureCoordinate3D)&&(_=3)):c._vf.mode&&(f=c._vf.mode):t=!1,this._mesh._numTexComponents=_;var m=3,p=this._cf.color.node;p?(i=!0,l=p._vf.color,x3dom.isa(p,x3dom.nodeTypes.ColorRGBA)&&(m=4)):i=!1,this._mesh._numColComponents=m,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[],this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0;var x=0,g=0;if(e&&n.length<=x3dom.Utils.maxIndexableCoords){this._hasIndexOffset=!0,this._indexOffset=[],this._mesh._primType="TRIANGLESTRIP";var v=[0];for(D=0;D<r.length;D++)-1==r[D]?(x++,v.push(this._mesh._indices[0].length)):(this._mesh._indices[0].push(+r[D]),s||(this._mesh._normals[0].push(a[x].x),this._mesh._normals[0].push(a[x].y),this._mesh._normals[0].push(a[x].z)),o||(this._mesh._colors[0].push(l[x].r),this._mesh._colors[0].push(l[x].g),this._mesh._colors[0].push(l[x].b),4===m&&this._mesh._colors[0].push(l[x].a)));for(this._mesh._positions[0]=n.toGL(),s&&(this._mesh._normals[0]=a.toGL()),t?(this._mesh._texCoords[0]=d.toGL(),this._mesh._numTexComponents=_):x3dom.debug.logWarning("IndexedTriangleStripSet: no texCoords given and won't calculate!"),i&&(o&&(this._mesh._colors[0]=l.toGL()),this._mesh._numColComponents=m),D=1;D<v.length;D++){var y=v[D]-v[D-1];this._indexOffset.push({count:y,offset:2*v[D-1]}),this._mesh._numFaces+=y-2}this._mesh._numCoords=this._mesh._positions[0].length/3}else{this._hasIndexOffset=!1;for(var b,T,S,M,C,F,E,w,A,R,N,I,P=!1,D=1;D<r.length-2;++D)-1!=r[D+1]?(P?(b=r[D],T=r[D-1],S=r[D+1]):(b=r[D-1],T=r[D],S=r[D+1]),P=!P,s?(M=b,C=T,F=S):s||(M=C=F=x),E=b,w=T,A=S,o?(R=b,N=T,I=S):o||(R=N=I=x),this._mesh._indices[0].push(g++,g++,g++),this._mesh._positions[0].push(n[b].x),this._mesh._positions[0].push(n[b].y),this._mesh._positions[0].push(n[b].z),this._mesh._positions[0].push(n[T].x),this._mesh._positions[0].push(n[T].y),this._mesh._positions[0].push(n[T].z),this._mesh._positions[0].push(n[S].x),this._mesh._positions[0].push(n[S].y),this._mesh._positions[0].push(n[S].z),e&&(this._mesh._normals[0].push(a[M].x),this._mesh._normals[0].push(a[M].y),this._mesh._normals[0].push(a[M].z),this._mesh._normals[0].push(a[C].x),this._mesh._normals[0].push(a[C].y),this._mesh._normals[0].push(a[C].z),this._mesh._normals[0].push(a[F].x),this._mesh._normals[0].push(a[F].y),this._mesh._normals[0].push(a[F].z)),i&&(this._mesh._colors[0].push(l[R].r),this._mesh._colors[0].push(l[R].g),this._mesh._colors[0].push(l[R].b),4===m&&this._mesh._colors[0].push(l[R].a),this._mesh._colors[0].push(l[N].r),this._mesh._colors[0].push(l[N].g),this._mesh._colors[0].push(l[N].b),4===m&&this._mesh._colors[0].push(l[N].a),this._mesh._colors[0].push(l[I].r),this._mesh._colors[0].push(l[I].g),this._mesh._colors[0].push(l[I].b),4===m&&this._mesh._colors[0].push(l[I].a)),t&&(this._mesh._texCoords[0].push(d[E].x),this._mesh._texCoords[0].push(d[E].y),3===_&&this._mesh._texCoords[0].push(d[E].z),this._mesh._texCoords[0].push(d[w].x),this._mesh._texCoords[0].push(d[w].y),3===_&&this._mesh._texCoords[0].push(d[w].z),this._mesh._texCoords[0].push(d[A].x),this._mesh._texCoords[0].push(d[A].y),3===_&&this._mesh._texCoords[0].push(d[A].z))):(D+=2,x++);for(e||this._mesh.calcNormals(Math.PI),t||this._mesh.calcTexCoords(f),this._mesh.splitMesh(),this.invalidateVolume(),D=0;D<this._mesh._indices.length;D++)this._mesh._numFaces+=this._mesh._indices[D].length/3,this._mesh._numCoords+=this._mesh._positions[D].length/3}},fieldChanged:function(e){if("coord"!=e&&"normal"!=e&&"texCoord"!=e&&"color"!=e&&!e.startsWith("attrib"))return void x3dom.debug.logWarning("IndexedTriangleStripSet: fieldChanged for "+e+" not yet implemented!");var t=this._cf.coord.node._vf.point;if(null===this._cf.normal.node||t.length>x3dom.Utils.maxIndexableCoords){if("coord"==e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var i,o,s,r,n=!1,a=!1,d=!1,l=this._vf.colorPerVertex,h=this._vf.normalPerVertex,u=this._vf.index,f=this._cf.coord.node;x3dom.debug.assert(f),i=f._vf.point;var _=this._cf.normal.node;_?(n=!0,o=_._vf.vector):n=!1;var c="",m=2,p=this._cf.texCoord.node;x3dom.isa(p,x3dom.nodeTypes.MultiTextureCoordinate)&&p._cf.texCoord.nodes.length&&(p=p._cf.texCoord.nodes[0]),p?p._vf.point?(a=!0,s=p._vf.point,x3dom.isa(p,x3dom.nodeTypes.TextureCoordinate3D)&&(m=3)):p._vf.mode&&(c=p._vf.mode):a=!1,this._mesh._numTexComponents=m;var x=3,g=this._cf.color.node;g?(d=!0,r=g._vf.color,x3dom.isa(g,x3dom.nodeTypes.ColorRGBA)&&(x=4)):d=!1,this._mesh._numColComponents=x,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var v,y,b,T,S,M,C,F,E,w,A,R,N=0,I=0,P=!1;if(n||a||d){for(var D=1;D<u.length-2;++D)-1!=u[D+1]?(P?(v=u[D],y=u[D-1],b=u[D+1]):(v=u[D-1],y=u[D],b=u[D+1]),P=!P,h?(T=v,S=y,M=b):h||(T=S=M=N),C=v,F=y,E=b,l?(w=v,A=y,R=b):l||(w=A=R=N),this._mesh._indices[0].push(I++,I++,I++),this._mesh._positions[0].push(i[v].x),this._mesh._positions[0].push(i[v].y),this._mesh._positions[0].push(i[v].z),this._mesh._positions[0].push(i[y].x),this._mesh._positions[0].push(i[y].y),this._mesh._positions[0].push(i[y].z),this._mesh._positions[0].push(i[b].x),this._mesh._positions[0].push(i[b].y),this._mesh._positions[0].push(i[b].z),n&&(this._mesh._normals[0].push(o[T].x),this._mesh._normals[0].push(o[T].y),this._mesh._normals[0].push(o[T].z),this._mesh._normals[0].push(o[S].x),this._mesh._normals[0].push(o[S].y),this._mesh._normals[0].push(o[S].z),this._mesh._normals[0].push(o[M].x),this._mesh._normals[0].push(o[M].y),this._mesh._normals[0].push(o[M].z)),d&&(this._mesh._colors[0].push(r[w].r),this._mesh._colors[0].push(r[w].g),this._mesh._colors[0].push(r[w].b),4===x&&this._mesh._colors[0].push(r[w].a),this._mesh._colors[0].push(r[A].r),this._mesh._colors[0].push(r[A].g),this._mesh._colors[0].push(r[A].b),4===x&&this._mesh._colors[0].push(r[A].a),this._mesh._colors[0].push(r[R].r),this._mesh._colors[0].push(r[R].g),this._mesh._colors[0].push(r[R].b),4===x&&this._mesh._colors[0].push(r[R].a)),a&&(this._mesh._texCoords[0].push(s[C].x),this._mesh._texCoords[0].push(s[C].y),3===m&&this._mesh._texCoords[0].push(s[C].z),this._mesh._texCoords[0].push(s[F].x),this._mesh._texCoords[0].push(s[F].y),3===m&&this._mesh._texCoords[0].push(s[F].z),this._mesh._texCoords[0].push(s[E].x),this._mesh._texCoords[0].push(s[E].y),3===m&&this._mesh._texCoords[0].push(s[E].z))):(D+=2,N++);n||this._mesh.calcNormals(Math.PI),a||this._mesh.calcTexCoords(c),this._mesh.splitMesh()}else{for(var P=!1,D=1;D<u.length;++D)-1!=u[D+1]?(P?(this._mesh._indices[0].push(u[D]),this._mesh._indices[0].push(u[D-1]),this._mesh._indices[0].push(u[D+1])):(this._mesh._indices[0].push(u[D-1]),this._mesh._indices[0].push(u[D]),this._mesh._indices[0].push(u[D+1])),P=!P):D+=2;this._mesh._positions[0]=i.toGL(),n?this._mesh._normals[0]=o.toGL():this._mesh.calcNormals(Math.PI),a?(this._mesh._texCoords[0]=s.toGL(),this._mesh._numTexComponents=m):this._mesh.calcTexCoords(c),d&&(this._mesh._colors[0]=r.toGL(),this._mesh._numColComponents=x)}for(this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,D=0;D<this._mesh._indices.length;D++)this._mesh._numFaces+=this._mesh._indices[D].length/3,this._mesh._numCoords+=this._mesh._positions[D].length/3;Array.forEach(this._parentNodes,function(e){e.setAllDirty(),e.invalidateVolume()})}else if("color"==e){var V=this._cf.color.node._vf.color,N=0,w=A=R=0,x=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(x=4),this._mesh._colors[0]=[];var u=this._vf.index,P=!1;for(D=1;D<u.length-2;++D)-1!=u[D+1]?(this._vf.colorPerVertex?(P?(w=u[D],A=u[D-1],R=u[D+1]):(w=u[D-1],A=u[D],R=u[D+1]),P=!P):this._vf.colorPerVertex||(w=A=R=N),this._mesh._colors[0].push(V[w].r),this._mesh._colors[0].push(V[w].g),this._mesh._colors[0].push(V[w].b),4===x&&this._mesh._colors[0].push(V[w].a),this._mesh._colors[0].push(V[A].r),this._mesh._colors[0].push(V[A].g),this._mesh._colors[0].push(V[A].b),4===x&&this._mesh._colors[0].push(V[A].a),this._mesh._colors[0].push(V[R].r),this._mesh._colors[0].push(V[R].g),this._mesh._colors[0].push(V[R].b),4===x&&this._mesh._colors[0].push(V[R].a)):(D+=2,N++);Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})}else if("normal"==e){var L=this._cf.normal.node._vf.vector,N=0,T=S=M=0;this._mesh._normals[0]=[];var u=this._vf.index,P=!1;for(D=1;D<u.length-2;++D)-1!=u[D+1]?(this._vf.normalPerVertex?(P?(T=u[D],S=u[D-1],M=u[D+1]):(T=u[D-1],S=u[D],M=u[D+1]),P=!P):this._vf.normalPerVertex||(T=S=M=N),this._mesh._normals[0].push(L[T].x),this._mesh._normals[0].push(L[T].y),this._mesh._normals[0].push(L[T].z),this._mesh._normals[0].push(L[S].x),this._mesh._normals[0].push(L[S].y),
this._mesh._normals[0].push(L[S].z),this._mesh._normals[0].push(L[M].x),this._mesh._normals[0].push(L[M].y),this._mesh._normals[0].push(L[M].z)):(D+=2,N++);Array.forEach(this._parentNodes,function(e){e._dirty.normals=!0})}else if("texCoord"==e){var p=this._cf.texCoord.node;x3dom.isa(p,x3dom.nodeTypes.MultiTextureCoordinate)&&p._cf.texCoord.nodes.length&&(p=p._cf.texCoord.nodes[0]);var B=p._vf.point,C=F=E=0,m=2;x3dom.isa(p,x3dom.nodeTypes.TextureCoordinate3D)&&(m=3),this._mesh._texCoords[0]=[];var u=this._vf.index,P=!1;for(D=1;D<u.length-2;++D)-1!=u[D+1]?(P?(C=u[D],F=u[D-1],E=u[D+1]):(C=u[D-1],F=u[D],E=u[D+1]),P=!P,this._mesh._texCoords[0].push(B[C].x),this._mesh._texCoords[0].push(B[C].y),3===m&&this._mesh._texCoords[0].push(B[C].z),this._mesh._texCoords[0].push(B[F].x),this._mesh._texCoords[0].push(B[F].y),3===m&&this._mesh._texCoords[0].tex(V[F].z),this._mesh._texCoords[0].push(B[E].x),this._mesh._texCoords[0].push(B[E].y),3===m&&this._mesh._texCoords[0].push(B[E].z)):D+=2;Array.forEach(this._parentNodes,function(e){e._dirty.texcoords=!0})}if(e.startsWith("attrib")){{var u=this._vf.index,O=e.slice(7),k=this._cf.attrib.nodes.find(function(e){return e._vf.name==O}),U=k._vf.value,G=k._vf.numComponents;this._mesh._dynamicFields[O]}this._mesh._dynamicFields[O].numComponents=G;var X=0,z=[0,0,0];for(this._mesh._dynamicFields[O].value=[],D=0;D<u.length;++D)switch(X){case 0:z[0]=u[D]*G,X++;break;case 1:z[1]=u[D]*G,X++;break;case-1:X=0;break;default:z[2]=u[D]*G;for(var j=0;3>j;j++)for(var H=0;G>H;H++)this._mesh._dynamicFields[O].value.push(U[z[j]+H]);X%2?(z[0]=z[1],z[1]=z[2]):z[0]=z[2],X=-1==u[D+1]?-1:X+1}Array.forEach(this._parentNodes,function(e){e._dirty.specialAttribs=!0})}}else if("coord"==e)this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()});else if("color"==e){if(t=this._cf.color.node._vf.color,this._vf.colorPerVertex)this._mesh._colors[0]=t.toGL();else if(!this._vf.colorPerVertex){var N=0,x=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(x=4),this._mesh._colors[0]=[];var u=this._vf.index;for(D=0;D<u.length;++D)-1!=u[D]?(this._mesh._colors[0].push(t[N].r),this._mesh._colors[0].push(t[N].g),this._mesh._colors[0].push(t[N].b),4===x&&this._mesh._colors[0].push(t[N].a)):N++}Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})}else if("normal"==e){if(t=this._cf.normal.node._vf.vector,this._vf.normalPerVertex)this._mesh._normals[0]=t.toGL();else if(!this._vf.normalPerVertex){var u=this._vf.index;this._mesh._normals[0]=[];var N=0;for(D=0;D<u.length;++D)-1!=u[D]?(this._mesh._normals[0].push(t[N].x),this._mesh._normals[0].push(t[N].y),this._mesh._normals[0].push(t[N].z)):N++}Array.forEach(this._parentNodes,function(e){e._dirty.normals=!0})}else if("texCoord"==e){var p=this._cf.texCoord.node;x3dom.isa(p,x3dom.nodeTypes.MultiTextureCoordinate)&&p._cf.texCoord.nodes.length&&(p=p._cf.texCoord.nodes[0]),t=p._vf.point,this._mesh._texCoords[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.texcoords=!0})}else e.startsWith("attrib")&&(O=e.slice(7),k=this._cf.attrib.nodes.find(function(e){return e._vf.name==O}),U=k._vf.value,G=k._vf.numComponents,this._mesh._dynamicFields[O].numComponents=G,this._mesh._dynamicFields[O].value=U.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.specialAttribs=!0}))}})),x3dom.registerNodeType("TriangleSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(e){x3dom.nodeTypes.TriangleSet.superClass.call(this,e)},{_buildGeometry:function(){this.handleAttribs();var e,t,i,o,s=this._vf.colorPerVertex,r=this._vf.normalPerVertex,n=!1,a=!1,d=!1,l=this._cf.coord.node;if(x3dom.debug.assert(l),!l||l._vf.point.length<3)return void(this._vf.render=!1);e=l._vf.point;var h=this._cf.normal.node;h?(n=!0,t=h._vf.vector):n=!1;var u="",f=2,_=this._cf.texCoord.node;x3dom.isa(_,x3dom.nodeTypes.MultiTextureCoordinate)&&_._cf.texCoord.nodes.length&&(_=_._cf.texCoord.nodes[0]),_?_._vf.point?(a=!0,i=_._vf.point,x3dom.isa(_,x3dom.nodeTypes.TextureCoordinate3D)&&(f=3)):_._vf.mode&&(u=_._vf.mode):a=!1;var c=3,m=this._cf.color.node;for(m?(d=!0,o=m._vf.color,x3dom.isa(m,x3dom.nodeTypes.ColorRGBA)&&(c=4)):d=!1;e.length%3>0;)e.pop();this._mesh._indices[0]=new Array(e.length),this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var p,x=e.length/3,g=0;for(p=0;x>p;p++)this._mesh._indices[0][g]=g++,this._mesh._indices[0][g]=g++,this._mesh._indices[0][g]=g++,!r&&n&&(this._mesh._normals[0].push(t[p].x),this._mesh._normals[0].push(t[p].y),this._mesh._normals[0].push(t[p].z)),!s&&d&&(this._mesh._colors[0].push(o[p].r),this._mesh._colors[0].push(o[p].g),this._mesh._colors[0].push(o[p].b),4===c&&this._mesh._colors[0].push(o[p].a));this._mesh._positions[0]=e.toGL(),n?this._mesh._normals[0]=t.toGL():this._mesh.calcNormals(r?Math.PI:0),a?(this._mesh._texCoords[0]=i.toGL(),this._mesh._numTexComponents=f):this._mesh.calcTexCoords(u),d&&s&&(this._mesh._colors[0]=o.toGL(),this._mesh._numColComponents=c),this._mesh._numFaces=x,this._mesh._numCoords=e.length,this.invalidateVolume()},nodeChanged:function(){this._buildGeometry()},fieldChanged:function(e){"coord"==e?(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})):"color"==e?(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})):"normal"==e?(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.normals=!0})):"texCoord"==e?(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.texcoords=!0})):e.startsWith("attrib")&&(this._buildGeometry(),Array.forEach(this._parentNodes,function(e){e._dirty.specialAttribs=!0}))}})),x3dom.registerNodeType("X3DGeometricPropertyNode","Rendering",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DGeometricPropertyNode.superClass.call(this,e)})),x3dom.registerNodeType("X3DCoordinateNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.X3DCoordinateNode.superClass.call(this,e)},{fieldChanged:function(e){("coord"===e||"point"===e)&&Array.forEach(this._parentNodes,function(e){e.fieldChanged("coord")})},parentAdded:function(e){e._mesh&&e._cf.coord.node!==this&&e.fieldChanged("coord")}})),x3dom.registerNodeType("Coordinate","Rendering",defineClass(x3dom.nodeTypes.X3DCoordinateNode,function(e){x3dom.nodeTypes.Coordinate.superClass.call(this,e),this.addField_MFVec3f(e,"point",[])},{getPoints:function(){return this._vf.point}})),x3dom.registerNodeType("Normal","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.Normal.superClass.call(this,e),this.addField_MFVec3f(e,"vector",[])},{fieldChanged:function(e){("normal"===e||"vector"===e)&&Array.forEach(this._parentNodes,function(e){e.fieldChanged("normal")})},parentAdded:function(e){e._mesh&&e._cf.normal.node!==this&&e.fieldChanged("normal")}})),x3dom.registerNodeType("X3DColorNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.X3DColorNode.superClass.call(this,e)},{fieldChanged:function(e){"color"===e&&Array.forEach(this._parentNodes,function(e){e.fieldChanged("color")})},parentAdded:function(e){e._mesh&&e._cf.color.node!==this&&e.fieldChanged("color")}})),x3dom.registerNodeType("Color","Rendering",defineClass(x3dom.nodeTypes.X3DColorNode,function(e){x3dom.nodeTypes.Color.superClass.call(this,e),this.addField_MFColor(e,"color",[])})),x3dom.registerNodeType("ColorRGBA","Rendering",defineClass(x3dom.nodeTypes.X3DColorNode,function(e){x3dom.nodeTypes.ColorRGBA.superClass.call(this,e),this.addField_MFColorRGBA(e,"color",[])})),x3dom.registerNodeType("ParticleSet","Rendering",defineClass(x3dom.nodeTypes.PointSet,function(e){x3dom.nodeTypes.ParticleSet.superClass.call(this,e),this.addField_SFString(e,"mode","ViewDirQuads"),this.addField_SFString(e,"drawOrder","Any"),this.addField_SFNode("normal",x3dom.nodeTypes.Normal),this.addField_MFVec3f(e,"size",[]),this.addField_MFInt32(e,"index",[]),this.addField_MFFloat(e,"textureZ",[]),this._mesh._primType="POINTS"},{drawOrder:function(){return this._vf.drawOrder.toLowerCase()},nodeChanged:function(){var e=this._cf.coord.node;x3dom.debug.assert(e,"ParticleSet without coord node!");var t=e.getPoints(),i=3,o=this._cf.color.node,s=new x3dom.fields.MFColor;o&&(s=o._vf.color,x3dom.debug.assert(t.length==s.length,"Size of color and coord array differs!"),x3dom.isa(o,x3dom.nodeTypes.ColorRGBA)&&(i=4));var r=this._cf.normal.node,n=new x3dom.fields.MFVec3f;r&&(n=r._vf.vector);var a=[];if("any"!=this.drawOrder()&&(a=this._vf.index.toGL(),0==a.length)){var d,l=t.length;for(a=new Array(l),d=0;l>d;d++)a[d]=d}this._mesh._numColComponents=i,this._mesh._lit=!1,this._mesh._indices[0]=a,this._mesh._positions[0]=t.toGL(),this._mesh._colors[0]=s.toGL(),this._mesh._normals[0]=n.toGL(),this._mesh._texCoords[0]=[],this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(e){var t=null;if("index"==e)this._mesh._indices[0]=this._vf.index.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.indexes=!0});else if("size"==e)Array.forEach(this._parentNodes,function(e){e._dirty.specialAttribs=!0});else if("coord"==e){t=this._cf.coord.node.getPoints(),this._mesh._positions[0]=t.toGL();var i=[];if("any"!=this.drawOrder()&&(i=this._vf.index.toGL(),0==i.length)){var o,s=t.length;for(i=new Array(s),o=0;s>o;o++)i[o]=o}this._mesh._indices[0]=i,this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e._dirty.indexes=!0,e.invalidateVolume()})}else"color"==e&&(t=this._cf.color.node._vf.color,this._mesh._colors[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0}))}})),x3dom.registerNodeType("CustomAttributeNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.CustomAttributeNode.superClass.call(this,e),this.addField_MFNode("uniforms",x3dom.nodeTypes.Uniform),this.addField_MFNode("varyings",x3dom.nodeTypes.Varying),this.addField_SFString(e,"vertexShaderPartMain",""),this.addField_SFString(e,"fragmentShaderPartMain","")},{get:function(e){return this._vf[e]},addUniform:function(e,t,i){void 0==this._cf.uniforms&&(this._cf.uniforms=new x3dom.fields.MFNode(x3dom.nodeTypes.Uniform));var o=new x3dom.nodeTypes.Uniform;o._vf.name=e,o._vf.type=i,o._vf.value=t,this._cf.uniforms.nodes.push(o)},addVarying:function(e,t){void 0==this._cf.varyings&&(this._cf.varyings=new x3dom.fields.MFNode(x3dom.nodeTypes.Varying));var i=new x3dom.nodeTypes.Varying;i._vf.name=e,i._vf.type=t,this._cf.varyings.nodes.push(i)},addVertexShaderPart:function(e){this._vf.vertexShaderPartMain=e},addFragmentShaderPart:function(e){this._vf.fragmentShaderPartMain=e},attributeNameChanged:function(e){{var t,i,o,s;this._vf[e]}Array.forEach(this._parentNodes,function(e){for(t=0,i=e._parentNodes.length;i>t;t++)o=e._parentNodes[t],o._dirty.shader=!0,s=o._webgl.shader,s[e._cf.threshold.node._vf.dataName]||setUpWebglBuffer(o,e)})},updateUniform:function(e,t){var i=this._cf.uniforms.nodes.find(function(e){return e._vf.name==t});i&&(i._vf.value=this._vf[e],i.fieldChanged("value"))}})),x3dom.registerNodeType("ClipPlane","Rendering",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.ClipPlane.superClass.call(this,e),this.addField_SFBool(e,"enabled",!0),this.addField_SFVec4f(e,"plane",0,1,0,0),this.addField_SFFloat(e,"cappingStrength",0),this.addField_SFColor(e,"cappingColor",1,1,1),this.addField_SFBool(e,"on",!0)},{fieldChanged:function(e){},nodeChanged:function(){x3dom.nodeTypes.ClipPlane.count++},onRemove:function(){x3dom.nodeTypes.ClipPlane.count--},parentAdded:function(){},parentRemoved:function(){}})),x3dom.nodeTypes.ClipPlane.count=0,x3dom.registerNodeType("X3DAppearanceNode","Shape",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DAppearanceNode.superClass.call(this,e)})),x3dom.registerNodeType("Appearance","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceNode,function(e){x3dom.nodeTypes.Appearance.superClass.call(this,e),this.addField_SFNode("material",x3dom.nodeTypes.X3DMaterialNode),this.addField_SFNode("texture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("textureTransform",x3dom.nodeTypes.X3DTextureTransformNode),this.addField_SFNode("lineProperties",x3dom.nodeTypes.LineProperties),this.addField_SFNode("colorMaskMode",x3dom.nodeTypes.ColorMaskMode),this.addField_SFNode("blendMode",x3dom.nodeTypes.BlendMode),this.addField_SFNode("depthMode",x3dom.nodeTypes.DepthMode),this.addField_MFNode("shaders",x3dom.nodeTypes.X3DShaderNode),this.addField_SFString(e,"sortType","auto"),this.addField_SFInt32(e,"sortKey",0),this.addField_SFFloat(e,"alphaClipThreshold",.1),this._shader=null},{fieldChanged:function(e){"alphaClipThreshold"==e&&Array.forEach(this._parentNodes,function(e){e.setAppDirty()})},nodeChanged:function(){!this._cf.material.node,this._cf.shaders.nodes.length?this._shader=this._cf.shaders.nodes[0]:this._shader&&(this._shader=null),Array.forEach(this._parentNodes,function(e){e.setAppDirty()}),this.checkSortType()},checkSortType:function(){"auto"==this._vf.sortType&&(this._vf.sortType=this._cf.material.node&&(this._cf.material.node._vf.transparency>0||this._cf.material.node._vf.backTransparency&&this._cf.material.node._vf.backTransparency>0)?"transparent":this._cf.texture.node&&this._cf.texture.node._vf.url.length&&this._cf.texture.node._vf.url[0].toLowerCase().indexOf(".png")>=0?"transparent":"opaque")},texTransformMatrix:function(){return null===this._cf.textureTransform.node?x3dom.fields.SFMatrix4f.identity():this._cf.textureTransform.node.texTransformMatrix()},parentAdded:function(e){this!=x3dom.nodeTypes.Appearance._defaultNode&&e.setAppDirty()}})),x3dom.nodeTypes.Appearance.defaultNode=function(){return x3dom.nodeTypes.Appearance._defaultNode||(x3dom.nodeTypes.Appearance._defaultNode=new x3dom.nodeTypes.Appearance,x3dom.nodeTypes.Appearance._defaultNode.nodeChanged()),x3dom.nodeTypes.Appearance._defaultNode},x3dom.registerNodeType("X3DAppearanceChildNode","Shape",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DAppearanceChildNode.superClass.call(this,e)})),x3dom.registerNodeType("BlendMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.BlendMode.superClass.call(this,e),this.addField_SFString(e,"srcFactor","src_alpha"),this.addField_SFString(e,"destFactor","one_minus_src_alpha"),this.addField_SFColor(e,"color",1,1,1),this.addField_SFFloat(e,"colorTransparency",0),this.addField_SFString(e,"alphaFunc","none"),this.addField_SFFloat(e,"alphaFuncValue",0),this.addField_SFString(e,"equation","none")})),x3dom.registerNodeType("DepthMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.DepthMode.superClass.call(this,e),this.addField_SFBool(e,"enableDepthTest",!0),this.addField_SFString(e,"depthFunc","none"),this.addField_SFBool(e,"readOnly",!1),this.addField_SFFloat(e,"zNearRange",-1),this.addField_SFFloat(e,"zFarRange",-1)})),x3dom.registerNodeType("ColorMaskMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.ColorMaskMode.superClass.call(this,e),this.addField_SFBool(e,"maskR",!0),this.addField_SFBool(e,"maskG",!0),this.addField_SFBool(e,"maskB",!0),this.addField_SFBool(e,"maskA",!0)})),x3dom.registerNodeType("LineProperties","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.LineProperties.superClass.call(this,e),this.addField_SFBool(e,"applied",!0),this.addField_SFInt32(e,"linetype",1),this.addField_SFFloat(e,"linewidthScaleFactor",0)})),x3dom.registerNodeType("X3DMaterialNode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.X3DMaterialNode.superClass.call(this,e)})),x3dom.registerNodeType("Material","Shape",defineClass(x3dom.nodeTypes.X3DMaterialNode,function(e){x3dom.nodeTypes.Material.superClass.call(this,e),this.addField_SFFloat(e,"ambientIntensity",.2),this.addField_SFColor(e,"diffuseColor",.8,.8,.8),this.addField_SFColor(e,"emissiveColor",0,0,0),this.addField_SFFloat(e,"shininess",.2),this.addField_SFColor(e,"specularColor",0,0,0),this.addField_SFFloat(e,"transparency",0)},{fieldChanged:function(e){("ambientIntensity"==e||"diffuseColor"==e||"emissiveColor"==e||"shininess"==e||"specularColor"==e||"transparency"==e)&&Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e._dirty.material=!0}),e.checkSortType()})}})),x3dom.nodeTypes.Material.defaultNode=function(){return x3dom.nodeTypes.Material._defaultNode||(x3dom.nodeTypes.Material._defaultNode=new x3dom.nodeTypes.Material,x3dom.nodeTypes.Material._defaultNode.nodeChanged()),x3dom.nodeTypes.Material._defaultNode},x3dom.registerNodeType("TwoSidedMaterial","Shape",defineClass(x3dom.nodeTypes.Material,function(e){x3dom.nodeTypes.TwoSidedMaterial.superClass.call(this,e),this.addField_SFFloat(e,"backAmbientIntensity",.2),this.addField_SFColor(e,"backDiffuseColor",.8,.8,.8),this.addField_SFColor(e,"backEmissiveColor",0,0,0),this.addField_SFFloat(e,"backShininess",.2),this.addField_SFColor(e,"backSpecularColor",0,0,0),this.addField_SFFloat(e,"backTransparency",0),this.addField_SFBool(e,"separateBackColor",!1)},{fieldChanged:function(e){("ambientIntensity"==e||"diffuseColor"==e||"emissiveColor"==e||"shininess"==e||"specularColor"==e||"transparency"==e||"backAmbientIntensity"==e||"backDiffuseColor"==e||"backEmissiveColor"==e||"backShininess"==e||"backSpecularColor"==e||"backTransparency"==e||"separateBackColor"==e)&&Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e._dirty.material=!0}),e.checkSortType()})}})),x3dom.registerNodeType("X3DShapeNode","Shape",defineClass(x3dom.nodeTypes.X3DBoundedObject,function(e){x3dom.nodeTypes.X3DShapeNode.superClass.call(this,e),this.addField_SFBool(e,"isPickable",!0),this.addField_SFInt32(e,"idOffset",0),this.addField_SFNode("appearance",x3dom.nodeTypes.X3DAppearanceNode),this.addField_SFNode("geometry",x3dom.nodeTypes.X3DGeometryNode),this._objectID=0,this._shaderProperties=null,this._clipPlanes=[],this._cleanupGLObjects=null,this._dirty={positions:!0,normals:!0,texcoords:!0,colors:!0,specialAttribs:!0,indexes:!0,texture:!0,material:!0,text:!0,shader:!0,ids:!0},this._coordStrideOffset=[0,0],this._normalStrideOffset=[0,0],this._texCoordStrideOffset=[0,0],this._colorStrideOffset=[0,0],this._idStrideOffset=[0,0],this._tessellationProperties=[]},{collectDrawableObjects:function(e,t,i,o,s,r){var n=this.graphState();return i&&this._parentNodes.length>1&&(i=!1),i&&(o=o||this.cacheInvalid())&&this.invalidateCache(),!this._cf.geometry.node||t.cull(e,n,i,s)<=0?!1:(i&&!this._graph.globalMatrix&&(this._graph.globalMatrix=e),this._clipPlanes.length!=r.length&&(this._dirty.shader=!0),this._clipPlanes=r,t.addShape(this,e,n),!0)},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this._vf.render){var t=this._cf.geometry.node,i=t?t.getVolume():null;i&&i.isValid()&&e.extendBounds(i.min,i.max)}return e},getCenter:function(){var e=this._cf.geometry.node;return e?e.getCenter():new x3dom.fields.SFVec3f(0,0,0)},getDiameter:function(){var e=this._cf.geometry.node;return e?e.getDiameter():0},doIntersect:function(e){return this._cf.geometry.node.doIntersect(e)},forceUpdateCoverage:function(){var e=this._cf.geometry.node;return e?e.forceUpdateCoverage():!1},tessellationProperties:function(){var e=this._cf.geometry.node;return e&&e._indexOffset?e._indexOffset:this._tessellationProperties},isLit:function(){return this._cf.geometry.node._vf.lit},isSolid:function(){var e=this._cf.appearance.node&&this._cf.appearance.node._cf.material.node&&x3dom.isa(this._cf.appearance.node._cf.material.node,x3dom.nodeTypes.TwoSidedMaterial);return this._cf.geometry.node._vf.solid&&!e},isCCW:function(){return this._cf.geometry.node._vf.ccw},parentRemoved:function(e){for(var t=0,i=this._childNodes.length;i>t;t++){var o=this._childNodes[t];o&&o.parentRemoved(this)}e&&e.invalidateVolume(),this._parentNodes.length>0&&this.invalidateVolume(),this._cleanupGLObjects&&this._cleanupGLObjects()},unsetDirty:function(){this._dirty.positions=!1,this._dirty.normals=!1,this._dirty.texcoords=!1,this._dirty.colors=!1,this._dirty.specialAttribs=!1,this._dirty.indexes=!1,this._dirty.texture=!1,this._dirty.material=!1,this._dirty.text=!1,this._dirty.shader=!1},unsetGeoDirty:function(){this._dirty.positions=!1,this._dirty.normals=!1,this._dirty.texcoords=!1,this._dirty.colors=!1,this._dirty.specialAttribs=!1,this._dirty.indexes=!1},setAllDirty:function(){this._dirty.positions=!0,this._dirty.normals=!0,this._dirty.texcoords=!0,this._dirty.colors=!0,this._dirty.specialAttribs=!0,this._dirty.indexes=!0,this._dirty.texture=!0,this._dirty.material=!0,this._dirty.text=!0,this._dirty.shader=!0,this.invalidateVolume()},setAppDirty:function(){this._dirty.texture=!0,this._dirty.material=!0,this._dirty.shader=!0},setGeoDirty:function(){this._dirty.positions=!0,this._dirty.normals=!0,this._dirty.texcoords=!0,this._dirty.colors=!0,this._dirty.specialAttribs=!0,this._dirty.indexes=!0,this.invalidateVolume()},getShaderProperties:function(e){return(null==this._shaderProperties||1==this._dirty.shader||void 0!==this._webgl&&this._webgl.dirtyLighting!=x3dom.Utils.checkDirtyLighting(e)||1==x3dom.Utils.checkDirtyEnvironment(e,this._shaderProperties))&&(this._shaderProperties=x3dom.Utils.generateProperties(e,this),this._dirty.shader=!1,void 0!==this._webgl&&(this._webgl.dirtyLighting=x3dom.Utils.checkDirtyLighting(e))),this._shaderProperties},getTextures:function(){var e=[],t=this._cf.appearance.node;if(t){var i=t._cf.texture.node;i&&(x3dom.isa(i,x3dom.nodeTypes.MultiTexture)?e=e.concat(i.getTextures()):e.push(i));var o=t._cf.shaders.nodes[0];o&&x3dom.isa(o,x3dom.nodeTypes.CommonSurfaceShader)&&(e=e.concat(o.getTextures()))}var s=this._cf.geometry.node;return s&&(x3dom.isa(s,x3dom.nodeTypes.ImageGeometry)?e=e.concat(s.getTextures()):x3dom.isa(s,x3dom.nodeTypes.Text)&&(e=e.concat(s))),e}})),x3dom.registerNodeType("Shape","Shape",defineClass(x3dom.nodeTypes.X3DShapeNode,function(e){x3dom.nodeTypes.Shape.superClass.call(this,e)},{nodeChanged:function(){!this._cf.appearance.node,this._cf.geometry.node?this._objectID||(this._objectID=++x3dom.nodeTypes.Shape.objectID,x3dom.nodeTypes.Shape.idMap.nodeID[this._objectID]=this):this._DEF&&x3dom.debug.logError("No geometry given in Shape/"+this._DEF),this.invalidateVolume()}})),x3dom.nodeTypes.Shape.shaderPartID=0,x3dom.nodeTypes.Shape.objectID=0,x3dom.nodeTypes.Shape.idMap={nodeID:{},remove:function(e){for(var t in this.nodeID)if(this.nodeID.hasOwnProperty(t)){var i=this.nodeID[t];i._objectID&&e._objectID&&i._objectID===e._objectID&&(delete this.nodeID[t],x3dom.debug.logInfo("Unreg "+i._objectID))}}},x3dom.registerNodeType("X3DLightNode","Lighting",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DLightNode.superClass.call(this,e),e?e.doc._nodeBag.lights.push(this):x3dom.debug.logWarning("X3DLightNode: No runtime context found!"),this._lightID=0,this._dirty=!0,this.addField_SFFloat(e,"ambientIntensity",0),this.addField_SFColor(e,"color",1,1,1),this.addField_SFFloat(e,"intensity",1),this.addField_SFBool(e,"global",!1),this.addField_SFBool(e,"on",!0),this.addField_SFFloat(e,"shadowIntensity",0),this.addField_SFInt32(e,"shadowMapSize",1024),this.addField_SFInt32(e,"shadowFilterSize",0),this.addField_SFFloat(e,"shadowOffset",0),this.addField_SFFloat(e,"zNear",-1),this.addField_SFFloat(e,"zFar",-1)},{getViewMatrix:function(){return x3dom.fields.SFMatrix4f.identity},nodeChanged:function(){this._lightID||(this._lightID=++x3dom.nodeTypes.X3DLightNode.lightID)},fieldChanged:function(e){this._vf.hasOwnProperty(e)&&(this._dirty=!0)},parentRemoved:function(e){if(1===this._parentNodes.length&&this._parentNodes[0]==e)for(var t=this.findX3DDoc(),i=0,o=t._nodeBag.lights.length;o>i;i++)t._nodeBag.lights[i]===this&&t._nodeBag.lights.splice(i,1)},onRemove:function(){console.log("remove")}})),x3dom.nodeTypes.X3DLightNode.lightID=0,x3dom.registerNodeType("DirectionalLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(e){x3dom.nodeTypes.DirectionalLight.superClass.call(this,e),this.addField_SFVec3f(e,"direction",0,0,-1),this.addField_SFInt32(e,"shadowCascades",1),this.addField_SFFloat(e,"shadowSplitFactor",1),this.addField_SFFloat(e,"shadowSplitOffset",.1)},{getViewMatrix:function(e){var t=this.getCurrentTransform().multMatrixVec(this._vf.direction).normalize(),i=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),t);return i.toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(e.negate()))}})),x3dom.registerNodeType("PointLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(e){x3dom.nodeTypes.PointLight.superClass.call(this,e),this.addField_SFVec3f(e,"attenuation",1,0,0),this.addField_SFVec3f(e,"location",0,0,0),this.addField_SFFloat(e,"radius",100),this._vf.global=!0},{getViewMatrix:function(e){var t=this.getCurrentTransform().multMatrixPnt(this._vf.location),i=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),e);return i.toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(t.negate()))}})),x3dom.registerNodeType("SpotLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(e){x3dom.nodeTypes.SpotLight.superClass.call(this,e),this.addField_SFVec3f(e,"direction",0,0,-1),this.addField_SFVec3f(e,"attenuation",1,0,0),this.addField_SFVec3f(e,"location",0,0,0),this.addField_SFFloat(e,"radius",100),this.addField_SFFloat(e,"beamWidth",1.5707963),this.addField_SFFloat(e,"cutOffAngle",1.5707963),this.addField_SFInt32(e,"shadowCascades",1),this.addField_SFFloat(e,"shadowSplitFactor",1),this.addField_SFFloat(e,"shadowSplitOffset",.1),this._vf.global=!0},{getViewMatrix:function(){var e=this.getCurrentTransform().multMatrixPnt(this._vf.location),t=this.getCurrentTransform().multMatrixVec(this._vf.direction).normalize(),i=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),t);return i.toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(e.negate()))}})),x3dom.registerNodeType("X3DFollowerNode","Followers",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DFollowerNode.superClass.call(this,e),e?e.doc._nodeBag.followers.push(this):x3dom.debug.logWarning("X3DFollowerNode: No runtime context found!"),this.addField_SFBool(e,"isActive",!1),this._eps=x3dom.fields.Eps},{parentRemoved:function(){if(0===this._parentNodes.length)for(var e=this.findX3DDoc(),t=0,i=e._nodeBag.followers.length;i>t;t++)e._nodeBag.followers[t]===this&&e._nodeBag.followers.splice(t,1)},tick:function(){return!1},stepResponse:function(e){return 0>=e?0:e>=this._vf.duration?1:this.stepResponseCore(e/this._vf.duration)},stepResponseCore:function(e){return.5-.5*Math.cos(e*Math.PI)}})),x3dom.registerNodeType("X3DChaserNode","Followers",defineClass(x3dom.nodeTypes.X3DFollowerNode,function(e){x3dom.nodeTypes.X3DChaserNode.superClass.call(this,e),this.addField_SFTime(e,"duration",1),this._initDone=!1,this._stepTime=0,this._currTime=0,this._bufferEndTime=0,this._numSupports=60})),x3dom.registerNodeType("X3DDamperNode","Followers",defineClass(x3dom.nodeTypes.X3DFollowerNode,function(e){x3dom.nodeTypes.X3DDamperNode.superClass.call(this,e),this.addField_SFTime(e,"tau",.3),this.addField_SFFloat(e,"tolerance",-1),this.addField_SFInt32(e,"order",3),this._eps=this._vf.tolerance<0?this._eps:this._vf.tolerance,this._lastTick=0})),x3dom.registerNodeType("ColorChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.ColorChaser.superClass.call(this,e),this.addField_SFColor(e,"initialDestination",.8,.8,.8),this.addField_SFColor(e,"initialValue",.8,.8,.8),this.addField_SFColor(e,"value",0,0,0),this.addField_SFColor(e,"destination",0,0,0),this._buffer=new x3dom.fields.MFColor,this._previousValue=new x3dom.fields.SFColor(0,0,0),this._value=new x3dom.fields.SFColor(0,0,0),this.initialize()},{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=this._vf.initialDestination,this._buffer.length=this._numSupports,this._buffer[0]=this._vf.initialDestination;for(var e=1;e<this._buffer.length;e++)this._buffer[e]=this._vf.initialValue;this._previousValue=this._vf.initialValue,this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=this._vf.initialValue,this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=this._previousValue,o=this._buffer[this._buffer.length-1].subtract(this._previousValue),s=o.multiply(this.stepResponse((this._buffer.length-1+t)*this._stepTime));i=i.add(s);for(var r=this._buffer.length-2;r>=0;r--)o=this._buffer[r].subtract(this._buffer[r+1]),s=o.multiply(this.stepResponse((r+t)*this._stepTime)),i=i.add(s);return i.equals(this._value,this._eps)?this.postMessage("isActive",!1):(this._value.setValues(i),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,o,s=(e-this._bufferEndTime)/this._stepTime;if(s>=1){if(i=Math.floor(s),s-=i,i<this._buffer.length){for(this._previousValue=this._buffer[this._buffer.length-i],t=this._buffer.length-1;t>=i;t--)this._buffer[t]=this._buffer[t-i];for(t=0;i>t;t++)o=t/i,this._buffer[t]=this._buffer[i].multiply(o).add(this._vf.destination.multiply(1-o))}else for(this._previousValue=i==this._buffer.length?this._buffer[0]:this._vf.destination,t=0;t<this._buffer.length;t++)this._buffer[t]=this._vf.destination;this._bufferEndTime+=i*this._stepTime}return s}})),x3dom.registerNodeType("ColorDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.ColorDamper.superClass.call(this,e),this.addField_SFColor(e,"initialDestination",.8,.8,.8),this.addField_SFColor(e,"initialValue",.8,.8,.8),this.addField_SFColor(e,"value",0,0,0),this.addField_SFColor(e,"destination",0,0,0),this._value0=new x3dom.fields.SFColor(0,0,0),this._value1=new x3dom.fields.SFColor(0,0,0),this._value2=new x3dom.fields.SFColor(0,0,0),this._value3=new x3dom.fields.SFColor(0,0,0),this._value4=new x3dom.fields.SFColor(0,0,0),this._value5=new x3dom.fields.SFColor(0,0,0),this.initialize()},{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},distance:function(e,t){var i=e.subtract(t);return Math.sqrt(i.r*i.r+i.g*i.g+i.b*i.b);

},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(i)):new x3dom.fields.SFColor(this._value0.r,this._value0.g,this._value0.b),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(i)):new x3dom.fields.SFColor(this._value1.r,this._value1.g,this._value1.b),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(i)):new x3dom.fields.SFColor(this._value2.r,this._value2.g,this._value2.b),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(i)):new x3dom.fields.SFColor(this._value3.r,this._value3.g,this._value3.b),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(i)):new x3dom.fields.SFColor(this._value4.r,this._value4.g,this._value4.b);var o=this.distance(this._value1,this._value0);if(this._vf.order>1){var s=this.distance(this._value2,this._value1);s>o&&(o=s)}if(this._vf.order>2){var r=this.distance(this._value3,this._value2);r>o&&(o=r)}if(this._vf.order>3){var n=this.distance(this._value4,this._value3);n>o&&(o=n)}if(this._vf.order>4){var a=this.distance(this._value5,this._value4);a>o&&(o=a)}return o<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("OrientationChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.OrientationChaser.superClass.call(this,e),this.addField_SFRotation(e,"initialDestination",0,1,0,0),this.addField_SFRotation(e,"initialValue",0,1,0,0),this.addField_SFRotation(e,"value",0,1,0,0),this.addField_SFRotation(e,"destination",0,1,0,0),this._numSupports=30,this._buffer=new x3dom.fields.MFRotation,this._previousValue=new x3dom.fields.Quaternion(0,1,0,0),this._value=new x3dom.fields.Quaternion(0,1,0,0),this.initialize()},{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=x3dom.fields.Quaternion.copy(this._vf.initialDestination),this._buffer.length=this._numSupports,this._buffer[0]=x3dom.fields.Quaternion.copy(this._vf.initialDestination);for(var e=1;e<this._buffer.length;e++)this._buffer[e]=x3dom.fields.Quaternion.copy(this._vf.initialValue);this._previousValue=x3dom.fields.Quaternion.copy(this._vf.initialValue),this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=x3dom.fields.Quaternion.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=x3dom.fields.Quaternion.copy(this._previousValue),o=this._previousValue.inverse().multiply(this._buffer[this._buffer.length-1]);i=i.slerp(i.multiply(o),this.stepResponse((this._buffer.length-1+t)*this._stepTime));for(var s=this._buffer.length-2;s>=0;s--)o=this._buffer[s+1].inverse().multiply(this._buffer[s]),i=i.slerp(i.multiply(o),this.stepResponse((s+t)*this._stepTime));return i.equals(this._value,this._eps)?this.postMessage("isActive",!1):(i=i.normalize(i),this._value.setValues(i),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,o,s=(e-this._bufferEndTime)/this._stepTime;if(s>=1){if(i=Math.floor(s),s-=i,i<this._buffer.length){for(this._previousValue=x3dom.fields.Quaternion.copy(this._buffer[this._buffer.length-i]),t=this._buffer.length-1;t>=i;t--)this._buffer[t]=x3dom.fields.Quaternion.copy(this._buffer[t-i]);for(t=0;i>t;t++)o=t/i,this._buffer[t]=this._vf.destination.slerp(this._buffer[i],o)}else for(this._previousValue=x3dom.fields.Quaternion.copy(i==this._buffer.length?this._buffer[0]:this._vf.destination),t=0;t<this._buffer.length;t++)this._buffer[t]=x3dom.fields.Quaternion.copy(this._vf.destination);this._bufferEndTime+=i*this._stepTime}return s}})),x3dom.registerNodeType("OrientationDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.OrientationDamper.superClass.call(this,e),this.addField_SFRotation(e,"initialDestination",0,1,0,0),this.addField_SFRotation(e,"initialValue",0,1,0,0),this.addField_SFRotation(e,"value",0,1,0,0),this.addField_SFRotation(e,"destination",0,1,0,0),this._value0=new x3dom.fields.Quaternion(0,1,0,0),this._value1=new x3dom.fields.Quaternion(0,1,0,0),this._value2=new x3dom.fields.Quaternion(0,1,0,0),this._value3=new x3dom.fields.Quaternion(0,1,0,0),this._value4=new x3dom.fields.Quaternion(0,1,0,0),this._value5=new x3dom.fields.Quaternion(0,1,0,0),this.initialize()},{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.slerp(this._value1,i):new x3dom.fields.Quaternion(this._value0.x,this._value0.y,this._value0.z,this._value0.w),this._value2=this._vf.order>1&&this._vf.tau?this._value1.slerp(this._value2,i):new x3dom.fields.Quaternion(this._value1.x,this._value1.y,this._value1.z,this._value1.w),this._value3=this._vf.order>2&&this._vf.tau?this._value2.slerp(this._value3,i):new x3dom.fields.Quaternion(this._value2.x,this._value2.y,this._value2.z,this._value2.w),this._value4=this._vf.order>3&&this._vf.tau?this._value3.slerp(this._value4,i):new x3dom.fields.Quaternion(this._value3.x,this._value3.y,this._value3.z,this._value3.w),this._value5=this._vf.order>4&&this._vf.tau?this._value4.slerp(this._value5,i):new x3dom.fields.Quaternion(this._value4.x,this._value4.y,this._value4.z,this._value4.w);var o=Math.abs(this._value1.inverse().multiply(this._value0).angle());if(this._vf.order>1){var s=Math.abs(this._value2.inverse().multiply(this._value1).angle());s>o&&(o=s)}if(this._vf.order>2){var r=Math.abs(this._value3.inverse().multiply(this._value2).angle());r>o&&(o=r)}if(this._vf.order>3){var n=Math.abs(this._value4.inverse().multiply(this._value3).angle());n>o&&(o=n)}if(this._vf.order>4){var a=Math.abs(this._value5.inverse().multiply(this._value4).angle());a>o&&(o=a)}return o<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("PositionChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.PositionChaser.superClass.call(this,e),this.addField_SFVec3f(e,"initialDestination",0,0,0),this.addField_SFVec3f(e,"initialValue",0,0,0),this.addField_SFVec3f(e,"value",0,0,0),this.addField_SFVec3f(e,"destination",0,0,0),this._buffer=new x3dom.fields.MFVec3f,this._previousValue=new x3dom.fields.SFVec3f(0,0,0),this._value=new x3dom.fields.SFVec3f(0,0,0),this.initialize()},{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=x3dom.fields.SFVec3f.copy(this._vf.initialDestination),this._buffer.length=this._numSupports,this._buffer[0]=x3dom.fields.SFVec3f.copy(this._vf.initialDestination);for(var e=1;e<this._buffer.length;e++)this._buffer[e]=x3dom.fields.SFVec3f.copy(this._vf.initialValue);this._previousValue=x3dom.fields.SFVec3f.copy(this._vf.initialValue),this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=x3dom.fields.SFVec3f.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=x3dom.fields.SFVec3f.copy(this._previousValue),o=this._buffer[this._buffer.length-1].subtract(this._previousValue),s=o.multiply(this.stepResponse((this._buffer.length-1+t)*this._stepTime));i=i.add(s);for(var r=this._buffer.length-2;r>=0;r--)o=this._buffer[r].subtract(this._buffer[r+1]),s=o.multiply(this.stepResponse((r+t)*this._stepTime)),i=i.add(s);return i.equals(this._value,this._eps)?this.postMessage("isActive",!1):(this._value.setValues(i),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,o,s=(e-this._bufferEndTime)/this._stepTime;if(s>=1){if(i=Math.floor(s),s-=i,i<this._buffer.length){for(this._previousValue=x3dom.fields.SFVec3f.copy(this._buffer[this._buffer.length-i]),t=this._buffer.length-1;t>=i;t--)this._buffer[t]=x3dom.fields.SFVec3f.copy(this._buffer[t-i]);for(t=0;i>t;t++)o=t/i,this._buffer[t]=this._buffer[i].multiply(o).add(this._vf.destination.multiply(1-o))}else for(this._previousValue=x3dom.fields.SFVec3f.copy(i==this._buffer.length?this._buffer[0]:this._vf.destination),t=0;t<this._buffer.length;t++)this._buffer[t]=x3dom.fields.SFVec3f.copy(this._vf.destination);this._bufferEndTime+=i*this._stepTime}return s}})),x3dom.registerNodeType("PositionChaser2D","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.PositionChaser2D.superClass.call(this,e),this.addField_SFVec2f(e,"initialDestination",0,0),this.addField_SFVec2f(e,"initialValue",0,0),this.addField_SFVec2f(e,"value",0,0),this.addField_SFVec2f(e,"destination",0,0),this._buffer=new x3dom.fields.MFVec2f,this._previousValue=new x3dom.fields.SFVec2f(0,0),this._value=new x3dom.fields.SFVec2f(0,0),this.initialize()},{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=x3dom.fields.SFVec2f.copy(this._vf.initialDestination),this._buffer.length=this._numSupports,this._buffer[0]=x3dom.fields.SFVec2f.copy(this._vf.initialDestination);for(var e=1;e<this._buffer.length;e++)this._buffer[e]=x3dom.fields.SFVec2f.copy(this._vf.initialValue);this._previousValue=x3dom.fields.SFVec2f.copy(this._vf.initialValue),this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=x3dom.fields.SFVec2f.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=x3dom.fields.SFVec2f.copy(this._previousValue),o=this._buffer[this._buffer.length-1].subtract(this._previousValue),s=o.multiply(this.stepResponse((this._buffer.length-1+t)*this._stepTime));i=i.add(s);for(var r=this._buffer.length-2;r>=0;r--)o=this._buffer[r].subtract(this._buffer[r+1]),s=o.multiply(this.stepResponse((r+t)*this._stepTime)),i=i.add(s);return i.equals(this._value,this._eps)?this.postMessage("isActive",!1):(this._value.setValues(i),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,o,s=(e-this._bufferEndTime)/this._stepTime;if(s>=1){if(i=Math.floor(s),s-=i,i<this._buffer.length){for(this._previousValue=x3dom.fields.SFVec2f.copy(this._buffer[this._buffer.length-i]),t=this._buffer.length-1;t>=i;t--)this._buffer[t]=x3dom.fields.SFVec2f.copy(this._buffer[t-i]);for(t=0;i>t;t++)o=t/i,this._buffer[t]=this._buffer[i].multiply(o).add(this._vf.destination.multiply(1-o))}else for(this._previousValue=x3dom.fields.SFVec2f.copy(i==this._buffer.length?this._buffer[0]:this._vf.destination),t=0;t<this._buffer.length;t++)this._buffer[t]=x3dom.fields.SFVec2f.copy(this._vf.destination);this._bufferEndTime+=i*this._stepTime}return s}})),x3dom.registerNodeType("PositionDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.PositionDamper.superClass.call(this,e),this.addField_SFVec3f(e,"initialDestination",0,0,0),this.addField_SFVec3f(e,"initialValue",0,0,0),this.addField_SFVec3f(e,"value",0,0,0),this.addField_SFVec3f(e,"destination",0,0,0),this._value0=new x3dom.fields.SFVec3f(0,0,0),this._value1=new x3dom.fields.SFVec3f(0,0,0),this._value2=new x3dom.fields.SFVec3f(0,0,0),this._value3=new x3dom.fields.SFVec3f(0,0,0),this._value4=new x3dom.fields.SFVec3f(0,0,0),this._value5=new x3dom.fields.SFVec3f(0,0,0),this.initialize()},{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(i)):new x3dom.fields.SFVec3f(this._value0.x,this._value0.y,this._value0.z),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(i)):new x3dom.fields.SFVec3f(this._value1.x,this._value1.y,this._value1.z),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(i)):new x3dom.fields.SFVec3f(this._value2.x,this._value2.y,this._value2.z),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(i)):new x3dom.fields.SFVec3f(this._value3.x,this._value3.y,this._value3.z),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(i)):new x3dom.fields.SFVec3f(this._value4.x,this._value4.y,this._value4.z);var o=this._value1.subtract(this._value0).length();if(this._vf.order>1){var s=this._value2.subtract(this._value1).length();s>o&&(o=s)}if(this._vf.order>2){var r=this._value3.subtract(this._value2).length();r>o&&(o=r)}if(this._vf.order>3){var n=this._value4.subtract(this._value3).length();n>o&&(o=n)}if(this._vf.order>4){var a=this._value5.subtract(this._value4).length();a>o&&(o=a)}return o<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("PositionDamper2D","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.PositionDamper2D.superClass.call(this,e),this.addField_SFVec2f(e,"initialDestination",0,0),this.addField_SFVec2f(e,"initialValue",0,0),this.addField_SFVec2f(e,"value",0,0),this.addField_SFVec2f(e,"destination",0,0),this._value0=new x3dom.fields.SFVec2f(0,0),this._value1=new x3dom.fields.SFVec2f(0,0),this._value2=new x3dom.fields.SFVec2f(0,0),this._value3=new x3dom.fields.SFVec2f(0,0),this._value4=new x3dom.fields.SFVec2f(0,0),this._value5=new x3dom.fields.SFVec2f(0,0),this.initialize()},{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(i)):new x3dom.fields.SFVec2f(this._value0.x,this._value0.y,this._value0.z),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(i)):new x3dom.fields.SFVec2f(this._value1.x,this._value1.y,this._value1.z),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(i)):new x3dom.fields.SFVec2f(this._value2.x,this._value2.y,this._value2.z),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(i)):new x3dom.fields.SFVec2f(this._value3.x,this._value3.y,this._value3.z),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(i)):new x3dom.fields.SFVec2f(this._value4.x,this._value4.y,this._value4.z);var o=this._value1.subtract(this._value0).length();if(this._vf.order>1){var s=this._value2.subtract(this._value1).length();s>o&&(o=s)}if(this._vf.order>2){var r=this._value3.subtract(this._value2).length();r>o&&(o=r)}if(this._vf.order>3){var n=this._value4.subtract(this._value3).length();n>o&&(o=n)}if(this._vf.order>4){var a=this._value5.subtract(this._value4).length();a>o&&(o=a)}return o<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("ScalarChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.ScalarChaser.superClass.call(this,e),this.addField_SFFloat(e,"initialDestination",0),this.addField_SFFloat(e,"initialValue",0),this.addField_SFFloat(e,"value",0),this.addField_SFFloat(e,"destination",0),this._buffer=[],this._previousValue=0,this._value=0,this.initialize()},{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue=this._vf.value;for(var t=1;t<this._buffer.length;t++)this._buffer[t]=this._vf.value;this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=this._vf.initialDestination,this._buffer.length=this._numSupports,this._buffer[0]=this._vf.initialDestination;for(var e=1;e<this._buffer.length;e++)this._buffer[e]=this._vf.initialValue;this._previousValue=this._vf.initialValue,this._stepTime=this._vf.duration/this._numSupports;var t=Math.abs(this._buffer[0]-this._buffer[1])>this._eps;this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=this._vf.initialValue,this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=this._previousValue,o=this._buffer[this._buffer.length-1]-this._previousValue,s=o*this.stepResponse((this._buffer.length-1+t)*this._stepTime);i+=s;for(var r=this._buffer.length-2;r>=0;r--)o=this._buffer[r]-this._buffer[r+1],s=o*this.stepResponse((r+t)*this._stepTime),i+=s;return Math.abs(i-this._value)>this._eps?(this._value=i,this.postMessage("value",this._value)):this.postMessage("isActive",!1),this._vf.isActive},updateBuffer:function(e){var t,i,o,s=(e-this._bufferEndTime)/this._stepTime;if(s>=1){if(i=Math.floor(s),s-=i,i<this._buffer.length){for(this._previousValue=this._buffer[this._buffer.length-i],t=this._buffer.length-1;t>=i;t--)this._buffer[t]=this._buffer[t-i];for(t=0;i>t;t++)o=t/i,this._buffer[t]=this._buffer[i]*o+this._vf.destination*(1-o)}else for(this._previousValue=i==this._buffer.length?this._buffer[0]:this._vf.destination,t=0;t<this._buffer.length;t++)this._buffer[t]=this._vf.destination;this._bufferEndTime+=i*this._stepTime}return s}})),x3dom.registerNodeType("ScalarDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.ScalarDamper.superClass.call(this,e),this.addField_SFFloat(e,"initialDestination",0),this.addField_SFFloat(e,"initialValue",0),this.addField_SFFloat(e,"value",0),this.addField_SFFloat(e,"destination",0),this._value0=0,this._value1=0,this._value2=0,this._value3=0,this._value4=0,this._value5=0,this.initialize()},{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?Math.abs(this._value0-this._vf.destination)>this._eps&&(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1=this._vf.value,this._value2=this._vf.value,this._value3=this._vf.value,this._value4=this._vf.value,this._value5=this._vf.value,this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0=this._vf.initialDestination,this._value1=this._vf.initialValue,this._value2=this._vf.initialValue,this._value3=this._vf.initialValue,this._value4=this._vf.initialValue,this._value5=this._vf.initialValue,this._lastTick=0;var e=Math.abs(this._value0-this._value1)>this._eps;this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0+i*(this._value1-this._value0):this._value0,this._value2=this._vf.order>1&&this._vf.tau?this._value1+i*(this._value2-this._value1):this._value1,this._value3=this._vf.order>2&&this._vf.tau?this._value2+i*(this._value3-this._value2):this._value2,this._value4=this._vf.order>3&&this._vf.tau?this._value3+i*(this._value4-this._value3):this._value3,this._value5=this._vf.order>4&&this._vf.tau?this._value4+i*(this._value5-this._value4):this._value4;var o=Math.abs(this._value1-this._value0);if(this._vf.order>1){var s=Math.abs(this._value2-this._value1);s>o&&(o=s)}if(this._vf.order>2){var r=Math.abs(this._value3-this._value2);r>o&&(o=r)}if(this._vf.order>3){var n=Math.abs(this._value4-this._value3);n>o&&(o=n)}if(this._vf.order>4){var a=Math.abs(this._value5-this._value4);a>o&&(o=a)}return o<=this._eps?(this._value1=this._value0,this._value2=this._value0,this._value3=this._value0,this._value4=this._value0,this._value5=this._value0,this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("CoordinateDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.CoordinateDamper.superClass.call(this,e),this.addField_MFVec3f(e,"initialDestination",[]),this.addField_MFVec3f(e,"initialValue",[]),this.addField_MFVec3f(e,"value",[]),this.addField_MFVec3f(e,"destination",[]),x3dom.debug.logWarning("CoordinateDamper NYI")})),x3dom.registerNodeType("TexCoordDamper2D","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.TexCoordDamper2D.superClass.call(this,e),this.addField_MFVec2f(e,"initialDestination",[]),this.addField_MFVec2f(e,"initialValue",[]),this.addField_MFVec2f(e,"value",[]),this.addField_MFVec2f(e,"destination",[]),x3dom.debug.logWarning("TexCoordDamper2D NYI")})),x3dom.registerNodeType("X3DInterpolatorNode","Interpolation",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DInterpolatorNode.superClass.call(this,e),this.addField_MFFloat(e,"key",[]),this.addField_SFFloat(e,"set_fraction",0)},{linearInterp:function(e,t){if(e<=this._vf.key[0])return this._vf.keyValue[0];if(e>=this._vf.key[this._vf.key.length-1])return this._vf.keyValue[this._vf.key.length-1];for(var i=0;i<this._vf.key.length-1;++i)if(this._vf.key[i]<e&&e<=this._vf.key[i+1])return t(this._vf.keyValue[i],this._vf.keyValue[i+1],(e-this._vf.key[i])/(this._vf.key[i+1]-this._vf.key[i]));return this._vf.keyValue[0]}})),x3dom.registerNodeType("OrientationInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.OrientationInterpolator.superClass.call(this,e),this.addField_MFRotation(e,"keyValue",[])},{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,function(e,t,i){return e.slerp(t,i)});this.postMessage("value_changed",t)}}})),x3dom.registerNodeType("PositionInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.PositionInterpolator.superClass.call(this,e),this.addField_MFVec3f(e,"keyValue",[])},{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,function(e,t,i){return e.multiply(1-i).add(t.multiply(i))});this.postMessage("value_changed",t)}}})),x3dom.registerNodeType("NormalInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.NormalInterpolator.superClass.call(this,e),this.addField_MFVec3f(e,"keyValue",[])},{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,function(e,t,i){return e.multiply(1-i).add(t.multiply(i)).normalize()});this.postMessage("value_changed",t)}}})),x3dom.registerNodeType("ColorInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.ColorInterpolator.superClass.call(this,e),this.addField_MFColor(e,"keyValue",[])},{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,function(e,t,i){return e.multiply(1-i).add(t.multiply(i))});this.postMessage("value_changed",t)}}})),x3dom.registerNodeType("ScalarInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.ScalarInterpolator.superClass.call(this,e),this.addField_MFFloat(e,"keyValue",[])},{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,function(e,t,i){return(1-i)*e+i*t});this.postMessage("value_changed",t)}}})),x3dom.registerNodeType("CoordinateInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){if(x3dom.nodeTypes.CoordinateInterpolator.superClass.call(this,e),this.addField_MFVec3f(e,"keyValue",[]),e&&e.xmlNode.hasAttribute("keyValue")){this._vf.keyValue=[];for(var t=x3dom.fields.MFVec3f.parse(e.xmlNode.getAttribute("keyValue")),i=this._vf.key.length>0?this._vf.key.length:1,o=t.length/i,s=0;i>s;s++){for(var r=new x3dom.fields.MFVec3f,n=0;o>n;n++)r.push(t[s*o+n]);this._vf.keyValue.push(r)}}},{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,function(e,t,i){for(var o=new x3dom.fields.MFVec3f,s=0;s<e.length;s++)o.push(e[s].multiply(1-i).add(t[s].multiply(i)));return o});this.postMessage("value_changed",t)}}})),x3dom.registerNodeType("SplinePositionInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.SplinePositionInterpolator.superClass.call(this,e),this.addField_MFVec3f(e,"keyValue",[]),this.addField_MFVec3f(e,"keyVelocity",[]),this.addField_SFBool(e,"closed",!1),this.addField_SFBool(e,"normalizeVelocity",!1),this.dtot=0,this.T0=[],this.T1=[],this.checkSanity=function(){var e=this._vf.key.length==this._vf.keyValue.length&&(this._vf.key.length==this._vf.keyVelocity.length||2==this._vf.keyVelocity.length&&this._vf.key.length>=2||0==this._vf.keyVelocity.length);e||x3dom.debug.logWarning("SplinePositionInterpolator Node: 'key' , 'keyValue' and/or 'keyVelocity' fields have inappropriate sizes")},this.calcDtot=function(){this.dtot=0;for(var e=0;e<this._vf.key.length-1;e++)this.dtot+=Math.abs(this._vf.key[e]-this._vf.key[e+1])},this.calcAdjustedKeyVelocity=function(){var e,t,i,o,s=this._vf.key.length;if(this._vf.keyVelocity.length==s)for(e=0;s>e;e++)t=this._vf.keyVelocity[e],this._vf.normalizeVelocity&&(t=t.multiply(this.dtot/t.length())),i=0==e||e==s-1?1:2*(this._vf.key[e]-this._vf.key[e-1])/(this._vf.key[e+1]-this._vf.key[e-1]),o=0==e||e==s-1?1:2*(this._vf.key[e+1]-this._vf.key[e])/(this._vf.key[e+1]-this._vf.key[e-1]),this.T0[e]=t.multiply(i),this.T1[e]=t.multiply(o);else if(2==this._vf.keyVelocity.length&&s>2)for(e=0;s>e;e++)t=0==e?this._vf.keyVelocity[0]:e==s-1?this._vf.keyVelocity[1]:this._vf.keyValue[e+1].subtract(this._vf.keyValue[e-1]).multiply(.5),this._vf.normalizeVelocity&&(t=t.multiply(this.dtot/t.length())),i=0==e||e==s-1?1:2*(this._vf.key[e]-this._vf.key[e-1])/(this._vf.key[e+1]-this._vf.key[e-1]),
o=0==e||e==s-1?1:2*(this._vf.key[e+1]-this._vf.key[e])/(this._vf.key[e+1]-this._vf.key[e-1]),this.T0[e]=t.multiply(i),this.T1[e]=t.multiply(o);else{var r=this._vf.closed&&this._vf.keyValue[0].equals(this._vf.keyValue[s-1],1e-5);for(e=0;s>e;e++)0!=e&&e!=s-1||r?(0!=e&&e!=s-1||!r?(t=this._vf.keyValue[e+1].subtract(this._vf.keyValue[e-1]).multiply(.5),i=2*(this._vf.key[e]-this._vf.key[e-1])/(this._vf.key[e+1]-this._vf.key[e-1]),o=2*(this._vf.key[e+1]-this._vf.key[e])/(this._vf.key[e+1]-this._vf.key[e-1])):(t=this._vf.keyValue[1].subtract(this._vf.keyValue[s-2]).multiply(.5),0==e?(i=2*(this._vf.key[0]-this._vf.key[s-2])/(this._vf.key[1]-this._vf.key[s-2]),o=2*(this._vf.key[1]-this._vf.key[0])/(this._vf.key[1]-this._vf.key[s-2])):(i=2*(this._vf.key[s-1]-this._vf.key[s-2])/(this._vf.key[1]-this._vf.key[s-2]),o=2*(this._vf.key[1]-this._vf.key[s-1])/(this._vf.key[1]-this._vf.key[s-2])),i=2*(this._vf.key[s-1]-this._vf.key[s-2])/(this._vf.key[s-2]-this._vf.key[1]),o=2*(this._vf.key[1]-this._vf.key[0])/(this._vf.key[s-2]-this._vf.key[1])),this.T0[e]=t.multiply(i),this.T1[e]=t.multiply(o)):(this.T0[e]=new x3dom.fields.SFVec3f(0,0,0),this.T1[e]=new x3dom.fields.SFVec3f(0,0,0))}},this.checkSanity(),this.calcDtot(),this.calcAdjustedKeyVelocity()},{fieldChanged:function(e){switch(e){case"key":case"keyValue":case"keyVelocity":this.checkSanity(),this.calcDtot(),this.calcAdjustedKeyVelocity();break;case"closed":case"normalizeVelocity":this.calcAdjustedKeyVelocity();break;case"set_fraction":var t;this._vf.key.length>0&&(this._vf.set_fraction<=this._vf.key[0]?t=x3dom.fields.SFVec3f.copy(this._vf.keyValue[0]):this._vf.set_fraction>=this._vf.key[this._vf.key.length-1]&&(t=x3dom.fields.SFVec3f.copy(this._vf.keyValue[this._vf.key.length-1])));for(var i=0;i<this._vf.key.length-1;i++)if(this._vf.key[i]<this._vf.set_fraction&&this._vf.set_fraction<=this._vf.key[i+1]){var o=(this._vf.set_fraction-this._vf.key[i])/(this._vf.key[i+1]-this._vf.key[i]),s=new x3dom.fields.SFVec4f(2*o*o*o-3*o*o+1,-2*o*o*o+3*o*o,o*o*o-2*o*o+o,o*o*o-o*o);t=new x3dom.fields.SFVec3f(s.x*this._vf.keyValue[i].x+s.y*this._vf.keyValue[i+1].x+s.z*this.T0[i].x+s.w*this.T1[i+1].x,s.x*this._vf.keyValue[i].y+s.y*this._vf.keyValue[i+1].y+s.z*this.T0[i].y+s.w*this.T1[i+1].y,s.x*this._vf.keyValue[i].z+s.y*this._vf.keyValue[i+1].z+s.z*this.T0[i].z+s.w*this.T1[i+1].z);break}void 0!==t?this.postMessage("value_changed",t):x3dom.debug.logWarning("SplinePositionInterpolator Node: value_changed is undefined!")}}})),x3dom.registerNodeType("TimeSensor","Time",defineClass(x3dom.nodeTypes.X3DSensorNode,function(e){x3dom.nodeTypes.TimeSensor.superClass.call(this,e),e?e.doc._nodeBag.timer.push(this):x3dom.debug.logWarning("TimeSensor: No runtime context found!"),this.addField_SFTime(e,"cycleInterval",1),this.addField_SFBool(e,"loop",!1),this.addField_SFTime(e,"startTime",0),this.addField_SFTime(e,"stopTime",0),this.addField_SFTime(e,"pauseTime",0),this.addField_SFTime(e,"resumeTime",0),this.addField_SFTime(e,"cycleTime",0),this.addField_SFTime(e,"elapsedTime",0),this.addField_SFFloat(e,"fraction_changed",0),this.addField_SFBool(e,"isActive",!1),this.addField_SFBool(e,"isPaused",!1),this.addField_SFTime(e,"time",0),this.addField_SFBool(e,"first",!0),this.addField_SFFloat(e,"firstCycle",0),this._prevCycle=-1,this._lastTime=0,this._cycleStopTime=0,this._activatedTime=0,this._vf.startTime>0&&this._updateCycleStopTime(),this._backupStartTime=this._vf.startTime,this._backupStopTime=this._vf.stopTime,this._backupCycleInterval=this._vf.cycleInterval},{tick:function(e){if(!this._vf.enabled)return this._lastTime=e,!1;var t=this._vf.cycleInterval>0&&e>=this._vf.startTime&&(e<this._vf.stopTime||this._vf.stopTime<=this._vf.startTime)&&(1==this._vf.loop||0==this._vf.loop&&e<this._cycleStopTime);if(t&&!this._vf.isActive&&(this.postMessage("isActive",!0),this._activatedTime=e),t||this._vf.isActive){this.postMessage("elapsedTime",e-this._activatedTime);var i=e>=this._vf.pauseTime&&this._vf.pauseTime>this._vf.resumeTime;if(i&&!this._vf.isPaused?(this.postMessage("isPaused",!0),this.postMessage("pauseTime",e)):!i&&this._vf.isPaused&&(this.postMessage("isPaused",!1),this.postMessage("resumeTime",e)),!i){var o=this._getCycleAt(e),s=Math.floor(o),r=this._vf.startTime+s*this._vf.cycleInterval,n=0;this._vf.stopTime>this._vf.startTime&&this._lastTime<this._vf.stopTime&&e>=this._vf.stopTime?n=this._vf.stopTime:this._lastTime<r&&e>=r&&(n=r),n>0&&(e=n,o=this._getCycleAt(e),s=Math.floor(o));var a=o-s;a<x3dom.fields.Eps&&(a=this._lastTime<this._vf.startTime?0:1,this.postMessage("cycleTime",e)),this.postMessage("fraction_changed",a),this.postMessage("time",e)}}return!t&&this._vf.isActive&&this.postMessage("isActive",!1),this._lastTime=e,!0},fieldChanged:function(e){if("enabled"==e)!this._vf.enabled&&this._vf.isActive&&this.postMessage("isActive",!1);else if("startTime"==e){if(this._vf.isActive)return void(this._vf.startTime=this._backupStartTime);this._backupStartTime=this._vf.startTime,this._updateCycleStopTime()}else if("stopTime"==e){if(this._vf.isActive&&this._vf.stopTime<=this._vf.startTime)return void(this._vf.stopTime=this._backupStopTime);this._backupStopTime=this._vf.stopTime}else if("cycleInterval"==e){if(this._vf.isActive)return void(this._vf.cycleInterval=this._backupCycleInterval);this._backupCycleInterval=this._vf.cycleInterval}else"loop"==e&&this._updateCycleStopTime()},parentRemoved:function(){if(0===this._parentNodes.length)for(var e=this.findX3DDoc(),t=0,i=e._nodeBag.timer.length;i>t;t++)e._nodeBag.timer[t]===this&&e._nodeBag.timer.splice(t,1)},_getCycleAt:function(e){return Math.max(0,e-this._vf.startTime)/this._vf.cycleInterval},_updateCycleStopTime:function(){if(0==this._vf.loop){var e=(new Date).getTime()/1e3,t=Math.floor(this._getCycleAt(e))+1;this._cycleStopTime=this._vf.startTime+t*this._vf.cycleInterval}else this._cycleStopTime=0}})),x3dom.registerNodeType("X3DTimeDependentNode","Time",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DTimeDependentNode.superClass.call(this,e),this.addField_SFBool(e,"loop",!1)})),x3dom.registerNodeType("Anchor","Networking",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Anchor.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_MFString(e,"parameter",[]),this.addField_SFString(e,"description","")},{doIntersect:function(e){for(var t=!1,i=0;i<this._childNodes.length;i++)this._childNodes[i]&&(t=this._childNodes[i].doIntersect(e)||t);return t},handleTouch:function(){var e=this._vf.url.length?this._vf.url[0]:"",t=e.search("#"),i="";t>=0&&(i=e.slice(t+1));var o=this._vf.parameter.length?this._vf.parameter[0]:"",s=o.search("target="),r="";s>=0&&(r=o.slice(s+7)),x3dom.debug.logInfo("Anchor url="+e+", target="+r+", #viewpoint="+i),0!=r.length||"_self"!=r?window.open(this._nameSpace.getURL(e),r):window.location=this._nameSpace.getURL(e)}})),x3dom.registerNodeType("Inline","Networking",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Inline.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_SFBool(e,"load",!0),this.addField_MFString(e,"nameSpaceName",[]),this.addField_SFBool(e,"mapDEFToID",!1),this.initDone=!1,this.count=0,this.numRetries=x3dom.nodeTypes.Inline.MaximumRetries},{fieldChanged:function(e){if("url"==e){for(var t=0;t<this._childNodes.length;t++)this.removeChild(this._childNodes[t]);if(0!=this._vf.nameSpaceName.length){var i=this._xmlNode;if(i&&i.hasChildNodes())for(;i.childNodes.length>=1;)i.removeChild(i.firstChild)}this.loadInline()}else"render"==e&&this.invalidateVolume()},nodeChanged:function(){this.initDone||(this.initDone=!0,this.loadInline())},fireEvents:function(e){if(this._xmlNode&&(this._xmlNode["on"+e]||this._xmlNode.hasAttribute("on"+e)||this._listeners[e])){var t={target:this._xmlNode,type:e,error:"error"==e?"XMLHttpRequest Error":"",cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}};try{var i=this._xmlNode["on"+e];if("function"==typeof i)i.call(this._xmlNode,t);else{var o=this._xmlNode.getAttribute("on"+e),s=new Function("event",o);s.call(this._xmlNode,t)}var r=this._listeners[e];if(r)for(var n=0;n<r.length;n++)r[n].call(this._xmlNode,t)}catch(a){x3dom.debug.logException(a)}}},loadInline:function(){var e=this,t=new window.XMLHttpRequest;if(t.overrideMimeType&&t.overrideMimeType("text/xml"),t.onreadystatechange=function(){if(4!=t.readyState)return t;if(t.status===x3dom.nodeTypes.Inline.AwaitTranscoding){if(e.count<e.numRetries){e.count++;var i=+t.getResponseHeader("Refresh")||5;return x3dom.debug.logInfo("XHR status: "+t.status+" - Await Transcoding ("+e.count+"/"+e.numRetries+"): Next request in "+i+" seconds"),window.setTimeout(function(){e._nameSpace.doc.downloadCount-=1,e.loadInline()},1e3*i),t}return x3dom.debug.logError("XHR status: "+t.status+" - Await Transcoding ("+e.count+"/"+e.numRetries+"): No Retries left"),e._nameSpace.doc.downloadCount-=1,e.count=0,t}if(200!==t.status&&0!==t.status)return e.fireEvents("error"),x3dom.debug.logError("XHR status: "+t.status+" - XMLHttpRequest requires web server running!"),e._nameSpace.doc.downloadCount-=1,e.count=0,t;(200==t.status||0==t.status)&&(e.count=0),x3dom.debug.logInfo("Inline: downloading "+e._vf.url[0]+" done.");var o=null,s=null,r=null,n=null;if(n="Microsoft Internet Explorer"!=navigator.appName?t.responseXML:(new DOMParser).parseFromString(t.responseText,"text/xml"),void 0!==n&&null!==n?o=n.getElementsByTagName("Scene")[0]||n.getElementsByTagName("scene")[0]:e.fireEvents("error"),o){var a=0!=e._vf.nameSpaceName.length?e._vf.nameSpaceName.toString().replace(" ",""):"";r=new x3dom.NodeNameSpace(a,e._nameSpace.doc);var d=e._vf.url.length?e._vf.url[0]:"";r.setBaseURL("/"===d[0]||d.indexOf(":")>=0?d:e._nameSpace.baseURL+d),s=r.setupTree(o),e._nameSpace.addSpace(r),0!=e._vf.nameSpaceName.length&&Array.forEach(o.childNodes,function(t){t instanceof Element&&(setNamespace(e._vf.nameSpaceName,t,e._vf.mapDEFToID),e._xmlNode.appendChild(t))})}else x3dom.debug.logError(n&&n.localName?"No Scene in "+n.localName:"No Scene in resource");var l=x3dom.getGlobal();for(e._childNodes.length>0&&e._childNodes[0]&&e._childNodes[0]._nameSpace&&e._nameSpace.removeSpace(e._childNodes[0]._nameSpace);0!==e._childNodes.length;)l._remover=e.removeChild(e._childNodes[0]);if(delete l._remover,s){e.addChild(s),e.invalidateVolume(),e._nameSpace.doc.downloadCount-=1,e._nameSpace.doc.needRender=!0,x3dom.debug.logInfo("Inline: added "+e._vf.url[0]+" to scene.");var h=e._nameSpace.doc._scene;h&&(h.invalidateVolume(),window.setTimeout(function(){e.invalidateVolume(),h.updateVolume(),e._nameSpace.doc.needRender=!0},1e3)),e.fireEvents("load")}return s=null,r=null,o=null,n=null,t},this._vf.url.length&&this._vf.url[0].length){var i=this._nameSpace.getURL(this._vf.url[0]);t.open("GET",i,!0),this._nameSpace.doc.downloadCount+=1;try{t.send(null)}catch(o){this.fireEvents("error"),x3dom.debug.logError(this._vf.url[0]+": "+o)}}}})),x3dom.nodeTypes.Inline.AwaitTranscoding=202,x3dom.nodeTypes.Inline.MaximumRetries=15,x3dom.registerNodeType("MultiPart","Networking",defineClass(x3dom.nodeTypes.Inline,function(e){x3dom.nodeTypes.MultiPart.superClass.call(this,e),this.addField_MFString(e,"urlIDMap",[]),this.addField_SFBool(e,"isPickable",!0),this.addField_SFString(e,"sortType","auto"),this.addField_SFBool(e,"solid",!1),this.addField_SFInt32(e,"sortKey",0),this.addField_SFString(e,"initialVisibility","auto"),this._idMap=null,this._inlineNamespace=null,this._highlightedParts=[],this._minId=0,this._maxId=0,this._lastId=-1,this._lastClickedId=-1,this._lastButton=0,this._identifierToPartId=[],this._identifierToAppId=[],this._visiblePartsPerShape=[],this._partVolume=[],this._partVisibility=[],this._originalColor=[],this._materials=[]},{fieldChanged:function(e){if("url"==e){if(0!=this._vf.nameSpaceName.length){var t=this._xmlNode;if(t&&t.hasChildNodes())for(;t.childNodes.length>=1;)t.removeChild(t.firstChild)}this.loadInline()}else"render"==e&&this.invalidateVolume()},nodeChanged:function(){this.initDone||(this.initDone=!0,this.loadIDMap())},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this._vf.render)for(var t=0;t<this._partVisibility.length;t++)if(this._partVisibility[t]){var i=this._partVolume[t];i&&i.isValid()&&e.extendBounds(i.min,i.max)}return e},handleEvents:function(e){if(this._inlineNamespace){var t=this._inlineNamespace.defMap.MultiMaterial_ColorMap,i=this._inlineNamespace.defMap.MultiMaterial_EmissiveMap,o=this._inlineNamespace.defMap.MultiMaterial_SpecularMap,s=this._inlineNamespace.defMap.MultiMaterial_VisibilityMap;-1==e.pickedId&&0!=e.button?(this._lastClickedId=-1,this._lastButton=e.button):-1==e.pickedId&&0==e.button&&(this._lastClickedId=-1,this._lastButton=0),-1!=e.pickedId?(e.part=new x3dom.Parts(this,[e.pickedId-this._minId],t,i,o,s),e.partID=this._idMap.mapping[e.pickedId-this._minId].name,e.type="mousemove",this.callEvtHandler("onmousemove",e),e.type="mouseover",this.callEvtHandler("onmouseover",e),!e.mouseup&&e.button&&e.button!=this._lastButton&&(e.type="mousedown",this._lastButton=e.button,-1==this._lastClickedId&&(this._lastClickedId=e.pickedId),this.callEvtHandler("onmousedown",e)),(e.mouseup||0!=this._lastButton&&0==e.button)&&(e.type="mouseup",this.callEvtHandler("onmouseup",e),this._lastButton=0,e.pickedId==this._lastClickedId&&(this._lastClickedId=-1,e.type="click",this.callEvtHandler("onclick",e)),this._lastClickedId=-1),e.pickedId!=this._lastId&&(-1!=this._lastId&&(e.part=new x3dom.Parts(this,[this._lastId-this._minId],t,i,o,s),e.partID=this._idMap.mapping[this._lastId-this._minId].name,e.type="mouseleave",this.callEvtHandler("onmouseleave",e)),e.part=new x3dom.Parts(this,[e.pickedId-this._minId],t,i,o,s),e.partID=this._idMap.mapping[e.pickedId-this._minId].name,e.type="mouseenter",this.callEvtHandler("onmouseenter",e),this._lastId=e.pickedId),this._lastId=e.pickedId):-1!=this._lastId&&(e.part=new x3dom.Parts(this,[this._lastId-this._minId],t,i,o,s),e.partID=this._idMap.mapping[this._lastId-this._minId].name,e.type="mouseout",this.callEvtHandler("onmouseout",e),e.type="mouseleave",this.callEvtHandler("onmouseleave",e),this._lastId=-1)}},loadIDMap:function(){if(this._vf.urlIDMap.length&&this._vf.urlIDMap[0].length){var e,t=this,i=this._nameSpace.getURL(this._vf.urlIDMap[0]),o=new XMLHttpRequest;o.open("GET",i,!0),o.onload=function(){for(t._idMap=JSON.parse(this.responseText),null==t._nameSpace.doc._scene._multiPartMap&&(t._nameSpace.doc._scene._multiPartMap={numberOfIds:0,multiParts:[]}),t._minId=t._nameSpace.doc._scene._multiPartMap.numberOfIds,t._maxId=t._minId+t._idMap.numberOfIDs-1,t._nameSpace.doc._scene._multiPartMap.numberOfIds+=t._idMap.numberOfIDs,t._nameSpace.doc._scene._multiPartMap.multiParts.push(t),e=0;e<t._idMap.mapping.length;e++)if(t._identifierToPartId[t._idMap.mapping[e].name]||(t._identifierToPartId[t._idMap.mapping[e].name]=[]),t._identifierToPartId[t._idMap.mapping[e].appearance]||(t._identifierToPartId[t._idMap.mapping[e].appearance]=[]),t._identifierToPartId[t._idMap.mapping[e].name].push(e),t._identifierToPartId[t._idMap.mapping[e].appearance].push(e),!t._partVolume[e]){var i=x3dom.fields.SFVec3f.parse(t._idMap.mapping[e].min),o=x3dom.fields.SFVec3f.parse(t._idMap.mapping[e].max);t._partVolume[e]=new x3dom.fields.BoxVolume(i,o)}for(e=0;e<t._idMap.appearance.length;e++)t._identifierToAppId[t._idMap.appearance[e].name]=e;t.loadInline()},o.send(null)}},createMaterialData:function(){var e,t,i,o,s,r,n,a,d,l,h,u,f="",_="",c="",m="",p="",x="",g=Math.ceil(Math.sqrt(this._idMap.numberOfIDs));g=x3dom.Utils.nextHighestPowerOfTwo(g);for(var v=2*g,y=g+" "+v+" 4",b=g+" "+v+" 4",T=g+" "+v+" 4",S=0;g*g>S;S++)if(S<this._idMap.mapping.length){var M=this._idMap.mapping[S].appearance,C=this._identifierToAppId[M];r=this._idMap.appearance[C].material.ambientIntensity?this._idMap.appearance[C].material.ambientIntensity:"0.2",u=this._idMap.appearance[C].material.backAmbientIntensity?this._idMap.appearance[C].material.backAmbientIntensity:r,e=this._idMap.appearance[C].material.diffuseColor?this._idMap.appearance[C].material.diffuseColor:"0.8 0.8 0.8",n=this._idMap.appearance[C].material.backDiffuseColor?this._idMap.appearance[C].material.backDiffuseColor:e,s=this._idMap.appearance[C].material.emissiveColor?this._idMap.appearance[C].material.emissiveColor:"0.0 0.0 0.0",h=this._idMap.appearance[C].material.backEmissiveColor?this._idMap.appearance[C].material.backEmissiveColor:s,o=this._idMap.appearance[C].material.shininess?this._idMap.appearance[C].material.shininess:"0.2",l=this._idMap.appearance[C].material.backShininess?this._idMap.appearance[C].material.backShininess:o,i=this._idMap.appearance[C].material.specularColor?this._idMap.appearance[C].material.specularColor:"0 0 0",d=this._idMap.appearance[C].material.backSpecularColor?this._idMap.appearance[C].material.backSpecularColor:i,t=this._idMap.appearance[C].material.transparency?this._idMap.appearance[C].material.transparency:0,a=this._idMap.appearance[C].material.backTransparency?this._idMap.appearance[C].material.backTransparency:t,f+=" "+x3dom.fields.SFColorRGBA.parse(e+" "+(1-t)).toUint(),_+=" "+x3dom.fields.SFColorRGBA.parse(i+" "+o).toUint(),c+=" "+x3dom.fields.SFColorRGBA.parse(s+" "+r).toUint(),m+=" "+x3dom.fields.SFColorRGBA.parse(n+" "+(1-a)).toUint(),p+=" "+x3dom.fields.SFColorRGBA.parse(d+" "+l).toUint(),x+=" "+x3dom.fields.SFColorRGBA.parse(h+" "+u).toUint(),this._originalColor[S]=f,this._materials[S]=new x3dom.MultiMaterial({ambientIntensity:r,diffuseColor:x3dom.fields.SFColor.parse(e),emissiveColor:x3dom.fields.SFColor.parse(s),shininess:o,specularColor:x3dom.fields.SFColor.parse(i),transparency:t,backAmbientIntensity:u,backDiffuseColor:x3dom.fields.SFColor.parse(n),backEmissiveColor:x3dom.fields.SFColor.parse(h),backShininess:l,backSpecularColor:x3dom.fields.SFColor.parse(d),backTransparency:a})}else f+=" 255",_+=" 255",c+=" 255",m+=" 255",p+=" 255",x+=" 255";return y+=f+m,b+=_+p,T+=c+x,{diffuseTransparency:y,specularShininess:b,emissiveAmbientIntensity:T}},createVisibilityData:function(){var e,t,i=Math.ceil(Math.sqrt(this._idMap.numberOfIDs));i=x3dom.Utils.nextHighestPowerOfTwo(i);var o=i+" "+i+" 1";for(e=0;i*i>e;e++)if(e<this._idMap.mapping.length){if("auto"==this._vf.initialVisibility)for(o+=" 255",this._partVisibility[e]||(this._partVisibility[e]=!0),t=0;t<this._idMap.mapping[e].usage.length;t++)this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]]||(this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]]={val:0,max:0}),this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]].val++,this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]].max++;else if("visible"==this._vf.initialVisibility)for(o+=" 255",this._partVisibility[e]||(this._partVisibility[e]=!0),t=0;t<this._idMap.mapping[e].usage.length;t++)this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]]||(this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]]={val:0,max:0}),this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]].val++,this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]].max++;else if("invisible"==this._vf.initialVisibility)for(o+=" 0",this._partVisibility[e]||(this._partVisibility[e]=!1),t=0;t<this._idMap.mapping[e].usage.length;t++)this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]]||(this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]]={val:0,max:0}),this._visiblePartsPerShape[this._idMap.mapping[e].usage[t]].max++}else o+=" 0";return o},replaceMaterials:function(e){var t,i,o,s,r,n=!0;if(e&&e.hasChildNodes()){o=this.createMaterialData(),s=this.createVisibilityData();for(var a=e.getElementsByTagName("Shape"),d=0;d<a.length;d++){i=a[d].getAttribute("DEF")||a[d].getAttribute("def"),i&&this._visiblePartsPerShape[i]&&0==this._visiblePartsPerShape[i].val&&a[d].setAttribute("render","false"),a[d].setAttribute("idOffset",this._minId),a[d].setAttribute("isPickable",this._vf.isPickable);var l=a[d].getElementsByTagName("BinaryGeometry");if(l&&l.length)for(var h=0;h<l.length;h++)l[h].setAttribute("solid",this._vf.solid);var u=a[d].getElementsByTagName("Appearance");if(u.length)for(var f=0;f<u.length;f++){u[f].removeAttribute("DEF"),u[f].removeAttribute("USE"),u[f].setAttribute("sortType",this._vf.sortType),u[f].setAttribute("sortKey",this._vf.sortKey);var _=u[f].getElementsByTagName("Material");if(_.length){if(n){n=!1,t=document.createElement("CommonSurfaceShader"),t.setAttribute("DEF","MultiMaterial");var c=document.createElement("PixelTexture");c.setAttribute("containerField","multiDiffuseAlphaTexture"),c.setAttribute("id","MultiMaterial_ColorMap"),c.setAttribute("image",o.diffuseTransparency);var m=document.createElement("PixelTexture");m.setAttribute("containerField","multiEmissiveAmbientTexture"),m.setAttribute("id","MultiMaterial_EmissiveMap"),m.setAttribute("image",o.emissiveAmbientIntensity);var p=document.createElement("PixelTexture");p.setAttribute("containerField","multiSpecularShininessTexture"),p.setAttribute("id","MultiMaterial_SpecularMap"),p.setAttribute("image",o.specularShininess);var x=document.createElement("PixelTexture");x.setAttribute("containerField","multiVisibilityTexture"),x.setAttribute("id","MultiMaterial_VisibilityMap"),x.setAttribute("image",s),t.appendChild(c),t.appendChild(m),t.appendChild(p),t.appendChild(x)}else t=document.createElement("CommonSurfaceShader"),t.setAttribute("USE","MultiMaterial");u[f].replaceChild(t,_[0])}else{if(n){n=!1,t=document.createElement("CommonSurfaceShader"),t.setAttribute("DEF","MultiMaterial");var c=document.createElement("PixelTexture");c.setAttribute("containerField","multiDiffuseAlphaTexture"),c.setAttribute("id","MultiMaterial_ColorMap"),c.setAttribute("image",o.diffuseTransparency);var m=document.createElement("PixelTexture");m.setAttribute("containerField","multiEmissiveAmbientTexture"),m.setAttribute("id","MultiMaterial_EmissiveMap"),m.setAttribute("image",o.emissiveAmbientIntensity);var p=document.createElement("PixelTexture");p.setAttribute("containerField","multiSpecularShininessTexture"),p.setAttribute("id","MultiMaterial_SpecularMap"),p.setAttribute("image",o.specularShininess);var x=document.createElement("PixelTexture");x.setAttribute("containerField","multiVisibilityTexture"),x.setAttribute("id","MultiMaterial_VisibilityMap"),x.setAttribute("image",s),t.appendChild(c),t.appendChild(m),t.appendChild(p),t.appendChild(x)}else t=document.createElement("CommonSurfaceShader"),t.setAttribute("USE","MultiMaterial");u[f].appendChild(t)}}else{if(r=document.createElement("Appearance"),n){n=!1,t=document.createElement("CommonSurfaceShader"),t.setAttribute("DEF","MultiMaterial");var c=document.createElement("PixelTexture");c.setAttribute("containerField","multiDiffuseAlphaTexture"),c.setAttribute("id","MultiMaterial_ColorMap"),c.setAttribute("image",o.diffuseTransparency);var m=document.createElement("PixelTexture");m.setAttribute("containerField","multiEmissiveAmbientTexture"),m.setAttribute("id","MultiMaterial_EmissiveMap"),m.setAttribute("image",o.emissiveAmbientIntensity);var p=document.createElement("PixelTexture");p.setAttribute("containerField","multiSpecularShininessTexture"),p.setAttribute("id","MultiMaterial_SpecularMap"),p.setAttribute("image",o.specularShininess);var x=document.createElement("PixelTexture");x.setAttribute("containerField","multiVisibilityTexture"),x.setAttribute("id","MultiMaterial_VisibilityMap"),x.setAttribute("image",s),t.appendChild(c),t.appendChild(m),t.appendChild(p),t.appendChild(x)}else t=document.createElement("CommonSurfaceShader"),t.setAttribute("USE","MultiMaterial");r.appendChild(t),l[h].appendChild(r)}}}},appendAPI:function(){var e=this;this._xmlNode.getIdList=function(){var t,i=[];for(t=0;t<e._idMap.mapping.length;t++)i.push(e._idMap.mapping[t].name);return i},this._xmlNode.getAppearanceIdList=function(){var t,i=[];for(t=0;t<e._idMap.appearance.length;t++)i.push(e._idMap.appearance[t].name);return i},this._xmlNode.getParts=function(t){var i,o,s=[];if(void 0==t)for(o=0;o<e._idMap.mapping.length;o++)s.push(o);else if(t instanceof Array)for(i=0;i<t.length;i++)e._identifierToPartId[t[i]]&&(s=s.concat(e._identifierToPartId[t[i]]));else if(t instanceof RegExp)for(var r in e._identifierToPartId)r.match(t)&&(s=s.concat(e._identifierToPartId[r]));var n=e._inlineNamespace.defMap.MultiMaterial_ColorMap,a=e._inlineNamespace.defMap.MultiMaterial_EmissiveMap,d=e._inlineNamespace.defMap.MultiMaterial_SpecularMap,l=e._inlineNamespace.defMap.MultiMaterial_VisibilityMap;return 0==s.length?null:new x3dom.Parts(e,s,n,a,d,l)}},loadInline:function(){var e=this,t=new window.XMLHttpRequest;if(t.overrideMimeType&&t.overrideMimeType("text/xml"),t.onreadystatechange=function(){if(4!=t.readyState)return t;if(t.status===x3dom.nodeTypes.Inline.AwaitTranscoding){if(e.count<e.numRetries){e.count++;var i=+t.getResponseHeader("Refresh")||5;return x3dom.debug.logInfo("XHR status: "+t.status+" - Await Transcoding ("+e.count+"/"+e.numRetries+"): Next request in "+i+" seconds"),window.setTimeout(function(){e._nameSpace.doc.downloadCount-=1,e.loadInline()},1e3*i),t}return x3dom.debug.logError("XHR status: "+t.status+" - Await Transcoding ("+e.count+"/"+e.numRetries+"): No Retries left"),e._nameSpace.doc.downloadCount-=1,e.count=0,t}if(200!==t.status&&0!==t.status)return e.fireEvents("error"),x3dom.debug.logError("XHR status: "+t.status+" - XMLHttpRequest requires web server running!"),e._nameSpace.doc.downloadCount-=1,e.count=0,t;(200==t.status||0==t.status)&&(e.count=0),x3dom.debug.logInfo("Inline: downloading "+e._vf.url[0]+" done.");var o=null,s=null,r=null;if(r="Microsoft Internet Explorer"!=navigator.appName?t.responseXML:(new DOMParser).parseFromString(t.responseText,"text/xml"),void 0!==r&&null!==r?o=r.getElementsByTagName("Scene")[0]||r.getElementsByTagName("scene")[0]:e.fireEvents("error"),o){var n="ns"+e._nameSpace.childSpaces.length,a=0!=e._vf.nameSpaceName.length?e._vf.nameSpaceName.toString().replace(" ",""):n;e._inlineNamespace=new x3dom.NodeNameSpace(a,e._nameSpace.doc);var d=e._vf.url.length?e._vf.url[0]:"";e._inlineNamespace.setBaseURL("/"===d[0]||d.indexOf(":")>=0?d:e._nameSpace.baseURL+d),e.replaceMaterials(o),s=e._inlineNamespace.setupTree(o),e._nameSpace.addSpace(e._inlineNamespace),0!=e._vf.nameSpaceName.length&&Array.forEach(o.childNodes,function(t){t instanceof Element&&(setNamespace(e._vf.nameSpaceName,t,e._vf.mapDEFToID),e._xmlNode.appendChild(t))})}else x3dom.debug.logError(r&&r.localName?"No Scene in "+r.localName:"No Scene in resource");var l=x3dom.getGlobal();for(e._childNodes.length>0&&e._childNodes[0]&&e._childNodes[0]._nameSpace&&e._nameSpace.removeSpace(e._childNodes[0]._nameSpace);0!==e._childNodes.length;)l._remover=e.removeChild(e._childNodes[0]);if(delete l._remover,s){e.addChild(s),e.invalidateVolume(),e._nameSpace.doc.downloadCount-=1,e._nameSpace.doc.needRender=!0,x3dom.debug.logInfo("Inline: added "+e._vf.url[0]+" to scene.");var h=e._nameSpace.doc._scene;h&&(h.invalidateVolume(),window.setTimeout(function(){e.invalidateVolume(),h.updateVolume(),e._nameSpace.doc.needRender=!0},1e3)),e.appendAPI(),e.fireEvents("load")}return s=null,o=null,r=null,t},this._vf.url.length&&this._vf.url[0].length){var i=this._nameSpace.getURL(this._vf.url[0]);t.open("GET",i,!0),this._nameSpace.doc.downloadCount+=1;try{t.send(null)}catch(o){this.fireEvents("error"),x3dom.debug.logError(this._vf.url[0]+": "+o)}}}})),x3dom.registerNodeType("X3DBackgroundNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){x3dom.nodeTypes.X3DBackgroundNode.superClass.call(this,e);var t=e&&e.autoGen?1:0;this.addField_SFString(e,"crossOrigin",""),this.addField_MFColor(e,"groundColor",[]),this.addField_MFFloat(e,"groundAngle",[]),this.addField_MFColor(e,"skyColor",[new x3dom.fields.SFColor(0,0,0)]),this.addField_MFFloat(e,"skyAngle",[]),this.addField_SFFloat(e,"transparency",t),this._dirty=!0},{getSkyColor:function(){return new x3dom.fields.SFColor(0,0,0)},getTransparency:function(){return 0},getTexUrl:function(){return[]}})),x3dom.registerNodeType("X3DFogNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){x3dom.nodeTypes.X3DFogNode.superClass.call(this,e),this.addField_SFColor(e,"color",1,1,1),this.addField_SFString(e,"fogType","LINEAR"),this.addField_SFFloat(e,"visibilityRange",0)},{})),x3dom.registerNodeType("Fog","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DFogNode,function(e){x3dom.nodeTypes.Fog.superClass.call(this,e)},{})),x3dom.registerNodeType("Background","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBackgroundNode,function(e){x3dom.nodeTypes.Background.superClass.call(this,e),this.addField_MFString(e,"backUrl",[]),this.addField_MFString(e,"bottomUrl",[]),this.addField_MFString(e,"frontUrl",[]),this.addField_MFString(e,"leftUrl",[]),this.addField_MFString(e,"rightUrl",[]),this.addField_MFString(e,"topUrl",[])},{fieldChanged:function(e){e.indexOf("Url")>0||"transparency"==e||e.search("sky")>=0||e.search("ground")>=0?this._dirty=!0:e.indexOf("bind")>=0&&this.bind(this._vf.bind)},getSkyColor:function(){return this._vf.skyColor},getGroundColor:function(){return this._vf.groundColor},getTransparency:function(){return this._vf.transparency},getTexUrl:function(){return[this._nameSpace.getURL(this._vf.backUrl[0]),this._nameSpace.getURL(this._vf.frontUrl[0]),this._nameSpace.getURL(this._vf.bottomUrl[0]),this._nameSpace.getURL(this._vf.topUrl[0]),this._nameSpace.getURL(this._vf.leftUrl[0]),this._nameSpace.getURL(this._vf.rightUrl[0])]}})),x3dom.registerNodeType("X3DEnvironmentNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){x3dom.nodeTypes.X3DEnvironmentNode.superClass.call(this,e)})),x3dom.registerNodeType("Environment","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DEnvironmentNode,function(e){x3dom.nodeTypes.Environment.superClass.call(this,e),this.addField_SFBool(e,"sortTrans",!0),this.addField_SFBool(e,"shadowExcludeTransparentObjects",!1),this.addField_SFString(e,"gammaCorrectionDefault","linear"),this.addField_SFBool(e,"frustumCulling",!0),this.addField_SFBool(e,"smallFeatureCulling",!1),this.addField_SFFloat(e,"smallFeatureThreshold",1),this.addField_SFBool(e,"occlusionCulling",!1),this.addField_SFFloat(e,"occlusionVisibilityThreshold",0),this.addField_SFBool(e,"lowPriorityCulling",!1),this.addField_SFFloat(e,"lowPriorityThreshold",1),this.addField_SFBool(e,"tessellationDetailCulling",!1),this.addField_SFFloat(e,"tessellationErrorThreshold",0),this.addField_SFBool(e,"enableARC",!1),this.addField_SFFloat(e,"minFrameRate",1),this.addField_SFFloat(e,"maxFrameRate",62.5),this.addField_SFFloat(e,"userDataFactor",-1),this.addField_SFFloat(e,"smallFeatureFactor",-1),this.addField_SFFloat(e,"occlusionVisibilityFactor",-1),this.addField_SFFloat(e,"lowPriorityFactor",-1),this.addField_SFFloat(e,"tessellationErrorFactor",-1),this.addField_SFBool(e,"SSAO",!1),this.addField_SFFloat(e,"SSAOradius",.7),this.addField_SFFloat(e,"SSAOamount",.3),this.addField_SFInt32(e,"SSAOrandomTextureSize",4),this.addField_SFInt32(e,"SSAOblurDepthTreshold",1),this._validGammaCorrectionTypes=["none","fastlinear","linear"],this.checkSanity()},{checkSanity:function(){var e=function(e,t,i,o){return e&&t==o?i:e||t==o?t:o};this._smallFeatureThreshold=e(this._vf.smallFeatureCulling,this._vf.smallFeatureThreshold,10,0),this._lowPriorityThreshold=e(this._vf.lowPriorityCulling,this._vf.lowPriorityThreshold,.5,1),this._occlusionVisibilityThreshold=e(this._vf.occlusionCulling,this._vf.occlusionVisibilityThreshold,1,0),this._tessellationErrorThreshold=e(this._vf.tessellationDetailCulling,this._vf.tessellationErrorThreshold,1,0);var t=function(e,t){return e=e.toLowerCase(),t._validGammaCorrectionTypes.indexOf(e)>-1?e:(x3dom.debug.logWarning(e+" gammaCorrectionDefault may only be linear (default), fastLinear, or none"),t._validGammaCorrectionTypes[0])};this._vf.gammaCorrectionDefault=t(this._vf.gammaCorrectionDefault,this)}})),x3dom.registerNodeType("X3DViewpointNode","Navigation",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){
if(x3dom.nodeTypes.X3DViewpointNode.superClass.call(this,e),e&&e.xmlNode){var t=e.xmlNode;t.resetView||t.getFieldOfView||t.getNear||t.getFar||(t.resetView=function(){var e=this._x3domNode;e.resetView(),e._nameSpace.doc.needRender=!0},t.getFieldOfView=function(){return this._x3domNode.getFieldOfView()},t.getNear=function(){return this._x3domNode.getNear()},t.getFar=function(){return this._x3domNode.getFar()})}},{activate:function(e){var t=this._nameSpace.doc._viewarea;e&&t.animateTo(this,e._autoGen?null:e),t._needNavigationMatrixUpdate=!0,x3dom.nodeTypes.X3DBindableNode.prototype.activate.call(this,e)},deactivate:function(e){x3dom.nodeTypes.X3DBindableNode.prototype.deactivate.call(this,e)},getTransformation:function(){return this.getCurrentTransform()},getCenterOfRotation:function(){return new x3dom.fields.SFVec3f(0,0,0)},setCenterOfRotation:function(e){this._vf.centerOfRotation.setValues(e)},getFieldOfView:function(){return 1.57079633},setView:function(e){var t=this.getCurrentTransform();this._viewMatrix=e.mult(t)},setViewAbsolute:function(e){this._viewMatrix=e},setProjectionMatrix:function(){},resetView:function(){},getNear:function(){return.1},getFar:function(){return 1e4},getImgPlaneHeightAtDistOne:function(){return 2},getViewMatrix:function(){return null},getProjectionMatrix:function(){return null}})),x3dom.registerNodeType("Viewpoint","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(e){x3dom.nodeTypes.Viewpoint.superClass.call(this,e),this.addField_SFFloat(e,"fieldOfView",.785398),this.addField_SFVec3f(e,"position",0,0,10),this.addField_SFRotation(e,"orientation",0,0,0,1),this.addField_SFVec3f(e,"centerOfRotation",0,0,0),this.addField_SFFloat(e,"zNear",-1),this.addField_SFFloat(e,"zFar",-1),this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()).inverse(),this._projMatrix=null,this._lastAspect=1,this._zRatio=1e4,this._zNear=this._vf.zNear,this._zFar=this._vf.zFar,this._imgPlaneHeightAtDistOne=2*Math.tan(this._vf.fieldOfView/2)},{fieldChanged:function(e){"position"==e||"orientation"==e?this.resetView():"fieldOfView"==e||"zNear"==e||"zFar"==e?(this._projMatrix=null,this._zNear=this._vf.zNear,this._zFar=this._vf.zFar,this._imgPlaneHeightAtDistOne=2*Math.tan(this._vf.fieldOfView/2)):e.indexOf("bind")>=0&&this.bind(this._vf.bind)},setProjectionMatrix:function(e){this._projMatrix=e},getCenterOfRotation:function(){return this.getCurrentTransform().multMatrixPnt(this._vf.centerOfRotation)},getViewMatrix:function(){return this._viewMatrix},getFieldOfView:function(){return this._vf.fieldOfView},resetView:function(){this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()).inverse(),this._vf.isActive&&this._nameSpace&&this._nameSpace.doc._viewarea&&this._nameSpace.doc._viewarea.resetNavHelpers()},getNear:function(){return this._zNear},getFar:function(){return this._zFar},getImgPlaneHeightAtDistOne:function(){return this._imgPlaneHeightAtDistOne},getProjectionMatrix:function(e){var t=this._vf.fieldOfView,i=this._vf.zFar,o=this._vf.zNear;if(0>=o||0>=i){var s=.8,r=1.2,n=this._nameSpace.doc._viewarea,a=n._scene,d=x3dom.fields.SFVec3f.copy(a._lastMin),l=x3dom.fields.SFVec3f.copy(a._lastMax),h=l.subtract(d),u=h.length()/2,f=n.getViewMatrix().inverse(),_=f.e3(),c=new x3dom.fields.SFVec3f(0,0,0),m=new x3dom.fields.SFVec3f(1,1,1),p=new x3dom.fields.Quaternion(0,0,1,0),x=new x3dom.fields.Quaternion(0,0,1,0);f.getTransform(c,p,m,x);var g=m.x,v=m.x;v<m.y&&(v=m.y),g>m.y&&(g=m.y),v<m.z&&(v=m.z),g>m.z&&(g=m.z),v>1?s/=v:g>x3dom.fields.Eps&&1>g&&(r/=g);var y=d.add(h.multiply(.5)),b=_.subtract(y).length();u?(o=b>u?(b-u)*s:0,i=(b+u)*r):(o=.1,i=1e5);var T=i/this._zRatio;o=Math.max(o,Math.max(x3dom.fields.Eps,T)),i>this._vf.zNear&&this._vf.zNear>0&&(o=this._vf.zNear),this._vf.zFar>o&&(i=this._vf.zFar),o>=i&&(i=o+1)}if(null==this._projMatrix)this._projMatrix=x3dom.fields.SFMatrix4f.perspective(t,e,o,i);else if(this._zNear!=o||this._zFar!=i){var S=o-i;this._projMatrix._22=(o+i)/S,this._projMatrix._23=2*o*i/S}else this._lastAspect!=e&&(this._projMatrix._00=1/Math.tan(t/2)/e,this._lastAspect=e);return this._zNear=o,this._zFar=i,this._projMatrix}})),x3dom.registerNodeType("OrthoViewpoint","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(e){x3dom.nodeTypes.OrthoViewpoint.superClass.call(this,e),this.addField_MFFloat(e,"fieldOfView",[-1,-1,1,1]),this.addField_SFVec3f(e,"position",0,0,10),this.addField_SFRotation(e,"orientation",0,0,0,1),this.addField_SFVec3f(e,"centerOfRotation",0,0,0),this.addField_SFFloat(e,"zNear",.1),this.addField_SFFloat(e,"zFar",1e4),this._viewMatrix=null,this._projMatrix=null,this._lastAspect=1,this.resetView()},{fieldChanged:function(e){"position"==e||"orientation"==e?this.resetView():"fieldOfView"==e||"zNear"==e||"zFar"==e?(this._projMatrix=null,this.resetView()):e.indexOf("bind")>=0&&this.bind(this._vf.bind)},getCenterOfRotation:function(){return this.getCurrentTransform().multMatrixPnt(this._vf.centerOfRotation)},getViewMatrix:function(){return this._viewMatrix},resetView:function(){var e=x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f((this._vf.fieldOfView[0]+this._vf.fieldOfView[2])/2,(this._vf.fieldOfView[1]+this._vf.fieldOfView[3])/2,0));this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()),this._viewMatrix=this._viewMatrix.mult(e).inverse(),this._vf.isActive&&this._nameSpace&&this._nameSpace.doc._viewarea&&this._nameSpace.doc._viewarea.resetNavHelpers()},getNear:function(){return this._vf.zNear},getFar:function(){return this._vf.zFar},getProjectionMatrix:function(e){if(null==this._projMatrix||this._lastAspect!=e){var t=this.getNear(),i=this.getFar(),o=this._vf.fieldOfView[0],s=this._vf.fieldOfView[1],r=this._vf.fieldOfView[2],n=this._vf.fieldOfView[3];this._projMatrix=x3dom.fields.SFMatrix4f.ortho(o,r,s,n,t,i,e)}return this._lastAspect=e,this._projMatrix}})),x3dom.registerNodeType("Viewfrustum","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(e){x3dom.nodeTypes.Viewfrustum.superClass.call(this,e),this.addField_SFMatrix4f(e,"modelview",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this.addField_SFMatrix4f(e,"projection",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this._viewMatrix=this._vf.modelview.transpose().inverse(),this._projMatrix=this._vf.projection.transpose(),this._centerOfRotation=new x3dom.fields.SFVec3f(0,0,0)},{fieldChanged:function(e){"modelview"==e?this.resetView():"projection"==e?this._projMatrix=this._vf.projection.transpose():e.indexOf("bind")>=0&&this.bind(this._vf.bind)},getCenterOfRotation:function(){return this.getCurrentTransform().multMatrixPnt(this._centerOfRotation)},setCenterOfRotation:function(e){this._centerOfRotation.setValues(e)},getViewMatrix:function(){return this._viewMatrix},getFieldOfView:function(){return 2*Math.atan(1/this._projMatrix._11)},getImgPlaneHeightAtDistOne:function(){return 2/this._projMatrix._11},resetView:function(){this._viewMatrix=this._vf.modelview.transpose().inverse(),this._centerOfRotation=new x3dom.fields.SFVec3f(0,0,0)},getProjectionMatrix:function(){return this._projMatrix}})),x3dom.registerNodeType("X3DNavigationInfoNode","Navigation",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){x3dom.nodeTypes.X3DNavigationInfoNode.superClass.call(this,e)})),x3dom.registerNodeType("NavigationInfo","Navigation",defineClass(x3dom.nodeTypes.X3DNavigationInfoNode,function(e){x3dom.nodeTypes.NavigationInfo.superClass.call(this,e),this.addField_SFBool(e,"headlight",!0),this.addField_MFString(e,"type",["EXAMINE","ANY"]),this.addField_MFFloat(e,"typeParams",[-.4,60,.05,2.8]),this.addField_SFString(e,"explorationMode","all"),this.addField_MFFloat(e,"avatarSize",[.25,1.6,.75]),this.addField_SFFloat(e,"visibilityLimit",0),this.addField_SFFloat(e,"speed",1),this.addField_SFTime(e,"transitionTime",1),this.addField_MFString(e,"transitionType",["LINEAR"]),this._validTypes=["none","examine","turntable","fly","freefly","lookat","lookaround","walk","game","helicopter","any"],this._heliUpdated=!1;var t=this.checkType(this.getType());x3dom.debug.logInfo("NavType: "+t)},{fieldChanged:function(e){if("typeParams"==e)this._heliUpdated=!1;else if("type"==e){var t=this.checkType(this.getType());switch(t){case"game":this._nameSpace.doc._viewarea.initMouseState();break;case"helicopter":this._heliUpdated=!1;break;case"turntable":this._nameSpace.doc._viewarea.initMouseState(),this._nameSpace.doc._viewarea.initTurnTable(this)}this._vf.type[0]=t,x3dom.debug.logInfo("Switch to "+t+" mode.")}},setType:function(e,t){var i=this.checkType(e.toLowerCase()),o=this.checkType(this.getType());switch(i){case"game":o!==i&&(t?t.initMouseState():this._nameSpace.doc._viewarea.initMouseState());break;case"helicopter":o!==i&&(this._heliUpdated=!1);break;case"turntable":o!==i&&(t?(t.initMouseState(),t.initTurnTable(this)):(this._nameSpace.doc._viewarea.initMouseState(),this._nameSpace.doc._viewarea.initTurnTable(this)))}this._vf.type[0]=i,x3dom.debug.logInfo("Switch to "+i+" mode.")},getType:function(){var e=this._vf.type[0].toLowerCase();return e.length<=1?e="none":"any"==e&&(e="examine"),e},getTypeParams:function(){var e=this._vf.typeParams.length,t=e>=1?this._vf.typeParams[0]:-.4,i=e>=2?this._vf.typeParams[1]:60,o=e>=3?this._vf.typeParams[2]:x3dom.fields.Eps,s=e>=4?this._vf.typeParams[3]:Math.PI-x3dom.fields.Eps,r=[t,i,o,s];return e>=5&&r.push(this._vf.typeParams[4]),r},setTypeParams:function(e){for(var t=0;t<e.length;t++)this._vf.typeParams[t]=e[t]},checkType:function(e){return this._validTypes.indexOf(e)>-1?e:(x3dom.debug.logWarning(e+" is no valid navigation type, use one of "+this._validTypes.toString()),"examine")},getExplorationMode:function(){switch(this._vf.explorationMode.toLowerCase()){case"all":return 7;case"rotate":return 1;case"zoom":return 2;case"pan":return 4;case"none":return 0;default:return 7}}})),x3dom.registerNodeType("Billboard","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Billboard.superClass.call(this,e),this.addField_SFVec3f(e,"axisOfRotation",0,1,0),this._eye=new x3dom.fields.SFVec3f(0,0,0),this._eyeViewUp=new x3dom.fields.SFVec3f(0,0,0),this._eyeLook=new x3dom.fields.SFVec3f(0,0,0)},{collectDrawableObjects:function(e,t,i,o,s,r){if(i&&this._parentNodes.length>1&&(i=!1),i&&(o=o||this.cacheInvalid())&&this.invalidateCache(),s=t.cull(e,this.graphState(),i,s),!(0>s)){i=!1;var n=this.getVolume(),a=x3dom.fields.SFVec3f.MAX(),d=x3dom.fields.SFVec3f.MIN();n.getBounds(a,d);var l=t.viewMatrix,h=new x3dom.fields.SFVec3f(0,0,0);h=l.inverse().multMatrixPnt(h);var u=l.mult(e);this._eye=e.inverse().multMatrixPnt(h),this._eyeViewUp=new x3dom.fields.SFVec3f(u._10,u._11,u._12),this._eyeLook=new x3dom.fields.SFVec3f(u._20,u._21,u._22);var f=x3dom.fields.SFMatrix4f.identity(),_=d.add(a).multiply(.5),c=this._eye.subtract(_);if(this._vf.axisOfRotation.equals(new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.Eps)){var m=x3dom.fields.Quaternion.rotateFromTo(c,new x3dom.fields.SFVec3f(0,0,1));f=m.toMatrix().transpose();var p=f.multMatrixPnt(new x3dom.fields.SFVec3f(0,1,0)).normalize(),x=f.multMatrixPnt(new x3dom.fields.SFVec3f(0,0,1)).normalize();if(!this._eyeViewUp.equals(new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.Eps)){var g=x3dom.fields.Quaternion.rotateFromTo(this._eyeLook,x),v=g.toMatrix().transpose().multMatrixVec(p),y=x3dom.fields.Quaternion.rotateFromTo(this._eyeViewUp,v);f=g.toMatrix().transpose().mult(f),f=y.toMatrix().transpose().mult(f)}}else{var b=this._vf.axisOfRotation.cross(c).normalize();this._eye.z<0&&(b=b.multiply(-1));var T=Math.asin(b.dot(new x3dom.fields.SFVec3f(0,0,1)));this._eye.z<0&&(T+=Math.PI),f=x3dom.fields.SFMatrix4f.parseRotation(this._vf.axisOfRotation.x+", "+this._vf.axisOfRotation.y+", "+this._vf.axisOfRotation.z+", "+-1*T)}for(var S=this.transformMatrix(e.mult(f)),M=0,C=this._childNodes.length;C>M;M++){var F=this._childNodes[M];F&&F.collectDrawableObjects(S,t,i,o,s,r)}}}})),x3dom.registerNodeType("Collision","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Collision.superClass.call(this,e),this.addField_SFBool(e,"enabled",!0),this.addField_SFNode("proxy",x3dom.nodeTypes.X3DGroupingNode),this.addField_SFTime(e,"collideTime",0),this.addField_SFBool(e,"isActive",!0)},{collectDrawableObjects:function(e,t,i,o,s,r){if(i&&this._parentNodes.length>1&&(i=!1),i&&(o=o||this.cacheInvalid())&&this.invalidateCache(),s=t.cull(e,this.graphState(),i,s),!(0>s)){var n,a;i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),a=this._graph.globalMatrix):a=this.transformMatrix(e);for(var d=0,l=this._childNodes.length;l>d;d++)(n=this._childNodes[d])&&n!==this._cf.proxy.node&&n.collectDrawableObjects(a,t,i,o,s,r)}}})),x3dom.registerNodeType("X3DLODNode","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.X3DLODNode.superClass.call(this,e),this.addField_SFBool(e,"forceTransitions",!1),this.addField_SFVec3f(e,"center",0,0,0),this._eye=new x3dom.fields.SFVec3f(0,0,0)},{collectDrawableObjects:function(e,t,i,o,s,r){i&&this._parentNodes.length>1&&(i=!1),i&&(o=o||this.cacheInvalid())&&this.invalidateCache(),s=t.cull(e,this.graphState(),i,s),0>s||(i=!1,this.visitChildren(e,t,i,o,s,r))},visitChildren:function(){}})),x3dom.registerNodeType("LOD","Navigation",defineClass(x3dom.nodeTypes.X3DLODNode,function(e){x3dom.nodeTypes.LOD.superClass.call(this,e),this.addField_MFFloat(e,"range",[]),this._lastRangePos=-1},{visitChildren:function(e,t,i,o,s,r){var n=0,a=this._childNodes.length,d=t.viewMatrix,l=new x3dom.fields.SFVec3f(0,0,0);l=d.inverse().multMatrixPnt(l),this._eye=e.inverse().multMatrixPnt(l);for(var h=this._vf.center.subtract(this._eye).length();n<this._vf.range.length&&h>this._vf.range[n];)n++;n&&n>=a&&(n=a-1),this._lastRangePos=n;var u=this._childNodes[n];if(a&&u){var f=this.transformMatrix(e);u.collectDrawableObjects(f,t,i,o,s,r)}},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this._vf.render){var t,i;if(this._lastRangePos>=0)t=this._childNodes[this._lastRangePos],i=t&&t._vf.render===!0?t.getVolume():null,i&&i.isValid()&&e.extendBounds(i.min,i.max);else for(var o=0,s=this._childNodes.length;s>o;o++)(t=this._childNodes[o])&&t._vf.render===!0&&(i=t.getVolume(),i&&i.isValid()&&e.extendBounds(i.min,i.max))}return e},nodeChanged:function(){this.invalidateVolume()},fieldChanged:function(e){("render"==e||"center"==e||"range"==e)&&this.invalidateVolume()}})),x3dom.registerNodeType("DynamicLOD","Navigation",defineClass(x3dom.nodeTypes.X3DLODNode,function(e){x3dom.nodeTypes.DynamicLOD.superClass.call(this,e),this.addField_SFFloat(e,"subScale",.5),this.addField_SFVec2f(e,"size",2,2),this.addField_SFVec2f(e,"subdivision",1,1),this.addField_SFNode("root",x3dom.nodeTypes.X3DShapeNode),this.addField_SFString(e,"urlHead","http://r"),this.addField_SFString(e,"urlCenter",".ortho.tiles.virtualearth.net/tiles/h"),this.addField_SFString(e,"urlTail",".png?g=-1"),this.rootGeometry=new x3dom.nodeTypes.Plane(e),this.level=0,this.quadrant=4,this.cell=""},{nodeChanged:function(){var e=this._cf.root.node;null!=e&&null==e._cf.geometry.node&&(this.rootGeometry._vf.size.setValues(this._vf.size),this.rootGeometry._vf.subdivision.setValues(this._vf.subdivision),this.rootGeometry._vf.center.setValues(this._vf.center),this.rootGeometry.fieldChanged("subdivision"),this._cf.root.node.addChild(this.rootGeometry),this.rootGeometry.nodeChanged(),this._cf.root.node.nodeChanged(),this._nameSpace.doc.needRender=!0)},visitChildren:function(e,t,i,o,s,r){var n=this._cf.root.node;if(null!=n){var a=t.viewMatrix,d=new x3dom.fields.SFVec3f(0,0,0);d=a.inverse().multMatrixPnt(d),this._eye=e.inverse().multMatrixPnt(d);var l,h=this._vf.center.subtract(this._eye).length();if(h>x3dom.fields.Eps&&h*this._vf.subScale<=this._vf.size.length())if(this._childNodes.length<=1){var u=new Array(new x3dom.fields.SFVec3f(-.25*this._vf.size.x,.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(.25*this._vf.size.x,.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(-.25*this._vf.size.x,-.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(.25*this._vf.size.x,-.25*this._vf.size.y,0));for(l=0;4>l;l++){var f=new x3dom.nodeTypes.DynamicLOD;f._nameSpace=this._nameSpace,f._eye.setValues(this._eye),f.level=this.level+1,f.quadrant=l,f.cell=this.cell+l,f._vf.urlHead=this._vf.urlHead,f._vf.urlCenter=this._vf.urlCenter,f._vf.urlTail=this._vf.urlTail,f._vf.center=this._vf.center.add(u[l]),f._vf.size=this._vf.size.multiply(.5),f._vf.subdivision.setValues(this._vf.subdivision);var _=new x3dom.nodeTypes.Appearance,c=new x3dom.nodeTypes.ImageTexture;c._nameSpace=this._nameSpace,c._vf.url[0]=this._vf.urlHead+f.quadrant+this._vf.urlCenter+f.cell+this._vf.urlTail,_.addChild(c),c.nodeChanged();var m=new x3dom.nodeTypes.Shape;m._nameSpace=this._nameSpace,m.addChild(_),_.nodeChanged(),f.addChild(m,"root"),m.nodeChanged(),this.addChild(f),f.nodeChanged()}}else for(l=1;l<this._childNodes.length;l++)this._childNodes[l].collectDrawableObjects(e,t,i,o,s,r);else n.collectDrawableObjects(e,t,i,o,s,r)}},getVolume:function(){var e=this._graph.volume;return e.isValid()||(e.min.setValues(this._vf.center),e.min.x-=.5*this._vf.size.x,e.min.y-=.5*this._vf.size.y,e.min.z-=x3dom.fields.Eps,e.max.setValues(this._vf.center),e.max.x+=.5*this._vf.size.x,e.max.y+=.5*this._vf.size.y,e.max.z+=x3dom.fields.Eps),e}})),x3dom.registerNodeType("X3DFontStyleNode","Text",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DFontStyleNode.superClass.call(this,e)})),x3dom.registerNodeType("FontStyle","Text",defineClass(x3dom.nodeTypes.X3DFontStyleNode,function(e){x3dom.nodeTypes.FontStyle.superClass.call(this,e),this.addField_MFString(e,"family",["SERIF"]),this.addField_SFBool(e,"horizontal",!0),this.addField_MFString(e,"justify",["MIDDLE","MIDDLE"]),this.addField_SFString(e,"language",""),this.addField_SFBool(e,"leftToRight",!0),this.addField_SFFloat(e,"size",1),this.addField_SFFloat(e,"spacing",1),this.addField_SFString(e,"style","PLAIN"),this.addField_SFBool(e,"topToBottom",!0),this.addField_SFFloat(e,"quality",2)},{fieldChanged:function(e){("family"==e||"horizontal"==e||"justify"==e||"language"==e||"leftToRight"==e||"size"==e||"spacing"==e||"style"==e||"topToBottom"==e)&&Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e.setAllDirty()})})}})),x3dom.nodeTypes.FontStyle.defaultNode=function(){return x3dom.nodeTypes.FontStyle._defaultNode||(x3dom.nodeTypes.FontStyle._defaultNode=new x3dom.nodeTypes.FontStyle,x3dom.nodeTypes.FontStyle._defaultNode.nodeChanged()),x3dom.nodeTypes.FontStyle._defaultNode},x3dom.registerNodeType("Text","Text",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.Text.superClass.call(this,e),this.addField_MFString(e,"string",[]),this.addField_MFFloat(e,"length",[]),this.addField_SFFloat(e,"maxExtent",0),this.addField_SFNode("fontStyle",x3dom.nodeTypes.X3DFontStyleNode),this._mesh._positions[0]=[],this._mesh._normals[0]=[0,0,1,0,0,1,0,0,1,0,0,1],this._mesh._texCoords[0]=[0,0,1,0,1,1,0,1],this._mesh._colors[0]=[],this._mesh._indices[0]=[0,1,2,2,3,0],this._mesh._invalidate=!0,this._mesh._numFaces=2,this._mesh._numCoords=4},{nodeChanged:function(){this._cf.fontStyle.node||this.addChild(x3dom.nodeTypes.FontStyle.defaultNode()),this.invalidateVolume()},fieldChanged:function(e){("string"==e||"length"==e||"maxExtent"==e)&&(this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e.setAllDirty()}))}})),x3dom.registerNodeType("X3DSoundNode","Sound",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DSoundNode.superClass.call(this,e)})),x3dom.registerNodeType("Sound","Sound",defineClass(x3dom.nodeTypes.X3DSoundNode,function(e){x3dom.nodeTypes.Sound.superClass.call(this,e),this.addField_SFNode("source",x3dom.nodeTypes.X3DSoundSourceNode)},{nodeChanged:function(){if(!this._cf.source.node&&this._xmlNode){x3dom.debug.logInfo("No AudioClip child node given, searching for &lt;audio&gt; elements...");try{Array.forEach(this._xmlNode.childNodes,function(e){if(1===e.nodeType&&(x3dom.debug.logInfo("### Found &lt;"+e.nodeName+"&gt; tag."),"audio"===e.localName.toLowerCase())){var t=e.getAttribute("loop");t=t?"loop"===t.toLowerCase():!1;var i=e.cloneNode(!1);e.parentNode.removeChild(e),e=null,"Microsoft Internet Explorer"!=navigator.appName&&document.body.appendChild(i);var o=function(){i.play()},s=function(){t&&i.play()};i.addEventListener("canplaythrough",o,!0),i.addEventListener("ended",s,!0)}})}catch(e){x3dom.debug.logException(e)}}}})),x3dom.registerNodeType("X3DSoundSourceNode","Sound",defineClass(x3dom.nodeTypes.X3DTimeDependentNode,function(e){x3dom.nodeTypes.X3DSoundSourceNode.superClass.call(this,e)})),x3dom.registerNodeType("AudioClip","Sound",defineClass(x3dom.nodeTypes.X3DSoundSourceNode,function(e){x3dom.nodeTypes.AudioClip.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_SFBool(e,"enabled",!1),this.addField_SFBool(e,"loop",!1),this._audio=document.createElement("audio"),"Microsoft Internet Explorer"!=navigator.appName&&document.body.appendChild(this._audio),this._sources=[]},{nodeChanged:function(){this._createSources=function(){this._sources=[];for(var e=0;e<this._vf.url.length;e++){var t=this._nameSpace.getURL(this._vf.url[e]);x3dom.debug.logInfo("Adding sound file: "+t);var i=document.createElement("source");i.setAttribute("src",t),this._sources.push(i),this._audio.appendChild(i)}};var e=this;this._startAudio=function(){e._audio.loop=e._vf.loop?"loop":"",e._vf.enabled===!0&&e._audio.play()},this._stopAudio=function(){e._audio.pause()},this._audioEnded=function(){e._vf.enabled===!0&&e._vf.loop===!0&&e._startAudio()};var t=function(e){x3dom.debug.logWarning("MediaEvent error:"+e)};this._audio.addEventListener("canplaythrough",this._startAudio,!0),this._audio.addEventListener("ended",this._audioEnded,!0),this._audio.addEventListener("error",t,!0),this._audio.addEventListener("pause",this._audioEnded,!0),this._createSources()},fieldChanged:function(e){if("enabled"===e)this._vf.enabled===!0?this._startAudio():this._stopAudio();else if("loop"===e);else if("url"===e){for(this._stopAudio();this._audio.hasChildNodes();)this._audio.removeChild(this._audio.firstChild);for(var t=0;t<this._vf.url.length;t++){var i=this._nameSpace.getURL(this._vf.url[t]);x3dom.debug.logInfo("Adding sound file: "+i);var o=document.createElement("source");o.setAttribute("src",i),this._audio.appendChild(o)}}},shutdown:function(){if(this._audio){for(this._audio.pause();this._audio.hasChildNodes();)this._audio.removeChild(this._audio.firstChild);document.body.removeChild(this._audio),this._audio=null}}})),x3dom.registerNodeType("X3DTextureTransformNode","Texturing",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.X3DTextureTransformNode.superClass.call(this,e)})),x3dom.registerNodeType("TextureTransform","Texturing",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,function(e){x3dom.nodeTypes.TextureTransform.superClass.call(this,e),this.addField_SFVec2f(e,"center",0,0),this.addField_SFFloat(e,"rotation",0),this.addField_SFVec2f(e,"scale",1,1),this.addField_SFVec2f(e,"translation",0,0);var t=new x3dom.fields.SFVec3f(-this._vf.center.x,-this._vf.center.y,1),i=new x3dom.fields.SFVec3f(this._vf.center.x,this._vf.center.y,0),o=new x3dom.fields.SFVec3f(this._vf.translation.x,this._vf.translation.y,0),s=new x3dom.fields.SFVec3f(this._vf.scale.x,this._vf.scale.y,0);this._trafo=x3dom.fields.SFMatrix4f.translation(t).mult(x3dom.fields.SFMatrix4f.scale(s)).mult(x3dom.fields.SFMatrix4f.rotationZ(this._vf.rotation)).mult(x3dom.fields.SFMatrix4f.translation(i.add(o)))},{fieldChanged:function(e){if("center"==e||"rotation"==e||"scale"==e||"translation"==e){var t=new x3dom.fields.SFVec3f(-this._vf.center.x,-this._vf.center.y,1),i=new x3dom.fields.SFVec3f(this._vf.center.x,this._vf.center.y,0),o=new x3dom.fields.SFVec3f(this._vf.translation.x,this._vf.translation.y,0),s=new x3dom.fields.SFVec3f(this._vf.scale.x,this._vf.scale.y,0);this._trafo=x3dom.fields.SFMatrix4f.translation(t).mult(x3dom.fields.SFMatrix4f.scale(s)).mult(x3dom.fields.SFMatrix4f.rotationZ(this._vf.rotation)).mult(x3dom.fields.SFMatrix4f.translation(i.add(o)))}},texTransformMatrix:function(){return this._trafo}})),x3dom.registerNodeType("TextureProperties","Texturing",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.TextureProperties.superClass.call(this,e),this.addField_SFFloat(e,"anisotropicDegree",1),this.addField_SFColorRGBA(e,"borderColor",0,0,0,0),this.addField_SFInt32(e,"borderWidth",0),this.addField_SFString(e,"boundaryModeS","REPEAT"),this.addField_SFString(e,"boundaryModeT","REPEAT"),this.addField_SFString(e,"boundaryModeR","REPEAT"),this.addField_SFString(e,"magnificationFilter","FASTEST"),this.addField_SFString(e,"minificationFilter","FASTEST"),this.addField_SFString(e,"textureCompression","FASTEST"),this.addField_SFFloat(e,"texturePriority",0),this.addField_SFBool(e,"generateMipMaps",!1)},{fieldChanged:function(e){this._vf.hasOwnProperty(e)&&(Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0})})}),this._nameSpace.doc.needRender=!0)}})),x3dom.registerNodeType("X3DTextureNode","Texturing",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.X3DTextureNode.superClass.call(this,e),this.addField_SFInt32(e,"origChannelCount",0),this.addField_MFString(e,"url",[]),this.addField_SFBool(e,"repeatS",!0),this.addField_SFBool(e,"repeatT",!0),this.addField_SFBool(e,"scale",!0),this.addField_SFString(e,"crossOrigin",""),this.addField_SFNode("textureProperties",x3dom.nodeTypes.TextureProperties),this._needPerFrameUpdate=!1,this._isCanvas=!1,this._type="diffuseMap",this._blending=1==this._vf.origChannelCount||2==this._vf.origChannelCount},{invalidateGLObject:function(){Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)?e._dirty.texture=!0:Array.forEach(e._parentNodes,function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)?e._dirty.texture=!0:Array.forEach(e._parentNodes,function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)&&(e._dirty.texture=!0)})})})}),this._nameSpace.doc.needRender=!0},parentAdded:function(e){Array.forEach(e._parentNodes,function(e){x3dom.isa(e,x3dom.nodeTypes.Shape)?e._dirty.texture=!0:Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0})})},parentRemoved:function(e){Array.forEach(e._parentNodes,function(e){x3dom.isa(e,x3dom.nodeTypes.Shape)?e._dirty.texture=!0:Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0})})},fieldChanged:function(e){if("url"==e||"origChannelCount"==e||"repeatS"==e||"repeatT"==e||"scale"==e||"crossOrigin"==e){var t=this;Array.forEach(this._parentNodes,function(e){if(x3dom.isa(e,x3dom.nodeTypes.X3DAppearanceNode))e.nodeChanged(),Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0});else if(x3dom.isa(e,x3dom.nodeTypes.MultiTexture))Array.forEach(e._parentNodes,function(e){e.nodeChanged(),Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0})});else if(x3dom.isa(e,x3dom.nodeTypes.ImageGeometry)){var i=null;t._xmlNode&&t._xmlNode.hasAttribute("containerField")&&(i=t._xmlNode.getAttribute("containerField"),e._dirty[i]=!0)}else if(void 0!==x3dom.nodeTypes.X3DVolumeDataNode)if(x3dom.isa(e,x3dom.nodeTypes.X3DVolumeRenderStyleNode)){if(t._xmlNode&&t._xmlNode.hasAttribute("containerField"))if(e._volumeDataParent)e._volumeDataParent._dirty.texture=!0;else{for(var o=e._parentNodes[0];!x3dom.isa(o,x3dom.nodeTypes.X3DVolumeDataNode)&&x3dom.isa(o,x3dom.nodeTypes.X3DNode);)o=o._parentNodes[0];x3dom.isa(o,x3dom.nodeTypes.X3DNode)&&(o._dirty.texture=!0)}}else x3dom.isa(e,x3dom.nodeTypes.X3DVolumeDataNode)&&t._xmlNode&&t._xmlNode.hasAttribute("containerField")&&(e._dirty.texture=!0)})}},getTexture:function(e){return 0===e?this:null},size:function(){return 1}})),x3dom.registerNodeType("MultiTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.MultiTexture.superClass.call(this,e),this.addField_MFNode("texture",x3dom.nodeTypes.X3DTextureNode)},{getTexture:function(e){return e>=0&&e<this._cf.texture.nodes.length?this._cf.texture.nodes[e]:null},getTextures:function(){return this._cf.texture.nodes},size:function(){return this._cf.texture.nodes.length}})),x3dom.registerNodeType("Texture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.Texture.superClass.call(this,e),this.addField_SFBool(e,"hideChildren",!0),this._video=null,this._intervalID=0,this._canvas=null},{nodeChanged:function(){if(!this._vf.url.length&&this._xmlNode){x3dom.debug.logInfo("No Texture URL given, searching for &lt;img&gt; elements...");var e=this;try{Array.forEach(this._xmlNode.childNodes,function(t){if(1===t.nodeType){var i=t.getAttribute("src");if(i){if(e._vf.url.push(i),x3dom.debug.logInfo(e._vf.url[e._vf.url.length-1]),"video"===t.localName.toLowerCase()){e._needPerFrameUpdate=!0,e._video=document.createElement("video"),e._video.setAttribute("preload","auto"),e._video.setAttribute("muted","muted");var o=document.getElementsByTagName("body")[0];o.appendChild(e._video),e._video.style.display="none",e._video.style.visibility="hidden"}}else"canvas"===t.localName.toLowerCase()&&(e._needPerFrameUpdate=!0,e._isCanvas=!0,e._canvas=t);t.style&&e._vf.hideChildren&&(t.style.display="none",t.style.visibility="hidden"),x3dom.debug.logInfo("### Found &lt;"+t.nodeName+"&gt; tag.")}})}catch(t){x3dom.debug.logException(t)}}},shutdown:function(){if(this._video){for(this._video.pause();this._video.hasChildNodes();)this._video.removeChild(this._video.firstChild);document.body.removeChild(this._video),this._video=null}}})),x3dom.registerNodeType("RenderedTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.RenderedTexture.superClass.call(this,e),e?e.doc._nodeBag.renderTextures.push(this):x3dom.debug.logWarning("RenderedTexture: No runtime context found!"),this.addField_SFNode("viewpoint",x3dom.nodeTypes.X3DViewpointNode),this.addField_SFNode("background",x3dom.nodeTypes.X3DBackgroundNode),this.addField_SFNode("fog",x3dom.nodeTypes.X3DFogNode),this.addField_SFNode("scene",x3dom.nodeTypes.X3DNode),this.addField_MFNode("excludeNodes",x3dom.nodeTypes.X3DNode),this.addField_MFInt32(e,"dimensions",[128,128,4]),this.addField_SFString(e,"update","NONE"),this.addField_SFBool(e,"showNormals",!1),this.addField_SFString(e,"stereoMode","NONE"),this.addField_SFFloat(e,"interpupillaryDistance",.064),this.addField_SFBool(e,"depthMap",!1),this.addField_SFBool(e,"oculusRiftVersion",1),this.hScreenSize=1==this._vf.oculusRiftVersion?.14976:.12576,this.vScreenSize=1==this._vf.oculusRiftVersion?.09356:.07074,this.vScreenCenter=this.vScreenSize/2,this.eyeToScreenDistance=.041,this.lensSeparationDistance=.0635,this.distortionK=[1,.22,.24,0],this.lensCenter=.151976495726,x3dom.debug.assert(this._vf.dimensions.length>=3,"RenderedTexture.dimensions requires at least 3 entries."),this._clearParents=!0,this._needRenderUpdate=!0,this.checkDepthTextureSupport=function(){this._vf.depthMap&&null===x3dom.caps.DEPTH_TEXTURE&&x3dom.debug.logWarning("RenderedTexture Node: depth texture extension not supported")},this.checkDepthTextureSupport()},{nodeChanged:function(){this._clearParents=!0,this._needRenderUpdate=!0},fieldChanged:function(e){switch(e){case"excludeNodes":this._clearParents=!0;break;case"update":("NEXT_FRAME_ONLY"==this._vf.update.toUpperCase()||"ALWAYS"==this._vf.update.toUpperCase())&&(this._needRenderUpdate=!0);break;case"depthMap":this.checkDepthTextureSupport(),this._x3domTexture.updateTexture(),this._needRenderUpdate=!0}},getViewMatrix:function(){if(this._clearParents&&this._cf.excludeNodes.nodes.length){var e=this;Array.forEach(this._cf.excludeNodes.nodes,function(t){for(var i=0,o=t._parentNodes.length;o>i;i++)t._parentNodes[i]===e&&(t._parentNodes.splice(i,1),
t.parentRemoved(e))}),this._clearParents=!1}var t=this._cf.scene.node,i=this._nameSpace.doc._scene,o=i.getViewpoint(),s=this._cf.viewpoint.node,r=null;if(null===s||s===o)r=this._nameSpace.doc._viewarea.getViewMatrix();else if(t&&t!==i)r=s.getViewMatrix();else{var n=s.getCurrentTransform();r=s.getViewMatrix().mult(n.inverse())}var a=this._vf.stereoMode.toUpperCase();if("NONE"!=a){var d=this._vf.interpupillaryDistance/2;"RIGHT_EYE"==a&&(d=-d);var l=new x3dom.fields.SFMatrix4f(1,0,0,d,0,1,0,0,0,0,1,0,0,0,0,1);r=l.mult(r)}return r},getProjectionMatrix:function(){var e,t=this._nameSpace.doc,i=t._scene.getViewpoint(),o=this._cf.viewpoint.node,s=null,r=this._vf.dimensions[0],n=this._vf.dimensions[1],a=this._vf.stereoMode.toUpperCase(),d="NONE"!=a;if(null===o||o===i?(s=x3dom.fields.SFMatrix4f.copy(t._viewarea.getProjectionMatrix()),d?(e=2*Math.atan(this.vScreenSize/(2*this.eyeToScreenDistance)),e=1/Math.tan(e/2)):e=1/Math.tan(i._vf.fieldOfView/2),s._00=e/(r/n),s._11=e):s=o.getProjectionMatrix(r/n),d){var l=this.lensCenter;"RIGHT_EYE"==a&&(l=-l);var h=new x3dom.fields.SFMatrix4f(1,0,0,l,0,1,0,0,0,0,1,0,0,0,0,1);s=h.mult(s)}return s},getWCtoCCMatrix:function(){var e=this.getViewMatrix(),t=this.getProjectionMatrix();return t.mult(e)},parentRemoved:function(){if(0===this._parentNodes.length)for(var e=this.findX3DDoc(),t=0,i=e._nodeBag.renderTextures.length;i>t;t++)e._nodeBag.renderTextures[t]===this&&e._nodeBag.renderTextures.splice(t,1);this._cf.scene.node&&this._cf.scene.node.parentRemoved(this)},requirePingPong:function(){return!1}})),x3dom.registerNodeType("RefinementTexture","Texturing",defineClass(x3dom.nodeTypes.RenderedTexture,function(e){if(x3dom.nodeTypes.RefinementTexture.superClass.call(this,e),this.addField_SFString(e,"stamp0","gpuii/stamps/0.gif"),this.addField_SFString(e,"stamp1","gpuii/stamps/1.gif"),this.addField_SFBool(e,"autoRefinement",!0),this.addField_SFString(e,"format","jpg"),this.addField_SFInt32(e,"iterations",7),this.addField_SFInt32(e,"maxLevel",this._vf.iterations),this._vf.iterations%2===0){var t=this._vf.stamp0;this._vf.stamp0=this._vf.stamp1,this._vf.stamp1=t}this._vf.iterations=this._vf.iterations>11?11:this._vf.iterations,this._vf.iterations=this._vf.iterations<3?3:this._vf.iterations,this._vf.maxLevel=this._vf.maxLevel>11?11:this._vf.maxLevel,this._vf.maxLevel=this._vf.maxLevel<3?3:this._vf.maxLevel,this._vf.maxLevel=this._vf.maxLevel>this._vf.iterations?this._vf.iterations:this._vf.maxLevel;var i=[{x:4,y:8},{x:8,y:8},{x:8,y:16},{x:16,y:16},{x:16,y:32},{x:32,y:32},{x:32,y:64},{x:64,y:64},{x:64,y:128}];this._repeat=new x3dom.fields.SFVec2f(this._vf.dimensions[0]/i[this._vf.iterations-3].x,this._vf.dimensions[1]/i[this._vf.iterations-3].y),this._renderedImage=0,this._currLoadLevel=0,this._loadLevel=1},{nextLevel:function(){this._loadLevel<this._vf.maxLevel&&(this._loadLevel++,this._nameSpace.doc.needRender=!0)},requirePingPong:function(){return this._currLoadLevel<=this._vf.maxLevel&&this._renderedImage<this._loadLevel}})),x3dom.registerNodeType("PixelTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.PixelTexture.superClass.call(this,e),this.addField_SFImage(e,"image",0,0,0)},{fieldChanged:function(e){"image"==e&&this.invalidateGLObject()},getWidth:function(){return this._vf.image.width},getHeight:function(){return this._vf.image.height},getComponents:function(){return this._vf.image.comp},setPixel:function(e,t,i,o){o=void 0==o?!0:o,this._x3domTexture?(this._x3domTexture.setPixel(e,t,[255*i.r,255*i.g,255*i.b,255*i.a],o),this._vf.image.setPixel(e,t,i)):(this._vf.image.setPixel(e,t,i),o&&this.invalidateGLObject())},getPixel:function(e,t){return this._vf.image.getPixel(e,t)},setPixels:function(e,t){t=void 0==t?!0:t,this._vf.image.setPixels(e),t&&this.invalidateGLObject()},getPixels:function(){return this._vf.image.getPixels()}})),x3dom.registerNodeType("ImageTexture","Texturing",defineClass(x3dom.nodeTypes.Texture,function(e){x3dom.nodeTypes.ImageTexture.superClass.call(this,e)})),x3dom.registerNodeType("MovieTexture","Texturing",defineClass(x3dom.nodeTypes.Texture,function(e){x3dom.nodeTypes.MovieTexture.superClass.call(this,e),this.addField_SFBool(e,"loop",!1),this.addField_SFFloat(e,"speed",1),this.addField_SFTime(e,"pauseTime",0),this.addField_SFFloat(e,"pitch",1),this.addField_SFTime(e,"resumeTime",0),this.addField_SFTime(e,"startTime",0),this.addField_SFTime(e,"stopTime",0)})),x3dom.registerNodeType("X3DTextureCoordinateNode","Texturing",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.X3DTextureCoordinateNode.superClass.call(this,e)},{fieldChanged:function(e){("texCoord"===e||"point"===e||"parameter"===e||"mode"===e)&&Array.forEach(this._parentNodes,function(e){e.fieldChanged("texCoord")})},parentAdded:function(e){e._mesh&&e._cf.texCoord.node!==this&&e.fieldChanged("texCoord")}})),x3dom.registerNodeType("TextureCoordinate","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(e){x3dom.nodeTypes.TextureCoordinate.superClass.call(this,e),this.addField_MFVec2f(e,"point",[])})),x3dom.registerNodeType("TextureCoordinateGenerator","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(e){x3dom.nodeTypes.TextureCoordinateGenerator.superClass.call(this,e),this.addField_SFString(e,"mode","SPHERE"),this.addField_MFFloat(e,"parameter",[])})),x3dom.registerNodeType("MultiTextureCoordinate","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(e){x3dom.nodeTypes.MultiTextureCoordinate.superClass.call(this,e),this.addField_MFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode)})),x3dom.registerNodeType("ImageTextureAtlas","Texturing",defineClass(x3dom.nodeTypes.Texture,function(e){x3dom.nodeTypes.ImageTextureAtlas.superClass.call(this,e),this.addField_SFInt32(e,"numberOfSlices",0),this.addField_SFInt32(e,"slicesOverX",0),this.addField_SFInt32(e,"slicesOverY",0)})),x3dom.registerNodeType("X3DEnvironmentTextureNode","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.X3DEnvironmentTextureNode.superClass.call(this,e)},{getTexUrl:function(){return[]},getTexSize:function(){return-1}})),x3dom.registerNodeType("ComposedCubeMapTexture","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DEnvironmentTextureNode,function(e){x3dom.nodeTypes.ComposedCubeMapTexture.superClass.call(this,e),this.addField_SFNode("back",x3dom.nodeTypes.Texture),this.addField_SFNode("front",x3dom.nodeTypes.Texture),this.addField_SFNode("bottom",x3dom.nodeTypes.Texture),this.addField_SFNode("top",x3dom.nodeTypes.Texture),this.addField_SFNode("left",x3dom.nodeTypes.Texture),this.addField_SFNode("right",x3dom.nodeTypes.Texture),this._type="environmentMap"},{getTexUrl:function(){return[this._nameSpace.getURL(this._cf.back.node._vf.url[0]),this._nameSpace.getURL(this._cf.front.node._vf.url[0]),this._nameSpace.getURL(this._cf.bottom.node._vf.url[0]),this._nameSpace.getURL(this._cf.top.node._vf.url[0]),this._nameSpace.getURL(this._cf.left.node._vf.url[0]),this._nameSpace.getURL(this._cf.right.node._vf.url[0])]}})),x3dom.registerNodeType("GeneratedCubeMapTexture","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DEnvironmentTextureNode,function(e){x3dom.nodeTypes.GeneratedCubeMapTexture.superClass.call(this,e),this.addField_SFInt32(e,"size",128),this.addField_SFString(e,"update","NONE"),this._type="cubeMap",x3dom.debug.logWarning("GeneratedCubeMapTexture NYI")},{getTexSize:function(){return this._vf.size}})),x3dom.registerNodeType("Uniform","Shaders",defineClass(x3dom.nodeTypes.Field,function(e){x3dom.nodeTypes.Uniform.superClass.call(this,e)})),x3dom.registerNodeType("Varying","Shaders",defineClass(x3dom.nodeTypes.Field,function(e){x3dom.nodeTypes.Varying.superClass.call(this,e)})),x3dom.registerNodeType("SurfaceShaderTexture","Shaders",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.SurfaceShaderTexture.superClass.call(this,e),this.addField_SFInt32(e,"textureCoordinatesId",0),this.addField_SFString(e,"channelMask","DEFAULT"),this.addField_SFBool(e,"isSRGB",!1),this.addField_SFNode("texture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("textureTransform",x3dom.nodeTypes.X3DTextureTransformNode)})),x3dom.registerNodeType("X3DShaderNode","Shaders",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.X3DShaderNode.superClass.call(this,e),this.addField_SFString(e,"language","")})),x3dom.registerNodeType("CommonSurfaceShader","Shaders",defineClass(x3dom.nodeTypes.X3DShaderNode,function(e){x3dom.nodeTypes.CommonSurfaceShader.superClass.call(this,e),this.addField_SFInt32(e,"tangentTextureCoordinatesId",-1),this.addField_SFInt32(e,"binormalTextureCoordinatesId",-1),this.addField_SFVec3f(e,"emissiveFactor",0,0,0),this.addField_SFInt32(e,"emissiveTextureId",-1),this.addField_SFInt32(e,"emissiveTextureCoordinatesId",0),this.addField_SFString(e,"emissiveTextureChannelMask","rgb"),this.addField_SFVec3f(e,"ambientFactor",.2,.2,.2),this.addField_SFInt32(e,"ambientTextureId",-1),this.addField_SFInt32(e,"ambientTextureCoordinatesId",0),this.addField_SFString(e,"ambientTextureChannelMask","rgb"),this.addField_SFVec3f(e,"diffuseFactor",.8,.8,.8),this.addField_SFInt32(e,"diffuseTextureId",-1),this.addField_SFInt32(e,"diffuseTextureCoordinatesId",0),this.addField_SFString(e,"diffuseTextureChannelMask","rgb"),this.addField_SFVec3f(e,"specularFactor",0,0,0),this.addField_SFInt32(e,"specularTextureId",-1),this.addField_SFInt32(e,"specularTextureCoordinatesId",0),this.addField_SFString(e,"specularTextureChannelMask","rgb"),this.addField_SFFloat(e,"shininessFactor",.2),this.addField_SFInt32(e,"shininessTextureId",-1),this.addField_SFInt32(e,"shininessTextureCoordinatesId",0),this.addField_SFString(e,"shininessTextureChannelMask","a"),this.addField_SFString(e,"normalFormat","UNORM"),this.addField_SFString(e,"normalSpace","TANGENT"),this.addField_SFInt32(e,"normalTextureId",-1),this.addField_SFInt32(e,"normalTextureCoordinatesId",0),this.addField_SFString(e,"normalTextureChannelMask","rgb"),this.addField_SFVec3f(e,"reflectionFactor",0,0,0),this.addField_SFInt32(e,"reflectionTextureId",-1),this.addField_SFInt32(e,"reflectionTextureCoordinatesId",0),this.addField_SFString(e,"reflectionTextureChannelMask","rgb"),this.addField_SFVec3f(e,"transmissionFactor",0,0,0),this.addField_SFInt32(e,"transmissionTextureId",-1),this.addField_SFInt32(e,"transmissionTextureCoordinatesId",0),this.addField_SFString(e,"transmissionTextureChannelMask","rgb"),this.addField_SFVec3f(e,"environmentFactor",1,1,1),this.addField_SFInt32(e,"environmentTextureId",-1),this.addField_SFInt32(e,"environmentTextureCoordinatesId",0),this.addField_SFString(e,"environmentTextureChannelMask","rgb"),this.addField_SFFloat(e,"relativeIndexOfRefraction",1),this.addField_SFFloat(e,"fresnelBlend",0),this.addField_SFString(e,"displacementAxis","y"),this.addField_SFFloat(e,"displacementFactor",255),this.addField_SFInt32(e,"displacementTextureId",-1),this.addField_SFInt32(e,"displacementTextureCoordinatesId",0),this.addField_SFNode("emissiveTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("ambientTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("diffuseTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("specularTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("shininessTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("normalTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("reflectionTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("transmissionTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("environmentTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("displacementTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("diffuseDisplacementTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("multiDiffuseAlphaTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("multiSpecularShininessTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("multiEmissiveAmbientTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("multiVisibilityTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFVec3f(e,"normalScale",2,2,2),this.addField_SFVec3f(e,"normalBias",-1,-1,-1),this.addField_SFFloat(e,"alphaFactor",1),this.addField_SFBool(e,"invertAlphaTexture",!1),this.addField_SFInt32(e,"alphaTextureId",-1),this.addField_SFInt32(e,"alphaTextureCoordinatesId",0),this.addField_SFString(e,"alphaTextureChannelMask","a"),this.addField_SFNode("alphaTexture",x3dom.nodeTypes.X3DTextureNode),this._dirty={}},{getDiffuseMap:function(){return this._cf.diffuseTexture.node?x3dom.isa(this._cf.diffuseTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.diffuseTexture.node._cf.texture.node._type="diffuseMap",this._cf.diffuseTexture.node._cf.texture.node):(this._cf.diffuseTexture.node._type="diffuseMap",this._cf.diffuseTexture.node):null},getEnvironmentMap:function(){return this._cf.environmentTexture.node?x3dom.isa(this._cf.environmentTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.environmentTexture.node._cf.texture.node._type="environmentMap",this._cf.environmentTexture.node._cf.texture.node):(this._cf.environmentTexture.node._type="environmentMap",this._cf.environmentTexture.node):null},getNormalMap:function(){return this._cf.normalTexture.node?x3dom.isa(this._cf.normalTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.normalTexture.node._cf.texture.node._type="normalMap",this._cf.normalTexture.node._cf.texture.node):(this._cf.normalTexture.node._type="normalMap",this._cf.normalTexture.node):null},getAmbientMap:function(){return this._cf.ambientTexture.node?x3dom.isa(this._cf.ambientTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.ambientTexture.node._cf.texture.node._type="ambientMap",this._cf.ambientTexture.node._cf.texture.node):(this._cf.ambientTexture.node._type="ambientMap",this._cf.ambientTexture.node):null},getSpecularMap:function(){return this._cf.specularTexture.node?x3dom.isa(this._cf.specularTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.specularTexture.node._cf.texture.node._type="specularMap",this._cf.specularTexture.node._cf.texture.node):(this._cf.specularTexture.node._type="specularMap",this._cf.specularTexture.node):null},getShininessMap:function(){return this._cf.shininessTexture.node?x3dom.isa(this._cf.shininessTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.shininessTexture.node._cf.texture.node._type="shininessMap",this._cf.shininessTexture.node._cf.texture.node):(this._cf.shininessTexture.node._type="shininessMap",this._cf.shininessTexture.node):null},getAlphaMap:function(){return this._cf.alphaTexture.node?x3dom.isa(this._cf.alphaTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.alphaTexture.node._cf.texture.node._type="alphaMap",this._cf.alphaTexture.node._cf.texture.node):(this._cf.alphaTexture.node._type="alphaMap",this._cf.alphaTexture.node):null},getDisplacementMap:function(){return this._cf.displacementTexture.node?x3dom.isa(this._cf.displacementTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.displacementTexture.node._cf.texture.node._type="displacementMap",this._cf.displacementTexture.node._cf.texture.node):(this._cf.displacementTexture.node._type="displacementMap",this._cf.displacementTexture.node):null},getDiffuseDisplacementMap:function(){return this._cf.diffuseDisplacementTexture.node?x3dom.isa(this._cf.diffuseDisplacementTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.diffuseDisplacementTexture.node._cf.texture.node._type="diffuseDisplacementMap",this._cf.diffuseDisplacementTexture.node._cf.texture.node):(this._cf.diffuseDisplacementTexture.node._type="diffuseDisplacementMap",this._cf.diffuseDisplacementTexture.node):null},getMultiDiffuseAlphaMap:function(){return this._cf.multiDiffuseAlphaTexture.node?x3dom.isa(this._cf.multiDiffuseAlphaTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.multiDiffuseAlphaTexture.node._cf.texture.node._type="multiDiffuseAlphaMap",this._cf.multiDiffuseAlphaTexture.node._cf.texture.node):(this._cf.multiDiffuseAlphaTexture.node._type="multiDiffuseAlphaMap",this._cf.multiDiffuseAlphaTexture.node):null},getMultiEmissiveAmbientMap:function(){return this._cf.multiEmissiveAmbientTexture.node?x3dom.isa(this._cf.multiEmissiveAmbientTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.multiEmissiveAmbientTexture.node._cf.texture.node._type="multiEmissiveAmbientMap",this._cf.multiEmissiveAmbientTexture.node._cf.texture.node):(this._cf.multiEmissiveAmbientTexture.node._type="multiEmissiveAmbientMap",this._cf.multiEmissiveAmbientTexture.node):null},getMultiSpecularShininessMap:function(){return this._cf.multiSpecularShininessTexture.node?x3dom.isa(this._cf.multiSpecularShininessTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.multiSpecularShininessTexture.node._cf.texture.node._type="multiSpecularShininessMap",this._cf.multiSpecularShininessTexture.node._cf.texture.node):(this._cf.multiSpecularShininessTexture.node._type="multiSpecularShininessMap",this._cf.multiSpecularShininessTexture.node):null},getMultiVisibilityMap:function(){return this._cf.multiVisibilityTexture.node?x3dom.isa(this._cf.multiVisibilityTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.multiVisibilityTexture.node._cf.texture.node._type="multiVisibilityMap",this._cf.multiVisibilityTexture.node._cf.texture.node):(this._cf.multiVisibilityTexture.node._type="multiVisibilityMap",this._cf.multiVisibilityTexture.node):null},getTextures:function(){var e=[],t=this.getDiffuseMap();t&&e.push(t);var i=this.getNormalMap();i&&e.push(i);var o=this.getSpecularMap();o&&e.push(o);var s=this.getShininessMap();s&&e.push(s);var r=this.getEnvironmentMap();r&&e.push(r);var n=this.getDisplacementMap();n&&e.push(n);var a=this.getDiffuseDisplacementMap();a&&e.push(a);var d=this.getMultiDiffuseAlphaMap();d&&e.push(d);var l=this.getMultiEmissiveAmbientMap();l&&e.push(l);var h=this.getMultiSpecularShininessMap();h&&e.push(h);var u=this.getMultiVisibilityMap();return u&&e.push(u),e},needTexcoords:function(){return this.getDiffuseMap()||this.getNormalMap()||this.getSpecularMap()||this.getShininessMap()||this.getDisplacementMap()||this.getDiffuseDisplacementMap()||this.getEnvironmentMap()?!0:!1}})),x3dom.registerNodeType("ComposedShader","Shaders",defineClass(x3dom.nodeTypes.X3DShaderNode,function(e){x3dom.nodeTypes.ComposedShader.superClass.call(this,e),this.addField_MFNode("fields",x3dom.nodeTypes.Field),this.addField_MFNode("parts",x3dom.nodeTypes.ShaderPart),this._vertex=null,this._fragment=null,this._id=null,x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown||(x3dom.debug.logInfo("Current ComposedShader node implementation limitations:\nVertex attributes (if given in the standard X3D fields 'coord', 'color', 'normal', 'texCoord'), matrices and texture are provided as follows...\n(see also <a href='http://x3dom.org/x3dom/doc/help/composedShader.html'>http://x3dom.org/x3dom/doc/help/composedShader.html</a>)\n    attribute vec3 position;\n    attribute vec3 normal;\n    attribute vec2 texcoord;\n    attribute vec3 color;\n    uniform mat4 modelViewProjectionMatrix;\n    uniform mat4 modelViewMatrix;\n    uniform mat4 normalMatrix;\n    uniform mat4 viewMatrix;\n    uniform sampler2D tex;\n"),x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown=!0)},{nodeChanged:function(){var e,t=this._cf.parts.nodes.length;for(e=0;t>e;e++)"vertex"==this._cf.parts.nodes[e]._vf.type.toLowerCase()?(this._vertex=this._cf.parts.nodes[e],this._id=this._cf.parts.nodes[e]._id):"fragment"==this._cf.parts.nodes[e]._vf.type.toLowerCase()&&(this._fragment=this._cf.parts.nodes[e],this._id+=" - "+this._cf.parts.nodes[e]._id);var i={};for(t=this._cf.fields.nodes.length,e=0;t>e;e++){var o=this._cf.fields.nodes[e]._vf.name;i.xmlNode=this._cf.fields.nodes[e]._xmlNode;var s=!1;(void 0===i.xmlNode||null===i.xmlNode)&&(i.xmlNode=document.createElement("field"),s=!0),i.xmlNode.setAttribute(o,this._cf.fields.nodes[e]._vf.value);var r="this.addField_"+this._cf.fields.nodes[e]._vf.type+"(ctx, name);",n=new Function("ctx","name",r);n.call(this,i,o),s&&(i.xmlNode=null)}Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e._cleanupGLObjects&&e._cleanupGLObjects(),e.setAllDirty()})})},fieldChanged:function(e){var t,i=this._cf.fields.nodes.length;for(t=0;i>t;t++){var o=this._cf.fields.nodes[t]._vf.name;if(o===e){var s=this._cf.fields.nodes[t]._vf.value;try{this._vf[o].setValueByStr(s)}catch(r){try{switch(_typeof(this._vf[o]).toString()){case"number":this._vf[o]=+s;break;case"boolean":this._vf[o]="true"===s.toLowerCase();break;case"string":this._vf[o]=s}}catch(n){x3dom.debug.logError("setValueByStr() NYI for "+_typeof(this._vf[o]))}}break}}"url"===o&&Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e._dirty.shader=!0})})},parentAdded:function(e){e.nodeChanged()}})),x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown=!1,x3dom.registerNodeType("ShaderPart","Shaders",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.ShaderPart.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_SFString(e,"type","VERTEX"),this._id=e&&e.xmlNode&&""!=e.xmlNode.id?e.xmlNode.id:++x3dom.nodeTypes.Shape.shaderPartID,x3dom.debug.assert("vertex"==this._vf.type.toLowerCase()||"fragment"==this._vf.type.toLowerCase(),"Unknown shader part type!")},{nodeChanged:function(){var e={};if(e.xmlNode=this._xmlNode,void 0!==e.xmlNode&&null!==e.xmlNode){var t=this;if(t._vf.url.length&&-1==t._vf.url[0].indexOf("\n")){var i=new XMLHttpRequest;i.open("GET",t._nameSpace.getURL(t._vf.url[0]),!1),i.onload=function(){t._vf.url=new x3dom.fields.MFString([]),t._vf.url.push(i.response)},i.onerror=function(){x3dom.debug.logError("Could not load file '"+t._vf.url[0]+"'.")},i.send(null)}else{t._vf.url.length&&(t._vf.url=new x3dom.fields.MFString([]));try{t._vf.url.push(e.xmlNode.childNodes[1].nodeValue),e.xmlNode.removeChild(e.xmlNode.childNodes[1])}catch(o){Array.forEach(e.xmlNode.childNodes,function(e){3===e.nodeType?t._vf.url.push(e.nodeValue):4===e.nodeType&&t._vf.url.push(e.data),e.parentNode.removeChild(e)})}}}Array.forEach(this._parentNodes,function(e){e.nodeChanged()})},fieldChanged:function(e){"url"===e&&Array.forEach(this._parentNodes,function(e){e.fieldChanged("url")})},parentAdded:function(e){e.nodeChanged()}})),x3dom.registerNodeType("X3DVertexAttributeNode","Shaders",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.X3DVertexAttributeNode.superClass.call(this,e),this.addField_SFString(e,"name","")})),x3dom.registerNodeType("FloatVertexAttribute","Shaders",defineClass(x3dom.nodeTypes.X3DVertexAttributeNode,function(e){x3dom.nodeTypes.FloatVertexAttribute.superClass.call(this,e),this.addField_SFInt32(e,"numComponents",4),this.addField_MFFloat(e,"value",[])},{fieldChanged:function(e){var t=this;("value"==e||"numComponents"==e)&&Array.forEach(this._parentNodes,function(e){e.fieldChanged("attrib_"+t._vf.name)})}})),x3dom.registerNodeType("X3DSpatialGeometryNode","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.X3DSpatialGeometryNode.superClass.call(this,e)})),x3dom.registerNodeType("Plane","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.Plane.superClass.call(this,e),this.addField_SFVec2f(e,"size",2,2),this.addField_SFVec2f(e,"subdivision",1,1),this.addField_SFVec3f(e,"center",0,0,0),this.addField_MFString(e,"primType",["TRIANGLES"]),this._vf.primType.length&&(this._mesh._primType=this._vf.primType[0]);var t=this._vf.size.x,i=this._vf.size.y,o=this._vf.subdivision.x,s=this._vf.subdivision.y,r="Plane_"+t+"-"+i+"-"+o+"-"+s+"-"+this._vf.center.x+"-"+this._vf.center.y+"-"+this._vf.center.z;if(e&&this._vf.useGeoCache&&void 0!==x3dom.geoCache[r])this._mesh=x3dom.geoCache[r];else{var n=0,a=0,d=t/o,l=i/s;for(t/=2,i/=2,a=0;s>=a;a++)for(n=0;o>=n;n++)this._mesh._positions[0].push(this._vf.center.x+n*d-t),this._mesh._positions[0].push(this._vf.center.y+a*l-i),this._mesh._positions[0].push(this._vf.center.z),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(n/o),this._mesh._texCoords[0].push(a/s);for(a=1;s>=a;a++)for(n=0;o>n;n++)this._mesh._indices[0].push((a-1)*(o+1)+n),this._mesh._indices[0].push((a-1)*(o+1)+n+1),this._mesh._indices[0].push(a*(o+1)+n),this._mesh._indices[0].push(a*(o+1)+n),this._mesh._indices[0].push((a-1)*(o+1)+n+1),this._mesh._indices[0].push(a*(o+1)+n+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[r]=this._mesh}},{fieldChanged:function(e){if("size"==e||"center"==e){this._mesh._positions[0]=[];var t=this._vf.size.x,i=this._vf.size.y,o=this._vf.subdivision.x,s=this._vf.subdivision.y,r=0,n=0,a=t/o,d=i/s;for(t/=2,i/=2,n=0;s>=n;n++)for(r=0;o>=r;r++)this._mesh._positions[0].push(this._vf.center.x+r*a-t),this._mesh._positions[0].push(this._vf.center.y+n*d-i),this._mesh._positions[0].push(this._vf.center.z);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})}else if("subdivision"==e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var t=this._vf.size.x,i=this._vf.size.y,o=this._vf.subdivision.x,s=this._vf.subdivision.y,r=0,n=0,a=t/o,d=i/s;for(t/=2,i/=2,n=0;s>=n;n++)for(r=0;o>=r;r++)this._mesh._positions[0].push(this._vf.center.x+r*a-t),this._mesh._positions[0].push(this._vf.center.y+n*d-i),this._mesh._positions[0].push(this._vf.center.z),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(r/o),this._mesh._texCoords[0].push(n/s);for(n=1;s>=n;n++)for(r=0;o>r;r++)this._mesh._indices[0].push((n-1)*(o+1)+r),this._mesh._indices[0].push((n-1)*(o+1)+r+1),this._mesh._indices[0].push(n*(o+1)+r),this._mesh._indices[0].push(n*(o+1)+r),this._mesh._indices[0].push((n-1)*(o+1)+r+1),this._mesh._indices[0].push(n*(o+1)+r+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty(),e.invalidateVolume()})}}})),x3dom.registerNodeType("Box","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.Box.superClass.call(this,e),this.addField_SFVec3f(e,"size",2,2,2),this.addField_SFBool(e,"hasHelperColors",!1);var t=this._vf.size.x,i=this._vf.size.y,o=this._vf.size.z,s="Box_"+t+"-"+i+"-"+o;this._vf.useGeoCache&&void 0!==x3dom.geoCache[s]?this._mesh=x3dom.geoCache[s]:(t/=2,i/=2,o/=2,this._mesh._positions[0]=[-t,-i,-o,-t,i,-o,t,i,-o,t,-i,-o,-t,-i,o,-t,i,o,t,i,o,t,-i,o,-t,-i,-o,-t,-i,o,-t,i,o,-t,i,-o,t,-i,-o,t,-i,o,t,i,o,t,i,-o,-t,i,-o,-t,i,o,t,i,o,t,i,-o,-t,-i,-o,-t,-i,o,t,-i,o,t,-i,-o],this._mesh._normals[0]=[0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],this._mesh._texCoords[0]=[1,0,1,1,0,1,0,0,0,0,0,1,1,1,1,0,0,0,1,0,1,1,0,1,1,0,0,0,0,1,1,1,0,1,0,0,1,0,1,1,0,0,0,1,1,1,1,0],this._vf.hasHelperColors&&(this._mesh._colors[0]=[0,0,0,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,1,1,1,1,0,1,0,0,0,0,0,1,0,1,1,0,1,0,1,0,0,1,0,1,1,1,1,1,1,0,0,1,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,0,1,1,0,0]),this._mesh._indices[0]=[0,1,2,2,3,0,4,7,5,5,7,6,8,9,10,10,11,8,12,14,13,14,12,15,16,17,18,18,19,16,20,22,21,22,20,23],this._mesh._invalidate=!0,this._mesh._numFaces=12,this._mesh._numCoords=24,x3dom.geoCache[s]=this._mesh)},{fieldChanged:function(e){if("size"===e){var t=this._vf.size.x/2,i=this._vf.size.y/2,o=this._vf.size.z/2;this._mesh._positions[0]=[-t,-i,-o,-t,i,-o,t,i,-o,t,-i,-o,-t,-i,o,-t,i,o,t,i,o,t,-i,o,-t,-i,-o,-t,-i,o,-t,i,o,-t,i,-o,t,-i,-o,t,-i,o,t,i,o,t,i,-o,-t,i,-o,-t,i,o,t,i,o,t,i,-o,-t,-i,-o,-t,-i,o,t,-i,o,t,-i,-o],this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})}else"hasHelperColors"===e&&(this._mesh._colors[0]=this._vf.hasHelperColors?[0,0,0,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,1,1,1,1,0,1,0,0,0,0,0,1,0,1,1,0,1,0,1,0,0,1,0,1,1,1,1,1,1,0,0,1,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,0,1,1,0,0]:[],Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0}))}})),x3dom.registerNodeType("Sphere","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.Sphere.superClass.call(this,e),this.addField_SFFloat(e,"radius",e?1:1e4),this.addField_SFVec2f(e,"subdivision",24,24);var t=1,i=this._vf.radius,o=this._vf.subdivision.x,s=this._vf.subdivision.y,r="Sphere_"+i+"-"+o+"-"+s;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[r])this._mesh=x3dom.geoCache[r];else{if(e&&(t=e.doc.properties.getProperty("PrimitiveQuality","Medium")),x3dom.Utils.isNumber(t))t=parseFloat(t);else switch(t.toLowerCase()){case"low":t=.3;break;case"medium":t=.5;break;case"high":t=1}this._quality=t;var n,a,d,l,h,u,f,_,c,m,p,x,g,v=Math.floor(o*t),y=Math.floor(s*t);for(n=0;v>=n;n++)for(d=n*Math.PI/v,l=Math.sin(d),h=Math.cos(d),a=0;y>=a;a++)u=2*a*Math.PI/y,f=Math.sin(u),_=Math.cos(u),c=-_*l,m=-h,p=-f*l,x=.25-a/y,g=n/v,this._mesh._positions[0].push(i*c),this._mesh._positions[0].push(i*m),this._mesh._positions[0].push(i*p),this._mesh._normals[0].push(c),this._mesh._normals[0].push(m),this._mesh._normals[0].push(p),this._mesh._texCoords[0].push(x),this._mesh._texCoords[0].push(g);var b,T;for(n=0;v>n;n++)for(a=0;y>a;a++)b=n*(y+1)+a,T=b+y+1,this._mesh._indices[0].push(b),this._mesh._indices[0].push(T),this._mesh._indices[0].push(b+1),this._mesh._indices[0].push(T),this._mesh._indices[0].push(T+1),this._mesh._indices[0].push(b+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[r]=this._mesh}},{fieldChanged:function(e){if("radius"===e){this._mesh._positions[0]=[];var t,i,o,s,r,n,a,d,l,h,u,f=this._vf.radius,_=this._vf.subdivision.x,c=this._vf.subdivision.y,m=this._quality,p=Math.floor(_*m),x=Math.floor(c*m);for(t=0;p>=t;t++)for(o=t*Math.PI/p,s=Math.sin(o),r=Math.cos(o),i=0;x>=i;i++)n=2*i*Math.PI/x,a=Math.sin(n),d=Math.cos(n),l=-d*s,h=-r,u=-a*s,this._mesh._positions[0].push(f*l),this._mesh._positions[0].push(f*h),this._mesh._positions[0].push(f*u);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})}else if("subdivision"===e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var t,i,o,s,r,n,a,d,l,h,u,g,v,f=this._vf.radius,_=this._vf.subdivision.x,c=this._vf.subdivision.y,m=this._quality,p=Math.floor(_*m),x=Math.floor(c*m);for(t=0;p>=t;t++)for(o=t*Math.PI/p,s=Math.sin(o),r=Math.cos(o),i=0;x>=i;i++)n=2*i*Math.PI/x,a=Math.sin(n),d=Math.cos(n),l=-d*s,h=-r,u=-a*s,g=.25-i/x,v=t/p,this._mesh._positions[0].push(f*l),this._mesh._positions[0].push(f*h),this._mesh._positions[0].push(f*u),this._mesh._normals[0].push(l),this._mesh._normals[0].push(h),this._mesh._normals[0].push(u),this._mesh._texCoords[0].push(g),this._mesh._texCoords[0].push(v);var y,b;for(t=0;p>t;t++)for(i=0;x>i;i++)y=t*(x+1)+i,b=y+x+1,this._mesh._indices[0].push(y),this._mesh._indices[0].push(b),this._mesh._indices[0].push(y+1),this._mesh._indices[0].push(b),this._mesh._indices[0].push(b+1),this._mesh._indices[0].push(y+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty(),e.invalidateVolume()})}}})),x3dom.registerNodeType("Torus","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.Torus.superClass.call(this,e);

var t=2*Math.PI;this.addField_SFFloat(e,"innerRadius",.5),this.addField_SFFloat(e,"outerRadius",1),this.addField_SFFloat(e,"angle",t),this.addField_SFBool(e,"caps",!0),this.addField_SFVec2f(e,"subdivision",24,24),this.addField_SFBool(e,"insideOutsideRadius",!1),this._vf.angle<0?this._vf.angle=0:this._vf.angle>t&&(this._vf.angle=t),this._origCCW=this._vf.ccw;var i=this._vf.innerRadius,o=this._vf.outerRadius;if(1==this._vf.insideOutsideRadius){if(i>o){var s=i;i=o,o=s}var r=(o-i)/2;o=i+r,i=r,this._vf.ccw=!this._origCCW}var n=this._vf.subdivision.x,a=this._vf.subdivision.y;n=Math.max(3,Math.round(this._vf.angle/t*n));var d="Torus_"+i+"_"+o+"_"+this._vf.angle+"_"+this._vf.subdivision+"-"+this._vf.caps;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[d])this._mesh=x3dom.geoCache[d];else{var l,h,u,f,_,c,m,p,x,g=this._vf.angle/n,v=t/a;for(l=0,u=0;n>=l;l++,u+=g)for(_=Math.cos(u),c=Math.sin(u),h=0,f=0;a>=h;h++,f+=v)m=Math.cos(f),p=Math.sin(f),x=o+i*m,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(_*x,i*p,-c*x),this._mesh._normals[0].push(_*m,p,-c*m)):(this._mesh._positions[0].push(_*x,-c*x,i*p),this._mesh._normals[0].push(_*m,-c*m,p)),this._mesh._texCoords[0].push(-l/n,h/a);for(l=0;a>l;l++)for(h=0;n>h;h++)this._mesh._indices[0].push(h*(a+1)+l),this._mesh._indices[0].push(h*(a+1)+l+1),this._mesh._indices[0].push((h+1)*(a+1)+l),this._mesh._indices[0].push(h*(a+1)+l+1),this._mesh._indices[0].push((h+1)*(a+1)+l+1),this._mesh._indices[0].push((h+1)*(a+1)+l);if(this._vf.angle<t&&1==this._vf.caps){var y=this._mesh._positions[0].length/3;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(o,0,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(o,0,0),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(.5,.5),h=0,f=0;a>=h;h++,f+=v)m=Math.cos(f),p=Math.sin(f),x=o+i*m,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(x,p*i,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(x,0,p*i),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(.5*(1+m),.5*(1-p)),h>0&&(this._mesh._indices[0].push(y),this._mesh._indices[0].push(y+h),this._mesh._indices[0].push(y+h-1)),h==a&&(this._mesh._indices[0].push(y),this._mesh._indices[0].push(y+1),this._mesh._indices[0].push(y+h));_=Math.cos(this._vf.angle),c=Math.sin(this._vf.angle),y=this._mesh._positions[0].length/3;var b=-c,T=-_;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(_*o,0,-c*o),this._mesh._normals[0].push(b,0,T)):(this._mesh._positions[0].push(_*o,-c*o,0),this._mesh._normals[0].push(b,T,0)),this._mesh._texCoords[0].push(.5,.5),h=0,f=0;a>=h;h++,f+=v)m=Math.cos(f),p=Math.sin(f),x=o+i*m,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(_*x,p*i,-c*x),this._mesh._normals[0].push(b,0,T)):(this._mesh._positions[0].push(_*x,-c*x,p*i),this._mesh._normals[0].push(b,T,0)),this._mesh._texCoords[0].push(1-.5*(1+m),.5*(1-p)),h>0&&(this._mesh._indices[0].push(y),this._mesh._indices[0].push(y+h-1),this._mesh._indices[0].push(y+h)),h==a&&(this._mesh._indices[0].push(y),this._mesh._indices[0].push(y+h),this._mesh._indices[0].push(y+1))}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[d]=this._mesh}},{fieldChanged:function(e){if("innerRadius"==e||"outerRadius"==e||"subdivision"==e||"angle"==e||"insideOutsideRadius"==e||"caps"==e){var t=2*Math.PI;this._vf.angle<0?this._vf.angle=0:this._vf.angle>t&&(this._vf.angle=t);var i=this._vf.innerRadius,o=this._vf.outerRadius;if(1==this._vf.insideOutsideRadius){if(i>o){var s=i;i=o,o=s}var r=(o-i)/2;o=i+r,i=r,this._vf.ccw=!this._origCCW}else this._vf.ccw=this._origCCW;var n=this._vf.subdivision.x,a=this._vf.subdivision.y;n=Math.max(3,Math.round(this._vf.angle/t*n));var d,l,h,u,f,_,c,m,p,x=this._vf.angle/n,g=t/a;for(this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[],d=0,h=0;n>=d;d++,h+=x)for(f=Math.cos(h),_=Math.sin(h),l=0,u=0;a>=l;l++,u+=g)c=Math.cos(u),m=Math.sin(u),p=o+i*c,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(f*p,i*m,-_*p),this._mesh._normals[0].push(f*c,m,-_*c)):(this._mesh._positions[0].push(f*p,-_*p,i*m),this._mesh._normals[0].push(f*c,-_*c,m)),this._mesh._texCoords[0].push(-d/n,l/a);for(d=0;a>d;d++)for(l=0;n>l;l++)this._mesh._indices[0].push(l*(a+1)+d),this._mesh._indices[0].push(l*(a+1)+d+1),this._mesh._indices[0].push((l+1)*(a+1)+d),this._mesh._indices[0].push(l*(a+1)+d+1),this._mesh._indices[0].push((l+1)*(a+1)+d+1),this._mesh._indices[0].push((l+1)*(a+1)+d);if(this._vf.angle<t&&1==this._vf.caps){var v=this._mesh._positions[0].length/3;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(o,0,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(o,0,0),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(.5,.5),l=0,u=0;a>=l;l++,u+=g)c=Math.cos(u),m=Math.sin(u),p=o+i*c,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(p,m*i,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(p,0,m*i),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(.5*(1+c),.5*(1-m)),l>0&&(this._mesh._indices[0].push(v),this._mesh._indices[0].push(v+l),this._mesh._indices[0].push(v+l-1)),l==a&&(this._mesh._indices[0].push(v),this._mesh._indices[0].push(v+1),this._mesh._indices[0].push(v+l));f=Math.cos(this._vf.angle),_=Math.sin(this._vf.angle),v=this._mesh._positions[0].length/3;var y=-_,b=-f;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(f*o,0,-_*o),this._mesh._normals[0].push(y,0,b)):(this._mesh._positions[0].push(f*o,-_*o,0),this._mesh._normals[0].push(y,b,0)),this._mesh._texCoords[0].push(.5,.5),l=0,u=0;a>=l;l++,u+=g)c=Math.cos(u),m=Math.sin(u),p=o+i*c,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(f*p,m*i,-_*p),this._mesh._normals[0].push(y,0,b)):(this._mesh._positions[0].push(f*p,-_*p,m*i),this._mesh._normals[0].push(y,b,0)),this._mesh._texCoords[0].push(1-.5*(1+c),.5*(1-m)),l>0&&(this._mesh._indices[0].push(v),this._mesh._indices[0].push(v+l-1),this._mesh._indices[0].push(v+l)),l==a&&(this._mesh._indices[0].push(v),this._mesh._indices[0].push(v+l),this._mesh._indices[0].push(v+1))}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty(),e.invalidateVolume()})}}})),x3dom.registerNodeType("Cone","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.Cone.superClass.call(this,e),this.addField_SFFloat(e,"bottomRadius",1),this.addField_SFFloat(e,"topRadius",0),this.addField_SFFloat(e,"height",2),this.addField_SFBool(e,"bottom",!0),this.addField_SFBool(e,"side",!0),this.addField_SFBool(e,"top",!0),this.addField_SFFloat(e,"subdivision",32);var t="Cone_"+this._vf.bottomRadius+"_"+this._vf.height+"_"+this._vf.top+"_"+this._vf.bottom+"_"+this._vf.side+"_"+this._vf.topRadius+"_"+this._vf.subdivision;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[t])this._mesh=x3dom.geoCache[t];else{var i,o,s,r,n,a=this._vf.bottomRadius,d=this._vf.height,l=this._vf.topRadius,h=this._vf.subdivision,u=2*Math.PI/h,f=(a-l)/d,_=1/Math.sqrt(1+f*f),c=0,m=0;if(this._vf.side&&d>0){var p=0,x=0;for(c=0,m=0;h>=c;c++)i=c*u,o=Math.sin(i),s=-Math.cos(i),l>x3dom.fields.Eps&&(p=o*l,x=s*l),this._mesh._positions[0].push(p,d/2,x),this._mesh._normals[0].push(o/_,f/_,s/_),this._mesh._texCoords[0].push(1-c/h,1),this._mesh._positions[0].push(o*a,-d/2,s*a),this._mesh._normals[0].push(o/_,f/_,s/_),this._mesh._texCoords[0].push(1-c/h,0),c>0&&(this._mesh._indices[0].push(m),this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+1),this._mesh._indices[0].push(m+2),this._mesh._indices[0].push(m+3),m+=2)}if(this._vf.bottom&&a>0){for(n=this._mesh._positions[0].length/3,c=h-1;c>=0;c--)i=c*u,o=a*Math.sin(i),s=-a*Math.cos(i),this._mesh._positions[0].push(o,-d/2,s),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(o/a/2+.5,s/a/2+.5);for(r=n+1,c=2;h>c;c++)this._mesh._indices[0].push(r),this._mesh._indices[0].push(n),r=n+c,this._mesh._indices[0].push(r)}if(this._vf.top&&l>x3dom.fields.Eps){for(n=this._mesh._positions[0].length/3,c=h-1;c>=0;c--)i=c*u,o=l*Math.sin(i),s=-l*Math.cos(i),this._mesh._positions[0].push(o,d/2,s),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(o/l/2+.5,1-s/l/2+.5);for(r=n+1,c=2;h>c;c++)this._mesh._indices[0].push(n),this._mesh._indices[0].push(r),r=n+c,this._mesh._indices[0].push(r)}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[t]=this._mesh}},{fieldChanged:function(e){if("bottomRadius"==e||"topRadius"==e||"height"==e||"subdivision"==e||"bottom"==e||"top"==e||"side"==e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var t,i,o,s,r,n=this._vf.bottomRadius,a=this._vf.height,d=this._vf.topRadius,l=this._vf.subdivision,h=2*Math.PI/l,u=(n-d)/a,f=1/Math.sqrt(1+u*u),_=0,c=0;if(this._vf.side&&a>0){var m=0,p=0;for(_=0,c=0;l>=_;_++)t=_*h,i=Math.sin(t),o=-Math.cos(t),d>x3dom.fields.Eps&&(m=i*d,p=o*d),this._mesh._positions[0].push(m,a/2,p),this._mesh._normals[0].push(i/f,u/f,o/f),this._mesh._texCoords[0].push(1-_/l,1),this._mesh._positions[0].push(i*n,-a/2,o*n),this._mesh._normals[0].push(i/f,u/f,o/f),this._mesh._texCoords[0].push(1-_/l,0),_>0&&(this._mesh._indices[0].push(c),this._mesh._indices[0].push(c+2),this._mesh._indices[0].push(c+1),this._mesh._indices[0].push(c+1),this._mesh._indices[0].push(c+2),this._mesh._indices[0].push(c+3),c+=2)}if(this._vf.bottom&&n>0){for(r=this._mesh._positions[0].length/3,_=l-1;_>=0;_--)t=_*h,i=n*Math.sin(t),o=-n*Math.cos(t),this._mesh._positions[0].push(i,-a/2,o),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(i/n/2+.5,o/n/2+.5);for(s=r+1,_=2;l>_;_++)this._mesh._indices[0].push(s),this._mesh._indices[0].push(r),s=r+_,this._mesh._indices[0].push(s)}if(this._vf.top&&d>x3dom.fields.Eps){for(r=this._mesh._positions[0].length/3,_=l-1;_>=0;_--)t=_*h,i=d*Math.sin(t),o=-d*Math.cos(t),this._mesh._positions[0].push(i,a/2,o),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(i/d/2+.5,1-o/d/2+.5);for(s=r+1,_=2;l>_;_++)this._mesh._indices[0].push(r),this._mesh._indices[0].push(s),s=r+_,this._mesh._indices[0].push(s)}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty(),e.invalidateVolume()})}}})),x3dom.registerNodeType("Cylinder","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.Cylinder.superClass.call(this,e),this.addField_SFFloat(e,"radius",1),this.addField_SFFloat(e,"height",2),this.addField_SFBool(e,"bottom",!0),this.addField_SFBool(e,"top",!0),this.addField_SFFloat(e,"subdivision",32),this.addField_SFBool(e,"side",!0);var t=this._vf.subdivision,i="Cylinder_"+this._vf.radius+"_"+this._vf.height+"_"+this._vf.bottom+"_"+this._vf.top+"_"+this._vf.side+"_"+this._vf.subdivision;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[i])this._mesh=x3dom.geoCache[i];else{var o,s,r,n,a,d=this._vf.radius,l=this._vf.height/2,h=2*Math.PI/t;if(this._vf.side)for(n=0,a=0;t>=n;n++)o=n*h,s=Math.sin(o),r=-Math.cos(o),this._mesh._positions[0].push(s*d,-l,r*d),this._mesh._normals[0].push(s,0,r),this._mesh._texCoords[0].push(1-n/t,0),this._mesh._positions[0].push(s*d,l,r*d),this._mesh._normals[0].push(s,0,r),this._mesh._texCoords[0].push(1-n/t,1),n>0&&(this._mesh._indices[0].push(a),this._mesh._indices[0].push(a+1),this._mesh._indices[0].push(a+2),this._mesh._indices[0].push(a+2),this._mesh._indices[0].push(a+1),this._mesh._indices[0].push(a+3),a+=2);if(d>0){var u,f=this._mesh._positions[0].length/3;if(this._vf.top){for(n=t-1;n>=0;n--)o=n*h,s=d*Math.sin(o),r=-d*Math.cos(o),this._mesh._positions[0].push(s,l,r),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(s/d/2+.5,-r/d/2+.5);for(u=f+1,n=2;t>n;n++)this._mesh._indices[0].push(f),this._mesh._indices[0].push(u),u=f+n,this._mesh._indices[0].push(u);f=this._mesh._positions[0].length/3}if(this._vf.bottom){for(n=t-1;n>=0;n--)o=n*h,s=d*Math.sin(o),r=-d*Math.cos(o),this._mesh._positions[0].push(s,-l,r),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(s/d/2+.5,r/d/2+.5);for(u=f+1,n=2;t>n;n++)this._mesh._indices[0].push(u),this._mesh._indices[0].push(f),u=f+n,this._mesh._indices[0].push(u)}}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[i]=this._mesh}},{fieldChanged:function(e){if("radius"===e||"height"===e){this._mesh._positions[0]=[];var t,i,o,s,r=this._vf.radius,n=this._vf.height/2,a=this._vf.subdivision,d=2*Math.PI/a;if(this._vf.side)for(s=0;a>=s;s++)t=s*d,i=Math.sin(t),o=-Math.cos(t),this._mesh._positions[0].push(i*r,-n,o*r),this._mesh._positions[0].push(i*r,n,o*r);if(r>0){var l,h=this._mesh._positions[0].length/3;if(this._vf.top)for(s=a-1;s>=0;s--)t=s*d,i=r*Math.sin(t),o=-r*Math.cos(t),this._mesh._positions[0].push(i,n,o)}if(this._vf.bottom)for(s=a-1;s>=0;s--)t=s*d,i=r*Math.sin(t),o=-r*Math.cos(t),this._mesh._positions[0].push(i,-n,o);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e.invalidateVolume()})}else if("subdivision"===e||"bottom"===e||"top"===e||"side"===e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var t,i,o,s,r=this._vf.radius,n=this._vf.height/2,a=this._vf.subdivision,d=2*Math.PI/a,u=0;if(this._vf.side)for(s=0,u=0;a>=s;s++)t=s*d,i=Math.sin(t),o=-Math.cos(t),this._mesh._positions[0].push(i*r,-n,o*r),this._mesh._normals[0].push(i,0,o),this._mesh._texCoords[0].push(1-s/a,0),this._mesh._positions[0].push(i*r,n,o*r),this._mesh._normals[0].push(i,0,o),this._mesh._texCoords[0].push(1-s/a,1),s>0&&(this._mesh._indices[0].push(u+0),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+3),u+=2);if(r>0){var l,h=this._mesh._positions[0].length/3;if(this._vf.top){for(s=a-1;s>=0;s--)t=s*d,i=r*Math.sin(t),o=-r*Math.cos(t),this._mesh._positions[0].push(i,n,o),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(i/r/2+.5,-o/r/2+.5);for(l=h+1,s=2;a>s;s++)this._mesh._indices[0].push(h),this._mesh._indices[0].push(l),l=h+s,this._mesh._indices[0].push(l);h=this._mesh._positions[0].length/3}if(this._vf.bottom){for(s=a-1;s>=0;s--)t=s*d,i=r*Math.sin(t),o=-r*Math.cos(t),this._mesh._positions[0].push(i,-n,o),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(i/r/2+.5,o/r/2+.5);for(l=h+1,s=2;a>s;s++)this._mesh._indices[0].push(l),this._mesh._indices[0].push(h),l=h+s,this._mesh._indices[0].push(l)}}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty(),e.invalidateVolume()})}}})),x3dom.registerNodeType("ExternalGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.ExternalGeometry.superClass.call(this,e),this.addField_MFString(e,"url",[]),this._mesh._invalidate=!1,this._mesh._numCoords=0,this._mesh._numFaces=0,this._currentURLIdx=0},{updateRenderData:function(e,t,i,o,s){var r,n=this;0==this._vf.url.length||this._currentURLIdx>=this._vf.url.length||x3dom.BinaryContainerLoader.outOfMemory||(e._webgl.internalDownloadCount=1,e._nameSpace.doc.downloadCount=1,r=new XMLHttpRequest,r.open("GET",e._nameSpace.getURL(this._vf.url[this._currentURLIdx]),!0),r.responseType="arraybuffer",r.send(null),r.onerror=function(){x3dom.debug.logError('Unable to load SRC data from URL "'+n._vf.url[n._currentURLIdx]+'"')},r.onload=function(){e._webgl.internalDownloadCount=0,e._nameSpace.doc.downloadCount=0;var a,d,l,h,u,f,_=new Uint32Array(r.response,0,12);if((200==r.status||0==r.status)&&_.length>=3)if(a=_[2],l=a+12,d=r.response.byteLength-l,a>0&&d>=0){h=new Uint8Array(r.response,12,a),u=new Uint8Array(r.response,l,d);try{f=JSON.parse(String.fromCharCode.apply(null,h))}catch(c){return void x3dom.debug.logError("Unable to parse SRC header: "+c)}n._updateRenderDataFromSRC(e,t,i,f,u)}else n._currentURLIdx+1<n._vf.url.length?(x3dom.debug.logWarning('Invalid SRC data, loaded from URL "'+n._vf.url[n._currentURLIdx]+'", trying next specified URL'),++n._currentURLIdx,n.updateRenderData(e,t,i,o,s)):x3dom.debug.logError('Invalid SRC data, loaded from URL "'+n._vf.url[n._currentURLIdx]+'", no other URLs left to try.');else n._currentURLIdx+1<n._vf.url.length?(x3dom.debug.logWarning('Invalid SRC data, loaded from URL "'+n._vf.url[n._currentURLIdx]+'", trying next specified URL'),++n._currentURLIdx,n.updateRenderData(e,t,i,o,s)):x3dom.debug.logError('Invalid SRC data, loaded from URL "'+n._vf.url[n._currentURLIdx]+'", no other URLs left to try.')})},_updateRenderDataFromSRC:function(e,t,i,o,s){var r,n,a,d,l,h,u,f,_,c,m,p,x=0,g=1,v=2,y=3,b=4,T=5,S=6,M=o.accessors.indexViews,C=o.accessors.attributeViews,F=o.meshes,E={},w={};for(r in M)n=M[r],w[n.bufferView]=!0;this._createGLBuffersFromSRCChunks(i,o.bufferChunks,o.bufferViews,s,w,E);for(r in M)n=M[r],n.componentType!=i.UNSIGNED_SHORT&&x3dom.debug.logWarning("SRC index componentType "+n.componentType+" is not UNSIGNED_SHORT. Ignoring given value and assuming UNSIGNED_SHORT indices."),e._webgl.indexType=i.UNSIGNED_SHORT;m=0,p=0,e._webgl.primType=[],e._webgl.indexOffset=[],e._webgl.drawCount=[],this._mesh._numCoords=0,this._mesh._numFaces=0;for(c in F){_=F[c],r=_.indices,""!=r?(e._webgl.externalGeometry=1,n=M[r],e._webgl.indexOffset[m]=n.byteOffset,e._webgl.drawCount[m]=n.count,e._webgl.buffers[x+p]=E[n.bufferView],this._mesh._numFaces+=n.count/3):e._webgl.externalGeometry=-1,e._webgl.primType[m]=_.primitive,a=_.attributes;for(d in a){switch(l=C[a[d]],d){case"position":h="coord",u="Pos",e._webgl.buffers[g+p]=E[l.bufferView],""==_.indices&&(e._webgl.drawCount[m]=l.count,this._mesh._numFaces+=l.count/3),this._mesh._numCoords+=l.count;break;case"normal":h="normal",u="Norm",e._webgl.buffers[v+p]=E[l.bufferView];break;case"texcoord":h="texCoord",u="Tex",e._webgl.buffers[y+p]=E[l.bufferView];break;case"color":h="color",u="Col",e._webgl.buffers[b+p]=E[l.bufferView];break;case"id":h="id",u="Id",e._webgl.buffers[T+p]=E[l.bufferView],e._cf.geometry.node._vf.idsPerVertex=!0}e["_"+h+"StrideOffset"][0]=l.byteStride,e["_"+h+"StrideOffset"][1]=l.byteOffset,e._webgl[h+"Type"]=l.componentType,f=x3dom.nodeTypes.ExternalGeometry._findNumComponentsForSRCAccessorType(l.type),this._mesh["_num"+u+"Components"]=f}++m,p+=S}e._dirty.shader=!0,e._nameSpace.doc.needRender=!0,x3dom.BinaryContainerLoader.checkError(i)},_createGLBuffersFromSRCChunks:function(e,t,i,o,s,r){var n,a,d,l,h,u,f,_;for(var c in i)if(l="undefined"!=typeof s[c]?e.ELEMENT_ARRAY_BUFFER:e.ARRAY_BUFFER,a=i[c],d=a.chunks,1==d.length)h=t[d[0]],f=new Uint8Array(o.buffer,o.byteOffset+h.byteOffset,h.byteLength),u=e.createBuffer(),e.bindBuffer(l,u),e.bufferData(l,f,e.STATIC_DRAW),r[c]=u;else{for(u=e.createBuffer(),e.bindBuffer(l,u),e.bufferData(l,a.byteLength,e.STATIC_DRAW),_=0,n=0;n<d.length;++n)h=t[d[n]],f=new Uint8Array(o.buffer,o.byteOffset+h.byteOffset,h.byteLength),e.bufferSubData(l,_,f),_+=h.byteLength;r[c]=u}},getVolume:function(){var e,t=this._mesh._vol;return t.isValid()||(e=this._parentNodes[0],"undefined"!=typeof e._vf.bboxCenter&&"undefined"!=typeof e._vf.bboxSize&&t.setBoundsByCenterSize(e._vf.bboxCenter,e._vf.bboxSize)),t}})),x3dom.nodeTypes.ExternalGeometry._findNumComponentsForSRCAccessorType=function(e){switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;default:return 0}},x3dom.registerNodeType("X3DBinaryContainerGeometryNode","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(e){x3dom.nodeTypes.X3DBinaryContainerGeometryNode.superClass.call(this,e),this.addField_SFVec3f(e,"position",0,0,0),this.addField_SFVec3f(e,"size",1,1,1),this.addField_MFInt32(e,"vertexCount",[0]),this.addField_MFString(e,"primType",["TRIANGLES"]),this._mesh._invalidate=!1,this._mesh._numCoords=0,this._mesh._numFaces=0,this._diameter=this._vf.size.length()},{getMin:function(){var e=this._mesh._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e.min},getMax:function(){var e=this._mesh._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e.max},getVolume:function(){var e=this._mesh._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e},invalidateVolume:function(){},getCenter:function(){return this._vf.position},getDiameter:function(){return this._diameter},needLighting:function(){var e=this._vf.primType.length&&this._vf.primType[0].indexOf("TRIANGLE")>=0;return this._vf.lit&&e}})),x3dom.registerNodeType("BinaryGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(e){x3dom.nodeTypes.BinaryGeometry.superClass.call(this,e),this.addField_SFString(e,"index",""),this.addField_SFString(e,"coord",""),this.addField_SFString(e,"normal",""),this.addField_SFString(e,"texCoord",""),this.addField_SFString(e,"color",""),this.addField_SFString(e,"tangent",""),this.addField_SFString(e,"binormal",""),this.addField_SFString(e,"indexType","Uint16"),this.addField_SFString(e,"coordType","Float32"),this.addField_SFString(e,"normalType","Float32"),this.addField_SFString(e,"texCoordType","Float32"),this.addField_SFString(e,"colorType","Float32"),this.addField_SFString(e,"tangentType","Float32"),this.addField_SFString(e,"binormalType","Float32"),this.addField_SFBool(e,"normalAsSphericalCoordinates",!1),this.addField_SFBool(e,"rgbaColors",!1),this.addField_SFInt32(e,"numTexCoordComponents",2),this.addField_SFBool(e,"normalPerVertex",!0),this.addField_SFBool(e,"idsPerVertex",!1),this.addField_SFBool(e,"compressed",!1),this._hasStrideOffset=!1,this._mesh._numPosComponents=this._vf.normalAsSphericalCoordinates?4:3,this._mesh._numTexComponents=this._vf.numTexCoordComponents,this._mesh._numColComponents=this._vf.rgbaColors?4:3,this._mesh._numNormComponents=this._vf.normalAsSphericalCoordinates?2:3,this._vertexCountSum=0;for(var t=0;t<this._vf.vertexCount.length;++t)this._vertexCountSum+=this._vf.vertexCount[t]},{parentAdded:function(e){var t,i,o,s;t=this._vf.coord.lastIndexOf("#"),i=this._vf.coord.lastIndexOf("+"),t>=0&&i>=0?(o=+this._vf.coord.substring(++t,i),s=+this._vf.coord.substring(i),e._coordStrideOffset=[s,o],this._hasStrideOffset=!0,o/8-Math.floor(o/8)==0&&(this._mesh._numPosComponents=4)):i>=0&&(s=+this._vf.coord.substring(i),e._coordStrideOffset=[s,0],s/8-Math.floor(s/8)==0&&(this._mesh._numPosComponents=4)),t=this._vf.normal.lastIndexOf("#"),i=this._vf.normal.lastIndexOf("+"),t>=0&&i>=0?(o=+this._vf.normal.substring(++t,i),s=+this._vf.normal.substring(i),e._normalStrideOffset=[s,o]):i>=0&&(s=+this._vf.normal.substring(i),e._normalStrideOffset=[s,0]),t=this._vf.texCoord.lastIndexOf("#"),i=this._vf.texCoord.lastIndexOf("+"),t>=0&&i>=0?(o=+this._vf.texCoord.substring(++t,i),s=+this._vf.texCoord.substring(i),e._texCoordStrideOffset=[s,o]):i>=0&&(s=+this._vf.texCoord.substring(i),e._texCoordStrideOffset=[s,0]),t=this._vf.color.lastIndexOf("#"),i=this._vf.color.lastIndexOf("+"),t>=0&&i>=0?(o=+this._vf.color.substring(++t,i),s=+this._vf.color.substring(i),e._colorStrideOffset=[s,o]):i>=0&&(s=+this._vf.color.substring(i),e._colorStrideOffset=[s,0]),"Uint16"==this._vf.indexType||x3dom.caps.INDEX_UINT||x3dom.debug.logWarning("Index type "+this._vf.indexType+" problematic")},doIntersect:function(e){var t=this.getMin(),i=this.getMax(),o=e.intersect(t,i);return o&&e.enter<e.dist?(e.dist=e.enter,e.hitObject=this,e.hitPoint=e.pos.add(e.dir.multiply(e.enter)),!0):!1},getPrecisionMax:function(e){switch(this._vf[e]){case"Int8":return 127;case"Uint8":return 255;case"Int16":return 32767;case"Uint16":return 65535;case"Int32":return 2147483647;case"Uint32":return 4294967295;case"Float32":case"Float64":default:return 1}}})),x3dom.registerNodeType("PopGeometryLevel","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.PopGeometryLevel.superClass.call(this,e),this.addField_SFString(e,"src",""),this.addField_SFInt32(e,"numIndices",0),this.addField_SFInt32(e,"vertexDataBufferOffset",0)},{getSrc:function(){return this._vf.src},getNumIndices:function(){return this._vf.numIndices},getVertexDataBufferOffset:function(){return this._vf.vertexDataBufferOffset}})),x3dom.registerNodeType("PopGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(e){x3dom.nodeTypes.PopGeometry.superClass.call(this,e),this.addField_SFVec3f(e,"tightSize",1,1,1),this.addField_SFVec3f(e,"maxBBSize",1,1,1),this.addField_SFVec3f(e,"bbMinModF",0,0,0),this.addField_SFVec3f(e,"bbMaxModF",1,1,1),this.addField_SFVec3f(e,"bbMin",0,0,0),this.addField_SFVec3f(e,"bbShiftVec",0,0,0),this._vf.bbMinModF.x>this._vf.bbMaxModF.x&&(this._vf.bbShiftVec.x=1),this._vf.bbMinModF.y>this._vf.bbMaxModF.y&&(this._vf.bbShiftVec.y=1),this._vf.bbMinModF.z>this._vf.bbMaxModF.z&&(this._vf.bbShiftVec.z=1),this.addField_MFNode("levels",x3dom.nodeTypes.PopGeometryLevel),this.addField_SFInt32(e,"attributeStride",0),this.addField_SFInt32(e,"positionOffset",0),this.addField_SFInt32(e,"normalOffset",0),this.addField_SFInt32(e,"texcoordOffset",0),this.addField_SFInt32(e,"colorOffset",0),this.addField_SFInt32(e,"numAnchorVertices",0),this.addField_SFInt32(e,"positionPrecision",2),this.addField_SFInt32(e,"normalPrecision",1),this.addField_SFInt32(e,"texcoordPrecision",2),this.addField_SFInt32(e,"colorPrecision",1),this.addField_SFInt32(e,"minPrecisionLevel",-1),this.addField_SFInt32(e,"maxPrecisionLevel",-1),this.addField_SFFloat(e,"precisionFactor",1),this.addField_SFString(e,"coordType","Uint16"),this.addField_SFString(e,"normalType","Uint8"),this.addField_SFString(e,"texCoordType","Uint16"),this.addField_SFString(e,"colorType","Uint8"),this.addField_SFInt32(e,"vertexBufferSize",0),this.addField_SFBool(e,"indexedRendering",!0),this.addField_SFBool(e,"sphericalNormals",!1),this.addField_MFInt32(e,"originalVertexCount",[0]);for(var t=0;t<this._vf.vertexCount.length;++t)this._vf.originalVertexCount[t]=this._vf.vertexCount[t];this._vf.maxBBSize=x3dom.fields.SFVec3f.copy(this._vf.size),this._vf.size=this._vf.tightSize,this._diameter=this._vf.size.length(),this._bbMinBySize=[Math.floor(this._vf.bbMin.x/this._vf.maxBBSize.x),Math.floor(this._vf.bbMin.y/this._vf.maxBBSize.y),Math.floor(this._vf.bbMin.z/this._vf.maxBBSize.z)],this._volRadius=this._vf.size.length()/2,this._volLargestRadius=this._vf.maxBBSize.length()/2,this._mesh._numPosComponents=this._vf.sphericalNormals?4:3,this._mesh._numNormComponents=this._vf.sphericalNormals?2:3,this._mesh._numTexComponents=2,this._mesh._numColComponents=3,x3dom.nodeTypes.PopGeometry.numTotalVerts+=this.getVertexCount(),x3dom.nodeTypes.PopGeometry.numTotalTris+=(this.hasIndex()?this.getTotalNumberOfIndices():this.getVertexCount())/3},{forceUpdateCoverage:function(){return!0},getBBoxShiftVec:function(){return this._vf.bbShiftVec},getBBoxSize:function(){return this._vf.size},hasIndex:function(){return this._vf.indexedRendering},getTotalNumberOfIndices:function(){if(this._vf.indexedRendering){for(var e=0,t=0;t<this._vf.originalVertexCount.length;++t)e+=this._vf.originalVertexCount[t];return e}return 0},getVertexCount:function(){for(var e=0,t=0;t<this._vf.originalVertexCount.length;++t)e+=this._vf.originalVertexCount[t];return e},adaptVertexCount:function(e){for(var t=0,i=0;i<this._vf.originalVertexCount.length;++i){if(!(this._vf.originalVertexCount[i]+t<=e)){this._vf.vertexCount[i]=e-t;break}this._vf.vertexCount[i]=this._vf.originalVertexCount[i],t+=this._vf.originalVertexCount[i]}},hasNormal:function(){return 0!=this._vf.normalOffset&&!this._vf.sphericalNormals},hasTexCoord:function(){return 0!=this._vf.texcoordOffset},hasColor:function(){return 0!=this._vf.colorOffset},getPositionPrecision:function(){return this._vf.positionPrecision},getNormalPrecision:function(){return this._vf.normalPrecision},getTexCoordPrecision:function(){return this._vf.texcoordPrecision},getColorPrecision:function(){return this._vf.colorPrecision},getAttributeStride:function(){return this._vf.attributeStride},getPositionOffset:function(){return this._vf.positionOffset},getNormalOffset:function(){return this._vf.normalOffset},getTexCoordOffset:function(){return this._vf.texcoordOffset},getColorOffset:function(){return this._vf.colorOffset},getBufferTypeStringFromByteCount:function(e){switch(e){case 1:return"Uint8";case 2:return"Uint16";default:return 0}},getDataURLs:function(){for(var e=[],t=0;t<this._cf.levels.nodes.length;++t)e.push(this._cf.levels.nodes[t].getSrc());return e},getNumIndicesByLevel:function(e){return this._cf.levels.nodes[e].getNumIndices()},getNumLevels:function(){return this._cf.levels.nodes.length},getVertexDataBufferOffset:function(e){return this._cf.levels.nodes[e].getVertexDataBufferOffset()},getPrecisionMax:function(e){switch(this._vf[e]){case"Uint8":return 255;case"Uint16":return 65535;default:return 1}}})),x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor=1,x3dom.nodeTypes.PopGeometry.PrecisionFactorOnMove=1,x3dom.nodeTypes.PopGeometry.numRenderedVerts=0,x3dom.nodeTypes.PopGeometry.numRenderedTris=0,x3dom.nodeTypes.PopGeometry.numTotalVerts=0,x3dom.nodeTypes.PopGeometry.numTotalTris=0,x3dom.nodeTypes.PopGeometry.powLUT=[32768,16384,8192,4096,2048,1024,512,256,128,64,32,16,8,4,2,1],x3dom.registerNodeType("ImageGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(e){if(x3dom.nodeTypes.ImageGeometry.superClass.call(this,e),this.addField_SFVec2f(e,"implicitMeshSize",256,256),this.addField_SFInt32(e,"numColorComponents",3),this.addField_SFInt32(e,"numTexCoordComponents",2),this.addField_SFNode("index",x3dom.nodeTypes.X3DTextureNode),this.addField_MFNode("coord",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("normal",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DTextureNode),this._mesh._numColComponents=this._vf.numColorComponents,this._mesh._numTexComponents=this._vf.numTexCoordComponents,0==this._vf.implicitMeshSize.y&&(this._vf.implicitMeshSize.y=this._vf.implicitMeshSize.x),"webgl"==x3dom.caps.BACKEND&&x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS>0){var t="ImageGeometry_"+this._vf.implicitMeshSize.x+"_"+this._vf.implicitMeshSize.y;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[t])this._mesh=x3dom.geoCache[t];else{for(var i=0;i<this._vf.implicitMeshSize.y;i++)for(var o=0;o<this._vf.implicitMeshSize.x;o++)this._mesh._positions[0].push(o/this._vf.implicitMeshSize.x,i/this._vf.implicitMeshSize.y,0);this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[t]=this._mesh}}this._vol=new x3dom.fields.BoxVolume,this._dirty={coord:!0,normal:!0,texCoord:!0,color:!0,index:!0}},{setGeoDirty:function(){this._dirty.coord=!0,this._dirty.normal=!0,this._dirty.texCoords=!0,this._dirty.color=!0,this._dirty.index=!0},unsetGeoDirty:function(){this._dirty.coord=!1,this._dirty.normal=!1,this._dirty.texCoords=!1,this._dirty.color=!1,this._dirty.index=!1},nodeChanged:function(){Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e._dirty.normals=!0,e._dirty.texcoords=!0,e._dirty.colors=!0}),this._vol.invalidate()},fieldChanged:function(e){"index"==e||"coord"==e||"normal"==e||"texCoord"==e||"color"==e?(this._dirty[e]=!0,this._vol.invalidate()):"implicitMeshSize"==e&&this._vol.invalidate()},getMin:function(){var e=this._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),
e.min},getMax:function(){var e=this._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e.max},getVolume:function(){var e=this._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e},numCoordinateTextures:function(){return this._cf.coord.nodes.length},getIndexTexture:function(){return this._cf.index.node?(this._cf.index.node._type="IG_index",this._cf.index.node):null},getIndexTextureURL:function(){return this._cf.index.node?this._cf.index.node._vf.url:null},getCoordinateTexture:function(e){return this._cf.coord.nodes[e]?(this._cf.coord.nodes[e]._type="IG_coords"+e,this._cf.coord.nodes[e]):null},getCoordinateTextureURL:function(e){return this._cf.coord.nodes[e]?this._cf.coord.nodes[e]._vf.url:null},getCoordinateTextureURLs:function(){for(var e=[],t=0;t<this._cf.coord.nodes.length;t++)e.push(this._cf.coord.nodes[t]._vf.url);return e},getNormalTexture:function(){return this._cf.normal.node?(this._cf.normal.node._type="IG_normals",this._cf.normal.node):null},getNormalTextureURL:function(){return this._cf.normal.node?this._cf.normal.node._vf.url:null},getTexCoordTexture:function(){return this._cf.texCoord.node?(this._cf.texCoord.node._type="IG_texCoords",this._cf.texCoord.node):null},getTexCoordTextureURL:function(){return this._cf.texCoord.node?this._cf.texCoord.node._vf.url:null},getColorTexture:function(){return this._cf.color.node?(this._cf.color.node._type="IG_colors",this._cf.color.node):null},getColorTextureURL:function(){return this._cf.color.node?this._cf.color.node._vf.url:null},getTextures:function(){var e=[],t=this.getIndexTexture();for(t&&e.push(t),i=0;i<this.numCoordinateTextures();i++){var o=this.getCoordinateTexture(i);o&&e.push(o)}var s=this.getNormalTexture();s&&e.push(s);var r=this.getTexCoordTexture();r&&e.push(r);var n=this.getColorTexture();return n&&e.push(n),e}})),x3dom.registerNodeType("IndexedFaceSet","Geometry3D",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(e){x3dom.nodeTypes.IndexedFaceSet.superClass.call(this,e),this.addField_SFFloat(e,"creaseAngle",0),this.addField_SFBool(e,"convex",!0),this.addField_MFInt32(e,"coordIndex",[]),this.addField_MFInt32(e,"normalIndex",[]),this.addField_MFInt32(e,"colorIndex",[]),this.addField_MFInt32(e,"texCoordIndex",[])},{nodeChanged:function(){(new Date).getTime();this.handleAttribs();var e=this._vf.coordIndex;e.length&&-1!=e[e.length-1]&&e.push(-1);var t=this._vf.normalIndex,i=this._vf.texCoordIndex,o=this._vf.colorIndex,s=!1,r=!1,n=!1,a=!1,d=!1,l=!1,h=this._vf.colorPerVertex,u=this._vf.normalPerVertex;t.length>0&&(r=!0),i.length>0&&(a=!0),o.length>0&&(l=!0);var f,_,c,m,p=this._cf.coord.node;x3dom.debug.assert(p),f=p.getPoints();var x=this._cf.normal.node;x?(s=!0,_=x._vf.vector):s=!1;var g="",v=2,y=this._cf.texCoord.node;x3dom.isa(y,x3dom.nodeTypes.MultiTextureCoordinate)&&y._cf.texCoord.nodes.length&&(y=y._cf.texCoord.nodes[0]),y?y._vf.point?(n=!0,c=y._vf.point,x3dom.isa(y,x3dom.nodeTypes.TextureCoordinate3D)&&(v=3)):y._vf.mode&&(g=y._vf.mode):n=!1,this._mesh._numTexComponents=v;var b=3,T=this._cf.color.node;T?(d=!0,m=T._vf.color,x3dom.isa(T,x3dom.nodeTypes.ColorRGBA)&&(b=4)):d=!1,this._mesh._numColComponents=b,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var S,M,C,F,E,w,A,R,N,I,P,D,V,L,B,O,k;if(this._vf.creaseAngle<=x3dom.fields.Eps||f.length>x3dom.Utils.maxIndexableCoords||s&&r||n&&a||d&&l){if(this._vf.creaseAngle<=x3dom.fields.Eps&&x3dom.debug.logWarning("Fallback to inefficient multi-index mode since creaseAngle=0."),this._vf.convex)for(C=0,F=0,E=0,this._mesh._multiIndIndices=[],this._mesh._posSize=f.length,S=0;S<e.length;++S)if(-1!=e[S])switch(r&&x3dom.debug.assert(-1!=t[S]),a&&x3dom.debug.assert(-1!=i[S]),l&&x3dom.debug.assert(-1!=o[S]),C){case 0:w=+e[S],N=r&&u?+t[S]:r&&!u?+t[E]:u?w:E,D=a?+i[S]:w,B=l&&h?+o[S]:l&&!h?+o[E]:h?w:E,C=1;break;case 1:A=+e[S],I=r&&u?+t[S]:r&&!u?+t[E]:u?A:E,V=a?+i[S]:A,O=l&&h?+o[S]:l&&!h?+o[E]:h?A:E,C=2;break;case 2:R=+e[S],P=r&&u?+t[S]:r&&!u?+t[E]:u?R:E,L=a?+i[S]:R,k=l&&h?+o[S]:l&&!h?+o[E]:h?R:E,C=3,this._mesh._positions[0].push(f[w].x),this._mesh._positions[0].push(f[w].y),this._mesh._positions[0].push(f[w].z),this._mesh._positions[0].push(f[A].x),this._mesh._positions[0].push(f[A].y),this._mesh._positions[0].push(f[A].z),this._mesh._positions[0].push(f[R].x),this._mesh._positions[0].push(f[R].y),this._mesh._positions[0].push(f[R].z),s&&(this._mesh._normals[0].push(_[N].x),this._mesh._normals[0].push(_[N].y),this._mesh._normals[0].push(_[N].z),this._mesh._normals[0].push(_[I].x),this._mesh._normals[0].push(_[I].y),this._mesh._normals[0].push(_[I].z),this._mesh._normals[0].push(_[P].x),this._mesh._normals[0].push(_[P].y),this._mesh._normals[0].push(_[P].z)),this._mesh._multiIndIndices.push(w,A,R),d&&(this._mesh._colors[0].push(m[B].r),this._mesh._colors[0].push(m[B].g),this._mesh._colors[0].push(m[B].b),4===b&&this._mesh._colors[0].push(m[B].a),this._mesh._colors[0].push(m[O].r),this._mesh._colors[0].push(m[O].g),this._mesh._colors[0].push(m[O].b),4===b&&this._mesh._colors[0].push(m[O].a),this._mesh._colors[0].push(m[k].r),this._mesh._colors[0].push(m[k].g),this._mesh._colors[0].push(m[k].b),4===b&&this._mesh._colors[0].push(m[k].a)),n&&(this._mesh._texCoords[0].push(c[D].x),this._mesh._texCoords[0].push(c[D].y),3===v&&this._mesh._texCoords[0].push(c[D].z),this._mesh._texCoords[0].push(c[V].x),this._mesh._texCoords[0].push(c[V].y),3===v&&this._mesh._texCoords[0].push(c[V].z),this._mesh._texCoords[0].push(c[L].x),this._mesh._texCoords[0].push(c[L].y),3===v&&this._mesh._texCoords[0].push(c[L].z));break;case 3:A=R,V=L,u&&(I=P),h&&(O=k),R=+e[S],r&&u?P=+t[S]:r&&!u||(P=u?R:E),L=a?+i[S]:R,l&&h?k=+o[S]:l&&!h||(k=h?R:E),this._mesh._positions[0].push(f[w].x),this._mesh._positions[0].push(f[w].y),this._mesh._positions[0].push(f[w].z),this._mesh._positions[0].push(f[A].x),this._mesh._positions[0].push(f[A].y),this._mesh._positions[0].push(f[A].z),this._mesh._positions[0].push(f[R].x),this._mesh._positions[0].push(f[R].y),this._mesh._positions[0].push(f[R].z),s&&(this._mesh._normals[0].push(_[N].x),this._mesh._normals[0].push(_[N].y),this._mesh._normals[0].push(_[N].z),this._mesh._normals[0].push(_[I].x),this._mesh._normals[0].push(_[I].y),this._mesh._normals[0].push(_[I].z),this._mesh._normals[0].push(_[P].x),this._mesh._normals[0].push(_[P].y),this._mesh._normals[0].push(_[P].z)),this._mesh._multiIndIndices.push(w,A,R),d&&(this._mesh._colors[0].push(m[B].r),this._mesh._colors[0].push(m[B].g),this._mesh._colors[0].push(m[B].b),4===b&&this._mesh._colors[0].push(m[B].a),this._mesh._colors[0].push(m[O].r),this._mesh._colors[0].push(m[O].g),this._mesh._colors[0].push(m[O].b),4===b&&this._mesh._colors[0].push(m[O].a),this._mesh._colors[0].push(m[k].r),this._mesh._colors[0].push(m[k].g),this._mesh._colors[0].push(m[k].b),4===b&&this._mesh._colors[0].push(m[k].a)),n&&(this._mesh._texCoords[0].push(c[D].x),this._mesh._texCoords[0].push(c[D].y),3===v&&this._mesh._texCoords[0].push(c[D].z),this._mesh._texCoords[0].push(c[V].x),this._mesh._texCoords[0].push(c[V].y),3===v&&this._mesh._texCoords[0].push(c[V].z),this._mesh._texCoords[0].push(c[L].x),this._mesh._texCoords[0].push(c[L].y),3===v&&this._mesh._texCoords[0].push(c[L].z))}else C=0,E++;else{var U=new x3dom.DoublyLinkedList,G={};for(F=0,E=0,S=0;S<e.length;++S)if(-1!=e[S])s&&(G.normals=r&&u?_[t[S]]:r&&!u?_[t[E]]:_[e[S]]),d&&(G.colors=l&&h?m[o[S]]:l&&!h?m[o[E]]:h?m[e[S]]:m[E]),n&&(G.texCoords=a?c[i[S]]:c[e[S]]),U.appendNode(new x3dom.DoublyLinkedList.ListNode(f[e[S]],e[S],G.normals,G.colors,G.texCoords));else{var X=x3dom.EarClipping.getMultiIndexes(U);for(M=0;M<X.indices.length;M++)this._mesh._indices[0].push(F),F++,this._mesh._positions[0].push(X.point[M].x,X.point[M].y,X.point[M].z),s&&this._mesh._normals[0].push(X.normals[M].x,X.normals[M].y,X.normals[M].z),d&&(this._mesh._colors[0].push(X.colors[M].r,X.colors[M].g,X.colors[M].b),4===b&&this._mesh._colors[0].push(X.colors[M].a)),n&&(this._mesh._texCoords[0].push(X.texCoords[M].x,X.texCoords[M].y),3===v&&this._mesh._texCoords[0].push(X.texCoords[M].z));U=new x3dom.DoublyLinkedList,E++}this._mesh.splitMesh()}s||this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),n||this._mesh.calcTexCoords(g)}else{if(C=0,this._vf.convex)for(S=0;S<e.length;++S)if(-1!=e[S])switch(C){case 0:N=+e[S],C=1;break;case 1:I=+e[S],C=2;break;case 2:P=+e[S],C=3,this._mesh._indices[0].push(N,I,P);break;case 3:I=P,P=+e[S],this._mesh._indices[0].push(N,I,P)}else C=0;else for(U=new x3dom.DoublyLinkedList,S=0;S<e.length;++S)if(-1!=e[S])U.appendNode(new x3dom.DoublyLinkedList.ListNode(f[e[S]],e[S]));else{var z=x3dom.EarClipping.getIndexes(U);for(M=0;M<z.length;M++)this._mesh._indices[0].push(z[M]);U=new x3dom.DoublyLinkedList}this._mesh._positions[0]=f.toGL(),s?this._mesh._normals[0]=_.toGL():this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),n?(this._mesh._texCoords[0]=c.toGL(),this._mesh._numTexComponents=v):this._mesh.calcTexCoords(g),d&&(this._mesh._colors[0]=m.toGL(),this._mesh._numColComponents=b)}for(this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,S=0;S<this._mesh._positions.length;S++){var j=this._mesh._indices[S].length,H=this._mesh._positions[S].length/3;this._mesh._numCoords+=H,this._mesh._numFaces+=j>0?j/3:H/3}},fieldChanged:function(e){if("coord"!=e&&"normal"!=e&&"texCoord"!=e&&"color"!=e&&"coordIndex"!=e&&!e.startsWith("attrib_"))return void x3dom.debug.logWarning("IndexedFaceSet: fieldChanged for "+e+" not yet implemented!");var t=this._cf.coord.node._vf.point,i=t.length,o=this._cf.texCoord.node;if(x3dom.isa(o,x3dom.nodeTypes.MultiTextureCoordinate)&&o._cf.texCoord.nodes.length&&(o=o._cf.texCoord.nodes[0]),(this._vf.creaseAngle<=x3dom.fields.Eps||i>x3dom.Utils.maxIndexableCoords||this._vf.normalIndex.length>0&&this._cf.normal.node||this._vf.texCoordIndex.length>0&&o||this._vf.colorIndex.length>0&&this._cf.color.node)&&this._mesh._multiIndIndices){var s=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase();if(i=this._mesh._multiIndIndices.length,this._mesh._positions[0]=[],this._mesh._indices[0]=[],"coord"==e&&i){for(s&&(this._mesh._normals[0]=[]),G=0;i>G;G+=3){var r=this._mesh._multiIndIndices[G],n=this._mesh._multiIndIndices[G+1],a=this._mesh._multiIndIndices[G+2],d=t[r],l=t[n],h=t[a];if(this._mesh._positions[0].push(d.x,d.y,d.z),this._mesh._positions[0].push(l.x,l.y,l.z),this._mesh._positions[0].push(h.x,h.y,h.z),s){var u=d.subtract(l),f=l.subtract(h),_=u.cross(f).normalize();this._vf.ccw||(_=_.negate()),this._mesh._normals[0].push(_.x,_.y,_.z),this._mesh._normals[0].push(_.x,_.y,_.z),this._mesh._normals[0].push(_.x,_.y,_.z)}}return this.invalidateVolume(),void Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,s&&(e._dirty.normals=!0)})}this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var c=this._vf.coordIndex,m=this._vf.normalIndex,p=this._vf.texCoordIndex,x=this._vf.colorIndex,g=!1,v=!1,y=!1,b=!1,T=!1,S=!1,M=this._vf.colorPerVertex,C=this._vf.normalPerVertex;m.length>0&&(v=!0),p.length>0&&(b=!0),x.length>0&&(S=!0);var F,E,w,A,R=this._cf.coord.node;x3dom.debug.assert(R),F=R.getPoints();var N=this._cf.normal.node;N?(g=!0,E=N._vf.vector):g=!1;var I="",P=2;o=this._cf.texCoord.node,x3dom.isa(o,x3dom.nodeTypes.MultiTextureCoordinate)&&o._cf.texCoord.nodes.length&&(o=o._cf.texCoord.nodes[0]),o?o._vf.point?(y=!0,w=o._vf.point,x3dom.isa(o,x3dom.nodeTypes.TextureCoordinate3D)&&(P=3)):o._vf.mode&&(I=o._vf.mode):y=!1,this._mesh._numTexComponents=P;var D=3,V=this._cf.color.node;if(V?(T=!0,A=V._vf.color,x3dom.isa(V,x3dom.nodeTypes.ColorRGBA)&&(D=4)):T=!1,this._mesh._numColComponents=D,e.startsWith("attrib")){var L=e.slice(7),B=this._cf.attrib.nodes.find(function(e){return e._vf.name==L});if(B){var O=B._vf.value,k=B._vf.numComponents,U=void 0!==this._mesh._dynamicFields[L];this._mesh._dynamicFields[L].numComponents=k,this._mesh._dynamicFields[L].value=[]}}var G,X,z,j,H,W,Y,q,Q,K,Z,$,J,ee,te,ie,oe,se;if(this._vf.convex)for(j=0,H=0,W=0,this._mesh._multiIndIndices=[],this._mesh._posSize=F.length,G=0;G<c.length;++G)if(-1!=c[G])switch(v&&x3dom.debug.assert(-1!=m[G]),b&&x3dom.debug.assert(-1!=p[G]),S&&x3dom.debug.assert(-1!=x[G]),j){case 0:Y=+c[G],K=v&&C?+m[G]:v&&!C?+m[W]:C?Y:W,J=b?+p[G]:Y,ie=S&&M?+x[G]:S&&!M?+x[W]:M?Y:W,j=1;break;case 1:q=+c[G],Z=v&&C?+m[G]:v&&!C?+m[W]:C?q:W,ee=b?+p[G]:q,oe=S&&M?+x[G]:S&&!M?+x[W]:M?q:W,j=2;break;case 2:if(Q=+c[G],$=v&&C?+m[G]:v&&!C?+m[W]:C?Q:W,te=b?+p[G]:Q,se=S&&M?+x[G]:S&&!M?+x[W]:M?Q:W,this._mesh._positions[0].push(F[Y].x),this._mesh._positions[0].push(F[Y].y),this._mesh._positions[0].push(F[Y].z),this._mesh._positions[0].push(F[q].x),this._mesh._positions[0].push(F[q].y),this._mesh._positions[0].push(F[q].z),this._mesh._positions[0].push(F[Q].x),this._mesh._positions[0].push(F[Q].y),this._mesh._positions[0].push(F[Q].z),g&&(this._mesh._normals[0].push(E[K].x),this._mesh._normals[0].push(E[K].y),this._mesh._normals[0].push(E[K].z),this._mesh._normals[0].push(E[Z].x),this._mesh._normals[0].push(E[Z].y),this._mesh._normals[0].push(E[Z].z),this._mesh._normals[0].push(E[$].x),this._mesh._normals[0].push(E[$].y),this._mesh._normals[0].push(E[$].z)),this._mesh._multiIndIndices.push(Y,q,Q),T&&(this._mesh._colors[0].push(A[ie].r),this._mesh._colors[0].push(A[ie].g),this._mesh._colors[0].push(A[ie].b),4===D&&this._mesh._colors[0].push(A[ie].a),this._mesh._colors[0].push(A[oe].r),this._mesh._colors[0].push(A[oe].g),this._mesh._colors[0].push(A[oe].b),4===D&&this._mesh._colors[0].push(A[oe].a),this._mesh._colors[0].push(A[se].r),this._mesh._colors[0].push(A[se].g),this._mesh._colors[0].push(A[se].b),4===D&&this._mesh._colors[0].push(A[se].a)),y&&(this._mesh._texCoords[0].push(w[J].x),this._mesh._texCoords[0].push(w[J].y),3===P&&this._mesh._texCoords[0].push(w[J].z),this._mesh._texCoords[0].push(w[ee].x),this._mesh._texCoords[0].push(w[ee].y),3===P&&this._mesh._texCoords[0].push(w[ee].z),this._mesh._texCoords[0].push(w[te].x),this._mesh._texCoords[0].push(w[te].y),3===P&&this._mesh._texCoords[0].push(w[te].z)),U){var re=[Y,q,Q];for(X=0;3>X;X++)for(z=0;k>z;z++)this._mesh._dynamicFields[L].value.push(O[k*re[X]+z])}q=Q,ee=te,C&&(Z=$),M&&(oe=se)}else j=0,W++;else{var ne=new x3dom.DoublyLinkedList,ae={};for(H=0,W=0,G=0;G<c.length;++G)if(-1!=c[G])g&&(ae.normals=v&&C?E[m[G]]:v&&!C?E[m[W]]:E[c[G]]),T&&(ae.colors=S&&M?A[x[G]]:S&&!M?A[x[W]]:A[c[G]]),y&&(ae.texCoords=b?w[p[G]]:w[c[G]]),ne.appendNode(new x3dom.DoublyLinkedList.ListNode(F[c[G]],c[G],ae.normals,ae.colors,ae.texCoords));else{var de=x3dom.EarClipping.getMultiIndexes(ne);for(X=0;X<de.indices.length;X++)this._mesh._indices[0].push(H),H++,this._mesh._positions[0].push(de.point[X].x,de.point[X].y,de.point[X].z),g&&this._mesh._normals[0].push(de.normals[X].x,de.normals[X].y,de.normals[X].z),T&&(this._mesh._colors[0].push(de.colors[X].r,de.colors[X].g,de.colors[X].b),4===D&&this._mesh._colors[0].push(de.colors[X].a)),y&&(this._mesh._texCoords[0].push(de.texCoords[X].x,de.texCoords[X].y),3===P&&this._mesh._texCoords[0].push(de.texCoords[X].z));ne=new x3dom.DoublyLinkedList,W++}this._mesh.splitMesh()}for(g||this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),y||this._mesh.calcTexCoords(I),this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,G=0;G<this._mesh._positions.length;G++){var le=this._mesh._indices[G].length,he=this._mesh._positions[G].length/3;this._mesh._numCoords+=he,this._mesh._numFaces+=le>0?le/3:he/3}Array.forEach(this._parentNodes,function(e){e.setGeoDirty(),U&&(e._dirty.specialAttribs=!0)})}else if("coord"==e){var s=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase();this._mesh._positions[0]=t.toGL(),s&&this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),this.invalidateVolume(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,s&&(e._dirty.normals=!0),e.invalidateVolume()})}else if("color"==e)t=this._cf.color.node._vf.color,this._mesh._colors[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0});else if("normal"==e)t=this._cf.normal.node._vf.vector,this._mesh._normals[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.normals=!0});else if("texCoord"==e)o=this._cf.texCoord.node,x3dom.isa(o,x3dom.nodeTypes.MultiTextureCoordinate)&&o._cf.texCoord.nodes.length&&(o=o._cf.texCoord.nodes[0]),t=o._vf.point,this._mesh._texCoords[0]=t.toGL(),Array.forEach(this._parentNodes,function(e){e._dirty.texcoords=!0});else if("coordIndex"==e){for(s=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase(),c=this._vf.coordIndex,j=0,i=c.length,this._mesh._indices[0]=[],G=0;i>G;++G)if(-1==c[G])j=0;else switch(j){case 0:Y=+c[G],j=1;break;case 1:q=+c[G],j=2;break;case 2:Q=+c[G],j=3,this._mesh._indices[0].push(Y,q,Q);break;case 3:q=Q,Q=+c[G],this._mesh._indices[0].push(Y,q,Q)}s&&this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),Array.forEach(this._parentNodes,function(e){e._dirty.indexes=!0,s&&(e._dirty.normals=!0)})}}})),x3dom.registerNodeType("X3DTexture3DNode","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.X3DTexture3DNode.superClass.call(this,e)})),x3dom.registerNodeType("ComposedTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,function(e){x3dom.nodeTypes.ComposedTexture3D.superClass.call(this,e),this.addField_MFNode("texture",x3dom.nodeTypes.X3DTexture3DNode)})),x3dom.registerNodeType("ImageTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,function(e){x3dom.nodeTypes.ImageTexture3D.superClass.call(this,e)})),x3dom.registerNodeType("PixelTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,function(e){x3dom.nodeTypes.PixelTexture3D.superClass.call(this,e)})),x3dom.registerNodeType("TextureCoordinate3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(e){x3dom.nodeTypes.TextureCoordinate3D.superClass.call(this,e),this.addField_MFVec3f(e,"point",[])})),x3dom.registerNodeType("TextureTransform3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,function(e){x3dom.nodeTypes.TextureTransform3D.superClass.call(this,e),this.addField_SFVec3f(e,"center",0,0,0),this.addField_SFRotation(e,"rotation",0,0,1,0),this.addField_SFVec3f(e,"scale",1,1,1),this.addField_SFVec3f(e,"translation",0,0,0),this.addField_SFRotation(e,"scaleOrientation",0,0,1,0)})),x3dom.registerNodeType("TextureTransformMatrix3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,function(e){x3dom.nodeTypes.TextureTransformMatrix3D.superClass.call(this,e),this.addField_SFMatrix4f(e,"matrix",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)})),x3dom.registerNodeType("X3DPointingDeviceSensorNode","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DSensorNode,function(e){x3dom.nodeTypes.X3DPointingDeviceSensorNode.superClass.call(this,e)},{pointerPressedOverSibling:function(){this._vf.enabled&&(this._vf.isActive=!0,this.postMessage("isActive",!0))},pointerMoved:function(){},pointerMovedOver:function(){this._vf.enabled&&this.postMessage("isOver",!0)},pointerMovedOut:function(){this._vf.enabled&&this.postMessage("isOver",!1)},pointerReleased:function(){this._vf.enabled&&(this._vf.isActive=!1,this.postMessage("isActive",!1))}})),x3dom.registerNodeType("X3DDragSensorNode","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DPointingDeviceSensorNode,function(e){x3dom.nodeTypes.X3DDragSensorNode.superClass.call(this,e),this.addField_SFBool(e,"autoOffset",!0),this._lastX=-1,this._lastY=-1},{pointerPressedOverSibling:function(e){x3dom.nodeTypes.X3DPointingDeviceSensorNode.prototype.pointerPressedOverSibling.call(this,e),this._lastX=e.layerX,this._lastY=e.layerY,this._startDragging(e.viewarea,e.layerX,e.layerX,e.worldX,e.worldY,e.worldZ)},pointerMoved:function(e){x3dom.nodeTypes.X3DPointingDeviceSensorNode.prototype.pointerMoved.call(this,e),this._vf.isActive&&this._vf.enabled&&this._process2DDrag(e.layerX,e.layerY,e.layerX-this._lastX,e.layerY-this._lastY)},pointerReleased:function(){x3dom.nodeTypes.X3DPointingDeviceSensorNode.prototype.pointerReleased.call(this),this._stopDragging()},_startDragging:function(){},_process2DDrag:function(){},_stopDragging:function(){}})),x3dom.registerNodeType("X3DTouchSensorNode","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DPointingDeviceSensorNode,function(e){x3dom.nodeTypes.X3DTouchSensorNode.superClass.call(this,e)},{})),x3dom.registerNodeType("TouchSensor","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DTouchSensorNode,function(e){x3dom.nodeTypes.TouchSensor.superClass.call(this,e)},{})),x3dom.registerNodeType("PlaneSensor","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DDragSensorNode,function(e){x3dom.nodeTypes.PlaneSensor.superClass.call(this,e),this.addField_SFRotation(e,"axisRotation",0,0,1,0),this.addField_SFVec2f(e,"minPosition",0,0),this.addField_SFVec2f(e,"maxPosition",-1,-1),this.addField_SFVec3f(e,"offset",0,0,0),this._rotationMatrix=this._vf.axisRotation.toMatrix(),this._worldToLocalMatrix=null,this._initialPlaneIntersection=null,this._planeNormal=null,this._viewArea=null,this._currentTranslation=new x3dom.fields.SFVec3f(0,0,0)},{getCurrentTransform:function(){var e=x3dom.nodeTypes.X3DDragSensorNode.prototype.getCurrentTransform.call(this);return e.mult(this._rotationMatrix)},_startDragging:function(e,t,i,o,s,r){x3dom.nodeTypes.X3DDragSensorNode.prototype._startDragging.call(this,e,t,i,o,s,r),this._viewArea=e,this._currentTranslation=new x3dom.fields.SFVec3f(0,0,0).add(this._vf.offset),this._worldToLocalMatrix=this.getCurrentTransform().inverse(),this._initialPlaneIntersection=this._worldToLocalMatrix.multMatrixPnt(new x3dom.fields.SFVec3f(o,s,r)),this._planeNormal=new x3dom.fields.SFVec3f(0,0,1)},_process2DDrag:function(e,t,i,o){x3dom.nodeTypes.X3DDragSensorNode.prototype._process2DDrag.call(this,e,t,i,o);var s,r,n;if(this._initialPlaneIntersection){var a=this._viewArea.calcViewRay(e,t);a.pos=this._worldToLocalMatrix.multMatrixPnt(a.pos),a.dir=this._worldToLocalMatrix.multMatrixVec(a.dir.normalize()),s=a.intersectPlane(this._initialPlaneIntersection,this._planeNormal),s||(s=a.intersectPlane(this._initialPlaneIntersection,this._planeNormal.negate())),s&&(this._currentTranslation=s.subtract(this._initialPlaneIntersection),this._currentTranslation=this._currentTranslation.add(this._vf.offset),r=this._vf.minPosition,n=this._vf.maxPosition,r.x<=n.x&&(this._currentTranslation.x=Math.min(this._currentTranslation.x,n.x),this._currentTranslation.x=Math.max(this._currentTranslation.x,r.x)),r.y<=n.y&&(this._currentTranslation.y=Math.min(this._currentTranslation.y,n.y),this._currentTranslation.y=Math.max(this._currentTranslation.y,r.y)),this.postMessage("translation_changed",x3dom.fields.SFVec3f.copy(this._currentTranslation)))}},_stopDragging:function(){x3dom.nodeTypes.X3DDragSensorNode.prototype._stopDragging.call(this),this._vf.autoOffset&&(this._vf.offset=x3dom.fields.SFVec3f.copy(this._currentTranslation),this.postMessage("offset_changed",this._vf.offset))}})),x3dom.registerNodeType("SphereSensor","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DDragSensorNode,function(e){x3dom.nodeTypes.SphereSensor.superClass.call(this,e),this.addField_SFRotation(e,"offset",0,1,0,0),this._currentRotation=null,this._rotationMatrix=this._vf.offset.toMatrix()},{getCurrentTransform:function(){var e=x3dom.nodeTypes.X3DDragSensorNode.prototype.getCurrentTransform.call(this);return e.mult(this._rotationMatrix)},_startDragging:function(e,t,i,o,s,r){x3dom.nodeTypes.X3DDragSensorNode.prototype._startDragging.call(this,e,t,i,o,s,r),this._currentRotation=new x3dom.fields.Quaternion,this._viewArea=e,this._localOrigin=new x3dom.fields.SFVec3f(0,0,0),this._inverseToWorldMatrix=this.getCurrentTransform().inverse();var n=this._inverseToWorldMatrix.multMatrixPnt(new x3dom.fields.SFVec3f(o,s,r));this._initialSphereIntersectionVector=n.subtract(this._localOrigin),this._sphereRadius=this._initialSphereIntersectionVector.length(),this._initialSphereIntersectionVector=this._initialSphereIntersectionVector.normalize()},_process2DDrag:function(e,t,i,o){x3dom.nodeTypes.X3DDragSensorNode.prototype._process2DDrag.call(this,e,t,i,o);var s=this._viewArea.calcViewRay(e,t);s.pos=this._inverseToWorldMatrix.multMatrixPnt(s.pos),s.dir=this._inverseToWorldMatrix.multMatrixVec(s.dir);var r,n,a=s.dir.dot(s.dir),d=2*s.dir.dot(s.pos.subtract(this._localOrigin)),l=s.pos.dot(s.pos)-2*this._localOrigin.dot(s.pos)+this._localOrigin.dot(this._localOrigin)-this._sphereRadius*this._sphereRadius,h=d*d-4*a*l;if(h>=0&&(r=(-d+Math.sqrt(h))/(2*a),n=(-d-Math.sqrt(h))/(2*a),r=Math.min(r,n),r>=1)){var u=s.pos.add(s.dir.multiply(r)),f=u.subtract(this._localOrigin).normalize();this._currentRotation=x3dom.fields.Quaternion.rotateFromTo(this._initialSphereIntersectionVector,f),this._currentRotation=this._currentRotation.multiply(this._vf.offset),this.postMessage("rotation_changed",this._currentRotation)}},_stopDragging:function(){x3dom.nodeTypes.X3DDragSensorNode.prototype._stopDragging.call(this),this._vf.autoOffset&&(this._vf.offset=this._currentRotation,this.postMessage("offset_changed",this._vf.offset)),this._currentRotation=new x3dom.fields.Quaternion}})),x3dom.registerNodeType("CylinderSensor","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DDragSensorNode,function(e){x3dom.nodeTypes.CylinderSensor.superClass.call(this,e),this.addField_SFFloat(e,"offset",0),this.addField_SFRotation(e,"axisRotation",0,1,0,0),this.addField_SFFloat(e,"diskAngle",.262),this.addField_SFFloat(e,"minAngle",0),this.addField_SFFloat(e,"maxAngle",-1),this._rotationMatrix=this._vf.axisRotation.toMatrix(),this._inverseToWorldMatrix=null,this._initialCylinderIntersectionVector=null,this._viewArea=null,this._cylinderRadius=0,this._yAxisLine=null,this._cylinderMode=!0,this._currentRotationAngle=0},{getCurrentTransform:function(){var e=x3dom.nodeTypes.X3DDragSensorNode.prototype.getCurrentTransform.call(this);return e.mult(this._rotationMatrix)},_startDragging:function(e,t,i,o,s,r){x3dom.nodeTypes.X3DDragSensorNode.prototype._startDragging.call(this,e,t,i,o,s,r),this._currentRotation=new x3dom.fields.Quaternion,this._viewArea=e,this._yAxisLine=new x3dom.fields.Line(new x3dom.fields.SFVec3f(0,0,0),new x3dom.fields.SFVec3f(0,1,0)),this._inverseToWorldMatrix=this.getCurrentTransform().inverse();var n=this._inverseToWorldMatrix.multMatrixPnt(new x3dom.fields.SFVec3f(o,s,r)),a=this._yAxisLine.closestPoint(n);this._initialCylinderIntersectionVector=n.subtract(a),this._cylinderRadius=this._initialCylinderIntersectionVector.length(),this._initialCylinderIntersectionVector=this._initialCylinderIntersectionVector.normalize()},_process2DDrag:function(e,t,i,o){if(x3dom.nodeTypes.X3DDragSensorNode.prototype._process2DDrag.call(this,e,t,i,o),this._cylinderMode){var s=this._viewArea.calcViewRay(e,t);s.pos=this._inverseToWorldMatrix.multMatrixPnt(s.pos),s.dir=this._inverseToWorldMatrix.multMatrixVec(s.dir);var r,n,a=s.dir.subtract(this._yAxisLine.dir.multiply(s.dir.dot(this._yAxisLine.dir))),d=s.pos.subtract(this._yAxisLine.pos).add(this._yAxisLine.dir.multiply(this._yAxisLine.dir.dot(this._yAxisLine.pos.subtract(s.pos)))),l=2*a.dot(d)/a.dot(a),h=(d.dot(d)-this._cylinderRadius*this._cylinderRadius)/a.dot(a),u=l*l*.25-h;if(u>=0&&(u=Math.sqrt(u),r=.5*-l+u,n=.5*-l-u,r=Math.min(r,n),r>0)){var f=s.pos.add(s.dir.multiply(r)),_=this._yAxisLine.closestPoint(f),c=f.subtract(_).normalize();this._currentRotation=x3dom.fields.Quaternion.rotateFromTo(this._initialCylinderIntersectionVector,c);var m=x3dom.fields.Quaternion.axisAngle(this._yAxisLine.dir,this._vf.offset);this._currentRotation=this._currentRotation.multiply(m),this.postMessage("rotation_changed",this._currentRotation)}}},_stopDragging:function(){x3dom.nodeTypes.X3DDragSensorNode.prototype._stopDragging.call(this),this._vf.autoOffset&&(this._vf.offset=this._currentRotation.angle(),this.postMessage("offset_changed",this._vf.offset))}})),x3dom.versionInfo={version:"1.7.2-dev",revision:"3cf614b0d65ebf3e449f9505171dd37aec475da7",date:"Tue Feb 9 10:23:30 2016 +0100"},x3dom.defineClass=defineClass,console.log(x3dom),x3dom}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},x3dom=initX3dom();module.exports=x3dom},{}]},{},[16]);